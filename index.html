<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>통합 근무 관리 시스템 (현황표 + 승무일지 + 정비일지)</title>
    
    <style>
        /* ================================================================= */
        /* [공통] Global Styles */
        /* ================================================================= */
      
  :root {
            /* S3 폰트 크기 변수 (px로 변경) */
            --s3-font-size-base: 16px;
--s3-print-font-size: 11pt; /* 인쇄는 pt 유지 */
            
            /* S3 인쇄 여백 CSS 변수 */
            --s3-print-margin-top: 10mm;
--s3-print-margin-bottom: 10mm;
            --s3-print-margin-left: 10mm;
            --s3-print-margin-right: 10mm;

            /* S1 폰트 크기 변수 (px로 변경) */
            --worker-font-size: 14px;
/* 11pt -> 14px */
            /* S1 인쇄 여백 CSS 변수 */
            --print-margin-left: 10mm;
--print-margin-right: 10mm;
        }
        
        body {
            font-family: Arial, sans-serif;
margin: 10px;
            background-color: #e9ecef; /* 배경색 변경 */
            color: #333;
font-size: 16px; /* 14pt -> 16px */
        }

        /* 상단 버전 헤더바 */
        #header-bar {
            display: flex;
justify-content: flex-end;
            align-items: center;
            padding: 5px 10px;
            background-color: #f8f9fa; /* 컨트롤박스 배경과 비슷하게 */
            border-bottom: 1px solid #dee2e6;
margin-bottom: 10px; /* #section1과의 간격 */
            border-radius: 8px;
}
        #header-logo {
            height: 24px;
width: auto;
            margin-right: 8px;
        }
        #version-display {
            font-size: 13px;
/* 10pt -> 13px */
            font-weight: bold;
            color: #555;
}

        .divider {
            margin: 40px 0;
border: 2px solid #0056b3;
        }


        /* ================================================================= */
        /* [Section 1] 근무 현황표 Styles */
        /* ================================================================= */
        
        #section1 .controls {
            background-color: #fff;
padding: 15px; border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 15px;
            align-items: stretch; 
        }

        #section1 .controls fieldset {
            border: 1px solid #ced4da;
border-radius: 8px;
            padding: 10px 15px;
            margin: 0;
            background: linear-gradient(145deg, #ffffff, #f0f0f5);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
min-width: 300px; 
            display: flex;
            flex-direction: column;
            gap: 10px; 
            transition: transform 0.2s;
}
        
        #section1 .controls fieldset:hover {
             box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
transform: translateY(-2px);
        }

        #section1 .controls fieldset legend {
            font-weight: bold;
font-size: 1.2em;
            color: #0056b3;
            padding: 2px 10px;
            border-radius: 4px;
            background-color: #eaf4ff;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
}
        
        #section1 .controls .control-group {
            display: flex;
flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
        }
        #section1 .controls label { font-weight: bold;
margin-right: 5px; white-space: nowrap; }
        #section1 .controls input[type="text"],
        #section1 .controls input[type="number"], 
        #section1 .controls select {
            padding: 6px;
border: 1px solid #a8c8e1; 
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
}
        
        #section1 .controls input[type="number"] { width: 70px;
}
        
        #section1 .controls input#companyInput {
            flex: 1 1 auto;
min-width: 150px;
        }
        #section1 .controls select#typeSelect {
            flex: 1 1 auto;
min-width: 150px;
        }
        
        #section1 .controls select { flex-grow: 1;
min-width: 120px; }

        #section1 #vehicleInputsContainer {
            display: flex;
flex-wrap: wrap; 
            gap: 5px;
            width: 100%;
            margin-top: 5px;
            padding: 5px;
            background: #e9f0f6; 
            border-radius: 4px;
            border: 1px solid #cfe2f3;
            max-height: 180px;
overflow-y: auto;
        }
        #section1 #vehicleInputsContainer input {
            width: 80px;
font-size: 0.9em;
            padding: 4px;
        }

        #section1 .controls select.margin-select {
            width: 35px;
min-width: 35px;
            padding: 1px 3px;
            font-size: 0.85em; 
            flex-grow: 0;
        }
        
        #section1 .controls button,
        #section1 .controls select.action-select,
        #section1 .controls select.work-type-select,
        #section1 .controls select.vehicle-select {
            padding: 8px 15px;
color: white; border: none; border-radius: 4px;
            cursor: pointer; font-size: 17.5px;
            text-decoration: none; display: inline-block;
            text-align: center; white-space: nowrap;
            width: auto;
flex-grow: 0; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
}
        
        #section1 .controls button { background-color: #007bff;
}
        #section1 .controls button:hover { background-color: #0056b3;
}
        #section1 .controls button.btn-danger { background-color: #dc3545;
}
        #section1 .controls button.btn-danger:hover { background-color: #c82333;
}
        
        #section1 .controls select.action-select { background-color: #28a745;
}
        #section1 .controls select.work-type-select { background-color: #ffc107; color: #333;
}
        #section1 .controls select.vehicle-select { background-color: #6c757d;
}
        
        #section1 .controls select.route-navigate-select {
            padding: 8px 15px;
font-size: 17.5px;
            background-color: #17a2b8; 
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            flex-grow: 1;
}

        #section1 .holiday-option-group {
            background-color: #e3f2fd;
padding: 8px;
            border-radius: 5px;
            align-items: center;
            border: 1px solid #b3e5fc;
}
        #section1 .holiday-option-group select {
            padding: 4px;
font-size: 0.9em;
            flex-grow: 0; 
            width: 100px;
        }

        #section1 #scheduleContainer {
            background-color: white;
padding: 10px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 90%;
            overflow-x: auto;
            border-radius: 8px;
box-sizing: border-box; 
        }
        
        #section1 table {
            width: 100%;
min-width: 100%; 
            border-collapse: collapse;
            margin: 0 auto; font-size: 0.9em; background-color: #fff; table-layout: fixed;
}
        #section1 th, #section1 td {
            border: 1px solid #ddd;
padding: 5px; 
            text-align: center;
            vertical-align: middle; 
            line-height: 1.2; 
            word-break: keep-all;
            height: 38px; box-sizing: border-box;
            font-size: 16px;
/* 13pt -> 16px */
        }
        #section1 th { background-color: #f2f2f2;
font-weight: bold;
        }
        #section1 caption {
            font-size: 1.5em;
margin-bottom: 10px; font-weight: bold;
            color: #333; text-decoration: underline;
        }
        
        #section1 .sunday { background-color: initial !important;
}
        #section1 .saturday { background-color: initial !important;
}
        #section1 .holiday { 
            background-color: initial !important;
font-weight: bold; 
            color: #cc0000;
        }
        
        #section1 .holiday td:not(:nth-child(1)):not(:nth-child(2)) {
            color: #333;
font-weight: normal;
        }
        
        #section1 .sub-day-info {
            display: block;
font-size: 0.5em; 
            line-height: 1.2;
            font-weight: bold;
            color: inherit; 
        }
        
        #section1 .day-cell-content {
            display: flex;
flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1em;
}
        
        #section1 .day-name-main {
            font-weight: bold;
font-size: 1.2em; 
            line-height: 1.2;
        }
        
        #section1 .edit-mode {
            position: relative;
padding: 2px; display: flex; flex-direction: column;
            justify-content: center; height: 100%;
            vertical-align: middle;
}
        #section1 .edit-mode input {
            width: calc(100% - 8px);
margin-bottom: 2px;
            padding: 2px; box-sizing: border-box;
        }
        #section1 .edit-mode .cell-buttons { display: flex;
justify-content: space-around; margin-top: 2px; }
            
        #section1 .edit-mode .cell-buttons button {
            padding: 3px 5px;
font-size: 0.7em; 
            color: white; 
            border: none;
            border-radius: 3px; 
            cursor: pointer; 
            white-space: nowrap;
            transition: background-color: 0.15s;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            flex-grow: 1; 
            margin: 0 1px;
}
        
        #section1 .edit-mode .cell-buttons button:disabled {
            opacity: 0.6;
cursor: not-allowed;
            box-shadow: none;
        }

        #section1 .edit-mode .cell-buttons .btn-fixed { background-color: #007bff;
}
        #section1 .edit-mode .cell-buttons .btn-fixed:hover:not(:disabled) { background-color: #0056b3;
}
        #section1 .edit-mode .cell-buttons .btn-temp { background-color: #28a745;
}
        #section1 .edit-mode .cell-buttons .btn-temp:hover { background-color: #1e7e34;
}
        #section1 .edit-mode .cell-buttons .btn-highlight-am { background-color: #6f42c1;
}
        #section1 .edit-mode .cell-buttons .btn-highlight-am:hover { background-color: #5a349c;
}
        #section1 .edit-mode .cell-buttons .btn-highlight-pm { background-color: #fd7e14;
}
        #section1 .edit-mode .cell-buttons .btn-highlight-pm:hover { background-color: #db6a0b;
}
        #section1 .edit-mode .cell-buttons .btn-delete { background-color: #dc3545;
}
        #section1 .edit-mode .cell-buttons .btn-delete:hover { background-color: #c82333;
}


        #section1 .name-entry { 
            display: block;
margin-top: 2px; 
            margin-bottom: 2px; 
            color: inherit; 
            font-size: var(--worker-font-size); 
        }
        #section1 .hidden-x { color: white;
}
        #section1 .name-entry.bold-name {
            font-weight: bold;
}
        #section1 table th:nth-child(1),
        #section1 table td:nth-child(1),
        #section1 table th:nth-child(2),
        #section1 table td:nth-child(2) {
            width: 4%;
min-width: 60px;
            vertical-align: middle; 
        }

        /* [Section 1] 컨트롤 박스 UI 개선 */
        #section1 .controls input[type="number"] {
            padding: 8px;
font-size: 1em;
        }
        #section1 .controls input#yearInput {
            width: 90px;
}
        #section1 .controls fieldset:nth-of-type(1) .control-group:nth-of-type(3) button {
            flex: 1 1 auto;
}
        #section1 .controls fieldset:nth-of-type(3) .control-group {
            flex-direction: column;
align-items: stretch;
        }
        #section1 .controls fieldset:nth-of-type(3) .control-group > * {
            margin-bottom: 5px;
}
        #section1 .controls fieldset:nth-of-type(3) .control-group > *:last-child {
            margin-bottom: 0;
}
        #section1 .controls fieldset:nth-of-type(3) .control-group:nth-of-type(2) {
            flex-direction: row;
align-items: center;
            gap: 10px; 
        }
        #section1 .controls fieldset:nth-of-type(3) .control-group:nth-of-type(2) > select {
            flex: 1 1 auto;
margin-bottom: 0; 
        }
        #section1 .controls fieldset:nth-of-type(4) .control-group:not(:first-of-type) {
             flex-direction: column;
align-items: stretch;
        }
        #section1 .controls fieldset:nth-of-type(4) .control-group:not(:first-of-type) > * {
            margin-bottom: 5px;
}
        #section1 .controls .control-group[style*="border-top"] {
            flex-direction: row;
align-items: center; 
            flex-wrap: wrap; 
        }
        #section1 .controls .control-group[style*="border-top"] > div[style*="flex-direction: row"] {
            flex-direction: row !important;
align-items: center !important; 
            gap: 10px !important; 
            margin-left: 10px !important; 
            flex-wrap: wrap;
}
        #section1 .controls select.margin-select {
            width: 60px;
min-width: 60px;
            padding: 4px; 
            font-size: 0.95em; 
        }

        @media screen and (max-width: 1400px) {
            #section1 .controls {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
}
        }

        @media screen and (max-width: 768px) {
            
            #section1 #scheduleContainer {
                max-width: 100%;
margin: 10px 0; 
            }
            
            #section1 .controls {
                grid-template-columns: 1fr;
}
            #section1 .controls .control-group { 
                flex-direction: column;
align-items: stretch;
            }
            #section1 .controls input[type="text"], 
            #section1 .controls input[type="number"], 
            #section1 .controls select,
            #section1 .controls input#companyInput, 
            #section1 .controls select#typeSelect { 
                width: 100%;
flex-basis: auto;
            }
            
            #section1 table { 
                min-width: 100%;
font-size: 0.8em; 
            }
            /* === [수정됨] === */
            #section1 th, #section1 td {
                padding: 3px;
height: 30px;
                font-size: 13px !important; /* 10pt -> 13px */
            }
            #section1 .day-name-main { font-size: 1.0em;
}
            /* === [수정됨] === */
            #section1 .name-entry { font-size: 12px !important;
} /* 9pt -> 12px */
        }
        /* ================================================================= */
        /* [Section 2] 승무 일지 Styles */
        /* ================================================================= */

        #section2 {
            font-family: Arial, sans-serif;
margin: 0;
            padding: 10px; 
            color: #333;
            font-size: 12px; /* 9pt -> 12px */
        }

        #section2 .journal-container {
            background-color: white;
padding: 15px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            max-width: 90%;
            margin: 10px auto;
            overflow-x: auto;
box-sizing: border-box;
        }

        #section2 .header-title {
            text-align: center;
font-size: 1.88em; 
            font-weight: bold;
            color: #0056b3;
            padding-bottom: 4px;
            margin-bottom: 4px;
            border-bottom: 2px solid #0056b3;
}

        #section2 .title-area {
            display: flex;
justify-content: space-between; 
            align-items: center;
            margin: 8px 0 10px 0;
            padding: 0 5px; 
            flex-wrap: wrap;
/* [수정] 모바일에서 줄바꿈 허용 */
            gap: 10px;
/* [수정] 요소 간 간격 */
        }

        #section2 .title-left {
            display: flex;
flex-direction: column;
            align-items: flex-start;
        }

        #section2 .main-title {
            font-size: 1.44em;
font-weight: bold;
            color: #333;
            display: inline-block;
        }
        
        /* === [수정] S2 날짜 네비게이션 === */
        #section2 .date-navigation-area {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
            border: 1px solid #ced4da;
            background-color: #f8f9fa;
            padding: 5px;
            border-radius: 5px;
            margin-top: 5px;
            width: 100%;
            justify-content: center;
        }
        #section2 .date-navigation-area label {
            font-size: 1em;
            font-weight: bold;
            margin: 0 5px;
        }
        #section2 .date-navigation-area input[type="date"] {
            font-size: 1em;
            padding: 3px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            max-width: 130px;
        }
        #section2 .date-nav-btn {
            padding: 4px 10px;
            font-size: 0.94em;
            font-weight: bold;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        #section2 .date-nav-btn:hover {
            background-color: #0056b3;
        }
        #section2 .date-nav-btn.today {
            background-color: #28a745;
        }
        #section2 .date-nav-btn.today:hover {
            background-color: #1e7e34;
        }
        #section2 .date-nav-btn.secondary {
             background-color: #6c757d;
        }
        #section2 .date-nav-btn.secondary:hover {
             background-color: #5a6268;
        }
        /* === [수정 끝] === */

        
        #section2 .options-right {
            display: flex;
align-items: center;
            flex-wrap: wrap; /* [수정] 모바일에서 줄바꿈 허용 */
            gap: 10px;
justify-content: flex-end; /* [수정] 우측 정렬 */
            flex-grow: 1;
/* [수정] 남은 공간 차지 */
        }
        
        #section2 .font-selector-container {
            font-size: 0.94em;
display: flex;
            align-items: center;
            white-space: nowrap;
        }

        #section2 .font-selector-container label {
            margin-right: 3px;
font-weight: normal;
        }
        
        #section2 #font-size-select {
            padding: 1px 3px;
font-size: 1em;
            height: 20px;
        }
        
        /* === [수정] 출차순서 및 순환주기 === */
        #section2 .dispatch-buttons-container {
            display: flex;
align-items: center;
            font-size: 0.94em; 
            border: 1px solid #ced4da;
            border-radius: 3px;
            padding: 2px;
            white-space: nowrap;
/* [추가] */
        }
        
        /* [추가] 순환주기 컨테이너 */
        #section2 .dispatch-cycle-container {
             font-size: 0.94em;
white-space: nowrap;
             display: flex; /* [추가] */
             align-items: center;
/* [추가] */
             border: 1px solid #ced4da;
/* [추가] */
             border-radius: 3px;
/* [추가] */
             padding: 2px;
/* [추가] */
        }
        #section2 .dispatch-cycle-container label {
             margin: 0 8px;
font-weight: normal;
             color: #333;
        }
        #section2 .dispatch-cycle-select {
            padding: 3px;
font-size: 1em; 
            border: 1px solid #ced4da; 
            border-radius: 3px;
            height: 25px;
/* 버튼과 높이 맞춤 */
            vertical-align: middle;
/* [추가] */
        }
        /* === [수정 끝] === */

        #section2 .dispatch-buttons-container label {
            margin: 0 8px;
font-weight: normal;
            color: #333;
        }

        #section2 .dispatch-button {
            padding: 3px 6px;
margin-left: -1px; 
            font-size: 1em; 
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ced4da;
            border-radius: 0;
            cursor: pointer;
            transition: background-color: 0.1s;
}

        #section2 .dispatch-button:first-of-type {
            border-top-left-radius: 2px;
border-bottom-left-radius: 2px;
            margin-left: 0;
        }
        #section2 .dispatch-button:last-of-type {
            border-top-right-radius: 2px;
border-bottom-right-radius: 2px;
        }

        #section2 .dispatch-button:hover {
            background-color: #e2e6ea;
}

        #section2 .dispatch-button.active {
            background-color: #007bff;
color: white;
            border-color: #007bff;
            z-index: 1; 
        }

        #section2 .print-button {
            padding: 4px 10px;
font-size: 0.94em;
            font-weight: bold;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
/* [추가] */
        }

        #section2 .print-button:hover {
            background-color: #0056b3;
}
        
        /* === [수정] S2 날짜 헤더 (날짜별 구분) === */
        #section2 .date-header {
            font-size: 1.5em; /* 1.25em -> 1.5em */
            font-weight: bold;
            color: #0056b3;
            text-align: center;
            padding: 10px 5px;
            background-color: #eaf4ff;
            border-top: 2px solid #0056b3;
            border-bottom: 1px solid #b3d7ff;
            margin: 15px 0 10px 0;
            display: block; /* [수정] 항상 보이도록 */
        }
        /* === [수정 끝] === */
        
        #section2 .route-section {
            margin-bottom: 15px;
border: 1px solid #ced4da;
            border-radius: 4px;
            overflow: hidden;
        }
        
        #section2 .route-header-flex {
            display: flex;
justify-content: space-between; 
            align-items: flex-start; /* [수정] 상단 정렬 */
            flex-wrap: wrap;
/* [수정] 줄바꿈 허용 */
            gap: 5px;
/* [수정] 요소 간 간격 */
            background-color: #e6f7ff;
padding: 5px 8px;
            border-bottom: 1px solid #ced4da;
        }
        
        #section2 .route-title-group {
            display: flex;
align-items: center;
            flex-shrink: 0; /* [추가] 줄어들지 않음 */
        }

        #section2 .route-name-text {
            font-size: 1.22em;
font-weight: bold;
            color: #0056b3;
            white-space: nowrap; 
            padding-right: 15px; 
        }
        
        #section2 .load-button-container {
            display: flex;
align-items: center;
        }
        #section2 .load-button {
            background-color: #38b43d;
color: white;
            border: none;
            padding: 3px 8px;
            margin-left: 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.88em;
            white-space: nowrap;
}
        #section2 .load-button:hover {
            background-color: #2e8b34;
}

        #section2 .schedule-options {
            display: flex;
gap: 15px;
            font-size: 0.9em;
            flex-wrap: wrap; /* [수정] 줄바꿈 허용 */
        }

        #section2 .schedule-options select {
            font-size: 1em;
height: 20px;
            padding: 0 2px;
            margin: 2px 0;
            box-sizing: border-box;
            vertical-align: middle;
}

        #section2 .schedule-options input[type="number"] {
            width: 30px;
height: 18px; 
            text-align: center;
            font-size: 0.9em;
            padding: 0;
            margin: 0 1px;
            border: 1px solid #ccc;
}

        #section2 .am-options, #section2 .pm-options {
            border: 1px solid #ddd;
padding: 3px 5px;
            background-color: #f7f9fb;
            border-radius: 3px;
            white-space: nowrap; /* [추가] */
        }

        #section2 .am-options span, #section2 .pm-options span {
            font-weight: bold;
}
        
        #section2 .settings-controls {
            display: flex;
flex-direction: column;
            gap: 2px;
            padding-top: 5px; 
            flex-shrink: 0; /* [추가] */
        }

        #section2 .setting-button {
            padding: 3px 5px;
font-size: 0.88em;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 3px;
            white-space: nowrap;
            transition: background-color: 0.1s;
}

        #section2 .apply-button {
            background-color: #d4edda;
border-color: #c3e6cb;
        }

        #section2 .apply-button:hover {
            background-color: #c3e6cb;
}

        #section2 .reset-button {
            background-color: #f8d7da;
border-color: #f5c6cb;
        }

        #section2 .reset-button:hover {
            background-color: #f5c6cb;
}
        
        #section2 table { 
            width: 100%;
border-collapse: collapse;
            table-layout: fixed; 
            font-size: 0.88em; 
            background-color: #fff;
        }

        #section2 th, #section2 td { 
            border: 1px solid #ddd;
padding: 2px 1px; 
            text-align: center;
            vertical-align: middle;
            height: 20px; 
            box-sizing: border-box;
            line-height: 1.1;
            position: relative;
}

        #section2 th {
            background-color: #e9ecef;
font-weight: bold;
            color: #333;
        }
        
        #section2 .car-number-cell {
            font-weight: bold;
font-size: 1.136em; 
            cursor: pointer;
            padding: 0;
        }

        #section2 .car-display {
            padding: 2px 1px;
height: 100%;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
}

        #section2 .car-controls {
            position: absolute;
top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #fff;
            padding: 1px;
box-sizing: border-box;
            gap: 1px;
            z-index: 10;
            border: 2px solid #ffc107;
}

        #section2 .car-controls select {
            width: 95%;
font-size: 0.8em;
            padding: 0;
            margin: 0;
            height: 14px;
        }

        #section2 .car-controls button {
            width: 48%;
font-size: 0.7em;
            padding: 0;
            margin: 0;
            height: 14px;
            line-height: 1;
            box-sizing: border-box;
            border: 1px solid #ccc;
            cursor: pointer;
            background-color: #f0f0f0;
}

        #section2 .car-controls div {
            display: flex;
justify-content: space-between;
            width: 95%;
            margin-top: 1px;
        }
        
        #section2 .journal-table th:nth-child(1),
        #section2 .journal-table th:nth-child(10) { /* [수정] 9 -> 10 */
            font-size: 1.136em;
}
        
        #section2 input[type="number"], #section2 input[type="text"] {
            font-size: 1em;
padding: 0;
            margin: 0;
            width: 100%;
            height: 18px; 
            box-sizing: border-box;
            border: 1px solid #ccc;
            text-align: center;
            -moz-appearance: textfield;
}
        
        /* === [수정] S2 Colgroup 9열 기준 (18열) === */
        #section2 .journal-table colgroup col {
             width: 5.4%; /* 18열 기준, 5.4% * 18 = 97.2% */
        } 
        /* === [수정 끝] === */

        #section2 .driver-name {
            box-sizing: border-box;
width: 100%;
            padding: 0;
            margin: 0;
            border: none;
            background: transparent;
            text-align: center;
            line-height: 1.1em; 
            min-height: 18px; 
            cursor: pointer;
            display: block;
}
        
        #section2 .driver-input {
            resize: none;
height: 18px; 
            overflow: hidden;
            border: 1px solid #007bff; 
            background-color: #fff !important;
            font-size: 1em;
            box-sizing: border-box;
            width: 100%;
            padding: 0;
margin: 0;
            text-align: center;
        }

        #section2 .edit-controls {
            display: flex;
justify-content: center;
            gap: 2px;
            padding: 1px 0;
            margin-top: -1px; 
        }
        
        #section2 .edit-controls button {
            flex-grow: 1;
padding: 0;
            margin: 0;
            font-size: 0.8em;
            height: 18px;
            line-height: 1;
            cursor: pointer;
            border-radius: 2px;
            border: 1px solid #ccc;
}
        
        #section2 .edit-controls button:first-child { background-color: #f44336;
color: white; border-color: #d32f2f; }
        #section2 .edit-controls button:last-child { background-color: #4CAF50; color: white;
border-color: #388e3c; }

        #section2 .hidden {
            display: none !important;
}
        
        @media screen and (max-width: 768px) {
            #section2 .journal-container {
                max-width: 100%;
margin: 10px 0; 
                padding: 5px; 
            }
            /* === [수정됨] === */
            #section2 {
                font-size: 11px !important;
/* 8pt -> 11px */
            }
            #section2 .options-right {
                gap: 5px;
flex-wrap: wrap; 
                justify-content: flex-end;
            }
            #section2 .print-button {
                padding: 3px 6px;
font-size: 1em;
            }
            #section2 .dispatch-buttons-container label {
                margin: 0 4px;
}
            #section2 th, #section2 td {
                height: 30px;
padding: 2px 0;
            }
            #section2 input[type="number"], #section2 input[type="text"],
            #section2 .s2-work-hours-select,
            #section2 .driver-input,
            #section2 .driver-name {
                height: 16px;
font-size: 0.95em;
            }
            
            /* === [수정] S2 날짜 네비게이션 모바일 === */
            #section2 .date-navigation-area {
                flex-direction: column;
                align-items: stretch;
            }
            #section2 .date-navigation-area div {
                display: flex;
                gap: 5px;
                width: 100%;
            }
            #section2 .date-navigation-area input[type="date"] {
                flex-grow: 1;
                max-width: none;
            }
            #section2 .date-navigation-area .date-nav-btn {
                flex-grow: 1;
            }
            /* === [수정 끝] === */

        }

        #section2 .s2-work-hours-select {
            font-size: 1em;
padding: 0;
            margin: 0;
            width: 100%;
            height: 18px; 
            box-sizing: border-box;
            border: 1px solid #ccc;
            text-align: center;
            background-color: white; 
            -moz-appearance: none;
-webkit-appearance: none; 
            appearance: none;
        }
        
        /* ================================================================= */
        /* [Section 3] 정비일지 Styles */
        /* ================================================================= */
        
        #section3 {
            font-family: 'Noto Sans KR', sans-serif;
margin: 0;
            padding: 10px; 
            color: #333;
            font-size: var(--s3-font-size-base); 
        }
        #section3 .maintenance-container {
            max-width: 900px;
margin: 18px auto;
            background: #fff;
            padding: 10px;
            border: 1px solid #000;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            box-sizing: border-box;
}
        
        #section3 header {
            display: flex;
flex-wrap: wrap; 
            align-items: center; 
        }
        #section3 header h1 {
            flex-basis: 100%;
text-align: center; 
            order: -1; 
            margin-bottom: 10px;
            font-size: 20px;
            margin-top: 6px;
}
        #section3 .controls {
            flex-basis: 100%;
display: flex;
            gap: 8px;
            flex-wrap: wrap; 
            justify-content: flex-end; 
            align-items: center;
}
        
        #section3 button {
            padding: 8px 12px;
border-radius: 4px;
            border: 1px solid #444;
            background: #fff;
            cursor: pointer;
            font-size: 16px;
/* 13pt -> 16px */
        }
        #section3 button.primary {
            background: #007bff;
color: #fff;
            border-color: #007bff;
        }
        #section3 button.success {
            background: #28a745;
color: #fff;
        }
        #section3 button.warning {
            background: #ffc107;
color: #333;
        }

        #section3 .margin-control-group {
            display: flex;
flex-direction: row; 
            align-items: center; 
            gap: 6px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f8f9fa;
}
        #section3 .margin-control-group > label {
            font-size: 14px;
/* 11pt -> 14px */
            font-weight: bold;
            margin-right: 5px;
}
        #section3 .margin-control {
            display: flex;
flex-direction: column; 
            align-items: center; 
        }
        #section3 .margin-control label {
            font-size: 12px;
/* 9pt -> 12px */
            font-weight: bold;
            color: #333;
}
        #section3 .margin-select {
            width: 45px;
font-size: 13px; /* 10pt -> 13px */
            padding: 1px;
border: 1px solid #aaa;
            border-radius: 3px;
        }
        
        #section3 .form-table {
            width: 100%;
border-collapse: collapse;
            margin-top: 8px;
            border: 1px solid #000; 
            table-layout: fixed;
}
        #section3 .form-table td, #section3 .form-table th {
            border: 1px solid #000;
padding: 6px;
            vertical-align: middle;
            font-size: calc(var(--s3-font-size-base) * 0.9);
            height: 28px;
            box-sizing: border-box;
            word-break: break-all;
}
        #section3 .form-table thead th {
            text-align: center;
border-top-width: 1px; 
        }
        
        #section3 .route-col { width: 15%;
} /* 노선/차량 */
        #section3 .item-col { width: 20%;
} /* 항목 */
        #section3 .detail-col { width: 20%;
} /* 정비내역 */
        #section3 .parts-col { width: 15%;
} /* 부품내역 */
        #section3 .price-col { width: 15%;
} /* 부품가격 */
        #section3 .worker-col { width: 15%;
} /* 기타 */
        #section3 .date-col { width: auto;
}
        
        
        /* === [수정됨] S3 날짜 네비게이터 === */
        #section3 #s3_date_nav_container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px; /* 버튼과 날짜 사이 간격 */
            position: relative; /* input[type=date] 배치용 */
        }
        #section3 .s3_date_nav_btn {
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            color: #0056b3;
            user-select: none;
            padding: 5px;
        }
        #section3 .s3_date_nav_btn:hover {
            color: #007bff;
        }
        #section3 #s3_dateDisplay_text {
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
        }
         #section3 #s3_dateDisplay_text:hover {
            background-color: #eaf4ff;
         }
        
        #section3 #s3_datePicker {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 100px; /* 최소한의 크기 */
            height: 100%;
            opacity: 0; /* 완전히 투명하게 */
            cursor: pointer;
        }
        /* === [수정 끝] === */

        #section3 .route-select-cell {
            vertical-align: top !important;
padding: 4px !important;
        }
        #section3 .header-select {
            font-size: 11px;
padding: 2px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 3px;
}
        #section3 .vehicle-display {
            font-weight: bold;
font-size: 12px;
            color: #0056b3;
            margin-top: 4px;
            height: 1.2em; 
        }
        
        #section3 input[type=text], #section3 input[type=number], #section3 textarea, #section3 select {
            width: 100%;
box-sizing: border-box;
            border: none;
            outline: none;
            font-size: 14px; /* 11pt -> 14px */
            color: #000;
background: transparent;
            resize: none;
        }
        #section3 textarea.auto-resize {
            overflow-y: hidden;
min-height: 28px;
            line-height: 1.4;
        }
        
        /* [수정됨] .price-input 스타일 */
        #section3 .price-input {
            text-align: right;
width: 100%; 
            padding-right: 20px; /* "원" 글자가 들어갈 공간 확보 */
            box-sizing: border-box;
}

        /* [수정됨] 입력칸과 "원" 글자를 감쌀 컨테이너 */
        #section3 .price-wrapper {
            position: relative;
width: 100%;
        }

        /* [수정됨] "원" 글자를 입력칸 위에 겹치게 하는 스타일 */
        #section3 .price-wrapper::after {
            content: "원";
position: absolute;
            top: 50%;
            right: 5px; /* 입력칸 안쪽 우측 여백 */
            transform: translateY(-50%);
color: #555; /* 글자 색상 */
            pointer-events: none;
/* "원" 글자가 클릭되는 것을 방지 */
        }

        #section3 .s3_added-row {
            background-color: #f0f8ff;
/* AliceBlue */
        }
        
        /* ================================== */
        /* [수정됨] S3 모바일 스타일 추가 */
        /* ================================== */
        @media screen and (max-width: 768px) {
            #section3 .maintenance-container {
                max-width: 100%;
padding: 5px;
                margin: 10px 0;
                /* 테이블이 넘칠 경우 좌우 스크롤 허용 */
                overflow-x: auto;
box-sizing: border-box;
            }
            #section3 header .controls {
                flex-direction: column;
align-items: stretch;
                gap: 5px;
            }
            #section3 header .controls > * {
                width: 100%;
box-sizing: border-box;
            }
            #section3 .form-table {
                font-size: 12px;
/* 모바일 폰트 크기 축소 */
                min-width: 800px;
/* 테이블 최소 너비 보장 (스크롤용) */
            }
            #section3 .form-table td, #section3 .form-table th {
                padding: 4px;
}
            #section3 input[type=text], #section3 input[type=number], #section3 textarea, #section3 select {
                 font-size: 12px;
}
        }


        /* ================================================================= */
        /* [공통] 인쇄 스타일 (S1, S2, S3 통합) */
        /* ================================================================= */
        @media print {
            
            /* [수정됨] 인쇄가 안 되는 문제 수정 */
            #header-bar,
   
         #s2_restoreDateModal, #s3_restoreDateModal, #s3_calculatorModal {
                display: none !important;
}

            /* * [수정된 핵심 로직] 
             * 기본적으로 아무것도 숨기지 않습니다.
* 대신 JS가 body에 클래스를 추가하면, '다른' 섹션들을 숨깁니다.
             * 이렇게 하면 인쇄할 섹션이 display:none 이었다가 block으로 바뀌는 
             * '레이스 컨디션' 자체가 발생하지 않습니다.
*/

            /* S1 인쇄 시: S2, S3, 구분선 숨기기 */
            body.printing-section1 #section2,
            body.printing-section1 #section3,
            body.printing-section1 .divider {
                display: none !important;
}

            /* S2 인쇄 시: S1, S3, 구분선 숨기기 */
            body.printing-section2 #section1,
            body.printing-section2 #section3,
            body.printing-section2 .divider {
                display: none !important;
}

            /* S3 인쇄 시: S1, S2, 구분선 숨기기 */
            body.printing-section3 #section1,
            body.printing-section3 #section2,
            body.printing-section3 .divider {
                display: none !important;
}
            
            /* [수정 끝] */

            /* ... (S1, S2, S3 개별 인쇄 스타일은 그대로 둠) ... */
            
            /* S1 컨트롤 숨기기 */
            body.printing-section1 #section1 .controls {
       
         display: none !important;
}
            
            /* ----- S1 인쇄 규칙 ----- */
            body.printing-section1 @page {
                size: A4;
margin: 10mm;
                margin-left: var(--print-margin-left, 15mm);
                margin-right: var(--print-margin-right, 5mm);
            }
            body.printing-section1 { background-color: white;
margin: 0; padding: 0; -webkit-print-color-adjust: exact; }
            
            body.printing-section1 .controls { display: none;
}
            body.printing-section1 #scheduleContainer { box-shadow: none; margin: 0;
padding: 0; }
            body.printing-section1 #section1 caption {
                font-size: 1.0em;
margin-bottom: 5px; 
            }
            body.printing-section1 #section1 table { 
                width: 100%;
min-width: unset; 
                font-size: 0.8em; 
                border: 1px solid #000; 
                table-layout: fixed;
                page-break-inside: auto;
}
            body.printing-section1 #section1 tr {
                page-break-inside: avoid;
page-break-after: auto;
            }
            
            body.printing-section1 #section1 th, 
            body.printing-section1 #section1 td { padding: 1px;
height: auto; word-break: break-all; vertical-align: top; border: 1px solid #000;
}
            
            body.printing-section1 #section1 table th:nth-child(1), 
            body.printing-section1 #section1 table td:nth-child(1),
            body.printing-section1 #section1 table th:nth-child(2), 
            body.printing-section1 #section1 table td:nth-child(2) { 
                width: 4%;
vertical-align: middle; 
            }
            
            body.printing-section1 #section1 .sub-day-info { font-size: 0.5em;
} 
            body.printing-section1 #section1 .day-name-main { font-size: 1em;
}
            
            body.printing-section1 #section1 .sunday { background-color: initial !important;
}
            body.printing-section1 #section1 .saturday { background-color: initial !important;
}
            body.printing-section1 #section1 .holiday { 
                background-color: initial !important;
font-weight: bold; 
                color: #cc0000; 
            }
            body.printing-section1 #section1 .holiday td:not(:nth-child(1)):not(:nth-child(2)) {
                color: #000;
font-weight: normal;
            }

            /* ----- S2 인쇄 규칙 ----- */
            body.printing-section2 @page {
                size: A4 landscape;
margin: 6mm; 
            }
            body.printing-section2 { 
                background-color: white;
padding: 0; 
                margin: 0; 
                font-size: 9pt;
                color: #000;
            }
            body.printing-section2 #section2 .journal-container {
                box-shadow: none;
border-radius: 0;
                padding: 0;
                margin: 0;
                max-width: 100%;
            }
            
            /* [수정] 순환주기, 날짜 네비게이션 인쇄 시 숨김 */
            body.printing-section2 #section2 .date-navigation-area,
            body.printing-section2 #section2 .dispatch-cycle-container,
            body.printing-section2 #section2 .print-button, 
            body.printing-section2 #section2 .font-selector-container, 
            body.printing-section2 #section2 .dispatch-buttons-container,
   
         body.printing-section2 #section2 .driver-input, 
            body.printing-section2 #section2 .edit-controls, 
            body.printing-section2 #section2 .schedule-options, 
            body.printing-section2 #section2 .load-button-container,
            body.printing-section2 #section2 .car-controls,
            body.printing-section2 #section2 .settings-controls {
               
          display: none !important;
}
            
            body.printing-section2 #section2 table { 
                font-size: 7pt;
border-collapse: collapse !important; 
                border: 1px solid #000 !important; 
            }
            body.printing-section2 #section2 th, 
            body.printing-section2 #section2 td { 
                height: 16px;
padding: 1px 0px; 
                border: 1px solid #000 !important; 
            }
            
            body.printing-section2 #section2 .header-title, 
            body.printing-section2 #section2 .main-title, 
            body.printing-section2 #section2 .route-name-text { color: #000 !important;
}
            
            body.printing-section2 #section2 .route-header-flex { background-color: #eee !important;
border-bottom: 1px solid #000 !important; }
            
            /* [수정] S2 날짜 헤더 인쇄 스타일 */
            body.printing-section2 #section2 .date-header {
                font-size: 1.2em;
                padding: 5px;
                margin: 10px 0 5px 0;
                background-color: #f0f0f0 !important;
                border-top: 1px solid #000 !important;
                border-bottom: 1px solid #000 !important;
                color: #000 !important;
                -webkit-print-color-adjust: exact;
            }

            body.printing-section2 #section2 input[type="number"], 
            body.printing-section2 #section2 input[type="text"] {
                border: none;
background: transparent;
                padding: 0;
                height: auto;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
}
            
            body.printing-section2 #section2 .s2-work-hours-select {
                border: none;
background: transparent;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                padding: 0; 
                height: auto;
}

            body.printing-section2 #section2 .driver-name, 
            body.printing-section2 #section2 .car-display {
                display: flex !important;
justify-content: center;
                align-items: center;
                border: none !important;
                cursor: default;
                height: 100%;
                width: 100%;
}
            body.printing-section2 #section2 .car-number-cell {
                padding: 2px 1px;
}

            /* S3 인쇄 규칙 */
            body.printing-section3 #section3 .maintenance-container {
                max-width: 100%;
border: none;
                box-shadow: none;
                margin: 0;
                padding: 0;
            }
            body.printing-section3 #section3 .form-table {
                font-size: var(--s3-print-font-size);
border: 2px solid #000 !important; 
            }
            body.printing-section3 #section3 .form-table td, 
            body.printing-section3 #section3 .form-table th {
                border: 1px solid #000 !important;
padding: 4px !important; 
                height: auto !important; 
                vertical-align: top; 
            }
            body.printing-section3 #section3 input, 
            body.printing-section3 #section3 textarea {
                border: none !important;
background: transparent !important;
                font-size: calc(var(--s3-print-font-size) * 0.9) !important;
                height: auto !important;
                overflow: visible !important;
                color: #000 !important;
}
            
            /* S3 인쇄 시 '원' 글자 숨기기 */
            body.printing-section3 #section3 .price-wrapper::after {
                display: none;
}
            body.printing-section3 #section3 .price-input {
                padding-right: 0;
/* 인쇄 시 여백 제거 */
            }

            body.printing-section3 #section3 .no-print,
            body.printing-section3 #section3 .header-select {
                display: none !important;
}
            
            /* === [수정됨] S3 날짜 네비게이터 인쇄 시 숨기기 === */
            body.printing-section3 #section3 #s3_date_nav_container {
                display: none !important;
            }
            /* === [수정됨] S3 인쇄 시 날짜 텍스트만 보이게 (JS가 처리하지만 만일을 대비) === */
            body.printing-section3 #section3 #s3_dateDisplay {
                display: block;
                font-weight: bold;
                font-size: 1.1em;
            }

            body.printing-section3 #section3 .vehicle-display {
                font-size: 11px !important;
color: #000 !important; 
                height: auto !important;
                margin-top: 0;
            }
            
            body.printing-section3 @page { 
                size: A4 portrait;
margin-top: var(--s3-print-margin-top);
                margin-bottom: var(--s3-print-margin-bottom);
                margin-left: var(--s3-print-margin-left);
                margin-right: var(--s3-print-margin-right);
            }
        }
    </style>
</head>
<body>
<div id="header-bar">
        <img id="header-logo" src="https://raw.githubusercontent.com/waryong2025/dasomsoftec/main/dasom.png" alt="DasomSoftec">
        <span id="version-display">Ver 5.4.2</span> </div>


    <div id="section1">
        <div class="controls">

            <fieldset>
                <legend>회사 / 노선 정보</legend>
        
        
                <div class="control-group">
                   <label for="companyInput">회사명:</label>
                    <input type="text" id="companyInput" placeholder="예: 와룡운수">
                </div>

               
 <div class="control-group">
                    <label for="typeSelect">버스 종류 선택:</label>
                       <select id="typeSelect">
                        <option value="마을">마을</option>
                        <option value="버스">버스</option>
 
                   </select>
                </div>
  
               
                <div class="control-group">
                    <label for="routeInput">노선 번호:</label>
         
           <input type="text" id="routeInput" placeholder="예: 종로08">
                    <button id="s1-addOrUpdateRoute">노선 추가/수정</button>
                    <button id="s1-deleteRoute" class="btn-danger">선택 노선 삭제</button>
                </div>
                
       
          <div class="control-group">
                    <label for="routeNavigateSelect">관련 노선 이동:</label>
                   <select id="routeNavigateSelect" class="route-navigate-select"></select>
                </div>
    
             </fieldset>

            
<fieldset>
                <legend>조회 설정</legend>
                <div class="control-group">
                    <label for="yearInput">년도:</label>
                     <input type="number" id="yearInput" value="2025">
                    <label 
for="monthInput">월:</label>
                    <input type="number" id="monthInput" value="10" min="1" max="12">
                    
                    <button id="s1-generateSchedule">생성</button>
                </div>
                 <div 
class="control-group">
                    <input type="radio" id="option1" name="displayOption" value="1">
                    <label for="option1">1일 ~ 15일</label>
                   
                    <input type="radio" id="option2" name="displayOption" value="2" checked>
         
           <label for="option2">16일 ~ 말일</label>
                </div>
                <div class="control-group holiday-option-group">
                    <label for="holidaySelect">법정휴무일:</label>
                
               
     <select id="holidaySelect">
                         <option value="apply">적용</option>
                        <option value="ignore">미적용</option>
                    </select>
                </div>
       
  
               
                <div class="control-group" style="border-top: 1px solid #dee2e6;
padding-top: 10px; margin-top: 5px;">
                    <button id="s1-printPage">인쇄</button>
                    
                    <div style="display: flex;
flex-direction: row; gap: 10px; margin-left: 5px; align-items: flex-start; flex-grow: 1;">

                        <div style="display: flex;
flex-direction: column; gap: 4px; align-items: stretch; padding: 2px 5px; border: 1px solid #ced4da; border-radius: 4px; background-color: #f8f9fa;
flex-shrink: 0;">
                            
                            <div style="display: flex;
align-items: center; gap: 2px; font-size: 0.9em; justify-content: space-between;">
                                <label for="marginLeftSelect">좌측:</label>
                                <select id="marginLeftSelect" class="margin-select">
                          
           <option value="0">0</option><option value="10" selected>10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option>
                                </select>
                            </div>
                       
  
    
                            <div style="display: flex;
align-items: center; gap: 2px; font-size: 0.9em; justify-content: space-between;">
                                <label for="marginRightSelect">우측:</label>
                                <select id="marginRightSelect" class="margin-select">
                          
           <option value="0">0</option><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option>
                                </select>
                            </div>
                        
 </div>
 
                        <div style="display: flex;
align-items: center; gap: 3px; font-size: 0.9em; padding: 2px 5px; background-color: #eaf4ff; border-radius: 4px; border: 1px solid #b3d7ff; flex-grow: 1;
white-space: nowrap;">
                           <label for="fontSizeInput" style="font-weight: bold;">글자크기조정:</label>
                           <select id="fontSizeInput" class="margin-select" style="width: 45px;
padding: 1px 3px; box-sizing: border-box; font-weight: bold;">
                                <option value="8">8pt</option>
                                <option value="9">9pt</option>
                            
    <option value="10">10pt</option>
                                <option value="11" selected>11pt</option>
                                <option value="12">12pt</option>
                            
    <option value="13">13pt</option>
                                <option value="14">14pt</option>
                            </select>
                        </div>

          
          </div>
                    
                </div>
              
            </fieldset>

            <fieldset>
                
<legend>근무전체데이타관리옵션</legend> <div class="control-group">
                    <select id="scheduleActionsSelect" class="action-select">
                        <option value="">근무전체데이타관리옵션</option> <option value="reset">현재 노선 초기화</option>
                        <option value="backup">전체 데이터 저장</option>
                    
    <option value="restore">전체 데이터 불러오기</option>
                    </select>
                    <input type="file" id="restoreFile" style="display: none;" accept=".json">
                
    
                    <button id="s1-calculateWorkdays">근무일수계산</button>
       
         </div>
                
                <div class="control-group">
                     <select id="vehicleSelect" class="vehicle-select">
                          <option value="">차량 선택</option>
       
              </select>
                    <select id="workTypeSelect" class="work-type-select">
                         <option value="">근무조건 선택</option>
                         <option value="normal">3/3 근무</option>
          
              <option value="biweekly">격주 근무</option>
                        <option value="five_day">5일근무</option> 
                    </select>
                </div>

           
           
<div style="border-top: 1px solid #dee2e6; padding-top: 10px; margin-top: 5px;"></div> 
                
                <div class="control-group">
                    <button id="s1-showS2">승무일지 및 배차관리</button>
                    <button id="s1-showS3">차량정비점검일지</button>
           
   
             </div>
            </fieldset>
            
            <fieldset>
                <legend>차량 설정 (현재 노선)</legend>
                <div class="control-group">
               
      <label for="vehicleCountInput">차량 수:</label>
                    <input type="number" id="vehicleCountInput" value="11" min="1" max="50">
                    <button id="s1-saveRouteConfig">차량 번호 저장</button>
                </div>
                <div class="control-group" style="flex-direction: column;
align-items: flex-start;">
                    <label>차량 번호 (총 <span id="vehicleCountDisplay">0</span>대):</label>
                    <div id="vehicleInputsContainer">
                        </div>
                </div>
            </fieldset>
  

           
        </div>

        <div id="scheduleContainer">
            <table>
                <caption id="tableCaption">근무 현황표를 생성해주세요.</caption>
                <thead id="scheduleHeader">
                </thead>
        
 
               <tbody id="scheduleBody">
                </tbody>
            </table>
        </div>
    </div>

    <hr class="divider">

    <div id="section2" style="display: none;">
        <div class="journal-container">

            <div class="header-title">승무일지</div>
    
            <div class="title-area">
                <div class="title-left">
                    <div class="main-title">승 무 일 지</div>
                </div>
    
                <div class="options-right">
                    <button type="button" id="s2-showAll" class="print-button" style="background-color: #6c757d;">전체보기</button>
               
                    <div class="font-selector-container">
                        <label for="font-size-select">글자크기조정:</label>
                        <select id="font-size-select">
                            <option value="8">8pt</option>
                            <option value="9">9pt</option> 
                            <option value="10">10pt</option> 
                            <option value="11" selected>11pt</option> 
                            <option value="12">12pt</option>
                            <option value="13">13pt</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 5px;">
                        <button type="button" id="s2-backupLog" class="print-button" style="background-color: #28a745;">일지백업</button>
                        <button type="button" id="s2-showRestoreModal" class="print-button" style="background-color: #fd7e14;">일지복원</button>
                        <input type="file" id="s2_restoreFile" style="display: none;" accept=".json">
                    </div>

                   <button type="button" id="s2-refreshLog" class="print-button" style="background-color: #17a2b8;">현재일지새로고침</button>
                   <button id="s2-printPage" class="print-button">인쇄하기</button>
                </div>
            </div>

            <div class="date-navigation-area">
                <div>
                    <button id="s2_prevDate" class="date-nav-btn secondary">◀ 이전</button>
                    <button id="s2_today" class="date-nav-btn today">오늘</button>
                    <button id="s2_nextDate" class="date-nav-btn secondary">다음 ▶</button>
                </div>
                <div>
                    <label for="s2_startDate">기간조회:</label>
                    <input type="date" id="s2_startDate">
                    <span>~</span>
                    <input type="date" id="s2_endDate">
                    <button id="s2_loadRange" class="date-nav-btn">조회</button>
                </div>
            </div>
            <div id="dispatch-log-body">
                </div>
        </div>
    </div>
    <div id="s2_restoreDateModal" style="display: none;
position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
background-color: rgba(0,0,0,0.4);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px;
border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px;
box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <h3 style="margin-top: 0;
border-bottom: 1px solid #ccc; padding-bottom: 10px;">승무일지 불러오기</h3>
            <p>백업한 '.json' 파일을 선택하세요.</p>
            <p style="color: red;
font-weight: bold;">S2(승무일지)의 모든 기존 데이터는 덮어쓰여집니다.</p>
            
            <div style="display: flex;
justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button id="s2_cancelRestoreBtn" type="button" style="padding: 10px 15px;
background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">취소</button>
                <button id="s2_confirmRestoreBtn" type="button" style="padding: 10px 15px;
background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">파일 선택</button>
            </div>
        </div>
    </div>

    <hr class="divider">

    <div id="section3" style="display: none;">
        <div class="maintenance-container">
            <header>
                <h1 id="s3_title" style="flex-basis: 100%;
text-align: center; order: -1; margin-bottom: 10px;">
                    차량정비점검일지 및 작업의뢰서
                </h1>
                <div class="controls no-print">
        
                    <button id="s3-showAll" style="background-color: #6c757d;
color: white;">전체보기</button>
                <button id="s3-backupFile" class="primary">일지백업</button> <input type="file" id="s3_restoreFile" style="display: none;" accept=".json">

             <button id="s3-triggerRestore" class="warning">일지복구</button> 
             <button id="s3-showCalculator">모든일지및가격</button>
             <button id="s3-clearForm">폼초기화</button>
                    <button id="s3-printPage" class="primary">인쇄</button> 

              
      <div class="margin-control-group no-print">
                        <label>인쇄여백</label>
                        <div class="margin-control">
                            <label for="s3_marginLeft">좌</label>
              
              <select id="s3_marginLeft" class="margin-select">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                 
               <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                       
 </div>
                        <div class="margin-control">
                            <label for="s3_marginRight">우</label>
                            <select id="s3_marginRight" class="margin-select">
               
                 <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
               
                 <option value="20">20</option>
                            </select>
                        </div>
                    </div>

          
          <div style="display: flex; align-items: center; gap: 5px;
font-size: 13pt;">
                        <label for="s3_fontSizeInput">글자크기:</label>
                        <select id="s3_fontSizeInput" style="width: 50px;
padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="8">8pt</option>
                            <option value="9">9pt</option>
                            <option value="10">10pt</option>
      
                      <option value="11" selected>11pt</option>
                            <option value="12">12pt</option>
                            <option value="13">13pt</option>
                  
          <option value="14">14pt</option>
                        </select>
                    </div>

                </div>
            </header>

            <form id="maintenanceForm">
    
            <table class="form-table">
<colgroup>
            <col class="route-col">  <col class="item-col">   <col class="detail-col"> <col class="parts-col">  <col class="price-col">  <col class="worker-col"> </colgroup>
                    <thead>
                    <tr>
                  
      <th class="date-col">년/월/일</th>
                        <th colspan="5" id="s3_dateDisplay">
                            <div id="s3_date_nav_container">
                                <span id="s3_prevDate" class="s3_date_nav_btn no-print">◀ 이전</span>
                                <span id="s3_dateDisplay_text">날짜 로딩 중...</span>
                                <span id="s3_nextDate" class="s3_date_nav_btn no-print">다음 ▶</span>
                                <input type="date" id="s3_datePicker" class="no-print">
                            </div>
                        </th>
                        </tr>
                    <tr>
                        <th 
class="route-col">노선/차량</th>
                        <th class="item-col">항목</th>
                        <th class="detail-col">정비내역</th>
                        <th class="parts-col">부품내역</th>
                        <th 
class="price-col">부품가격</th>
                        <th class="worker-col">작업자</th>
                    </tr>
                    </thead>
                    <tbody>
               
         <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_1"></select>
                         
       <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_1" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                          
  <td><textarea name="item_1_1" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_1" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_1" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_1" class="price-input" /></div></td>
  
                          <td><textarea name="worker_1_1" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                       
     <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_2"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_2" style="display: none;"></select>
                    
            <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_2" class="auto-resize"></textarea></td>
                            <td><textarea 
name="detail_1_2" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_2" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_2" class="price-input" /></div></td>
                            <td><textarea name="worker_1_2" class="auto-resize"></textarea></td>
     
                   </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                           
     <select class="header-select s3_routeSelect_row no-print" name="route_1_3"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_3" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                    
        </td>
                            <td><textarea name="item_1_3" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_3" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_3" class="auto-resize"></textarea></td>
  
                          <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_3" class="price-input" /></div></td>
                            <td><textarea name="worker_1_3" class="auto-resize"></textarea></td>
                        </tr>
              
          <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_4"></select>
                        
        <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_4" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                         
   <td><textarea name="item_1_4" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_4" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_4" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_4" class="price-input" /></div></td>
 
                           <td><textarea name="worker_1_4" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                      
      <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_5"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_5" style="display: none;"></select>
                   
             <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_5" class="auto-resize"></textarea></td>
                            
<td><textarea name="detail_1_5" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_5" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_5" class="price-input" /></div></td>
                            <td><textarea name="worker_1_5" class="auto-resize"></textarea></td>
    
                    </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                          
      <select class="header-select s3_routeSelect_row no-print" name="route_1_6"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_6" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                   
         </td>
                            <td><textarea name="item_1_6" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_6" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_6" class="auto-resize"></textarea></td>
 
                           <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_6" class="price-input" /></div></td>
                            <td><textarea name="worker_1_6" class="auto-resize"></textarea></td>
                        </tr>
             
           <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_1"></select>
                       
         <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_1" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                        
    <td><textarea name="item_2_1" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_1" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_1" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_1" class="price-input" 
/></div></td>
                            <td><textarea name="worker_2_1" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                     
       <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_2"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_2" style="display: none;"></select>
                  
              <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_2" class="auto-resize"></textarea></td>
                           
 <td><textarea name="detail_2_2" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_2" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_2" class="price-input" /></div></td>
                            <td><textarea name="worker_2_2" class="auto-resize"></textarea></td>
   
                     </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                         
       <select class="header-select s3_routeSelect_row no-print" name="route_2_3"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_3" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                  
          </td>
                            <td><textarea name="item_2_3" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_3" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_3" 
class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_3" class="price-input" /></div></td>
                            <td><textarea name="worker_2_3" class="auto-resize"></textarea></td>
                        </tr>
            
            <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_4"></select>
                      
          <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_4" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                       
     <td><textarea name="item_2_4" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_4" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_4" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_4" 
class="price-input" /></div></td>
                            <td><textarea name="worker_2_4" class="auto-resize"></textarea></td>
                        </tr>
                    </tbody>
                    <tfoot class="no-print">
    
                    <tr>
                            <td colspan="6" style="text-align: right;
padding: 5px;">
                                <button type="button" id="s3-addRow" style="font-size: 11pt;
padding: 4px 8px; background-color: #007bff; color: white; border: none;">
                                    행 추가 (+)
                                </button>
                      
      </td>
                        </tr>
                    </tfoot>
                </table>
            </form>

            <p class="thin-text" style="margin-top:8px">사용법: 셀에 내용을 입력한 뒤 'PDF로 저장 / 
인쇄' 버튼을 눌러 A4로 저장하세요. 모바일에서는 가로 모드에서 인쇄 결과가 더 잘 맞을 수 있습니다.</p>
        </div>
    </div>

      <div id="s3_calculatorModal" style="display: none;
position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
background-color: rgba(0,0,0,0.4);">
        <div style="background-color: #fefefe; margin: 10% auto; padding: 20px;
border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px;
box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <h3 style="margin-top: 0;
border-bottom: 1px solid #ccc; padding-bottom: 10px;">모든일지및가격</h3>
            <p>기간을 설정하고 모든 일지 내역과 부품 가격 합계를 확인합니다.</p>
            
            <div style="display: flex;
gap: 10px; margin-bottom: 15px; align-items: center;">
                <label>시작일:</label><input type="date" id="s3_startDate" style="flex-grow: 1;
padding: 8px;">
                <label>종료일:</label><input type="date" id="s3_endDate" style="flex-grow: 1;
padding: 8px;">
                <button id="s3-calculatePrices" style="padding: 8px 12px;
background-color: #007bff; color: white; border: none; border-radius: 4px;">조회</button>
            </div>

            <div style="padding: 10px;
border: 1px solid #ddd; background-color: #f8f9fa;">
                <strong>총 부품가격 합계: <span id="s3_totalPrice" style="color: #dc3545;">0원</span></strong>
            </div>
            <p style="font-size: 0.9em; color: #555;">'조회' 버튼을 누르면 합계가 계산되고, 상세 내역은 새 창으로 열립니다.</p>

            <div style="text-align: right;
margin-top: 20px;">
                <button id="s3-closeCalculator" style="padding: 10px 15px;
background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">닫기</button>
            </div>
        </div>
    </div>
    <script>
    /* ================================================================= */
        /* [공통] 통합 관리자 (DataManager) */
        /* (S1, S2, S3 데이터 동기화 총괄) */
        /* ================================================================= */

        /**
         * 1. 데이터 관리자 (DataManager)
         * - 모든 데이터의 로드, 저장, 수정을 담당합니다.
         * - 데이터 변경 시 "알림(dispatch)"을 보내 S2, S3가 반응하도록 합니다.
         */
        const DataManager = {
            MASTER_KEY: 'busScheduleManagerData', // S1, S2 공유 (근무표)
            S2_LOG_KEY: 'busDispatchLogData',     // S2 전용 (승무일지)
    
            S3_LOG_KEY: 'busMaintenanceLogData',  // S3 전용 (정비일지)
            
            // 데이터 저장소 (메모리)
            data: {
                s1: { currentRoute: null, routes: {} }, // S1 근무표 데이터
                s2: {}, // S2 승무일지 데이터
                s3: {}  // S3 정비일지 데이터
            },

            // 알림을 받을 모듈(S1, S2, S3)을 등록하는 곳
            listeners: [],

            // 알림 기능: 데이터가 변경되면 등록된 모듈에 알림
            dispatch(event, payload) {
                console.log(`[DataManager] 알림 발생: ${event}`, payload);
                this.listeners.forEach(listener => {
                    if (typeof listener.onDataChanged === 'function') {
                        listener.onDataChanged(event, payload);
                    }
                });
            },

            // 알림 받을 모듈 등록
            subscribe(module) {
                this.listeners.push(module);
            },

            // --- 공통 유틸리티 ---
            saveToStorage(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.error(`[DataManager] 로컬 스토리지 저장 실패 (키: ${key}):`, e);
                    alert(`데이터 저장에 실패했습니다. 로컬 스토리지가 꽉 찼거나 브라우저 설정(쿠키 차단 등)에 문제가 있을 수 있습니다.\n\n에러: ${e.message}`);
                }
            },
            loadFromStorage(key) {
                const data = localStorage.getItem(key);
                try {
                    return JSON.parse(data);
                } catch {
                    return null;
                }
            },
            
            // [NEW] 날짜 유틸리티
            getTodayDateString(dateObj = new Date()) {
                return dateObj.toISOString().slice(0, 10); // YYYY-MM-DD
            },
            
            // --- S1 (근무표) 데이터 관리 ---
            loadS1Data() {
                let storedData = this.loadFromStorage(this.MASTER_KEY);
                if (!storedData || !storedData.routes) {
                    storedData = { currentRoute: null, routes: {} };
                }
                if (!storedData.currentRoute || !storedData.routes[storedData.currentRoute]) {
                    storedData.currentRoute = Object.keys(storedData.routes)[0] || null;
                }
                this.data.s1 = storedData;
                console.log("[DataManager] S1(근무표) 데이터 로드 완료.");
                return this.data.s1;
            },
            saveS1Data() {
                this.saveToStorage(this.MASTER_KEY, this.data.s1);
                console.log("[DataManager] S1(근무표) 데이터 저장 완료.");
                // S1 데이터 변경 시 S2, S3에 알림
                this.dispatch('s1_data_changed', this.data.s1);
            },
            updateS1Data(updaterFunction) {
                updaterFunction(this.data.s1);
                this.saveS1Data();
            },
            getCurrentRouteData() {
                const routeName = this.data.s1.currentRoute;
                if (!routeName) return { routeName: null, routeData: null };
                return {
                    routeName,
                    routeData: this.data.s1.routes[routeName]
                };
            },
            getAllRoutes() {
                return this.data.s1.routes || {};
            },
            setCurrentRoute(routeName) {
                this.data.s1.currentRoute = routeName;
                this.saveS1Data(); // 저장 및 알림(dispatch)
                console.log(`[DataManager] 현재 노선 변경: ${routeName}`);
            },

            // --- S2 (승무일지) 데이터 관리 ---
            loadS2Data() {
                const storedData = this.loadFromStorage(this.S2_LOG_KEY);
                this.data.s2 = storedData || {};
                console.log("[DataManager] S2(승무일지) 데이터 로드 완료.");
                return this.data.s2;
            },
            saveS2Data() {
                this.saveToStorage(this.S2_LOG_KEY, this.data.s2);
                console.log("[DataManager] S2(승무일지) 데이터 저장 완료.");
            },
            updateS2Data(updaterFunction) {
                updaterFunction(this.data.s2);
                this.saveS2Data();
            },
            // [NEW] S2 노선별 설정 가져오기 (읽기 전용)
            getS2RouteSettings(routeName) {
                const s2_route_data = this.data.s2[routeName] || {};
                // 기본값 설정
                return Object.assign({
                    dispatchType: 'manual',
                    cycle: 'manual',
                    lastRotationDate: '1970-01-01',
                 
                    baseOrder: [],
                    // 자동 적용 시간 설정
                    am_startVehicle: "", am_hour: "", am_minute: "", am_interval: "",
                    pm_startVehicle: "", pm_hour: "", pm_minute: "", pm_interval: ""
                }, s2_route_data._settings);
            },
            // [NEW] S2 특정 날짜 로그 가져오기 (읽기 전용)
            getS2LogByDate(dateString) {
                return this.data.s2[dateString] || {};
            },

            // --- S3 (정비일지) 데이터 관리 ---
            loadS3Data() {
                const storedData = this.loadFromStorage(this.S3_LOG_KEY);
                this.data.s3 = storedData || {};
                console.log("[DataManager] S3(정비일지) 데이터 로드 완료.");
                return this.data.s3;
            },
            saveS3Data() {
                this.saveToStorage(this.S3_LOG_KEY, this.data.s3);
                console.log("[DataManager] S3(정비일지) 데이터 저장 완료.");
            },
            updateS3Data(updaterFunction) {
                updaterFunction(this.data.s3);
                this.saveS3Data();
            }
        };
        /* ================================================================= */
        /* [Section 1] 근무 현황표 JavaScript */
        /* ================================================================= */

        /**
         * 2. S1(근무 현황표) 모듈
         * - DataManager로부터 데이터를 받아 화면(테이블)을 그립니다.
         * - 노선 추가, 삭제, 근무표 수정 등 S1 데이터를 변경하는 작업을
         * DataManager에 요청합니다.
         */
        const S1_Module = {
            // S1 내부 상태
            state: {
                currentRoute: null,
                currentVehicleColumns: [],
                fixedScheduleData: {},
          
                tempScheduleData: {},
                workTypeConfig: {},
                scheduleData: {} // 현재 화면에 그려진 데이터 (임시)
            },

            // S1 UI 요소 캐시
            ui: {},

            
            // 2025년 공휴일 데이터 (이름 포함)
            publicHolidays2025: {
                '01-01': '신정', '01-28': '설날', '01-29': '설날', '01-30': '설날',
                '03-01': '삼일절', '05-05': '어린이날', '05-06': '부처님오신날',
                '06-06': '현충일', '08-15': '광복절', '10-05': '추석',
                '10-06': '추석', '10-07': '추석', '10-09': '한글날', '12-25': '성탄절'
            },

            /**
             * S1 모듈 초기화 (DOM 로드 시 1회 실행)
             */
            initialize() {
                console.log("S1: 초기화 시작");
                // UI 요소 캐시
                this.ui = {
                    companyInput: document.getElementById('companyInput'),
                    typeSelect: document.getElementById('typeSelect'),
                    routeInput: document.getElementById('routeInput'),
                
                    routeNavigateSelect: document.getElementById('routeNavigateSelect'),
                    yearInput: document.getElementById('yearInput'),
                    monthInput: document.getElementById('monthInput'),
                    holidaySelect: document.getElementById('holidaySelect'),
                    marginLeftSelect: document.getElementById('marginLeftSelect'),
           
                    marginRightSelect: document.getElementById('marginRightSelect'),
                    fontSizeInput: document.getElementById('fontSizeInput'),
                    scheduleActionsSelect: document.getElementById('scheduleActionsSelect'),
                    restoreFile: document.getElementById('restoreFile'),
                    vehicleSelect: document.getElementById('vehicleSelect'),
      
                    workTypeSelect: document.getElementById('workTypeSelect'),
                    vehicleCountInput: document.getElementById('vehicleCountInput'),
                    vehicleCountDisplay: document.getElementById('vehicleCountDisplay'),
                    vehicleInputsContainer: document.getElementById('vehicleInputsContainer'),
                    scheduleContainer: document.getElementById('scheduleContainer')
 
                };
                // 날짜 초기화
                const today = new Date();
                this.ui.yearInput.value = today.getFullYear();
                this.ui.monthInput.value = today.getMonth() + 1;
                const currentDay = today.getDate();
                if (currentDay <= 15) {
                    document.getElementById('option1').checked = true;
                } else {
                    document.getElementById('option2').checked = true;
                }

                // DataManager로부터 S1 데이터 로드
                const s1_data = DataManager.loadS1Data();
                this.state.currentRoute = s1_data.currentRoute;

                // 이벤트 리스너 바인딩
                this.bindEventListeners();
                // 노선 선택 드롭다운 채우기
                this.populateRouteSelect();
                // 현재 노선 데이터 화면에 로드
                this.loadRouteData(this.state.currentRoute);
                // DataManager에 S1 모듈 등록 (S2 등에서 데이터 변경 시 알림 받기 위함)
                DataManager.subscribe(this);
                console.log("S1: 초기화 완료.");
            },

            /**
             * DataManager로부터 알림을 처리하는 함수 (S2/S3에서 데이터 변경 시)
             */
            onDataChanged(event, payload) {
                // S1 데이터가 외부(S2)에서 변경된 경우, S1 화면을 다시 그림
            
                if (event === 's1_data_changed') {
                    console.log("[S1] S2로부터 데이터 변경 알림 수신. S1 갱신 시작.");
                    const s1_data = payload;
                    this.state.currentRoute = s1_data.currentRoute;
                    this.populateRouteSelect();
                    this.loadRouteData(this.state.currentRoute, true); // true = 갱신 알림
                }
            },

            /**
             * S1의 모든 이벤트 리스너 바인딩
             */
            bindEventListeners() {
            
                document.getElementById('s1-addOrUpdateRoute').onclick = () => this.addOrUpdateRoute();
                document.getElementById('s1-deleteRoute').onclick = () => this.deleteRoute();
                this.ui.routeNavigateSelect.onchange = (e) => this.handleRouteSelectChange(e.target.value);
                document.getElementById('s1-generateSchedule').onclick = () => this.generateSchedule();
                document.getElementById('s1-printPage').onclick = () => this.printPage();
                this.ui.fontSizeInput.onchange = (e) => this.applyFontSize(e.target.value + 'pt');
                this.ui.scheduleActionsSelect.onchange = () => this.handleScheduleActions();
                this.ui.restoreFile.onchange = (e) => this.restoreScheduleData(e.target.files[0]);
    document.getElementById('s1-calculateWorkdays').onclick = () => this.calculateWorkdays();
                this.ui.workTypeSelect.onchange = () => this.handleWorkTypeChange();
                this.ui.vehicleCountInput.onchange = (e) => this.handleVehicleCountChange(e.target.value);
                document.getElementById('s1-saveRouteConfig').onclick = () => this.saveRouteConfig();

                document.getElementById('s1-showS2').onclick = () => this.showSection('S2');
                document.getElementById('s1-showS3').onclick = () => this.showSection('S3');
                document.addEventListener('click', (e) => this.clearEditMode(e));
            },

            /**
             * [데이터 연동] 노선 목록 드롭다운 채우기
             */
            populateRouteSelect() {
                const { routes } = DataManager.data.s1;
                const routeSelect = this.ui.routeNavigateSelect;
                routeSelect.innerHTML = ''; 
                const routeNames = Object.keys(routes);
                if (routeNames.length === 0) {
                    routeSelect.innerHTML = '<option value="">노선을 추가하세요</option>';
                    return;
                }
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '--- 노선 이동 ---';
                routeSelect.appendChild(defaultOption);
                
                routeNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    if (name === this.state.currentRoute) {
                         option.selected = true;
                    }
                    routeSelect.appendChild(option);
                });
            },

            /**
             * [데이터 연동] 특정 노선 데이터 로드 (S1 상태 변경)
             */
            loadRouteData(routeName, isRefresh = false) {
                const { routes } = DataManager.data.s1;
                if (!routeName || !routes[routeName]) {
                    // UI 초기화
                    this.ui.routeInput.value = '';
                    this.ui.companyInput.value = '';
                    this.ui.typeSelect.value = '마을';
                    this.ui.vehicleCountInput.value = 0;
                    this.handleVehicleCountChange(0);
                    // S1 내부 상태 초기화
                    this.state.fixedScheduleData = {};
                    this.state.tempScheduleData = {};
                    this.state.workTypeConfig = {};
                    this.state.currentVehicleColumns = [];
                    this.state.currentRoute = null;
                    
                    DataManager.setCurrentRoute(null);
                    
                    this.updateVehicleSelect();
                    if (this.ui.routeNavigateSelect) {
                        this.ui.routeNavigateSelect.value = '';
                    }
                    this.generateSchedule();
                    return;
                }

                // DataManager에 현재 노선 설정 요청 (알림 발생)
                // (S2 등에서 발생한 갱신(isRefresh)일 경우는 제외)
                if (!isRefresh) {
                    DataManager.setCurrentRoute(routeName);
                }
                
                this.state.currentRoute = routeName;
                const routeData = routes[routeName];

                // S1 내부 상태 변수 로드
                this.state.fixedScheduleData = routeData.fixedSchedule;
                this.state.tempScheduleData = routeData.tempSchedule;
                this.state.workTypeConfig = routeData.workTypeConfig;
                this.state.currentVehicleColumns = routeData.vehicleColumns || [];
                // S1 컨트롤 UI 업데이트
                this.ui.routeInput.value = routeName;
                this.ui.companyInput.value = routeData.companyName || '';
                this.ui.typeSelect.value = routeData.type || '마을';
                this.ui.vehicleCountInput.value = this.state.currentVehicleColumns.length;

                this.handleVehicleCountChange(this.state.currentVehicleColumns.length);
                this.updateVehicleSelect();
                if (this.ui.routeNavigateSelect) {
                    this.ui.routeNavigateSelect.value = routeName;
                }
                
                // 근무 현황표 다시 그리기
                this.generateSchedule();
            },

            /**
             * [데이터 연동] 노선 추가 또는 수정
             * [MODIFIED] - '번' 자동 추가 기능
             */
            addOrUpdateRoute() {
                let routeName = this.ui.routeInput.value.trim(); // 'let'으로 변경
                if (!routeName) {
                    alert('노선 번호를 입력하세요.');
                    return;
                }
                
                // [NEW] 요청: "번" 자동 추가 (예: "종로08" -> "종로08번")
                if (!routeName.endsWith('번')) {
                    routeName += '번';
                    console.log(`[S1] 노선 이름에 '번'이 추가되었습니다: ${routeName}`);
                }
                // [NEW] 수정된 이름(예: "종로08번")을 입력창에 다시 반영
                this.ui.routeInput.value = routeName;
                const companyName = this.ui.companyInput.value.trim();
                const type = this.ui.typeSelect.value;
                
                // DataManager에 데이터 수정을 요청
                DataManager.updateS1Data(s1_data => {
                    if (!s1_data.routes[routeName]) {
                        // 새 노선 추가
                     
    
                        // [수정 1] 차량 수를 컨트롤 박스에서 읽어와 기본 차량 목록(예: 차량1, 차량2...)을 생성합니다.
                        const vehicleCount = parseInt(this.ui.vehicleCountInput.value, 10) || 1;
                        const newVehicleColumns = Array.from({ length: vehicleCount }, (_, i) => `차량${i + 1}`);
                        if (newVehicleColumns.length === 0) {
                             newVehicleColumns.push('차량1');
                        }
            
 
                        s1_data.routes[routeName] = {
                            companyName: companyName,
                            type: type,
                 
                            vehicleColumns: newVehicleColumns, // [수정 1]
                            fixedSchedule: {},
                            tempSchedule: {},
                           
                            workTypeConfig: {}
                        };
                        alert(`새 노선 [${routeName}]이 추가되었습니다. 차량 수(${vehicleCount}대)와 차량 번호를 설정하세요.`);
                    } else {
                        // 기존 노선 정보 업데이트
                        s1_data.routes[routeName].companyName = companyName;
                        s1_data.routes[routeName].type = type;
                        alert(`[${routeName}] 노선 정보 (회사명, 종류)가 수정되었습니다.`);
                    }
                    s1_data.currentRoute = routeName;
                });

                // S1 상태 업데이트 및 UI 갱신 (DataManager가 알림을 보내지만, S1은 즉시 갱신)
                this.state.currentRoute = routeName;
                this.populateRouteSelect(); 
                this.loadRouteData(routeName);
            },

            /**
             * [데이터 연동] 노선 삭제
             */
            deleteRoute() {
                const routeName = this.ui.routeNavigateSelect.value;
                if (!routeName) {
                    alert('삭제할 노선을 [관련 노선 이동] 드롭다운에서 선택하세요.');
                    return;
                }

                if (confirm(`[${routeName}] 노선을 정말로 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`)) {
                    let newRouteToLoad = null;
                    // DataManager에 데이터 수정을 요청
                    DataManager.updateS1Data(s1_data => {
                        delete s1_data.routes[routeName];
                        newRouteToLoad = Object.keys(s1_data.routes)[0] || null;
                     
                        s1_data.currentRoute = newRouteToLoad;
                    });
                    // S1 상태 업데이트 및 UI 갱신
                    this.state.currentRoute = newRouteToLoad;
                    this.populateRouteSelect(); 
                    this.loadRouteData(newRouteToLoad); 
                    
                    alert(`[${routeName}] 노선이 삭제되었습니다.`);
                }
            },

           /**
             * [데이터 연동] 차량 번호 저장
             */
            saveRouteConfig() {
                if (!this.state.currentRoute) {
          
                    alert('먼저 노선을 선택하거나 추가하세요.');
                    return;
                }

                const inputs = this.ui.vehicleInputsContainer.querySelectorAll('input');
                const newVehicleColumns = [];
                inputs.forEach(input => {
                    // [MODIFIED] 비어있는 값은 '미입력'으로 저장
                    newVehicleColumns.push(input.value.trim() || '미입력');
                });
                
                // [NEW] S2 순환주기 베이스 리스트(baseOrder)도 함께 업데이트
                DataManager.updateS2Data(s2_data => {
                    const routeName = this.state.currentRoute;
                    if (!s2_data[routeName]) s2_data[routeName] = {};
                    if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
    
                 
                    // S1과 동일한 정렬된 리스트 (미입력 제외)
                    const s1_base_list = newVehicleColumns.filter(v => v && v !== '미입력');
                    
         
                    const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
                    s1_base_list.sort(collator.compare);
                    
                    // S2의 baseOrder를 S1의 새 목록 기준으로 업데이트
            
                    // (기존 순서는 최대한 유지하되, 없어진 차는 빼고, 새로 생긴 차는 뒤에 추가)
                    const old_s2_order = s2_data[routeName]._settings.baseOrder || [];
                    const new_s2_order = [];
                    const s1_set = new Set(s1_base_list);
                    
                    // 1. 기존 S2 순서 중 S1에 아직 있는 차들만 순서대로 추가
                    old_s2_order.forEach(car => {
                        if (s1_set.has(car)) {
                            new_s2_order.push(car);
             
                            s1_set.delete(car); // S1 목록에서 제거
                        }
                    });
                    // 2. S1 목록에 남은 차들(새로 추가된 차)을 S2 순서 뒤에 추가
                    s1_set.forEach(car => {
                        new_s2_order.push(car);
                    });

                    s2_data[routeName]._settings.baseOrder = new_s2_order;
                    console.log(`[S1->S2] ${routeName} 노선의 S2 baseOrder가 갱신되었습니다.`);
                });
                
                // DataManager에 S1 데이터 수정을 요청
                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[this.state.currentRoute];
                    if (routeData) {
                        routeData.vehicleColumns = newVehicleColumns;
      
                    }
                });
                
                // [MODIFIED] loadRouteData를 호출하여 S1 상태 및 UI 전체 갱신
                this.loadRouteData(this.state.currentRoute);
                alert(`[${this.state.currentRoute}] 노선의 차량 번호가 저장되었습니다. (S2 목록도 갱신됨)`);
            },

            /**
             * (UI) 차량 수 변경 시 입력란 동적 생성
             * [MODIFIED] - '차량X'를 값 대신 placeholder로 사용
             */
            handleVehicleCountChange(countStr) {
             
                const count = parseInt(countStr) || 0;
                this.ui.vehicleCountDisplay.textContent = count;
                const container = this.ui.vehicleInputsContainer;
                container.innerHTML = '';
                
                container.style.flexDirection = 'row'; 
                container.style.alignItems = 'unset';

                const existingColumns = this.state.currentVehicleColumns || [];
                
                for (let i = 0; i < count; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    const existingValue = existingColumns[i] || '';
                    const defaultPlaceholder = `차량 ${i + 1}`; // 기본 플레이스홀더

                    // [MODIFIED] "차량X", "미입력", "" 인지 확인
                    const isDefaultValue = /^차량\d+$/.test(existingValue);
                    const isNotEntered = (existingValue === '미입력');

                    if (isDefaultValue || isNotEntered || existingValue === '') {
                        // 기본값이거나, "미입력"이거나, 비어있으면 value를 비우고 placeholder를 설정
                        input.value = '';
                        input.placeholder = isNotEntered ? '미입력' : defaultPlaceholder;
                    } else {
                        // "5518" 등 실제 데이터가 있으면 value에 설정
                        input.value = existingValue;
                        input.placeholder = defaultPlaceholder;
                    }
                    
                    // [NEW] 사용자가 클릭(포커스)하면 기존 텍스트를 전체 선택하여 바로 입력할 수 있도록 함
                    input.onfocus = (e) => {
                     
                        e.target.select();
                    };

                    container.appendChild(input);
                }
            },
            
            /**
             * (UI) 차량 선택 드롭다운 업데이트
             */
            updateVehicleSelect() {
              
                const vehicleSelect = this.ui.vehicleSelect;
                vehicleSelect.innerHTML = '<option value="">차량 선택</option>';
                
                if (this.state.currentVehicleColumns.length > 0) {
                     vehicleSelect.innerHTML += '<option value="ALL_VEHICLES" style="font-weight:bold; background-color:#e0e0e0;">--- 전체차량 ---</option>';
                }

                this.state.currentVehicleColumns.forEach(colName => {
                    if(colName && colName !== '미입력') {
                        const option = document.createElement('option');
                        option.value = colName;
    
                        option.textContent = colName;
                        vehicleSelect.appendChild(option);
                    }
                });
            },

            /**
             * (Util) 요일 이름 반환
             */
            getDayName(dayOfWeek) {
                return ['일', '월', '화', '수', '목', '금', '토'][dayOfWeek];
            },
            
            /**
             * (Util) 공휴일 확인
             */
            isPublicHoliday(date) {
                const year = date.getFullYear();
                if (year !== 2025) return false; // 2025년 데이터만 있음
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const mmdd = `${month}-${day}`;
                return this.publicHolidays2025[mmdd] || false;
            },

            /**
             * (UI) 셀 내용물(이름) HTML 생성
             */
            renderCellContent(names) {
                if (!names || names.length === 0) return '';
                
                return names.map(item => {
                    const text = item.text.trim();
                    // [★★★ 수정 ★★★] '휴무'도 빈 칸(.)으로 표시
                    const display = (text === '' || text === '휴무') ? '.' : text;
                    const hiddenClass = (text === '' || text === '휴무') ? ' hidden-x' : '';
               
                    const boldClass = item.bold ? ' bold-name' : ''; 
                    return `<span class="name-entry${hiddenClass}${boldClass}">${display}</span>`;
                }).join('');
            },

            /**
             * (UI) 셀 편집 모드 진입
             */
            editCell(cell, colId, dateString, dayOfWeek) {
                if (cell.classList.contains('edit-mode')) return;
                
                // 기존 편집 모드 셀 닫기
                document.querySelectorAll('#section1 td.edit-mode').forEach(editCell => { 
                    const prevColId = editCell.dataset.colId;
                    const prevDateString = editCell.dataset.dateString;
                    const originalNames = (this.state.scheduleData[prevDateString] && this.state.scheduleData[prevDateString][prevColId]) || [{ text: '', bold: false }, { text: '', bold: false }];
                    editCell.classList.remove('edit-mode');
                    editCell.innerHTML = this.renderCellContent(originalNames);
                });
                
                const currentNames = (this.state.scheduleData[dateString] && this.state.scheduleData[dateString][colId]) || [{ text: '', bold: false }, { text: '', bold: false }];
                
                // [★★★ 수정 ★★★] '휴무'는 빈칸으로 표시
                const morningValue = (currentNames[0] && currentNames[0].text !== '휴무') ? currentNames[0].text : '';
                const afternoonValue = (currentNames[1] && currentNames[1].text !== '휴무') ? currentNames[1].text : '';
                
                const isBiweeklySunday = (this.state.workTypeConfig[colId] === 'biweekly' && dayOfWeek === 0);

                cell.classList.add('edit-mode');
                cell.dataset.colId = colId;
                cell.dataset.dateString = dateString;
                cell.dataset.dayOfWeek = dayOfWeek;
                
                cell.innerHTML = `
                    <input type="text" class="morning-input" value="${morningValue}" placeholder="오전 (비우면 휴무)" data-bold="${currentNames[0].bold}">
                    <input type="text" class="afternoon-input" value="${afternoonValue}" placeholder="오후 (비우면 휴무)" data-bold="${currentNames[1].bold}">
                    <div class="cell-buttons">
                        <button class="btn-fixed" ${isBiweeklySunday ? 'disabled title="격주 근무 차량은 일요일 고정 저장이 불가능합니다."' : ''}>고정</button>
                        <button class="btn-temp">임시</button>
                        <button class="btn-highlight-am">오전 강조</button>
                        <button class="btn-highlight-pm">오후 강조</button>
             
                        <button class="btn-delete">삭제</button>
                    </div>
                `;
                cell.querySelector('.morning-input').focus();

                // 새로 생성된 버튼들에 이벤트 리스너 바인딩
                const buttons = cell.querySelector('.cell-buttons');
                buttons.querySelector('.btn-fixed').onclick = (e) => { e.stopPropagation(); this.saveFixedCell(cell); };
                buttons.querySelector('.btn-temp').onclick = (e) => { e.stopPropagation(); this.saveTempCell(cell); };
                buttons.querySelector('.btn-highlight-am').onclick = (e) => { e.stopPropagation(); this.highlightCell(cell, 'am'); };
                buttons.querySelector('.btn-highlight-pm').onclick = (e) => { e.stopPropagation(); this.highlightCell(cell, 'pm'); };
                buttons.querySelector('.btn-delete').onclick = (e) => { e.stopPropagation(); this.deleteCell(cell); };
            },
            
            /**
             * (UI) 편집 모드 해제
             */
            clearEditMode(event) {
                // S1의 날짜/요일 셀 클릭 시
    
                if (event.target.matches('#section1 td:nth-child(1)') || event.target.matches('#section1 td:nth-child(2)')) {
                    const editCell = document.querySelector('#section1 td.edit-mode');
                    if (editCell) {
                        const prevColId = editCell.dataset.colId;
                        const prevDateString = editCell.dataset.dateString;
                        const originalNames = (this.state.scheduleData[prevDateString] && this.state.scheduleData[prevDateString][prevColId]) || [{ text: '', bold: false }, { text: '', bold: false }];
                        editCell.classList.remove('edit-mode');
                        editCell.innerHTML = this.renderCellContent(originalNames);
                    }
                }
            },

            /**
             * (Util) 편집 셀에서 이름/강조 정보 가져오기
             * [★★★ 수정 ★★★] 비어있으면 "휴무" 대신 빈칸("")으로 저장
             */
           
             getNamesAndBoldStateFromCell(cellElement) {
                const morningInput = cellElement.querySelector('.morning-input');
                const afternoonInput = cellElement.querySelector('.afternoon-input');
                
                const morningText = morningInput.value.trim();
                const afternoonText = afternoonInput.value.trim();
                
                return [ 
                    { text: morningText === '' ? '' : morningText, bold: morningInput.dataset.bold === 'true' }, 
                    { text: afternoonText === '' ? '' : afternoonText, bold: afternoonInput.dataset.bold === 'true' } 
                ];
            },

            /**
             * (UI) 오전/오후 강조 토글
             */
            highlightCell(cellElement, timeOfDay) {
                let inputElement = cellElement.querySelector(timeOfDay === 'am' ? '.morning-input' : '.afternoon-input');
                if (inputElement) {
                    const newState = !(inputElement.dataset.bold === 'true');
                    inputElement.dataset.bold = newState; 
                    inputElement.style.fontWeight = newState ? 'bold' : 'normal';
                }
            },

            /**
             * [데이터 연동] '고정' 저장
             */
            saveFixedCell(cellElement) {
                const { colId, dayOfWeek, dateString } = cellElement.dataset;
                const namesToSave = this.getNamesAndBoldStateFromCell(cellElement); // [수정] 비어있으면 ''로 저장됨
                const workType = this.state.workTypeConfig[colId] || 'normal';
                
                if (workType === 'biweekly' && dayOfWeek === '0') {
                    alert('격주 근무 차량은 일요일 고정 저장이 불가능합니다.');
                    return;
                }

                // DataManager에 데이터 수정을 요청
                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[this.state.currentRoute];
                    if (!routeData) return;

                
                    const currentRecurringKey = `${dayOfWeek}-${colId}`;
                    if (!routeData.fixedSchedule[currentRecurringKey]) {
                        routeData.fixedSchedule[currentRecurringKey] = [];
                    }
                    routeData.fixedSchedule[currentRecurringKey] = 
                         routeData.fixedSchedule[currentRecurringKey].filter(
                            entry => entry.dateString !== dateString
                        );
                    routeData.fixedSchedule[currentRecurringKey].push({ dateString: dateString, names: namesToSave });

                    for (const key in routeData.fixedSchedule) {
                        routeData.fixedSchedule[key].sort((a, b) => new Date(b.dateString) - new Date(a.dateString));
                    }
                    
                    this.state.fixedScheduleData = routeData.fixedSchedule;
                });
                
                this.generateSchedule();
            },

            /**
             * [데이터 연동] '임시' 저장
             */
            saveTempCell(cellElement) {
                const { colId, dateString } = cellElement.dataset;
                const namesToSave = this.getNamesAndBoldStateFromCell(cellElement); // [수정] 비어있으면 ''로 저장됨

                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[this.state.currentRoute];
                    if (!routeData) return;

                    if (!routeData.tempSchedule[dateString]) routeData.tempSchedule[dateString] = {};
                    routeData.tempSchedule[dateString][colId] = namesToSave;
   
                    this.state.tempScheduleData = routeData.tempSchedule;
                });
                
                this.generateSchedule();
            },

            /**
             * [데이터 연동] '삭제'
             * [★★★ 수정 ★★★] '휴무' 대신 빈칸('')으로 덮어쓰기
             */
            deleteCell(cellElement) {
                const { colId, dayOfWeek, dateString } = cellElement.dataset;
                
                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[this.state.currentRoute];
                    if (!routeData) return;

                    // 1. 임시 데이터 삭제
                    if (routeData.tempSchedule[dateString]?.[colId]) {
                        delete routeData.tempSchedule[dateString][colId];
      
                        if (Object.keys(routeData.tempSchedule[dateString]).length === 0) {
                            delete routeData.tempSchedule[dateString];
                        }
                    }

                    // 2. 고정 데이터 '삭제' (사실상 ''로 덮어쓰기)
                    const recurringKey = `${dayOfWeek}-${colId}`;
                    if (!routeData.fixedSchedule[recurringKey]) {
                        routeData.fixedSchedule[recurringKey] = [];
                    }
              
       
                    const blankNames = [{ text: '', bold: false }, { text: '', bold: false }]; // [★★★ 수정 ★★★]
  
                    routeData.fixedSchedule[recurringKey] = 
                        routeData.fixedSchedule[recurringKey].filter(entry => entry.dateString !== dateString);
                    
                    routeData.fixedSchedule[recurringKey].push({ dateString: dateString, names: blankNames });
                    routeData.fixedSchedule[recurringKey].sort((a, b) => new Date(b.dateString) - new Date(a.dateString));
                    
                    this.state.fixedScheduleData = routeData.fixedSchedule;
                    this.state.tempScheduleData = routeData.tempSchedule;
                });
                
                this.generateSchedule();
            },
            
            /**
             * [데이터 연동] 현재 노선 초기화
             */
            resetAllFixedSchedules() {
                if (!this.state.currentRoute) {
                    alert('초기화할 노선이 선택되지 않았습니다.');
                    return;
                }
                const password = prompt(`[${this.state.currentRoute}] 노선의 모든 고정/임시 근무표 및 근무형태 설정을 삭제하시려면 비밀번호를 입력하세요.`);
                
                if (password === "201023") {
                    if (confirm(`[${this.state.currentRoute}] 노선의 모든 근무표 데이터를 삭제합니다. 계속하시겠습니까?`)) {
                        
                        // DataManager에 데이터 수정을 요청
                
                        DataManager.updateS1Data(s1_data => {
                            const routeData = s1_data.routes[this.state.currentRoute];
                            if (routeData) {
                             
                                routeData.fixedSchedule = {};
                                routeData.tempSchedule = {};
                                routeData.workTypeConfig = {};
                           
      
                                // S1 내부 상태도 즉시 동기화
                                this.state.fixedScheduleData = routeData.fixedSchedule;
                        
                                this.state.tempScheduleData = routeData.tempSchedule;
                                this.state.workTypeConfig = routeData.workTypeConfig;
                            }
                        });
                        
                        // [NEW] S2의 설정(_settings)도 함께 초기화
                        DataManager.updateS2Data(s2_data => {
                            const routeName = this.state.currentRoute;
                            if (s2_data[routeName] && s2_data[routeName]._settings) {
      
                                delete s2_data[routeName]._settings;
                                console.log(`[S1->S2] ${routeName} 노선의 S2 설정도 초기화되었습니다.`);
                            }
        
                        });
                        
                        // 화면 갱신
                        this.generateSchedule();
                        alert(`[${this.state.currentRoute}] 노선의 근무표가 초기화되었습니다.`);
                    }
                } else {
                    alert("비밀번호 확인 후 신청하세요.");
                }
            },

            /**
             * [데이터 연동] 전체 데이터 저장 (백업) - [수정됨]
             */
            backupScheduleData() {
                const backupData = DataManager.data.s1;
                const jsonString = JSON.stringify(backupData);
                const now = new Date();
                // [수정] 날짜 포맷 (YYYYMMDD)
                const dateString = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
                let companyName = "전체";
                let routeName = "전체";
                
                if (this.state.currentRoute && DataManager.data.s1.routes[this.state.currentRoute]) {
                    const routeData = DataManager.data.s1.routes[this.state.currentRoute];
                    companyName = (routeData.companyName || "회사없음").replace(/\s/g, ''); // 공백 제거
                    routeName = this.state.currentRoute.replace(/\s/g, ''); // 공백 제거
                }
                
                // [수정] 한글 파일명으로 변경
                const filename = `${companyName}_${routeName}_근무현황표(S1)_${dateString}.json`;
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                // [수정] 알림 메시지
                alert(`근무현황표(S1) 데이터 파일 (${filename})이 다운로드 폴더에 JSON 파일로 저장됩니다.`);
            },

            /**
             * [데이터 연동] 전체 데이터 불러오기 (복원)
             */
            restoreScheduleData(file) {
                const selectElement = this.ui.scheduleActionsSelect;
                if (!file) {
                    selectElement.value = '';
                    return;
                }
                if (!confirm(`[${file.name}] 파일을 업로드하여 저장된 *모든* 노선의 근무표(S1)를 불러오시겠습니까? (현재 모든 S1 데이터는 덮어쓰여집니다.)`)) {
                    this.ui.restoreFile.value = '';
                    selectElement.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedData = JSON.parse(event.target.result);
                        if (!loadedData.routes || loadedData.currentRoute === undefined) {
                             alert('파일 형식이 올바르지 않거나 데이터가 부족합니다. (routes, currentRoute 속성 필요)');
                             throw new Error('Invalid saved file structure');
                        }
                        
                        // DataManager에 데이터 수정을 요청 (완전 덮어쓰기)
                        DataManager.updateS1Data(s1_data => {
              
                            s1_data.routes = loadedData.routes;
                            s1_data.currentRoute = loadedData.currentRoute;
                        });
                        
                        // S1 상태 업데이트 및 UI 갱신
                        this.state.currentRoute = loadedData.currentRoute;
                        this.populateRouteSelect();
                        this.loadRouteData(this.state.currentRoute);
                        alert(`[${file.name}] 파일로부터 S1 전체 데이터 불러오기를 완료했습니다. 화면을 확인해주세요.`);
                    } catch (e) {
                        alert('파일을 읽는 도중 오류가 발생했습니다. 파일이 손상되었거나 JSON 형식이 아닙니다.');
                        console.error('Restore Error:', e);
                    } finally {
                        this.ui.restoreFile.value = '';
                        selectElement.value = '';
                    }
                };
                reader.onerror = () => {
                    alert('파일을 읽을 수 없습니다.');
                    this.ui.restoreFile.value = '';
                    selectElement.value = '';
                };
                reader.readAsText(file);
            },

           /**
             * (UI) 근무 현황표 테이블 생성 (핵심)
             * [수정됨] '미입력' 컬럼도 정상적으로 데이터를 계산하고 클릭 가능하도록 수정
             */
            generateSchedule() {
              
                if (!this.state.currentRoute) {
                    this.ui.scheduleContainer.innerHTML = '<table><caption id="tableCaption">표시할 노선을 선택하거나 추가해주세요.</caption></table>';
                    return;
                }

                const year = parseInt(this.ui.yearInput.value);
                const month = parseInt(this.ui.monthInput.value);
                const selectedOption = document.querySelector('#section1 input[name="displayOption"]:checked').value;
                const applyHolidays = this.ui.holidaySelect.value === 'apply';
                const { routeData } = DataManager.getCurrentRouteData();
                if (!routeData) return; // 노선이 없으면 중단

                const companyName = routeData.companyName || '회사명 없음';
                const VEHICLE_COLS = routeData.vehicleColumns || [];
                
                this.ui.scheduleContainer.innerHTML = '';
                const startDate = new Date(year, month - 1, selectedOption === '1' ? 1 : 16);
                const endDate = (selectedOption === '1') ? new Date(year, month - 1, 15) : new Date(year, month, 0);
                const colsPerPage = 12; 
                const colChunks = [];
                for (let i = 0; i < VEHICLE_COLS.length; i += colsPerPage) {
                    colChunks.push(VEHICLE_COLS.slice(i, i + colsPerPage));
                }
                if (colChunks.length === 0) {
                     colChunks.push([]);
                }

                const dateRange = [];
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    dateRange.push(new Date(d));
                }
                
                this.state.scheduleData = {};
                
                colChunks.forEach((vehicleChunk, chunkIndex) => {
                    
                    const table = document.createElement('table');
                    if (chunkIndex > 0) {
                        table.style.pageBreakBefore = 'always';
    
                    }

                    // 1. 캡션(제목) 생성
                    const caption = document.createElement('caption');
                    let captionText = `${companyName} [${this.state.currentRoute}] ${year}년 ${month}월 ${startDate.getDate()}일 ~ ${endDate.getDate()}일까지 근무현황표`;
        
                    if (colChunks.length > 1) {
                        captionText += ` (페이지 ${chunkIndex + 1}/${colChunks.length})`;
                    }
                    if (chunkIndex === 0) caption.id = 'tableCaption';
        
                    caption.textContent = captionText;
                    table.appendChild(caption);

                    // 2. 헤더 생성
                    const thead = document.createElement('thead');
                    
                    if (chunkIndex === 0) thead.id = 'scheduleHeader';
                    // [수정] '미입력'도 헤더에 표시 (클릭 영역 확보)
                    const headerHTML = `<tr><th style="width: 4%;">월일</th><th style="width: 4%;">요일</th>${vehicleChunk.map(c => `<th>${c}</th>`).join('')}</tr>`;
                    thead.innerHTML = headerHTML;
                    table.appendChild(thead);

                    // 3. 바디 생성
                    const tbody = document.createElement('tbody');
                    if (chunkIndex === 0) tbody.id = 'scheduleBody';

                    // 날짜별(행) 데이터 계산
                    dateRange.forEach(d => {
                        const dateString = d.toISOString().slice(0, 10);
                        const dayOfWeek = d.getDay();
             
            
                        if (!this.state.scheduleData[dateString]) { 
                            let cellsContent = {};
                            VEHICLE_COLS.forEach(colId => { 
                                // [수정] '미입력'일 때 return; 하던 로직 삭제
                                // if (colId === '미입력') { ... return; } <-- 이 부분 삭제됨

                 
                                let appliedNames = [{ text: '', bold: false }, { text: '', bold: false }]; // [★★★ 수정 ★★★] 기본값 ''

                                
                                if (this.state.tempScheduleData[dateString] && this.state.tempScheduleData[dateString][colId]) {
   
                                    appliedNames = this.state.tempScheduleData[dateString][colId];
                                } 
                                
                                else {
                                    const recurringKey = `${dayOfWeek}-${colId}`;
                                    if (this.state.fixedScheduleData[recurringKey]) {
                                        let anchorEntry = null;
                                        for (const entry of this.state.fixedScheduleData[recurringKey]) {
                                            if (new Date(dateString) >= new Date(entry.dateString)) {
                                             
                                                anchorEntry = entry;
                                                break; 
                                            }
                                        }

                                        if (anchorEntry) {
           
                                            const workType = this.state.workTypeConfig[colId] || 'normal';
                                            if (workType === 'biweekly' && dayOfWeek !== 0) {
                                                const anchorDate = new Date(anchorEntry.dateString);
                                                const currentDate = new Date(dateString);
                                                anchorDate.setHours(0, 0, 0, 0);
                                                currentDate.setHours(0, 0, 0, 0);
                                                const msInDay = 24 * 60 * 60 * 1000;
                                                const diffInDays = Math.round((currentDate.getTime() - anchorDate.getTime()) / msInDay);
                                                const weekDifference = Math.floor(diffInDays / 7);
                                                
                                                if (weekDifference % 2 === 1) {
                                                    appliedNames = [anchorEntry.names[1], anchorEntry.names[0]];
                                                } else {
                                                    appliedNames = anchorEntry.names;
                                                }
                                            } else {
                                                appliedNames = anchorEntry.names;
                                            }
                                        }
                                    }
                        
                                }
                                cellsContent[colId] = appliedNames;
                            });
                            this.state.scheduleData[dateString] = cellsContent; 
                        }

                        // 행(Row) HTML 생성
                        const holidayName = applyHolidays ? this.isPublicHoliday(d) : false;
                        const isHoliday = !!holidayName;
                        let rowClass = '';
                        const dayName = this.getDayName(dayOfWeek); 
                        let mainColor = '#333';
                        let subText = '';

                        if (isHoliday) {
                            rowClass = 'holiday';
                            mainColor = '#cc0000'; subText = holidayName.substring(0, 2); 
                        } else if (dayOfWeek === 0) {
                            rowClass = 'sunday';
                            mainColor = '#cc0000'; subText = '일요'; 
                        } else if (dayOfWeek === 6) {
                            rowClass = 'saturday';
                            mainColor = '#0000cc'; subText = '토요';
                        }
                        
                        let dayCellContent;
                        if (dayOfWeek === 0 || dayOfWeek === 6 || isHoliday) {
                            dayCellContent = `<div class="day-cell-content"><span class="day-name-main" style="color: ${mainColor};">${dayName}</span><span class="sub-day-info" style="color: ${mainColor};">${subText}</span></div>`;
                        } else {
                            dayCellContent = `<div class="day-cell-content"><span class="day-name-main" style="color: ${mainColor};">${dayName}</span><span class="sub-day-info" style="color: ${mainColor};"></span></div>`;
                        }

                        // 데이터 셀(TD) HTML 생성
                        // [수정] '미입력' 컬럼을 구분하는 삼항 연산자 삭제
                        const dataCellsHTML = vehicleChunk.map(colId =>
             
                            `<td onclick="S1_Module.editCell(this, '${colId}', '${dateString}', ${dayOfWeek})">${this.renderCellContent(this.state.scheduleData[dateString][colId])}</td>`
                        ).join('');
                        
                        tbody.insertAdjacentHTML('beforeend', `
                            <tr class="${rowClass}">
                                <td>${d.getDate()}</td>
                                <td>${dayCellContent}</td> 
     
                                ${dataCellsHTML}
                            </tr>`);
                    }); 

                    table.appendChild(tbody);
                    this.ui.scheduleContainer.appendChild(table);
                }); 
            },

            /**
             * (Util) 근무일수 계산기
             * [★★★ 수정 ★★★] '휴무'가 아닌 ''(빈칸)을 휴무로 간주
             */
            calculateWorkdays() {
                if (!this.state.currentRoute) {
                    alert('근무일수를 계산할 노선이 없습니다.');
                    return;
                }
                
                const { routeData } = DataManager.getCurrentRouteData();
                if (!routeData) return;
                
                const year = parseInt(this.ui.yearInput.value);
                const month = parseInt(this.ui.monthInput.value);
                const VEHICLE_COLS = routeData.vehicleColumns || [];
                const workdayCounts = {};
                const shiftCounts = {};
                const allNames = new Set();
                
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0);
                
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateString = d.toISOString().slice(0, 10);
                    const dayOfWeek = d.getDay();
                    let dailyNames = {}; 

                    VEHICLE_COLS.forEach(colId => {
                        if (colId === '미입력') return; 

                        let appliedNames = [{ text: '', bold: false }, { text: '', bold: false }]; // [★★★ 수정 ★★★] 기본값 ''
                       
                        if (routeData.tempSchedule[dateString] && routeData.tempSchedule[dateString][colId]) {
                           appliedNames = routeData.tempSchedule[dateString][colId];
                        } else {
                            const recurringKey = `${dayOfWeek}-${colId}`;
         
                            if (routeData.fixedSchedule[recurringKey]) {
                                for (const entry of routeData.fixedSchedule[recurringKey]) {
                                    if (new Date(dateString) >= new Date(entry.dateString)) {
                                        appliedNames = entry.names;
                                        break;
                                    }
                                }
                            }
                      
                        }
                        dailyNames[colId] = appliedNames;
                    });
                    
                    const dayWorkdays = new Set();
                    for (const colId in dailyNames) {
                        if (colId !== '비고' && colId !== '미입력') { 
                            dailyNames[colId].forEach((item, index) => {
                         
                                const name = item.text.trim();
                                if (name !== '' && name !== '휴무') { // [수정] '휴무'도 여전히 제외
                                    allNames.add(name);
              
                                    if (!shiftCounts[name]) shiftCounts[name] = { 오전: 0, 오후: 0 };
                                    if (index === 0) shiftCounts[name].오전++;
                                    else shiftCounts[name].오후++;
                                    
                                    dayWorkdays.add(name);
                                }
                        
                            });
                        }
                    }
                    dayWorkdays.forEach(name => {
                        if (!workdayCounts[name]) workdayCounts[name] = 0;
                        workdayCounts[name]++;
 
                    });
                }

                const combinedData = Array.from(allNames).map(name => ({
                    name: name, 
                    workdays: workdayCounts[name] || 0,
                    morningShifts: (shiftCounts[name] && shiftCounts[name].오전) || 0,
         
                    afternoonShifts: (shiftCounts[name] && shiftCounts[name].오후) || 0
                }));
                
                combinedData.sort((a, b) => b.workdays - a.workdays);
                
                const title = `[${this.state.currentRoute}] ${year}년 ${month}월 근무일수`;
                const tableHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead><tr>
                            <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">이름</th>
             
                            <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">오전</th>
                            <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">오후</th>
                            <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">총 근무일수</th>
    
                        </tr></thead>
                        <tbody>${combinedData.map(data => `
                            <tr>
                          
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.name}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.morningShifts}일</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.afternoonShifts}일</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.workdays}일</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`;
                
       
                const newWindow = window.open('', '_blank', 'width=600,height=400');
                newWindow.document.write(`<html><head><title>${title}</title><style>
                    body { font-family: Arial, sans-serif; margin: 20px; } h3 { text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
          
                    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; } th { background-color: #f2f2f2; }
                    .print-button { display: block; margin: 20px auto; padding: 10px 20px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; }
                    @media print { .print-button { display: none; } html, body { height: 100%; width: 100%; margin: 0; } }
                    </style></head><body><h3>${title}</h3>${tableHTML}<button class="print-button" onclick="window.print()">인쇄</button></body></html>`);
                newWindow.document.close();
            },

            /**
             * (UI) 인쇄
             */
            printPage() {
                const editCell = document.querySelector('#section1 td.edit-mode');
                if (editCell) {
                    const { colId, dateString } = editCell.dataset;
                    const originalNames = this.state.scheduleData[dateString]?.[colId] || [{ text: '', bold: false }, { text: '', bold: false }];
                    editCell.classList.remove('edit-mode');
                    editCell.innerHTML = this.renderCellContent(originalNames);
                }

                document.documentElement.style.setProperty('--print-margin-left', `${this.ui.marginLeftSelect.value}mm`);
                document.documentElement.style.setProperty('--print-margin-right', `${this.ui.marginRightSelect.value}mm`);
                
                const originalTitle = document.title;
                const captionText = document.getElementById('tableCaption').textContent;
                let newTitle = "근무현황표";
                
                const matches = captionText.match(/\[(.*?)\] (\d{4})년 (\d{1,2})월 (\d{1,2})일 ~ (\d{1,2})일/);
                if (matches) {
                    newTitle = `${matches[1]} ${matches[2]}-${matches[3].padStart(2, '0')} (${matches[4].padStart(2, '0')}일-${matches[5].padStart(2, '0')}일)`;
                } else if (this.state.currentRoute) {
                    newTitle = `${this.state.currentRoute} 근무현황표`;
                }
                
                document.body.classList.remove('printing-section2', 'printing-section3');
                document.body.classList.add('printing-section1'); 

                const handleAfterPrint = () => {
                    document.title = originalTitle;
                    document.documentElement.style.removeProperty('--print-margin-left');
                    document.documentElement.style.removeProperty('--print-margin-right');
                    document.body.classList.remove('printing-section1'); 
                    window.removeEventListener('afterprint', handleAfterPrint);
                };
                window.addEventListener('afterprint', handleAfterPrint);
                
                document.title = newTitle;
                // [수정됨] 4. 인쇄 딜레이 제거 (CSS 로직 변경으로 불필요)
                window.print();
            },
            
            /**
             * (UI) 폰트 크기 적용
             */
            applyFontSize(size) {
                if (parseFloat(size) < 8) size = '8pt';
                if (parseFloat(size) > 20) size = '20pt';
                document.documentElement.style.setProperty('--worker-font-size', size);
            },

            /**
             * (UI) 데이터 관리 옵션 핸들러
             */
            handleScheduleActions() {
                const action = this.ui.scheduleActionsSelect.value;
                if (action === 'reset') this.resetAllFixedSchedules();
                else if (action === 'backup') this.backupScheduleData();
                else if (action === 'restore') this.ui.restoreFile.click();
                
                this.ui.scheduleActionsSelect.value = '';
            },

            /**
             * [데이터 연동] 근무 형태 변경
             */
            handleWorkTypeChange() {
                const selectedValue = this.ui.vehicleSelect.value;
                const workType = this.ui.workTypeSelect.value;
                
                if (!selectedValue || !workType) return;

                let workTypeName = '';
                if (workType === 'normal') workTypeName = '3/3 근무';
                else if (workType === 'biweekly') workTypeName = '격주 근무';
                else if (workType === 'five_day') workTypeName = '5일 근무';
                
                if (selectedValue === 'ALL_VEHICLES') {
                    const vehicleCount = this.state.currentVehicleColumns.filter(c => c !== '미입력').length;
                    if (vehicleCount === 0) {
                        alert('설정할 차량이 없습니다.');
                    } else if (confirm(`[${this.state.currentRoute}] 노선의 '미입력'을 제외한 *전체 차량* (${vehicleCount}대)의 근무형태를 [${workTypeName}]로 설정하고 저장하시겠습니까?`)) {
                        
                        DataManager.updateS1Data(s1_data => {
                            const routeData = s1_data.routes[this.state.currentRoute];
     
                            if (!routeData) return;
                            this.state.currentVehicleColumns.forEach(colId => {
                                if (colId !== '미입력') { 
        
                                    routeData.workTypeConfig[colId] = workType;
                                }
                            });
           
                            this.state.workTypeConfig = routeData.workTypeConfig;
                        });
                        alert(`[${this.state.currentRoute}] 노선의 전체 차량 근무형태가 [${workTypeName}]로 설정되었습니다. '고정' 저장 시 적용됩니다.`);
                    }
                } else {
                    const colId = selectedValue;
                    if (confirm(`차량 [${colId}]의 근무형태를 [${workTypeName}]로 설정하고 저장하시겠습니까?`)) {
                        
                        DataManager.updateS1Data(s1_data => {
                            const routeData = s1_data.routes[this.state.currentRoute];
            
                            if (!routeData) return;
                            routeData.workTypeConfig[colId] = workType;
                            this.state.workTypeConfig = routeData.workTypeConfig;
                      
                        });
                        alert(`차량 [${colId}]의 근무형태가 [${workTypeName}]로 설정되었습니다. '고정' 저장 시 적용됩니다.`);
                    }
                }
                
                this.ui.vehicleSelect.value = '';
                this.ui.workTypeSelect.value = '';
            },
            
            /**
             * (UI) 노선 이동 드롭다운 핸들러
             */
            handleRouteSelectChange(routeName) {
                if (routeName) {
           
                    this.loadRouteData(routeName);
                }
            },

            /**
             * (UI) 섹션 이동
             */
            showSection(sectionId) {
                document.getElementById('section1').style.display = 'none';
                document.getElementById('section2').style.display = 'none';
                document.getElementById('section3').style.display = 'none';
                document.querySelectorAll('.divider').forEach(d => d.style.display = 'none');
                
                const targetSection = document.getElementById(`section${sectionId.replace('S', '')}`);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    targetSection.scrollIntoView({ behavior: 'smooth' });
                }
            },

            /**
             * (UI) 전체 보기
             */
            showAllSections() {
                document.getElementById('section1').style.display = 'block';
                document.getElementById('section2').style.display = 'block';
                document.getElementById('section3').style.display = 'block'; 
                document.querySelectorAll('.divider').forEach(d => d.style.display = 'block');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },

            /**
             * (UI) 버전 정보 설정
             */
            setVersion() {
                try {
                    // [수정] 버전 정보
                    document.getElementById('version-display').textContent = 'Ver 5.4.3';
                } catch (e) {
                    console.error("버전 정보를 설정하는 데 실패했습니다.", e);
                    document.getElementById('version-display').textContent = 'Ver 5.4.3';
                }
            }
        };
/* ================================================================= */
        /* [Section 2] 승무 일지 JavaScript (수정됨) */
        /* ================================================================= */

        /**
         * 3. S2(승무일지) 모듈
         * - [수정] 날짜 네비게이션, 기간별 조회 기능 추가
         * - [★★★ 수정 ★★★] 테이블 레이아웃 변경 (8열 -> 9열)
         * - [수정] '시간 적용' 시 '오전 시작차량'을 1번으로 자동 회전
         * - [★★★ 수정 ★★★] 근무시간 '휴무' 선택 시 휴무자 칸 자동 입력
         * - [★★★ 수정 ★★★] S1 '휴무' -> ''(빈칸) 연동
         */
        const S2_Module = {
            // S2 UI 요소
            ui: {
                headerTitle: document.querySelector('#section2 .header-title'),
                fontSizeSelect: document.getElementById('font-size-select'),
                dispatchLogBody: document.getElementById('dispatch-log-body'),
                // 날짜 네비게이션
                prevDateBtn: document.getElementById('s2_prevDate'),
                todayBtn: document.getElementById('s2_today'),
                nextDateBtn: document.getElementById('s2_nextDate'),
                startDateInput: document.getElementById('s2_startDate'),
                endDateInput: document.getElementById('s2_endDate'),
                loadRangeBtn: document.getElementById('s2_loadRange'),
                // 모달
                restoreModal: document.getElementById('s2_restoreDateModal'),
                restoreFile: document.getElementById('s2_restoreFile'),
                cancelRestoreBtn: document.getElementById('s2_cancelRestoreBtn'),
                confirmRestoreBtn: document.getElementById('s2_confirmRestoreBtn'),
            },

            // S2 내부 상태
            state: {
                // [수정] s2_currentDates는 현재 조회 중인 날짜 목록
                s2_currentDates: [], // [ { date: Date, dateString: "YYYY-MM-DD" } ]
                S2_ROUTE_MAP: { 
                    '종로07번': '07',
                    '종로08번': '08',
                    '성동 3-1번': 'sd31',
                    '성동 3-2번': 'sd32'
                },
                S2_USED_VEHICLES: {}, 
                s2_draggedCell: null,
                s2_draggedRoute: null
            },
            
            // --- [추가] S2 순환주기 헬퍼 함수 ---
            addDays(date, days) {
                const result = new Date(date);
                result.setDate(result.getDate() + days);
                return result;
            },
            addMonths(date, months) {
                const result = new Date(date);
                result.setMonth(result.getMonth() + months);
                return result;
            },
            shuffleArray(array) {
                let currentIndex = array.length, randomIndex;
                const newArray = [...array]; 
                while (currentIndex !== 0) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [newArray[currentIndex], newArray[randomIndex]] = [
                        newArray[randomIndex], newArray[currentIndex]];
                }
                return newArray;
            },
            rotateArray(array, count) {
                const len = array.length;
                if (len === 0) return [];
                const netCount = count % len;
                if (netCount === 0) return [...array];
                
                if (netCount > 0) { // 양수 (1,2,3 -> 2,3,1)
                    return [...array.slice(netCount), ...array.slice(0, netCount)];
                } else { // 음수 (1,2,3 -> 3,1,2)
                    return [...array.slice(netCount), ...array.slice(0, len + netCount)];
                }
            },
            // --- [추가 끝] ---


            /**
             * S2 모듈 초기화 (DOM 로드 시 1회 실행)
             */
            initialize() {
                console.log("S2: 초기화 시작");
                DataManager.subscribe(this); // DataManager에 S2 모듈 등록
                DataManager.loadS2Data(); // S2 전용 일지 데이터 로드
                
                this.bindEventListeners();
                
                // [수정] 오늘 날짜로 초기화 및 화면 로드
                this.loadToday();
                
                // --- [!!! NEW !!!] ---
                // [핵심] 자동 순환 로직 실행
                // S1, S2, S3 데이터 로드가 모두 끝난 후 실행
                this.applyAutoRotation();
                // --- [!!! NEW !!!] ---

                // S1 데이터 기준으로 S2 화면 첫 그리기
                this.refreshDispatchLog();
                console.log("S2: 초기화 완료.");
            },
            
            /**
             * [수정] 오늘 날짜 로드
             */
            loadToday() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayString = DataManager.getTodayDateString(today);

                this.state.s2_currentDates = [{ date: today, dateString: todayString }];
                this.ui.startDateInput.value = todayString;
                this.ui.endDateInput.value = todayString;

                this.refreshDispatchLog();
            },

            /**
             * [핵심] DataManager로부터 알림을 처리하는 함수 (S1에서 데이터 변경 시)
             */
            onDataChanged(event, payload) {
                if (event === 's1_data_changed') {
                    console.log("[S2] S1로부터 데이터 변경 알림 수신. S2 갱신 시작.");
                    this.refreshDispatchLog();
                }
            },

            /**
             * S2의 모든 이벤트 리스너 바인딩
             */
            bindEventListeners() {
                document.getElementById('s2-showAll').onclick = () => S1_Module.showAllSections();
                this.ui.fontSizeSelect.onchange = (e) => this.changeFontSize(e.target.value);
                
                document.getElementById('s2-backupLog').onclick = () => this.backupLogData();
                document.getElementById('s2-showRestoreModal').onclick = () => this.showRestoreModal();
                
                document.getElementById('s2-refreshLog').onclick = () => {
                    if (confirm("현재 조회된 *모든 날짜*의 승무일지를 새로고침 하시겠습니까?\n\n[확인]을 누르면 현재 선택된 날짜들의 승무일지(S2)에 입력된 [시간/근무시간] 데이터가 삭제되고 S1 근무표 기준으로 다시 불러옵니다.\n(출차순서 및 시간적용 설정은 변경되지 않습니다.)")) {
                        this.resetS2LogForCurrentDates(); // [수정]
                        this.refreshDispatchLog(); // S1 기준으로 다시 그림
                    }
                };
                
                document.getElementById('s2-printPage').onclick = () => this.printPage();

                // [수정] 날짜 네비게이션
                this.ui.prevDateBtn.onclick = () => this.navigateDate(-1);
                this.ui.todayBtn.onclick = () => this.loadToday();
                this.ui.nextDateBtn.onclick = () => this.navigateDate(1);
                this.ui.loadRangeBtn.onclick = () => this.loadDateRange();

                // 모달 버튼
                this.ui.cancelRestoreBtn.onclick = () => this.hideRestoreModal();
                this.ui.confirmRestoreBtn.onclick = () => this.triggerRestore();
                this.ui.restoreFile.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.restoreLogData(file);
                        this.hideRestoreModal();
                    }
                };
                
                // (동적 생성 요소 이벤트는 dispatchLogBody에 위임)
                const logBody = this.ui.dispatchLogBody;
                
                logBody.onchange = (e) => {
                    const target = e.target;
                    
                    // 1. 시간 입력 (HH:MM 자동 포맷)
                    if (target.tagName === 'INPUT' && (target.getAttribute('name')?.startsWith('start_time_') || target.getAttribute('name')?.startsWith('pm_start_time_'))) {
                        target.value = this.formatTimeInput(target.value);
                        this.saveS2LogEntryFromElement(target);
                    }
                    // 2. 근무 시간 선택
                    else if (target.tagName === 'SELECT' && target.classList.contains('s2-work-hours-select')) {
                        // [★★★ 수정 ★★★] 휴무자 자동 입력 로직
                        this.handleWorkHoursChange(target); 
                        this.saveS2LogEntryFromElement(target);
                    }
                    // 3. [수정] 노선별 순환주기 변경
                    else if (e.target.classList.contains('dispatch-cycle-select')) {
                        e.stopPropagation();
                        const routeId = e.target.closest('.dispatch-cycle-container').dataset.routeId;
                        const routeName = document.getElementById(`route-${routeId}`).dataset.routeName;
                        const cycle = e.target.value;
                        this.changeDispatchCycle(routeName, cycle);
                    }
                    // 4. 차량 번호 변경 (드롭다운)
                    else if (e.target.classList.contains('car-select-dropdown')) {
                        e.stopPropagation();
                        const routeName = e.target.closest('.route-section').dataset.routeName;
                        this.changeCarNumber(e.target, routeName);
                    }
                    // 5. [NEW] 시간 설정값 변경 (자동저장)
                    else if (target.closest('.schedule-options')) {
                        e.stopPropagation();
                        const routeId = target.closest('.route-section').id.replace('route-', '');
                        const routeName = document.getElementById(`route-${routeId}`).dataset.routeName;
                        this.saveScheduleSettings(routeName, routeId); // 설정값 저장
                    }
                };
                
                logBody.onclick = (e) => {
                    const carCell = e.target.closest('.car-number-cell');
                    const driverCell = e.target.closest('td[data-edit-type="driver"]');
                    const dispatchBtn = e.target.closest('.dispatch-button');

                    if (carCell) {
                        e.preventDefault();
                        const routeName = carCell.closest('.route-section').dataset.routeName;
                        this.toggleCarNumberEditMode(carCell, routeName);
                        return;
                    }
                    if (driverCell) {
                        e.preventDefault();
                        this.toggleEditMode(driverCell);
                        return;
                    }
                    if (dispatchBtn) {
                        e.preventDefault();
                        const routeId = dispatchBtn.closest('.dispatch-buttons-container').dataset.routeId;
                        const routeName = document.getElementById(`route-${routeId}`).dataset.routeName;
                        const order = dispatchBtn.dataset.order;
                        this.changeDispatchOrder(routeName, order, dispatchBtn.closest('.dispatch-buttons-container'));
                        return;
                    }
                };
                
                logBody.onmousedown = (e) => {
const carControlBtn = e.target.closest('.car-controls button');
                    if (carControlBtn) {
                        e.preventDefault();
                        const td = carControlBtn.closest('.car-number-cell');
                        if (carControlBtn.classList.contains('btn-car-delete')) {
                            this.deleteCarRow(td);
                        } else if (carControlBtn.classList.contains('btn-car-close')) {
                            this.exitCarNumberEditMode(td);
                        }
                        return;
                    }
                    
                    const driverControlBtn = e.target.closest('.edit-controls button');
                    if (driverControlBtn) {
                        e.preventDefault();
                        const td = driverControlBtn.closest('td[data-edit-type="driver"]');
                        if (driverControlBtn.classList.contains('btn-driver-delete')) {
                            this.deleteName(td);
                        } else if (driverControlBtn.classList.contains('btn-driver-save')) {
                            this.saveAndExit(td);
                        }
                        return;
                    }
                    
                    const settingBtn = e.target.closest('.setting-button');
                    if(settingBtn) {
                        e.preventDefault();
                        const routeId = settingBtn.dataset.routeId;
                        const routeName = document.getElementById(`route-${routeId}`).dataset.routeName;
                        // [수정] 시간 적용은 현재 표시된 첫 번째 날짜 기준
                        const dateString = this.state.s2_currentDates[0]?.dateString; 
                        if (!dateString) return;

                        if (settingBtn.classList.contains('apply-button')) {
                            this.applyScheduleSettings(routeName, routeId, dateString, true); // true = 강제 적용 및 저장
                        } else if (settingBtn.classList.contains('reset-button')) {
                            this.resetScheduleSettings(routeName, routeId);
                        }
                        return;
                    }
                };
                
                logBody.ondragstart = (e) => {
                    const cell = e.target.closest('td.car-number-cell');
                    if (cell) {
                        const routeName = cell.closest('.route-section').dataset.routeName;
                        this.dragStart(e, routeName);
                    }
                };
                logBody.ondragover = (e) => this.dragOver(e);
                logBody.ondrop = (e) => {
                    const cell = e.target.closest('td.car-number-cell');
                    if (cell) {
                        const routeName = cell.closest('.route-section').dataset.routeName;
                        this.drop(e, routeName);
                    }
                };
                logBody.ondragend = (e) => this.dragEnd(e);
            },

            // --- S2 UI/상태 관리 ---
            
            /**
             * [수정] 날짜 포맷 (다국어 지원)
             */
            getFormattedDateString(dateObj) {
                return dateObj.toLocaleDateString('ko-KR', { 
                    year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'long' 
                }).replace(/\. /g, '.').replace(/\.$/, '');
            },
            
            changeFontSize(size) {
                document.getElementById('section2').style.fontSize = size + 'pt';
            },

            /**
             * [수정] 노선별 출차 순서 변경 및 저장
             */
            changeDispatchOrder(routeName, order, buttonContainer) {
                if (!routeName || !order) return;
                
                // 1. UI 업데이트
                buttonContainer.querySelectorAll('.dispatch-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.order === order);
                });
                
                const cycleContainer = buttonContainer.nextElementSibling; // .dispatch-cycle-container
                const cycleSelect = cycleContainer.querySelector('.dispatch-cycle-select');
                
                // 2. '수동' 선택 시 '순환주기' 비활성화 및 'manual'로 저장
                if (order === 'manual') {
                    cycleSelect.value = 'manual';
                    cycleSelect.disabled = true;
                    this.changeDispatchCycle(routeName, 'manual'); // 순환주기도 'manual'로 저장
                } else {
                    // 3. '수동' 아닐 시 '순환주기' 활성화
                    cycleSelect.disabled = false;
                    if (cycleSelect.value === 'manual') {
                         cycleSelect.value = 'daily'; // 기본값 '하루'
                         this.changeDispatchCycle(routeName, 'daily'); // '하루'로 저장
                    }
                }

                // 4. S2 데이터에 'dispatchType' 저장
                DataManager.updateS2Data(s2_data => {
                    if (!s2_data[routeName]) s2_data[routeName] = {};
                    if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
                    s2_data[routeName]._settings.dispatchType = order;
                });
                
                // 5. 화면 새로고침 (새 순서 적용)
                // [수정] 자동 순환 적용 (오늘 날짜 기준으로 즉시 순환 실행)
                this.applyAutoRotation(new Date(), [routeName]); // 오늘 날짜, 이 노선만
                this.refreshDispatchLog(); // S1 기준으로 다시 그림
            },

            /**
             * [NEW] 노선별 순환 주기 저장
             */
            changeDispatchCycle(routeName, cycle) {
                if (!routeName || !cycle) return;
                
                // S2 데이터에 'cycle' 저장
                DataManager.updateS2Data(s2_data => {
                    if (!s2_data[routeName]) s2_data[routeName] = {};
                    if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
                    s2_data[routeName]._settings.cycle = cycle;
        
                });
                // (저장만 하고 새로고침은 하지 않음)
            },

            printPage() {
                document.body.classList.remove('printing-section1', 'printing-section3');
                document.body.classList.add('printing-section2'); 
                
                const handleAfterPrint = () => {
                    document.body.classList.remove('printing-section2');
                    window.removeEventListener('afterprint', handleAfterPrint);
                };
                window.addEventListener('afterprint', handleAfterPrint);
                
                window.print();
            },
            
           sanitizeForId(text) {
                if (!text) return 'unknown';
                
                const s2_id = this.state.S2_ROUTE_MAP[text];
                if (s2_id) return s2_id;
                
                return text.toLowerCase().replace(/[^a-z0-9-]/g, '');
            },

            // --- [수정] S2 날짜 네비게이션 ---

            /**
             * [NEW] 이전/다음 날짜로 이동 (단일 날짜 조회)
             */
            navigateDate(days) {
                if (this.state.s2_currentDates.length === 0) {
                    this.loadToday();
                    return;
                }
                // 현재 표시된 첫 번째 날짜 기준
                const currentDate = this.state.s2_currentDates[0].date;
                const newDate = this.addDays(currentDate, days);
                newDate.setHours(0, 0, 0, 0);
                const newDateString = DataManager.getTodayDateString(newDate);

                this.state.s2_currentDates = [{ date: newDate, dateString: newDateString }];
                this.ui.startDateInput.value = newDateString;
                this.ui.endDateInput.value = newDateString;

                this.refreshDispatchLog();
            },
            
            /**
             * [NEW] 기간별 날짜 조회
             */
            loadDateRange() {
                const startDateStr = this.ui.startDateInput.value;
                const endDateStr = this.ui.endDateInput.value;

                if (!startDateStr || !endDateStr) {
                    alert('시작일과 종료일을 모두 선택해주세요.');
                    return;
                }

                const startDate = new Date(startDateStr + 'T00:00:00');
                const endDate = new Date(endDateStr + 'T00:00:00');

                if (startDate > endDate) {
                    alert('시작일은 종료일보다 이전이거나 같아야 합니다.');
                    return;
                }

                const dates = [];
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    d.setHours(0,0,0,0);
                    dates.push({
                        date: new Date(d),
                        dateString: DataManager.getTodayDateString(d)
                    });
                }
                
                if (dates.length > 31) {
                    alert('조회 기간은 최대 31일입니다.');
                    return;
                }

                this.state.s2_currentDates = dates;
                this.refreshDispatchLog();
            },


            // --- [수정] S2 순환주기 계산 로직 (applyAutoRotation) ---
            
            /**
             * [!!! NEW !!!]
             * 자동 순환 적용 (S2_Module.initialize 시 1회 실행)
             * 오늘 날짜와 마지막 순환 날짜를 비교하여 순환 적용
             * @param {Date} today - 기준 날짜 (보통 new Date())
             * @param {Array<string>} [targetRoutes=null] - 특정 노선만 강제 실행 (null이면 전체 노선)
             */
            applyAutoRotation(today = new Date(), targetRoutes = null) {
                console.log(`[S2 자동순환] ${today.toISOString().slice(0, 10)} 기준 자동 순환 시작...`);
                
                today.setHours(0, 0, 0, 0); // YYYY-MM-DD 00:00:00
                const todayString = DataManager.getTodayDateString(today);
                
                const allRoutes = DataManager.getAllRoutes();
                const routesToUpdate = targetRoutes || Object.keys(allRoutes);
                
                DataManager.updateS2Data(s2_data => {
                    
                    routesToUpdate.forEach(routeName => {
                        const routeData = allRoutes[routeName];
                        if (!routeData) return;
   
                     
                        // 1. S2 설정 로드 (기본값 포함)
                        const s2_settings = DataManager.getS2RouteSettings(routeName);
                      
  
                        // '수동'이거나 '주기 없음'이면 순환 안 함
                        if (s2_settings.dispatchType === 'manual' || s2_settings.cycle === 'manual') {
                            return; 
       
                        }
                        
                        // 2. S1의 기본 차량 목록 (정렬됨)
                        let s1_base_list = (routeData.vehicleColumns || []).filter(v => v && v !== '미입력');
                        const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
                        s1_base_list.sort(collator.compare);
                        
                        // 3. S2에 저장된 마지막 순서
                        let last_order = s2_settings.baseOrder || [...s1_base_list];
                        
                        // 4. S1 목록과 S2 순서 동기화 (S1에서 차가 빠지거나 추가됐을 수 있음)
                        const s1_set = new Set(s1_base_list);
                        let synced_order = [];
                        
                        // 4a. S2 순서 중 S1에 아직 있는 차들만 순서대로 추가
                        last_order.forEach(car => {
                            if (s1_set.has(car)) {
                              
                                synced_order.push(car);
                                s1_set.delete(car); // S1 목록에서 제거
                            }
                        });
                        // 4b. S1 목록에 남은 차들(새로 추가된 차)을 S2 순서 뒤에 추가
                        s1_set.forEach(car => {
                            synced_order.push(car);
                        });
                        
                        // 5. 날짜 비교 및 순환 적용
                        const lastRotationDate = new Date(s2_settings.lastRotationDate + 'T00:00:00');
                        let shouldRotate = false;
                        let newRotationDate = s2_settings.lastRotationDate;

                        if (today > lastRotationDate) {
                            if (s2_settings.cycle === 'daily') {
                                shouldRotate = true;
                            } else if (s2_settings.cycle === 'weekly' && today >= this.addDays(lastRotationDate, 7)) {
                                shouldRotate = true;
                            } else if (s2_settings.cycle === 'monthly' && today >= this.addMonths(lastRotationDate, 1)) {
                                shouldRotate = true;
                            }
                        }
                        
                        let final_order = synced_order;
                        
                        // 6. 순환 실행
                        if (shouldRotate || targetRoutes) { // targetRoutes가 있으면 강제 순환
                            if (s2_settings.dispatchType === 'ascending') {
                                
                                final_order = this.rotateArray(synced_order, 1); // 1,2,3 -> 2,3,1
                            } else if (s2_settings.dispatchType === 'descending') {
                                final_order = this.rotateArray(synced_order, -1); // 1,2,3 -> 3,1,2
                            } else if (s2_settings.dispatchType === 'random') {
                                final_order = this.shuffleArray(synced_order);
                            }
                            
                            newRotationDate = todayString; // 순환 기준일을 오늘로 갱신
                            console.log(`[S2 자동순환] ${routeName} 노선 순환 적용됨. (새 순서: ${final_order.join(',')})`);
                            
                            // 7. [!!! NEW !!!] 자동 순환된 배차표(S2 로그) 생성
                            this.generateAutoRotatedLog(s2_data, routeName, routeData, final_order, today);
                        }
                        
                        // 8. 변경된 순서와 날짜를 S2 설정(_settings)에 저장
                        if (!s2_data[routeName]) s2_data[routeName] = {};
                        s2_data[routeName]._settings = { 
                            ...s2_settings, 
                            baseOrder: final_order, // 최종 순서
                            lastRotationDate: newRotationDate // 갱신된 날짜
    
                        };
                    });
                });
                
                console.log("[S2 자동순환] 완료.");
            },
            
            /**
             * [!!! NEW !!!] [★★★ 수정됨 ★★★]
             * 자동 순환된 배차표(S2 로그)를 생성합니다. (applyAutoRotation 내부에서 호출됨)
             * [★★★ 수정 ★★★] : S1 근무표 기준 '' 또는 '휴무'가 아닐 때만 시간 적용
             */
            generateAutoRotatedLog(s2_data, routeName, routeData, newOrder, today) {
                const todayString = DataManager.getTodayDateString(today);
                const dayOfWeek = today.getDay();
                
                // 1. 오늘 날짜의 S2 로그가 이미 있는지 확인
                if (s2_data[todayString] && s2_data[todayString][routeName]) {
                    console.log(`[S2 자동순환] ${routeName} 노선은 이미 ${todayString} 로그가 있어 자동 생성을 건너뜁니다.`);
                    return; // 이미 데이터가 있으면 덮어쓰지 않음
                }
                
                // 2. S2 설정에서 시간 정보 가져오기
                const s2_settings = DataManager.getS2RouteSettings(routeName);
                // 3. 오늘 날짜 S1 근무표 가져오기
                const todayS1Schedule = this.getTodayS1Schedule(routeData, todayString, dayOfWeek);
                // 4. S2 로그 데이터 생성 준비
                if (!s2_data[todayString]) s2_data[todayString] = {};
                s2_data[todayString][routeName] = {};
                const s2_log_today_route = s2_data[todayString][routeName];
                
                // 5. 오전/오후 시간 계산 준비
                const am_startVehicle = s2_settings.am_startVehicle;
                const am_interval = parseInt(s2_settings.am_interval, 10);
                let am_currentTime = new Date();
                am_currentTime.setHours(parseInt(s2_settings.am_hour, 10), parseInt(s2_settings.am_minute, 10), 0, 0);
                
                const pm_startVehicle = s2_settings.pm_startVehicle;
                const pm_interval = parseInt(s2_settings.pm_interval, 10);
                let pm_currentTime = new Date();
                pm_currentTime.setHours(parseInt(s2_settings.pm_hour, 10), parseInt(s2_settings.pm_minute, 10), 0, 0);

                const routeId = this.sanitizeForId(routeName);
                
                // 6. 오전 시간 계산 및 로그 생성
                if (am_startVehicle && !isNaN(am_interval) && !isNaN(am_currentTime.getTime())) {
                    const startIndex = newOrder.indexOf(am_startVehicle);
                    if (startIndex > -1) {
                        // 시작 차량부터 끝까지
                        for (let i = startIndex; i < newOrder.length; i++) {
                            const carNum = newOrder[i];
                            
                            // [★★★ 수정 ★★★] : 오전 근무자 확인
                            const s1CarData = todayS1Schedule[carNum] || [{ text: '' }, { text: '' }];
                            const amDriverText = (s1CarData[0].text || '').trim();
                            const hasAmDriver = amDriverText !== '' && amDriverText !== '휴무';

                            if (hasAmDriver) { // 근무자가 있을 때만 시간 적용
                                const timeStr = am_currentTime.toTimeString().slice(0, 5);
                                s2_log_today_route[carNum] = { [`start_time_${routeId}_${carNum}_am`]: timeStr };
                                am_currentTime.setMinutes(am_currentTime.getMinutes() + am_interval);
                            }
                        }
                        // 처음부터 시작 차량 전까지
                        for (let i = 0; i < startIndex; i++) {
                            const carNum = newOrder[i];
                            
                            // [★★★ 수정 ★★★] : 오전 근무자 확인
                            const s1CarData = todayS1Schedule[carNum] || [{ text: '' }, { text: '' }];
                            const amDriverText = (s1CarData[0].text || '').trim();
                            const hasAmDriver = amDriverText !== '' && amDriverText !== '휴무';
                            
                            if (hasAmDriver) { // 근무자가 있을 때만 시간 적용
                                const timeStr = am_currentTime.toTimeString().slice(0, 5);
                                if (!s2_log_today_route[carNum]) s2_log_today_route[carNum] = {};
                                s2_log_today_route[carNum][`start_time_${routeId}_${carNum}_am`] = timeStr;
                                am_currentTime.setMinutes(am_currentTime.getMinutes() + am_interval);
                            }
                        }
                    }
                }
                
                // 7. 오후 시간 계산 및 로그 생성
                if (pm_startVehicle && !isNaN(pm_interval) && !isNaN(pm_currentTime.getTime())) {
   
                    const startIndex = newOrder.indexOf(pm_startVehicle);
                    if (startIndex > -1) {
                        // 시작 차량(막차)부터 처음까지
                        for (let i = startIndex; i >= 0; i--) {
                            const carNum = newOrder[i];
                            
                            // [★★★ 수정 ★★★] : 오후 근무자 확인
                            const s1CarData = todayS1Schedule[carNum] || [{ text: '' }, { text: '' }];
                            const pmDriverText = (s1CarData[1].text || '').trim();
                            const hasPmDriver = pmDriverText !== '' && pmDriverText !== '휴무';

                            if (hasPmDriver) { // 근무자가 있을 때만 시간 적용
                                const timeStr = pm_currentTime.toTimeString().slice(0, 5);
                                if (!s2_log_today_route[carNum]) s2_log_today_route[carNum] = {};
                                s2_log_today_route[carNum][`pm_start_time_${routeId}_${carNum}_pm`] = timeStr; 
                                pm_currentTime.setMinutes(pm_currentTime.getMinutes() - pm_interval);
                            }
                        }
                        // 끝부터 시작 차량 다음까지
                        for (let i = newOrder.length - 1; i > startIndex; i--) {
                            const carNum = newOrder[i];
                            
                            // [★★★ 수정 ★★★] : 오후 근무자 확인
                            const s1CarData = todayS1Schedule[carNum] || [{ text: '' }, { text: '' }];
                            const pmDriverText = (s1CarData[1].text || '').trim();
                            const hasPmDriver = pmDriverText !== '' && pmDriverText !== '휴무';

                            if (hasPmDriver) { // 근무자가 있을 때만 시간 적용
                                const timeStr = pm_currentTime.toTimeString().slice(0, 5);
                                if (!s2_log_today_route[carNum]) s2_log_today_route[carNum] = {};
                                s2_log_today_route[carNum][`pm_start_time_${routeId}_${carNum}_pm`] = timeStr;
                                pm_currentTime.setMinutes(pm_currentTime.getMinutes() - pm_interval);
                            }
                        }
                    }
                }
                
                console.log(`[S2 자동순환] ${routeName} 노선의 ${todayString} 로그가 자동으로 생성되었습니다.`);
            },


            // --- S2 핵심 기능: 화면 그리기 ---

            /**
             * [수정됨] refreshDispatchLog
             * - s2_currentDates (배열)을 순회하며 모든 날짜의 일지를 그림
             */
            refreshDispatchLog() {
                console.log("[S2] 승무일지 새로고침 시작...");
                
                const { routeData: currentS1RouteData } = DataManager.getCurrentRouteData();
                const s1_companyName = currentS1RouteData ? currentS1RouteData.companyName : "승무일지";
                this.ui.headerTitle.textContent = `${s1_companyName} 승무일지`;
                
                const allRoutes = DataManager.getAllRoutes();
                const container = this.ui.dispatchLogBody;
                container.innerHTML = ''; 

                if (this.state.s2_currentDates.length === 0) {
                    container.innerHTML = '<div class="date-header">조회할 날짜를 선택해주세요.</div>';
                    return;
                }

                // [수정] 선택된 모든 날짜를 순회
                this.state.s2_currentDates.forEach(dateInfo => {
                    const { date, dateString } = dateInfo;
                    const dayOfWeek = date.getDay();
                    
                    // 1. 날짜 헤더 추가
                    container.insertAdjacentHTML('beforeend', 
                        `<div class="date-header">${this.getFormattedDateString(date)}</div>`
                    );
                    
                    // 2. S2 로그 (해당 날짜)
                    const s2_logData = DataManager.getS2LogByDate(dateString);

                    // 3. 모든 노선 순회
                    for (const routeName in allRoutes) {
                        const routeData = allRoutes[routeName];
                        if (!routeData) continue;
                        
                        const routeId = this.sanitizeForId(routeName);

                        // 3a. S2 설정 (순서, 주기, 시간 설정 등)
                        const s2_settings = DataManager.getS2RouteSettings(routeName);
                        // 3b. S1 근무표 (해당 날짜)
                        const todayS1Schedule = this.getTodayS1Schedule(routeData, dateString, dayOfWeek);
                        // 3c. S2 로그 (해당 날짜, 해당 노선)
                        const todayS2RouteLog = s2_logData[routeName] || {};

                        // 3d. S1 차량 목록 (원본)
                        let s1_base_list = (routeData.vehicleColumns || []).filter(v => v && v !== '미입력');
                        const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
                        s1_base_list.sort(collator.compare);
                        
                        // 3e. S2 차량 순서 (자동 순환 적용된)
                        const validVehicles = (s2_settings.baseOrder && s2_settings.baseOrder.length > 0) ?
                            s2_settings.baseOrder : s1_base_list;
                        
                        // [수정] 헤더와 옵션은 첫 번째 날짜에만 표시 (복잡성 감소)
                        let s2_optionsHTML = '';
                        if (dateString === this.state.s2_currentDates[0].dateString) {
                            s2_optionsHTML = this.createOptionsHTML(routeId, routeName, validVehicles, s2_settings);
                        }

                        // 3f. 테이블 생성
                        const tableHeader = this.createTableHeaderHTML(routeId);
                        let tableBodyHTML = '';
                        const halfCount = Math.ceil(validVehicles.length / 2);
                        
                        for (let i = 0; i < halfCount; i++) {
                            const leftCar = validVehicles[i] || '미입력';
                            const rightCar = validVehicles[i + halfCount] || '미입력';
                            
                            const leftHTML = this.createRowSideHTML(routeName, leftCar, todayS1Schedule, todayS2RouteLog, s2_settings, dateString);
                            const rightHTML = this.createRowSideHTML(routeName, rightCar, todayS1Schedule, todayS2RouteLog, s2_settings, dateString);
                            
                            tableBodyHTML += `<tr data-date-string="${dateString}">${leftHTML}${rightHTML}</tr>`; // [수정] tr에 날짜 추가
                        }
                        
                        container.insertAdjacentHTML('beforeend', `
                            <div class="route-section" id="route-${routeId}" data-route-name="${routeName}">
                                <div class="route-header-flex">
                                    <div class="route-title-group">
                                        <div class="route-name-text">${routeName}</div>
                                    </div>
                                    ${s2_optionsHTML}
                                </div>
                                <table class="journal-table">
                                    ${tableHeader}
                                    <tbody>${tableBodyHTML}</tbody>
                                </table>
                            </div>
                        `);
                    } // 노선 루프 끝
                }); // 날짜 루프 끝
                
                // [수정] 옵션 HTML이 첫 번째 날짜에만 렌더링되므로, 모든 옵션 값을 다시 채워줌
                this.state.s2_currentDates.forEach(dateInfo => {
                    if (dateInfo.dateString === this.state.s2_currentDates[0].dateString) {
                        for (const routeName in allRoutes) {
                            const routeId = this.sanitizeForId(routeName);
                            const s2_settings = DataManager.getS2RouteSettings(routeName);
                            this.fillOptionsValues(routeId, s2_settings);
                        }
                    }
                });

                console.log("[S2] 승무일지 새로고침 완료.");
            },
            
            /**
             * [수정] 현재 조회 중인 모든 날짜의 S2 로그만 삭제
             */
            resetS2LogForCurrentDates() {
                DataManager.updateS2Data(s2_data => {
                    this.state.s2_currentDates.forEach(dateInfo => {
                        if (s2_data[dateInfo.dateString]) {
                            delete s2_data[dateInfo.dateString];
                            console.log(`[S2] ${dateInfo.dateString} 날짜의 승무일지 로그가 초기화되었습니다.`);
                        }
                    });
                });
            },

            // --- S2 로그(일지) 데이터 저장/백업/복원 ---

            /**
             * HH:MM 형식으로 시간 자동 포맷
             */
            formatTimeInput(value) {
                let v = value.replace(/[^0-9]/g, '');
                if (v.length > 4) v = v.slice(0, 4);
                if (v.length >= 3) {
                    const hour = parseInt(v.slice(0, 2), 10);
                    const minute = parseInt(v.slice(2, 4), 10);
                    if (hour > 23) v = '23' + v.slice(2);
                    if (minute > 59) v = v.slice(0, 2) + '59';
                    return v.slice(0, 2) + ':' + v.slice(2);
                }
                return v;
            },

            /**
             * [NEW] input/select 변경 시 S2 로그 즉시 저장
             * [수정] 날짜 데이터셋(data-date-string) 추가
             */
            saveS2LogEntryFromElement(element) {
                const carNum = element.dataset.carNum;
                const routeName = element.closest('.route-section').dataset.routeName;
                const name = element.getAttribute('name');
                const value = element.value;
                const dateString = element.closest('tr').dataset.dateString; // [수정]

                if (!carNum || !routeName || !name || !dateString) return;

                DataManager.updateS2Data(s2_data => {
                    if (!s2_data[dateString]) s2_data[dateString] = {};
                    if (!s2_data[dateString][routeName]) s2_data[dateString][routeName] = {};
                    if (!s2_data[dateString][routeName][carNum]) s2_data[dateString][routeName][carNum] = {};
                    
                    s2_data[dateString][routeName][carNum][name] = value;
                });
            },

            /**
             * [NEW] S2 일지 데이터 백업 (S2_LOG_KEY)
             */
            backupLogData() {
                const backupData = DataManager.data.s2;
                const jsonString = JSON.stringify(backupData);
                const now = new Date();
                const dateString = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
                
                const { routeData: currentS1RouteData } = DataManager.getCurrentRouteData();
                let companyName = (currentS1RouteData ? currentS1RouteData.companyName : "회사없음").replace(/\s/g, '');

                const filename = `${companyName}_승무일지(S2)_${dateString}.json`;
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                alert(`승무일지(S2) 전체 데이터 파일 (${filename})이 다운로드 폴더에 JSON 파일로 저장됩니다.`);
            },

            /**
             * [NEW] S2 복원 모달 표시
             */
            showRestoreModal() {
                this.ui.restoreModal.style.display = 'block';
            },
            hideRestoreModal() {
                this.ui.restoreModal.style.display = 'none';
                this.ui.restoreFile.value = '';
            },
            triggerRestore() {
                this.ui.restoreFile.click();
            },

            /**
             * [NEW] S2 일지 데이터 복원 (S2_LOG_KEY)
             */
            restoreLogData(file) {
                if (!file) return;
                if (!confirm(`[${file.name}] 파일을 업로드하여 *모든* 날짜의 승무일지(S2)를 불러오시겠습니까? (현재 모든 S2 데이터는 덮어쓰여집니다.)`)) {
                    this.ui.restoreFile.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedData = JSON.parse(event.target.result);
                        if (typeof loadedData !== 'object' || loadedData === null) {
                             alert('파일 형식이 올바르지 않거나 데이터가 없습니다.');
                             throw new Error('Invalid saved file structure');
                        }
                        
                        // DataManager에 S2 데이터 덮어쓰기
                        DataManager.updateS2Data(s2_data => {
                            // 기존 s2_data를 비우고 새 데이터로 채움
                            Object.keys(s2_data).forEach(key => delete s2_data[key]);
                            Object.assign(s2_data, loadedData);
                        });

                        // [중요] 복원 후에는 반드시 자동 순환 로직을 다시 실행
                        this.applyAutoRotation();
                        // 화면 갱신
                        this.refreshDispatchLog();
                        
                        alert(`[${file.name}] 파일로부터 S2 전체 데이터 불러오기를 완료했습니다. 화면을 확인해주세요.`);
                    } catch (e) {
                        alert('파일을 읽는 도중 오류가 발생했습니다. 파일이 손상되었거나 JSON 형식이 아닙니다.');
                        console.error('S2 Restore Error:', e);
                    } finally {
                        this.ui.restoreFile.value = '';
                    }
                };
                reader.onerror = () => {
                    alert('파일을 읽을 수 없습니다.');
                    this.ui.restoreFile.value = '';
                };
                reader.readAsText(file);
            },


            // --- S2 HTML 생성 헬퍼 ---

            /**
             * [★★★ 수정 ★★★] S2 테이블 헤더 HTML 생성 (9열 * 2 = 18열)
             */
            createTableHeaderHTML(routeId) {
                const colgroup = `
                    <colgroup>
                        <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;">
                        <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;">
                        
                        <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;">
                        <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;">
                    </colgroup>`;
                
                const header = `
                    <thead>
                        <tr>
                            <th id="header_car_${routeId}_1">차<br>번</th>
                            <th>오전<br>근무</th>
                            <th>출발<br>시간</th>
                            <th>근무<br>시간</th>
                            <th>휴무자<br>(오전)</th>
                            <th>오후<br>근무</th>
                            <th>출근<br>시간</th>
                            <th>근무<br>시간</th>
                            <th>휴무자<br>(오후)</th>
                            
                            <th id="header_car_${routeId}_2">차<br>번</th>
                            <th>오전<br>근무</th>
                            <th>출발<br>시간</th>
                            <th>근무<br>시간</th>
                            <th>휴무자<br>(오전)</th>
                            <th>오후<br>근무</th>
                            <th>출근<br>시간</th>
                            <th>근무<br>시간</th>
                            <th>휴무자<br>(오후)</th>
                        </tr>
                    </thead>`;
                return colgroup + header;
            },

            /**
             * [★★★ 수정 ★★★] S2 테이블 행의 절반(좌/우) HTML 생성 (9열)
             */
            createRowSideHTML(routeName, carNum, todayS1Schedule, todayS2RouteLog, s2_settings, dateString) {
                const routeId = this.sanitizeForId(routeName);

                if (carNum === '미입력' || !carNum) {
                    return `
                        <td class="car-number-cell" data-car-number="미입력"></td>
                        <td></td> <td></td> <td></td> <td></td>
                        <td></td> <td></td> <td></td> <td></td>
                    `;
                }

                // 1. S1 데이터 (근무자)
                const s1CarData = todayS1Schedule[carNum] || [{ text: '', bold: false }, { text: '', bold: false }];
                const amDriver = s1CarData[0];
                const pmDriver = s1CarData[1];
                
                // [★★★ 수정 ★★★] S1 '휴무' 또는 '' 는 빈칸으로 표시
                const amDriverText = (amDriver.text || '').trim();
                const pmDriverText = (pmDriver.text || '').trim();
                const amDriverDisplay = (amDriverText === '' || amDriverText === '휴무') ? '' : amDriverText;
                const pmDriverDisplay = (pmDriverText === '' || pmDriverText === '휴무') ? '' : pmDriverText;

                const amDriverBold = amDriver.bold ? 'font-weight: bold;' : '';
                const pmDriverBold = pmDriver.bold ? 'font-weight: bold;' : '';
                
                // 2. S2 데이터 (시간, 근무시간)
                const s2CarData = todayS2RouteLog[carNum] || {};
                const amTimeKey = `start_time_${routeId}_${carNum}_am`; // 출발시간
                const pmTimeKey = `pm_start_time_${routeId}_${carNum}_pm`; // 오후 출근시간
                const amHoursKey = `work_hours_${routeId}_${carNum}_am`;
                const pmHoursKey = `work_hours_${routeId}_${carNum}_pm`;
                
                const amTimeValue = s2CarData[amTimeKey] || '';
                const pmTimeValue = s2CarData[pmTimeKey] || '';
                const amHoursValue = s2CarData[amHoursKey] || '';
                const pmHoursValue = s2CarData[pmHoursKey] || '';

                // 3. [★★★ 수정 ★★★] 휴무자 칸 자동 계산
                const amHolidayDisplay = (amHoursValue === '휴무') ? amDriverDisplay : '';
                const pmHolidayDisplay = (pmHoursValue === '휴무') ? pmDriverDisplay : '';

                // [수정] 근무시간 선택 옵션 HTML (2~12, 휴무)
                const createWorkHoursOptions = (selectedValue) => {
                    const options = ['', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '휴무'];
                    return options.map(opt => 
                        `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`
                    ).join('');
                };

                const amHoursOptions = createWorkHoursOptions(amHoursValue);
                const pmHoursOptions = createWorkHoursOptions(pmHoursValue);

                // 4. HTML 반환 (data-date-string 추가)
                return `
                    <td class="car-number-cell" data-car-number="${carNum}" draggable="true">
                        <div class="car-display">${carNum}</div>
                        <div class="car-controls hidden">
                            <select class="car-select-dropdown"></select>
                            <div>
                                <button class="btn-car-delete">삭제</button>
                                <button class="btn-car-close">닫기</button>
                            </div>
                        </div>
                    </td>
                    <td data-edit-type="driver" data-s1-key="${routeName}" data-car-number="${carNum}" data-shift="am" data-date-string="${dateString}">
                        <span class="driver-name" style="${amDriverBold}">${amDriverDisplay}</span>
                        <input type="text" class="driver-input hidden" value="${amDriverText}">
                        <div class="edit-controls hidden">
                            <button class="btn-driver-delete">삭제</button>
                            <button class="btn-driver-save">저장</button>
                        </div>
                    </td>
                    <td><input type="text" inputmode="numeric" name="${amTimeKey}" data-car-num="${carNum}" value="${amTimeValue}" ${amDriverDisplay ? '' : 'disabled'}></td>
                    <td><select class="s2-work-hours-select" name="${amHoursKey}" data-car-num="${carNum}" data-shift="am" ${amDriverDisplay ? '' : 'disabled'}>${amHoursOptions}</select></td>
                    <td class="s2-holiday-cell" data-shift="am">${amHolidayDisplay}</td>
                    
                    <td data-edit-type="driver" data-s1-key="${routeName}" data-car-number="${carNum}" data-shift="pm" data-date-string="${dateString}">
                        <span class="driver-name" style="${pmDriverBold}">${pmDriverDisplay}</span>
                        <input type="text" class="driver-input hidden" value="${pmDriverText}">
                        <div class="edit-controls hidden">
                            <button class="btn-driver-delete">삭제</button>
                            <button class="btn-driver-save">저장</button>
                        </div>
                    </td>
                    <td><input type="text" inputmode="numeric" name="${pmTimeKey}" data-car-num="${carNum}" value="${pmTimeValue}" ${pmDriverDisplay ? '' : 'disabled'}></td>
                    <td><select class="s2-work-hours-select" name="${pmHoursKey}" data-car-num="${carNum}" data-shift="pm" ${pmDriverDisplay ? '' : 'disabled'}>${pmHoursOptions}</select></td>
                    <td class="s2-holiday-cell" data-shift="pm">${pmHolidayDisplay}</td>
                `;
            },
            
            /**
             * [★★★ 수정 ★★★] 근무시간 변경 시 휴무자 칸 자동 업데이트
             */
            handleWorkHoursChange(selectElement) {
                const selectedValue = selectElement.value;
                const shift = selectElement.dataset.shift; // 'am' or 'pm'
                const tr = selectElement.closest('tr');
                
                // 1. 해당 줄(am/pm)의 근무자 이름 가져오기
                const driverNameSpan = tr.querySelector(`td[data-shift="${shift}"] .driver-name`);
                const driverName = driverNameSpan ? driverNameSpan.textContent : '';
                
                // 2. 해당 줄(am/pm)의 휴무자 칸 찾기
                const holidayCell = tr.querySelector(`td.s2-holiday-cell[data-shift="${shift}"]`);
                
                // 3. 값 업데이트
                if (holidayCell) {
                    if (selectedValue === '휴무') {
                        holidayCell.textContent = driverName;
                    } else {
                        holidayCell.textContent = '';
                    }
                }
            },

            /**
             * [S2] 헤더 옵션 영역 HTML 생성
             */
            createOptionsHTML(routeId, routeName, validVehicles, s2_settings) {
                
                // 1. 출차순서 버튼
                const dispatchType = s2_settings.dispatchType || 'manual';
                const dispatchButtons = [
                    { order: 'manual', text: '수동' },
                    { order: 'ascending', text: '순차' },
                    { order: 'descending', text: '역순' },
                    { order: 'random', text: '랜덤' }
                ];
                const dispatchButtonsHTML = dispatchButtons.map(btn => 
                    `<button type="button" class="dispatch-button ${dispatchType === btn.order ? 'active' : ''}" data-order="${btn.order}">${btn.text}</button>`
                ).join('');

                // 2. 순환주기
                const cycle = s2_settings.cycle || 'manual';
                const cycleDisabled = (dispatchType === 'manual') ? 'disabled' : '';
                const cycleOptions = [
                    { value: 'manual', text: '주기 없음' },
                    { value: 'daily', text: '하루' },
                    { value: 'weekly', text: '1주' },
                    { value: 'monthly', text: '1개월' }
                ];
                const cycleOptionsHTML = cycleOptions.map(opt => 
                    `<option value="${opt.value}" ${cycle === opt.value ? 'selected' : ''}>${opt.text}</option>`
                ).join('');

                // 3. 시간 설정 - 차량 옵션
                const vehicleOptions = validVehicles.map(car => 
                    `<option value="${car}">${car}</option>`
                ).join('');
                
                // 4. 시간 설정 - 오전
                const { am_startVehicle = '', am_hour = '', am_minute = '', am_interval = '',
                        pm_startVehicle = '', pm_hour = '', pm_minute = '', pm_interval = '' } = s2_settings;

                return `
                    <div class="load-button-container">
                        <div class="dispatch-buttons-container" data-route-id="${routeId}">
                            <label>출차순서:</label>
                            ${dispatchButtonsHTML}
                        </div>
                        <div class="dispatch-cycle-container" data-route-id="${routeId}">
                            <label>순환주기:</label>
                            <select class="dispatch-cycle-select" ${cycleDisabled}>
                                ${cycleOptionsHTML}
                            </select>
                        </div>
                    </div>
                    
                    <div class="schedule-options">
                        <div class="am-options">
                            <span>오전</span>
                            <select name="am_startVehicle_${routeId}">
                                <option value="">시작차량</option>
                                ${vehicleOptions}
                            </select>
                            <input type="number" name="am_hour_${routeId}" min="0" max="23" placeholder="시" value="${am_hour}">
                            <input type="number" name="am_minute_${routeId}" min="0" max="59" placeholder="분" value="${am_minute}">
                            <input type="number" name="am_interval_${routeId}" min="0" max="60" placeholder="간격(분)" value="${am_interval}">
                        </div>
                        <div class="pm-options">
                            <span>오후</span>
                            <select name="pm_startVehicle_${routeId}">
                                <option value="">막차차량</option>
                                ${vehicleOptions}
                            </select>
                            <input type="number" name="pm_hour_${routeId}" min="0" max="23" placeholder="시" value="${pm_hour}">
                            <input type="number" name="pm_minute_${routeId}" min="0" max="59" placeholder="분" value="${pm_minute}">
                            <input type="number" name="pm_interval_${routeId}" min="0" max="60" placeholder="간격(분)" value="${pm_interval}">
                        </div>
                    </div>

                    <div class="settings-controls">
                        <button type="button" class="setting-button apply-button" data-route-id="${routeId}">시간 적용</button>
                        <button type="button" class="setting-button reset-button" data-route-id="${routeId}">시간 초기화</button>
                    </div>
                `;
            },
            
            /**
             * [NEW] 옵션 컨트롤 값 채우기 (refreshDispatchLog에서 호출)
             */
            fillOptionsValues(routeId, s2_settings) {
                const container = document.getElementById(`route-${routeId}`);
                if (!container) return;

                const amSelect = container.querySelector(`select[name="am_startVehicle_${routeId}"]`);
                if (amSelect) amSelect.value = s2_settings.am_startVehicle || '';
                
                const amHour = container.querySelector(`input[name="am_hour_${routeId}"]`);
                if (amHour) amHour.value = s2_settings.am_hour || '';
                
                const amMinute = container.querySelector(`input[name="am_minute_${routeId}"]`);
                if (amMinute) amMinute.value = s2_settings.am_minute || '';
                
                const amInterval = container.querySelector(`input[name="am_interval_${routeId}"]`);
                if (amInterval) amInterval.value = s2_settings.am_interval || '';

                const pmSelect = container.querySelector(`select[name="pm_startVehicle_${routeId}"]`);
                if (pmSelect) pmSelect.value = s2_settings.pm_startVehicle || '';
                
                const pmHour = container.querySelector(`input[name="pm_hour_${routeId}"]`);
                if (pmHour) pmHour.value = s2_settings.pm_hour || '';
                
                const pmMinute = container.querySelector(`input[name="pm_minute_${routeId}"]`);
                if (pmMinute) pmMinute.value = s2_settings.pm_minute || '';
                
                const pmInterval = container.querySelector(`input[name="pm_interval_${routeId}"]`);
                if (pmInterval) pmInterval.value = s2_settings.pm_interval || '';
            },


            /**
             * [S2] S1 데이터로부터 오늘 날짜의 근무표(차량: [오전, 오후])를 계산
             * [★★★ 수정 ★★★] S1 기본값을 ''(빈칸)으로 수정
             */
            getTodayS1Schedule(routeData, dateString, dayOfWeek) {
                const s1Schedule = {};
                const VEHICLE_COLS = routeData.vehicleColumns || [];

                VEHICLE_COLS.forEach(colId => {
                    if (colId === '미입력') return;

                    let appliedNames = [{ text: '', bold: false }, { text: '', bold: false }]; // [★★★ 수정 ★★★]

                    // 1. 임시(temp) 데이터 확인 (우선순위 높음)
                    if (routeData.tempSchedule[dateString] && routeData.tempSchedule[dateString][colId]) {
                        appliedNames = routeData.tempSchedule[dateString][colId];
                    } 
                    // 2. 고정(fixed) 데이터 확인
                    else {
                        const recurringKey = `${dayOfWeek}-${colId}`;
                        if (routeData.fixedSchedule[recurringKey]) {
                            let anchorEntry = null;
                            // 날짜가 가장 최신이면서 오늘보다 이전인 항목 찾기
                            for (const entry of routeData.fixedSchedule[recurringKey]) {
                                if (new Date(dateString) >= new Date(entry.dateString)) {
                                    anchorEntry = entry;
                                    break; // (이미 날짜 역순으로 정렬되어 있음)
                                }
                            }

                            if (anchorEntry) {
                                const workType = routeData.workTypeConfig[colId] || 'normal';
                                // 격주 근무 로직
                                if (workType === 'biweekly' && dayOfWeek !== 0) {
                                    const anchorDate = new Date(anchorEntry.dateString);
                                    const currentDate = new Date(dateString);
                                    anchorDate.setHours(0, 0, 0, 0);
                                    currentDate.setHours(0, 0, 0, 0);
                                    const msInDay = 24 * 60 * 60 * 1000;
                                    const diffInDays = Math.round((currentDate.getTime() - anchorDate.getTime()) / msInDay);
                                    const weekDifference = Math.floor(diffInDays / 7);
                                    
                                    if (weekDifference % 2 === 1) { // 홀수 주 (순서 변경)
                                        appliedNames = [anchorEntry.names[1], anchorEntry.names[0]]; 
                                    } else { // 짝수 주 (그대로)
                                        appliedNames = anchorEntry.names;
                                    }
                                } else {
                                    appliedNames = anchorEntry.names;
                                }
                            }
                        }
                    }
                    s1Schedule[colId] = appliedNames;
                });
                return s1Schedule;
            },


            // --- S2 인라인 편집 (S1 데이터 연동) ---

            /**
             * [S2->S1] 근무자 이름 편집 모드
             */
            toggleEditMode(cell) {
                // 다른 모든 편집 모드 닫기
                document.querySelectorAll('td[data-edit-type="driver"]').forEach(c => {
                    c.querySelector('.driver-name').classList.remove('hidden');
                    c.querySelector('.driver-input').classList.add('hidden');
                    c.querySelector('.edit-controls').classList.add('hidden');
                });
                // 현재 셀 편집 모드
                cell.querySelector('.driver-name').classList.add('hidden');
                const input = cell.querySelector('.driver-input');
                const controls = cell.querySelector('.edit-controls');
                input.classList.remove('hidden');
                controls.classList.remove('hidden');
                input.focus();
                input.select();
            },

            /**
             * [S2->S1] 근무자 이름 저장
             * [★★★ 수정 ★★★] S1 임시 저장 시 ''(빈칸)으로 저장
             */
            saveAndExit(cell) {
                const routeName = cell.dataset.s1Key;
                const carNum = cell.dataset.carNumber;
                const shift = cell.dataset.shift; // 'am' or 'pm'
                const shiftIndex = (shift === 'am') ? 0 : 1;
                const input = cell.querySelector('.driver-input');
                const newName = input.value.trim();
                const dateString = cell.dataset.dateString; // [수정]
                
                if (!dateString) {
                    console.error("S2: 날짜 정보(dateString)가 없습니다. 저장 실패.");
                    return;
                }

                // S1 데이터에 임시(temp) 스케줄로 저장
                const dayOfWeek = new Date(dateString + 'T00:00:00').getDay();

                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[routeName];
                    if (!routeData) return;

                    // 1. 현재 S1 데이터(고정+임시)를 먼저 가져옴
                    const s1ScheduleToday = this.getTodayS1Schedule(routeData, dateString, dayOfWeek);
                    const currentNames = s1ScheduleToday[carNum] || [{ text: '', bold: false }, { text: '', bold: false }];
                    
                    // 2. 새 이름 반영 (강조 플래그는 유지)
                    currentNames[shiftIndex].text = (newName === '' || newName === '휴무') ? '' : newName; // [★★★ 수정 ★★★]

                    // 3. S1의 임시(temp) 스케줄에 덮어쓰기
                    if (!routeData.tempSchedule[dateString]) routeData.tempSchedule[dateString] = {};
                    routeData.tempSchedule[dateString][carNum] = currentNames;
                    
                    console.log(`[S2->S1] ${dateString} / ${routeName} / ${carNum} / ${shift} 근무자가 [${newName}](으)로 S1(임시)에 저장되었습니다.`);
                });
                
                // S1 데이터 변경이 완료되면 DataManager가 's1_data_changed' 알림을 보냄.
                // S2의 onDataChanged가 이 알림을 받고 refreshDispatchLog()를 호출하여 화면을 갱신함.
            },
            
            /**
             * [S2->S1] 근무자 이름 삭제 (공란 ''로 저장)
             */
            deleteName(cell) {
                cell.querySelector('.driver-input').value = ''; // [★★★ 수정 ★★★]
                this.saveAndExit(cell);
            },


            // --- S2 인라인 편집 (S2 데이터 전용) ---

            /**
             * [S2] 차량 번호 편집 모드
             */
            toggleCarNumberEditMode(cell, routeName) {
                const carDisplay = cell.querySelector('.car-display');
                const carControls = cell.querySelector('.car-controls');
                const carSelect = cell.querySelector('.car-select-dropdown');
                
                if (carControls.classList.contains('hidden')) {
                    // 편집 모드 시작
                    // 1. 모든 차량 목록 (S1 기준)
                    const routeData = DataManager.getAllRoutes()[routeName];
                    if (!routeData) return; // S1에 노선 정보가 없는 경우 방지
                    
                    const s1_all_vehicles = (routeData.vehicleColumns || []).filter(v => v && v !== '미입력');
                    
                    // 2. 현재 S2에 표시된 차량 목록 (중복 선택 방지용)
                    this.state.S2_USED_VEHICLES = {};
                    document.querySelectorAll(`#route-${this.sanitizeForId(routeName)} .car-number-cell`).forEach(c => {
                        this.state.S2_USED_VEHICLES[c.dataset.carNumber] = true;
                    });

                    // 3. 드롭다운 채우기
                    carSelect.innerHTML = '<option value="">-- 변경 --</option>';
                    s1_all_vehicles.forEach(car => {
                        const isUsed = this.state.S2_USED_VEHICLES[car];
                        const currentCar = cell.dataset.carNumber;
                        if (!isUsed || car === currentCar) {
                             carSelect.innerHTML += `<option value="${car}" ${car === currentCar ? 'selected' : ''}>${car}</option>`;
                        }
                    });
                    
                    carDisplay.classList.add('hidden');
                    carControls.classList.remove('hidden');
                } else {
                    // 편집 모드 종료
                    carDisplay.classList.remove('hidden');
                    carControls.classList.add('hidden');
                }
            },
            
            /**
             * [S2] 차량 번호 변경 (S2 로그 수정)
             * [수정] 날짜(data-date-string) 기준으로 S2 로그 수정
             */
            changeCarNumber(selectElement, routeName) {
                const cell = selectElement.closest('.car-number-cell');
                const oldCarNum = cell.dataset.carNumber;
                const newCarNum = selectElement.value;
                const dateString = cell.closest('tr').dataset.dateString; // [수정]
                
                if (!newCarNum || oldCarNum === newCarNum || !dateString) return;

                DataManager.updateS2Data(s2_data => {
                    const s2_log_today_route = s2_data[dateString] && s2_data[dateString][routeName];
                    if (s2_log_today_route && s2_log_today_route[oldCarNum]) {
                        // 기존 데이터 복사
                        const oldData = s2_log_today_route[oldCarNum];
                        // 새 데이터 객체 생성 (키 이름 변경)
                        const newData = {};
                        const routeId = this.sanitizeForId(routeName);
                        
                        // "start_time_07_5518_am" -> "start_time_07_5519_am"
                        Object.keys(oldData).forEach(key => {
                            const newKey = key.replace(`_${oldCarNum}_`, `_${newCarNum}_`);
                            newData[newKey] = oldData[key];
                        });

                        // 기존 데이터 삭제 및 새 데이터 추가
                        delete s2_log_today_route[oldCarNum];
                        s2_log_today_route[newCarNum] = newData;
                        
                        console.log(`[S2] 로그 수정: ${dateString} / ${routeName} 차량이 [${oldCarNum}] -> [${newCarNum}](으)로 변경되었습니다.`);
                    }
                });
                
                // [수정] 차량 번호 변경 시 순환주기(baseOrder)도 갱신
                this.updateBaseOrderCarNumber(routeName, oldCarNum, newCarNum);

                // 화면 즉시 새로고침
                this.refreshDispatchLog();
            },

            /**
             * [S2] 차량 행 삭제 (S2 로그 수정)
             * [수정] 날짜(data-date-string) 기준으로 S2 로그 삭제
             */
            deleteCarRow(cell) {
                const carNum = cell.dataset.carNumber;
                const routeName = cell.closest('.route-section').dataset.routeName;
                const dateString = cell.closest('tr').dataset.dateString; // [수정]

                if (!carNum || carNum === '미입력' || !dateString) return;
                
                if (confirm(`[${carNum}] 차량을 [${dateString}] 승무일지에서 삭제하시겠습니까?\n(S1 근무표는 변경되지 않습니다.)`)) {

                    DataManager.updateS2Data(s2_data => {
                        // 1. S2 로그에서 해당 차량 데이터 삭제
                        const s2_log_today_route = s2_data[dateString] && s2_data[dateString][routeName];
                        if (s2_log_today_route && s2_log_today_route[carNum]) {
                            delete s2_log_today_route[carNum];
                        }
                        
                        // 2. S2 설정(baseOrder)에서도 해당 차량 삭제
                        const s2_settings = DataManager.getS2RouteSettings(routeName);
                        if (s2_settings.baseOrder) {
                            s2_settings.baseOrder = s2_settings.baseOrder.filter(c => c !== carNum);
                            
                            if (!s2_data[routeName]) s2_data[routeName] = {};
                            s2_data[routeName]._settings = s2_settings;
                        }
                        console.log(`[S2] 로그 수정: ${dateString} / ${routeName} 차량 [${carNum}]이 S2 일지 및 순서에서 삭제되었습니다.`);
                    });

                    // 화면 즉시 새로고침
                    this.refreshDispatchLog();
                }
            },
            
            /**
             * [S2] 차량 번호 편집 모드 닫기
             */
            exitCarNumberEditMode(cell) {
                cell.querySelector('.car-display').classList.remove('hidden');
                cell.querySelector('.car-controls').classList.add('hidden');
            },
            
            /**
             * [S2] (Helper) baseOrder 차량 번호 갱신
             */
            updateBaseOrderCarNumber(routeName, oldCarNum, newCarNum) {
                 DataManager.updateS2Data(s2_data => {
                    const s2_settings = DataManager.getS2RouteSettings(routeName);
                    if (s2_settings.baseOrder) {
                        const index = s2_settings.baseOrder.indexOf(oldCarNum);
                        if (index > -1) {
                            s2_settings.baseOrder[index] = newCarNum;
                            
                            if (!s2_data[routeName]) s2_data[routeName] = {};
                            s2_data[routeName]._settings = s2_settings;
                        }
                    }
                 });
            },
            

            // --- S2 시간 설정 ---
            
            /**
             * [S2] 시간 설정 저장
             */
            saveScheduleSettings(routeName, routeId) {
                const container = document.getElementById(`route-${routeId}`);
                if (!container) return; // 첫 날짜가 아닐 경우 container가 없음

                const settings = {
                    am_startVehicle: container.querySelector(`select[name="am_startVehicle_${routeId}"]`).value,
                    am_hour: container.querySelector(`input[name="am_hour_${routeId}"]`).value,
                    am_minute: container.querySelector(`input[name="am_minute_${routeId}"]`).value,
                    am_interval: container.querySelector(`input[name="am_interval_${routeId}"]`).value,
                    pm_startVehicle: container.querySelector(`select[name="pm_startVehicle_${routeId}"]`).value,
                    pm_hour: container.querySelector(`input[name="pm_hour_${routeId}"]`).value,
                    pm_minute: container.querySelector(`input[name="pm_minute_${routeId}"]`).value,
                    pm_interval: container.querySelector(`input[name="pm_interval_${routeId}"]`).value,
                };
                
                DataManager.updateS2Data(s2_data => {
                    if (!s2_data[routeName]) s2_data[routeName] = {};
                    if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
                    
                    // 기존 설정(dispatchType 등)은 유지하고 시간 설정만 덮어쓰기
                    s2_data[routeName]._settings = { ...s2_data[routeName]._settings, ...settings };
                });
                console.log(`[S2] ${routeName} 노선 시간 설정 저장됨.`);
            },

            /**
             * [S2] 시간 설정 적용
             * [★★★ 수정됨 ★★★]
             * [★★★ 수정 ★★★] : S1 근무표 기준 '' 또는 '휴무'가 아닐 때만 시간 적용
             * 요청사항 2: 오전 시작차량을 1번으로 회전시킵니다.
             */
            applyScheduleSettings(routeName, routeId, dateString, forceSave = false) {
                const s2_settings = DataManager.getS2RouteSettings(routeName);
                
                // 0. S1 근무표 (근무자 확인용)
                const dayOfWeek = new Date(dateString + 'T00:00:00').getDay();
                const routeData = DataManager.getAllRoutes()[routeName];
                const todayS1Schedule = this.getTodayS1Schedule(routeData, dateString, dayOfWeek);
                
                const container = document.getElementById(`route-${routeId}`);
                if (!container) return;

                const am_startVehicle = container.querySelector(`select[name="am_startVehicle_${routeId}"]`).value;
                const am_interval = parseInt(container.querySelector(`input[name="am_interval_${routeId}"]`).value, 10);
                let am_currentTime = new Date();
                am_currentTime.setHours(
                    parseInt(container.querySelector(`input[name="am_hour_${routeId}"]`).value, 10),
                    parseInt(container.querySelector(`input[name="am_minute_${routeId}"]`).value, 10),
                    0, 0
                );
                
                // 1. [★★★ 수정 ★★★] '오전 시작차량'을 1번으로 회전
                let validVehicles = s2_settings.baseOrder || [];
                if (am_startVehicle && validVehicles.length > 0) {
                    const startIndex = validVehicles.indexOf(am_startVehicle);
                    if (startIndex > 0) { // 0번이 아니면 회전 필요
                        validVehicles = this.rotateArray(validVehicles, startIndex);
                        
                        // [수정] 회전된 순서를 S2 설정(baseOrder)에 즉시 저장
                        DataManager.updateS2Data(s2_data => {
                            if (!s2_data[routeName]) s2_data[routeName] = {};
                            s2_data[routeName]._settings = { ...s2_settings, baseOrder: validVehicles };
                        });
                        
                        // [수정] 화면 즉시 새로고침 (회전된 순서 반영)
                        this.refreshDispatchLog();
                        // [수정] refresh 후 container를 다시 찾아야 함
                        const newContainer = document.getElementById(`route-${routeId}`);
                        if (!newContainer) return; // 오류 방지
                        
                        console.log(`[S2] ${routeName} 노선의 순서가 ${am_startVehicle} 기준으로 회전되었습니다.`);
                    }
                }

                if (validVehicles.length === 0) {
                    alert('적용할 차량 목록이 없습니다.');
                    return;
                }

                // 2. 오전 시간 계산 (회전된 순서 기준)
                if (am_startVehicle && !isNaN(am_interval) && !isNaN(am_currentTime.getTime())) {
                    for (let i = 0; i < validVehicles.length; i++) {
                        const carNum = validVehicles[i];
                        // [★★★ 수정 ★★★] : 오전 근무자 확인
                        const s1CarData = todayS1Schedule[carNum] || [{ text: '' }, { text: '' }];
                        const amDriverText = (s1CarData[0].text || '').trim();
                        const hasAmDriver = amDriverText !== '' && amDriverText !== '휴무';

                        if (hasAmDriver) { // 근무자가 있을 때만 시간 적용
                            const timeStr = am_currentTime.toTimeString().slice(0, 5);
                            const input = document.querySelector(`tr[data-date-string="${dateString}"] input[name="start_time_${routeId}_${carNum}_am"]`);
                            if (input) input.value = timeStr;
                            am_currentTime.setMinutes(am_currentTime.getMinutes() + am_interval);
                        }
                    }
                }
                
                // 3. 오후 시간 계산
                const pm_startVehicle = container.querySelector(`select[name="pm_startVehicle_${routeId}"]`).value;
                const pm_interval = parseInt(container.querySelector(`input[name="pm_interval_${routeId}"]`).value, 10);
                let pm_currentTime = new Date();
                pm_currentTime.setHours(
                    parseInt(container.querySelector(`input[name="pm_hour_${routeId}"]`).value, 10),
                    parseInt(container.querySelector(`input[name="pm_minute_${routeId}"]`).value, 10),
                    0, 0
                );

                if (pm_startVehicle && !isNaN(pm_interval) && !isNaN(pm_currentTime.getTime())) {
                    const startIndex = validVehicles.indexOf(pm_startVehicle);
                    if (startIndex > -1) {
                        // 시작 차량(막차)부터 처음까지
                        for (let i = startIndex; i >= 0; i--) {
                            const carNum = validVehicles[i];
                            // [★★★ 수정 ★★★] : 오후 근무자 확인
                            const s1CarData = todayS1Schedule[carNum] || [{ text: '' }, { text: '' }];
                            const pmDriverText = (s1CarData[1].text || '').trim();
                            const hasPmDriver = pmDriverText !== '' && pmDriverText !== '휴무';

                            if (hasPmDriver) {
                                const timeStr = pm_currentTime.toTimeString().slice(0, 5);
                                const input = document.querySelector(`tr[data-date-string="${dateString}"] input[name="pm_start_time_${routeId}_${carNum}_pm"]`);
                                if (input) input.value = timeStr;
                                pm_currentTime.setMinutes(pm_currentTime.getMinutes() - pm_interval);
                            }
                        }
                        // 끝부터 시작 차량 다음까지
                        for (let i = validVehicles.length - 1; i > startIndex; i--) {
                            const carNum = validVehicles[i];
                            // [★★★ 수정 ★★★] : 오후 근무자 확인
                            const s1CarData = todayS1Schedule[carNum] || [{ text: '' }, { text: '' }];
                            const pmDriverText = (s1CarData[1].text || '').trim();
                            const hasPmDriver = pmDriverText !== '' && pmDriverText !== '휴무';

                            if (hasPmDriver) {
                                const timeStr = pm_currentTime.toTimeString().slice(0, 5);
                                const input = document.querySelector(`tr[data-date-string="${dateString}"] input[name="pm_start_time_${routeId}_${carNum}_pm"]`);
                                if (input) input.value = timeStr;
                                pm_currentTime.setMinutes(pm_currentTime.getMinutes() - pm_interval);
                            }
                        }
                    }
                }

                // 4. [수정] 강제 저장 (버튼 클릭 시)
                if (forceSave) {
                    // 4a. UI에 적용된 시간 설정을 S2 설정(_settings)에 저장
                    this.saveScheduleSettings(routeName, routeId);
                    
                    // 4b. UI에 적용된 시간 값들을 S2 로그(s2_data[dateString])에 저장
                    document.querySelectorAll(`input[name^="start_time_"], input[name^="pm_start_time_"], select[name^="work_hours_"]`).forEach(el => {
                        // [수정] 현재 날짜의 input/select만 저장
                        if (el.closest('tr').dataset.dateString === dateString) {
                            this.saveS2LogEntryFromElement(el);
                        }
                    });
                    
                    alert(`[${routeName}] 노선의 시간이 적용 및 저장되었습니다.`);
                }
            },
            
            /**
             * [S2] 시간 설정 초기화
             */
            resetScheduleSettings(routeName, routeId) {
                const container = document.getElementById(`route-${routeId}`);
                if (!container) return;

                if (confirm(`[${routeName}] 노선의 '시간 설정'을 초기화하시겠습니까?\n(입력된 출근 시간은 삭제되지 않습니다.)`)) {
                    
                    // 1. UI 초기화
                    container.querySelector(`select[name="am_startVehicle_${routeId}"]`).value = "";
                    container.querySelector(`input[name="am_hour_${routeId}"]`).value = "";
                    container.querySelector(`input[name="am_minute_${routeId}"]`).value = "";
                    container.querySelector(`input[name="am_interval_${routeId}"]`).value = "";
                    container.querySelector(`select[name="pm_startVehicle_${routeId}"]`).value = "";
                    container.querySelector(`input[name="pm_hour_${routeId}"]`).value = "";
                    container.querySelector(`input[name="pm_minute_${routeId}"]`).value = "";
                    container.querySelector(`input[name="pm_interval_${routeId}"]`).value = "";
                    
                    // 2. S2 설정(_settings)에서 시간 관련 키만 삭제
                    DataManager.updateS2Data(s2_data => {
                        if (s2_data[routeName] && s2_data[routeName]._settings) {
                            delete s2_data[routeName]._settings.am_startVehicle;
                            delete s2_data[routeName]._settings.am_hour;
                            delete s2_data[routeName]._settings.am_minute;
                            delete s2_data[routeName]._settings.am_interval;
                            delete s2_data[routeName]._settings.pm_startVehicle;
                            delete s2_data[routeName]._settings.pm_hour;
                            delete s2_data[routeName]._settings.pm_minute;
                            delete s2_data[routeName]._settings.pm_interval;
                        }
                    });
                    console.log(`[S2] ${routeName} 노선 시간 설정 초기화됨.`);
                }
            },


            // --- S2 드래그 앤 드롭 (S2 순서 변경) ---
            
            dragStart(e, routeName) {
                this.state.s2_draggedCell = e.target.closest('td');
                this.state.s2_draggedRoute = routeName;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', e.target.closest('td').dataset.carNumber);
                setTimeout(() => {
                    this.state.s2_draggedCell.style.opacity = '0.4';
                }, 0);
            },
            dragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            },
            drop(e, routeName) {
                e.preventDefault();
                if (this.state.s2_draggedRoute !== routeName) {
                    console.warn("[S2] 다른 노선 간 드래그는 불가능합니다.");
                    return;
                }
                const targetCell = e.target.closest('td.car-number-cell');
                const draggedCar = this.state.s2_draggedCell.dataset.carNumber;
                const targetCar = targetCell.dataset.carNumber;

                if (draggedCar === targetCar) return;

                // S2 설정(baseOrder) 업데이트
                DataManager.updateS2Data(s2_data => {
                    const s2_settings = DataManager.getS2RouteSettings(routeName);
                    let baseOrder = s2_settings.baseOrder || [];
                    
                    const draggedIndex = baseOrder.indexOf(draggedCar);
                    const targetIndex = baseOrder.indexOf(targetCar);
                    
                    if (draggedIndex > -1 && targetIndex > -1) {
                        // 배열에서 제거
                        const [draggedItem] = baseOrder.splice(draggedIndex, 1);
                        // 새 위치에 삽입
                        baseOrder.splice(targetIndex, 0, draggedItem);
                        
                        // S2 설정에 저장
                        if (!s2_data[routeName]) s2_data[routeName] = {};
                        s2_data[routeName]._settings = { ...s2_settings, baseOrder: baseOrder };
                        
                        // '수동'으로 변경
                        const container = document.querySelector(`#route-${this.sanitizeForId(routeName)} .dispatch-buttons-container`);
                        if (container) {
                            this.changeDispatchOrder(routeName, 'manual', container);
                        }
                    }
                });
                
                // 화면 갱신 (onDataChanged가 아닌 S2가 직접 호출)
                this.refreshDispatchLog();
            },
            dragEnd(e) {
                if (this.state.s2_draggedCell) {
                    this.state.s2_draggedCell.style.opacity = '1';
                }
                this.state.s2_draggedCell = null;
                this.state.s2_draggedRoute = null;
            }
        };

        /* ================================================================= */
        /* [Section 3] 정비일지 JavaScript */
        /* ================================================================= */

        /**
         * 4. S3(정비일지) 모듈
         * - S1 데이터 변경 시(onDataChanged) 노선/차량 드롭다운을 갱신합니다.
         * - S3 전용 데이터를 로드/저장/백업/복원합니다.
         */
        const S3_Module = {
            // S3 UI 요소
            ui: {
                section: document.getElementById('section3'),
                container: document.querySelector('#section3 .maintenance-container'),
                form: document.getElementById('maintenanceForm'),
                title: document.getElementById('s3_title'),
                // 날짜
                dateDisplayText: document.getElementById('s3_dateDisplay_text'),
                datePicker: document.getElementById('s3_datePicker'),
                prevDateBtn: document.getElementById('s3_prevDate'),
                nextDateBtn: document.getElementById('s3_nextDate'),
                // 인쇄/글꼴
                marginLeftSelect: document.getElementById('s3_marginLeft'),
                marginRightSelect: document.getElementById('s3_marginRight'),
                fontSizeInput: document.getElementById('s3_fontSizeInput'),
                // 복원 모달 (S3는 모달 없이 input[type=file]만 사용)
                restoreFile: document.getElementById('s3_restoreFile'),
                // 계산기 모달
                calculatorModal: document.getElementById('s3_calculatorModal'),
                startDateInput: document.getElementById('s3_startDate'),
                endDateInput: document.getElementById('s3_endDate'),
                totalPriceDisplay: document.getElementById('s3_totalPrice'),
            },

            // S3 내부 상태
            state: {
                s3_currentDate: new Date(),
                autoSaveTimer: null,
            },

            /**
             * S3 모듈 초기화
             */
            initialize() {
                console.log("S3: 초기화 시작");
                DataManager.subscribe(this); // S1 변경 알림 구독
                DataManager.loadS3Data(); // S3 데이터 로드
                
                this.state.s3_currentDate = new Date();
                this.state.s3_currentDate.setHours(0, 0, 0, 0);

                this.bindEventListeners();
                
                this.updateDateDisplay();
                this.populateRouteSelectors(); // S1 데이터 기준으로 노선/차량 채우기
                this.loadLogData(); // 오늘 날짜 데이터 채우기

                console.log("S3: 초기화 완료.");
            },

            /**
             * [핵심] S1 데이터 변경 시 (노선/차량 목록 갱신)
             */
            onDataChanged(event, payload) {
                if (event === 's1_data_changed') {
                    console.log("[S3] S1로부터 데이터 변경 알림 수신. S3 노선/차량 갱신.");
                    this.populateRouteSelectors();
                    this.updateVehicleDisplays(); // 저장된 값 기준으로 다시 선택
                }
            },

            /**
             * S3의 모든 이벤트 리스너 바인딩
             */
            bindEventListeners() {
                // 헤더 버튼
                document.getElementById('s3-showAll').onclick = () => S1_Module.showAllSections();
                document.getElementById('s3-backupFile').onclick = () => this.backupFile();
                document.getElementById('s3-triggerRestore').onclick = () => this.ui.restoreFile.click();
                this.ui.restoreFile.onchange = (e) => this.restoreFile(e.target.files[0]);
                document.getElementById('s3-clearForm').onclick = () => this.clearForm();
                document.getElementById('s3-printPage').onclick = () => this.printPage();
                
                // 날짜 네비게이션
                this.ui.prevDateBtn.onclick = () => this.changeDate(-1);
                this.ui.nextDateBtn.onclick = () => this.changeDate(1);
                this.ui.dateDisplayText.onclick = () => this.ui.datePicker.showPicker ? this.ui.datePicker.showPicker() : this.ui.datePicker.click();
                this.ui.datePicker.onchange = (e) => {
                    const selectedDate = new Date(e.target.value + 'T00:00:00'); // 시간 보정
                    if (!isNaN(selectedDate)) {
                        this.state.s3_currentDate = selectedDate;
                        this.updateDateDisplay();
                        this.loadLogData();
                    }
                };

                // 폼 이벤트 (이벤트 위임)
                this.ui.form.oninput = (e) => this.handleFormInput(e);
                this.ui.form.onfocus = (e) => this.handleFormFocus(e);
                this.ui.form.onblur = (e) => this.handleFormBlur(e);
                this.ui.form.onchange = (e) => {
                    // 노선/차량 <select> 변경 시
                    if (e.target.classList.contains('s3_routeSelect_row') || e.target.classList.contains('s3_vehicleSelect_row')) {
                        this.handleRouteSelectChange(e.target);
                        this.triggerAutoSave(); // 선택 즉시 저장
                    }
                };
                
                // 행 추가
                document.getElementById('s3-addRow').onclick = () => this.addRow();
                
                // 글꼴/여백
                this.ui.fontSizeInput.onchange = (e) => this.applyFontSize(e.target.value);
                
                // [수정] 계산기 모달
                document.getElementById('s3-showCalculator').onclick = () => this.showCalculator();
                document.getElementById('s3-closeCalculator').onclick = () => this.hideCalculator();
                document.getElementById('s3-calculatePrices').onclick = () => this.calculatePrices();
            },
            
            // --- S3 날짜 및 데이터 로드/저장 ---

            updateDateDisplay() {
                this.ui.dateDisplayText.textContent = this.state.s3_currentDate.toLocaleDateString('ko-KR', {
                    year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
                });
                this.ui.datePicker.value = DataManager.getTodayDateString(this.state.s3_currentDate);
                // 제목 업데이트
                this.ui.title.textContent = `${this.state.s3_currentDate.getFullYear()}년 ${this.state.s3_currentDate.getMonth() + 1}월 차량정비점검일지`;
            },

            changeDate(days) {
                this.state.s3_currentDate.setDate(this.state.s3_currentDate.getDate() + days);
                this.updateDateDisplay();
                this.loadLogData(); // 날짜 변경 시 데이터 로드
            },

            /**
             * [S3] 현재 날짜의 정비일지 데이터 로드
             */
            loadLogData() {
                const dateString = DataManager.getTodayDateString(this.state.s3_currentDate);
                const logData = DataManager.data.s3[dateString] || {};
                
                // 폼 초기화
                this.ui.form.reset(); 
                
                // 기본 행들 값 채우기
                this.ui.form.querySelectorAll('tr.entry-row').forEach((row, index) => {
                    const rowName = row.querySelector('textarea[name^="item_"]').name.split('_')[1]; // 예: '1', '2'
                    const rowNum = row.querySelector('textarea[name^="item_"]').name.split('_')[2]; // 예: '1', '2', '3'
                    const prefix = `${rowName}_${rowNum}`; // 예: '1_1'

                    row.querySelector(`[name="route_${prefix}"]`).value = logData[`route_${prefix}`] || '';
                    row.querySelector(`[name="vehicle_${prefix}"]`).value = logData[`vehicle_${prefix}`] || '';
                    row.querySelector(`[name="item_${prefix}"]`).value = logData[`item_${prefix}`] || '';
                    row.querySelector(`[name="detail_${prefix}"]`).value = logData[`detail_${prefix}`] || '';
                    row.querySelector(`[name="parts_${prefix}"]`).value = logData[`parts_${prefix}`] || '';
                    row.querySelector(`[name="price_${prefix}"]`).value = this.formatPriceString(logData[`price_${prefix}`] || '');
                    row.querySelector(`[name="worker_${prefix}"]`).value = logData[`worker_${prefix}`] || '';
                });

                // 추가된 행들(s3_added-row) 제거 및 생성
                this.ui.form.querySelectorAll('tr.s3_added-row').forEach(row => row.remove());
                
                let i = 3; // 기본 2_X 다음은 3_1부터
                while (logData[`route_${i}_1`]) {
                    let rowHtml = '';
                    let rowHasData = false;
                    for (let j = 1; j <= 10; j++) { // (임의의 최대치, 예: 10)
                        const prefix = `${i}_${j}`;
                        if (!logData[`route_${prefix}`] && !logData[`item_${prefix}`]) break; // 해당 그룹에 더 이상 데이터 없으면 중단
                        
                        rowHtml += this.createRowHTML(prefix, logData);
                        rowHasData = true;
                    }
                    if (rowHasData) {
                        this.ui.form.querySelector('tbody').insertAdjacentHTML('beforeend', rowHtml);
                    }
                    i++;
                }

                this.updateVehicleDisplays(); // 차량 셀렉트박스 처리
                this.autoResizeAllTextareas(); // 텍스트 영역 높이 조절
            },

            /**
             * [S3] 자동 저장 (DataManager에 저장)
             */
            saveLogData() {
                const dateString = DataManager.getTodayDateString(this.state.s3_currentDate);
                const formData = new FormData(this.ui.form);
                const logData = {};
                let hasData = false;
                
                for (let [key, value] of formData.entries()) {
                    if (key.startsWith('price_')) {
                        value = value.replace(/,/g, ''); // 콤마 제거
                    }
                    if (value.trim() !== '') {
                        logData[key] = value;
                        hasData = true;
                    }
                }

                DataManager.updateS3Data(s3_data => {
                    if (hasData) {
                        s3_data[dateString] = logData;
                    } else {
                        // 모든 데이터가 비어있으면 해당 날짜의 키를 삭제
                        delete s3_data[dateString];
                    }
                });
                
                // console.log(`[S3] ${dateString} 날짜 로그 자동 저장됨.`);
            },

            /**
             * [S3] 자동 저장 타이머
             */
            triggerAutoSave() {
                clearTimeout(this.state.autoSaveTimer);
                this.state.autoSaveTimer = setTimeout(() => {
                    this.saveLogData();
                }, 500); // 0.5초 디바운스
            },


            // --- S3 폼 핸들러 ---

            handleFormInput(e) {
                if (e.target.tagName === 'TEXTAREA') {
                    this.autoResizeTextarea(e.target);
                    this.triggerAutoSave();
                } else if (e.target.classList.contains('price-input')) {
                    this.formatPriceInput(e.target);
                    this.triggerAutoSave();
                } else if (e.target.tagName === 'INPUT') {
                    this.triggerAutoSave();
                }
            },
            
            handleFormFocus(e) {
                // 가격 입력 시 콤마 제거
                if (e.target.classList.contains('price-input')) {
                    e.target.value = e.target.value.replace(/,/g, '');
                }
            },
            
            handleFormBlur(e) {
                // 가격 입력 벗어날 때 콤마 추가
                if (e.target.classList.contains('price-input')) {
                    e.target.value = this.formatPriceString(e.target.value);
                }
            },
            
            autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
            },

            autoResizeAllTextareas() {
                this.ui.form.querySelectorAll('textarea.auto-resize').forEach(this.autoResizeTextarea);
            },
            
            formatPriceInput(input) {
                const value = input.value.replace(/[^0-9]/g, ''); // 숫자만
                input.value = value;
            },

            formatPriceString(value) {
                if (!value) return '';
                const num = parseInt(String(value).replace(/[^0-9]/g, ''));
                return isNaN(num) ? '' : num.toLocaleString('ko-KR');
            },
            
            /**
             * [S3] 모든 노선/차량 드롭다운 채우기
             */
            populateRouteSelectors() {
                const allRoutes = DataManager.getAllRoutes();
                const routeSelects = this.ui.form.querySelectorAll('select.s3_routeSelect_row');
                
                let routeOptionsHTML = '<option value="">-- 노선 선택 --</option>';
                for (const routeName in allRoutes) {
                    routeOptionsHTML += `<option value="${routeName}">${routeName}</option>`;
                }
                
                routeSelects.forEach(select => {
                    const currentValue = select.value;
                    select.innerHTML = routeOptionsHTML;
                    // 기존 값 유지
                    if (allRoutes[currentValue]) {
                        select.value = currentValue;
                    }
                });
            },

            /**
             * [S3] 노선 선택 시 차량 드롭다운 표시/채우기
             */
            handleRouteSelectChange(selectElement) {
                if (!selectElement.classList.contains('s3_routeSelect_row')) return;
                
                const routeName = selectElement.value;
                const cell = selectElement.closest('.route-select-cell');
                const vehicleSelect = cell.querySelector('.s3_vehicleSelect_row');
                const vehicleDisplay = cell.querySelector('.vehicle-display');
                
                const allRoutes = DataManager.getAllRoutes();
                
                if (routeName && allRoutes[routeName]) {
                    const vehicles = (allRoutes[routeName].vehicleColumns || []).filter(v => v && v !== '미입력');
                    let vehicleOptionsHTML = '<option value="">-- 차량 선택 --</option>';
                    vehicles.forEach(car => {
                        vehicleOptionsHTML += `<option value="${car}">${car}</option>`;
                    });
                    
                    vehicleSelect.innerHTML = vehicleOptionsHTML;
                    vehicleSelect.style.display = 'block';
                    vehicleDisplay.textContent = ''; // 차량 번호 숨기기
                } else {
                    vehicleSelect.innerHTML = '';
                    vehicleSelect.style.display = 'none';
                    vehicleDisplay.textContent = '';
                }
            },

            /**
             * [S3] (로드 시) 저장된 차량 값 표시
             */
            updateVehicleDisplays() {
                this.ui.form.querySelectorAll('select.s3_routeSelect_row').forEach(routeSelect => {
                    const routeName = routeSelect.value;
                    const cell = routeSelect.closest('.route-select-cell');
                    const vehicleSelect = cell.querySelector('.s3_vehicleSelect_row');
                    const vehicleDisplay = cell.querySelector('.vehicle-display');
                    
                    // 1. 노선에 맞게 차량 옵션 채우기
                    this.handleRouteSelectChange(routeSelect); 
                    
                    // 2. 저장된 차량 값 불러오기
                    const savedVehicle = vehicleSelect.name.replace('route_', 'vehicle_');
                    const logData = DataManager.data.s3[DataManager.getTodayDateString(this.state.s3_currentDate)] || {};
                    const vehicleValue = logData[savedVehicle] || '';

                    if (vehicleValue) {
                        // 3. 차량 드롭다운에 값 설정
                        vehicleSelect.value = vehicleValue;
                        
                        // 4. (인쇄용) 텍스트 디스플레이 설정
                        vehicleDisplay.textContent = `${routeName.replace('번', '')} / ${vehicleValue}`;
                    } else {
                         vehicleDisplay.textContent = '';
                    }
                });
            },
            
            /**
             * [S3] 폼 초기화
             */
            clearForm() {
                if (confirm('현재 날짜의 정비일지 폼을 모두 초기화하시겠습니까? (저장된 데이터도 삭제됩니다.)')) {
                    this.ui.form.reset();
                    this.ui.form.querySelectorAll('tr.s3_added-row').forEach(row => row.remove());
                    this.ui.form.querySelectorAll('.vehicle-display').forEach(div => div.textContent = '');
                    this.ui.form.querySelectorAll('.s3_vehicleSelect_row').forEach(sel => {
                        sel.innerHTML = '';
                        sel.style.display = 'none';
                    });
                    this.autoResizeAllTextareas();
                    // 데이터 즉시 삭제
                    this.saveLogData();
                }
            },

            /**
             * [S3] 행 추가
             */
            addRow() {
                // 추가된 마지막 행 찾기
                const lastAddedRow = this.ui.form.querySelector('tr.s3_added-row:last-child');
                let prefix;
                
                if (lastAddedRow) {
                    const lastName = lastAddedRow.querySelector('textarea[name^="item_"]').name;
                    const parts = lastName.split('_'); // item_3_1
                    prefix = `${parts[1]}_${parseInt(parts[2]) + 1}`; // 3_2
                } else {
                    // 추가된 행이 없으면, 기본 마지막 행 (2_4) 다음인 3_1
                    prefix = '3_1';
                }
                
                const newRowHTML = this.createRowHTML(prefix);
                this.ui.form.querySelector('tbody').insertAdjacentHTML('beforeend', newRowHTML);
                
                // 새 행의 노선 드롭다운 채우기
                this.populateRouteSelectors();
            },
            
            /**
             * [S3] (Helper) 새 행 HTML 생성
             */
            createRowHTML(prefix, data = {}) {
                return `
                    <tr class="entry-row s3_added-row">
                        <td class="route-select-cell">
                            <select class="header-select s3_routeSelect_row no-print" name="route_${prefix}">${data[`route_${prefix}`] || ''}</select>
                            <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_${prefix}" style="display: none;"></select>
                            <div class="vehicle-display"></div>
                        </td>
                        <td><textarea name="item_${prefix}" class="auto-resize">${data[`item_${prefix}`] || ''}</textarea></td>
                        <td><textarea name="detail_${prefix}" class="auto-resize">${data[`detail_${prefix}`] || ''}</textarea></td>
                        <td><textarea name="parts_${prefix}" class="auto-resize">${data[`parts_${prefix}`] || ''}</textarea></td>
                        <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_${prefix}" class="price-input" value="${this.formatPriceString(data[`price_${prefix}`] || '')}" /></div></td>
                        <td><textarea name="worker_${prefix}" class="auto-resize">${data[`worker_${prefix}`] || ''}</textarea></td>
                    </tr>
                `;
            },
            

            // --- S3 인쇄 및 백업/복원 ---
            
            applyFontSize(size) {
                 document.documentElement.style.setProperty('--s3-font-size-base', `${size}px`);
                 document.documentElement.style.setProperty('--s3-print-font-size', `${size}pt`);
                 this.autoResizeAllTextareas();
            },
            
            printPage() {
                // S3 여백 CSS 변수 설정
                document.documentElement.style.setProperty('--s3-print-margin-top', `${this.ui.marginLeftSelect.value}mm`);
                document.documentElement.style.setProperty('--s3-print-margin-bottom', `${this.ui.marginLeftSelect.value}mm`);
                document.documentElement.style.setProperty('--s3-print-margin-left', `${this.ui.marginLeftSelect.value}mm`);
                document.documentElement.style.setProperty('--s3-print-margin-right', `${this.ui.marginRightSelect.value}mm`);

                // S1, S2 숨기고 S3 인쇄 클래스 추가
                document.body.classList.remove('printing-section1', 'printing-section2');
                document.body.classList.add('printing-section3'); 
                
                const handleAfterPrint = () => {
                    document.body.classList.remove('printing-section3');
                    window.removeEventListener('afterprint', handleAfterPrint);
                };
                window.addEventListener('afterprint', handleAfterPrint);
                
                window.print();
            },
            
            backupFile() {
                const backupData = DataManager.data.s3;
                const jsonString = JSON.stringify(backupData);
                const now = new Date();
                const dateString = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
                
                let companyName = "전체";
                const { routeData } = DataManager.getCurrentRouteData();
                if (routeData && routeData.companyName) {
                    companyName = routeData.companyName.replace(/\s/g, '');
                }

                const filename = `${companyName}_정비일지(S3)_${dateString}.json`;
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                alert(`정비일지(S3) 데이터 파일 (${filename})이 다운로드 폴더에 JSON 파일로 저장됩니다.`);
            },
            
            restoreFile(file) {
                if (!file) {
                    this.ui.restoreFile.value = '';
                    return;
                }
                
                if (!confirm(`[${file.name}] 파일을 업로드하여 정비일지(S3) 데이터를 *전체* 복원하시겠습니까?\n\n[경고] 현재 S3의 모든 일지 데이터는 덮어쓰여집니다.`)) {
                    this.ui.restoreFile.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedData = JSON.parse(event.target.result);
                        
                        // S3 데이터 전체 덮어쓰기
                        DataManager.updateS3Data(s3_data => {
                            Object.keys(s3_data).forEach(key => delete s3_data[key]);
                            Object.assign(s3_data, loadedData);
                        });

                        alert(`[${file.name}] 파일로부터 S3 정비일지 전체 데이터 불러오기를 완료했습니다.`);
                        // 현재 날짜 데이터 다시 로드
                        this.loadLogData();

                    } catch (e) {
                        alert('파일을 읽는 도중 오류가 발생했습니다. 파일이 손상되었거나 JSON 형식이 아닙니다.');
                        console.error('S3 Restore Error:', e);
                    } finally {
                        this.ui.restoreFile.value = '';
                    }
                };
                reader.onerror = () => {
                    alert('파일을 읽을 수 없습니다.');
                    this.ui.restoreFile.value = '';
                };
                reader.readAsText(file);
            },
            
            // --- S3 가격 계산기 ---

            showCalculator() {
                const today = DataManager.getTodayDateString(new Date());
                this.ui.startDateInput.value = today;
                this.ui.endDateInput.value = today;
                this.ui.totalPriceDisplay.textContent = '0원';
                this.ui.calculatorModal.style.display = 'block';
            },

            hideCalculator() {
                this.ui.calculatorModal.style.display = 'none';
            },

            calculatePrices() {
                const startDate = new Date(this.ui.startDateInput.value + 'T00:00:00');
                const endDate = new Date(this.ui.endDateInput.value + 'T00:00:00');
                
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    alert('유효한 시작일과 종료일을 선택하세요.');
                    return;
                }
                if (startDate > endDate) {
                    alert('시작일은 종료일보다 이전이어야 합니다.');
                    return;
                }

                const s3_data = DataManager.data.s3;
                let totalPrice = 0;
                const reportEntries = [];
                const allRoutes = DataManager.getAllRoutes();

                // 날짜 순회
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateString = DataManager.getTodayDateString(d);
                    const logData = s3_data[dateString];
                    if (!logData) continue;
                    
                    const dateEntries = [];
                    
                    // 로그 데이터(폼 필드) 순회
                    Object.keys(logData).forEach(key => {
                        if (key.startsWith('price_')) {
                            const value = parseInt(logData[key]);
                            if (!isNaN(value)) {
                                totalPrice += value;
                                
                                // 관련 정보 찾기
                                const prefix = key.replace('price_', ''); // 1_1
                                const routeName = logData[`route_${prefix}`] || '노선없음';
                                const vehicleNum = logData[`vehicle_${prefix}`] || '차량없음';
                                const item = logData[`item_${prefix}`] || '-';
                                const detail = logData[`detail_${prefix}`] || '-';
                                
                                dateEntries.push({
                                    routeName, vehicleNum, item, detail,
                                    price: value
                                });
                            }
                        }
                    });
                    
                    if (dateEntries.length > 0) {
                        reportEntries.push({
                            date: dateString,
                            entries: dateEntries
                        });
                    }
                }
                
                // 1. 모달에 총 합계 표시
                this.ui.totalPriceDisplay.textContent = `${totalPrice.toLocaleString('ko-KR')}원`;
                
                // 2. 새 창에 상세 내역 표시
                this.openPriceReportWindow(startDate, endDate, reportEntries, totalPrice);
            },
            
            openPriceReportWindow(startDate, endDate, reportEntries, totalPrice) {
                const startStr = startDate.toLocaleDateString('ko-KR');
                const endStr = endDate.toLocaleDateString('ko-KR');
                const title = `차량정비 부품가격 보고서 (${startStr} ~ ${endStr})`;
                
                let reportHTML = `
                    <style>
                        body { font-family: 'Malgun Gothic', sans-serif; margin: 20px; }
                        h1, h2 { text-align: center; }
                        h2 { border-bottom: 2px solid #000; padding-bottom: 10px; }
                        .total-price { font-size: 1.5em; font-weight: bold; color: #dc3545; text-align: right; margin: 20px 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                        th { background-color: #f4f4f4; }
                        .date-header { font-size: 1.2em; font-weight: bold; background-color: #eaf4ff; padding: 10px; margin-top: 20px; border-top: 2px solid #0056b3; }
                        .price-cell { text-align: right; font-weight: bold; }
                        .print-button { display: block; margin: 20px auto; padding: 10px 20px; font-size: 1em; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; }
                        @media print {
                            .print-button { display: none; }
                            body { margin: 10mm; }
                            .date-header { background-color: #eee !important; -webkit-print-color-adjust: exact; }
                            tr { page-break-inside: avoid; }
                        }
                    </style>
                    <h1>${title}</h1>
                    <div class="total-price">총 부품가격 합계: ${totalPrice.toLocaleString('ko-KR')}원</div>
                    <button class="print-button" onclick="window.print()">인쇄</button>
                `;
                
                reportEntries.forEach(dailyReport => {
                    reportHTML += `<div class="date-header">${dailyReport.date}</div>`;
                    reportHTML += `
                        <table>
                            <thead>
                                <tr>
                                    <th>노선</th> <th>차량</th> <th>항목</th> <th>정비내역</th> <th>부품가격</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    let dailyTotal = 0;
                    dailyReport.entries.forEach(entry => {
                        reportHTML += `
                            <tr>
                                <td>${entry.routeName}</td>
                                <td>${entry.vehicleNum}</td>
                                <td>${entry.item}</td>
                                <td>${entry.detail}</td>
                                <td class="price-cell">${entry.price.toLocaleString('ko-KR')}원</td>
                            </tr>
                        `;
                        dailyTotal += entry.price;
                    });
                    reportHTML += `
                            <tr>
                                <td colspan="4" style="text-align: right; font-weight: bold;">일일 합계</td>
                                <td class="price-cell">${dailyTotal.toLocaleString('ko-KR')}원</td>
                            </tr>
                        </tbody></table>
                    `;
                });

                const newWindow = window.open('', '_blank', 'width=800,height=600');
                newWindow.document.write(`<html><head><title>${title}</title>${reportHTML}</head><body></body></html>`);
                newWindow.document.close();
            }
        };

        /* ================================================================= */
        /* [공통] 모듈 초기화 */
        /* ================================================================= */
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM 로드 완료. 통합 관리 시스템 초기화 시작.");
            
            // 0. 버전 정보 설정 (버전 5.4.3으로 수정)
            S1_Module.setVersion();
            
            // 1. S1(근무 현황표) 모듈 초기화
            // (S1 데이터 로드, S1 이벤트 바인딩, S1 화면 그리기)
            S1_Module.initialize();
            
            // 2. S2(승무 일지) 모듈 초기화
            // (S2 데이터 로드, S2 이벤트 바인딩, 자동 순환 적용, S2 화면 그리기)
            S2_Module.initialize();
            
            // 3. S3(정비 일지) 모듈 초기화
            // (S3 데이터 로드, S3 이벤트 바인딩, S3 화면 그리기)
            S3_Module.initialize();
            
            console.log("모든 모듈 초기화 완료.");
        });
    </script>
</body>
</html>
