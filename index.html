<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>통합 근무 관리 시스템 (현황표 + 승무일지 + 정비일지)</title>
    
    <style>
       /* ================================================================= */
        /* [공통] Global Styles */
        /* ================================================================= */
      
        :root {
            --s3-font-size-base: 16px;
            --s3-print-font-size: 11pt;
            --s3-print-margin-top: 10mm;
            --s3-print-margin-bottom: 10mm;
            --s3-print-margin-left: 10mm;
            --s3-print-margin-right: 10mm;
            --worker-font-size: 14px;
            --print-margin-left: 10mm;
            --print-margin-right: 10mm;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            background-color: #e9ecef;
            color: #333;
            font-size: 16px;
        }

        #header-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        #header-logo {
            height: 24px;
            width: auto;
            margin-right: 8px;
        }
        #version-display {
            font-size: 13px;
            font-weight: bold;
            color: #555;
        }

        .divider {
            margin: 40px 0;
            border: 2px solid #0056b3;
        }

        /* ================================================================= */
        /* [Section 1] 근무 현황표 Styles */
        /* ================================================================= */
        
        #section1 .controls {
            background-color: #fff;
            padding: 15px; border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            align-items: stretch; 
        }

        #section1 .controls fieldset {
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 10px 15px;
            margin: 0;
            background: linear-gradient(145deg, #ffffff, #f0f0f5);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 300px; 
            display: flex;
            flex-direction: column;
            gap: 10px; 
            transition: transform 0.2s;
        }
        
        #section1 .controls fieldset:hover {
             box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        #section1 .controls fieldset legend {
            font-weight: bold;
            font-size: 1.2em;
            color: #0056b3;
            padding: 2px 10px;
            border-radius: 4px;
            background-color: #eaf4ff;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        #section1 .controls .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
        }
        #section1 .controls label { font-weight: bold; margin-right: 5px; white-space: nowrap; }
        
        #section1 .controls input[type="text"],
        #section1 .controls input[type="number"], 
        #section1 .controls select {
            padding: 6px;
            border: 1px solid #a8c8e1; 
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        #section1 .controls input[type="number"] { width: 70px; }
        #section1 .controls input#companyInput { flex: 1 1 auto; min-width: 150px; }
        #section1 .controls select#typeSelect { flex: 1 1 auto; min-width: 150px; }
        #section1 .controls select { flex-grow: 1; min-width: 120px; }

        #section1 #vehicleInputsContainer {
            display: flex;
            flex-wrap: wrap; 
            gap: 5px;
            width: 100%;
            margin-top: 5px;
            padding: 5px;
            background: #e9f0f6; 
            border-radius: 4px;
            border: 1px solid #cfe2f3;
            max-height: 180px;
            overflow-y: auto;
        }
        #section1 #vehicleInputsContainer input {
            width: 80px;
            font-size: 0.9em;
            padding: 4px;
        }

        #section1 .controls select.margin-select {
            width: 35px;
            min-width: 35px;
            padding: 1px 3px;
            font-size: 0.85em; 
            flex-grow: 0;
        }
        
        #section1 .controls button,
        #section1 .controls select.action-select,
        #section1 .controls select.work-type-select,
        #section1 .controls select.vehicle-select {
            padding: 8px 15px;
            color: white; border: none; border-radius: 4px;
            cursor: pointer; font-size: 17.5px;
            text-decoration: none; display: inline-block;
            text-align: center; white-space: nowrap;
            width: auto;
            flex-grow: 0; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        
        #section1 .controls button { background-color: #007bff; }
        #section1 .controls button:hover { background-color: #0056b3; }
        #section1 .controls button.btn-danger { background-color: #dc3545; }
        #section1 .controls button.btn-danger:hover { background-color: #c82333; }
        
        #section1 .controls select.action-select { background-color: #28a745; }
        #section1 .controls select.work-type-select { background-color: #ffc107; color: #333; }
        #section1 .controls select.vehicle-select { background-color: #6c757d; }
        
        #section1 .controls select.route-navigate-select {
            padding: 8px 15px;
            font-size: 17.5px;
            background-color: #17a2b8; 
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            flex-grow: 1;
        }

        #section1 .holiday-option-group {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 5px;
            align-items: center;
            border: 1px solid #b3e5fc;
        }
        #section1 .holiday-option-group select {
            padding: 4px;
            font-size: 0.9em;
            flex-grow: 0; 
            width: 100px;
        }

        #section1 #scheduleContainer {
            background-color: white;
            padding: 10px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 90%;
            overflow-x: auto;
            border-radius: 8px;
            box-sizing: border-box; 
        }
        
        #section1 table {
            width: 100%;
            min-width: 100%; 
            border-collapse: collapse;
            margin: 0 auto; font-size: 0.9em; background-color: #fff; table-layout: fixed;
        }
        #section1 th, #section1 td {
            border: 1px solid #ddd;
            padding: 5px; 
            text-align: center;
            vertical-align: middle; 
            line-height: 1.2; 
            word-break: keep-all;
            height: 38px; box-sizing: border-box;
            font-size: 16px;
        }
        #section1 th { background-color: #f2f2f2; font-weight: bold; }
        #section1 caption {
            font-size: 1.5em;
            margin-bottom: 10px; font-weight: bold;
            color: #333; text-decoration: underline;
        }
        
        #section1 .sunday { background-color: initial !important; }
        #section1 .saturday { background-color: initial !important; }
        #section1 .holiday { 
            background-color: initial !important;
            font-weight: bold; 
            color: #cc0000;
        }
        #section1 .holiday td:not(:nth-child(1)):not(:nth-child(2)) {
            color: #333;
            font-weight: normal;
        }
        
        #section1 .sub-day-info {
            display: block;
            font-size: 0.5em; 
            line-height: 1.2;
            font-weight: bold;
            color: inherit; 
        }
        
        #section1 .day-cell-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1em;
        }
        
        #section1 .day-name-main {
            font-weight: bold;
            font-size: 1.2em; 
            line-height: 1.2;
        }
        
        #section1 .edit-mode {
            position: relative;
            padding: 2px; display: flex; flex-direction: column;
            justify-content: center; height: 100%;
            vertical-align: middle;
        }
        #section1 .edit-mode input {
            width: calc(100% - 8px);
            margin-bottom: 2px;
            padding: 2px; box-sizing: border-box;
        }
        #section1 .edit-mode .cell-buttons { display: flex; justify-content: space-around; margin-top: 2px; }
            
        #section1 .edit-mode .cell-buttons button {
            padding: 3px 5px;
            font-size: 0.7em; 
            color: white; 
            border: none;
            border-radius: 3px; 
            cursor: pointer; 
            white-space: nowrap;
            transition: background-color: 0.15s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            flex-grow: 1; 
            margin: 0 1px;
        }
        
        #section1 .edit-mode .cell-buttons button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }
        #section1 .edit-mode .cell-buttons .btn-fixed { background-color: #007bff; }
        #section1 .edit-mode .cell-buttons .btn-fixed:hover:not(:disabled) { background-color: #0056b3; }
        #section1 .edit-mode .cell-buttons .btn-temp { background-color: #28a745; }
        #section1 .edit-mode .cell-buttons .btn-temp:hover { background-color: #1e7e34; }
        #section1 .edit-mode .cell-buttons .btn-highlight-am { background-color: #6f42c1; }
        #section1 .edit-mode .cell-buttons .btn-highlight-am:hover { background-color: #5a349c; }
        #section1 .edit-mode .cell-buttons .btn-highlight-pm { background-color: #fd7e14; }
        #section1 .edit-mode .cell-buttons .btn-highlight-pm:hover { background-color: #db6a0b; }
        #section1 .edit-mode .cell-buttons .btn-delete { background-color: #dc3545; }
        #section1 .edit-mode .cell-buttons .btn-delete:hover { background-color: #c82333; }

        #section1 .name-entry { 
            display: block;
            margin-top: 2px; 
            margin-bottom: 2px; 
            color: inherit; 
            font-size: var(--worker-font-size); 
        }
        
        /* [수정됨] 특수 상태(월차/년차/퇴직자) 숨김 처리 개선 */
        #section1 .hidden-x { 
            visibility: hidden; /* 영역은 차지하되 보이지 않음 */
        }
        
        #section1 .name-entry.bold-name { font-weight: bold; }
        #section1 table th:nth-child(1),
        #section1 table td:nth-child(1),
        #section1 table th:nth-child(2),
        #section1 table td:nth-child(2) {
            width: 4%;
            min-width: 60px;
            vertical-align: middle; 
        }

        /* [Section 1] 컨트롤 박스 UI 개선 */
        #section1 .controls input[type="number"] { padding: 8px; font-size: 1em; }
        #section1 .controls input#yearInput { width: 90px; }
        #section1 .controls fieldset:nth-of-type(1) .control-group:nth-of-type(3) button { flex: 1 1 auto; }
        #section1 .controls fieldset:nth-of-type(3) .control-group { flex-direction: column; align-items: stretch; }
        #section1 .controls fieldset:nth-of-type(3) .control-group > * { margin-bottom: 5px; }
        #section1 .controls fieldset:nth-of-type(3) .control-group > *:last-child { margin-bottom: 0; }
        #section1 .controls fieldset:nth-of-type(3) .control-group:nth-of-type(2) { flex-direction: row; align-items: center; gap: 10px; }
        #section1 .controls fieldset:nth-of-type(3) .control-group:nth-of-type(2) > select { flex: 1 1 auto; margin-bottom: 0; }
        #section1 .controls fieldset:nth-of-type(4) .control-group:not(:first-of-type) { flex-direction: column; align-items: stretch; }
        #section1 .controls fieldset:nth-of-type(4) .control-group:not(:first-of-type) > * { margin-bottom: 5px; }
        #section1 .controls .control-group[style*="border-top"] { flex-direction: row; align-items: center; flex-wrap: wrap; }
        #section1 .controls .control-group[style*="border-top"] > div[style*="flex-direction: row"] {
            flex-direction: row !important;
            align-items: center !important; 
            gap: 10px !important; 
            margin-left: 10px !important; 
            flex-wrap: wrap;
        }
        #section1 .controls select.margin-select { width: 60px; min-width: 60px; padding: 4px; font-size: 0.95em; }

        @media screen and (max-width: 1400px) {
            #section1 .controls { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        }

        @media screen and (max-width: 768px) {
            #section1 #scheduleContainer { max-width: 100%; margin: 10px 0; }
            #section1 .controls { grid-template-columns: 1fr; }
            #section1 .controls .control-group { flex-direction: column; align-items: stretch; }
            #section1 .controls input[type="text"], 
            #section1 .controls input[type="number"], 
            #section1 .controls select,
            #section1 .controls input#companyInput, 
            #section1 .controls select#typeSelect { width: 100%; flex-basis: auto; }
            #section1 table { min-width: 100%; font-size: 0.8em; }
            #section1 th, #section1 td { padding: 3px; height: 30px; font-size: 13px !important; word-break: break-all; }
            #section1 .day-name-main { font-size: 1.0em; }
            #section1 .name-entry { font-size: 12px !important; }
        }

        /* ================================================================= */
        /* [Section 2] 승무 일지 Styles */
        /* ================================================================= */

        #section2 {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px; 
            color: #333;
            font-size: 12px;
        }

        #section2 .journal-container {
            background-color: white;
            padding: 15px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            max-width: 90%;
            margin: 10px auto;
            overflow-x: auto;
            box-sizing: border-box;
        }

        #section2 .header-title {
            text-align: center;
            font-size: 1.88em; 
            font-weight: bold;
            color: #0056b3;
            padding-bottom: 4px;
            margin-bottom: 4px;
            border-bottom: 2px solid #0056b3;
        }
        #section2 .title-area {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            margin: 8px 0 10px 0;
            padding: 0 5px; 
            flex-wrap: wrap;
            gap: 10px;
        }

        #section2 .title-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        #section2 .main-title {
            font-size: 1.44em;
            font-weight: bold;
            color: #333;
            display: inline-block;
        }
        
        #section2 .date-navigation-area {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
            border: 1px solid #ced4da;
            background-color: #f8f9fa;
            padding: 5px;
            border-radius: 5px;
            margin-top: 5px;
            width: 100%;
            justify-content: center;
        }
        #section2 .date-navigation-area label { font-size: 1em; font-weight: bold; margin: 0 5px; }
        #section2 .date-navigation-area input[type="date"] { font-size: 1em; padding: 3px; border: 1px solid #ced4da; border-radius: 3px; max-width: 130px; }
        #section2 .date-nav-btn {
            padding: 4px 10px; font-size: 0.94em; font-weight: bold; color: white;
            background-color: #007bff; border: none; border-radius: 3px; cursor: pointer;
        }
        #section2 .date-nav-btn:hover { background-color: #0056b3; }
        #section2 .date-nav-btn.today { background-color: #28a745; }
        #section2 .date-nav-btn.today:hover { background-color: #1e7e34; }
        #section2 .date-nav-btn.secondary { background-color: #6c757d; }
        #section2 .date-nav-btn.secondary:hover { background-color: #5a6268; }

        #section2 .options-right {
            display: flex; align-items: center; flex-wrap: wrap; gap: 10px; justify-content: flex-end; flex-grow: 1;
        }
        
        #section2 .font-selector-container {
            font-size: 0.94em; display: flex; align-items: center; white-space: nowrap;
        }
        #section2 .font-selector-container label { margin-right: 3px; font-weight: normal; }
        #section2 #font-size-select { padding: 1px 3px; font-size: 1em; height: 20px; }
        
        #section2 .dispatch-buttons-container {
            display: flex; align-items: center; font-size: 0.94em; border: 1px solid #ced4da; border-radius: 3px; padding: 2px; white-space: nowrap;
        }
        
        #section2 .dispatch-cycle-container {
             font-size: 0.94em; white-space: nowrap; display: flex; align-items: center; border: 1px solid #ced4da; border-radius: 3px; padding: 2px;
        }
        #section2 .dispatch-cycle-container label { margin: 0 8px; font-weight: normal; color: #333; }
        #section2 .dispatch-cycle-select {
            padding: 3px; font-size: 1em; border: 1px solid #ced4da; border-radius: 3px; height: 25px; vertical-align: middle;
        }
        
        #section2 .dispatch-buttons-container label { margin: 0 8px; font-weight: normal; color: #333; }
        #section2 .dispatch-button {
            padding: 3px 6px; margin-left: -1px; font-size: 1em; background-color: #f8f9fa; color: #333;
            border: 1px solid #ced4da; border-radius: 0; cursor: pointer; transition: background-color: 0.1s;
        }
        #section2 .dispatch-button:first-of-type { border-top-left-radius: 2px; border-bottom-left-radius: 2px; margin-left: 0; }
        #section2 .dispatch-button:last-of-type { border-top-right-radius: 2px; border-bottom-right-radius: 2px; }
        #section2 .dispatch-button:hover { background-color: #e2e6ea; }
        #section2 .dispatch-button.active { background-color: #007bff; color: white; border-color: #007bff; z-index: 1; }

        #section2 .print-button {
            padding: 4px 10px; font-size: 0.94em; font-weight: bold; color: white; background-color: #007bff;
            border: none; border-radius: 3px; cursor: pointer; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); white-space: nowrap;
        }
        #section2 .print-button:hover { background-color: #0056b3; }
        
        #section2 .date-header {
            font-size: 1.5em; font-weight: bold; color: #0056b3; text-align: center; padding: 10px 5px;
            background-color: #eaf4ff; border-top: 2px solid #0056b3; border-bottom: 1px solid #b3d7ff; margin: 15px 0 10px 0; display: block;
        }
        
        #section2 .route-section {
            margin-bottom: 15px; border: 1px solid #ced4da; border-radius: 4px; overflow: hidden;
        }
        
        #section2 .route-header-flex {
            display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 5px;
            background-color: #e6f7ff; padding: 5px 8px; border-bottom: 1px solid #ced4da;
        }
        
        #section2 .route-title-group { display: flex; align-items: center; flex-shrink: 0; }
        #section2 .route-name-text { font-size: 1.22em; font-weight: bold; color: #0056b3; white-space: nowrap; padding-right: 15px; }
        
        #section2 .load-button-container { display: flex; align-items: center; }
        #section2 .load-button {
            background-color: #38b43d; color: white; border: none; padding: 3px 8px; margin-left: 10px;
            border-radius: 3px; cursor: pointer; font-size: 0.88em; white-space: nowrap;
        }
        #section2 .load-button:hover { background-color: #2e8b34; }

        #section2 .schedule-options { display: flex; gap: 15px; font-size: 0.9em; flex-wrap: wrap; }
        #section2 .schedule-options select { font-size: 1em; height: 20px; padding: 0 2px; margin: 2px 0; box-sizing: border-box; vertical-align: middle; }
        #section2 .schedule-options input[type="number"] { width: 30px; height: 18px; text-align: center; font-size: 0.9em; padding: 0; margin: 0 1px; border: 1px solid #ccc; }

        #section2 .am-options, #section2 .pm-options {
            border: 1px solid #ddd; padding: 3px 5px; background-color: #f7f9fb; border-radius: 3px; white-space: nowrap;
        }
        #section2 .am-options span, #section2 .pm-options span { font-weight: bold; }
        
        #section2 .settings-controls {
            display: flex; flex-direction: column; gap: 2px; padding-top: 5px; flex-shrink: 0;
        }

        #section2 .setting-button {
            padding: 3px 5px; font-size: 0.88em; cursor: pointer; border: 1px solid #ccc; border-radius: 3px; white-space: nowrap; transition: background-color: 0.1s;
        }
        #section2 .apply-button { background-color: #d4edda; border-color: #c3e6cb; }
        #section2 .apply-button:hover { background-color: #c3e6cb; }
        #section2 .reset-button { background-color: #f8d7da; border-color: #f5c6cb; }
        #section2 .reset-button:hover { background-color: #f5c6cb; }
        
        #section2 table { 
            width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 0.88em; background-color: #fff;
        }

        #section2 th, #section2 td { 
            border: 1px solid #ddd; padding: 2px 1px; text-align: center; vertical-align: middle;
            height: 20px; box-sizing: border-box; line-height: 1.1; position: relative;
        }

        #section2 th { background-color: #e9ecef; font-weight: bold; color: #333; }
        
        #section2 .car-number-cell { font-weight: bold; font-size: 1.136em; cursor: pointer; padding: 0; }

        #section2 .car-display {
            padding: 2px 1px; height: 100%; width: 100%; box-sizing: border-box;
            display: flex; justify-content: center; align-items: center;
        }

        #section2 .car-controls {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-color: #fff; padding: 1px; box-sizing: border-box; gap: 1px; z-index: 10; border: 2px solid #ffc107;
        }

        #section2 .car-controls select { width: 95%; font-size: 0.8em; padding: 0; margin: 0; height: 14px; }
        #section2 .car-controls button {
            width: 48%; font-size: 0.7em; padding: 0; margin: 0; height: 14px; line-height: 1;
            box-sizing: border-box; border: 1px solid #ccc; cursor: pointer; background-color: #f0f0f0;
        }
        #section2 .car-controls div { display: flex; justify-content: space-between; width: 95%; margin-top: 1px; }
        
        #section2 .journal-table th:nth-child(1),
        #section2 .journal-table th:nth-child(10) { font-size: 1.136em; }
        
        #section2 input[type="number"], #section2 input[type="text"] {
            font-size: 1em; padding: 0; margin: 0; width: 100%; height: 18px; 
            box-sizing: border-box; border: 1px solid #ccc; text-align: center; -moz-appearance: textfield;
        }
        
        #section2 .journal-table colgroup col { width: 5.4%; } 

        #section2 .driver-name {
            box-sizing: border-box; width: 100%; padding: 0; margin: 0; border: none; background: transparent;
            text-align: center; line-height: 1.1em; min-height: 18px; cursor: pointer; display: block;
        }
        
        #section2 .driver-input {
            resize: none; height: 18px; overflow: hidden; border: 1px solid #007bff; background-color: #fff !important;
            font-size: 1em; box-sizing: border-box; width: 100%; padding: 0; margin: 0; text-align: center;
        }

        #section2 .edit-controls {
            display: flex; justify-content: center; gap: 2px; padding: 1px 0; margin-top: -1px; 
        }
        #section2 .edit-controls button {
            flex-grow: 1; padding: 0; margin: 0; font-size: 0.8em; height: 18px; line-height: 1;
            cursor: pointer; border-radius: 2px; border: 1px solid #ccc;
        }
        #section2 .edit-controls button:first-child { background-color: #f44336; color: white; border-color: #d32f2f; }
        #section2 .edit-controls button:last-child { background-color: #4CAF50; color: white; border-color: #388e3c; }

        #section2 .hidden { display: none !important; }
        
        @media screen and (max-width: 768px) {
            #section2 .journal-container { max-width: 100%; margin: 10px 0; padding: 5px; }
            #section2 { font-size: 11px !important; }
            #section2 .options-right { gap: 5px; flex-wrap: wrap; justify-content: flex-end; }
            #section2 .print-button { padding: 3px 6px; font-size: 1em; }
            #section2 .dispatch-buttons-container label { margin: 0 4px; }
            #section2 th, #section2 td { height: 30px; padding: 2px 0; }
            #section2 input[type="number"], #section2 input[type="text"],
            #section2 .s2-work-hours-select, #section2 .driver-input, #section2 .driver-name { height: 16px; font-size: 0.95em; }
            
            #section2 .date-navigation-area { flex-direction: column; align-items: stretch; }
            #section2 .date-navigation-area div { display: flex; gap: 5px; width: 100%; }
            #section2 .date-navigation-area input[type="date"] { flex-grow: 1; max-width: none; }
            #section2 .date-navigation-area .date-nav-btn { flex-grow: 1; }
        }

        #section2 .s2-work-hours-select {
            font-size: 1em; padding: 0; margin: 0; width: 100%; height: 18px; 
            box-sizing: border-box; border: 1px solid #ccc; text-align: center;
            background-color: white; -moz-appearance: none; -webkit-appearance: none; appearance: none;
        }
        
        /* ================================================================= */
        /* [Section 3] 정비일지 Styles */
        /* ================================================================= */
        
        #section3 {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0; padding: 10px; color: #333; font-size: var(--s3-font-size-base); 
        }
        #section3 .maintenance-container {
            max-width: 900px; margin: 18px auto; background: #fff; padding: 10px;
            border: 1px solid #000; box-shadow: 0 6px 18px rgba(0,0,0,0.06); box-sizing: border-box;
        }
        
        #section3 header { display: flex; flex-wrap: wrap; align-items: center; }
        #section3 header h1 {
            flex-basis: 100%; text-align: center; order: -1; margin-bottom: 10px; font-size: 20px; margin-top: 6px;
        }
        #section3 .controls {
            flex-basis: 100%; display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; align-items: center;
        }
        
        #section3 button {
            padding: 8px 12px; border-radius: 4px; border: 1px solid #444; background: #fff; cursor: pointer; font-size: 16px;
        }
        #section3 button.primary { background: #007bff; color: #fff; border-color: #007bff; }
        #section3 button.success { background: #28a745; color: #fff; }
        #section3 button.warning { background: #ffc107; color: #333; }

        #section3 .margin-control-group {
            display: flex; flex-direction: row; align-items: center; gap: 6px; padding: 4px;
            border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa;
        }
        #section3 .margin-control-group > label { font-size: 14px; font-weight: bold; margin-right: 5px; }
        #section3 .margin-control { display: flex; flex-direction: column; align-items: center; }
        #section3 .margin-control label { font-size: 12px; font-weight: bold; color: #333; }
        #section3 .margin-select { width: 45px; font-size: 13px; padding: 1px; border: 1px solid #aaa; border-radius: 3px; }
        
        #section3 .form-table {
            width: 100%; border-collapse: collapse; margin-top: 8px; border: 1px solid #000; table-layout: fixed;
        }
        #section3 .form-table td, #section3 .form-table th {
            border: 1px solid #000; padding: 6px; vertical-align: middle;
            font-size: calc(var(--s3-font-size-base) * 0.9); height: 28px; box-sizing: border-box; word-break: break-all;
        }
        #section3 .form-table thead th { text-align: center; border-top-width: 1px; }
        
        #section3 .route-col { width: 15%; } 
        #section3 .item-col { width: 20%; } 
        #section3 .detail-col { width: 20%; } 
        #section3 .parts-col { width: 15%; } 
        #section3 .price-col { width: 15%; } 
        #section3 .worker-col { width: 15%; } 
        #section3 .date-col { width: auto; }
        
        #section3 #s3_date_nav_container {
            display: flex; justify-content: center; align-items: center; gap: 10px; position: relative;
        }
        #section3 .s3_date_nav_btn {
            font-size: 1em; font-weight: bold; cursor: pointer; color: #0056b3; user-select: none; padding: 5px;
        }
        #section3 .s3_date_nav_btn:hover { color: #007bff; }
        #section3 #s3_dateDisplay_text {
            font-weight: bold; font-size: 1.1em; cursor: pointer; padding: 5px; border-radius: 4px;
        }
         #section3 #s3_dateDisplay_text:hover { background-color: #eaf4ff; }
        
        #section3 #s3_datePicker {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            width: 100px; height: 100%; opacity: 0; cursor: pointer;
        }

        #section3 .route-select-cell { vertical-align: top !important; padding: 4px !important; }
        #section3 .header-select {
            font-size: 11px; padding: 2px; width: 100%; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 3px;
        }
        #section3 .vehicle-display { font-weight: bold; font-size: 12px; color: #0056b3; margin-top: 4px; height: 1.2em; }
        
        #section3 input[type=text], #section3 input[type=number], #section3 textarea, #section3 select {
            width: 100%; box-sizing: border-box; border: none; outline: none; font-size: 14px;
            color: #000; background: transparent; resize: none;
        }
        #section3 textarea.auto-resize { overflow-y: hidden; min-height: 28px; line-height: 1.4; }
        
        #section3 .price-input { text-align: right; width: 100%; padding-right: 20px; box-sizing: border-box; }
        #section3 .price-wrapper { position: relative; width: 100%; }
        #section3 .price-wrapper::after {
            content: "원"; position: absolute; top: 50%; right: 5px; transform: translateY(-50%); color: #555; pointer-events: none;
        }
        #section3 .s3_added-row { background-color: #f0f8ff; }
        
        @media screen and (max-width: 768px) {
            #section3 .maintenance-container {
                max-width: 100%; padding: 5px; margin: 10px 0; overflow-x: auto; box-sizing: border-box;
            }
            #section3 header .controls { flex-direction: column; align-items: stretch; gap: 5px; }
            #section3 header .controls > * { width: 100%; box-sizing: border-box; }
            #section3 .form-table { font-size: 12px; min-width: 800px; }
            #section3 .form-table td, #section3 .form-table th { padding: 4px; }
            #section3 input[type=text], #section3 input[type=number], #section3 textarea, #section3 select { font-size: 12px; }
        }

        /* ================================================================= */
        /* [공통] 인쇄 스타일 */
        /* ================================================================= */
        @media print {
            #header-bar, #s2_restoreDateModal, #s3_restoreDateModal, #s3_calculatorModal, #s2_timeSettingModal { display: none !important; }

            body.printing-section1 #section2, body.printing-section1 #section3, body.printing-section1 .divider { display: none !important; }
            body.printing-section2 #section1, body.printing-section2 #section3, body.printing-section2 .divider { display: none !important; }
            body.printing-section3 #section1, body.printing-section3 #section2, body.printing-section3 .divider { display: none !important; }
            
            body.printing-section1 .controls { display: none !important; }
            
            body.printing-section1 @page { size: A4; margin: 10mm; margin-left: var(--print-margin-left, 15mm); margin-right: var(--print-margin-right, 5mm); }
            body.printing-section1 { background-color: white; margin: 0; padding: 0; -webkit-print-color-adjust: exact; }
            body.printing-section1 #scheduleContainer { box-shadow: none; margin: 0; padding: 0; }
            body.printing-section1 #section1 caption { font-size: 1.0em; margin-bottom: 5px; }
            body.printing-section1 #section1 table { width: 100%; min-width: unset; font-size: 0.8em; border: 1px solid #000; table-layout: fixed; page-break-inside: auto; }
            body.printing-section1 #section1 tr { page-break-inside: avoid; page-break-after: auto; }
            body.printing-section1 #section1 th, body.printing-section1 #section1 td { padding: 1px; height: auto; word-break: break-all; vertical-align: top; border: 1px solid #000; }
            body.printing-section1 #section1 table th:nth-child(1), body.printing-section1 #section1 table td:nth-child(1),
            body.printing-section1 #section1 table th:nth-child(2), body.printing-section1 #section1 table td:nth-child(2) { width: 4%; vertical-align: middle; }
            body.printing-section1 #section1 .sub-day-info { font-size: 0.5em; } 
            body.printing-section1 #section1 .day-name-main { font-size: 1em; }
            body.printing-section1 #section1 .sunday { background-color: initial !important; }
            body.printing-section1 #section1 .saturday { background-color: initial !important; }
            body.printing-section1 #section1 .holiday { background-color: initial !important; font-weight: bold; color: #cc0000; }
            body.printing-section1 #section1 .holiday td:not(:nth-child(1)):not(:nth-child(2)) { color: #000; font-weight: normal; }

            body.printing-section2 @page { size: A4 landscape; margin: 6mm; }
            body.printing-section2 { background-color: white; padding: 0; margin: 0; font-size: 9pt; color: #000; }
            body.printing-section2 #section2 .journal-container { box-shadow: none; border-radius: 0; padding: 0; margin: 0; max-width: 100%; }
            body.printing-section2 #section2 .date-navigation-area,
            body.printing-section2 #section2 .dispatch-cycle-container,
            body.printing-section2 #section2 .print-button, 
            body.printing-section2 #section2 .font-selector-container, 
            body.printing-section2 #section2 .dispatch-buttons-container,
            body.printing-section2 #section2 .driver-input, 
            body.printing-section2 #section2 .edit-controls, 
            body.printing-section2 #section2 .schedule-options, 
            body.printing-section2 #section2 .load-button-container,
            body.printing-section2 #section2 .car-controls,
            body.printing-section2 #section2 .settings-controls 
            { display: none !important; }
            
            body.printing-section2 #section2 table { font-size: 7pt; border-collapse: collapse !important; border: 1px solid #000 !important; }
            body.printing-section2 #section2 th, body.printing-section2 #section2 td { height: 16px; padding: 1px 0px; border: 1px solid #000 !important; }
            body.printing-section2 #section2 .header-title, body.printing-section2 #section2 .main-title, body.printing-section2 #section2 .route-name-text { color: #000 !important; }
            body.printing-section2 #section2 .route-header-flex { background-color: #eee !important; border-bottom: 1px solid #000 !important; }
            body.printing-section2 #section2 .date-header { font-size: 1.2em; padding: 5px; margin: 10px 0 5px 0; background-color: #f0f0f0 !important; border-top: 1px solid #000 !important; border-bottom: 1px solid #000 !important; color: #000 !important; -webkit-print-color-adjust: exact; }

            body.printing-section2 #section2 input[type="number"], body.printing-section2 #section2 input[type="text"],
            body.printing-section2 #section2 .s2-work-hours-select { border: none; background: transparent; padding: 0; height: auto; -webkit-appearance: none; -moz-appearance: none; appearance: none; }

            body.printing-section2 #section2 .driver-name, body.printing-section2 #section2 .car-display { display: flex !important; justify-content: center; align-items: center; border: none !important; cursor: default; height: 100%; width: 100%; }
            body.printing-section2 #section2 .car-number-cell { padding: 2px 1px; }

            body.printing-section3 #section3 .maintenance-container { max-width: 100%; border: none; box-shadow: none; margin: 0; padding: 0; }
            body.printing-section3 #section3 .form-table { font-size: var(--s3-print-font-size); border: 2px solid #000 !important; }
            body.printing-section3 #section3 .form-table td, body.printing-section3 #section3 .form-table th { border: 1px solid #000 !important; padding: 4px !important; height: auto !important; vertical-align: top; }
            body.printing-section3 #section3 input, body.printing-section3 #section3 textarea { border: none !important; background: transparent !important; font-size: calc(var(--s3-print-font-size) * 0.9) !important; height: auto !important; overflow: visible !important; color: #000 !important; }
            body.printing-section3 #section3 .price-wrapper::after { display: none; }
            body.printing-section3 #section3 .price-input { padding-right: 0; }
            body.printing-section3 #section3 .no-print, body.printing-section3 #section3 .header-select { display: none !important; }
            body.printing-section3 #section3 #s3_date_nav_container { display: none !important; }
            body.printing-section3 #section3 #s3_dateDisplay { display: block; font-weight: bold; font-size: 1.1em; }
            body.printing-section3 #section3 .vehicle-display { font-size: 11px !important; color: #000 !important; height: auto !important; margin-top: 0; }
            
            body.printing-section3 @page { 
                size: A4 portrait; margin-top: var(--s3-print-margin-top); margin-bottom: var(--s3-print-margin-bottom); margin-left: var(--s3-print-margin-left); margin-right: var(--s3-print-margin-right);
            }
        }
/* [Section 2] 휴무자 명단 및 팝업 스타일 (업그레이드됨) */
.rest-worker-container {
    margin-top: 5px;
    border: 1px solid #ced4da;
    display: flex;
    background-color: #fff;
    page-break-inside: avoid;
}
.rest-worker-title {
    background-color: #e9ecef;
    width: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #333;
    border-right: 1px solid #ced4da;
    text-align: center;
    padding: 5px;
    font-size: 1.1em;
    flex-shrink: 0;
}
.rest-worker-grid {
    flex-grow: 1;
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    grid-template-rows: repeat(2, 1fr);
}
.rest-worker-cell {
    border: 1px solid #ced4da;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1em;
    color: #333;
    margin-left: -1px;
    margin-top: -1px;
    cursor: pointer;
    position: relative; /* 팝업 위치 기준 */
}
.rest-worker-cell:hover {
    background-color: #eaf4ff;
}

/* 팝업 컨트롤 박스 */
.rest-worker-controls {
    display: none; /* 평소엔 숨김 */
    position: absolute;
    top: -35px; /* 칸 위쪽에 띄움 */
    left: 50%;
    transform: translateX(-50%);
    background-color: white;
    border: 1px solid #007bff;
    padding: 3px;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    z-index: 100;
    width: 160px;
    flex-direction: column;
    gap: 3px;
}
.rest-worker-cell.edit-mode .rest-worker-controls {
    display: flex; /* 수정 모드일 때 보임 */
}
.rest-worker-controls input {
    width: 100%;
    border: 1px solid #ccc;
    text-align: center;
    margin-bottom: 2px;
}
.rest-worker-btn-group {
    display: flex;
    justify-content: space-between;
    gap: 2px;
}
.rest-worker-btn-group button {
    flex: 1;
    font-size: 11px;
    padding: 2px 0;
    cursor: pointer;
    border: none;
    color: white;
    border-radius: 2px;
}
.btn-rest-save { background-color: #28a745; } /* 수정(초록) */
.btn-rest-del { background-color: #dc3545; }  /* 삭제(빨강) */
.btn-rest-close { background-color: #6c757d; } /* 닫기(회색) */
    
    /* 인쇄 모드일 때 스타일 강제 적용 */
    @media print {
        body.printing-section2 .rest-worker-container {
            border: 1px solid #000 !important;
            margin-top: 10px;
        }
        body.printing-section2 .rest-worker-title {
            background-color: #ddd !important;
            -webkit-print-color-adjust: exact;
            color: #000 !important;
            border-right: 1px solid #000 !important;
        }
        body.printing-section2 .rest-worker-cell {
            border: 1px solid #000 !important;
            color: #000 !important;
        }
    }
/* [Section 2] 휴무자 명단 수정 모드 스타일 (추가됨) */
    .rest-worker-cell {
        cursor: pointer; /* 클릭 가능하다는 손가락 표시 */
        position: relative;
    }
    .rest-worker-cell:hover {
        background-color: #eaf4ff; /* 마우스 올렸을 때 살짝 색상 변경 */
    }
    /* 수정할 때 나오는 입력창 */
    .rest-worker-input {
        width: 100%;
        height: 100%;
        border: 2px solid #007bff;
        text-align: center;
        font-size: 1em;
        box-sizing: border-box;
        display: none; /* 평소에는 숨김 */
        position: absolute;
        top: 0; 
        left: 0;
        z-index: 10;
    }
    /* 수정 모드일 때 입력창 보이기 */
    .rest-worker-cell.edit-mode .rest-worker-input {
        display: block;
    }
    /* 수정 모드일 때 기존 글자 숨기기 */
    .rest-worker-cell.edit-mode span {
        visibility: hidden;
    }
/* [Section 2] 휴무자(오전/오후) 셀 수정 모드 스타일 (추가됨) */
    .s2-holiday-cell {
        cursor: pointer; /* 클릭 가능 표시 */
        position: relative;
    }
    .s2-holiday-cell:hover {
        background-color: #fff3cd; /* 마우스 올렸을 때 살짝 노란색 */
    }
    .holiday-worker-input {
        width: 100%;
        height: 100%;
        border: 2px solid #ffc107; /* 강조색 */
        text-align: center;
        font-size: 1em;
        box-sizing: border-box;
        display: none; /* 평소엔 숨김 */
        position: absolute;
        top: 0; 
        left: 0;
        z-index: 10;
    }
    .s2-holiday-cell.edit-mode .holiday-worker-input {
        display: block; /* 수정 모드일 때 보임 */
    }
    .s2-holiday-cell.edit-mode span {
        visibility: hidden; /* 기존 글자 숨김 */
    }
        
        /* ================================================================= */
        /* [Section 3] 정비일지 Styles */
        /* ================================================================= */
        
        #section3 {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0; padding: 10px; color: #333; font-size: var(--s3-font-size-base); 
        }
        #section3 .maintenance-container {
            max-width: 900px; margin: 18px auto; background: #fff; padding: 10px;
            border: 1px solid #000; box-shadow: 0 6px 18px rgba(0,0,0,0.06); box-sizing: border-box;
        }
        
        #section3 header { display: flex; flex-wrap: wrap; align-items: center; }
        #section3 header h1 {
            flex-basis: 100%; text-align: center; order: -1; margin-bottom: 10px; font-size: 20px; margin-top: 6px;
        }
        #section3 .controls {
            flex-basis: 100%; display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; align-items: center;
        }
        
        #section3 button {
            padding: 8px 12px; border-radius: 4px; border: 1px solid #444; background: #fff; cursor: pointer; font-size: 16px;
        }
        #section3 button.primary { background: #007bff; color: #fff; border-color: #007bff; }
        #section3 button.success { background: #28a745; color: #fff; }
        #section3 button.warning { background: #ffc107; color: #333; }

        #section3 .margin-control-group {
            display: flex; flex-direction: row; align-items: center; gap: 6px; padding: 4px;
            border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa;
        }
        #section3 .margin-control-group > label { font-size: 14px; font-weight: bold; margin-right: 5px; }
        #section3 .margin-control { display: flex; flex-direction: column; align-items: center; }
        #section3 .margin-control label { font-size: 12px; font-weight: bold; color: #333; }
        #section3 .margin-select { width: 45px; font-size: 13px; padding: 1px; border: 1px solid #aaa; border-radius: 3px; }
        
        #section3 .form-table {
            width: 100%; border-collapse: collapse; margin-top: 8px; border: 1px solid #000; table-layout: fixed;
        }
        #section3 .form-table td, #section3 .form-table th {
            border: 1px solid #000; padding: 6px; vertical-align: middle;
            font-size: calc(var(--s3-font-size-base) * 0.9); height: 28px; box-sizing: border-box; word-break: break-all;
        }
        #section3 .form-table thead th { text-align: center; border-top-width: 1px; }
        
        #section3 .route-col { width: 15%; } 
        #section3 .item-col { width: 20%; } 
        #section3 .detail-col { width: 20%; } 
        #section3 .parts-col { width: 15%; } 
        #section3 .price-col { width: 15%; } 
        #section3 .worker-col { width: 15%; } 
        #section3 .date-col { width: auto; }
        
        #section3 #s3_date_nav_container {
            display: flex; justify-content: center; align-items: center; gap: 10px; position: relative;
        }
        #section3 .s3_date_nav_btn {
            font-size: 1em; font-weight: bold; cursor: pointer; color: #0056b3; user-select: none; padding: 5px;
        }
        #section3 .s3_date_nav_btn:hover { color: #007bff; }
        #section3 #s3_dateDisplay_text {
            font-weight: bold; font-size: 1.1em; cursor: pointer; padding: 5px; border-radius: 4px;
        }
         #section3 #s3_dateDisplay_text:hover { background-color: #eaf4ff; }
        
        #section3 #s3_datePicker {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            width: 100px; height: 100%; opacity: 0; cursor: pointer;
        }

        #section3 .route-select-cell { vertical-align: top !important; padding: 4px !important; }
        #section3 .header-select {
            font-size: 11px; padding: 2px; width: 100%; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 3px;
        }
        #section3 .vehicle-display { font-weight: bold; font-size: 12px; color: #0056b3; margin-top: 4px; height: 1.2em; }
        
        #section3 input[type=text], #section3 input[type=number], #section3 textarea, #section3 select {
            width: 100%; box-sizing: border-box; border: none; outline: none; font-size: 14px;
            color: #000; background: transparent; resize: none;
        }
        #section3 textarea.auto-resize { overflow-y: hidden; min-height: 28px; line-height: 1.4; }
        
        #section3 .price-input { text-align: right; width: 100%; padding-right: 20px; box-sizing: border-box; }
        #section3 .price-wrapper { position: relative; width: 100%; }
        #section3 .price-wrapper::after {
            content: "원"; position: absolute; top: 50%; right: 5px; transform: translateY(-50%); color: #555; pointer-events: none;
        }
        #section3 .s3_added-row { background-color: #f0f8ff; }
        
        @media screen and (max-width: 768px) {
            #section3 .maintenance-container {
                max-width: 100%; padding: 5px; margin: 10px 0; overflow-x: auto; box-sizing: border-box;
            }
            #section3 header .controls { flex-direction: column; align-items: stretch; gap: 5px; }
            #section3 header .controls > * { width: 100%; box-sizing: border-box; }
            #section3 .form-table { font-size: 12px; min-width: 800px; }
            #section3 .form-table td, #section3 .form-table th { padding: 4px; }
            #section3 input[type=text], #section3 input[type=number], #section3 textarea, #section3 select { font-size: 12px; }
        }

        /* ================================================================= */
        /* [공통] 인쇄 스타일 */
        /* ================================================================= */
        @media print {
            #header-bar, #s2_restoreDateModal, #s3_restoreDateModal, #s3_calculatorModal, #s2_timeSettingModal { display: none !important; }

            body.printing-section1 #section2, body.printing-section1 #section3, body.printing-section1 .divider { display: none !important; }
            body.printing-section2 #section1, body.printing-section2 #section3, body.printing-section2 .divider { display: none !important; }
            body.printing-section3 #section1, body.printing-section3 #section2, body.printing-section3 .divider { display: none !important; }
            
            body.printing-section1 .controls { display: none !important; }
            
            body.printing-section1 @page { size: A4; margin: 10mm; margin-left: var(--print-margin-left, 15mm); margin-right: var(--print-margin-right, 5mm); }
            body.printing-section1 { background-color: white; margin: 0; padding: 0; -webkit-print-color-adjust: exact; }
            body.printing-section1 #scheduleContainer { box-shadow: none; margin: 0; padding: 0; }
            body.printing-section1 #section1 caption { font-size: 1.0em; margin-bottom: 5px; }
            body.printing-section1 #section1 table { width: 100%; min-width: unset; font-size: 0.8em; border: 1px solid #000; table-layout: fixed; page-break-inside: auto; }
            body.printing-section1 #section1 tr { page-break-inside: avoid; page-break-after: auto; }
            body.printing-section1 #section1 th, body.printing-section1 #section1 td { padding: 1px; height: auto; word-break: break-all; vertical-align: top; border: 1px solid #000; }
            body.printing-section1 #section1 table th:nth-child(1), body.printing-section1 #section1 table td:nth-child(1),
            body.printing-section1 #section1 table th:nth-child(2), body.printing-section1 #section1 table td:nth-child(2) { width: 4%; vertical-align: middle; }
            body.printing-section1 #section1 .sub-day-info { font-size: 0.5em; } 
            body.printing-section1 #section1 .day-name-main { font-size: 1em; }
            body.printing-section1 #section1 .sunday { background-color: initial !important; }
            body.printing-section1 #section1 .saturday { background-color: initial !important; }
            body.printing-section1 #section1 .holiday { background-color: initial !important; font-weight: bold; color: #cc0000; }
            body.printing-section1 #section1 .holiday td:not(:nth-child(1)):not(:nth-child(2)) { color: #000; font-weight: normal; }

            body.printing-section2 @page { size: A4 landscape; margin: 6mm; }
            body.printing-section2 { background-color: white; padding: 0; margin: 0; font-size: 9pt; color: #000; }
            body.printing-section2 #section2 .journal-container { box-shadow: none; border-radius: 0; padding: 0; margin: 0; max-width: 100%; }
            body.printing-section2 #section2 .date-navigation-area,
            body.printing-section2 #section2 .dispatch-cycle-container,
            body.printing-section2 #section2 .print-button, 
            body.printing-section2 #section2 .font-selector-container, 
            body.printing-section2 #section2 .dispatch-buttons-container,
            body.printing-section2 #section2 .driver-input, 
            body.printing-section2 #section2 .edit-controls, 
            body.printing-section2 #section2 .schedule-options, 
            body.printing-section2 #section2 .load-button-container,
            body.printing-section2 #section2 .car-controls,
            body.printing-section2 #section2 .settings-controls 
            { display: none !important; }
            
            body.printing-section2 #section2 table { font-size: 7pt; border-collapse: collapse !important; border: 1px solid #000 !important; }
            body.printing-section2 #section2 th, body.printing-section2 #section2 td { height: 16px; padding: 1px 0px; border: 1px solid #000 !important; }
            body.printing-section2 #section2 .header-title, body.printing-section2 #section2 .main-title, body.printing-section2 #section2 .route-name-text { color: #000 !important; }
            body.printing-section2 #section2 .route-header-flex { background-color: #eee !important; border-bottom: 1px solid #000 !important; }
            body.printing-section2 #section2 .date-header { font-size: 1.2em; padding: 5px; margin: 10px 0 5px 0; background-color: #f0f0f0 !important; border-top: 1px solid #000 !important; border-bottom: 1px solid #000 !important; color: #000 !important; -webkit-print-color-adjust: exact; }

            body.printing-section2 #section2 input[type="number"], body.printing-section2 #section2 input[type="text"],
            body.printing-section2 #section2 .s2-work-hours-select { border: none; background: transparent; padding: 0; height: auto; -webkit-appearance: none; -moz-appearance: none; appearance: none; }

            body.printing-section2 #section2 .driver-name, body.printing-section2 #section2 .car-display { display: flex !important; justify-content: center; align-items: center; border: none !important; cursor: default; height: 100%; width: 100%; }
            body.printing-section2 #section2 .car-number-cell { padding: 2px 1px; }

            body.printing-section3 #section3 .maintenance-container { max-width: 100%; border: none; box-shadow: none; margin: 0; padding: 0; }
            body.printing-section3 #section3 .form-table { font-size: var(--s3-print-font-size); border: 2px solid #000 !important; }
            body.printing-section3 #section3 .form-table td, body.printing-section3 #section3 .form-table th { border: 1px solid #000 !important; padding: 4px !important; height: auto !important; vertical-align: top; }
            body.printing-section3 #section3 input, body.printing-section3 #section3 textarea { border: none !important; background: transparent !important; font-size: calc(var(--s3-print-font-size) * 0.9) !important; height: auto !important; overflow: visible !important; color: #000 !important; }
            body.printing-section3 #section3 .price-wrapper::after { display: none; }
            body.printing-section3 #section3 .price-input { padding-right: 0; }
            body.printing-section3 #section3 .no-print, body.printing-section3 #section3 .header-select { display: none !important; }
            body.printing-section3 #section3 #s3_date_nav_container { display: none !important; }
            body.printing-section3 #section3 #s3_dateDisplay { display: block; font-weight: bold; font-size: 1.1em; }
            body.printing-section3 #section3 .vehicle-display { font-size: 11px !important; color: #000 !important; height: auto !important; margin-top: 0; }
            
            body.printing-section3 @page { 
                size: A4 portrait; margin-top: var(--s3-print-margin-top); margin-bottom: var(--s3-print-margin-bottom); margin-left: var(--s3-print-margin-left); margin-right: var(--s3-print-margin-right);
            }
        }
/* [Section 2] 휴무자 명단 박스 스타일 (추가됨) */
    .rest-worker-container {
        margin-top: 5px;
        border: 1px solid #ced4da;
        display: flex;
        background-color: #fff;
        page-break-inside: avoid; /* 인쇄 시 잘림 방지 */
    }
    .rest-worker-title {
        background-color: #e9ecef;
        width: 80px; /* 제목 너비 */
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #333;
        border-right: 1px solid #ced4da;
        text-align: center;
        padding: 5px;
        font-size: 1.1em;
        flex-shrink: 0;
    }
    .rest-worker-grid {
        flex-grow: 1;
        display: grid;
        grid-template-columns: repeat(9, 1fr); /* 가로 9칸 */
        grid-template-rows: repeat(2, 1fr);    /* 세로 2줄 = 총 18칸 */
    }
    .rest-worker-cell {
        border: 1px solid #ced4da;
        border-collapse: collapse;
        height: 26px; /* 칸 높이 */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1em;
        color: #333;
        margin-left: -1px; /* 테두리 겹침 처리 */
        margin-top: -1px;
    }
    
    /* 인쇄 모드일 때 스타일 강제 적용 */
    @media print {
        body.printing-section2 .rest-worker-container {
            border: 1px solid #000 !important;
            margin-top: 10px;
        }
        body.printing-section2 .rest-worker-title {
            background-color: #ddd !important;
            -webkit-print-color-adjust: exact;
            color: #000 !important;
            border-right: 1px solid #000 !important;
        }
        body.printing-section2 .rest-worker-cell {
            border: 1px solid #000 !important;
            color: #000 !important;
        }
    }
/* [Section 2] 휴무자 명단 수정 모드 스타일 (추가됨) */
    .rest-worker-cell {
        cursor: pointer; /* 클릭 가능하다는 손가락 표시 */
        position: relative;
    }
    .rest-worker-cell:hover {
        background-color: #eaf4ff; /* 마우스 올렸을 때 살짝 색상 변경 */
    }
    /* 수정할 때 나오는 입력창 */
    .rest-worker-input {
        width: 100%;
        height: 100%;
        border: 2px solid #007bff;
        text-align: center;
        font-size: 1em;
        box-sizing: border-box;
        display: none; /* 평소에는 숨김 */
        position: absolute;
        top: 0; 
        left: 0;
        z-index: 10;
    }
    /* 수정 모드일 때 입력창 보이기 */
    .rest-worker-cell.edit-mode .rest-worker-input {
        display: block;
    }
    /* 수정 모드일 때 기존 글자 숨기기 */
    .rest-worker-cell.edit-mode span {
        visibility: hidden;
    }
/* [Section 2] 휴무자(오전/오후) 셀 수정 모드 스타일 (추가됨) */
    .s2-holiday-cell {
        cursor: pointer; /* 클릭 가능 표시 */
        position: relative;
    }
    .s2-holiday-cell:hover {
        background-color: #fff3cd; /* 마우스 올렸을 때 살짝 노란색 */
    }
    .holiday-worker-input {
        width: 100%;
        height: 100%;
        border: 2px solid #ffc107; /* 강조색 */
        text-align: center;
        font-size: 1em;
        box-sizing: border-box;
        display: none; /* 평소엔 숨김 */
        position: absolute;
        top: 0; 
        left: 0;
        z-index: 10;
    }
    .s2-holiday-cell.edit-mode .holiday-worker-input {
        display: block; /* 수정 모드일 때 보임 */
    }
    .s2-holiday-cell.edit-mode span {
        visibility: hidden; /* 기존 글자 숨김 */
    }
bindEventListeners() {
        // [수정 1] 월 입력창의 min/max 속성을 제거하여 13월이나 0월 입력을 허용하게 함 (그래야 자동 변환 가능)
        if (this.ui.monthInput) {
            this.ui.monthInput.removeAttribute('max');
            this.ui.monthInput.removeAttribute('min');
            
            // [수정 2] 월 변경 시 년도 자동 계산 로직 추가
            this.ui.monthInput.onchange = () => {
                let year = parseInt(this.ui.yearInput.value) || 2025;
                let month = parseInt(this.ui.monthInput.value) || 1;

                if (month > 12) {
                    // 12월을 넘어가면 내년 1월로
                    this.ui.yearInput.value = year + 1;
                    this.ui.monthInput.value = 1;
                } else if (month < 1) {
                    // 1월 밑으로 내려가면 작년 12월로
                    this.ui.yearInput.value = year - 1;
                    this.ui.monthInput.value = 12;
                }
            };
        }

        document.getElementById('s1-addOrUpdateRoute').onclick = () => this.addOrUpdateRoute();
        document.getElementById('s1-deleteRoute').onclick = () => this.deleteRoute();
        this.ui.routeNavigateSelect.onchange = (e) => this.handleRouteSelectChange(e.target.value);
        document.getElementById('s1-generateSchedule').onclick = () => this.generateSchedule();
        document.getElementById('s1-printPage').onclick = () => this.printPage();
        this.ui.fontSizeInput.onchange = (e) => this.applyFontSize(e.target.value + 'pt');
        this.ui.scheduleActionsSelect.onchange = () => this.handleScheduleActions();
        this.ui.restoreFile.onchange = (e) => { if (e.target.files.length > 0) this.restoreScheduleData(e.target.files[0]); };
        document.getElementById('s1-calculateWorkdays').onclick = () => this.calculateWorkdays();
        this.ui.workTypeSelect.onchange = () => this.handleWorkTypeChange();
        this.ui.vehicleCountInput.onchange = (e) => this.handleVehicleCountChange(e.target.value);
        document.getElementById('s1-saveRouteConfig').onclick = () => this.saveRouteConfig();
        document.getElementById('s1-showS2').onclick = () => this.showSection('S2');
        document.getElementById('s1-showS3').onclick = () => this.showSection('S3');
        document.addEventListener('click', (e) => {
            this.clearEditMode(e);
            if (e.target.closest('#scheduleBody td') && !e.target.closest('.edit-mode')) { this.checkAndShowFirstEntryGuide(); }
        });
    },


/* ================================================================= */
    /* [1단계 적용] 콘트롤 박스 축소 & 실행 취소 버튼 스타일 */
    /* ================================================================= */
    
    /* 1. 콘트롤 박스 1/2 크기 축소 (Compact Mode) */
    #section1 .controls {
        padding: 5px !important;
        gap: 5px !important;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)) !important;
    }
    #section1 .controls fieldset {
        padding: 3px 6px !important;
        gap: 3px !important;
        min-width: auto !important;
    }
    #section1 .controls fieldset legend {
        font-size: 0.9em !important;
        padding: 1px 4px !important;
        margin-bottom: 2px !important;
    }
    #section1 .controls input[type="text"],
    #section1 .controls input[type="number"],
    #section1 .controls select {
        padding: 1px 2px !important;
        font-size: 12px !important;
        height: 22px !important;
    }
    #section1 .controls label {
        font-size: 12px !important;
        margin-right: 3px !important;
    }
    #section1 .controls button,
    #section1 .controls select.action-select,
    #section1 .controls select.work-type-select,
    #section1 .controls select.vehicle-select,
    #section1 .controls select.route-navigate-select {
        padding: 2px 6px !important;
        font-size: 12px !important;
        height: 26px !important;
        line-height: 1 !important;
    }
    #section1 #vehicleInputsContainer {
        padding: 2px !important;
        gap: 2px !important;
        max-height: 100px !important;
    }
    #section1 #vehicleInputsContainer input {
        width: 60px !important;
        font-size: 11px !important;
        padding: 1px !important;
        height: 20px !important;
    }
    #section1 .controls .control-group {
        margin-bottom: 2px !important;
        gap: 4px !important;
    }

    /* 2. 실행 취소/다시 실행 버튼 스타일 */
    .history-bar {
        background-color: #f1f3f5;
        border: 1px solid #ced4da;
        border-radius: 6px;
        padding: 6px 10px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .history-btn {
        padding: 6px 12px;
        font-size: 13px;
        font-weight: bold;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s;
    }
    .btn-undo { background-color: #6c757d; color: white; }
    .btn-undo:hover:not(:disabled) { background-color: #5a6268; }
    .btn-redo { background-color: #17a2b8; color: white; }
    .btn-redo:hover:not(:disabled) { background-color: #138496; }
    .history-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background-color: #adb5bd;
    }
    </style>
</head>
<body>
<div id="header-bar">
        <img id="header-logo" src="https://raw.githubusercontent.com/waryong2025/dasomsoftec/main/dasom.png" alt="DasomSoftec">
        <span id="version-display">Ver 5.6.5</span> </div>
<div id="section1">
        <div class="controls">

            <fieldset>
                <legend>회사 / 노선 정보</legend>
        
                <div class="control-group">
                   <label for="companyInput">회사명:</label>
                    <input type="text" id="companyInput" placeholder="예: 와룡운수">
                </div>

                <div class="control-group">
                  <label for="typeSelect">버스 종류 선택:</label>
                       <select id="typeSelect">
                        <option value="마을">마을</option>
                        <option value="버스">버스</option>
                    </select>
                </div>
  
                <div class="control-group">
                    <label for="routeInput">노선 번호:</label>
                    <input type="text" id="routeInput" placeholder="예: 종로08">
                    <button id="s1-addOrUpdateRoute">노선 추가/수정</button>
                    <button id="s1-deleteRoute" class="btn-danger">선택 노선 삭제</button>
                </div>
                
                <div class="control-group">
                    <label for="routeNavigateSelect">관련 노선 이동:</label>
                   <select id="routeNavigateSelect" class="route-navigate-select"></select>
                </div>

             </fieldset>

            <fieldset>
                <legend>조회 설정</legend>
                <div class="control-group">
                    <label for="yearInput">년도:</label>
                     <input type="number" id="yearInput" value="2025">
                    <label for="monthInput">월:</label>
                    <input type="number" id="monthInput" value="10" min="1" max="12">
                    
                    <button id="s1-generateSchedule">생성</button>
                </div>
                 <div class="control-group">
                    <input type="radio" id="option1" name="displayOption" value="1">
                    <label for="option1">1일 ~ 15일</label>
                   
                    <input type="radio" id="option2" name="displayOption" value="2" checked>
                    <label for="option2">16일 ~ 말일</label>
                </div>
                <div class="control-group holiday-option-group">
                    <label for="holidaySelect">법정휴무일:</label>
                    <select id="holidaySelect">
                         <option value="apply">적용</option>
                        <option value="ignore">미적용</option>
                    </select>
                </div>
       
                <div class="control-group" style="border-top: 1px solid #dee2e6; padding-top: 10px; margin-top: 5px;">
                    <button id="s1-printPage">인쇄</button>
                    
                    <div style="display: flex; flex-direction: row; gap: 10px; margin-left: 5px; align-items: flex-start; flex-grow: 1;">

                        <div style="display: flex; flex-direction: column; gap: 4px; align-items: stretch; padding: 2px 5px; border: 1px solid #ced4da; border-radius: 4px; background-color: #f8f9fa; flex-shrink: 0;">
                            
                            <div style="display: flex; align-items: center; gap: 2px; font-size: 0.9em; justify-content: space-between;">
                                <label for="marginLeftSelect">좌측:</label>
                                <select id="marginLeftSelect" class="margin-select">
                                    <option value="0">0</option><option value="10" selected>10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option>
                                </select>
                            </div>
    
                            <div style="display: flex; align-items: center; gap: 2px; font-size: 0.9em; justify-content: space-between;">
                                <label for="marginRightSelect">우측:</label>
                                <select id="marginRightSelect" class="margin-select">
                                    <option value="0">0</option><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option>
                                </select>
                            </div>
                        </div>
 
                        <div style="display: flex; align-items: center; gap: 3px; font-size: 0.9em; padding: 2px 5px; background-color: #eaf4ff; border-radius: 4px; border: 1px solid #b3d7ff; flex-grow: 1; white-space: nowrap;">
                           <label for="fontSizeInput" style="font-weight: bold;">글자크기조정:</label>
                           <select id="fontSizeInput" class="margin-select" style="width: 45px; padding: 1px 3px; box-sizing: border-box; font-weight: bold;">
                                <option value="8">8pt</option>
                                <option value="9">9pt</option>
                                <option value="10">10pt</option>
                                <option value="11" selected>11pt</option>
                                <option value="12">12pt</option>
                                <option value="13">13pt</option>
                                <option value="14">14pt</option>
                            </select>
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>차량 설정 (현재 노선)</legend>
                
                <div class="control-group" style="display: flex; flex-direction: row; align-items: center; flex-wrap: nowrap; gap: 5px;">
                    
                    <label for="vehicleCountInput" style="margin-right: 0; white-space: nowrap;">차량 수:</label>
                    
                    <input type="number" id="vehicleCountInput" value="11" min="1" max="50" 
                           style="width: 50px; text-align: center; padding: 5px; margin: 0;">
                    
                    <div style="display: flex; flex-direction: column; justify-content: center; margin-right: 5px;">
                        <button type="button" onclick="document.getElementById('vehicleCountInput').stepUp(); document.getElementById('vehicleCountInput').dispatchEvent(new Event('change'));" 
                                style="font-size: 9px; padding: 0 4px; border: 1px solid #ccc; background: #fff; cursor: pointer; line-height: 1; margin-bottom: 1px; text-align: left; color: #007bff; width: 45px; min-width: 45px; height: auto; box-shadow: none;">
                            ▲증가
                        </button>
                        <button type="button" onclick="document.getElementById('vehicleCountInput').stepDown(); document.getElementById('vehicleCountInput').dispatchEvent(new Event('change'));" 
                                style="font-size: 9px; padding: 0 4px; border: 1px solid #ccc; background: #fff; cursor: pointer; line-height: 1; margin-top: 0; text-align: left; color: #dc3545; width: 45px; min-width: 45px; height: auto; box-shadow: none;">
                            ▼감소
                        </button>
                    </div>

                    <button id="s1-saveRouteConfig" style="white-space: nowrap; margin-left: 0;">
                        차량번호저장
                    </button>
                </div>

                <div class="control-group" style="flex-direction: column; align-items: flex-start; margin-top: 10px;">
                    <label>차량 번호 (총 <span id="vehicleCountDisplay">0</span>대):</label>
                    <div id="vehicleInputsContainer">
                        </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>근무전체데이타관리옵션</legend> 
                <div class="control-group">
                    <select id="scheduleActionsSelect" class="action-select">
                        <option value="">근무전체데이타관리옵션</option> <option value="reset">현재 노선 초기화</option>
                        <option value="backup">전체 데이터 저장</option>
                        <option value="restore">전체 데이터 불러오기</option>
                    </select>
                    <input type="file" id="restoreFile" style="display: none;" accept=".json">
                    <button id="s1-calculateWorkdays">근무일수계산</button>
                </div>
                
                <div class="control-group">
                     <select id="vehicleSelect" class="vehicle-select">
                          <option value="">차량 선택</option>
                     </select>
                    <select id="workTypeSelect" class="work-type-select">
                         <option value="">근무조건 선택</option>
                         <option value="normal">3/3 근무</option>
                         <option value="biweekly">격주 근무</option>
                        <option value="five_day">5일근무</option> 
                    </select>
                </div>

                <div style="border-top: 1px solid #dee2e6; padding-top: 10px; margin-top: 5px;"></div> 
                
                <div class="control-group">
                    <button id="s1-showS2">승무일지 및 배차관리</button>
                    <button id="s1-showS3">차량정비점검일지</button>
                </div>
            </fieldset>
            
        </div>
<div class="history-bar">
            <span style="font-weight:bold; font-size:14px; color:#333;">⚡ 작업 되돌리기:</span>
            <button id="s1-undoBtn" class="history-btn btn-undo" disabled>
                ↩ 실행 취소 (이전으로)
            </button>
            <button id="s1-redoBtn" class="history-btn btn-redo" disabled>
                ↪ 다시 실행 (앞으로)
            </button>
            <span style="font-size:11px; color:#666; margin-left:auto;">* 최근 50단계까지 저장됩니다.</span>
        </div>

        <div id="scheduleContainer">
            <table>
                <caption id="tableCaption">근무 현황표를 생성해주세요.</caption>
                <thead id="scheduleHeader">
                </thead>
               <tbody id="scheduleBody">
                </tbody>
            </table>
        </div>
    </div>

    <hr class="divider">

    <div id="section2" style="display: none;">
        <div class="journal-container">

            <div class="header-title">승무일지</div>
            <div class="title-area">
                <div class="title-left">
                    <div class="main-title">승 무 일 지</div>
                </div>
    
                <div class="options-right">
                    <button type="button" id="s2-showAll" class="print-button" style="background-color: #6c757d;">전체보기</button>
               
                    <div class="font-selector-container">
                        <label for="font-size-select">글자크기조정:</label>
                        <select id="font-size-select">
                             <option value="8">8pt</option>
                            <option value="9">9pt</option> 
                            <option value="10">10pt</option> 
                            <option value="11" selected>11pt</option> 
                            <option value="12">12pt</option>
                            <option value="13">13pt</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 5px;">
                        <button type="button" id="s2-backupLog" class="print-button" style="background-color: #28a745;">일지백업</button>
                        <button type="button" id="s2-showRestoreModal" class="print-button" style="background-color: #fd7e14;">일지복원</button>
                        <input type="file" id="s2_restoreFile" style="display: none;" accept=".json">
                    </div>

                   <button type="button" id="s2-refreshLog" class="print-button" style="background-color: #dc3545;">일지초기화</button>
                   <button id="s2-printPage" class="print-button">인쇄하기</button>
                </div>
            </div>

            <div class="date-navigation-area">
                <div>
                    <button id="s2_prevDate" class="date-nav-btn secondary">◀ 이전</button>
                    <button id="s2_today" class="date-nav-btn today">오늘</button>
                    <button id="s2_nextDate" class="date-nav-btn secondary">다음 ▶</button>
                </div>
                <div>
                    <label for="s2_startDate">기간조회:</label>
                    <input type="date" id="s2_startDate">
                    <span>~</span>
                    <input type="date" id="s2_endDate">
                    <button id="s2_loadRange" class="date-nav-btn">조회</button>
                </div>
            </div>
            <div id="dispatch-log-body">
                </div>
        </div>
    </div>
    <div id="s2_restoreDateModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <h3 style="margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px;">승무일지 불러오기</h3>
            <p>백업한 '.json' 파일을 선택하세요.</p>
            <p style="color: red; font-weight: bold;">S2(승무일지)의 모든 기존 데이터는 덮어쓰여집니다.</p>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button id="s2_cancelRestoreBtn" type="button" style="padding: 10px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">취소</button>
                <button id="s2_confirmRestoreBtn" type="button" style="padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">파일 선택</button>
            </div>
        </div>
    </div>

    <hr class="divider">

    <div id="section3" style="display: none;">
        <div class="maintenance-container">
            <header>
                <h1 id="s3_title" style="flex-basis: 100%; text-align: center; order: -1; margin-bottom: 10px;">
                    차량정비점검일지 및 작업의뢰서
                </h1>
                <div class="controls no-print">
                    <button id="s3-showAll" style="background-color: #6c757d; color: white;">전체보기</button>
                    <button id="s3-backupFile" class="primary">일지백업</button> <input type="file" id="s3_restoreFile" style="display: none;" accept=".json">
                    <button id="s3-triggerRestore" class="warning">일지복구</button> 
                    <button id="s3-showCalculator">모든일지및가격</button>
                    <button id="s3-clearForm">폼초기화</button>
                    <button id="s3-printPage" class="primary">인쇄</button> 
      
                    <div class="margin-control-group no-print">
                        <label>인쇄여백</label>
                        <div class="margin-control">
                            <label for="s3_marginLeft">좌</label>
                            <select id="s3_marginLeft" class="margin-select">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                        <div class="margin-control">
                            <label for="s3_marginRight">우</label>
                            <select id="s3_marginRight" class="margin-select">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                    </div>

                  <div style="display: flex; align-items: center; gap: 5px; font-size: 13pt;">
                        <label for="s3_fontSizeInput">글자크기:</label>
                        <select id="s3_fontSizeInput" style="width: 50px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="8">8pt</option>
                            <option value="9">9pt</option>
                            <option value="10">10pt</option>
                            <option value="11" selected>11pt</option>
                            <option value="12">12pt</option>
                            <option value="13">13pt</option>
                            <option value="14">14pt</option>
                        </select>
                    </div>
                </div>
            </header>

            <form id="maintenanceForm">
            <table class="form-table">
                <colgroup>
                    <col class="route-col">  <col class="item-col">   <col class="detail-col"> <col class="parts-col">  <col class="price-col">  <col class="worker-col"> 
                </colgroup>
                    <thead>
                    <tr>
                        <th class="date-col">년/월/일</th>
                        <th colspan="5" id="s3_dateDisplay">
                            <div id="s3_date_nav_container">
                                <span id="s3_prevDate" class="s3_date_nav_btn no-print">◀ 이전</span>
                                <span id="s3_dateDisplay_text">날짜 로딩 중...</span>
                                <span id="s3_nextDate" class="s3_date_nav_btn no-print">다음 ▶</span>
                                <input type="date" id="s3_datePicker" class="no-print">
                            </div>
                        </th>
                    </tr>
                    <tr>
                        <th class="route-col">노선/차량</th>
                        <th class="item-col">항목</th>
                        <th class="detail-col">정비내역</th>
                        <th class="parts-col">부품내역</th>
                        <th class="price-col">부품가격</th>
                        <th class="worker-col">작업자</th>
                    </tr>
                    </thead>
                    <tbody>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_1"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_1" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_1" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_1" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_1" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_1" class="price-input" /></div></td>
                            <td><textarea name="worker_1_1" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_2"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_2" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_2" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_2" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_2" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_2" class="price-input" /></div></td>
                            <td><textarea name="worker_1_2" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_3"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_3" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_3" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_3" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_3" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_3" class="price-input" /></div></td>
                            <td><textarea name="worker_1_3" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_4"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_4" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_4" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_4" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_4" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_4" class="price-input" /></div></td>
                            <td><textarea name="worker_1_4" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_5"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_5" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_5" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_5" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_5" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_5" class="price-input" /></div></td>
                            <td><textarea name="worker_1_5" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_6"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_6" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_6" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_6" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_6" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_6" class="price-input" /></div></td>
                            <td><textarea name="worker_1_6" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_1"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_1" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_1" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_1" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_1" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_1" class="price-input" /></div></td>
                            <td><textarea name="worker_2_1" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_2"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_2" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_2" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_2" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_2" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_2" class="price-input" /></div></td>
                            <td><textarea name="worker_2_2" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_3"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_3" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_3" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_3" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_3" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_3" class="price-input" /></div></td>
                            <td><textarea name="worker_2_3" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_4"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_4" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_4" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_4" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_4" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_4" class="price-input" /></div></td>
                            <td><textarea name="worker_2_4" class="auto-resize"></textarea></td>
                        </tr>
                    </tbody>
                    <tfoot class="no-print">
                    <tr>
                            <td colspan="6" style="text-align: right; padding: 5px;">
                                <button type="button" id="s3-addRow" style="font-size: 11pt; padding: 4px 8px; background-color: #007bff; color: white; border: none;">
                                    행 추가 (+)
                                </button>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </form>

            <p class="thin-text" style="margin-top:8px">사용법: 셀에 내용을 입력한 뒤 'PDF로 저장 / 인쇄' 버튼을 눌러 A4로 저장하세요. 모바일에서는 가로 모드에서 인쇄 결과가 더 잘 맞을 수 있습니다.</p>
        </div>
    </div>

      <div id="s3_calculatorModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <h3 style="margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px;">모든일지및가격</h3>
            <p>기간을 설정하고 모든 일지 내역과 부품 가격 합계를 확인합니다.</p>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                <label>시작일:</label><input type="date" id="s3_startDate" style="flex-grow: 1; padding: 8px;">
                <label>종료일:</label><input type="date" id="s3_endDate" style="flex-grow: 1; padding: 8px;">
                <button id="s3-calculatePrices" style="padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px;">조회</button>
            </div>

            <div style="padding: 10px; border: 1px solid #ddd; background-color: #f8f9fa;">
                <strong>총 부품가격 합계: <span id="s3_totalPrice" style="color: #dc3545;">0원</span></strong>
            </div>
            <p style="font-size: 0.9em; color: #555;">'조회' 버튼을 누르면 합계가 계산되고, 상세 내역은 새 창으로 열립니다.</p>

            <div style="text-align: right; margin-top: 20px;">
                <button id="s3-closeCalculator" style="padding: 10px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">닫기</button>
            </div>
        </div>
    </div>
    
    <div id="s2_timeSettingModal" style="display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 300px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
            <h3 style="margin-top: 0; text-align: center; color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 10px;">
                시간 및 배차간격 설정
            </h3>
            <p id="s2_timeModal_info" style="text-align: center; font-weight: bold; font-size: 0.9em; color: #555; margin-bottom: 15px;">
                차량 정보 로딩 중...
            </p>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div style="display: flex; gap: 5px; align-items: center;">
                    <label style="width: 50px; font-weight: bold;">시간:</label>
                    <input type="number" id="s2_modal_hour" placeholder="시" style="flex: 1; padding: 8px; text-align: center;" min="0" max="23">
                    <span>:</span>
                    <input type="number" id="s2_modal_minute" placeholder="분" style="flex: 1; padding: 8px; text-align: center;" min="0" max="59">
                </div>
                
                <div style="display: flex; gap: 5px; align-items: center;">
                    <label style="width: 50px; font-weight: bold;">간격:</label>
                    <input type="number" id="s2_modal_interval" placeholder="분 (0이면 현재만 수정)" style="flex: 1; padding: 8px; text-align: center;" min="0">
                </div>
            </div>

            <div style="margin-top: 20px; display: flex; justify-content: space-between; gap: 10px;">
                <button id="s2_modal_cancel" style="flex: 1; padding: 10px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">취소</button>
                <button id="s2_modal_apply" style="flex: 1; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">적용</button>
            </div>
            <p style="font-size: 0.8em; color: #888; margin-top: 10px; text-align: center;">
                * 간격을 입력하면 이후 차량 시간도 자동 계산됩니다.
            </p>
        </div>
    </div>
    
<script>

/* ================================================================= */
/* [공통] 통합 관리자 (DataManager) */
/* ================================================================= */

const DataManager = {
    MASTER_KEY: 'busScheduleManagerData', 
    S2_LOG_KEY: 'busDispatchLogData',     
    S3_LOG_KEY: 'busMaintenanceLogData',  
    
    data: {
        s1: { currentRoute: null, routes: {} },
        s2: {},
        s3: {}
    },

    listeners: [],

    dispatch(event, payload) {
        this.listeners.forEach(listener => {
            if (typeof listener.onDataChanged === 'function') {
                listener.onDataChanged(event, payload);
            }
        });
    },

    subscribe(module) {
        this.listeners.push(module);
    },

    saveToStorage(key, value) {
        try {
            localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
            console.error(`저장 실패: ${key}`, e);
        }
    },
    loadFromStorage(key) {
        const data = localStorage.getItem(key);
        try { return JSON.parse(data); } catch { return null; }
    },
    
    // UTC가 아닌 로컬 시간 기준으로 날짜 문자열 반환 (날짜 밀림 방지)
    getTodayDateString(dateObj = new Date()) {
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    },
    
    loadS1Data() {
        let storedData = this.loadFromStorage(this.MASTER_KEY);
        if (!storedData || !storedData.routes) {
            storedData = { currentRoute: null, routes: {} };
        }
        if (!storedData.currentRoute || !storedData.routes[storedData.currentRoute]) {
            storedData.currentRoute = Object.keys(storedData.routes)[0] || null;
        }
        this.data.s1 = storedData;
        return this.data.s1;
    },
    saveS1Data() {
        this.saveToStorage(this.MASTER_KEY, this.data.s1);
        this.dispatch('s1_data_changed', this.data.s1);
    },
    updateS1Data(updaterFunction) {
        updaterFunction(this.data.s1);
        this.saveS1Data();
    },
    getCurrentRouteData() {
        const routeName = this.data.s1.currentRoute;
        if (!routeName) return { routeName: null, routeData: null };
        return { routeName, routeData: this.data.s1.routes[routeName] };
    },
    getAllRoutes() { return this.data.s1.routes || {}; },
    setCurrentRoute(routeName) {
        this.data.s1.currentRoute = routeName;
        this.saveS1Data();
    },

    loadS2Data() {
        const storedData = this.loadFromStorage(this.S2_LOG_KEY);
        this.data.s2 = storedData || {};
        return this.data.s2;
    },
    saveS2Data() {
        this.saveToStorage(this.S2_LOG_KEY, this.data.s2);
        this.dispatch('s2_data_changed', this.data.s2); 
    },
    updateS2Data(updaterFunction) {
        updaterFunction(this.data.s2);
        this.saveS2Data();
    },
    getS2RouteSettings(routeName) {
        const s2_route_data = this.data.s2[routeName] || {};
        return Object.assign({
            dispatchType: 'manual', cycle: 'manual', baseOrder: [],
            am_startVehicle: "", am_hour: "", am_minute: "", am_interval: "",
            pm_startVehicle: "", pm_hour: "", pm_minute: "", pm_interval: ""
        }, s2_route_data._settings);
    },
    getS2LogByDate(dateString) { return this.data.s2[dateString] || {}; },

    loadS3Data() {
        const storedData = this.loadFromStorage(this.S3_LOG_KEY);
        this.data.s3 = storedData || {};
        return this.data.s3;
    },
    saveS3Data() { this.saveToStorage(this.S3_LOG_KEY, this.data.s3); },
    updateS3Data(updaterFunction) { updaterFunction(this.data.s3); this.saveS3Data(); }
};

/* ================================================================= */
/* [Section 1] 근무 현황표 JavaScript (월요일 자동 변경 제거) */
/* ================================================================= */

const S1_Module = {
    state: {
        currentRoute: null,
        currentVehicleColumns: [],
        fixedScheduleData: {},
        tempScheduleData: {},
        workTypeConfig: {},
        scheduleData: {},
        hasShownGuide: false,
        
        autoFillChainStartDate: null,
        pendingSourceDate: null,
        pendingTargetDate: null,
        autoFillStopFlag: false, 
        
        lastFocusedInput: 'both', 
        pendingRetireeSwap: null,
        pendingSwapInfo: null,
        dragSrcEl: null,
        undoStack: [],
        redoStack: [],
        maxHistory: 20 
    },
    ui: {},
    
    // [기능] 스냅샷 및 실행 취소
    saveSnapshot() {
        const currentState = JSON.stringify(DataManager.data.s1);
        this.state.undoStack.push(currentState);
        if (this.state.undoStack.length > this.state.maxHistory) this.state.undoStack.shift();
        this.state.redoStack = [];
        this.updateHistoryButtons();
    },
    performUndo() {
        if (this.state.undoStack.length === 0) return;
        this.state.redoStack.push(JSON.stringify(DataManager.data.s1));
        const prevState = JSON.parse(this.state.undoStack.pop());
        DataManager.updateS1Data(s1_data => { s1_data.routes = prevState.routes; s1_data.currentRoute = prevState.currentRoute; });
        this.state.currentRoute = prevState.currentRoute;
        this.loadRouteData(this.state.currentRoute, true); 
        this.updateHistoryButtons();
    },
    performRedo() {
        if (this.state.redoStack.length === 0) return;
        this.state.undoStack.push(JSON.stringify(DataManager.data.s1));
        const nextState = JSON.parse(this.state.redoStack.pop());
        DataManager.updateS1Data(s1_data => { s1_data.routes = nextState.routes; s1_data.currentRoute = nextState.currentRoute; });
        this.state.currentRoute = nextState.currentRoute;
        this.loadRouteData(this.state.currentRoute, true);
        this.updateHistoryButtons();
    },
    updateHistoryButtons() {
        const undoBtn = document.getElementById('s1-undoBtn');
        const redoBtn = document.getElementById('s1-redoBtn');
        if (undoBtn) undoBtn.disabled = (this.state.undoStack.length === 0);
        if (redoBtn) redoBtn.disabled = (this.state.redoStack.length === 0);
    },
    
    // [헬퍼] 날짜 및 유틸리티
    calculateWeekDiff(anchorDateStr, currentDateStr) {
        const [y1, m1, d1] = anchorDateStr.split('-').map(Number);
        const [y2, m2, d2] = currentDateStr.split('-').map(Number);
        const utc1 = Date.UTC(y1, m1 - 1, d1);
        const utc2 = Date.UTC(y2, m2 - 1, d2);
        return Math.floor(Math.floor((utc2 - utc1) / (1000 * 60 * 60 * 24)) / 7);
    },
    getLocalYMD(dateObj) {
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    },
    getNextDayOfWeek(startDateStr, targetDayOfWeek) {
        const d = new Date(startDateStr);
        const currentDay = d.getDay();
        let diff = targetDayOfWeek - currentDay;
        if (diff < 0) diff += 7; 
        d.setDate(d.getDate() + diff);
        return this.getLocalYMD(d);
    },
    isValidVehicleNumber(str) { return !(!str || !/^\d+$/.test(str.trim())); },

    updateLocalScheduleData(dateString, colId, names) {
        if (!this.state.scheduleData[dateString]) this.state.scheduleData[dateString] = {};
        this.state.scheduleData[dateString][colId] = names;
    },
    refreshSingleCell(cell, colId, dateString, names) {
        cell.classList.remove('edit-mode');
        cell.innerHTML = this.renderCellContent(names);
    },

    getFixedOwner(dateString, colId) {
        const routeData = DataManager.data.s1.routes[this.state.currentRoute];
        if (!routeData) return { am: '', pm: '' };

        const targetDate = new Date(dateString);
        const dayOfWeek = targetDate.getDay();
        const recurringKey = `${dayOfWeek}-${colId}`;
        
        let fixedAm = '';
        let fixedPm = '';

        if (routeData.fixedSchedule && routeData.fixedSchedule[recurringKey]) {
            let anchorEntry = null;
            for (const entry of routeData.fixedSchedule[recurringKey]) {
                if (new Date(dateString) >= new Date(entry.dateString)) {
                    anchorEntry = entry;
                    break;
                }
            }

            if (anchorEntry) {
                let names = anchorEntry.names;
                // [수정] 기본값 'normal' -> 'biweekly'로 변경
                const workType = routeData.workTypeConfig[colId] || 'biweekly';
                if (workType === 'biweekly' && dayOfWeek !== 0) { 
                    const weekDiff = this.calculateWeekDiff(anchorEntry.dateString, dateString);
                    if (weekDiff % 2 === 1) {
                        names = [anchorEntry.names[1], anchorEntry.names[0]];
                    }
                }
                fixedAm = (names[0].text || '').trim();
                fixedPm = (names[1].text || '').trim();
            }
        }
        return { am: fixedAm, pm: fixedPm };
    },

    initialize() {
        console.log("S1: 초기화 (기본 격주 설정)");
        this.ui = {
            companyInput: document.getElementById('companyInput'),
            typeSelect: document.getElementById('typeSelect'),
            routeInput: document.getElementById('routeInput'),
            routeNavigateSelect: document.getElementById('routeNavigateSelect'),
            yearInput: document.getElementById('yearInput'),
            monthInput: document.getElementById('monthInput'),
            holidaySelect: document.getElementById('holidaySelect'),
            marginLeftSelect: document.getElementById('marginLeftSelect'),
            marginRightSelect: document.getElementById('marginRightSelect'),
            fontSizeInput: document.getElementById('fontSizeInput'),
            scheduleActionsSelect: document.getElementById('scheduleActionsSelect'),
            restoreFile: document.getElementById('restoreFile'),
            vehicleSelect: document.getElementById('vehicleSelect'),
            workTypeSelect: document.getElementById('workTypeSelect'),
            vehicleCountInput: document.getElementById('vehicleCountInput'),
            vehicleCountDisplay: document.getElementById('vehicleCountDisplay'),
            vehicleInputsContainer: document.getElementById('vehicleInputsContainer'),
            scheduleContainer: document.getElementById('scheduleContainer')
        };
        const today = new Date();
        this.ui.yearInput.value = today.getFullYear();
        this.ui.monthInput.value = today.getMonth() + 1;
        const currentDay = today.getDate();
        if (currentDay <= 15) document.getElementById('option1').checked = true;
        else document.getElementById('option2').checked = true;
        
        // [수정] 근무 형태 선택 기본값을 'biweekly'로 설정
        if (this.ui.workTypeSelect) {
            this.ui.workTypeSelect.value = 'biweekly';
        }

        this.injectModals(); 
        const s1_data = DataManager.loadS1Data();
        this.state.currentRoute = s1_data.currentRoute;
        
        const undoBtn = document.getElementById('s1-undoBtn');
        const redoBtn = document.getElementById('s1-redoBtn');
        if(undoBtn) undoBtn.onclick = () => this.performUndo();
        if(redoBtn) redoBtn.onclick = () => this.performRedo();

        this.bindEventListeners();
        this.populateRouteSelect();
        this.loadRouteData(this.state.currentRoute);
        DataManager.subscribe(this);
    },

    injectModals() {
        if (!document.getElementById('s1-guide-modal')) {
            const guideModalHTML = `<div id="s1-guide-modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);"><div style="background-color:#fff; margin:15% auto; padding:20px; border:1px solid #888; width:80%; max-width:500px; border-radius:8px; text-align:center; box-shadow: 0 4px 8px rgba(0,0,0,0.2);"><h3 style="color:#0056b3; margin-top:0;">📋 근무표 작성 가이드</h3><p style="text-align:left; line-height:1.6; font-size:15px;">차량 번호를 입력하거나 <strong>칸을 드래그해서 위치를 바꿀 수 있습니다.</strong><br>첫 입력시 모든 직원들의 차량번호에 근무자를 채워주세요.</p><button id="s1-close-guide" style="background-color:#007bff; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-weight:bold; margin-top:10px;">확인</button></div></div>`;
            document.body.insertAdjacentHTML('beforeend', guideModalHTML);
        }
        if (!document.getElementById('s1-autofill-modal')) {
            const autofillModalHTML = `<div id="s1-autofill-modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);"><div style="background-color:#fff; margin:15% auto; padding:25px; border:1px solid #888; width:90%; max-width:400px; border-radius:10px; text-align:center; box-shadow: 0 4px 15px rgba(0,0,0,0.3);"><h3 style="color:#28a745; margin-top:0; font-size:1.4em;">⚡ 근무자 자동 생성</h3><div id="s1-autofill-msg" style="font-size:1.1em; line-height:1.6; margin:20px 0; word-break: keep-all;"></div><div style="display:flex; justify-content:center; gap:10px;"><button id="s1-confirm-autofill" style="background-color:#28a745; color:white; border:none; padding:12px 20px; border-radius:5px; cursor:pointer; font-size:1em; font-weight:bold;">예 (자동생성)</button><button id="s1-cancel-autofill" style="background-color:#6c757d; color:white; border:none; padding:12px 20px; border-radius:5px; cursor:pointer; font-size:1em;">아니오</button></div></div></div>`;
            document.body.insertAdjacentHTML('beforeend', autofillModalHTML);
        }
        if (!document.getElementById('s1-swap-modal')) {
            const swapModalHTML = `<div id="s1-swap-modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);"><div style="background-color:#fff; margin:20% auto; padding:25px; border:1px solid #888; width:90%; max-width:350px; border-radius:10px; text-align:center; box-shadow: 0 4px 15px rgba(0,0,0,0.3);"><div id="s1-swap-msg-content"></div><div style="display:flex; justify-content:center; gap:10px; margin-top:20px;"><button id="s1-confirm-swap" style="background-color:#007bff; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-size:1em; font-weight:bold;">예</button><button id="s1-cancel-swap" style="background-color:#6c757d; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-size:1em;">아니오</button></div></div></div>`;
            document.body.insertAdjacentHTML('beforeend', swapModalHTML);
        }
        if (!document.getElementById('s1-retiree-modal')) {
            const retireeModalHTML = `<div id="s1-retiree-modal" style="display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);"><div style="background-color:#fff; margin:15% auto; padding:20px; border:1px solid #888; width:300px; border-radius:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);"><h3 style="color:#d9534f; margin-top:0; text-align:center;">퇴직자 근무자 교체</h3><p id="s1-retiree-msg" style="text-align:center; font-size:0.95em;">대체할 근무자 이름을 입력하세요.</p><input type="text" id="s1-retiree-input" style="width:100%; padding:8px; margin:10px 0; border:1px solid #ccc; border-radius:4px; text-align:center;" placeholder="대체 근무자 이름"><div style="display:flex; justify-content:center; gap:10px; margin-top:10px;"><button id="s1-confirm-retiree" style="background-color:#d9534f; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; font-weight:bold;">교체 및 적용</button><button id="s1-cancel-retiree" style="background-color:#6c757d; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">취소</button></div></div></div>`;
            document.body.insertAdjacentHTML('beforeend', retireeModalHTML);
        }
        const guideClose = document.getElementById('s1-close-guide');
        if (guideClose) guideClose.onclick = () => document.getElementById('s1-guide-modal').style.display = 'none';
        const autoFillCancel = document.getElementById('s1-cancel-autofill');
        if (autoFillCancel) {
            autoFillCancel.onclick = () => {
                document.getElementById('s1-autofill-modal').style.display = 'none';
                this.state.pendingSourceDate = null;
                this.state.pendingTargetDate = null;
                this.state.autoFillStopFlag = true;
            };
        }
        const autoFillConfirm = document.getElementById('s1-confirm-autofill');
        if (autoFillConfirm) { autoFillConfirm.onclick = () => this.executeCopyNextDay(); }
        const swapConfirm = document.getElementById('s1-confirm-swap');
        const swapCancel = document.getElementById('s1-cancel-swap');
        if (swapConfirm) swapConfirm.onclick = () => this.executeFutureSwap(true);
        if (swapCancel) swapCancel.onclick = () => this.executeFutureSwap(false);
        const retireeConfirm = document.getElementById('s1-confirm-retiree');
        const retireeCancel = document.getElementById('s1-cancel-retiree');
        if (retireeConfirm) retireeConfirm.onclick = () => this.confirmRetireeChange();
        if (retireeCancel) retireeCancel.onclick = () => this.closeRetireeModal();
    },

    onDataChanged(event, payload) { if (event === 's1_data_changed') { this.state.currentRoute = payload.currentRoute; this.populateRouteSelect(); this.loadRouteData(this.state.currentRoute, true); } },
    
    bindEventListeners() {
        if (this.ui.monthInput) {
            this.ui.monthInput.removeAttribute('max');
            this.ui.monthInput.removeAttribute('min');
            this.ui.monthInput.onchange = () => {
                let year = parseInt(this.ui.yearInput.value) || 2025;
                let month = parseInt(this.ui.monthInput.value) || 1;
                if (month > 12) {
                    this.ui.yearInput.value = year + 1;
                    this.ui.monthInput.value = 1;
                } else if (month < 1) {
                    this.ui.yearInput.value = year - 1;
                    this.ui.monthInput.value = 12;
                }
            };
        }
        
        document.getElementById('s1-addOrUpdateRoute').onclick = () => this.addOrUpdateRoute();
        document.getElementById('s1-deleteRoute').onclick = () => this.deleteRoute();
        this.ui.routeNavigateSelect.onchange = (e) => this.handleRouteSelectChange(e.target.value);
        document.getElementById('s1-generateSchedule').onclick = () => this.generateSchedule();
        document.getElementById('s1-printPage').onclick = () => this.printPage();
        this.ui.fontSizeInput.onchange = (e) => this.applyFontSize(e.target.value + 'pt');
        this.ui.scheduleActionsSelect.onchange = () => this.handleScheduleActions();
        this.ui.restoreFile.onchange = (e) => { if (e.target.files.length > 0) this.restoreScheduleData(e.target.files[0]); };
        document.getElementById('s1-calculateWorkdays').onclick = () => this.calculateWorkdays();
        this.ui.workTypeSelect.onchange = () => this.handleWorkTypeChange();
        this.ui.vehicleCountInput.onchange = (e) => this.handleVehicleCountChange(e.target.value);
        document.getElementById('s1-saveRouteConfig').onclick = () => this.saveRouteConfig();
        document.getElementById('s1-showS2').onclick = () => this.showSection('S2');
        document.getElementById('s1-showS3').onclick = () => this.showSection('S3');
        document.addEventListener('click', (e) => {
            this.clearEditMode(e);
            if (e.target.closest('#scheduleBody td') && !e.target.closest('.edit-mode')) { this.checkAndShowFirstEntryGuide(); }
        });
    },

    checkAndShowFirstEntryGuide() { if (this.state.hasShownGuide) return; const isEmpty = Object.keys(this.state.fixedScheduleData).length === 0 && Object.keys(this.state.tempScheduleData).length === 0; if (isEmpty) { document.getElementById('s1-guide-modal').style.display = 'block'; this.state.hasShownGuide = true; } },
    populateRouteSelect() {
        const { routes } = DataManager.data.s1; const routeSelect = this.ui.routeNavigateSelect; routeSelect.innerHTML = ''; const routeNames = Object.keys(routes);
        if (routeNames.length === 0) { routeSelect.innerHTML = '<option value="">노선을 추가하세요</option>'; return; }
        const defaultOption = document.createElement('option'); defaultOption.value = ''; defaultOption.textContent = '--- 노선 이동 ---'; routeSelect.appendChild(defaultOption);
        routeNames.forEach(name => { const option = document.createElement('option'); option.value = name; option.textContent = name; if (name === this.state.currentRoute) option.selected = true; routeSelect.appendChild(option); });
    },
    
    renderVehicleInputs(count, dataProvider) {
        this.ui.vehicleCountDisplay.textContent = count; 
        const container = this.ui.vehicleInputsContainer; 
        container.innerHTML = ''; 
        container.style.flexDirection = 'row'; 
        container.style.alignItems = 'unset'; 
        
        for (let i = 0; i < count; i++) {
            const input = document.createElement('input'); 
            input.type = 'text'; 
            input.autocomplete = "off";
            input.draggable = true; 
            input.style.cursor = 'move'; 
            const val = dataProvider(i);
            if (val && val !== '미입력') input.value = val; else input.value = '';
            input.placeholder = `차량 ${i + 1}`; 
            input.dataset.prevValue = input.value.trim();
            input.onfocus = (e) => { e.target.select(); if (e.target.dataset.prevValue === undefined) e.target.dataset.prevValue = e.target.value; };
            input.onchange = (e) => this.handleVehicleInputChange(e.target);
            input.addEventListener('dragstart', (e) => this.handleDragStart(e));
            input.addEventListener('dragover', (e) => this.handleDragOver(e));
            input.addEventListener('drop', (e) => this.handleDrop(e));
            container.appendChild(input);
        }
    },

    handleDragStart(e) { this.state.dragSrcEl = e.target; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', e.target.value); e.target.style.opacity = '0.4'; },
    handleDragOver(e) { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; },
    handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();
        const targetEl = e.target;
        if (this.state.dragSrcEl !== targetEl && targetEl.tagName === 'INPUT') {
            const srcVal = this.state.dragSrcEl.value;
            const tgtVal = targetEl.value;
            this.state.dragSrcEl.value = tgtVal;
            targetEl.value = srcVal;
            this.state.dragSrcEl.dataset.prevValue = tgtVal;
            targetEl.dataset.prevValue = srcVal;
            this.highlightSwap(this.state.dragSrcEl, targetEl);
        }
        if (this.state.dragSrcEl) this.state.dragSrcEl.style.opacity = '1';
        return false;
    },

    loadRouteData(routeName, isRefresh = false) {
        const { routes } = DataManager.data.s1;
        if (!routeName || !routes[routeName]) {
            this.ui.routeInput.value = ''; this.ui.companyInput.value = ''; this.ui.typeSelect.value = '마을'; this.ui.vehicleCountInput.value = 0;
            this.state.fixedScheduleData = {}; this.state.tempScheduleData = {}; this.state.workTypeConfig = {};
            this.state.currentVehicleColumns = []; this.state.currentRoute = null; DataManager.setCurrentRoute(null); this.updateVehicleSelect();
            if (this.ui.routeNavigateSelect) this.ui.routeNavigateSelect.value = ''; this.generateSchedule(); 
            this.renderVehicleInputs(0, () => '');
            return;
        }
        if (!isRefresh) DataManager.setCurrentRoute(routeName);
        this.state.currentRoute = routeName; const routeData = routes[routeName];
        this.state.fixedScheduleData = routeData.fixedSchedule; this.state.tempScheduleData = routeData.tempSchedule;
        this.state.workTypeConfig = routeData.workTypeConfig; this.state.currentVehicleColumns = routeData.vehicleColumns || [];
        this.ui.routeInput.value = routeName; this.ui.companyInput.value = routeData.companyName || ''; this.ui.typeSelect.value = routeData.type || '마을';
        
        const count = this.state.currentVehicleColumns.length;
        this.ui.vehicleCountInput.value = count;
        this.renderVehicleInputs(count, (i) => this.state.currentVehicleColumns[i] || '');
        this.updateVehicleSelect();
        if (this.ui.routeNavigateSelect) this.ui.routeNavigateSelect.value = routeName;
        this.state.hasShownGuide = false; this.state.autoFillChainStartDate = null; this.state.pendingSourceDate = null; this.state.pendingTargetDate = null;
        if (!isRefresh) { this.state.autoFillStopFlag = false; }
        this.generateSchedule();
    },

    handleVehicleCountChange(countStr) {
        const newCount = parseInt(countStr) || 0;
        const currentInputs = Array.from(this.ui.vehicleInputsContainer.querySelectorAll('input'));
        const currentValues = currentInputs.map(inp => inp.value);
        this.renderVehicleInputs(newCount, (i) => currentValues[i] || '');
    },

    addOrUpdateRoute() {
        this.saveSnapshot(); 
        let routeName = this.ui.routeInput.value.trim(); if (!routeName) { alert('노선 번호를 입력하세요.'); return; } if (!routeName.endsWith('번')) routeName += '번'; this.ui.routeInput.value = routeName; const companyName = this.ui.companyInput.value.trim(); const type = this.ui.typeSelect.value;
        DataManager.updateS1Data(s1_data => {
            if (!s1_data.routes[routeName]) {
                const vehicleCount = parseInt(this.ui.vehicleCountInput.value, 10) || 1; const newVehicleColumns = Array.from({ length: vehicleCount }, (_, i) => `차량${i + 1}`); if (newVehicleColumns.length === 0) newVehicleColumns.push('차량1');
                s1_data.routes[routeName] = { companyName: companyName, type: type, vehicleColumns: newVehicleColumns, fixedSchedule: {}, tempSchedule: {}, workTypeConfig: {} }; alert(`새 노선 [${routeName}]이 추가되었습니다.`);
            } else { s1_data.routes[routeName].companyName = companyName; s1_data.routes[routeName].type = type; alert(`[${routeName}] 노선 정보가 수정되었습니다.`); } s1_data.currentRoute = routeName;
        });
        this.state.currentRoute = routeName; this.populateRouteSelect(); this.loadRouteData(routeName);
    },
    deleteRoute() { 
        this.saveSnapshot();
        const routeName = this.ui.routeNavigateSelect.value; if (!routeName) { alert('삭제할 노선을 선택하세요.'); return; } if (confirm(`[${routeName}] 노선을 삭제하시겠습니까?`)) { let newRouteToLoad = null; DataManager.updateS1Data(s1_data => { delete s1_data.routes[routeName]; newRouteToLoad = Object.keys(s1_data.routes)[0] || null; s1_data.currentRoute = newRouteToLoad; }); this.state.currentRoute = newRouteToLoad; this.populateRouteSelect(); this.loadRouteData(newRouteToLoad); alert(`[${routeName}] 노선이 삭제되었습니다.`); } 
    },
    
    handleVehicleInputChange(changedInput) {
        const newValue = changedInput.value.trim();
        let oldValue = changedInput.dataset.prevValue; 
        if (!oldValue) { changedInput.dataset.prevValue = newValue; return; }
        if (!newValue) { changedInput.dataset.prevValue = ''; return; }
        const allInputs = Array.from(this.ui.vehicleInputsContainer.querySelectorAll('input'));
        const targetInput = allInputs.find(input => input !== changedInput && input.value.trim() === newValue);
        if (targetInput) {
            targetInput.value = oldValue;
            targetInput.dataset.prevValue = oldValue;
            this.highlightSwap(changedInput, targetInput);
        }
        changedInput.dataset.prevValue = newValue;
    },

    highlightSwap(input1, input2) {
        const color = '#fff3cd'; input1.style.backgroundColor = color; input2.style.backgroundColor = color;
        setTimeout(() => { input1.style.backgroundColor = ''; input2.style.backgroundColor = ''; }, 500);
    },

    saveRouteConfig() {
        if (!this.state.currentRoute) { alert('먼저 노선을 선택하세요.'); return; } 
        this.saveSnapshot(); 
        const inputs = this.ui.vehicleInputsContainer.querySelectorAll('input'); 
        const newVehicleColumns = []; inputs.forEach(input => newVehicleColumns.push(input.value.trim() || '미입력'));
        DataManager.updateS2Data(s2_data => {
            const routeName = this.state.currentRoute; if (!s2_data[routeName]) s2_data[routeName] = {}; if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
            const s1_base_list = newVehicleColumns.filter(v => v && v !== '미입력' && isNaN(Number(v)) === false); 
            const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' }); 
            s1_base_list.sort(collator.compare);
            const old_s2_order = s2_data[routeName]._settings.baseOrder || []; const new_s2_order = []; const s1_set = new Set(s1_base_list);
            old_s2_order.forEach(car => { if (s1_set.has(car)) { new_s2_order.push(car); s1_set.delete(car); } }); 
            s1_set.forEach(car => new_s2_order.push(car)); s2_data[routeName]._settings.baseOrder = new_s2_order;
        });
        DataManager.updateS1Data(s1_data => { const routeData = s1_data.routes[this.state.currentRoute]; if (routeData) { routeData.vehicleColumns = newVehicleColumns; this.state.currentVehicleColumns = newVehicleColumns; } }); 
        this.state.autoFillStopFlag = false; this.loadRouteData(this.state.currentRoute); alert(`[${this.state.currentRoute}] 차량 번호 설정이 저장되었습니다.`);
    },

    updateVehicleSelect() { const vehicleSelect = this.ui.vehicleSelect; vehicleSelect.innerHTML = '<option value="">차량 선택</option>'; if (this.state.currentVehicleColumns.length > 0) { vehicleSelect.innerHTML += '<option value="ALL_VEHICLES" style="font-weight:bold; background-color:#e0e0e0;">--- 전체차량 ---</option>'; } this.state.currentVehicleColumns.forEach(colName => { if (colName && colName !== '미입력') { const option = document.createElement('option'); option.value = colName; option.textContent = colName; vehicleSelect.appendChild(option); } }); },
    getDayName(dayOfWeek) { return ['일', '월', '화', '수', '목', '금', '토'][dayOfWeek]; },
    getHolidayMap(year) { const holidays = {}; const solarHolidays = { '01-01': '신정', '03-01': '삼일절', '05-05': '어린이날', '06-06': '현충일', '08-15': '광복절', '10-03': '개천절', '10-09': '한글날', '12-25': '성탄절' }; for (const [dateStr, name] of Object.entries(solarHolidays)) { holidays[dateStr] = name; } const lunarMap = { 2024: { '02-09':'설날', '02-10':'설날', '02-11':'설날', '05-15':'부처님오신날', '09-16':'추석', '09-17':'추석', '09-18':'추석' }, 2025: { '01-28':'설날', '01-29':'설날', '01-30':'설날', '05-06':'부처님오신날', '10-05':'추석', '10-06':'추석', '10-07':'추석' }, 2026: { '02-16':'설날', '02-17':'설날', '02-18':'설날', '05-24':'부처님오신날', '09-24':'추석', '09-25':'추석', '09-26':'추석' }, 2027: { '02-06':'설날', '02-07':'설날', '02-08':'설날', '05-13':'부처님오신날', '09-14':'추석', '09-15':'추석', '09-16':'추석' }, 2028: { '01-26':'설날', '01-27':'설날', '01-28':'설날', '05-02':'부처님오신날', '10-02':'추석', '10-03':'추석', '10-04':'추석' }, 2029: { '02-12':'설날', '02-13':'설날', '02-14':'설날', '05-20':'부처님오신날', '09-21':'추석', '09-22':'추석', '09-23':'추석' }, 2030: { '02-02':'설날', '02-03':'설날', '02-04':'설날', '05-09':'부처님오신날', '09-11':'추석', '09-12':'추석', '09-13':'추석' } }; if (lunarMap[year]) { Object.assign(holidays, lunarMap[year]); } const sortedDates = Object.keys(holidays).sort(); const formatYMD = (d) => { const m = String(d.getMonth() + 1).padStart(2, '0'); const dd = String(d.getDate()).padStart(2, '0'); return `${m}-${dd}`; }; sortedDates.forEach(dateStr => { const name = holidays[dateStr]; const currentHolidayDate = new Date(year, parseInt(dateStr.split('-')[0]) - 1, parseInt(dateStr.split('-')[1])); const dayOfWeek = currentHolidayDate.getDay(); let needsSubstitute = false; if (['설날', '추석', '어린이날'].includes(name)) { if (dayOfWeek === 0 || dayOfWeek === 6) needsSubstitute = true; } else if (['삼일절', '광복절', '개천절', '한글날', '성탄절', '부처님오신날'].includes(name)) { if (dayOfWeek === 0) needsSubstitute = true; } if (needsSubstitute) { let nextDay = new Date(currentHolidayDate); nextDay.setDate(nextDay.getDate() + 1); while (true) { const nextDateStr = formatYMD(nextDay); if (holidays[nextDateStr]) { nextDay.setDate(nextDay.getDate() + 1); } else { holidays[nextDateStr] = '대체공휴일'; break; } } } }); return holidays; },
    isPublicHoliday(date) { const year = date.getFullYear(); const holidays = this.getHolidayMap(year); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); const key = `${month}-${day}`; return holidays[key] || false; },
    renderCellContent(names) { if (!names || names.length === 0) return ''; const hiddenKeywords = ['휴무', '월차', '년차', '퇴직자', '']; return names.map(item => { const text = item.text.trim(); const isHidden = hiddenKeywords.includes(text); const display = isHidden ? '' : text; const hiddenClass = isHidden ? ' hidden-x' : ''; const boldClass = item.bold ? ' bold-name' : ''; return `<span class="name-entry${hiddenClass}${boldClass}">${display}</span>`; }).join(''); },

    editCell(cell, colId, dateString, dayOfWeek) {
        if (cell.classList.contains('edit-mode')) return;
        document.querySelectorAll('#section1 td.edit-mode').forEach(editCell => {
            const prevColId = editCell.dataset.colId; const prevDateString = editCell.dataset.dateString;
            const originalNames = (this.state.scheduleData[prevDateString] && this.state.scheduleData[prevDateString][prevColId]) || [{ text: '', bold: false }, { text: '', bold: false }];
            editCell.classList.remove('edit-mode'); editCell.innerHTML = this.renderCellContent(originalNames);
        });
        const currentNames = (this.state.scheduleData[dateString] && this.state.scheduleData[dateString][colId]) || [{ text: '', bold: false }, { text: '', bold: false }];
        const morningValue = (currentNames[0] && currentNames[0].text !== '휴무') ? currentNames[0].text : '';
        const afternoonValue = (currentNames[1] && currentNames[1].text !== '휴무') ? currentNames[1].text : '';
        
        const amPlaceholder = morningValue ? morningValue : "오전 (비우면 휴무)";
        const pmPlaceholder = afternoonValue ? afternoonValue : "오후 (비우면 휴무)";

        cell.classList.add('edit-mode'); cell.dataset.colId = colId; cell.dataset.dateString = dateString; cell.dataset.dayOfWeek = dayOfWeek;
        this.state.lastFocusedInput = (morningValue === afternoonValue && morningValue !== '') ? 'both' : 'am';

        cell.innerHTML = `
            <input type="text" class="morning-input" value="" placeholder="${amPlaceholder}" data-bold="${currentNames[0].bold}">
            <input type="text" class="afternoon-input" value="" placeholder="${pmPlaceholder}" data-bold="${currentNames[1].bold}">
            <div class="cell-buttons" style="display: flex; flex-direction: column; gap: 2px; margin-top: 2px;">
                <div style="display: flex; gap: 1px; width: 100%;">
                    <button class="btn-fixed" style="flex: 1;">고정</button> <button class="btn-temp" style="flex: 1;">임시</button> <button class="btn-highlight-am" style="flex: 1; font-size: 0.6em;">오전스페어</button> <button class="btn-highlight-pm" style="flex: 1; font-size: 0.6em;">오후스페어</button>
                </div>
                <div style="display: flex; gap: 1px; width: 100%;">
                    <button class="btn-monthly" style="flex: 1; background-color: #17a2b8; color: white;">월차</button> <button class="btn-annual" style="flex: 1; background-color: #17a2b8; color: white;">년차</button> <button class="btn-resign" style="flex: 1; background-color: #6c757d; color: white;">퇴직자</button> <button class="btn-delete" style="flex: 1;">삭제</button>
                </div>
            </div>`;
        
        const amInput = cell.querySelector('.morning-input'); const pmInput = cell.querySelector('.afternoon-input');
        if (this.state.lastFocusedInput === 'pm') pmInput.focus(); else amInput.focus();
        amInput.onfocus = () => { this.state.lastFocusedInput = 'am'; }; pmInput.onfocus = () => { this.state.lastFocusedInput = 'pm'; };

        const buttons = cell.querySelector('.cell-buttons');
        buttons.querySelector('.btn-fixed').onclick = (e) => { e.stopPropagation(); this.saveFixedCell(cell); };
        buttons.querySelector('.btn-temp').onclick = (e) => { e.stopPropagation(); this.saveTempCell(cell); };
        buttons.querySelector('.btn-highlight-am').onclick = (e) => { e.stopPropagation(); this.highlightCell(cell, 'am'); };
        buttons.querySelector('.btn-highlight-pm').onclick = (e) => { e.stopPropagation(); this.highlightCell(cell, 'pm'); };
        buttons.querySelector('.btn-delete').onclick = (e) => { e.stopPropagation(); this.deleteCell(cell); };

        const applySpecialStatus = (status) => {
            if (status === '퇴직자') {
                const targetInput = (this.state.lastFocusedInput === 'pm') ? pmInput : amInput;
                let currentName = targetInput.value.trim();
                if (!currentName && targetInput.placeholder && !targetInput.placeholder.includes('비우면')) {
                    currentName = targetInput.placeholder;
                }
                
                this.openRetireeModal(dateString, colId, (this.state.lastFocusedInput === 'pm' ? 'pm' : 'am'), currentName);
                return; 
            }
            
            const targets = [];
            let currentAm = amInput.value.trim();
            if (!currentAm && amInput.placeholder && !amInput.placeholder.includes('비우면')) currentAm = amInput.placeholder;

            let currentPm = pmInput.value.trim();
            if (!currentPm && pmInput.placeholder && !pmInput.placeholder.includes('비우면')) currentPm = pmInput.placeholder;

            if (currentAm === currentPm || currentAm === '' || currentPm === '') { targets.push({ inp: amInput, val: currentAm, shift: 'am' }); targets.push({ inp: pmInput, val: currentPm, shift: 'pm' }); }
            else { if (this.state.lastFocusedInput === 'am') targets.push({ inp: amInput, val: currentAm, shift: 'am' }); else if (this.state.lastFocusedInput === 'pm') targets.push({ inp: pmInput, val: currentPm, shift: 'pm' }); else { targets.push({ inp: amInput, val: currentAm, shift: 'am' }); targets.push({ inp: pmInput, val: currentPm, shift: 'pm' }); } }
            targets.forEach(t => {
                const fixedOwner = this.getFixedOwner(dateString, colId);
                const ownerName = (t.shift === 'am') ? fixedOwner.am : fixedOwner.pm;
                const nameToSend = (t.val && t.val !== '휴무') ? t.val : ownerName;
                
                if (nameToSend) { this.updateS2HolidayWorker(dateString, this.state.currentRoute, colId, t.shift, nameToSend, status); }
                t.inp.value = ''; t.inp.dataset.leaveType = status;
            });
            this.saveTempCell(cell);
        };
        buttons.querySelector('.btn-monthly').onclick = (e) => { e.stopPropagation(); applySpecialStatus('월차'); };
        buttons.querySelector('.btn-annual').onclick = (e) => { e.stopPropagation(); applySpecialStatus('년차'); };
        buttons.querySelector('.btn-resign').onclick = (e) => { e.stopPropagation(); applySpecialStatus('퇴직자'); };
    },
    
    /* [S1_Module 내부 함수 수정] */

// 1. 고정 근무자 저장 함수 (수정됨)
saveFixedCell(cellElement) {
    // 스냅샷 저장
    this.saveSnapshot(); 
    
    const { colId, dayOfWeek, dateString } = cellElement.dataset;
    const amInput = cellElement.querySelector('.morning-input');
    const pmInput = cellElement.querySelector('.afternoon-input');
    
    let amName = amInput.value.trim();
    if (amName === '' && amInput.placeholder && !amInput.placeholder.includes('비우면')) {
        amName = amInput.placeholder;
    }

    let pmName = pmInput.value.trim();
    if (pmName === '' && pmInput.placeholder && !pmInput.placeholder.includes('비우면')) {
        pmName = pmInput.placeholder;
    }

    const oldNames = (this.state.scheduleData[dateString] && this.state.scheduleData[dateString][colId]) || [{ text: '', bold: false }, { text: '', bold: false }];
    const fixedOwner = this.getFixedOwner(dateString, colId);

    // [중요] 화면에 입력된 값 (Visual Names)
    const visualNewNames = [
        { text: amName, bold: amInput.dataset.bold === 'true' },
        { text: pmName, bold: pmInput.dataset.bold === 'true' }
    ];
    
    // 글로벌 스왑 체크는 "화면에 보이는 대로" 판단 (사용자 의도 파악)
    if (!amInput.dataset.leaveType && !pmInput.dataset.leaveType) {
        this.checkAndExecuteGlobalSwap(visualNewNames, oldNames, dateString, colId);
    }

    // S2 데이터 업데이트 (휴무자 등)
    if (visualNewNames[0].text !== '' && visualNewNames[0].text !== fixedOwner.am && visualNewNames[0].text !== '휴무') { 
        if (fixedOwner.am) this.updateS2HolidayWorker(dateString, this.state.currentRoute, colId, 'am', fixedOwner.am, ''); 
    }
    if (visualNewNames[1].text !== '' && visualNewNames[1].text !== fixedOwner.pm && visualNewNames[1].text !== '휴무') { 
        if (fixedOwner.pm) this.updateS2HolidayWorker(dateString, this.state.currentRoute, colId, 'pm', fixedOwner.pm, ''); 
    }
    
    DataManager.updateS1Data(s1_data => {
        const routeData = s1_data.routes[this.state.currentRoute]; if (!routeData) return;
        
        // [버그 수정 핵심] 현재 날짜가 "로테이션(격주 회전)"된 상태인지 확인
        let isViewRotated = false;
        const workType = routeData.workTypeConfig[colId] || 'biweekly'; // 기본값 biweekly
        
        if (workType === 'biweekly') {
            const recurringKey = `${dayOfWeek}-${colId}`;
            // 기존 고정 스케줄을 확인하여 로테이션 여부 판단
            if (routeData.fixedSchedule && routeData.fixedSchedule[recurringKey]) {
                for (const entry of routeData.fixedSchedule[recurringKey]) {
                    if (new Date(dateString) >= new Date(entry.dateString)) {
                        const weekDiff = this.calculateWeekDiff(entry.dateString, dateString);
                        if (weekDiff % 2 === 1) {
                            isViewRotated = true; // 홀수 주차라 화면이 뒤집힌 상태임
                        }
                        break;
                    }
                }
            }
        }

        // 화면이 뒤집힌 상태라면, 저장할 때는 다시 뒤집어서(Un-swap) 저장해야 원본 데이터가 꼬이지 않음
        let namesToSave = [...visualNewNames];
        if (isViewRotated) {
            namesToSave = [visualNewNames[1], visualNewNames[0]]; // [PM, AM] 순서로 변경하여 저장
        }

        const currentRecurringKey = `${dayOfWeek}-${colId}`;
        if (!routeData.fixedSchedule[currentRecurringKey]) routeData.fixedSchedule[currentRecurringKey] = [];
        
        // 해당 날짜의 기존 엔트리 제거 후 새 엔트리 추가
        routeData.fixedSchedule[currentRecurringKey] = routeData.fixedSchedule[currentRecurringKey].filter(entry => entry.dateString !== dateString);
        
        // [주의] 새 엔트리가 추가되면 이 날짜가 새로운 기준(Anchor)이 되므로, 
        // 이후에는 오늘을 기준으로 다시 로테이션이 계산됩니다.
        // 데이터 정합성을 위해 'namesToSave'를 저장합니다.
        routeData.fixedSchedule[currentRecurringKey].push({ dateString: dateString, names: namesToSave });
        routeData.fixedSchedule[currentRecurringKey].sort((a, b) => new Date(b.dateString) - new Date(a.dateString));
        
        this.state.fixedScheduleData = routeData.fixedSchedule;
    });

    this.updateLocalScheduleData(dateString, colId, visualNewNames);
    this.refreshSingleCell(cellElement, colId, dateString, visualNewNames);
    
    this.checkLineComplete(dateString, colId);
},

// 2. 임시 근무자 저장 함수 (수정됨)
saveTempCell(cellElement) {
    this.saveSnapshot(); 
    const { colId, dateString } = cellElement.dataset;
    const amInput = cellElement.querySelector('.morning-input');
    const pmInput = cellElement.querySelector('.afternoon-input');
    
    let amName = amInput.value.trim();
    if (amName === '' && amInput.placeholder && !amInput.placeholder.includes('비우면')) {
        amName = amInput.placeholder;
    }

    let pmName = pmInput.value.trim();
    if (pmName === '' && pmInput.placeholder && !pmInput.placeholder.includes('비우면')) {
        pmName = pmInput.placeholder;
    }

    const oldNames = (this.state.scheduleData[dateString] && this.state.scheduleData[dateString][colId]) || [{ text: '', bold: false }, { text: '', bold: false }];

    const visualNewNames = [
        { text: amName, bold: amInput.dataset.bold === 'true' },
        { text: pmName, bold: pmInput.dataset.bold === 'true' }
    ];
    
    if (!amInput.dataset.leaveType && !pmInput.dataset.leaveType) {
         this.checkAndExecuteGlobalSwap(visualNewNames, oldNames, dateString, colId);
    }

    const fixedOwner = this.getFixedOwner(dateString, colId);

    if (visualNewNames[0].text !== '' && visualNewNames[0].text !== fixedOwner.am && visualNewNames[0].text !== '휴무') {
        if (fixedOwner.am) {
            this.updateS2HolidayWorker(dateString, this.state.currentRoute, colId, 'am', fixedOwner.am, '');
        }
    }

    if (visualNewNames[1].text !== '' && visualNewNames[1].text !== fixedOwner.pm && visualNewNames[1].text !== '휴무') {
        if (fixedOwner.pm) {
            this.updateS2HolidayWorker(dateString, this.state.currentRoute, colId, 'pm', fixedOwner.pm, '');
        }
    }

    DataManager.updateS1Data(s1_data => {
        const routeData = s1_data.routes[this.state.currentRoute]; if (!routeData) return;
        if (!routeData.tempSchedule[dateString]) routeData.tempSchedule[dateString] = {};
        
        // [임시 저장 로직 수정]
        // TempSchedule은 화면에 보이는 그대로를 덮어쓰는(Override) 개념이므로
        // 별도의 Un-swap 로직 없이 화면 값(visualNewNames)을 그대로 저장해도 되지만,
        // S2 모듈과의 연동을 위해 로테이션 여부를 체크하는 것이 안전할 수 있습니다.
        // 하지만 TempSchedule은 '보이는 대로' 렌더링되므로 visualNewNames를 저장합니다.
        
        routeData.tempSchedule[dateString][colId] = visualNewNames;
        this.state.tempScheduleData = routeData.tempSchedule;
    });

    this.updateLocalScheduleData(dateString, colId, visualNewNames);
    this.refreshSingleCell(cellElement, colId, dateString, visualNewNames);
    
    this.checkLineComplete(dateString, colId);
},

    deleteCell(cellElement) {
        this.saveSnapshot(); 
        const { colId, dayOfWeek, dateString } = cellElement.dataset;
        const emptyNames = [{ text: '', bold: false }, { text: '', bold: false }];

        DataManager.updateS1Data(s1_data => {
            const routeData = s1_data.routes[this.state.currentRoute]; if (!routeData) return;
            if (routeData.tempSchedule[dateString]?.[colId]) { delete routeData.tempSchedule[dateString][colId]; if (Object.keys(routeData.tempSchedule[dateString]).length === 0) delete routeData.tempSchedule[dateString]; }
            const recurringKey = `${dayOfWeek}-${colId}`;
            if (!routeData.fixedSchedule[recurringKey]) routeData.fixedSchedule[recurringKey] = [];
            routeData.fixedSchedule[recurringKey] = routeData.fixedSchedule[recurringKey].filter(entry => entry.dateString !== dateString);
            routeData.fixedSchedule[recurringKey].push({ dateString: dateString, names: emptyNames });
            routeData.fixedSchedule[recurringKey].sort((a, b) => new Date(b.dateString) - new Date(a.dateString));
            this.state.fixedScheduleData = routeData.fixedSchedule; this.state.tempScheduleData = routeData.tempSchedule;
        });

        this.updateLocalScheduleData(dateString, colId, emptyNames);
        this.refreshSingleCell(cellElement, colId, dateString, emptyNames);
    },

    highlightCell(cellElement, shift) {
        const input = cellElement.querySelector(shift === 'am' ? '.morning-input' : '.afternoon-input');
        const isBold = input.dataset.bold === 'true';
        input.dataset.bold = (!isBold).toString();
        input.style.fontWeight = !isBold ? 'bold' : 'normal';
        input.style.color = !isBold ? '#0000FF' : ''; 
    },
    
    openRetireeModal(dateString, colId, shift, currentName) {
        this.state.pendingRetireeSwap = { dateString, colId, shift, currentName };
        const msgEl = document.getElementById('s1-retiree-msg');
        msgEl.innerHTML = `<strong>${currentName}</strong> (퇴직) <br>⬇<br> 대체 근무자 입력`;
        document.getElementById('s1-retiree-input').value = '';
        document.getElementById('s1-retiree-modal').style.display = 'block';
        document.getElementById('s1-retiree-input').focus();
    },

    confirmRetireeChange() {
        this.saveSnapshot(); 
        const newWorkerName = document.getElementById('s1-retiree-input').value.trim();
        if (!newWorkerName) { alert("대체 근무자 이름을 입력해주세요."); return; }
        
        const { dateString, colId, shift, currentName } = this.state.pendingRetireeSwap;
        this.updateS2HolidayWorker(dateString, this.state.currentRoute, colId, shift, currentName, '퇴직자');

        const info = {
            colId: colId,
            dateString: dateString,
            oldName: currentName,
            newName: newWorkerName,
            shift: shift
        };
        this.applyFutureSwap(info);
        
        this.closeRetireeModal();
        this.generateSchedule(); 
    },

    closeRetireeModal() {
        document.getElementById('s1-retiree-modal').style.display = 'none';
        this.state.pendingRetireeSwap = null;
    },
    
    clearEditMode(e) {
        if (!document.body.contains(e.target)) return;

        const activeCell = document.querySelector('#section1 td.edit-mode');
        if (activeCell && !activeCell.contains(e.target)) {
            const { colId, dateString } = activeCell.dataset;
            const originalNames = (this.state.scheduleData[dateString] && this.state.scheduleData[dateString][colId]) || [{ text: '', bold: false }, { text: '', bold: false }];
            activeCell.classList.remove('edit-mode');
            activeCell.innerHTML = this.renderCellContent(originalNames);
        }
    },

    checkAndExecuteGlobalSwap(newNames, oldNames, dateString, colId) {
        const newAm = newNames[0].text;
        const newPm = newNames[1].text;
        
        const oldAmObj = oldNames[0];
        const oldPmObj = oldNames[1];

        let oldName = "";
        let newName = "";
        let shift = "";

        if (oldAmObj.text && newAm && oldAmObj.text !== newAm && oldAmObj.text !== '휴무') {
            if (oldAmObj.bold === true) {
                oldName = oldAmObj.text;
                newName = newAm;
                shift = 'am';
            }
        } 
        else if (oldPmObj.text && newPm && oldPmObj.text !== newPm && oldPmObj.text !== '휴무') {
            if (oldPmObj.bold === true) {
                oldName = oldPmObj.text;
                newName = newPm;
                shift = 'pm';
            }
        } else {
            return;
        }

        if (!oldName) return;

        this.state.pendingSwapInfo = {
            colId: colId, dateString: dateString,
            oldName: oldName, newName: newName, shift: shift,
            type: 'global' 
        };

        const modalMsg = `
            <div style="text-align:center;">
                <p style="font-size:1.1em; font-weight:bold; margin-bottom:10px;">스페어 근무자 교체 확인</p>
                <p>새로 입력한 근무자 <strong>${newName}</strong>을(를)<br>
                기존 <span style="color:blue; font-weight:bold;">스페어</span> 근무자 <strong>${oldName}</strong>을(를) 대신하여<br>
                <span style="color:red;">모든 스페어 근무 위치에 자동으로 적용할까요?</span></p>
                <p style="font-size:0.9em; color:#666;">(해당 일자부터 미래의 <strong style="color:blue;">모든 차량/칸</strong>에서 변경됩니다.)</p>
            </div>`;
        
        const modalContent = document.querySelector('#s1-swap-msg-content');
        if (modalContent) modalContent.innerHTML = modalMsg;
        document.getElementById('s1-swap-modal').style.display = 'block';
    },

    executeFutureSwap(isConfirm) {
        if (isConfirm) this.saveSnapshot(); 
        document.getElementById('s1-swap-modal').style.display = 'none';
        const info = this.state.pendingSwapInfo;
        if (isConfirm && info) {
            if (info.type === 'global') {
                this.applyGlobalSwap(info);
            }
            this.generateSchedule();
        }
        this.state.pendingSwapInfo = null;
    },

    applyGlobalSwap(info) {
        const { dateString, oldName, newName } = info;
        
        DataManager.updateS1Data(s1_data => {
            const routeData = s1_data.routes[this.state.currentRoute]; if (!routeData) return;
            const startDate = new Date(dateString);
            const allCols = this.state.currentVehicleColumns.filter(c => c !== '미입력');

            for (let d = 0; d <= 6; d++) {
                const targetDateStr = this.getNextDayOfWeek(dateString, d);
                allCols.forEach(cId => {
                    const recurringKey = `${d}-${cId}`;
                    if (routeData.fixedSchedule[recurringKey]) {
                        const entries = routeData.fixedSchedule[recurringKey];
                        if (entries.length > 0) {
                            const lastEntry = entries[0];
                            const isAmTarget = (lastEntry.names[0].text === oldName && lastEntry.names[0].bold === true);
                            const isPmTarget = (lastEntry.names[1].text === oldName && lastEntry.names[1].bold === true);

                            if (isAmTarget || isPmTarget) {
                                let updatedNames = JSON.parse(JSON.stringify(lastEntry.names));
                                if (isAmTarget) { updatedNames[0].text = newName; } 
                                if (isPmTarget) { updatedNames[1].text = newName; }
                                const existIdx = entries.findIndex(e => e.dateString === targetDateStr);
                                if(existIdx > -1) { entries[existIdx].names = updatedNames; } 
                                else { entries.push({ dateString: targetDateStr, names: updatedNames }); entries.sort((a, b) => new Date(b.dateString) - new Date(a.dateString)); }
                            }
                        }
                    }
                });
            }

            Object.keys(routeData.tempSchedule).forEach(dStr => {
                if (new Date(dStr) >= startDate) {
                    const dailyData = routeData.tempSchedule[dStr];
                    Object.keys(dailyData).forEach(cId => {
                        const names = dailyData[cId];
                        if (names[0].text === oldName && names[0].bold === true) { names[0].text = newName; }
                        if (names[1].text === oldName && names[1].bold === true) { names[1].text = newName; }
                    });
                }
            });
            this.state.fixedScheduleData = routeData.fixedSchedule;
        });
    },

    applyFutureSwap(info) {
        const { colId, dateString, oldName, newName, shift } = info;
        const retireeName = oldName; 
        const newWorkerName = newName;

        DataManager.updateS1Data(s1_data => {
            const routeData = s1_data.routes[this.state.currentRoute]; if (!routeData) return;
            const startDate = new Date(dateString);
            
            for (let d = 0; d <= 6; d++) {
                const targetDateStr = this.getNextDayOfWeek(dateString, d);
                Object.keys(routeData.fixedSchedule).forEach(rKey => {
                    const [keyDay, keyCol] = rKey.split('-');
                    if (parseInt(keyDay) === d) {
                        const entries = routeData.fixedSchedule[rKey];
                        if (entries.length > 0) {
                            const lastEntry = entries[0];
                            const isAmRetiree = (lastEntry.names[0].text === retireeName);
                            const isPmRetiree = (lastEntry.names[1].text === retireeName);
                            if (isAmRetiree || isPmRetiree) {
                                let updatedNames = JSON.parse(JSON.stringify(lastEntry.names));
                                if (isAmRetiree) { updatedNames[0].text = newWorkerName; updatedNames[0].bold = false; }
                                if (isPmRetiree) { updatedNames[1].text = newWorkerName; updatedNames[1].bold = false; }
                                const existIdx = entries.findIndex(e => e.dateString === targetDateStr);
                                if(existIdx > -1) { entries[existIdx].names = updatedNames; } else { entries.push({ dateString: targetDateStr, names: updatedNames }); entries.sort((a, b) => new Date(b.dateString) - new Date(a.dateString)); }
                            }
                        }
                    }
                });
            }
            
            Object.keys(routeData.tempSchedule).forEach(dStr => {
                if (new Date(dStr) >= startDate) {
                    const dailyData = routeData.tempSchedule[dStr];
                    Object.keys(dailyData).forEach(currentColId => {
                        const names = dailyData[currentColId];
                        if (names[0].text === retireeName) { names[0].text = newWorkerName; names[0].bold = false; }
                        if (names[1].text === retireeName) { names[1].text = newWorkerName; names[1].bold = false; }
                    });
                }
            });
            this.state.fixedScheduleData = routeData.fixedSchedule;
        });
    },

    updateS2HolidayWorker(dateString, routeName, carNum, shift, workerName, status = '') {
        DataManager.updateS2Data(s2_data => {
            if (!s2_data[dateString]) s2_data[dateString] = {}; if (!s2_data[dateString][routeName]) s2_data[dateString][routeName] = {};
            let routeId = routeName.toLowerCase().replace(/[^a-z0-9-]/g, '');
            if (routeName === '종로07번') routeId = '07'; else if (routeName === '종로08번') routeId = '08'; else if (routeName === '성동 3-1번') routeId = 'sd31'; else if (routeName === '성동 3-2번') routeId = 'sd32';
            const displayText = (status === '월차' || status === '년차' || status === '퇴직자') ? `${workerName} (${status.replace('자','')})` : workerName;
            if (!s2_data[dateString][routeName][carNum]) s2_data[dateString][routeName][carNum] = {};
            const rowKey = `holiday_worker_${routeId}_${carNum}_${shift}`; s2_data[dateString][routeName][carNum][rowKey] = displayText;
            if (!s2_data[dateString][routeName].s1_rest_data) { s2_data[dateString][routeName].s1_rest_data = {}; }
            const listKey = `rest_list_s1_worker_${shift}_${carNum}_${workerName.trim().replace(/\s/g, '_')}`; s2_data[dateString][routeName].s1_rest_data[listKey] = displayText;
        });
    },
    
    checkLineComplete(dateString, triggeredColId) {
        if (this.state.autoFillStopFlag) return;
        if (!this.isValidVehicleNumber(triggeredColId)) return; 
        const validVehicleColumns = this.state.currentVehicleColumns.filter(c => this.isValidVehicleNumber(c));
        if (validVehicleColumns.length === 0) return;
        
        const currentData = this.state.scheduleData[dateString]; 
        if (!currentData) return;
        
        let isFull = true;
        for (const col of validVehicleColumns) { 
            const cellData = currentData[col]; 
            const am = cellData && cellData[0] ? cellData[0].text.trim() : ''; 
            const pm = cellData && cellData[1] ? cellData[1].text.trim() : ''; 
            if (am === '' || pm === '') { isFull = false; break; } 
        }
        
        if (isFull) {
            const nextDate = new Date(dateString); nextDate.setDate(nextDate.getDate() + 1); const nextDateStr = this.getLocalYMD(nextDate);
            const hasNextDayData = Object.values(this.state.fixedScheduleData).some(entries => entries.some(entry => entry.dateString === nextDateStr));
            const hasNextTemp = this.state.tempScheduleData[nextDateStr] && Object.keys(this.state.tempScheduleData[nextDateStr]).length > 0;
            if (hasNextDayData || hasNextTemp) return;
            
            this.state.pendingSourceDate = dateString; this.state.pendingTargetDate = nextDateStr;
            const msgEl = document.getElementById('s1-autofill-msg');
            msgEl.innerHTML = ` <strong style="color:#333;">${dateString}</strong> 근무자 입력 완료.<br><br> <span style="color:#0056b3; font-weight:bold; font-size:1.2em;">${nextDateStr} (다음날)</span> 근무자도<br> 동일하게 <span style="color:#28a745; font-weight:bold;">자동 생성</span> 하시겠습니까? `;
            document.getElementById('s1-autofill-modal').style.display = 'block';
        }
    },

    executeCopyNextDay() {
        this.saveSnapshot(); 
        const sourceDateStr = this.state.pendingSourceDate; const targetDateStr = this.state.pendingTargetDate; if (!sourceDateStr || !targetDateStr) return; document.getElementById('s1-autofill-modal').style.display = 'none';
        const sourceData = this.state.scheduleData[sourceDateStr]; if (!sourceData) return; const targetDate = new Date(targetDateStr); const targetDayOfWeek = targetDate.getDay(); const allColumns = this.state.currentVehicleColumns.filter(c => c !== '미입력'); const lastColId = allColumns.length > 0 ? allColumns[allColumns.length - 1] : null;
        DataManager.updateS1Data(s1_data => {
            const routeData = s1_data.routes[this.state.currentRoute]; if (!routeData) return;
            Object.keys(sourceData).forEach(colId => {
                const names = sourceData[colId]; let nextNames = JSON.parse(JSON.stringify(names)); 
                
                // [삭제됨] 격주 + 월요일 자동 스왑 로직 제거 (사용자 요청)
                // if (workType === 'biweekly' && targetDayOfWeek === 1) { ... } 

                const recurringKey = `${targetDayOfWeek}-${colId}`; if (!routeData.fixedSchedule[recurringKey]) routeData.fixedSchedule[recurringKey] = [];
                routeData.fixedSchedule[recurringKey] = routeData.fixedSchedule[recurringKey].filter(entry => entry.dateString !== targetDateStr);
                routeData.fixedSchedule[recurringKey].push({ dateString: targetDateStr, names: nextNames });
                routeData.fixedSchedule[recurringKey].sort((a, b) => new Date(b.dateString) - new Date(a.dateString));
            });
            this.state.fixedScheduleData = routeData.fixedSchedule;
        });
        this.generateSchedule();
        setTimeout(() => { if (lastColId) this.checkLineComplete(targetDateStr, lastColId); }, 100);
    },

    resetAllFixedSchedules() {
        if (!this.state.currentRoute) { alert('초기화할 노선이 선택되지 않았습니다.'); return; }
        const password = prompt(`[${this.state.currentRoute}] 노선의 모든 고정/임시 근무표, 근무형태 설정, 그리고 승무일지 기록을 삭제하시겠습니까?\n(비밀번호 입력)`);
        if (password === "201023") {
            if (confirm(`정말 삭제하시겠습니까? \n[${this.state.currentRoute}] 노선의 모든 데이터(근무표 + 승무일지 + 휴무자)가 영구적으로 삭제됩니다.`)) {
                this.saveSnapshot(); 
                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[this.state.currentRoute];
                    if (routeData) { routeData.fixedSchedule = {}; routeData.tempSchedule = {}; routeData.workTypeConfig = {}; this.state.fixedScheduleData = routeData.fixedSchedule; this.state.tempScheduleData = routeData.tempSchedule; this.state.workTypeConfig = routeData.workTypeConfig; }
                });
                DataManager.updateS2Data(s2_data => {
                    const routeName = this.state.currentRoute; if (s2_data[routeName]) delete s2_data[routeName];
                    Object.keys(s2_data).forEach(key => { if (s2_data[key] && s2_data[key][routeName]) { delete s2_data[key][routeName]; if (Object.keys(s2_data[key]).length === 0) delete s2_data[key]; } });
                });
                this.state.autoFillStopFlag = false;
                this.generateSchedule(); if (S2_Module && typeof S2_Module.refreshDispatchLog === 'function') S2_Module.refreshDispatchLog(); alert(`[${this.state.currentRoute}] 노선의 모든 데이터(근무표, 승무일지, 휴무자 포함)가 초기화되었습니다.`);
            }
        } else { alert("비밀번호가 일치하지 않습니다."); }
    },

    backupScheduleData() {
        const backupData = DataManager.data.s1; const jsonString = JSON.stringify(backupData); const now = new Date(); const dateString = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
        let companyName = "전체"; let routeName = "전체";
        if (this.state.currentRoute && DataManager.data.s1.routes[this.state.currentRoute]) { const routeData = DataManager.data.s1.routes[this.state.currentRoute]; companyName = (routeData.companyName || "회사없음").replace(/\s/g, ''); routeName = this.state.currentRoute.replace(/\s/g, ''); }
        const filename = `${companyName}_${routeName}_근무현황표(S1)_${dateString}.json`;
        const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); alert(`근무현황표(S1) 데이터 파일 (${filename})이 다운로드 폴더에 JSON 파일로 저장됩니다.`);
    },

    restoreScheduleData(file) {
        const selectElement = this.ui.scheduleActionsSelect; if (!file) { selectElement.value = ''; return; }
        if (!confirm(`[${file.name}] 파일을 업로드하여 저장된 *모든* 노선의 근무표(S1)를 불러오시겠습니까? (현재 모든 S1 데이터는 덮어쓰여집니다.)`)) { this.ui.restoreFile.value = ''; selectElement.value = ''; return; }
        
        this.saveSnapshot(); 
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const loadedData = JSON.parse(event.target.result); if (!loadedData.routes || loadedData.currentRoute === undefined) throw new Error('Invalid saved file structure');
                DataManager.updateS1Data(s1_data => { s1_data.routes = loadedData.routes; s1_data.currentRoute = loadedData.currentRoute; });
                this.state.currentRoute = loadedData.currentRoute; this.populateRouteSelect(); this.loadRouteData(this.state.currentRoute); alert(`[${file.name}] 파일로부터 S1 전체 데이터 불러오기를 완료했습니다.`);
            } catch (e) { alert('파일을 읽는 도중 오류가 발생했습니다.'); console.error('Restore Error:', e); } finally { this.ui.restoreFile.value = ''; selectElement.value = ''; }
        };
        reader.readAsText(file);
    },

    generateSchedule() {
        if (!this.state.currentRoute) { this.ui.scheduleContainer.innerHTML = '<table><caption id="tableCaption">표시할 노선을 선택하거나 추가해주세요.</caption></table>'; return; }
        const year = parseInt(this.ui.yearInput.value); const month = parseInt(this.ui.monthInput.value);
        const selectedOption = document.querySelector('#section1 input[name="displayOption"]:checked').value; const applyHolidays = this.ui.holidaySelect.value === 'apply';
        const { routeData } = DataManager.getCurrentRouteData(); if (!routeData) return;
        const companyName = routeData.companyName || '회사명 없음'; const VEHICLE_COLS = routeData.vehicleColumns || [];
        this.ui.scheduleContainer.innerHTML = '';
        const startDate = new Date(year, month - 1, selectedOption === '1' ? 1 : 16); const endDate = (selectedOption === '1') ? new Date(year, month - 1, 15) : new Date(year, month, 0);
        const colChunks = []; for (let i = 0; i < VEHICLE_COLS.length; i += 12) colChunks.push(VEHICLE_COLS.slice(i, i + 12)); if (colChunks.length === 0) colChunks.push([]);
        const dateRange = []; for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) dateRange.push(new Date(d));
        this.state.scheduleData = {};
        
        colChunks.forEach((vehicleChunk, chunkIndex) => {
            const table = document.createElement('table'); if (chunkIndex > 0) table.style.pageBreakBefore = 'always';
            const caption = document.createElement('caption'); let captionText = `${companyName} [${this.state.currentRoute}] ${year}년 ${month}월 ${startDate.getDate()}일 ~ ${endDate.getDate()}일까지 근무현황표`; if (colChunks.length > 1) captionText += ` (페이지 ${chunkIndex + 1}/${colChunks.length})`; if (chunkIndex === 0) caption.id = 'tableCaption'; caption.textContent = captionText; table.appendChild(caption);
            const thead = document.createElement('thead'); if (chunkIndex === 0) thead.id = 'scheduleHeader'; thead.innerHTML = `<tr><th style="width: 4%;">월일</th><th style="width: 4%;">요일</th>${vehicleChunk.map(c => `<th>${c}</th>`).join('')}</tr>`; table.appendChild(thead);
            const tbody = document.createElement('tbody'); if (chunkIndex === 0) tbody.id = 'scheduleBody';
            dateRange.forEach(d => {
                const dateString = this.getLocalYMD(d); const dayOfWeek = d.getDay();
                if (!this.state.scheduleData[dateString]) {
                    let cellsContent = {};
                    VEHICLE_COLS.forEach(colId => {
                        let appliedNames = [{ text: '', bold: false }, { text: '', bold: false }];
                        if (this.state.tempScheduleData[dateString] && this.state.tempScheduleData[dateString][colId]) { appliedNames = this.state.tempScheduleData[dateString][colId]; } else {
                            const recurringKey = `${dayOfWeek}-${colId}`;
                            if (this.state.fixedScheduleData[recurringKey]) {
                                let anchorEntry = null; for (const entry of this.state.fixedScheduleData[recurringKey]) { if (new Date(dateString) >= new Date(entry.dateString)) { anchorEntry = entry; break; } }
                                if (anchorEntry) { 
                                    // [수정] 기본값 'normal' -> 'biweekly'
                                    const workType = this.state.workTypeConfig[colId] || 'biweekly'; 
                                    if (workType === 'biweekly') { const weekDifference = this.calculateWeekDiff(anchorEntry.dateString, dateString); if (weekDifference % 2 === 1) appliedNames = [anchorEntry.names[1], anchorEntry.names[0]]; else appliedNames = anchorEntry.names; } else { appliedNames = anchorEntry.names; } 
                                }
                            }
                        }
                        cellsContent[colId] = appliedNames;
                    });
                    this.state.scheduleData[dateString] = cellsContent;
                }
                const holidayName = applyHolidays ? this.isPublicHoliday(d) : false; const isHoliday = !!holidayName; const dayName = this.getDayName(dayOfWeek);
                let rowClass = isHoliday ? 'holiday' : (dayOfWeek === 0 ? 'sunday' : (dayOfWeek === 6 ? 'saturday' : '')); let mainColor = isHoliday || dayOfWeek === 0 ? '#cc0000' : (dayOfWeek === 6 ? '#0000cc' : '#333');
                let subText = isHoliday ? holidayName.substring(0, 2) : (dayOfWeek === 0 ? '일요' : (dayOfWeek === 6 ? '토요' : ''));
                let dayCellContent = `<div class="day-cell-content"><span class="day-name-main" style="color: ${mainColor};">${dayName}</span><span class="sub-day-info" style="color: ${mainColor};">${subText}</span></div>`;
                const dataCellsHTML = vehicleChunk.map(colId => `<td onclick="S1_Module.editCell(this, '${colId}', '${dateString}', ${dayOfWeek})">${this.renderCellContent(this.state.scheduleData[dateString][colId])}</td>`).join('');
                tbody.insertAdjacentHTML('beforeend', `<tr class="${rowClass}"><td>${d.getDate()}</td><td>${dayCellContent}</td>${dataCellsHTML}</tr>`);
            });
            table.appendChild(tbody); this.ui.scheduleContainer.appendChild(table);
        });
    },
    calculateWorkdays() {
        if (!this.state.currentRoute) { alert('근무일수를 계산할 노선이 없습니다.'); return; }
        const { routeData } = DataManager.getCurrentRouteData(); if (!routeData) return;
        const year = parseInt(this.ui.yearInput.value); const month = parseInt(this.ui.monthInput.value);
        const VEHICLE_COLS = routeData.vehicleColumns || []; const workdayCounts = {}; const shiftCounts = {}; const allNames = new Set();
        const startDate = new Date(year, month - 1, 1); const endDate = new Date(year, month, 0);
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateString = this.getLocalYMD(d); const dayOfWeek = d.getDay(); let dailyNames = {};
            VEHICLE_COLS.forEach(colId => {
                if (colId === '미입력') return; let appliedNames = [{ text: '', bold: false }, { text: '', bold: false }];
                if (routeData.tempSchedule[dateString] && routeData.tempSchedule[dateString][colId]) { appliedNames = routeData.tempSchedule[dateString][colId]; } else { const recurringKey = `${dayOfWeek}-${colId}`; if (routeData.fixedSchedule[recurringKey]) { for (const entry of routeData.fixedSchedule[recurringKey]) { if (new Date(dateString) >= new Date(entry.dateString)) { appliedNames = entry.names; break; } } } }
                dailyNames[colId] = appliedNames;
            });
            const dayWorkdays = new Set();
            for (const colId in dailyNames) { if (colId !== '비고' && colId !== '미입력') { dailyNames[colId].forEach((item, index) => { const name = item.text.trim(); if (name !== '' && name !== '휴무') { allNames.add(name); if (!shiftCounts[name]) shiftCounts[name] = { 오전: 0, 오후: 0 }; if (index === 0) shiftCounts[name].오전++; else shiftCounts[name].오후++; dayWorkdays.add(name); } }); } }
            dayWorkdays.forEach(name => { if (!workdayCounts[name]) workdayCounts[name] = 0; workdayCounts[name]++; });
        }
        const combinedData = Array.from(allNames).map(name => ({ name: name, workdays: workdayCounts[name] || 0, morningShifts: (shiftCounts[name] && shiftCounts[name].오전) || 0, afternoonShifts: (shiftCounts[name] && shiftCounts[name].오후) || 0 })).sort((a, b) => b.workdays - a.workdays);
        const title = `[${this.state.currentRoute}] ${year}년 ${month}월 근무일수`;
        const tableHTML = ` <table style="width: 100%; border-collapse: collapse;"> <thead><tr> <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">이름</th> <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">오전</th> <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">오후</th> <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">총 근무일수</th> </tr></thead> <tbody>${combinedData.map(data => ` <tr> <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.name}</td> <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.morningShifts}일</td> <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.afternoonShifts}일</td> <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.workdays}일</td> </tr>`).join('')} </tbody> </table>`;
        const newWindow = window.open('', '_blank', 'width=600,height=400');
        newWindow.document.write(`<html><head><title>${title}</title><style> body { font-family: Arial, sans-serif; margin: 20px; } h3 { text-align: center; } table { width: 100%; border-collapse: collapse; margin-top: 20px; } th, td { border: 1px solid #ddd; padding: 10px; text-align: center; } th { background-color: #f2f2f2; } .print-button { display: block; margin: 20px auto; padding: 10px 20px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; } @media print { .print-button { display: none; } html, body { height: 100%; width: 100%; margin: 0; } } </style></head><body><h3>${title}</h3>${tableHTML}<button class="print-button" onclick="window.print()">인쇄</button></body></html>`);
        newWindow.document.close();
    },
    printPage() {
        const editCell = document.querySelector('#section1 td.edit-mode'); if (editCell) { const { colId, dateString } = editCell.dataset; const originalNames = this.state.scheduleData[dateString]?.[colId] || [{ text: '', bold: false }, { text: '', bold: false }]; editCell.classList.remove('edit-mode'); editCell.innerHTML = this.renderCellContent(originalNames); }
        document.documentElement.style.setProperty('--print-margin-left', `${this.ui.marginLeftSelect.value}mm`); document.documentElement.style.setProperty('--print-margin-right', `${this.ui.marginRightSelect.value}mm`);
        const originalTitle = document.title; const captionText = document.getElementById('tableCaption').textContent; let newTitle = "근무현황표"; const matches = captionText.match(/\[(.*?)\] (\d{4})년 (\d{1,2})월 (\d{1,2})일 ~ (\d{1,2})일/); if (matches) newTitle = `${matches[1]} ${matches[2]}-${matches[3].padStart(2, '0')} (${matches[4].padStart(2, '0')}일-${matches[5].padStart(2, '0')}일)`; else if (this.state.currentRoute) newTitle = `${this.state.currentRoute} 근무현황표`;
        document.body.classList.remove('printing-section1'); document.body.classList.add('printing-section1');
        const handleAfterPrint = () => { document.title = originalTitle; document.documentElement.style.removeProperty('--print-margin-left'); document.documentElement.style.removeProperty('--print-margin-right'); document.body.classList.remove('printing-section1'); window.removeEventListener('afterprint', handleAfterPrint); };
        window.addEventListener('afterprint', handleAfterPrint); document.title = newTitle; window.print();
    },
    applyFontSize(size) { if (parseFloat(size) < 8) size = '8pt'; if (parseFloat(size) > 20) size = '20pt'; document.documentElement.style.setProperty('--worker-font-size', size); },
    handleScheduleActions() { const action = this.ui.scheduleActionsSelect.value; if (action === 'reset') this.resetAllFixedSchedules(); else if (action === 'backup') this.backupScheduleData(); else if (action === 'restore') this.ui.restoreFile.click(); this.ui.scheduleActionsSelect.value = ''; },
    handleWorkTypeChange() {
        const selectedValue = this.ui.vehicleSelect.value; const workType = this.ui.workTypeSelect.value; if (!selectedValue || !workType) return; let workTypeName = workType === 'normal' ? '3/3 근무' : (workType === 'biweekly' ? '격주 근무' : '5일 근무');
        if (selectedValue === 'ALL_VEHICLES') { const vehicleCount = this.state.currentVehicleColumns.filter(c => c !== '미입력').length; if (vehicleCount === 0) alert('설정할 차량이 없습니다.'); else if (confirm(`[${this.state.currentRoute}] 노선의 '미입력'을 제외한 *전체 차량* (${vehicleCount}대)의 근무형태를 [${workTypeName}]로 설정하고 저장하시겠습니까?`)) { 
            this.saveSnapshot(); 
            DataManager.updateS1Data(s1_data => { const routeData = s1_data.routes[this.state.currentRoute]; if (!routeData) return; this.state.currentVehicleColumns.forEach(colId => { if (colId !== '미입력') routeData.workTypeConfig[colId] = workType; }); this.state.workTypeConfig = routeData.workTypeConfig; }); alert(`[${this.state.currentRoute}] 노선의 전체 차량 근무형태가 [${workTypeName}]로 설정되었습니다.`); } } else { if (confirm(`차량 [${selectedValue}]의 근무형태를 [${workTypeName}]로 설정하고 저장하시겠습니까?`)) { 
                this.saveSnapshot(); 
                DataManager.updateS1Data(s1_data => { const routeData = s1_data.routes[this.state.currentRoute]; if (!routeData) return; routeData.workTypeConfig[selectedValue] = workType; this.state.workTypeConfig = routeData.workTypeConfig; }); alert(`차량 [${selectedValue}]의 근무형태가 [${workTypeName}]로 설정되었습니다.`); } }
        this.ui.vehicleSelect.value = ''; this.ui.workTypeSelect.value = '';
    },
    handleRouteSelectChange(routeName) { if (routeName) this.loadRouteData(routeName); },
    showSection(sectionId) { document.getElementById('section1').style.display = 'none'; document.getElementById('section2').style.display = 'none'; document.getElementById('section3').style.display = 'none'; document.querySelectorAll('.divider').forEach(d => d.style.display = 'none'); const target = document.getElementById(`section${sectionId.replace('S', '')}`); if (target) { target.style.display = 'block'; target.scrollIntoView({ behavior: 'smooth' }); } },
    showAllSections() { document.getElementById('section1').style.display = 'block'; document.getElementById('section2').style.display = 'block'; document.getElementById('section3').style.display = 'block'; document.querySelectorAll('.divider').forEach(d => d.style.display = 'block'); window.scrollTo({ top: 0, behavior: 'smooth' }); },
    setVersion() { try { document.getElementById('version-display').textContent = 'Ver 6.5.0 (Partial Update)'; } catch (e) { console.error(e); } }
};

/* ================================================================= */
/* [Section 2] 승무 일지 모듈 (내림 수정 원칙 적용) */
/* ================================================================= */
const S2_Module = {
    ui: {
        headerTitle: document.querySelector('#section2 .header-title'),
        fontSizeSelect: document.getElementById('font-size-select'),
        dispatchLogBody: document.getElementById('dispatch-log-body'),
        prevDateBtn: document.getElementById('s2_prevDate'),
        todayBtn: document.getElementById('s2_today'),
        nextDateBtn: document.getElementById('s2_nextDate'),
        startDateInput: document.getElementById('s2_startDate'),
        endDateInput: document.getElementById('s2_endDate'),
        loadRangeBtn: document.getElementById('s2_loadRange'),
        restoreModal: document.getElementById('s2_restoreDateModal'),
        restoreFile: document.getElementById('s2_restoreFile'),
        cancelRestoreBtn: document.getElementById('s2_cancelRestoreBtn'),
        confirmRestoreBtn: document.getElementById('s2_confirmRestoreBtn'),
        timeModal: document.getElementById('s2_timeSettingModal'),
        timeModalInfo: document.getElementById('s2_timeModal_info'),
        modalHour: document.getElementById('s2_modal_hour'),
        modalMinute: document.getElementById('s2_modal_minute'),
        modalInterval: document.getElementById('s2_modal_interval'),
        modalApplyBtn: document.getElementById('s2_modal_apply'),
        modalCancelBtn: document.getElementById('s2_modal_cancel'),
    },

    state: {
        s2_currentDates: [],
        S2_ROUTE_MAP: {
            '종로07번': '07', '종로08번': '08',
            '성동 3-1번': 'sd31', '성동 3-2번': 'sd32'
        },
        S2_USED_VEHICLES: {},
        s2_draggedCell: null,
        s2_draggedRoute: null,
        activeTimeTarget: null
    },

    // [헬퍼] 날짜 더하기
    addDays(date, days) {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    },

    rotateArray(array, count) {
        const len = array.length;
        if (len === 0) return [];
        const netCount = count % len;
        if (netCount === 0) return [...array];
        if (netCount > 0) {
            return [...array.slice(netCount), ...array.slice(0, netCount)];
        } else {
            return [...array.slice(len + netCount), ...array.slice(0, len + netCount)];
        }
    },

    seededShuffle(array, seed) {
        const result = [...array];
        let m = result.length, t, i;
        let h = 0x811c9dc5;
        for (let j = 0; j < seed.length; j++) {
            h ^= seed.charCodeAt(j);
            h = Math.imul(h, 0x01000193);
        }
        const random = () => {
            let t = (h += 0x6D2B79F5);
            t = Math.imul(t ^ (t >>> 15), t | 1);
            t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
            return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        };
        while (m) {
            i = Math.floor(random() * m--);
            t = result[m];
            result[m] = result[i];
            result[i] = t;
        }
        return result;
    },

    initialize() {
        console.log("S2: 초기화 (내림 수정 원칙 적용)");
        DataManager.subscribe(this);
        DataManager.loadS2Data();

        this.bindEventListeners();
        this.loadToday();
        this.refreshDispatchLog();
    },

    loadToday() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayString = DataManager.getTodayDateString(today);
        this.state.s2_currentDates = [{ date: today, dateString: todayString }];
        this.ui.startDateInput.value = todayString;
        this.ui.endDateInput.value = todayString;
        this.refreshDispatchLog();
    },

    onDataChanged(event, payload) {
        if (event === 's1_data_changed' || event === 's2_data_changed') {
            this.refreshDispatchLog();
        }
    },

    bindEventListeners() {
        document.getElementById('s2-showAll').onclick = () => S1_Module.showAllSections();
        this.ui.fontSizeSelect.onchange = (e) => this.changeFontSize(e.target.value);
        document.getElementById('s2-backupLog').onclick = () => this.backupLogData();
        document.getElementById('s2-showRestoreModal').onclick = () => this.showRestoreModal();
        
        document.getElementById('s2-refreshLog').onclick = () => {
            if (confirm("경고: 현재 조회된 날짜의 [모든 기록]을 초기화하시겠습니까?\n\n(이 작업은 되돌릴 수 없습니다.)")) {
                this.resetS2LogForCurrentDates();
                this.refreshDispatchLog();
            }
        };
        
        document.getElementById('s2-printPage').onclick = () => this.printPage();

        this.ui.prevDateBtn.onclick = () => this.navigateDate(-1);
        this.ui.todayBtn.onclick = () => this.loadToday();
        this.ui.nextDateBtn.onclick = () => this.navigateDate(1);
        this.ui.loadRangeBtn.onclick = () => this.loadDateRange();
        this.ui.cancelRestoreBtn.onclick = () => this.hideRestoreModal();
        this.ui.confirmRestoreBtn.onclick = () => this.triggerRestore();
        this.ui.restoreFile.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                this.restoreLogData(file);
                this.hideRestoreModal();
            }
        };
        
        this.ui.modalCancelBtn.onclick = () => { this.ui.timeModal.style.display = 'none'; };
        this.ui.modalApplyBtn.onclick = () => this.applyTimeFromModal();

        const logBody = this.ui.dispatchLogBody;
        logBody.onchange = (e) => {
            const target = e.target;
            // 상단 컨트롤 박스 값 변경 감지 및 저장
            if (target.tagName === 'INPUT' || target.tagName === 'SELECT') {
                if (target.closest('.schedule-options')) {
                     const routeId = target.name.split('_').pop(); 
                     const routeName = document.getElementById(`route-${routeId}`).dataset.routeName;
                     this.saveScheduleSettings(routeName, routeId);
                     return;
                }
            }

            if (target.tagName === 'INPUT' && (target.name.startsWith('start_time_') || target.name.startsWith('pm_start_time_'))) {
                target.value = this.formatTimeInput(target.value);
                this.saveS2LogEntryFromElement(target);
            } else if (target.tagName === 'SELECT' && target.classList.contains('s2-work-hours-select')) {
                this.handleWorkHoursChange(target);
            } else if (e.target.classList.contains('dispatch-cycle-select')) {
                e.stopPropagation();
                const routeId = e.target.closest('.dispatch-cycle-container').dataset.routeId;
                const routeName = document.getElementById(`route-${routeId}`).dataset.routeName;
                this.changeDispatchCycle(routeName, e.target.value);
            } else if (e.target.classList.contains('car-select-dropdown')) {
                e.stopPropagation();
                const routeName = e.target.closest('.route-section').dataset.routeName;
                this.changeCarNumber(e.target, routeName);
            }
        };

        logBody.onclick = (e) => {
            const carCell = e.target.closest('.car-number-cell');
            const driverCell = e.target.closest('td[data-edit-type="driver"]');
            const dispatchBtn = e.target.closest('.dispatch-button');
            
            if (e.target.tagName === 'INPUT' && (e.target.name.startsWith('start_time_') || e.target.name.startsWith('pm_start_time_'))) {
                this.openTimeModal(e.target);
                return;
            }

            if (carCell) {
                e.preventDefault();
                const routeName = carCell.closest('.route-section').dataset.routeName;
                this.toggleCarNumberEditMode(carCell, routeName);
            } else if (driverCell) {
                e.preventDefault();
                this.toggleEditMode(driverCell);
            } else if (dispatchBtn) {
                e.preventDefault();
                const routeName = document.getElementById(`route-${dispatchBtn.closest('.dispatch-buttons-container').dataset.routeId}`).dataset.routeName;
                this.changeDispatchOrder(routeName, dispatchBtn.dataset.order, dispatchBtn.closest('.dispatch-buttons-container'));
            }
        };

        logBody.onmousedown = (e) => {
             const carControlBtn = e.target.closest('.car-controls button');
             if (carControlBtn) {
                 e.preventDefault();
                 const td = carControlBtn.closest('.car-number-cell');
                 if (carControlBtn.classList.contains('btn-car-delete')) this.deleteCarRow(td);
                 else if (carControlBtn.classList.contains('btn-car-close')) this.exitCarNumberEditMode(td);
                 return;
             }
             const driverControlBtn = e.target.closest('.edit-controls button');
             if (driverControlBtn) {
                 e.preventDefault();
                 const td = driverControlBtn.closest('td[data-edit-type="driver"]');
                 if (driverControlBtn.classList.contains('btn-driver-delete')) this.deleteName(td);
                 else if (driverControlBtn.classList.contains('btn-driver-save')) this.saveAndExit(td);
                 return;
             }
             
             // 시간 적용 및 초기화 버튼
             const settingBtn = e.target.closest('.setting-button');
             if (settingBtn) {
                 e.preventDefault();
                 const routeId = settingBtn.dataset.routeId;
                 const routeName = document.getElementById(`route-${routeId}`).dataset.routeName;
                 const dateString = this.state.s2_currentDates[0]?.dateString; 
                 if (!dateString) { alert("날짜를 먼저 조회해주세요."); return; }
 
                 if (settingBtn.classList.contains('apply-button')) {
                     this.applyScheduleSettings(routeName, routeId, dateString, true);
                 } else if (settingBtn.classList.contains('reset-button')) {
                     if(confirm("이 노선의 시간 설정을 초기화하시겠습니까? (컨트롤 박스 값만 초기화됩니다)")) {
                        this.resetScheduleSettings(routeName, routeId);
                     }
                 }
             }
         };
        // 드래그 앤 드롭
        logBody.ondragstart = (e) => this.dragStart(e, e.target.closest('.route-section').dataset.routeName);
        logBody.ondragover = (e) => this.dragOver(e);
        logBody.ondrop = (e) => this.drop(e, e.target.closest('.route-section').dataset.routeName);
        logBody.ondragend = (e) => this.dragEnd(e);
    },

    saveScheduleSettings(routeName, routeId) {
        // AM Inputs
        const amStart = document.querySelector(`select[name="am_startVehicle_${routeId}"]`)?.value;
        const amHour = document.querySelector(`input[name="am_hour_${routeId}"]`)?.value;
        const amMinute = document.querySelector(`input[name="am_minute_${routeId}"]`)?.value;
        const amInterval = document.querySelector(`input[name="am_interval_${routeId}"]`)?.value;

        // PM Inputs
        const pmStart = document.querySelector(`select[name="pm_startVehicle_${routeId}"]`)?.value;
        const pmHour = document.querySelector(`input[name="pm_hour_${routeId}"]`)?.value;
        const pmMinute = document.querySelector(`input[name="pm_minute_${routeId}"]`)?.value;
        const pmInterval = document.querySelector(`input[name="pm_interval_${routeId}"]`)?.value;

        DataManager.updateS2Data(s2_data => {
            if (!s2_data[routeName]) s2_data[routeName] = {};
            if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};

            s2_data[routeName]._settings.am_startVehicle = amStart;
            s2_data[routeName]._settings.am_hour = amHour;
            s2_data[routeName]._settings.am_minute = amMinute;
            s2_data[routeName]._settings.am_interval = amInterval;

            s2_data[routeName]._settings.pm_startVehicle = pmStart;
            s2_data[routeName]._settings.pm_hour = pmHour;
            s2_data[routeName]._settings.pm_minute = pmMinute;
            s2_data[routeName]._settings.pm_interval = pmInterval;
        });
    },

    resetScheduleSettings(routeName, routeId) {
        const inputs = [
            `select[name="am_startVehicle_${routeId}"]`, `input[name="am_hour_${routeId}"]`,
            `input[name="am_minute_${routeId}"]`, `input[name="am_interval_${routeId}"]`,
            `select[name="pm_startVehicle_${routeId}"]`, `input[name="pm_hour_${routeId}"]`,
            `input[name="pm_minute_${routeId}"]`, `input[name="pm_interval_${routeId}"]`
        ];
        
        inputs.forEach(sel => {
            const el = document.querySelector(sel);
            if (el) el.value = '';
        });
        
        this.saveScheduleSettings(routeName, routeId);
        alert("시간 설정값이 초기화되었습니다. (실제 입력된 시간은 변경되지 않음)");
    },

    // [전체 적용] 상단 컨트롤 박스: 이것은 전체 초기화 개념이므로 기존대로 둠 (원하는 경우 수정 가능)
    applyScheduleSettings(routeName, routeId, dateString, showMessage = false) {
        const routeSection = document.getElementById(`route-${routeId}`);
        if (!routeSection) return;

        const amStart = document.querySelector(`select[name="am_startVehicle_${routeId}"]`)?.value;
        const amHour = parseInt(document.querySelector(`input[name="am_hour_${routeId}"]`)?.value);
        const amMinute = parseInt(document.querySelector(`input[name="am_minute_${routeId}"]`)?.value);
        const amInterval = parseInt(document.querySelector(`input[name="am_interval_${routeId}"]`)?.value);

        const pmStart = document.querySelector(`select[name="pm_startVehicle_${routeId}"]`)?.value;
        const pmHour = parseInt(document.querySelector(`input[name="pm_hour_${routeId}"]`)?.value);
        const pmMinute = parseInt(document.querySelector(`input[name="pm_minute_${routeId}"]`)?.value);
        const pmInterval = parseInt(document.querySelector(`input[name="pm_interval_${routeId}"]`)?.value);

        DataManager.updateS2Data(s2_data => {
            if (!s2_data[dateString]) s2_data[dateString] = {};
            if (!s2_data[dateString][routeName]) s2_data[dateString][routeName] = {};
            const dailyRouteLog = s2_data[dateString][routeName];

            // --- AM 적용 ---
            if (amStart && !isNaN(amHour) && !isNaN(amMinute) && !isNaN(amInterval)) {
                let currentTime = new Date();
                currentTime.setHours(amHour, amMinute, 0, 0);

                const amInputs = Array.from(routeSection.querySelectorAll(`input[name^="start_time_"]`))
                    .sort((a, b) => parseInt(a.dataset.seqOrder) - parseInt(b.dataset.seqOrder));
                
                let startIdx = amInputs.findIndex(input => input.dataset.carNum === amStart);
                if (startIdx === -1) startIdx = 0;

                const orderedInputs = [...amInputs.slice(startIdx), ...amInputs.slice(0, startIdx)];

                orderedInputs.forEach(input => {
                    const carNum = input.dataset.carNum;
                    const driverName = input.closest('td').previousElementSibling.querySelector('.driver-name').textContent.trim();
                    const hasDriver = (driverName && driverName !== '휴무');

                    if (!dailyRouteLog[carNum]) dailyRouteLog[carNum] = {};

                    if (hasDriver) {
                        const timeStr = currentTime.toTimeString().slice(0, 5);
                        input.value = timeStr;
                        dailyRouteLog[carNum][input.name] = timeStr;
                        currentTime.setMinutes(currentTime.getMinutes() + amInterval);
                    } else {
                        input.value = '';
                        dailyRouteLog[carNum][input.name] = '';
                    }
                });
            }

            // --- PM 적용 ---
            if (pmStart && !isNaN(pmHour) && !isNaN(pmMinute) && !isNaN(pmInterval)) {
                let currentTime = new Date();
                currentTime.setHours(pmHour, pmMinute, 0, 0);

                const pmInputs = Array.from(routeSection.querySelectorAll(`input[name^="pm_start_time_"]`))
                    .sort((a, b) => parseInt(a.dataset.seqOrder) - parseInt(b.dataset.seqOrder));
                
                let startIdx = pmInputs.findIndex(input => input.dataset.carNum === pmStart);
                if (startIdx === -1) startIdx = 0;

                const orderedInputs = [...pmInputs.slice(startIdx), ...pmInputs.slice(0, startIdx)];

                orderedInputs.forEach(input => {
                    const carNum = input.dataset.carNum;
                    const driverName = input.closest('td').previousElementSibling.querySelector('.driver-name').textContent.trim();
                    const hasDriver = (driverName && driverName !== '휴무');

                    if (!dailyRouteLog[carNum]) dailyRouteLog[carNum] = {};

                    if (hasDriver) {
                        const timeStr = currentTime.toTimeString().slice(0, 5);
                        input.value = timeStr;
                        dailyRouteLog[carNum][input.name] = timeStr;
                        currentTime.setMinutes(currentTime.getMinutes() + pmInterval);
                    } else {
                        input.value = '';
                        dailyRouteLog[carNum][input.name] = '';
                    }
                });
            }
        });

        if (showMessage) {
            alert(`[${routeName}] 시간 설정이 일괄 적용되었습니다.`);
        }
    },

    renderApprovalLine(routeName, dateString) {
        const container = document.getElementById('s2-approval-container');
        if (!container) return;

        const s2_data = DataManager.loadS2Data();
        const settings = s2_data[routeName]?._settings || {};
        const dailyLog = s2_data[dateString]?.[routeName] || {};

        const defaultTitles = ["담당", "계장", "대리", "과장", "부장", "전무", "사장", "사장"];
        const titles = settings.approval_titles || defaultTitles;

        const signatures = dailyLog.approval_values || new Array(8).fill("");

        let html = '<table class="s2-approval-table"><thead><tr>';
        
        titles.forEach((title, idx) => {
            html += `<th><input type="text" class="approval-input-title" 
                      value="${title}" 
                      title="클릭하여 직함 수정"
                      onchange="S2_Module.saveApprovalTitle('${routeName}', ${idx}, this.value)"></th>`;
        });

        html += '</tr></thead><tbody><tr>';

        signatures.forEach((sign, idx) => {
            html += `<td><input type="text" class="approval-input-sign" 
                      value="${sign}" 
                      title="클릭하여 결재/이름 입력"
                      onchange="S2_Module.saveApprovalValue('${routeName}', '${dateString}', ${idx}, this.value)"></td>`;
        });

        html += '</tr></tbody></table>';
        container.innerHTML = html;
    },

    saveApprovalTitle(routeName, idx, value) {
        DataManager.updateS2Data(s2_data => {
            if (!s2_data[routeName]) s2_data[routeName] = {};
            if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
            
            if (!s2_data[routeName]._settings.approval_titles) {
                s2_data[routeName]._settings.approval_titles = ["담당", "계장", "대리", "과장", "부장", "전무", "사장", "사장"];
            }
            s2_data[routeName]._settings.approval_titles[idx] = value;
        });
    },

    saveApprovalValue(routeName, dateString, idx, value) {
        DataManager.updateS2Data(s2_data => {
            if (!s2_data[dateString]) s2_data[dateString] = {};
            if (!s2_data[dateString][routeName]) s2_data[dateString][routeName] = {};
            
            if (!s2_data[dateString][routeName].approval_values) {
                s2_data[dateString][routeName].approval_values = new Array(8).fill("");
            }
            s2_data[dateString][routeName].approval_values[idx] = value;
        });
    },

    refreshDispatchLog() {
        const { routeData } = DataManager.getCurrentRouteData();
        const container = this.ui.dispatchLogBody;
        container.innerHTML = '';

        if (this.state.s2_currentDates.length === 0) {
            container.innerHTML = '<div class="date-header">조회할 날짜를 선택해주세요.</div>';
            return;
        }

        if (this.state.s2_currentDates.length > 0 && S1_Module.state.currentRoute) {
            this.renderApprovalLine(S1_Module.state.currentRoute, this.state.s2_currentDates[0].dateString);
        }

        this.state.s2_currentDates.forEach(dateInfo => {
            const { date, dateString } = dateInfo;
            const dayOfWeek = date.getDay();
            const s2_logData = DataManager.getS2LogByDate(dateString);

            const holidaySelect = document.getElementById('holidaySelect');
            const applyHolidays = holidaySelect && holidaySelect.value === 'apply';
            let holidaySuffix = "";

            if (applyHolidays && S1_Module && S1_Module.isPublicHoliday) {
                 const hName = S1_Module.isPublicHoliday(date);
                 if (hName) {
                     holidaySuffix = ` <span style="color:#cc0000; font-size:0.8em;">(${hName})</span>`;
                 }
            }

            container.insertAdjacentHTML('beforeend', `<div class="date-header">${this.getFormattedDateString(date)}${holidaySuffix}</div>`);

            const allRoutes = DataManager.getAllRoutes();
            for (const routeName in allRoutes) {
                const rData = allRoutes[routeName];
                if (!rData) continue;

                const routeId = this.sanitizeForId(routeName);
                const s2_settings = DataManager.getS2RouteSettings(routeName);
                
                const todayS1Schedule = this.getTodayS1Schedule(rData, dateString, dayOfWeek);
                const todayS2RouteLog = s2_logData[routeName] || {};

                let validVehicles = this.calculateOrderForDate(routeName, dateString, s2_settings);
                
                if (!validVehicles || validVehicles.length === 0) {
                    let s1_base_list = (rData.vehicleColumns || []).filter(v => v && v !== '미입력');
                    const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
                    s1_base_list.sort(collator.compare);
                    validVehicles = s1_base_list;
                }

                if (s2_settings.dispatchType === 'manual' && s2_settings.cycle === 'manual' && s2_settings.am_startVehicle) {
                    const idx = validVehicles.indexOf(s2_settings.am_startVehicle);
                    if (idx > -1) validVehicles = this.rotateArray(validVehicles, idx);
                }

                const autoTimes = {}; 

                let s2_optionsHTML = (dateString === this.state.s2_currentDates[0].dateString) ? 
                    this.createOptionsHTML(routeId, routeName, validVehicles, s2_settings) : '';

                const halfCount = Math.ceil(validVehicles.length / 2);
                let tableBodyHTML = '';
                for (let i = 0; i < halfCount; i++) {
                    const leftCar = validVehicles[i] || '미입력';
                    const rightCar = validVehicles[i + halfCount] || '미입력';
                    const leftSeq = i + 1;
                    const rightSeq = i + 1 + halfCount;

                    const leftHTML = this.createRowSideHTML(routeName, leftCar, leftSeq, todayS1Schedule, todayS2RouteLog, s2_settings, dateString, autoTimes, rData, dayOfWeek);
                    const rightHTML = this.createRowSideHTML(routeName, rightCar, rightSeq, todayS1Schedule, todayS2RouteLog, s2_settings, dateString, autoTimes, rData, dayOfWeek);
                    tableBodyHTML += `<tr data-date-string="${dateString}">${leftHTML}${rightHTML}</tr>`;
                }

                let finalRestList = [];
                const savedRestList = todayS2RouteLog.manual_rest_list;

                if (savedRestList && Array.isArray(savedRestList)) {
                    finalRestList = savedRestList;
                } else {
                    finalRestList = this.getRestWorkersList(rData, dateString);
                }
                
                const s1_rest_data = todayS2RouteLog.s1_rest_data || {};
                Object.values(s1_rest_data).forEach(workerEntry => {
                    if (workerEntry && !finalRestList.includes(workerEntry)) {
                        finalRestList.push(workerEntry);
                    }
                });
                
                finalRestList = [...new Set(finalRestList)].sort();

                let restCellsHTML = '';
                const totalSlots = 18; 
                
                for (let i = 0; i < totalSlots; i++) {
                    const workerName = finalRestList[i] || ''; 
                    restCellsHTML += `
                        <div class="rest-worker-cell" 
                             onclick="S2_Module.toggleRestWorkerEdit(this, '${routeName}', '${dateString}', ${i})"
                             data-idx="${i}">
                            <span>${workerName}</span>
                            <input type="text" class="rest-worker-input" value="${workerName}" 
                                   onblur="S2_Module.saveRestWorker(this, '${routeName}', '${dateString}', ${i})"
                                   onkeydown="if(event.key==='Enter') this.blur()">
                        </div>`;
                }

                const restBoxHTML = `
                    <div class="rest-worker-container">
                        <div class="rest-worker-title">휴무자<br>(일일전체)</div>
                        <div class="rest-worker-grid">${restCellsHTML}</div>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', `
                    <div class="route-section" id="route-${routeId}" data-route-name="${routeName}">
                        <div class="route-header-flex">
                            <div class="route-title-group"><div class="route-name-text">${routeName}</div></div>
                            ${s2_optionsHTML}
                        </div>
                        <table class="journal-table">${this.createTableHeaderHTML(routeId)}<tbody>${tableBodyHTML}</tbody></table>
                        ${restBoxHTML}
                    </div>
                `);
            }
        });
    },

    openTimeModal(inputElement) {
        this.state.activeTimeTarget = inputElement; 
        const carNum = inputElement.dataset.carNum;
        const shift = inputElement.dataset.shift; 
        const routeSection = inputElement.closest('.route-section');
        const routeName = routeSection.dataset.routeName;
        
        let currentVal = inputElement.value.replace(/[^0-9:]/g, '');
        let hh = '', mm = '';
        if (currentVal.length === 4 && !currentVal.includes(':')) {
            hh = currentVal.substr(0, 2);
            mm = currentVal.substr(2, 2);
        } else if (currentVal.includes(':')) {
            [hh, mm] = currentVal.split(':');
        }

        this.ui.timeModalInfo.textContent = `[${routeName}] ${carNum}호 (${shift === 'am' ? '오전' : '오후'}) 출발시간 설정`;
        this.ui.modalHour.value = hh;
        this.ui.modalMinute.value = mm;
        this.ui.modalInterval.value = ''; 
        this.ui.timeModal.style.display = 'block';
        this.ui.modalHour.focus();
    },

    // [핵심 수정: 내림 적용 원칙]
    // 모달에서 적용 시 상단 컨트롤값 자동 세팅 및 시간 적용
    // "올림으로는 수정이 안되고 내림만 되도록" => circular loop 제거
    applyTimeFromModal() {
        const targetInput = this.state.activeTimeTarget;
        if (!targetInput) return;

        const hour = parseInt(this.ui.modalHour.value);
        const minute = parseInt(this.ui.modalMinute.value);
        const interval = parseInt(this.ui.modalInterval.value) || 0;

        if (isNaN(hour) || isNaN(minute)) {
            alert("시, 분을 정확히 입력해주세요.");
            return;
        }

        let currentTime = new Date();
        currentTime.setHours(hour, minute, 0, 0);

        const routeSection = targetInput.closest('.route-section');
        const routeName = routeSection.dataset.routeName;
        const routeId = this.sanitizeForId(routeName);
        const shift = targetInput.dataset.shift; 
        const targetCar = targetInput.dataset.carNum;

        // 1. 모달의 값을 상단 컨트롤 박스에 동기화
        const startVehicleSelect = document.querySelector(`select[name="${shift}_startVehicle_${routeId}"]`);
        const hourInput = document.querySelector(`input[name="${shift}_hour_${routeId}"]`);
        const minuteInput = document.querySelector(`input[name="${shift}_minute_${routeId}"]`);
        const intervalInput = document.querySelector(`input[name="${shift}_interval_${routeId}"]`);

        if (startVehicleSelect) startVehicleSelect.value = targetCar;
        if (hourInput) hourInput.value = hour;
        if (minuteInput) minuteInput.value = minute;
        if (intervalInput) intervalInput.value = interval;
        
        // 2. 컨트롤 박스 값 저장
        this.saveScheduleSettings(routeName, routeId);

        // 3. 시간 계산 및 적용 (내림 적용 원칙 - 아래로만 흐르게)
        const allInputs = Array.from(routeSection.querySelectorAll(`input[name*="${shift === 'am' ? '_am' : '_pm'}"]`));
        const timeInputs = allInputs.filter(el => el.name.startsWith(shift === 'am' ? 'start_time_' : 'pm_start_time_'));
        
        timeInputs.sort((a, b) => parseInt(a.dataset.seqOrder || 0) - parseInt(b.dataset.seqOrder || 0));

        let startIndex = timeInputs.indexOf(targetInput);
        if (startIndex === -1) return;

        DataManager.updateS2Data(s2_data => {
            const dateString = targetInput.closest('tr').dataset.dateString;
            
            // [중요 수정] 순환 배열(wrap-around) 제거
            // 기존: const orderedInputs = [...timeInputs.slice(startIndex), ...timeInputs.slice(0, startIndex)];
            // 수정: 선택된 인덱스부터 끝까지만(slice) 잘라서 적용. 앞부분(올림 방향)은 건드리지 않음.
            const orderedInputs = timeInputs.slice(startIndex);

            orderedInputs.forEach(input => {
                const carNum = input.dataset.carNum;
                
                const timeTd = input.closest('td');
                const driverTd = timeTd.previousElementSibling; 
                const driverNameSpan = driverTd.querySelector('.driver-name');
                const driverName = driverNameSpan ? driverNameSpan.textContent.trim() : '';
                
                if (driverName && driverName !== '휴무') {
                    const timeStr = currentTime.toTimeString().slice(0, 5);
                    input.value = timeStr;
                    
                    if (!s2_data[dateString]) s2_data[dateString] = {};
                    if (!s2_data[dateString][routeName]) s2_data[dateString][routeName] = {};
                    if (!s2_data[dateString][routeName][carNum]) s2_data[dateString][routeName][carNum] = {};
                    
                    const dbKey = (shift === 'am') 
                        ? `start_time_${this.sanitizeForId(routeName)}_${carNum}_am` 
                        : `pm_start_time_${this.sanitizeForId(routeName)}_${carNum}_pm`;
                    
                    s2_data[dateString][routeName][carNum][dbKey] = timeStr;

                    // 간격 적용
                    if (interval !== 0) currentTime.setMinutes(currentTime.getMinutes() + interval);
                } else {
                    input.value = '';
                    if (!s2_data[dateString]) s2_data[dateString] = {};
                    if (!s2_data[dateString][routeName]) s2_data[dateString][routeName] = {};
                    if (!s2_data[dateString][routeName][carNum]) s2_data[dateString][routeName][carNum] = {};

                    const dbKey = (shift === 'am') 
                        ? `start_time_${this.sanitizeForId(routeName)}_${carNum}_am` 
                        : `pm_start_time_${this.sanitizeForId(routeName)}_${carNum}_pm`;
                    s2_data[dateString][routeName][carNum][dbKey] = '';
                }
            });
        });
        
        this.ui.timeModal.style.display = 'none';
    },

    getFormattedDateString(dateObj) {
        return dateObj.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'long' }).replace(/\. /g, '.').replace(/\.$/, '');
    },
    changeFontSize(size) { document.getElementById('section2').style.fontSize = size + 'pt'; },
    printPage() {
        document.body.classList.remove('printing-section1', 'printing-section3');
        document.body.classList.add('printing-section2');
        const handleAfterPrint = () => {
            document.body.classList.remove('printing-section2');
            window.removeEventListener('afterprint', handleAfterPrint);
        };
        window.addEventListener('afterprint', handleAfterPrint);
        window.print();
    },
    sanitizeForId(text) {
        if (!text) return 'unknown';
        const s2_id = this.state.S2_ROUTE_MAP[text];
        return s2_id ? s2_id : text.toLowerCase().replace(/[^a-z0-9-]/g, '');
    },
    formatTimeInput(val) {
        if(!val) return '';
        val = val.replace(/[^0-9:]/g, '');
        if(val.length === 4 && !val.includes(':')) return val.slice(0,2) + ':' + val.slice(2);
        return val;
    },
    saveS2LogEntryFromElement(el) {
        const name = el.name;
        const val = el.value;
        const dateStr = el.closest('tr').dataset.dateString;
        const routeName = el.closest('.route-section').dataset.routeName;
        const carNum = el.dataset.carNum;
        
        DataManager.updateS2Data(s2_data => {
            if(!s2_data[dateStr]) s2_data[dateStr] = {};
            if(!s2_data[dateStr][routeName]) s2_data[dateStr][routeName] = {};
            if(!s2_data[dateStr][routeName][carNum]) s2_data[dateStr][routeName][carNum] = {};
            s2_data[dateStr][routeName][carNum][name] = val;
        });
    },
    backupLogData() {
        const backupData = DataManager.data.s2;
        const jsonString = JSON.stringify(backupData);
        const now = new Date();
        const dateString = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
        const filename = `승무일지(S2)_백업_${dateString}.json`;
        const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        alert('승무일지 데이터가 백업되었습니다.');
    },
    showRestoreModal() { this.ui.restoreModal.style.display = 'block'; },
    hideRestoreModal() { this.ui.restoreModal.style.display = 'none'; this.ui.restoreFile.value = ''; },
    triggerRestore() { this.ui.restoreFile.click(); },
    restoreLogData(file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const loadedData = JSON.parse(event.target.result);
                DataManager.updateS2Data(s2_data => {
                    Object.keys(s2_data).forEach(key => delete s2_data[key]);
                    Object.assign(s2_data, loadedData);
                });
                alert('승무일지 데이터가 복원되었습니다.');
                this.refreshDispatchLog();
            } catch (e) { alert('파일을 읽는 도중 오류가 발생했습니다.'); }
        };
        reader.readAsText(file);
    },

    changeDispatchOrder(routeName, order, buttonContainer) {
        buttonContainer.querySelectorAll('.dispatch-button').forEach(btn => btn.classList.toggle('active', btn.dataset.order === order));
        
        const cycleSelect = buttonContainer.nextElementSibling.querySelector('.dispatch-cycle-select');
        if (order === 'manual') {
            cycleSelect.value = 'manual';
            cycleSelect.disabled = true;
            DataManager.updateS2Data(s2_data => {
                 if (!s2_data[routeName]) s2_data[routeName] = {};
                 if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
                 s2_data[routeName]._settings.cycle = 'manual';
            });
        } else {
            cycleSelect.disabled = false;
            if (cycleSelect.value === 'manual') {
                cycleSelect.value = 'daily';
                DataManager.updateS2Data(s2_data => {
                     if (!s2_data[routeName]) s2_data[routeName] = {};
                     if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
                     s2_data[routeName]._settings.cycle = 'daily';
                });
            }
        }

        DataManager.updateS2Data(s2_data => {
            if (!s2_data[routeName]) s2_data[routeName] = {};
            if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
            s2_data[routeName]._settings.dispatchType = order;
        });
    },

    changeDispatchCycle(routeName, cycle) {
        DataManager.updateS2Data(s2_data => {
            if (!s2_data[routeName]) s2_data[routeName] = {};
            if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
            s2_data[routeName]._settings.cycle = cycle;
        });
    },

    navigateDate(days) {
        if (this.state.s2_currentDates.length === 0) return this.loadToday();
        const currentDate = this.state.s2_currentDates[0].date;
        const newDate = this.addDays(currentDate, days);
        newDate.setHours(0, 0, 0, 0);
        const newDateString = DataManager.getTodayDateString(newDate);
        this.state.s2_currentDates = [{ date: newDate, dateString: newDateString }];
        this.ui.startDateInput.value = newDateString;
        this.ui.endDateInput.value = newDateString;
        this.refreshDispatchLog();
    },

    loadDateRange() {
        const startDate = new Date(this.ui.startDateInput.value + 'T00:00:00');
        const endDate = new Date(this.ui.endDateInput.value + 'T00:00:00');
        if (isNaN(startDate) || isNaN(endDate)) return alert('날짜를 선택해주세요.');
        if (startDate > endDate) return alert('시작일은 종료일보다 이전이어야 합니다.');
        const dates = [];
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            d.setHours(0, 0, 0, 0);
            dates.push({ date: new Date(d), dateString: DataManager.getTodayDateString(d) });
        }
        if (dates.length > 31) return alert('최대 31일까지 조회 가능합니다.');
        this.state.s2_currentDates = dates;
        this.refreshDispatchLog();
    },

    calculateOrderForDate(routeName, targetDateString, s2_settings) {
        let baseOrder = s2_settings.baseOrder || [];
        
        const allRoutes = DataManager.getAllRoutes();
        const routeData = allRoutes[routeName];
        if (routeData && routeData.vehicleColumns) {
            let s1_base_list = routeData.vehicleColumns.filter(v => v && v !== '미입력');
            const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
            s1_base_list.sort(collator.compare);
            
            if (!baseOrder.length || baseOrder.length !== s1_base_list.length) {
                baseOrder = s1_base_list;
            }
        }
        
        if (!baseOrder.length) return [];
        if (s2_settings.dispatchType === 'manual' || s2_settings.cycle === 'manual') return baseOrder;

        if (s2_settings.dispatchType === 'random') {
             const seed = targetDateString.replace(/-/g, '') + routeName;
             return this.seededShuffle(baseOrder, seed);
        }

        const today = new Date(); today.setHours(0, 0, 0, 0);
        const targetDate = new Date(targetDateString); targetDate.setHours(0, 0, 0, 0);
        const diffDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
        
        let rotateCount = 0;
        if (s2_settings.cycle === 'daily') rotateCount = diffDays;
        else if (s2_settings.cycle === 'weekly') rotateCount = Math.floor(diffDays / 7);
        else if (s2_settings.cycle === 'monthly') rotateCount = Math.floor(diffDays / 30);
        
        if (s2_settings.dispatchType === 'descending') {
            rotateCount = -rotateCount;
        }

        return this.rotateArray(baseOrder, rotateCount);
    },

    createTableHeaderHTML(routeId) {
        const colgroup = `
            <colgroup>
                <col style="width: 3%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;">
                <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;">
                <col style="width: 3%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;">
                <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;">
            </colgroup>`;
        const header = `
            <thead>
                <tr>
                    <th style="background:#e9ecef; color:#333;">순서</th>
                    <th id="header_car_${routeId}_1">차<br>번</th> <th>오전<br>근무</th> <th>출발<br>시간</th> <th>근무<br>시간</th> <th>휴무자<br>(오전)</th>
                    <th>오후<br>근무</th> <th>출발<br>시간</th> <th>근무<br>시간</th> <th>휴무자<br>(오후)</th>
                    
                    <th style="background:#e9ecef; color:#333;">순서</th>
                    <th id="header_car_${routeId}_2">차<br>번</th> <th>오전<br>근무</th> <th>출발<br>시간</th> <th>근무<br>시간</th> <th>휴무자<br>(오전)</th>
                    <th>오후<br>근무</th> <th>출발<br>시간</th> <th>근무<br>시간</th> <th>휴무자<br>(오후)</th>
                </tr>
            </thead>`;
        return colgroup + header;
    },

    createRowSideHTML(routeName, carNum, seqNum, todayS1Schedule, todayS2RouteLog, s2_settings, dateString, autoTimes = {}, routeData = null, dayOfWeek = 0) {
        const routeId = this.sanitizeForId(routeName);
        const seqHTML = `<td style="font-weight:bold; background-color:#f8f9fa; color:#555;">${seqNum}</td>`;

        if (carNum === '미입력' || !carNum) {
            return `${seqHTML}<td class="car-number-cell" data-car-number="미입력"></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>`;
        }

        const s1CarData = todayS1Schedule[carNum] || [{text:''},{text:''}];
        const amDriver = (s1CarData[0].text||'').trim();
        const pmDriver = (s1CarData[1].text||'').trim();
        const amDisp = (amDriver===''||amDriver==='휴무')?'':amDriver;
        const pmDisp = (pmDriver===''||pmDriver==='휴무')?'':pmDriver;
        
        const log = todayS2RouteLog[carNum] || {};
        const amKey = `start_time_${routeId}_${carNum}_am`;
        const pmKey = `pm_start_time_${routeId}_${carNum}_pm`;
        const amHKey = `work_hours_${routeId}_${carNum}_am`;
        const pmHKey = `work_hours_${routeId}_${carNum}_pm`;
        
        let fixedAm = '', fixedPm = '';
        if (routeData) {
            const recurringKey = `${dayOfWeek}-${carNum}`;
            if (routeData.fixedSchedule && routeData.fixedSchedule[recurringKey]) {
                for (const entry of routeData.fixedSchedule[recurringKey]) {
                    if (new Date(dateString) >= new Date(entry.dateString)) {
                        let names = entry.names;
                        const workType = routeData.workTypeConfig[carNum] || 'normal';
                        if (workType === 'biweekly') {
                            const startObj = new Date(entry.dateString);
                            const currentObj = new Date(dateString);
                            
                            const diffTime = currentObj - startObj;
                            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                            const weeksPassed = Math.floor(diffDays / 7);

                            if (weeksPassed % 2 !== 0) {
                                names = [entry.names[1], entry.names[0]];
                            }
                        }
                        fixedAm = (names[0].text || '').trim();
                        fixedPm = (names[1].text || '').trim();
                        break;
                    }
                }
            }
        }

        let amHolidayWorkerStored = log[`holiday_worker_${routeId}_${carNum}_am`] || '';
        let pmHolidayWorkerStored = log[`holiday_worker_${routeId}_${carNum}_pm`] || '';

        if (!amHolidayWorkerStored && fixedAm && amDriver && fixedAm !== amDriver && amDriver !== '휴무') {
            amHolidayWorkerStored = fixedAm;
        }
        if (!pmHolidayWorkerStored && fixedPm && pmDriver && fixedPm !== pmDriver && pmDriver !== '휴무') {
            pmHolidayWorkerStored = fixedPm;
        }

        const amHoliday = log[amHKey] === '휴무';
        const pmHoliday = log[pmHKey] === '휴무';
        
        const amHolidayDisp = amHolidayWorkerStored ? amHolidayWorkerStored : (amHoliday ? amDisp : '');
        const pmHolidayDisp = pmHolidayWorkerStored ? pmHolidayWorkerStored : (pmHoliday ? pmDisp : '');
        
        const amClass = (amHoliday && amDisp) ? 'hidden' : '';
        const pmClass = (pmHoliday && pmDisp) ? 'hidden' : '';

        const amTimeValue = log[amKey] !== undefined ? log[amKey] : '';
        const pmTimeValue = log[pmKey] !== undefined ? log[pmKey] : '';

        const opts = (val) => ['', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '휴무'].map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('');

        return `
            ${seqHTML}
            <td class="car-number-cell" data-car-number="${carNum}" draggable="true">
                <div class="car-display">${carNum}</div>
                <div class="car-controls hidden">
                    <select class="car-select-dropdown"></select>
                    <div><button class="btn-car-delete">삭제</button><button class="btn-car-close">닫기</button></div>
                </div>
            </td>
            <td data-edit-type="driver" data-s1-key="${routeName}" data-car-number="${carNum}" data-shift="am" data-date-string="${dateString}">
                <span class="driver-name ${amClass}" style="${s1CarData[0].bold?'font-weight:bold':''}">${amDisp}</span>
                <input type="text" class="driver-input hidden" value="${amDriver}">
                <div class="edit-controls hidden"><button class="btn-driver-delete">삭제</button><button class="btn-driver-save">저장</button></div>
            </td>
            <td><input type="text" inputmode="numeric" name="${amKey}" data-car-num="${carNum}" data-shift="am" data-seq-order="${seqNum}" value="${amTimeValue}" ${amDisp?'':'disabled'}></td>
            <td><select class="s2-work-hours-select" name="${amHKey}" data-car-num="${carNum}" data-shift="am" ${amDisp?'':'disabled'}>${opts(log[amHKey])}</select></td>
            
            <td class="s2-holiday-cell" data-shift="am" data-route-name="${routeName}" data-car-number="${carNum}" data-date-string="${dateString}" onclick="S2_Module.toggleHolidayWorkerEdit(this)">
                <span>${amHolidayDisp}</span>
                <input type="text" class="holiday-worker-input" value="${amHolidayDisp}" onblur="S2_Module.saveHolidayWorker(this)" onkeydown="if(event.key==='Enter') this.blur()">
            </td>
            
            <td data-edit-type="driver" data-s1-key="${routeName}" data-car-number="${carNum}" data-shift="pm" data-date-string="${dateString}">
                <span class="driver-name ${pmClass}" style="${s1CarData[1].bold?'font-weight:bold':''}">${pmDisp}</span>
                <input type="text" class="driver-input hidden" value="${pmDriver}">
                <div class="edit-controls hidden"><button class="btn-driver-delete">삭제</button><button class="btn-driver-save">저장</button></div>
            </td>
            <td><input type="text" inputmode="numeric" name="${pmKey}" data-car-num="${carNum}" data-shift="pm" data-seq-order="${seqNum}" value="${pmTimeValue}" ${pmDisp?'':'disabled'}></td>
            <td><select class="s2-work-hours-select" name="${pmHKey}" data-car-num="${carNum}" data-shift="pm" ${pmDisp?'':'disabled'}>${opts(log[pmHKey])}</select></td>
            
            <td class="s2-holiday-cell" data-shift="pm" data-route-name="${routeName}" data-car-number="${carNum}" data-date-string="${dateString}" onclick="S2_Module.toggleHolidayWorkerEdit(this)">
                <span>${pmHolidayDisp}</span>
                <input type="text" class="holiday-worker-input" value="${pmHolidayDisp}" onblur="S2_Module.saveHolidayWorker(this)" onkeydown="if(event.key==='Enter') this.blur()">
            </td>
        `;
    },

    handleWorkHoursChange(el) {
        const val = el.value;
        const td = el.closest('td');
        const holidayCell = td.nextElementSibling;
        const driverCell = td.previousElementSibling.previousElementSibling;
        const timeInput = td.previousElementSibling.querySelector('input');
        const driverName = driverCell.querySelector('.driver-name');
        
        if (val === '휴무') {
            if(holidayCell) {
                const name = driverName.textContent;
                holidayCell.querySelector('span').textContent = name;
                holidayCell.querySelector('input').value = name;
            }
            driverName.classList.add('hidden');
            if(timeInput) { timeInput.value = ''; this.saveS2LogEntryFromElement(timeInput); }
        } else {
            if(holidayCell) {
                holidayCell.querySelector('span').textContent = '';
                holidayCell.querySelector('input').value = '';
            }
            driverName.classList.remove('hidden');
            if(timeInput && driverName.textContent.trim()) timeInput.disabled = false;
        }
        this.saveS2LogEntryFromElement(el);
    },

    createOptionsHTML(routeId, routeName, validVehicles, s2_settings) {
        const dType = s2_settings.dispatchType || 'manual';
        const cycle = s2_settings.cycle || 'manual';
        
        const opts = validVehicles.map(c => `<option value="${c}" ${s2_settings.am_startVehicle===c?'selected':''}>${c}</option>`).join('');
        const pmOpts = validVehicles.map(c => `<option value="${c}" ${s2_settings.pm_startVehicle===c?'selected':''}>${c}</option>`).join('');

        const btns = [['manual','수동'],['ascending','순차'],['descending','역순'],['random','랜덤']].map(([k,v]) => 
            `<button type="button" class="dispatch-button ${dType===k?'active':''}" data-order="${k}">${v}</button>`
        ).join('');
        const cycles = [['manual','주기 없음'],['daily','하루'],['weekly','1주'],['monthly','1개월']].map(([k,v]) => 
            `<option value="${k}" ${cycle===k?'selected':''}>${v}</option>`
        ).join('');
        
        const am_hour = s2_settings.am_hour || '';
        const am_minute = s2_settings.am_minute || '';
        const am_interval = s2_settings.am_interval || '';
        const pm_hour = s2_settings.pm_hour || '';
        const pm_minute = s2_settings.pm_minute || '';
        const pm_interval = s2_settings.pm_interval || '';

        return `
            <div class="schedule-options">
                <div class="am-options"><span>오전</span>
                    <select name="am_startVehicle_${routeId}"><option value="">시작차량</option>${opts}</select>
                    <input type="number" name="am_hour_${routeId}" placeholder="시" value="${am_hour}">
                    <input type="number" name="am_minute_${routeId}" placeholder="분" value="${am_minute}">
                    <input type="number" name="am_interval_${routeId}" placeholder="간격" value="${am_interval}">
                </div>
                <div class="pm-options"><span>오후</span>
                    <select name="pm_startVehicle_${routeId}"><option value="">오후시작</option>${pmOpts}</select>
                    <input type="number" name="pm_hour_${routeId}" placeholder="시" value="${pm_hour}">
                    <input type="number" name="pm_minute_${routeId}" placeholder="분" value="${pm_minute}">
                    <input type="number" name="pm_interval_${routeId}" placeholder="간격" value="${pm_interval}">
                </div>
            </div>
            <div class="settings-controls">
                <button type="button" class="setting-button apply-button" data-route-id="${routeId}">시간 적용</button>
                <button type="button" class="setting-button reset-button" data-route-id="${routeId}">시간 초기화</button>
            </div>
            <div class="load-button-container">
                <div class="dispatch-buttons-container" data-route-id="${routeId}"><label>출차순서:</label>${btns}</div>
                <div class="dispatch-cycle-container" data-route-id="${routeId}"><label>순환주기:</label>
                <select class="dispatch-cycle-select" ${dType==='manual'?'disabled':''}>${cycles}</select></div>
            </div>
        `;
    },

    toggleEditMode(cell) {
        document.querySelectorAll('td[data-edit-type="driver"]').forEach(c => {
            c.querySelector('.driver-name').classList.remove('hidden');
            c.querySelector('.driver-input').classList.add('hidden');
            c.querySelector('.edit-controls').classList.add('hidden');
        });
        cell.querySelector('.driver-name').classList.add('hidden');
        const inp = cell.querySelector('.driver-input');
        inp.classList.remove('hidden');
        cell.querySelector('.edit-controls').classList.remove('hidden');
        inp.focus(); inp.select();
    },
    saveAndExit(cell) {
        const routeName = cell.dataset.s1Key;
        const carNum = cell.dataset.carNumber;
        const shiftIdx = (cell.dataset.shift === 'am') ? 0 : 1;
        const newVal = cell.querySelector('.driver-input').value.trim();
        const dateStr = cell.dataset.dateString;
        
        DataManager.updateS1Data(s1_data => {
            const route = s1_data.routes[routeName];
            if(!route) return;
            if(!route.tempSchedule[dateStr]) route.tempSchedule[dateStr] = {};
            
            const todaySch = this.getTodayS1Schedule(route, dateStr, new Date(dateStr).getDay());
            const current = todaySch[carNum] || [{text:''},{text:''}];
            current[shiftIdx].text = (newVal===''||newVal==='휴무') ? '' : newVal;
            
            // 화면에 보이는 대로 저장 (격주 로테이션 반영된 상태 보존)
            route.tempSchedule[dateStr][carNum] = current;
        });
        this.refreshDispatchLog();
    },
    deleteName(cell) {
        cell.querySelector('.driver-input').value = '';
        this.saveAndExit(cell);
    },
    toggleCarNumberEditMode(cell, routeName) {
        const display = cell.querySelector('.car-display');
        const ctrls = cell.querySelector('.car-controls');
        const sel = cell.querySelector('.car-select-dropdown');
        
        if (ctrls.classList.contains('hidden')) {
            const routeData = DataManager.getAllRoutes()[routeName];
            const allCars = (routeData.vehicleColumns||[]).filter(v=>v&&v!=='미입력');
            const used = {};
            cell.closest('.route-section').querySelectorAll('.car-number-cell').forEach(c=>used[c.dataset.carNumber]=true);
            
            sel.innerHTML = '<option value="">-- 변경 --</option>' + 
                allCars.map(c => (used[c] && c!==cell.dataset.carNumber) ? '' : `<option value="${c}" ${c===cell.dataset.carNumber?'selected':''}>${c}</option>`).join('');
            
            display.classList.add('hidden');
            ctrls.classList.remove('hidden');
        } else {
            display.classList.remove('hidden');
            ctrls.classList.add('hidden');
        }
    },
    changeCarNumber(sel, routeName) {
        const newCar = sel.value;
        const oldCar = sel.closest('td').dataset.carNumber;
        const dateStr = sel.closest('tr').dataset.dateString;
        if(!newCar || newCar===oldCar) return;
        
        DataManager.updateS2Data(s2_data => {
            const log = s2_data[dateStr]?.[routeName];
            if(log && log[oldCar]) {
                const oldD = log[oldCar];
                const newD = {};
                const rId = this.sanitizeForId(routeName);
                Object.keys(oldD).forEach(k => newD[k.replace(`_${oldCar}_`,`_${newCar}_`)] = oldD[k]);
                delete log[oldCar];
                log[newCar] = newD;
            }
            const sett = s2_data[routeName]?._settings;
            if(sett?.baseOrder) {
                const idx = sett.baseOrder.indexOf(oldCar);
                if(idx>-1) sett.baseOrder[idx] = newCar;
            }
        });
        this.refreshDispatchLog();
    },
    deleteCarRow(cell) {
        if(!confirm("이 차량을 승무일지에서 삭제하시겠습니까?")) return;
        const car = cell.dataset.carNumber;
        const route = cell.closest('.route-section').dataset.routeName;
        const date = cell.closest('tr').dataset.dateString;
        
        DataManager.updateS2Data(s2_data => {
            if(s2_data[date]?.[route]?.[car]) delete s2_data[date][route][car];
            const sett = s2_data[route]?._settings;
            if(sett?.baseOrder) sett.baseOrder = sett.baseOrder.filter(c => c !== car);
        });
        this.refreshDispatchLog();
    },
    
    dragStart(e, routeName) {
        this.state.s2_draggedCell = e.target.closest('td');
        this.state.s2_draggedRoute = routeName;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', e.target.closest('td').dataset.carNumber);
        setTimeout(() => {
            this.state.s2_draggedCell.style.opacity = '0.4';
        }, 0);
    },
    dragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    },
    drop(e, routeName) {
        e.preventDefault();
        if (this.state.s2_draggedRoute !== routeName) {
            console.warn("[S2] 다른 노선 간 드래그는 불가능합니다.");
            return;
        }
        const targetCell = e.target.closest('td.car-number-cell');
        const draggedCar = this.state.s2_draggedCell.dataset.carNumber;
        const targetCar = targetCell.dataset.carNumber;

        if (draggedCar === targetCar) return;
        DataManager.updateS2Data(s2_data => {
            const s2_settings = DataManager.getS2RouteSettings(routeName);
            let baseOrder = s2_settings.baseOrder || [];
            
            const draggedIndex = baseOrder.indexOf(draggedCar);
            const targetIndex = baseOrder.indexOf(targetCar);
            
            if (draggedIndex > -1 && targetIndex > -1) {
                const [draggedItem] = baseOrder.splice(draggedIndex, 1);
                baseOrder.splice(targetIndex, 0, draggedItem);
                
                if (!s2_data[routeName]) s2_data[routeName] = {};
                s2_data[routeName]._settings = { ...s2_settings, baseOrder: baseOrder };
                
                const container = document.querySelector(`#route-${this.sanitizeForId(routeName)} .dispatch-buttons-container`);
                if (container) {
                    this.changeDispatchOrder(routeName, 'manual', container);
                }
            }
        });
        this.refreshDispatchLog();
    },
    dragEnd(e) {
        if (this.state.s2_draggedCell) {
            this.state.s2_draggedCell.style.opacity = '1';
            this.state.s2_draggedCell = null;
            this.state.s2_draggedRoute = null;
        }
    },

    toggleRestWorkerEdit(cell, routeName, dateString, idx) {
        if (cell.classList.contains('edit-mode')) return;
        document.querySelectorAll('.rest-worker-cell.edit-mode').forEach(el => el.classList.remove('edit-mode'));
        cell.classList.add('edit-mode');
        cell.querySelector('input').focus();
    },

    saveRestWorker(input, routeName, dateString, idx) {
        const newVal = input.value.trim();
        const cell = input.closest('.rest-worker-cell');
        
        DataManager.updateS2Data(s2_data => {
            if (!s2_data[dateString]) s2_data[dateString] = {};
            if (!s2_data[dateString][routeName]) s2_data[dateString][routeName] = {};

            const routeContainer = document.querySelector(`.route-section[data-route-name="${routeName}"]`);
            const allInputs = routeContainer.querySelectorAll('.rest-worker-input');
            
            let newRestList = [];
            allInputs.forEach((inp, i) => {
                if (i === idx) newRestList.push(newVal);
                else newRestList.push(inp.value.trim());
            });
            s2_data[dateString][routeName].manual_rest_list = newRestList;
        });

        cell.classList.remove('edit-mode');
        cell.querySelector('span').textContent = newVal;
    },

    toggleHolidayWorkerEdit(cell) {
        if (cell.classList.contains('edit-mode')) return;
        document.querySelectorAll('.s2-holiday-cell.edit-mode').forEach(el => el.classList.remove('edit-mode'));
        cell.classList.add('edit-mode');
        const input = cell.querySelector('input');
        input.focus();
        input.select();
    },

    saveHolidayWorker(input) {
        const newVal = input.value.trim();
        const cell = input.closest('.s2-holiday-cell');
        const routeName = cell.dataset.routeName;
        const carNum = cell.dataset.carNumber;
        const dateString = cell.dataset.dateString;
        const shift = cell.dataset.shift; 
        
        const routeId = this.sanitizeForId(routeName);
        const dbKey = `holiday_worker_${routeId}_${carNum}_${shift}`;
        
        DataManager.updateS2Data(s2_data => {
            if (!s2_data[dateString]) s2_data[dateString] = {};
            if (!s2_data[dateString][routeName]) s2_data[dateString][routeName] = {};
            if (!s2_data[dateString][routeName][carNum]) s2_data[dateString][routeName][carNum] = {};
            
            s2_data[dateString][routeName][carNum][dbKey] = newVal;
        });
        
        cell.classList.remove('edit-mode');
        cell.querySelector('span').textContent = newVal;
    },
    
    getTodayS1Schedule(routeData, dateString, dayOfWeek) {
        if (!routeData) return {};
        
        const todaySchedule = {};
        const VEHICLE_COLS = routeData.vehicleColumns || [];

        VEHICLE_COLS.forEach(colId => {
            if (colId === '미입력') return;
            
            let resultAm = { text: '', bold: false };
            let resultPm = { text: '', bold: false };

            const recurringKey = `${dayOfWeek}-${colId}`;
            if (routeData.fixedSchedule && routeData.fixedSchedule[recurringKey]) {
                for (const entry of routeData.fixedSchedule[recurringKey]) {
                    if (new Date(dateString) >= new Date(entry.dateString)) {
                        let names = entry.names;
                        const workType = routeData.workTypeConfig[colId] || 'normal';
                        if (workType === 'biweekly') {
                            const startObj = new Date(entry.dateString);
                            const currentObj = new Date(dateString);
                            
                            const diffTime = currentObj - startObj;
                            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                            const weeksPassed = Math.floor(diffDays / 7);

                            if (weeksPassed % 2 !== 0) {
                                names = [entry.names[1], entry.names[0]];
                            }
                        }
                        resultAm = names[0];
                        resultPm = names[1];
                        break;
                    }
                }
            }

            if (routeData.tempSchedule && routeData.tempSchedule[dateString] && routeData.tempSchedule[dateString][colId]) {
                resultAm = routeData.tempSchedule[dateString][colId][0];
                resultPm = routeData.tempSchedule[dateString][colId][1];
            }

            todaySchedule[colId] = [resultAm, resultPm];
        });
        return todaySchedule;
    },

    getRestWorkersList(routeData, dateString) {
        if (!routeData) return [];
        
        const restList = [];
        const targetDate = new Date(dateString);
        const dayOfWeek = targetDate.getDay();
        const VEHICLE_COLS = routeData.vehicleColumns || [];

        const workingWorkers = new Set(); 

        VEHICLE_COLS.forEach(colId => {
            if (colId === '미입력') return;

            let fixedAm = '', fixedPm = '';
            const recurringKey = `${dayOfWeek}-${colId}`;
            
            if (routeData.fixedSchedule && routeData.fixedSchedule[recurringKey]) {
                for (const entry of routeData.fixedSchedule[recurringKey]) {
                    if (new Date(dateString) >= new Date(entry.dateString)) {
                        let names = entry.names;
                        const workType = routeData.workTypeConfig[colId] || 'normal';
                        if (workType === 'biweekly') {
                            const startObj = new Date(entry.dateString);
                            const currentObj = new Date(dateString);
                            
                            const diffTime = currentObj - startObj;
                            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                            const weeksPassed = Math.floor(diffDays / 7);

                            if (weeksPassed % 2 !== 0) {
                                names = [entry.names[1], entry.names[0]];
                            }
                        }
                        fixedAm = (names[0].text || '').trim();
                        fixedPm = (names[1].text || '').trim();
                        break;
                    }
                }
            }

            let actualAm = fixedAm;
            let actualPm = fixedPm;
            
            if (routeData.tempSchedule && routeData.tempSchedule[dateString] && routeData.tempSchedule[dateString][colId]) {
                actualAm = (routeData.tempSchedule[dateString][colId][0].text || '').trim();
                actualPm = (routeData.tempSchedule[dateString][colId][1].text || '').trim();
            }

            if (actualAm && !['휴무', '월차', '년차', '퇴직자', '미입력'].includes(actualAm)) workingWorkers.add(actualAm);
            if (actualPm && !['휴무', '월차', '년차', '퇴직자', '미입력'].includes(actualPm)) workingWorkers.add(actualPm);

            const checkAndAdd = (fixed, actual) => {
                if (!fixed || fixed === '휴무') return; 
                if (actual === '월차') restList.push(`${fixed} (월차)`);
                else if (actual === '년차') restList.push(`${fixed} (년차)`);
                else if (actual === '퇴직자') restList.push(`${fixed} (퇴직)`);
                else if (actual && actual !== fixed && actual !== '휴무') {
                    restList.push(fixed); 
                }
            };
            checkAndAdd(fixedAm, actualAm);
            checkAndAdd(fixedPm, actualPm);
        });

        const detectedSpares = new Set();
        for (let i = -3; i <= 3; i++) {
            const d = new Date(targetDate);
            d.setDate(d.getDate() + i);
            const scanDateStr = DataManager.getTodayDateString(d); 
            const scanDay = d.getDay();

            VEHICLE_COLS.forEach(colId => {
                if (colId === '미입력') return;
                let scanAm = { text: '', bold: false };
                let scanPm = { text: '', bold: false };
                if (routeData.tempSchedule && routeData.tempSchedule[scanDateStr] && routeData.tempSchedule[scanDateStr][colId]) {
                    scanAm = routeData.tempSchedule[scanDateStr][colId][0];
                    scanPm = routeData.tempSchedule[scanDateStr][colId][1];
                } else {
                    const rKey = `${scanDay}-${colId}`;
                    if (routeData.fixedSchedule && routeData.fixedSchedule[rKey]) {
                        for (const entry of routeData.fixedSchedule[rKey]) {
                            if (new Date(scanDateStr) >= new Date(entry.dateString)) {
                                let names = entry.names;
                                const workType = routeData.workTypeConfig[colId] || 'normal';
                                if (workType === 'biweekly') {
                                    const startObj = new Date(entry.dateString);
                                    const currentObj = new Date(scanDateStr);
                                    
                                    const diffTime = currentObj - startObj;
                                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                                    const weeksPassed = Math.floor(diffDays / 7);

                                    if (weeksPassed % 2 !== 0) {
                                        names = [entry.names[1], entry.names[0]];
                                    }
                                }
                                scanAm = names[0];
                                scanPm = names[1];
                                break;
                            }
                        }
                    }
                }
                [scanAm, scanPm].forEach(worker => {
                    if (worker && worker.text && worker.bold === true && !['휴무', '미입력', '월차', '년차', '퇴직자'].includes(worker.text.trim())) {
                        detectedSpares.add(worker.text.trim());
                    }
                });
            });
        }

        detectedSpares.forEach(name => {
            if (!workingWorkers.has(name)) {
                const isAlreadyListed = restList.some(entry => entry.includes(name));
                if (!isAlreadyListed) restList.push(`(스페)${name}`);
            }
        });

        return [...new Set(restList)].sort();
    }
};
 /* ================================================================= */
/* [Section 3] 차량 정비 일지 모듈 */
/* ================================================================= */

const S3_Module = {
    ui: {
        title: document.getElementById('s3_title'),
        dateInput: document.getElementById('s3_datePicker'),
        dateDisplay: document.getElementById('s3_dateDisplay_text'),
        prevDayBtn: document.getElementById('s3_prevDate'),
        nextDayBtn: document.getElementById('s3_nextDate'),
        
        tbody: document.querySelector('#maintenanceForm tbody'),
        addRowBtn: document.getElementById('s3-addRow'),
        
        showAllBtn: document.getElementById('s3-showAll'),
        backupBtn: document.getElementById('s3-backupFile'),
        restoreBtn: document.getElementById('s3-triggerRestore'),
        restoreFile: document.getElementById('s3_restoreFile'),
        clearFormBtn: document.getElementById('s3-clearForm'),
        printBtn: document.getElementById('s3-printPage'),
        
        calcBtn: document.getElementById('s3-showCalculator'),
        calcModal: document.getElementById('s3_calculatorModal'),
        calcStart: document.getElementById('s3_startDate'),
        calcEnd: document.getElementById('s3_endDate'),
        calcActionBtn: document.getElementById('s3-calculatePrices'),
        calcTotal: document.getElementById('s3_totalPrice'),
        calcCloseBtn: document.getElementById('s3-closeCalculator'),

        marginLeftSelect: document.getElementById('s3_marginLeft'),
        marginRightSelect: document.getElementById('s3_marginRight'),
        fontSizeSelect: document.getElementById('s3_fontSizeInput')
    },

    state: {
        currentDate: null
    },

    initialize() {
        console.log("S3: 초기화 시작");
        this.bindEventListeners();
        
        // 오늘 날짜 설정
        const today = new Date();
        this.state.currentDate = DataManager.getTodayDateString(today);
        this.updateDateDisplay();
        
        DataManager.subscribe(this);
        DataManager.loadS3Data();
        this.loadDataForDate(this.state.currentDate);
    },

    bindEventListeners() {
        // 날짜 네비게이션
        this.ui.prevDayBtn.onclick = () => this.changeDate(-1);
        this.ui.nextDayBtn.onclick = () => this.changeDate(1);
        
        // 날짜 직접 선택 (텍스트 클릭 시 데이트피커 동작)
        this.ui.dateDisplay.onclick = () => {
            this.ui.dateInput.showPicker ? this.ui.dateInput.showPicker() : this.ui.dateInput.click();
        };
        this.ui.dateInput.onchange = (e) => {
            if (e.target.value) {
                this.state.currentDate = e.target.value;
                this.updateDateDisplay();
                this.loadDataForDate(this.state.currentDate);
            }
        };

        // 기능 버튼
        this.ui.showAllBtn.onclick = () => S1_Module.showAllSections();
        this.ui.addRowBtn.onclick = () => this.addNewRow();
        this.ui.printBtn.onclick = () => this.printPage();
        this.ui.clearFormBtn.onclick = () => {
            if(confirm("현재 보고 있는 날짜의 내용을 모두 지우시겠습니까?")) {
                this.clearCurrentForm();
                this.saveData();
            }
        };

        // 백업 및 복구
        this.ui.backupBtn.onclick = () => this.backupData();
        this.ui.restoreBtn.onclick = () => this.ui.restoreFile.click();
        this.ui.restoreFile.onchange = (e) => {
            if (e.target.files.length > 0) this.restoreData(e.target.files[0]);
        };

        // 스타일 조정
        this.ui.marginLeftSelect.onchange = (e) => {
            document.documentElement.style.setProperty('--s3-print-margin-left', e.target.value + 'mm');
        };
        this.ui.marginRightSelect.onchange = (e) => {
            document.documentElement.style.setProperty('--s3-print-margin-right', e.target.value + 'mm');
        };
        this.ui.fontSizeSelect.onchange = (e) => {
            document.documentElement.style.setProperty('--s3-font-size-base', e.target.value + 'pt');
            document.documentElement.style.setProperty('--s3-print-font-size', e.target.value + 'pt');
        };

        // 가격 계산기 모달
        this.ui.calcBtn.onclick = () => {
            this.ui.calcStart.value = this.state.currentDate;
            this.ui.calcEnd.value = this.state.currentDate;
            this.ui.calcTotal.textContent = "0원";
            this.ui.calcModal.style.display = 'block';
        };
        this.ui.calcCloseBtn.onclick = () => this.ui.calcModal.style.display = 'none';
        this.ui.calcActionBtn.onclick = () => this.calculateTotalPrice();

        // 폼 내부 입력 감지 (자동 저장)
        this.ui.tbody.addEventListener('change', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                if (e.target.name && e.target.name.startsWith('price_')) {
                    this.formatPriceInput(e.target);
                }
                this.saveData();
            }
        });

        // 텍스트박스 자동 높이 조절
        this.ui.tbody.addEventListener('input', (e) => {
            if (e.target.tagName === 'TEXTAREA' && e.target.classList.contains('auto-resize')) {
                this.autoResize(e.target);
            }
        });
    },

    onDataChanged(event, payload) {
        // S1 데이터 변경 시 차량 목록 업데이트 필요할 수 있음
        if (event === 's1_data_changed') {
            const dateStr = this.state.currentDate;
            if (dateStr) this.loadDataForDate(dateStr);
        }
    },

    changeDate(offset) {
        const curr = new Date(this.state.currentDate);
        curr.setDate(curr.getDate() + offset);
        this.state.currentDate = DataManager.getTodayDateString(curr);
        this.updateDateDisplay();
        this.loadDataForDate(this.state.currentDate);
    },

    updateDateDisplay() {
        const d = new Date(this.state.currentDate);
        const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
        this.ui.dateDisplay.textContent = `${d.getFullYear()}년 ${d.getMonth() + 1}월 ${d.getDate()}일 (${dayNames[d.getDay()]})`;
        this.ui.dateInput.value = this.state.currentDate;
    },

    clearCurrentForm() {
        // 기본 10줄은 유지하고 내용만 비움, 추가된 줄은 삭제
        const rows = Array.from(this.ui.tbody.querySelectorAll('tr'));
        rows.forEach(tr => {
            if (tr.classList.contains('s3_added-row')) {
                tr.remove();
            } else {
                tr.querySelectorAll('input, textarea').forEach(el => el.value = '');
                tr.querySelectorAll('select').forEach(el => el.value = '');
                tr.querySelectorAll('.vehicle-display').forEach(el => el.textContent = '');
                tr.querySelectorAll('textarea').forEach(el => this.autoResize(el));
            }
        });
    },

    loadDataForDate(dateString) {
        this.clearCurrentForm();
        const s3_data = DataManager.loadS3Data();
        const dailyData = s3_data[dateString] || {};
        const { routes } = DataManager.data.s1;

        // 노선 선택 옵션 채우기 (모든 select 박스)
        const routeOptions = Object.keys(routes);
        const routeSelects = this.ui.tbody.querySelectorAll('.s3_routeSelect_row');
        
        routeSelects.forEach(select => {
            const currentVal = select.value;
            select.innerHTML = '<option value="">선택</option>';
            routeOptions.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                opt.textContent = r;
                select.appendChild(opt);
            });
            select.value = currentVal; // 값 복원 시도 (빈 값이면 선택 안됨)
            
            // 이벤트 리스너: 노선 변경 시 차량 목록 갱신
            select.onchange = (e) => this.updateVehicleSelect(e.target);
        });

        // 저장된 데이터 불러오기
        Object.keys(dailyData).forEach(key => {
            // key 예: item_1_1, price_1_2, route_1_3 ...
            // 동적 행(added row) 처리
            const parts = key.split('_');
            if (parts.length >= 3) {
                const rowIdx = parseInt(parts[1]); // 1 (1st group), 2 (2nd group), or index for added rows
                const colIdx = parseInt(parts[2]); // 1~6
                
                // form-table 구조상 name 속성으로 매핑
                let input = this.ui.tbody.querySelector(`[name="${key}"]`);
                
                // 만약 input이 없으면 동적 행일 수 있음 (추가 구현 필요하거나, 기본 로직상 10줄 이내)
                // *Ver 6.0.11에서는 기본 10줄(1_1 ~ 2_4) + 추가 행 방식
                // 추가 행 데이터 로딩 로직
                if (!input && key.startsWith('added_')) {
                    // 추가된 행 데이터 로딩 (구조가 복잡해지므로 단순화: 여기서는 기본 10줄 위주로 처리하고, 추가 행은 별도 저장소 로직 필요)
                    // 현재 구조에서는 name 기반 매핑이므로, 
                    // 만약 저장된 키가 기본 폼에 없다면 행을 생성해야 함.
                    // (이 예제에서는 기본 10줄 외 데이터는 'added_rows' 배열로 관리하는 것이 일반적이나, 
                    //  기존 코드가 name 기반 개별 저장이라면 아래 로직 사용)
                } 

                if (input) {
                    input.value = dailyData[key];
                    if (input.tagName === 'TEXTAREA') this.autoResize(input);
                    if (input.name.startsWith('route_')) {
                        this.updateVehicleSelect(input, dailyData[`vehicle_${parts[1]}_${parts[2]}`]);
                    }
                    if (input.name.startsWith('price_')) {
                         this.formatPriceInput(input);
                    }
                }
            }
        });
        
        // 추가된 행 데이터 로드 (별도 키 'extra_rows' 사용 권장)
        if (dailyData.extra_rows && Array.isArray(dailyData.extra_rows)) {
            dailyData.extra_rows.forEach(rowData => {
                this.addNewRow(rowData);
            });
        }
    },

    updateVehicleSelect(routeSelect, savedVehicleVal = null) {
        const cell = routeSelect.parentElement;
        const vehicleSelect = cell.querySelector('.s3_vehicleSelect_row');
        const displayDiv = cell.querySelector('.vehicle-display');
        const routeName = routeSelect.value;
        
        vehicleSelect.innerHTML = '';
        vehicleSelect.style.display = 'none';
        displayDiv.textContent = '';
        
        if (!routeName) return;
        
        const { routes } = DataManager.data.s1;
        const routeData = routes[routeName];
        if (!routeData) return;

        const vehicles = (routeData.vehicleColumns || []).filter(v => v && v !== '미입력');
        // 정렬
        const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
        vehicles.sort(collator.compare);

        if (vehicles.length === 0) return;

        vehicleSelect.style.display = 'block';
        vehicleSelect.innerHTML = '<option value="">차량선택</option>';
        vehicles.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            vehicleSelect.appendChild(opt);
        });

        if (savedVehicleVal) vehicleSelect.value = savedVehicleVal;

        // 차량 선택 시 디스플레이 업데이트 및 저장
        vehicleSelect.onchange = () => {
             displayDiv.textContent = vehicleSelect.value;
             this.saveData();
        };
        
        // 초기 로딩 시 디스플레이 설정
        if (vehicleSelect.value) displayDiv.textContent = vehicleSelect.value;
    },

    saveData() {
        const data = {};
        const inputs = this.ui.tbody.querySelectorAll('input, textarea, select');
        inputs.forEach(el => {
            if (el.name && !el.closest('.s3_added-row')) {
                data[el.name] = el.value;
            }
        });

        // 추가된 행 별도 저장
        const extraRows = [];
        this.ui.tbody.querySelectorAll('tr.s3_added-row').forEach(tr => {
            const rowData = {};
            tr.querySelectorAll('input, textarea, select').forEach(el => {
                const className = el.className; // route, vehicle, item 등 클래스 활용
                if (className.includes('s3_routeSelect_row')) rowData.route = el.value;
                else if (className.includes('s3_vehicleSelect_row')) rowData.vehicle = el.value;
                else if (el.name.startsWith('item')) rowData.item = el.value;
                else if (el.name.startsWith('detail')) rowData.detail = el.value;
                else if (el.name.startsWith('parts')) rowData.parts = el.value;
                else if (el.name.startsWith('price')) rowData.price = el.value;
                else if (el.name.startsWith('worker')) rowData.worker = el.value;
            });
            extraRows.push(rowData);
        });
        data.extra_rows = extraRows;

        DataManager.updateS3Data(s3_data => {
            s3_data[this.state.currentDate] = data;
        });
    },

    addNewRow(rowData = null) {
        const tr = document.createElement('tr');
        tr.className = 'entry-row s3_added-row';
        
        // 랜덤 ID 생성하여 name 충돌 방지 (혹은 단순 인덱스)
        const uid = Date.now() + Math.floor(Math.random() * 1000);
        
        tr.innerHTML = `
            <td class="route-select-cell">
                <select class="header-select s3_routeSelect_row no-print"></select>
                <select class="header-select s3_vehicleSelect_row no-print" style="display: none;"></select>
                <div class="vehicle-display"></div>
            </td>
            <td><textarea name="item_add_${uid}" class="auto-resize"></textarea></td>
            <td><textarea name="detail_add_${uid}" class="auto-resize"></textarea></td>
            <td><textarea name="parts_add_${uid}" class="auto-resize"></textarea></td>
            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_add_${uid}" class="price-input" /></div></td>
            <td>
                <textarea name="worker_add_${uid}" class="auto-resize" style="width:80%; display:inline-block;"></textarea>
                <button type="button" class="no-print" onclick="this.closest('tr').remove(); S3_Module.saveData();" style="color:red; border:none; background:none; font-weight:bold; cursor:pointer;">X</button>
            </td>
        `;
        
        this.ui.tbody.insertBefore(tr, this.ui.tbody.lastElementChild); // tfoot 이전에 추가 (tfoot이 있다면)
        // 만약 tfoot이 tbody 안에 없다면 appendChild
        if (this.ui.tbody.querySelector('tfoot')) {
             // tfoot은 보통 tbody 밖에 있지만, 여기 구조상 tbody 안에 있다면
        } else {
             this.ui.tbody.appendChild(tr);
        }

        // 노선 select 초기화
        const routeSelect = tr.querySelector('.s3_routeSelect_row');
        const { routes } = DataManager.data.s1;
        routeSelect.innerHTML = '<option value="">선택</option>';
        Object.keys(routes).forEach(r => {
            const opt = document.createElement('option');
            opt.value = r; opt.textContent = r;
            routeSelect.appendChild(opt);
        });
        
        routeSelect.onchange = (e) => this.updateVehicleSelect(e.target);

        // 데이터 채우기 (복구 시)
        if (rowData) {
            routeSelect.value = rowData.route || '';
            this.updateVehicleSelect(routeSelect, rowData.vehicle);
            tr.querySelector(`[name^="item"]`).value = rowData.item || '';
            tr.querySelector(`[name^="detail"]`).value = rowData.detail || '';
            tr.querySelector(`[name^="parts"]`).value = rowData.parts || '';
            tr.querySelector(`[name^="price"]`).value = rowData.price || '';
            tr.querySelector(`[name^="worker"]`).value = rowData.worker || '';
            
            // 높이 조절
            tr.querySelectorAll('textarea').forEach(t => this.autoResize(t));
        }
    },

    autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    },

    formatPriceInput(input) {
        let val = input.value.replace(/[^0-9]/g, '');
        if (val) {
            val = parseInt(val).toLocaleString('ko-KR');
            input.value = val;
        }
    },

    calculateTotalPrice() {
        const start = new Date(this.ui.calcStart.value);
        const end = new Date(this.ui.calcEnd.value);
        if (start > end) { alert("시작일이 종료일보다 큽니다."); return; }

        const s3_data = DataManager.loadS3Data();
        let total = 0;
        let reportHTML = `<html><head><title>정비 내역서</title>
        <style>table{width:100%;border-collapse:collapse;}th,td{border:1px solid #333;padding:5px;font-size:12px;}th{background:#eee;}</style>
        </head><body><h2 style="text-align:center;">차량 정비 및 부품 내역서</h2>
        <p style="text-align:center;">기간: ${this.ui.calcStart.value} ~ ${this.ui.calcEnd.value}</p>
        <table><thead><tr><th>날짜</th><th>노선/차량</th><th>항목</th><th>부품내역</th><th>금액</th></tr></thead><tbody>`;

        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const dateStr = DataManager.getTodayDateString(d);
            const data = s3_data[dateStr];
            if (data) {
                // 기본 행 처리
                Object.keys(data).forEach(key => {
                    if (key.startsWith('price_')) {
                        const priceStr = data[key];
                        if (priceStr) {
                            const price = parseInt(priceStr.replace(/[^0-9]/g, '')) || 0;
                            if (price > 0) {
                                total += price;
                                // 관련 정보 찾기 (같은 접미사)
                                const suffix = key.replace('price_', '');
                                const route = data[`route_${suffix}`] || '';
                                const vehicle = data[`vehicle_${suffix}`] || '';
                                const item = data[`item_${suffix}`] || '';
                                const parts = data[`parts_${suffix}`] || '';
                                
                                reportHTML += `<tr><td>${dateStr}</td><td>${route} ${vehicle}</td><td>${item}</td><td>${parts}</td><td style="text-align:right;">${price.toLocaleString()}원</td></tr>`;
                            }
                        }
                    }
                });
                
                // 추가 행 처리
                if (data.extra_rows) {
                    data.extra_rows.forEach(row => {
                         const price = parseInt((row.price||'').replace(/[^0-9]/g, '')) || 0;
                         if (price > 0) {
                             total += price;
                             reportHTML += `<tr><td>${dateStr}</td><td>${row.route||''} ${row.vehicle||''}</td><td>${row.item||''}</td><td>${row.parts||''}</td><td style="text-align:right;">${price.toLocaleString()}원</td></tr>`;
                         }
                    });
                }
            }
        }
        
        reportHTML += `</tbody><tfoot><tr><th colspan="4" style="text-align:right;">총 합계</th><th style="text-align:right;color:red;">${total.toLocaleString()}원</th></tr></tfoot></table></body></html>`;

        this.ui.calcTotal.textContent = total.toLocaleString() + "원";
        
        const popup = window.open('', '_blank', 'width=800,height=600');
        popup.document.write(reportHTML);
        popup.document.close();
    },

    backupData() {
        const data = DataManager.data.s3;
        const json = JSON.stringify(data);
        const dateStr = this.state.currentDate.replace(/-/g, '');
        const blob = new Blob([json], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `정비일지(S3)_백업_${dateStr}.json`;
        a.click();
    },

    restoreData(file) {
        if (!confirm("정비일지 데이터를 복구하시겠습니까? 현재 데이터는 덮어쓰여집니다.")) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const loaded = JSON.parse(e.target.result);
                DataManager.updateS3Data(s3_data => {
                    Object.keys(s3_data).forEach(k => delete s3_data[k]);
                    Object.assign(s3_data, loaded);
                });
                this.loadDataForDate(this.state.currentDate);
                alert("정비일지가 복구되었습니다.");
            } catch(err) {
                alert("파일 형식이 올바르지 않습니다.");
                console.error(err);
            }
            this.ui.restoreFile.value = '';
        };
        reader.readAsText(file);
    },

    printPage() {
        document.body.classList.remove('printing-section1', 'printing-section2');
        document.body.classList.add('printing-section3');
        
        // 인쇄 전 textarea 높이 재조정 (확실하게 하기 위함)
        this.ui.tbody.querySelectorAll('textarea').forEach(el => this.autoResize(el));
        
        const handleAfterPrint = () => {
            document.body.classList.remove('printing-section3');
            window.removeEventListener('afterprint', handleAfterPrint);
        };
        window.addEventListener('afterprint', handleAfterPrint);
        window.print();
    }
};

/* ================================================================= */
/* [공통] 초기화 로직 */
/* ================================================================= */

document.addEventListener('DOMContentLoaded', () => {
    // 1. 각 모듈 초기화
    S1_Module.initialize();
    S2_Module.initialize();
    S3_Module.initialize();

    // 2. 탭 전환 로직
    const showS1Btn = document.getElementById('s1-showS1'); 
    // 네비게이션 버튼 (S2, S3에서 S1으로 돌아가는 버튼 등)
    // S2에는 s2-showAll, S3에는 s3-showAll 버튼이 있으며 이는 S1_Module.showAllSections()를 호출함.
    
    // 버전 정보 표시 (선택 사항)
    if (typeof S1_Module.setVersion === 'function') {
        S1_Module.setVersion();
    }
});
</script>
</body>
</html>
