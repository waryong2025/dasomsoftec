<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>통합 근무 관리 시스템 (현황표 + 승무일지 + 정비일지)</title>
    
    <style>
        /* ================================================================= */
        /* [공통] Global Styles */
        /* ================================================================= */
        :root {
            /* S3 폰트 크기 변수 (px로 변경) */
            --s3-font-size-base: 16px; 
            --s3-print-font-size: 11pt; /* 인쇄는 pt 유지 */
            
            /* S3 인쇄 여백 CSS 변수 */
            --s3-print-margin-top: 10mm;
            --s3-print-margin-bottom: 10mm;
            --s3-print-margin-left: 10mm;
            --s3-print-margin-right: 10mm;

            /* S1 폰트 크기 변수 (px로 변경) */
            --worker-font-size: 14px; /* 11pt -> 14px */
            /* S1 인쇄 여백 CSS 변수 */
            --print-margin-left: 10mm;
            --print-margin-right: 10mm;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            background-color: #e9ecef; /* 배경색 변경 */
            color: #333;
            font-size: 16px; /* 14pt -> 16px */
        }

        /* 상단 버전 헤더바 */
        #header-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 5px 10px;
            background-color: #f8f9fa; /* 컨트롤박스 배경과 비슷하게 */
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 10px; /* #section1과의 간격 */
            border-radius: 8px;
        }
        #header-logo {
            height: 24px; 
            width: auto;
            margin-right: 8px;
        }
        #version-display {
            font-size: 13px; /* 10pt -> 13px */
            font-weight: bold;
            color: #555;
        }

        .divider {
            margin: 40px 0;
            border: 2px solid #0056b3;
        }


        /* ================================================================= */
        /* [Section 1] 근무 현황표 Styles */
        /* ================================================================= */
        
        #section1 .controls {
            background-color: #fff;
            padding: 15px; border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            align-items: stretch; 
        }

        #section1 .controls fieldset {
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 10px 15px;
            margin: 0;
            background: linear-gradient(145deg, #ffffff, #f0f0f5);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 300px; 
            display: flex;
            flex-direction: column;
            gap: 10px; 
            transition: transform 0.2s;
        }
        
        #section1 .controls fieldset:hover {
             box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
             transform: translateY(-2px);
        }

        #section1 .controls fieldset legend {
            font-weight: bold;
            font-size: 1.2em;
            color: #0056b3;
            padding: 2px 10px;
            border-radius: 4px;
            background-color: #eaf4ff;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        #section1 .controls .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
        }
        #section1 .controls label { font-weight: bold;
            margin-right: 5px; white-space: nowrap; }
        #section1 .controls input[type="text"],
        #section1 .controls input[type="number"], 
        #section1 .controls select {
            padding: 6px;
            border: 1px solid #a8c8e1; 
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        #section1 .controls input[type="number"] { width: 70px;
        }
        
        #section1 .controls input#companyInput {
            flex: 1 1 auto;
            min-width: 150px;
        }
        #section1 .controls select#typeSelect {
            flex: 1 1 auto;
            min-width: 150px;
        }
        
        #section1 .controls select { flex-grow: 1;
            min-width: 120px; }

        #section1 #vehicleInputsContainer {
            display: flex;
            flex-wrap: wrap; 
            gap: 5px;
            width: 100%;
            margin-top: 5px;
            padding: 5px;
            background: #e9f0f6; 
            border-radius: 4px;
            border: 1px solid #cfe2f3;
            max-height: 180px;
            overflow-y: auto;
        }
        #section1 #vehicleInputsContainer input {
            width: 80px;
            font-size: 0.9em;
            padding: 4px;
        }

        #section1 .controls select.margin-select {
            width: 35px;
            min-width: 35px;
            padding: 1px 3px;
            font-size: 0.85em; 
            flex-grow: 0;
        }
        
        #section1 .controls button,
        #section1 .controls select.action-select,
        #section1 .controls select.work-type-select,
        #section1 .controls select.vehicle-select {
            padding: 8px 15px;
            color: white; border: none; border-radius: 4px;
            cursor: pointer; font-size: 17.5px;
            text-decoration: none; display: inline-block;
            text-align: center; white-space: nowrap;
            width: auto;
            flex-grow: 0; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        
        #section1 .controls button { background-color: #007bff;
        }
        #section1 .controls button:hover { background-color: #0056b3;
        }
        #section1 .controls button.btn-danger { background-color: #dc3545;
        }
        #section1 .controls button.btn-danger:hover { background-color: #c82333;
        }
        
        #section1 .controls select.action-select { background-color: #28a745;
        }
        #section1 .controls select.work-type-select { background-color: #ffc107; color: #333;
        }
        #section1 .controls select.vehicle-select { background-color: #6c757d;
        }
        
        #section1 .controls select.route-navigate-select {
            padding: 8px 15px;
            font-size: 17.5px;
            background-color: #17a2b8; 
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            flex-grow: 1;
        }

        #section1 .holiday-option-group {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 5px;
            align-items: center;
            border: 1px solid #b3e5fc;
        }
        #section1 .holiday-option-group select {
            padding: 4px;
            font-size: 0.9em;
            flex-grow: 0; 
            width: 100px;
        }

        #section1 #scheduleContainer {
            background-color: white;
            padding: 10px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 90%;
            overflow-x: auto;
            border-radius: 8px;
            box-sizing: border-box; 
        }
        
        #section1 table {
            width: 100%;
            min-width: 100%; 
            border-collapse: collapse;
            margin: 0 auto; font-size: 0.9em; background-color: #fff; table-layout: fixed;
        }
        #section1 th, #section1 td {
            border: 1px solid #ddd;
            padding: 5px; 
            text-align: center;
            vertical-align: middle; 
            line-height: 1.2; 
            word-break: keep-all;
            height: 38px; box-sizing: border-box;
            font-size: 16px; /* 13pt -> 16px */
        }
        #section1 th { background-color: #f2f2f2; font-weight: bold;
        }
        #section1 caption {
            font-size: 1.5em;
            margin-bottom: 10px; font-weight: bold;
            color: #333; text-decoration: underline;
        }
        
        #section1 .sunday { background-color: initial !important;
        }
        #section1 .saturday { background-color: initial !important;
        }
        #section1 .holiday { 
            background-color: initial !important;
            font-weight: bold; 
            color: #cc0000;
        }
        
        #section1 .holiday td:not(:nth-child(1)):not(:nth-child(2)) {
            color: #333;
            font-weight: normal;
        }
        
        #section1 .sub-day-info {
            display: block;
            font-size: 0.5em; 
            line-height: 1.2;
            font-weight: bold;
            color: inherit; 
        }
        
        #section1 .day-cell-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1em;
        }
        
        #section1 .day-name-main {
            font-weight: bold;
            font-size: 1.2em; 
            line-height: 1.2;
        }
        
        #section1 .edit-mode {
            position: relative;
            padding: 2px; display: flex; flex-direction: column;
            justify-content: center; height: 100%;
            vertical-align: middle;
        }
        #section1 .edit-mode input {
            width: calc(100% - 8px);
            margin-bottom: 2px;
            padding: 2px; box-sizing: border-box;
        }
        #section1 .edit-mode .cell-buttons { display: flex;
            justify-content: space-around; margin-top: 2px; }
            
        #section1 .edit-mode .cell-buttons button {
            padding: 3px 5px;
            font-size: 0.7em; 
            color: white; 
            border: none;
            border-radius: 3px; 
            cursor: pointer; 
            white-space: nowrap;
            transition: background-color: 0.15s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            flex-grow: 1; 
            margin: 0 1px;
        }
        
        #section1 .edit-mode .cell-buttons button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        #section1 .edit-mode .cell-buttons .btn-fixed { background-color: #007bff;
        }
        #section1 .edit-mode .cell-buttons .btn-fixed:hover:not(:disabled) { background-color: #0056b3;
        }
        #section1 .edit-mode .cell-buttons .btn-temp { background-color: #28a745;
        }
        #section1 .edit-mode .cell-buttons .btn-temp:hover { background-color: #1e7e34;
        }
        #section1 .edit-mode .cell-buttons .btn-highlight-am { background-color: #6f42c1;
        }
        #section1 .edit-mode .cell-buttons .btn-highlight-am:hover { background-color: #5a349c;
        }
        #section1 .edit-mode .cell-buttons .btn-highlight-pm { background-color: #fd7e14;
        }
        #section1 .edit-mode .cell-buttons .btn-highlight-pm:hover { background-color: #db6a0b;
        }
        #section1 .edit-mode .cell-buttons .btn-delete { background-color: #dc3545;
        }
        #section1 .edit-mode .cell-buttons .btn-delete:hover { background-color: #c82333;
        }


        #section1 .name-entry { 
            display: block;
            margin-top: 2px; 
            margin-bottom: 2px; 
            color: inherit; 
            font-size: var(--worker-font-size); 
        }
        #section1 .hidden-x { color: white;
        }
        #section1 .name-entry.bold-name {
            font-weight: bold;
        }
        #section1 table th:nth-child(1),
        #section1 table td:nth-child(1),
        #section1 table th:nth-child(2),
        #section1 table td:nth-child(2) {
            width: 4%;
            min-width: 60px;
            vertical-align: middle; 
        }

        /* [Section 1] 컨트롤 박스 UI 개선 */
        #section1 .controls input[type="number"] {
            padding: 8px; 
            font-size: 1em;
        }
        #section1 .controls input#yearInput {
            width: 90px;
        }
        #section1 .controls fieldset:nth-of-type(1) .control-group:nth-of-type(3) button {
            flex: 1 1 auto; 
        }
        #section1 .controls fieldset:nth-of-type(3) .control-group {
            flex-direction: column;
            align-items: stretch;
        }
        #section1 .controls fieldset:nth-of-type(3) .control-group > * {
            margin-bottom: 5px;
        }
        #section1 .controls fieldset:nth-of-type(3) .control-group > *:last-child {
            margin-bottom: 0;
        }
        #section1 .controls fieldset:nth-of-type(3) .control-group:nth-of-type(2) {
            flex-direction: row; 
            align-items: center;
            gap: 10px; 
        }
        #section1 .controls fieldset:nth-of-type(3) .control-group:nth-of-type(2) > select {
            flex: 1 1 auto; 
            margin-bottom: 0; 
        }
        #section1 .controls fieldset:nth-of-type(4) .control-group:not(:first-of-type) {
             flex-direction: column;
            align-items: stretch;
        }
        #section1 .controls fieldset:nth-of-type(4) .control-group:not(:first-of-type) > * {
            margin-bottom: 5px;
        }
        #section1 .controls .control-group[style*="border-top"] {
            flex-direction: row; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        #section1 .controls .control-group[style*="border-top"] > div[style*="flex-direction: row"] {
            flex-direction: row !important; 
            align-items: center !important; 
            gap: 10px !important; 
            margin-left: 10px !important; 
            flex-wrap: wrap; 
        }
        #section1 .controls select.margin-select {
            width: 60px; 
            min-width: 60px;
            padding: 4px; 
            font-size: 0.95em; 
        }

        @media screen and (max-width: 1400px) {
            #section1 .controls {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        @media screen and (max-width: 768px) {
            
            #section1 #scheduleContainer {
                max-width: 100%;
                margin: 10px 0; 
            }
            
            #section1 .controls {
                grid-template-columns: 1fr;
            }
            #section1 .controls .control-group { 
                flex-direction: column; 
                align-items: stretch;
            }
            #section1 .controls input[type="text"], 
            #section1 .controls input[type="number"], 
            #section1 .controls select,
            #section1 .controls input#companyInput, 
            #section1 .controls select#typeSelect { 
                width: 100%;
                flex-basis: auto;
            }
            
            #section1 table { 
                min-width: 100%;
                font-size: 0.8em; 
            }
            /* === [수정됨] === */
            #section1 th, #section1 td {
                padding: 3px;
                height: 30px;
                font-size: 13px !important; /* 10pt -> 13px */
            }
            #section1 .day-name-main { font-size: 1.0em; }
            /* === [수정됨] === */
            #section1 .name-entry { font-size: 12px !important; } /* 9pt -> 12px */
        }
        /* ================================================================= */
        /* [Section 2] 승무 일지 Styles */
        /* ================================================================= */

        #section2 {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px; 
            color: #333;
            font-size: 12px; /* 9pt -> 12px */
        }

        #section2 .journal-container {
            background-color: white;
            padding: 15px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            max-width: 90%;
            margin: 10px auto;
            overflow-x: auto;
            box-sizing: border-box;
        }

        #section2 .header-title {
            text-align: center;
            font-size: 1.88em; 
            font-weight: bold;
            color: #0056b3;
            padding-bottom: 4px;
            margin-bottom: 4px;
            border-bottom: 2px solid #0056b3;
        }

        #section2 .title-area {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            margin: 8px 0 10px 0;
            padding: 0 5px; 
            flex-wrap: wrap; /* [수정] 모바일에서 줄바꿈 허용 */
            gap: 10px; /* [수정] 요소 간 간격 */
        }

        #section2 .title-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        #section2 .main-title {
            font-size: 1.44em; 
            font-weight: bold;
            color: #333;
            display: inline-block;
        }
        
        #section2 .date-display {
            font-size: 1em; 
            color: #666;
            margin-top: 2px;
        }
        
        #section2 .options-right {
            display: flex;
            align-items: center;
            flex-wrap: wrap; /* [수정] 모바일에서 줄바꿈 허용 */
            gap: 10px; 
            justify-content: flex-end; /* [수정] 우측 정렬 */
            flex-grow: 1; /* [수정] 남은 공간 차지 */
        }
        
        #section2 .font-selector-container {
            font-size: 0.94em; 
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        #section2 .font-selector-container label {
            margin-right: 3px;
            font-weight: normal;
        }
        
        #section2 #font-size-select {
            padding: 1px 3px;
            font-size: 1em;
            height: 20px;
        }
        
        /* === [수정] 출차순서 및 순환주기 === */
        #section2 .dispatch-buttons-container {
            display: flex;
            align-items: center;
            font-size: 0.94em; 
            border: 1px solid #ced4da;
            border-radius: 3px;
            padding: 2px;
            white-space: nowrap; /* [추가] */
        }
        
        /* [추가] 순환주기 컨테이너 */
        #section2 .dispatch-cycle-container {
             font-size: 0.94em; 
             white-space: nowrap;
             display: flex; /* [추가] */
             align-items: center; /* [추가] */
             border: 1px solid #ced4da; /* [추가] */
             border-radius: 3px; /* [추가] */
             padding: 2px; /* [추가] */
        }
        #section2 .dispatch-cycle-container label {
             margin: 0 8px;
             font-weight: normal;
             color: #333;
        }
        #section2 .dispatch-cycle-select {
            padding: 3px; 
            font-size: 1em; 
            border: 1px solid #ced4da; 
            border-radius: 3px;
            height: 25px; /* 버튼과 높이 맞춤 */
            vertical-align: middle; /* [추가] */
        }
        /* === [수정 끝] === */

        #section2 .dispatch-buttons-container label {
            margin: 0 8px;
            font-weight: normal;
            color: #333;
        }

        #section2 .dispatch-button {
            padding: 3px 6px;
            margin-left: -1px; 
            font-size: 1em; 
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ced4da;
            border-radius: 0;
            cursor: pointer;
            transition: background-color: 0.1s;
        }

        #section2 .dispatch-button:first-of-type {
            border-top-left-radius: 2px;
            border-bottom-left-radius: 2px;
            margin-left: 0;
        }
        #section2 .dispatch-button:last-of-type {
            border-top-right-radius: 2px;
            border-bottom-right-radius: 2px;
        }

        #section2 .dispatch-button:hover {
            background-color: #e2e6ea;
        }

        #section2 .dispatch-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            z-index: 1; 
        }

        #section2 .print-button {
            padding: 4px 10px; 
            font-size: 0.94em;
            font-weight: bold;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            white-space: nowrap; /* [추가] */
        }

        #section2 .print-button:hover {
            background-color: #0056b3;
        }
        
        #section2 .date-header {
            display: none;
        }

        #section2 .route-section {
            margin-bottom: 15px; 
            border: 1px solid #ced4da;
            border-radius: 4px;
            overflow: hidden;
        }
        
        #section2 .route-header-flex {
            display: flex;
            justify-content: space-between; 
            align-items: flex-start; /* [수정] 상단 정렬 */
            flex-wrap: wrap; /* [수정] 줄바꿈 허용 */
            gap: 5px; /* [수정] 요소 간 간격 */
            background-color: #e6f7ff;
            padding: 5px 8px;
            border-bottom: 1px solid #ced4da;
        }
        
        #section2 .route-title-group {
            display: flex;
            align-items: center;
            flex-shrink: 0; /* [추가] 줄어들지 않음 */
        }

        #section2 .route-name-text {
            font-size: 1.22em; 
            font-weight: bold;
            color: #0056b3;
            white-space: nowrap; 
            padding-right: 15px; 
        }
        
        #section2 .load-button-container {
            display: flex;
            align-items: center;
        }
        #section2 .load-button {
            background-color: #38b43d; 
            color: white;
            border: none;
            padding: 3px 8px;
            margin-left: 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.88em;
            white-space: nowrap;
        }
        #section2 .load-button:hover {
            background-color: #2e8b34;
        }

        #section2 .schedule-options {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            flex-wrap: wrap; /* [수정] 줄바꿈 허용 */
        }

        #section2 .schedule-options select {
            font-size: 1em;
            height: 20px;
            padding: 0 2px;
            margin: 2px 0;
            box-sizing: border-box;
            vertical-align: middle;
        }

        #section2 .schedule-options input[type="number"] {
            width: 30px; 
            height: 18px; 
            text-align: center;
            font-size: 0.9em;
            padding: 0;
            margin: 0 1px;
            border: 1px solid #ccc;
        }

        #section2 .am-options, #section2 .pm-options {
            border: 1px solid #ddd;
            padding: 3px 5px;
            background-color: #f7f9fb;
            border-radius: 3px;
            white-space: nowrap; /* [추가] */
        }

        #section2 .am-options span, #section2 .pm-options span {
            font-weight: bold;
        }
        
        #section2 .settings-controls {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding-top: 5px; 
            flex-shrink: 0; /* [추가] */
        }

        #section2 .setting-button {
            padding: 3px 5px;
            font-size: 0.88em;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 3px;
            white-space: nowrap;
            transition: background-color: 0.1s;
        }

        #section2 .apply-button {
            background-color: #d4edda; 
            border-color: #c3e6cb;
        }

        #section2 .apply-button:hover {
            background-color: #c3e6cb;
        }

        #section2 .reset-button {
            background-color: #f8d7da; 
            border-color: #f5c6cb;
        }

        #section2 .reset-button:hover {
            background-color: #f5c6cb;
        }
        
        #section2 table { 
            width: 100%; 
            border-collapse: collapse;
            table-layout: fixed; 
            font-size: 0.88em; 
            background-color: #fff;
        }

        #section2 th, #section2 td { 
            border: 1px solid #ddd;
            padding: 2px 1px; 
            text-align: center;
            vertical-align: middle;
            height: 20px; 
            box-sizing: border-box;
            line-height: 1.1;
            position: relative;
        }

        #section2 th {
            background-color: #e9ecef;
            font-weight: bold;
            color: #333;
        }
        
        #section2 .car-number-cell {
            font-weight: bold;
            font-size: 1.136em; 
            cursor: pointer;
            padding: 0;
        }

        #section2 .car-display {
            padding: 2px 1px;
            height: 100%;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #section2 .car-controls {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #fff;
            padding: 1px;
            box-sizing: border-box;
            gap: 1px;
            z-index: 10;
            border: 2px solid #ffc107; 
        }

        #section2 .car-controls select {
            width: 95%;
            font-size: 0.8em;
            padding: 0;
            margin: 0;
            height: 14px;
        }

        #section2 .car-controls button {
            width: 48%;
            font-size: 0.7em;
            padding: 0;
            margin: 0;
            height: 14px;
            line-height: 1;
            box-sizing: border-box;
            border: 1px solid #ccc;
            cursor: pointer;
            background-color: #f0f0f0;
        }

        #section2 .car-controls div {
            display: flex;
            justify-content: space-between;
            width: 95%;
            margin-top: 1px;
        }
        
        #section2 .journal-table th:nth-child(1),
        #section2 .journal-table th:nth-child(9) {
            font-size: 1.136em; 
        }
        
        #section2 input[type="number"], #section2 input[type="text"] {
            font-size: 1em; 
            padding: 0;
            margin: 0;
            width: 100%;
            height: 18px; 
            box-sizing: border-box;
            border: 1px solid #ccc;
            text-align: center;
            -moz-appearance: textfield;
        }
        
        #section2 .journal-table colgroup col:nth-child(1), #section2 .journal-table colgroup col:nth-child(9) { width: 5.4%; } 
        #section2 .journal-table colgroup col:nth-child(8), #section2 .journal-table colgroup col:nth-child(16) { width: 5.4%; } 
        #section2 .journal-table colgroup col:nth-child(2), #section2 .journal-table colgroup col:nth-child(3), #section2 .journal-table colgroup col:nth-child(4), 
        #section2 .journal-table colgroup col:nth-child(5), #section2 .journal-table colgroup col:nth-child(6), #section2 .journal-table colgroup col:nth-child(7), 
        #section2 .journal-table colgroup col:nth-child(10), #section2 .journal-table colgroup col:nth-child(11), #section2 .journal-table colgroup col:nth-child(12),
        #section2 .journal-table colgroup col:nth-child(13), #section2 .journal-table colgroup col:nth-child(14), #section2 .journal-table colgroup col:nth-child(15) { width: 5.4%; }
        
        #section2 .driver-name {
            box-sizing: border-box;
            width: 100%;
            padding: 0;
            margin: 0;
            border: none;
            background: transparent;
            text-align: center;
            line-height: 1.1em; 
            min-height: 18px; 
            cursor: pointer;
            display: block;
        }
        
        #section2 .driver-input {
            resize: none; 
            height: 18px; 
            overflow: hidden;
            border: 1px solid #007bff; 
            background-color: #fff !important;
            font-size: 1em;
            box-sizing: border-box;
            width: 100%;
            padding: 0;
            margin: 0;
            text-align: center;
        }

        #section2 .edit-controls {
            display: flex;
            justify-content: center;
            gap: 2px;
            padding: 1px 0;
            margin-top: -1px; 
        }
        
        #section2 .edit-controls button {
            flex-grow: 1;
            padding: 0;
            margin: 0;
            font-size: 0.8em;
            height: 18px;
            line-height: 1;
            cursor: pointer;
            border-radius: 2px;
            border: 1px solid #ccc;
        }
        
        #section2 .edit-controls button:first-child { background-color: #f44336; color: white; border-color: #d32f2f; }
        #section2 .edit-controls button:last-child { background-color: #4CAF50; color: white; border-color: #388e3c; }

        #section2 .hidden {
            display: none !important;
        }
        
        @media screen and (max-width: 768px) {
            #section2 .journal-container {
                max-width: 100%;
                margin: 10px 0; 
                padding: 5px; 
            }
            /* === [수정됨] === */
            #section2 {
                font-size: 11px !important; /* 8pt -> 11px */
            }
            #section2 .options-right {
                gap: 5px;
                flex-wrap: wrap; 
                justify-content: flex-end;
            }
            #section2 .print-button {
                padding: 3px 6px;
                font-size: 1em;
            }
            #section2 .dispatch-buttons-container label {
                margin: 0 4px;
            }
            #section2 th, #section2 td {
                height: 30px;
                padding: 2px 0;
            }
            #section2 input[type="number"], #section2 input[type="text"],
            #section2 .s2-work-hours-select,
            #section2 .driver-input,
            #section2 .driver-name {
                height: 16px;
                font-size: 0.95em;
            }
        }

        #section2 .s2-work-hours-select {
            font-size: 1em; 
            padding: 0;
            margin: 0;
            width: 100%;
            height: 18px; 
            box-sizing: border-box;
            border: 1px solid #ccc;
            text-align: center;
            background-color: white; 
            -moz-appearance: none; 
            -webkit-appearance: none; 
            appearance: none;
        }
        
        /* ================================================================= */
        /* [Section 3] 정비일지 Styles */
        /* ================================================================= */
        
        #section3 {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 10px; 
            color: #333;
            font-size: var(--s3-font-size-base); 
        }
        #section3 .maintenance-container {
            max-width: 900px; 
            margin: 18px auto;
            background: #fff;
            padding: 10px;
            border: 1px solid #000;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            box-sizing: border-box;
        }
        
        #section3 header {
            display: flex;
            flex-wrap: wrap; 
            align-items: center; 
        }
        #section3 header h1 {
            flex-basis: 100%; 
            text-align: center; 
            order: -1; 
            margin-bottom: 10px;
            font-size: 20px;
            margin-top: 6px;
        }
        #section3 .controls {
            flex-basis: 100%; 
            display: flex;
            gap: 8px;
            flex-wrap: wrap; 
            justify-content: flex-end; 
            align-items: center; 
        }
        
        #section3 button {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #fff;
            cursor: pointer;
            font-size: 16px; /* 13pt -> 16px */
        }
        #section3 button.primary {
            background: #007bff;
            color: #fff;
            border-color: #007bff;
        }
        #section3 button.success {
            background: #28a745;
            color: #fff;
        }
        #section3 button.warning {
            background: #ffc107;
            color: #333;
        }

        #section3 .margin-control-group {
            display: flex;
            flex-direction: row; 
            align-items: center; 
            gap: 6px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        #section3 .margin-control-group > label {
            font-size: 14px; /* 11pt -> 14px */
            font-weight: bold;
            margin-right: 5px;
        }
        #section3 .margin-control {
            display: flex;
            flex-direction: column; 
            align-items: center; 
        }
        #section3 .margin-control label {
            font-size: 12px; /* 9pt -> 12px */
            font-weight: bold;
            color: #333;
        }
        #section3 .margin-select {
            width: 45px;
            font-size: 13px; /* 10pt -> 13px */
            padding: 1px;
            border: 1px solid #aaa;
            border-radius: 3px;
        }
        
        #section3 .form-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            border: 1px solid #000; 
            table-layout: fixed; 
        }
        #section3 .form-table td, #section3 .form-table th {
            border: 1px solid #000; 
            padding: 6px;
            vertical-align: middle;
            font-size: calc(var(--s3-font-size-base) * 0.9);
            height: 28px;
            box-sizing: border-box;
            word-break: break-all; 
        }
        #section3 .form-table thead th {
            text-align: center;
            border-top-width: 1px; 
        }
        
        #section3 .route-col { width: 15%; } /* 노선/차량 */
        #section3 .item-col { width: 20%; } /* 항목 */
        #section3 .detail-col { width: 20%; } /* 정비내역 */
        #section3 .parts-col { width: 15%; } /* 부품내역 */
        #section3 .price-col { width: 15%; } /* 부품가격 */
        #section3 .worker-col { width: 15%; } /* 기타 */
        #section3 .date-col { width: auto; }
        
        
        #section3 .route-select-cell {
            vertical-align: top !important; 
            padding: 4px !important;
        }
        #section3 .header-select {
            font-size: 11px; 
            padding: 2px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 3px;
        }
        #section3 .vehicle-display {
            font-weight: bold;
            font-size: 12px;
            color: #0056b3;
            margin-top: 4px;
            height: 1.2em; 
        }
        
        #section3 input[type=text], #section3 input[type=number], #section3 textarea, #section3 select {
            width: 100%;
            box-sizing: border-box;
            border: none;
            outline: none;
            font-size: 14px; /* 11pt -> 14px */
            color: #000; 
            background: transparent;
            resize: none;
        }
        #section3 textarea.auto-resize {
            overflow-y: hidden;
            min-height: 28px;
            line-height: 1.4;
        }
        
        /* [수정됨] .price-input 스타일 */
        #section3 .price-input {
            text-align: right;
            width: 100%; 
            padding-right: 20px; /* "원" 글자가 들어갈 공간 확보 */
            box-sizing: border-box; 
        }

        /* [수정됨] 입력칸과 "원" 글자를 감쌀 컨테이너 */
        #section3 .price-wrapper {
            position: relative;
            width: 100%;
        }

        /* [수정됨] "원" 글자를 입력칸 위에 겹치게 하는 스타일 */
        #section3 .price-wrapper::after {
            content: "원";
            position: absolute;
            top: 50%;
            right: 5px; /* 입력칸 안쪽 우측 여백 */
            transform: translateY(-50%);
            color: #555; /* 글자 색상 */
            pointer-events: none; /* "원" 글자가 클릭되는 것을 방지 */
        }

        #section3 .s3_added-row {
            background-color: #f0f8ff; /* AliceBlue */
        }
        
        /* ================================== */
        /* [수정됨] S3 모바일 스타일 추가 */
        /* ================================== */
        @media screen and (max-width: 768px) {
            #section3 .maintenance-container {
                max-width: 100%;
                padding: 5px;
                margin: 10px 0;
                /* 테이블이 넘칠 경우 좌우 스크롤 허용 */
                overflow-x: auto; 
                box-sizing: border-box;
            }
            #section3 header .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 5px;
            }
            #section3 header .controls > * {
                width: 100%;
                box-sizing: border-box;
            }
            #section3 .form-table {
                font-size: 12px; /* 모바일 폰트 크기 축소 */
                min-width: 800px; /* 테이블 최소 너비 보장 (스크롤용) */
            }
            #section3 .form-table td, #section3 .form-table th {
                padding: 4px;
            }
            #section3 input[type=text], #section3 input[type=number], #section3 textarea, #section3 select {
                 font-size: 12px;
            }
        }


        /* ================================================================= */
        /* [공통] 인쇄 스타일 (S1, S2, S3 통합) */
        /* ================================================================= */
        @media print {
            
            /* [수정됨] 인쇄가 안 되는 문제 수정 */
            #header-bar,
            #s2_restoreDateModal, #s3_restoreDateModal, #s3_calculatorModal {
                display: none !important;
            }

            /* * [수정된 핵심 로직] 
             * 기본적으로 아무것도 숨기지 않습니다.
             * 대신 JS가 body에 클래스를 추가하면, '다른' 섹션들을 숨깁니다.
             * 이렇게 하면 인쇄할 섹션이 display:none 이었다가 block으로 바뀌는 
             * '레이스 컨디션' 자체가 발생하지 않습니다.
             */

            /* S1 인쇄 시: S2, S3, 구분선 숨기기 */
            body.printing-section1 #section2,
            body.printing-section1 #section3,
            body.printing-section1 .divider {
                display: none !important;
            }

            /* S2 인쇄 시: S1, S3, 구분선 숨기기 */
            body.printing-section2 #section1,
            body.printing-section2 #section3,
            body.printing-section2 .divider {
                display: none !important;
            }

            /* S3 인쇄 시: S1, S2, 구분선 숨기기 */
            body.printing-section3 #section1,
            body.printing-section3 #section2,
            body.printing-section3 .divider {
                display: none !important;
            }
            
            /* [수정 끝] */

            /* ... (S1, S2, S3 개별 인쇄 스타일은 그대로 둠) ... */
            
            /* S1 컨트롤 숨기기 */
            body.printing-section1 #section1 .controls {
                display: none !important;
            }
            
            /* ----- S1 인쇄 규칙 ----- */
            body.printing-section1 @page {
                size: A4;
                margin: 10mm;
                margin-left: var(--print-margin-left, 15mm);
                margin-right: var(--print-margin-right, 5mm);
            }
            body.printing-section1 { background-color: white;
                margin: 0; padding: 0; -webkit-print-color-adjust: exact; }
            
            body.printing-section1 .controls { display: none;
            }
            body.printing-section1 #scheduleContainer { box-shadow: none; margin: 0;
                padding: 0; }
            body.printing-section1 #section1 caption {
                font-size: 1.0em; 
                margin-bottom: 5px; 
            }
            body.printing-section1 #section1 table { 
                width: 100%;
                min-width: unset; 
                font-size: 0.8em; 
                border: 1px solid #000; 
                table-layout: fixed;
                page-break-inside: auto;
            }
            body.printing-section1 #section1 tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            body.printing-section1 #section1 th, 
            body.printing-section1 #section1 td { padding: 1px;
                height: auto; word-break: break-all; vertical-align: top; border: 1px solid #000;
            }
            
            body.printing-section1 #section1 table th:nth-child(1), 
            body.printing-section1 #section1 table td:nth-child(1),
            body.printing-section1 #section1 table th:nth-child(2), 
            body.printing-section1 #section1 table td:nth-child(2) { 
                width: 4%;
                vertical-align: middle; 
            }
            
            body.printing-section1 #section1 .sub-day-info { font-size: 0.5em;
            } 
            body.printing-section1 #section1 .day-name-main { font-size: 1em;
            }
            
            body.printing-section1 #section1 .sunday { background-color: initial !important;
            }
            body.printing-section1 #section1 .saturday { background-color: initial !important;
            }
            body.printing-section1 #section1 .holiday { 
                background-color: initial !important;
                font-weight: bold; 
                color: #cc0000; 
            }
            body.printing-section1 #section1 .holiday td:not(:nth-child(1)):not(:nth-child(2)) {
                color: #000;
                font-weight: normal;
            }

            /* ----- S2 인쇄 규칙 ----- */
            body.printing-section2 @page {
                size: A4 landscape;
                margin: 6mm; 
            }
            body.printing-section2 { 
                background-color: white; 
                padding: 0; 
                margin: 0; 
                font-size: 9pt;
                color: #000;
            }
            body.printing-section2 #section2 .journal-container {
                box-shadow: none;
                border-radius: 0;
                padding: 0;
                margin: 0;
                max-width: 100%;
            }
            
            /* [수정] 순환주기 컨트롤 인쇄 시 숨김 */
            body.printing-section2 #section2 .dispatch-cycle-container,
            body.printing-section2 #section2 .print-button, 
            body.printing-section2 #section2 .font-selector-container, 
            body.printing-section2 #section2 .dispatch-buttons-container,
            body.printing-section2 #section2 .driver-input, 
            body.printing-section2 #section2 .edit-controls, 
            body.printing-section2 #section2 .schedule-options, 
            body.printing-section2 #section2 .load-button-container,
            body.printing-section2 #section2 .car-controls,
            body.printing-section2 #section2 .settings-controls {
                         display: none !important;
            }
            
            body.printing-section2 #section2 table { 
                font-size: 7pt; 
                border-collapse: collapse !important; 
                border: 1px solid #000 !important; 
            }
            body.printing-section2 #section2 th, 
            body.printing-section2 #section2 td { 
                height: 16px;
                padding: 1px 0px; 
                border: 1px solid #000 !important; 
            }
            
            body.printing-section2 #section2 .header-title, 
            body.printing-section2 #section2 .main-title, 
            body.printing-section2 #section2 .route-name-text { color: #000 !important;
            }
            
            body.printing-section2 #section2 .route-header-flex { background-color: #eee !important;
                border-bottom: 1px solid #000 !important; }
            
            body.printing-section2 #section2 input[type="number"], 
            body.printing-section2 #section2 input[type="text"] {
                border: none;
                background: transparent;
                padding: 0;
                height: auto;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            
            body.printing-section2 #section2 .s2-work-hours-select {
                border: none;
                background: transparent;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                padding: 0; 
                height: auto;
            }

            body.printing-section2 #section2 .driver-name, 
            body.printing-section2 #section2 .car-display {
                display: flex !important;
                justify-content: center;
                align-items: center;
                border: none !important;
                cursor: default;
                height: 100%;
                width: 100%;
            }
            body.printing-section2 #section2 .car-number-cell {
                padding: 2px 1px;
            }

            /* S3 인쇄 규칙 */
            body.printing-section3 #section3 .maintenance-container {
                max-width: 100%;
                border: none;
                box-shadow: none;
                margin: 0;
                padding: 0;
            }
            body.printing-section3 #section3 .form-table {
                font-size: var(--s3-print-font-size);
                border: 2px solid #000 !important; 
            }
            body.printing-section3 #section3 .form-table td, 
            body.printing-section3 #section3 .form-table th {
                border: 1px solid #000 !important;
                padding: 4px !important; 
                height: auto !important; 
                vertical-align: top; 
            }
            body.printing-section3 #section3 input, 
            body.printing-section3 #section3 textarea {
                border: none !important;
                background: transparent !important;
                font-size: calc(var(--s3-print-font-size) * 0.9) !important;
                height: auto !important;
                overflow: visible !important;
                color: #000 !important; 
            }
            
            /* S3 인쇄 시 '원' 글자 숨기기 */
            body.printing-section3 #section3 .price-wrapper::after {
                display: none;
            }
            body.printing-section3 #section3 .price-input {
                padding-right: 0; /* 인쇄 시 여백 제거 */
            }

            body.printing-section3 #section3 .no-print,
            body.printing-section3 #section3 .header-select {
                display: none !important;
            }
            
            body.printing-section3 #section3 .vehicle-display {
                font-size: 11px !important; 
                color: #000 !important; 
                height: auto !important;
                margin-top: 0;
            }
            
            body.printing-section3 @page { 
                size: A4 portrait; 
                margin-top: var(--s3-print-margin-top);
                margin-bottom: var(--s3-print-margin-bottom);
                margin-left: var(--s3-print-margin-left);
                margin-right: var(--s3-print-margin-right);
            }
        }
    </style>
</head>
<body>

    <div id="header-bar">
        <img id="header-logo" src="https://raw.githubusercontent.com/waryong2025/dasomsoftec/main/dasom.png" alt="DasomSoftec">
        <span id="version-display">Ver 4.8.5</span> </div>


    <div id="section1">
        <div class="controls">

            <fieldset>
                <legend>회사 / 노선 정보</legend>
                
                <div class="control-group">
                   <label for="companyInput">회사명:</label>
                    <input type="text" id="companyInput" placeholder="예: 와룡운수">
                </div>

                <div class="control-group">
                    <label for="typeSelect">버스 종류 선택:</label>
                       <select id="typeSelect">
                        <option value="마을">마을</option>
                        <option value="버스">버스</option>
                    </select>
                </div>
  
               
                <div class="control-group">
                    <label for="routeInput">노선 번호:</label>
                    <input type="text" id="routeInput" placeholder="예: 종로08">
                    <button id="s1-addOrUpdateRoute">노선 추가/수정</button>
                    <button id="s1-deleteRoute" class="btn-danger">선택 노선 삭제</button>
                </div>
                
                 <div class="control-group">
                    <label for="routeNavigateSelect">관련 노선 이동:</label>
                   <select id="routeNavigateSelect" class="route-navigate-select"></select>
                </div>
    
             </fieldset>

            <fieldset>
                <legend>조회 설정</legend>
                <div class="control-group">
                    <label for="yearInput">년도:</label>
                     <input type="number" id="yearInput" value="2025">
                    <label for="monthInput">월:</label>
                    <input type="number" id="monthInput" value="10" min="1" max="12">
                    
                    <button id="s1-generateSchedule">생성</button>
                </div>
                 <div class="control-group">
                    <input type="radio" id="option1" name="displayOption" value="1">
                    <label for="option1">1일 ~ 15일</label>
                   
                    <input type="radio" id="option2" name="displayOption" value="2" checked>
                    <label for="option2">16일 ~ 말일</label>
                </div>
                <div class="control-group holiday-option-group">
                    <label for="holidaySelect">법정휴무일:</label>
                
                    <select id="holidaySelect">
                         <option value="apply">적용</option>
                        <option value="ignore">미적용</option>
                    </select>
                </div>
         
               
                <div class="control-group" style="border-top: 1px solid #dee2e6; padding-top: 10px; margin-top: 5px;">
                    <button id="s1-printPage">인쇄</button>
                    
                    <div style="display: flex; flex-direction: row; gap: 10px; margin-left: 5px; align-items: flex-start; flex-grow: 1;">

                        <div style="display: flex; flex-direction: column; gap: 4px; align-items: stretch; padding: 2px 5px; border: 1px solid #ced4da; border-radius: 4px; background-color: #f8f9fa; flex-shrink: 0;">
                            
                            <div style="display: flex; align-items: center; gap: 2px; font-size: 0.9em; justify-content: space-between;">
                                <label for="marginLeftSelect">좌측:</label>
                                <select id="marginLeftSelect" class="margin-select">
                                     <option value="0">0</option><option value="10" selected>10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option>
                                </select>
                            </div>
                         
    
                            <div style="display: flex; align-items: center; gap: 2px; font-size: 0.9em; justify-content: space-between;">
                                <label for="marginRightSelect">우측:</label>
                                <select id="marginRightSelect" class="margin-select">
                                     <option value="0">0</option><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option>
                                </select>
                            </div>
                         </div>
 
                        <div style="display: flex; align-items: center; gap: 3px; font-size: 0.9em; padding: 2px 5px; background-color: #eaf4ff; border-radius: 4px; border: 1px solid #b3d7ff; flex-grow: 1; white-space: nowrap;">
                           <label for="fontSizeInput" style="font-weight: bold;">글자크기조정:</label>
                           <select id="fontSizeInput" class="margin-select" style="width: 45px; padding: 1px 3px; box-sizing: border-box; font-weight: bold;">
                                <option value="8">8pt</option>
                                <option value="9">9pt</option>
                                <option value="10">10pt</option>
                                <option value="11" selected>11pt</option>
                                <option value="12">12pt</option>
                                <option value="13">13pt</option>
                                <option value="14">14pt</option>
                            </select>
                        </div>

                    </div>
                    
                </div>
              
            </fieldset>

            <fieldset>
                <legend>근무전체데이타관리옵션</legend> <div class="control-group">
                    <select id="scheduleActionsSelect" class="action-select">
                        <option value="">근무전체데이타관리옵션</option> <option value="reset">현재 노선 초기화</option>
                        <option value="backup">전체 데이터 저장</option>
                        <option value="restore">전체 데이터 불러오기</option>
                    </select>
                    <input type="file" id="restoreFile" style="display: none;" accept=".json">
                
    
                    <button id="s1-calculateWorkdays">근무일수계산</button>
                </div>
                
                <div class="control-group">
                     <select id="vehicleSelect" class="vehicle-select">
                          <option value="">차량 선택</option>
                     </select>
                    <select id="workTypeSelect" class="work-type-select">
                         <option value="">근무조건 선택</option>
                         <option value="normal">3/3 근무</option>
                        <option value="biweekly">격주 근무</option>
                        <option value="five_day">5일근무</option> 
                    </select>
                </div>

           
           <div style="border-top: 1px solid #dee2e6; padding-top: 10px; margin-top: 5px;"></div> 
                
                <div class="control-group">
                    <button id="s1-showS2">승무일지 및 배차관리</button>
                    <button id="s1-showS3">차량정비점검일지</button>
           
                </div>
            </fieldset>
            
            <fieldset>
                <legend>차량 설정 (현재 노선)</legend>
                <div class="control-group">
                     <label for="vehicleCountInput">차량 수:</label>
                    <input type="number" id="vehicleCountInput" value="11" min="1" max="50">
                    <button id="s1-saveRouteConfig">차량 번호 저장</button>
                </div>
                <div class="control-group" style="flex-direction: column; align-items: flex-start;">
                    <label>차량 번호 (총 <span id="vehicleCountDisplay">0</span>대):</label>
                    <div id="vehicleInputsContainer">
                        </div>
                </div>
            </fieldset>
  
           
        </div>

        <div id="scheduleContainer">
            <table>
                <caption id="tableCaption">근무 현황표를 생성해주세요.</caption>
                <thead id="scheduleHeader">
                </thead>
         
               <tbody id="scheduleBody">
                </tbody>
            </table>
        </div>
    </div>

    <hr class="divider">

    <div id="section2" style="display: none;">
        <div class="journal-container">

            <div class="header-title">승무일지</div>

             <div class="title-area">
      
                     <div class="title-left">
                    <div class="main-title">승 무 일 지 (일일)</div>
                    <div id="today-date" class="date-display"></div>
                </div>
                
          
                 <div class="options-right">
                    
                    <button type="button" id="s2-showAll" class="print-button" style="background-color: #6c757d;">전체보기</button>
                    
                    <div class="font-selector-container">
                        <label for="font-size-select">글자크기조정:</label>
                        <select id="font-size-select">
                            <option value="8">8pt</option>
                            <option value="9">9pt</option> 
                            <option value="10">10pt</option> 
                            <option value="11" selected>11pt</option> <option value="12">12pt</option>
                            <option value="13">13pt</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 5px;">
                        <button type="button" id="s2-backupLog" class="print-button" style="background-color: #28a745;">일지백업</button>
                        <button type="button" id="s2-showRestoreModal" class="print-button" style="background-color: #fd7e14;">일지복원</button>
                        <input type="file" id="s2_restoreFile" style="display: none;" accept=".json">
                    </div>

                   <button type="button" id="s2-refreshLog" class="print-button" style="background-color: #17a2b8;">새로고침</button>
                   
                   <button id="s2-printPage" class="print-button">인쇄하기</button>
           
                 </div>
            </div>
            
             <div class="date-header">2025년 10월 16일 목요일</div> 

             <div id="dispatch-log-body">
                </div>

   
           </div>
    </div>

    <div id="s2_restoreDateModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <h3 style="margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px;">승무일지 불러오기</h3>
            <p>백업한 '.json' 파일을 선택하세요.</p>
            <p style="color: red; font-weight: bold;">S2(승무일지)의 모든 기존 데이터는 덮어쓰여집니다.</p>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button id="s2_cancelRestoreBtn" type="button" style="padding: 10px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">취소</button>
                <button id="s2_confirmRestoreBtn" type="button" style="padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">파일 선택</button>
            </div>
        </div>
    </div>
    <hr class="divider">

    <div id="section3" style="display: none;">
        <div class="maintenance-container">
            <header>
                <h1 id="s3_title" style="flex-basis: 100%; text-align: center; order: -1; margin-bottom: 10px;">
                    차량정비점검일지 및 작업의뢰서
                </h1>
                <div class="controls no-print">
        
                    <button id="s3-showAll" style="background-color: #6c757d; color: white;">전체보기</button>
                <button id="s3-backupFile" class="primary">일지백업</button> <input type="file" id="s3_restoreFile" style="display: none;" accept=".json">

             <button id="s3-triggerRestore" class="warning">일지복구</button> <button id="s3-showCalculator">부품가격계산</button>
                    <button id="s3-clearForm">폼초기화</button>
                    <button id="s3-printPage" class="primary">인쇄</button> 

                    <div class="margin-control-group no-print">
                        <label>인쇄여백</label>
                        <div class="margin-control">
                            <label for="s3_marginLeft">좌</label>
                            <select id="s3_marginLeft" class="margin-select">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                        <div class="margin-control">
                            <label for="s3_marginRight">우</label>
                            <select id="s3_marginRight" class="margin-select">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 5px; font-size: 13pt;">
                        <label for="s3_fontSizeInput">글자크기:</label>
                        <select id="s3_fontSizeInput" style="width: 50px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="8">8pt</option>
                            <option value="9">9pt</option>
                            <option value="10">10pt</option>
                            <option value="11" selected>11pt</option>
                            <option value="12">12pt</option>
                            <option value="13">13pt</option>
                            <option value="14">14pt</option>
                        </select>
                    </div>

                </div>
            </header>

            <form id="maintenanceForm">
                <table class="form-table">
<colgroup>
            <col class="route-col">  <col class="item-col">   <col class="detail-col"> <col class="parts-col">  <col class="price-col">  <col class="worker-col"> </colgroup>
                    <thead>
                    <tr>
                        <th class="date-col">년/월/일</th>
                        <th colspan="5" id="s3_dateDisplay">날짜 로딩 중...</th>
                    </tr>
                    <tr>
                        <th class="route-col">노선/차량</th>
                        <th class="item-col">항목</th>
                        <th class="detail-col">정비내역</th>
                        <th class="parts-col">부품내역</th>
                        <th class="price-col">부품가격</th>
                        <th class="worker-col">작업자</th>
                    </tr>
                    </thead>
                    <tbody>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_1"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_1" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_1" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_1" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_1" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_1" class="price-input" /></div></td>
                            <td><textarea name="worker_1_1" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_2"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_2" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_2" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_2" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_2" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_2" class="price-input" /></div></td>
                            <td><textarea name="worker_1_2" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_3"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_3" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_3" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_3" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_3" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_3" class="price-input" /></div></td>
                            <td><textarea name="worker_1_3" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_4"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_4" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_4" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_4" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_4" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_4" class="price-input" /></div></td>
                            <td><textarea name="worker_1_4" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_5"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_5" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_5" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_5" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_5" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_5" class="price-input" /></div></td>
                            <td><textarea name="worker_1_5" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_6"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_6" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_6" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_6" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_6" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_6" class="price-input" /></div></td>
                            <td><textarea name="worker_1_6" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_1"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_1" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_1" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_1" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_1" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_1" class="price-input" /></div></td>
                            <td><textarea name="worker_2_1" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_2"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_2" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_2" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_2" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_2" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_2" class="price-input" /></div></td>
                            <td><textarea name="worker_2_2" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_3"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_3" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_3" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_3" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_3" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_3" class="price-input" /></div></td>
                            <td><textarea name="worker_2_3" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_4"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_4" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_4" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_4" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_4" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_4" class="price-input" /></div></td>
                            <td><textarea name="worker_2_4" class="auto-resize"></textarea></td>
                        </tr>
                    </tbody>
                    <tfoot class="no-print">
                        <tr>
                            <td colspan="6" style="text-align: right; padding: 5px;">
                                <button type="button" id="s3-addRow" style="font-size: 11pt; padding: 4px 8px; background-color: #007bff; color: white; border: none;">
                                    행 추가 (+)
                                </button>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </form>

            <p class="thin-text" style="margin-top:8px">사용법: 셀에 내용을 입력한 뒤 'PDF로 저장 / 인쇄' 버튼을 눌러 A4로 저장하세요. 모바일에서는 가로 모드에서 인쇄 결과가 더 잘 맞을 수 있습니다.</p>
        </div>
    </div>

      <div id="s3_calculatorModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <h3 style="margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px;">부품가격 계산기</h3>
            <p>기간을 설정하고 부품 가격 합계를 확인합니다.</p>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                <label>시작일:</label><input type="date" id="s3_startDate" style="flex-grow: 1; padding: 8px;">
                <label>종료일:</label><input type="date" id="s3_endDate" style="flex-grow: 1; padding: 8px;">
                <button id="s3-calculatePrices" style="padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px;">계산</button>
            </div>

            <div style="padding: 10px; border: 1px solid #ddd; background-color: #f8f9fa;">
                <strong>총 합계: <span id="s3_totalPrice" style="color: #dc3545;">0원</span></strong>
            </div>

            <div style="text-align: right; margin-top: 20px;">
                <button id="s3-closeCalculator" style="padding: 10px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">닫기</button>
            </div>
        </div>
    </div>

<script>
        /* ================================================================= */
        /* [공통] 통합 관리자 (DataManager) */
        /* (S1, S2, S3 데이터 동기화 총괄) */
        /* ================================================================= */

        /**
         * 1. 데이터 관리자 (DataManager)
         * - 모든 데이터의 로드, 저장, 수정을 담당합니다.
         * - 데이터 변경 시 "알림(dispatch)"을 보내 S2, S3가 반응하도록 합니다.
         */
        const DataManager = {
            MASTER_KEY: 'busScheduleManagerData', // S1, S2 공유 (근무표)
            S2_LOG_KEY: 'busDispatchLogData',     // S2 전용 (승무일지)
            S3_LOG_KEY: 'busMaintenanceLogData',  // S3 전용 (정비일지)
            
            // 데이터 저장소 (메모리)
            data: {
                s1: { currentRoute: null, routes: {} }, // S1 근무표 데이터
                s2: {}, // S2 승무일지 데이터
                s3: {}  // S3 정비일지 데이터
            },

            // 알림을 받을 모듈(S1, S2, S3)을 등록하는 곳
            listeners: [],

            // 알림 기능: 데이터가 변경되면 등록된 모듈에 알림
            dispatch(event, payload) {
                console.log(`[DataManager] 알림 발생: ${event}`, payload);
                this.listeners.forEach(listener => {
                    if (typeof listener.onDataChanged === 'function') {
                        listener.onDataChanged(event, payload);
                    }
                });
            },

            // 알림 받을 모듈 등록
            subscribe(module) {
                this.listeners.push(module);
            },

            // --- 공통 유틸리티 ---
            saveToStorage(key, value) {
                localStorage.setItem(key, JSON.stringify(value));
            },
            loadFromStorage(key) {
                const data = localStorage.getItem(key);
                try {
                    return JSON.parse(data);
                } catch {
                    return null;
                }
            },

            // --- S1 (근무표) 데이터 관리 ---
            loadS1Data() {
                let storedData = this.loadFromStorage(this.MASTER_KEY);
                if (!storedData || !storedData.routes) {
                    storedData = { currentRoute: null, routes: {} };
                }
                if (!storedData.currentRoute || !storedData.routes[storedData.currentRoute]) {
                    storedData.currentRoute = Object.keys(storedData.routes)[0] || null;
                }
                this.data.s1 = storedData;
                console.log("[DataManager] S1(근무표) 데이터 로드 완료.");
                return this.data.s1;
            },
            saveS1Data() {
                this.saveToStorage(this.MASTER_KEY, this.data.s1);
                console.log("[DataManager] S1(근무표) 데이터 저장 완료.");
                // S1 데이터 변경 시 S2, S3에 알림
                this.dispatch('s1_data_changed', this.data.s1);
            },
            updateS1Data(updaterFunction) {
                updaterFunction(this.data.s1);
                this.saveS1Data();
            },
            getCurrentRouteData() {
                const routeName = this.data.s1.currentRoute;
                if (!routeName) return { routeName: null, routeData: null };
                return {
                    routeName,
                    routeData: this.data.s1.routes[routeName]
                };
            },
            getAllRoutes() {
                return this.data.s1.routes || {};
            },
            setCurrentRoute(routeName) {
                this.data.s1.currentRoute = routeName;
                this.saveS1Data(); // 저장 및 알림(dispatch)
                console.log(`[DataManager] 현재 노선 변경: ${routeName}`);
            },

            // --- S2 (승무일지) 데이터 관리 ---
            loadS2Data() {
                const storedData = this.loadFromStorage(this.S2_LOG_KEY);
                this.data.s2 = storedData || {};
                console.log("[DataManager] S2(승무일지) 데이터 로드 완료.");
                return this.data.s2;
            },
            saveS2Data() {
                this.saveToStorage(this.S2_LOG_KEY, this.data.s2);
                console.log("[DataManager] S2(승무일지) 데이터 저장 완료.");
            },
            updateS2Data(updaterFunction) {
                updaterFunction(this.data.s2);
                this.saveS2Data();
            },

            // --- S3 (정비일지) 데이터 관리 ---
            loadS3Data() {
                const storedData = this.loadFromStorage(this.S3_LOG_KEY);
                this.data.s3 = storedData || {};
                console.log("[DataManager] S3(정비일지) 데이터 로드 완료.");
                return this.data.s3;
            },
            saveS3Data() {
                this.saveToStorage(this.S3_LOG_KEY, this.data.s3);
                console.log("[DataManager] S3(정비일지) 데이터 저장 완료.");
            },
            updateS3Data(updaterFunction) {
                updaterFunction(this.data.s3);
                this.saveS3Data();
            }
        };


        /* ================================================================= */
        /* [Section 1] 근무 현황표 JavaScript */
        /* ================================================================= */

        /**
         * 2. S1(근무 현황표) 모듈
         * - DataManager로부터 데이터를 받아 화면(테이블)을 그립니다.
         * - 노선 추가, 삭제, 근무표 수정 등 S1 데이터를 변경하는 작업을
         * DataManager에 요청합니다.
         */
        const S1_Module = {
            // S1 내부 상태
            state: {
                currentRoute: null,
                currentVehicleColumns: [],
                fixedScheduleData: {},
                tempScheduleData: {},
                workTypeConfig: {},
                scheduleData: {} // 현재 화면에 그려진 데이터 (임시)
            },

            // S1 UI 요소 캐시
            ui: {},

            // 2025년 공휴일 데이터 (이름 포함)
            publicHolidays2025: {
                '01-01': '신정', '01-28': '설날', '01-29': '설날', '01-30': '설날',
                '03-01': '삼일절', '05-05': '어린이날', '05-06': '부처님오신날',
                '06-06': '현충일', '08-15': '광복절', '10-05': '추석',
                '10-06': '추석', '10-07': '추석', '10-09': '한글날', '12-25': '성탄절'
            },

            /**
             * S1 모듈 초기화 (DOM 로드 시 1회 실행)
             */
            initialize() {
                console.log("S1: 초기화 시작");
                // UI 요소 캐시
                this.ui = {
                    companyInput: document.getElementById('companyInput'),
                    typeSelect: document.getElementById('typeSelect'),
                    routeInput: document.getElementById('routeInput'),
                    routeNavigateSelect: document.getElementById('routeNavigateSelect'),
                    yearInput: document.getElementById('yearInput'),
                    monthInput: document.getElementById('monthInput'),
                    holidaySelect: document.getElementById('holidaySelect'),
                    marginLeftSelect: document.getElementById('marginLeftSelect'),
                    marginRightSelect: document.getElementById('marginRightSelect'),
                    fontSizeInput: document.getElementById('fontSizeInput'),
                    scheduleActionsSelect: document.getElementById('scheduleActionsSelect'),
                    restoreFile: document.getElementById('restoreFile'),
                    vehicleSelect: document.getElementById('vehicleSelect'),
                    workTypeSelect: document.getElementById('workTypeSelect'),
                    vehicleCountInput: document.getElementById('vehicleCountInput'),
                    vehicleCountDisplay: document.getElementById('vehicleCountDisplay'),
                    vehicleInputsContainer: document.getElementById('vehicleInputsContainer'),
                    scheduleContainer: document.getElementById('scheduleContainer')
                };

                // 날짜 초기화
                const today = new Date();
                this.ui.yearInput.value = today.getFullYear();
                this.ui.monthInput.value = today.getMonth() + 1;
                const currentDay = today.getDate();
                if (currentDay <= 15) {
                    document.getElementById('option1').checked = true;
                } else {
                    document.getElementById('option2').checked = true;
                }

                // DataManager로부터 S1 데이터 로드
                const s1_data = DataManager.loadS1Data();
                this.state.currentRoute = s1_data.currentRoute;

                // 이벤트 리스너 바인딩
                this.bindEventListeners();

                // 노선 선택 드롭다운 채우기
                this.populateRouteSelect();
                // 현재 노선 데이터 화면에 로드
                this.loadRouteData(this.state.currentRoute);

                // DataManager에 S1 모듈 등록 (S2 등에서 데이터 변경 시 알림 받기 위함)
                DataManager.subscribe(this);

                console.log("S1: 초기화 완료.");
            },

            /**
             * DataManager로부터 알림을 처리하는 함수 (S2/S3에서 데이터 변경 시)
             */
            onDataChanged(event, payload) {
                // S1 데이터가 외부(S2)에서 변경된 경우, S1 화면을 다시 그림
                if (event === 's1_data_changed') {
                    console.log("[S1] S2로부터 데이터 변경 알림 수신. S1 갱신 시작.");
                    const s1_data = payload;
                    this.state.currentRoute = s1_data.currentRoute;
                    this.populateRouteSelect();
                    this.loadRouteData(this.state.currentRoute, true); // true = 갱신 알림
                }
            },

            /**
             * S1의 모든 이벤트 리스너 바인딩
             */
            bindEventListeners() {
                document.getElementById('s1-addOrUpdateRoute').onclick = () => this.addOrUpdateRoute();
                document.getElementById('s1-deleteRoute').onclick = () => this.deleteRoute();
                this.ui.routeNavigateSelect.onchange = (e) => this.handleRouteSelectChange(e.target.value);
                
                document.getElementById('s1-generateSchedule').onclick = () => this.generateSchedule();
                document.getElementById('s1-printPage').onclick = () => this.printPage();
                this.ui.fontSizeInput.onchange = (e) => this.applyFontSize(e.target.value + 'pt');

                this.ui.scheduleActionsSelect.onchange = () => this.handleScheduleActions();
                this.ui.restoreFile.onchange = (e) => this.restoreScheduleData(e.target.files[0]);
                document.getElementById('s1-calculateWorkdays').onclick = () => this.calculateWorkdays();
                this.ui.workTypeSelect.onchange = () => this.handleWorkTypeChange();
                
                this.ui.vehicleCountInput.onchange = (e) => this.handleVehicleCountChange(e.target.value);
                document.getElementById('s1-saveRouteConfig').onclick = () => this.saveRouteConfig();

                document.getElementById('s1-showS2').onclick = () => this.showSection('S2');
                document.getElementById('s1-showS3').onclick = () => this.showSection('S3');
                
                document.addEventListener('click', (e) => this.clearEditMode(e));
            },

            /**
             * [데이터 연동] 노선 목록 드롭다운 채우기
             */
            populateRouteSelect() {
                const { routes } = DataManager.data.s1;
                const routeSelect = this.ui.routeNavigateSelect;
                routeSelect.innerHTML = ''; 
                const routeNames = Object.keys(routes);

                if (routeNames.length === 0) {
                    routeSelect.innerHTML = '<option value="">노선을 추가하세요</option>';
                    return;
                }
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '--- 노선 이동 ---';
                routeSelect.appendChild(defaultOption);

                routeNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    if (name === this.state.currentRoute) {
                        option.selected = true;
                    }
                    routeSelect.appendChild(option);
                });
            },

            /**
             * [데이터 연동] 특정 노선 데이터 로드 (S1 상태 변경)
             */
            loadRouteData(routeName, isRefresh = false) {
                const { routes } = DataManager.data.s1;

                if (!routeName || !routes[routeName]) {
                    // UI 초기화
                    this.ui.routeInput.value = '';
                    this.ui.companyInput.value = '';
                    this.ui.typeSelect.value = '마을';
                    this.ui.vehicleCountInput.value = 0;
                    this.handleVehicleCountChange(0);
                    
                    // S1 내부 상태 초기화
                    this.state.fixedScheduleData = {};
                    this.state.tempScheduleData = {};
                    this.state.workTypeConfig = {};
                    this.state.currentVehicleColumns = [];
                    this.state.currentRoute = null;
                    
                    DataManager.setCurrentRoute(null);
                    
                    this.updateVehicleSelect();
                    if (this.ui.routeNavigateSelect) {
                        this.ui.routeNavigateSelect.value = '';
                    }
                    this.generateSchedule(); 
                    return;
                }

                // DataManager에 현재 노선 설정 요청 (알림 발생)
                // (S2 등에서 발생한 갱신(isRefresh)일 경우는 제외)
                if (!isRefresh) {
                    DataManager.setCurrentRoute(routeName);
                }
                
                this.state.currentRoute = routeName;
                const routeData = routes[routeName];

                // S1 내부 상태 변수 로드
                this.state.fixedScheduleData = routeData.fixedSchedule;
                this.state.tempScheduleData = routeData.tempSchedule;
                this.state.workTypeConfig = routeData.workTypeConfig;
                this.state.currentVehicleColumns = routeData.vehicleColumns || [];

                // S1 컨트롤 UI 업데이트
                this.ui.routeInput.value = routeName;
                this.ui.companyInput.value = routeData.companyName || '';
                this.ui.typeSelect.value = routeData.type || '마을';
                this.ui.vehicleCountInput.value = this.state.currentVehicleColumns.length;

                this.handleVehicleCountChange(this.state.currentVehicleColumns.length);
                this.updateVehicleSelect();
                if (this.ui.routeNavigateSelect) {
                    this.ui.routeNavigateSelect.value = routeName;
                }
                
                // 근무 현황표 다시 그리기
                this.generateSchedule(); 
            },

            /**
             * [데이터 연동] 노선 추가 또는 수정
             * [MODIFIED] - '번' 자동 추가 기능
             */
            addOrUpdateRoute() {
                let routeName = this.ui.routeInput.value.trim(); // 'let'으로 변경
                if (!routeName) {
                    alert('노선 번호를 입력하세요.');
                    return;
                }
                
                // [NEW] 요청: "번" 자동 추가 (예: "종로08" -> "종로08번")
                if (!routeName.endsWith('번')) {
                    routeName += '번';
                    console.log(`[S1] 노선 이름에 '번'이 추가되었습니다: ${routeName}`);
                }
                // [NEW] 수정된 이름(예: "종로08번")을 입력창에 다시 반영
                this.ui.routeInput.value = routeName; 

                const companyName = this.ui.companyInput.value.trim();
                const type = this.ui.typeSelect.value;
                
                // DataManager에 데이터 수정을 요청
                DataManager.updateS1Data(s1_data => {
                    if (!s1_data.routes[routeName]) {
                        // 새 노선 추가
                        
                        // [수정 1] 차량 수를 컨트롤 박스에서 읽어와 기본 차량 목록(예: 차량1, 차량2...)을 생성합니다.
                        const vehicleCount = parseInt(this.ui.vehicleCountInput.value, 10) || 1;
                        const newVehicleColumns = Array.from({ length: vehicleCount }, (_, i) => `차량${i + 1}`);
                        if (newVehicleColumns.length === 0) {
                             newVehicleColumns.push('차량1');
                        }
            
                        s1_data.routes[routeName] = {
                            companyName: companyName,
                            type: type,
                            vehicleColumns: newVehicleColumns, // [수정 1]
                            fixedSchedule: {},
                            tempSchedule: {},
                            workTypeConfig: {}
                        };
                        alert(`새 노선 [${routeName}]이 추가되었습니다. 차량 수(${vehicleCount}대)와 차량 번호를 설정하세요.`);
                    } else {
                        // 기존 노선 정보 업데이트
                        s1_data.routes[routeName].companyName = companyName;
                        s1_data.routes[routeName].type = type;
                        alert(`[${routeName}] 노선 정보 (회사명, 종류)가 수정되었습니다.`);
                    }
                    s1_data.currentRoute = routeName;
                });

                // S1 상태 업데이트 및 UI 갱신 (DataManager가 알림을 보내지만, S1은 즉시 갱신)
                this.state.currentRoute = routeName;
                this.populateRouteSelect(); 
                this.loadRouteData(routeName);
            },

            /**
             * [데이터 연동] 노선 삭제
             */
            deleteRoute() {
                const routeName = this.ui.routeNavigateSelect.value;
                if (!routeName) {
                    alert('삭제할 노선을 [관련 노선 이동] 드롭다운에서 선택하세요.');
                    return;
                }

                if (confirm(`[${routeName}] 노선을 정말로 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`)) {
                    let newRouteToLoad = null;
                    
                    // DataManager에 데이터 수정을 요청
                    DataManager.updateS1Data(s1_data => {
                        delete s1_data.routes[routeName];
                        newRouteToLoad = Object.keys(s1_data.routes)[0] || null;
                        s1_data.currentRoute = newRouteToLoad;
                    });
                    
                    // S1 상태 업데이트 및 UI 갱신
                    this.state.currentRoute = newRouteToLoad;
                    this.populateRouteSelect(); 
                    this.loadRouteData(newRouteToLoad); 
                    
                    alert(`[${routeName}] 노선이 삭제되었습니다.`);
                }
            },

           /**
             * [데이터 연동] 차량 번호 저장
             */
            saveRouteConfig() {
                if (!this.state.currentRoute) {
                    alert('먼저 노선을 선택하거나 추가하세요.');
                    return;
                }

                const inputs = this.ui.vehicleInputsContainer.querySelectorAll('input');
                const newVehicleColumns = [];
                inputs.forEach(input => {
                    // [MODIFIED] 비어있는 값은 '미입력'으로 저장
                    newVehicleColumns.push(input.value.trim() || '미입력');
                });

                // DataManager에 데이터 수정을 요청
                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[this.state.currentRoute];
                    if (routeData) {
                        routeData.vehicleColumns = newVehicleColumns;
                    }
                });
                
                // [MODIFIED] loadRouteData를 호출하여 S1 상태 및 UI 전체 갱신
                this.loadRouteData(this.state.currentRoute);
                
                alert(`[${this.state.currentRoute}] 노선의 차량 번호가 저장되었습니다.`);
            },

            /**
             * (UI) 차량 수 변경 시 입력란 동적 생성
             * [MODIFIED] - '차량X'를 값 대신 placeholder로 사용
             */
            handleVehicleCountChange(countStr) {
                const count = parseInt(countStr) || 0;
                this.ui.vehicleCountDisplay.textContent = count;
                const container = this.ui.vehicleInputsContainer;
                container.innerHTML = ''; 
                container.style.flexDirection = 'row'; 
                container.style.alignItems = 'unset';

                const existingColumns = this.state.currentVehicleColumns || [];
                
                for (let i = 0; i < count; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    const existingValue = existingColumns[i] || '';
                    const defaultPlaceholder = `차량 ${i + 1}`; // 기본 플레이스홀더

                    // [MODIFIED] "차량X", "미입력", "" 인지 확인
                    const isDefaultValue = /^차량\d+$/.test(existingValue);
                    const isNotEntered = (existingValue === '미입력');

                    if (isDefaultValue || isNotEntered || existingValue === '') {
                        // 기본값이거나, "미입력"이거나, 비어있으면 value를 비우고 placeholder를 설정
                        input.value = '';
                        input.placeholder = isNotEntered ? '미입력' : defaultPlaceholder;
                    } else {
                        // "5518" 등 실제 데이터가 있으면 value에 설정
                        input.value = existingValue;
                        input.placeholder = defaultPlaceholder;
                    }
                    
                    // [NEW] 사용자가 클릭(포커스)하면 기존 텍스트를 전체 선택하여 바로 입력할 수 있도록 함
                    input.onfocus = (e) => {
                        e.target.select();
                    };

                    container.appendChild(input);
                }
            },
            
            /**
             * (UI) 차량 선택 드롭다운 업데이트
             */
            updateVehicleSelect() {
                const vehicleSelect = this.ui.vehicleSelect;
                vehicleSelect.innerHTML = '<option value="">차량 선택</option>';
                
                if (this.state.currentVehicleColumns.length > 0) {
                     vehicleSelect.innerHTML += '<option value="ALL_VEHICLES" style="font-weight:bold; background-color:#e0e0e0;">--- 전체차량 ---</option>';
                }

                this.state.currentVehicleColumns.forEach(colName => {
                    if(colName && colName !== '미입력') {
                        const option = document.createElement('option');
                        option.value = colName;
                        option.textContent = colName;
                        vehicleSelect.appendChild(option);
                    }
                });
            },

            /**
             * (Util) 요일 이름 반환
             */
            getDayName(dayOfWeek) {
                return ['일', '월', '화', '수', '목', '금', '토'][dayOfWeek];
            },
            
            /**
             * (Util) 공휴일 확인
             */
            isPublicHoliday(date) {
                const year = date.getFullYear();
                if (year !== 2025) return false; // 2025년 데이터만 있음
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const mmdd = `${month}-${day}`;
                return this.publicHolidays2025[mmdd] || false; 
            },

            /**
             * (UI) 셀 내용물(이름) HTML 생성
             */
            renderCellContent(names) {
                if (!names || names.length === 0) return '';
                return names.map(item => {
                    const text = item.text.trim();
                    const display = text === '' ? '.' : text;
                    const hiddenClass = text === '' ? ' hidden-x' : '';
                    const boldClass = item.bold ? ' bold-name' : ''; 
                    return `<span class="name-entry${hiddenClass}${boldClass}">${display}</span>`;
                }).join('');
            },

            /**
             * (UI) 셀 편집 모드 진입
             */
            editCell(cell, colId, dateString, dayOfWeek) {
                if (cell.classList.contains('edit-mode')) return;

                // 기존 편집 모드 셀 닫기
                document.querySelectorAll('#section1 td.edit-mode').forEach(editCell => { 
                    const prevColId = editCell.dataset.colId;
                    const prevDateString = editCell.dataset.dateString;
                    const originalNames = (this.state.scheduleData[prevDateString] && this.state.scheduleData[prevDateString][prevColId]) || [{ text: '', bold: false }, { text: '', bold: false }];
                    editCell.classList.remove('edit-mode');
                    editCell.innerHTML = this.renderCellContent(originalNames);
                });

                const currentNames = (this.state.scheduleData[dateString] && this.state.scheduleData[dateString][colId]) || [{ text: '', bold: false }, { text: '', bold: false }];
                const morningValue = currentNames[0] ? currentNames[0].text : '';
                const afternoonValue = currentNames[1] ? currentNames[1].text : '';
                const isBiweeklySunday = (this.state.workTypeConfig[colId] === 'biweekly' && dayOfWeek === 0);

                cell.classList.add('edit-mode');
                cell.dataset.colId = colId;
                cell.dataset.dateString = dateString;
                cell.dataset.dayOfWeek = dayOfWeek;
                cell.innerHTML = `
                    <input type="text" class="morning-input" value="${morningValue}" placeholder="오전" data-bold="${currentNames[0].bold}">
                    <input type="text" class="afternoon-input" value="${afternoonValue}" placeholder="오후" data-bold="${currentNames[1].bold}">
                    <div class="cell-buttons">
                        <button class="btn-fixed" ${isBiweeklySunday ? 'disabled title="격주 근무 차량은 일요일 고정 저장이 불가능합니다."' : ''}>고정</button>
                        <button class="btn-temp">임시</button>
                        <button class="btn-highlight-am">오전 강조</button>
                        <button class="btn-highlight-pm">오후 강조</button>
                        <button class="btn-delete">삭제</button>
                    </div>
                `;
                cell.querySelector('.morning-input').focus();

                // 새로 생성된 버튼들에 이벤트 리스너 바인딩
                const buttons = cell.querySelector('.cell-buttons');
                buttons.querySelector('.btn-fixed').onclick = (e) => { e.stopPropagation(); this.saveFixedCell(cell); };
                buttons.querySelector('.btn-temp').onclick = (e) => { e.stopPropagation(); this.saveTempCell(cell); };
                buttons.querySelector('.btn-highlight-am').onclick = (e) => { e.stopPropagation(); this.highlightCell(cell, 'am'); };
                buttons.querySelector('.btn-highlight-pm').onclick = (e) => { e.stopPropagation(); this.highlightCell(cell, 'pm'); };
                buttons.querySelector('.btn-delete').onclick = (e) => { e.stopPropagation(); this.deleteCell(cell); };
            },
            
            /**
             * (UI) 편집 모드 해제
             */
            clearEditMode(event) {
                // S1의 날짜/요일 셀 클릭 시
                if (event.target.matches('#section1 td:nth-child(1)') || event.target.matches('#section1 td:nth-child(2)')) {
                    const editCell = document.querySelector('#section1 td.edit-mode');
                    if (editCell) {
                        const prevColId = editCell.dataset.colId;
                        const prevDateString = editCell.dataset.dateString;
                        const originalNames = (this.state.scheduleData[prevDateString] && this.state.scheduleData[prevDateString][prevColId]) || [{ text: '', bold: false }, { text: '', bold: false }];
                        editCell.classList.remove('edit-mode');
                        editCell.innerHTML = this.renderCellContent(originalNames);
                    }
                }
            },

            /**
             * (Util) 편집 셀에서 이름/강조 정보 가져오기
             */
            getNamesAndBoldStateFromCell(cellElement) {
                const morningInput = cellElement.querySelector('.morning-input');
                const afternoonInput = cellElement.querySelector('.afternoon-input');
                return [ 
                    { text: morningInput.value.trim(), bold: morningInput.dataset.bold === 'true' }, 
                    { text: afternoonInput.value.trim(), bold: afternoonInput.dataset.bold === 'true' } 
                ];
            },

            /**
             * (UI) 오전/오후 강조 토글
             */
            highlightCell(cellElement, timeOfDay) {
                let inputElement = cellElement.querySelector(timeOfDay === 'am' ? '.morning-input' : '.afternoon-input');
                if (inputElement) {
                    const newState = !(inputElement.dataset.bold === 'true');
                    inputElement.dataset.bold = newState; 
                    inputElement.style.fontWeight = newState ? 'bold' : 'normal';
                }
            },

            /**
             * [데이터 연동] '고정' 저장
             */
            saveFixedCell(cellElement) {
                const { colId, dayOfWeek, dateString } = cellElement.dataset;
                const namesToSave = this.getNamesAndBoldStateFromCell(cellElement);
                const workType = this.state.workTypeConfig[colId] || 'normal';

                if (workType === 'biweekly' && dayOfWeek === '0') {
                    alert('격주 근무 차량은 일요일 고정 저장이 불가능합니다.');
                    return;
                }

                // DataManager에 데이터 수정을 요청
                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[this.state.currentRoute];
                    if (!routeData) return;

                    const currentRecurringKey = `${dayOfWeek}-${colId}`;
                    if (!routeData.fixedSchedule[currentRecurringKey]) {
                        routeData.fixedSchedule[currentRecurringKey] = [];
                    }
                    routeData.fixedSchedule[currentRecurringKey] = 
                        routeData.fixedSchedule[currentRecurringKey].filter(
                            entry => entry.dateString !== dateString
                        );
                    routeData.fixedSchedule[currentRecurringKey].push({ dateString: dateString, names: namesToSave });

                    for (const key in routeData.fixedSchedule) {
                        routeData.fixedSchedule[key].sort((a, b) => new Date(b.dateString) - new Date(a.dateString));
                    }
                    
                    this.state.fixedScheduleData = routeData.fixedSchedule;
                });
                
                this.generateSchedule();
            },

            /**
             * [데이터 연동] '임시' 저장
             */
            saveTempCell(cellElement) {
                const { colId, dateString } = cellElement.dataset;
                const namesToSave = this.getNamesAndBoldStateFromCell(cellElement);

                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[this.state.currentRoute];
                    if (!routeData) return;

                    if (!routeData.tempSchedule[dateString]) routeData.tempSchedule[dateString] = {};
                    routeData.tempSchedule[dateString][colId] = namesToSave;
                    
                    this.state.tempScheduleData = routeData.tempSchedule;
                });

                this.generateSchedule();
            },

            /**
             * [데이터 연동] '삭제'
             */
            deleteCell(cellElement) {
                const { colId, dayOfWeek, dateString } = cellElement.dataset;

                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[this.state.currentRoute];
                    if (!routeData) return;

                    if (routeData.tempSchedule[dateString]?.[colId]) {
                        delete routeData.tempSchedule[dateString][colId];
                        if (Object.keys(routeData.tempSchedule[dateString]).length === 0) {
                            delete routeData.tempSchedule[dateString];
                        }
                    }

                    const recurringKey = `${dayOfWeek}-${colId}`;
                    if (!routeData.fixedSchedule[recurringKey]) {
                        routeData.fixedSchedule[recurringKey] = [];
                    }
                    
                    const blankNames = [{ text: '', bold: false }, { text: '', bold: false }];
                    routeData.fixedSchedule[recurringKey] = 
                        routeData.fixedSchedule[recurringKey].filter(entry => entry.dateString !== dateString);
                    routeData.fixedSchedule[recurringKey].push({ dateString: dateString, names: blankNames });
                    routeData.fixedSchedule[recurringKey].sort((a, b) => new Date(b.dateString) - new Date(a.dateString));
                    
                    this.state.fixedScheduleData = routeData.fixedSchedule;
                    this.state.tempScheduleData = routeData.tempSchedule;
                });
                
                this.generateSchedule();
            },
/**
             * [데이터 연동] 현재 노선 초기화
             */
            resetAllFixedSchedules() {
                if (!this.state.currentRoute) {
                    alert('초기화할 노선이 선택되지 않았습니다.');
                    return;
                }
                const password = prompt(`[${this.state.currentRoute}] 노선의 모든 고정/임시 근무표 및 근무형태 설정을 삭제하시려면 비밀번호를 입력하세요.`);
                if (password === "201023") {
                    if (confirm(`[${this.state.currentRoute}] 노선의 모든 근무표 데이터를 삭제합니다. 계속하시겠습니까?`)) {
                        
                        // DataManager에 데이터 수정을 요청
                        DataManager.updateS1Data(s1_data => {
                            const routeData = s1_data.routes[this.state.currentRoute];
                            if (routeData) {
                                routeData.fixedSchedule = {};
                                routeData.tempSchedule = {};
                                routeData.workTypeConfig = {};
                                
                                // S1 내부 상태도 즉시 동기화
                                this.state.fixedScheduleData = routeData.fixedSchedule;
                                this.state.tempScheduleData = routeData.tempSchedule;
                                this.state.workTypeConfig = routeData.workTypeConfig;
                            }
                        });

                        // 화면 갱신
                        this.generateSchedule();
                        alert(`[${this.state.currentRoute}] 노선의 근무표가 초기화되었습니다.`);
                    }
                } else {
                    alert("비밀번호 확인 후 신청하세요.");
                }
            },

            /**
             * [데이터 연동] 전체 데이터 저장 (백업) - [수정됨]
             */
            backupScheduleData() {
                const backupData = DataManager.data.s1; 
                const jsonString = JSON.stringify(backupData);
                const now = new Date();
                // [수정] 날짜 포맷 (YYYYMMDD)
                const dateString = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
                
                let companyName = "전체";
                let routeName = "전체";
                
                if (this.state.currentRoute && DataManager.data.s1.routes[this.state.currentRoute]) {
                    const routeData = DataManager.data.s1.routes[this.state.currentRoute];
                    companyName = (routeData.companyName || "회사없음").replace(/\s/g, ''); // 공백 제거
                    routeName = this.state.currentRoute.replace(/\s/g, ''); // 공백 제거
                }
                
                // [수정] 한글 파일명으로 변경
                const filename = `${companyName}_${routeName}_근무현황표_${dateString}.json`;
                
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                // [수정] 알림 메시지
                alert(`근무현황표(S1) 데이터 파일 (${filename})이 다운로드 폴더에 JSON 파일로 저장됩니다.`);
            },

            /**
             * [데이터 연동] 전체 데이터 불러오기 (복원)
             */
            restoreScheduleData(file) {
                const selectElement = this.ui.scheduleActionsSelect;
                if (!file) {
                    selectElement.value = '';
                    return;
                }
                if (!confirm(`[${file.name}] 파일을 업로드하여 저장된 *모든* 노선의 근무표를 불러오시겠습니까? (현재 모든 데이터는 덮어쓰여집니다.)`)) {
                    this.ui.restoreFile.value = '';
                    selectElement.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedData = JSON.parse(event.target.result);
                        if (!loadedData.routes || loadedData.currentRoute === undefined) {
                             alert('파일 형식이 올바르지 않거나 데이터가 부족합니다. (routes, currentRoute 속성 필요)');
                             throw new Error('Invalid saved file structure');
                        }
                        
                        // DataManager에 데이터 수정을 요청 (완전 덮어쓰기)
                        DataManager.updateS1Data(s1_data => {
                            s1_data.routes = loadedData.routes;
                            s1_data.currentRoute = loadedData.currentRoute;
                        });

                        // S1 상태 업데이트 및 UI 갱신
                        this.state.currentRoute = loadedData.currentRoute; 
                        this.populateRouteSelect();
                        this.loadRouteData(this.state.currentRoute);
                        alert(`[${file.name}] 파일로부터 전체 데이터 불러오기를 완료했습니다. 화면을 확인해주세요.`);

                    } catch (e) {
                        alert('파일을 읽는 도중 오류가 발생했습니다. 파일이 손상되었거나 JSON 형식이 아닙니다.');
                        console.error('Restore Error:', e);
                    } finally {
                        this.ui.restoreFile.value = '';
                        selectElement.value = '';
                    }
                };
                reader.onerror = () => {
                    alert('파일을 읽을 수 없습니다.');
                    this.ui.restoreFile.value = '';
                    selectElement.value = '';
                };
                reader.readAsText(file);
            },

            /**
             * (UI) 근무 현황표 테이블 생성 (핵심)
             */
            generateSchedule() {
                if (!this.state.currentRoute) {
                    this.ui.scheduleContainer.innerHTML = '<table><caption id="tableCaption">표시할 노선을 선택하거나 추가해주세요.</caption></table>';
                    return;
                }

                const year = parseInt(this.ui.yearInput.value);
                const month = parseInt(this.ui.monthInput.value);
                const selectedOption = document.querySelector('#section1 input[name="displayOption"]:checked').value;
                const applyHolidays = this.ui.holidaySelect.value === 'apply';
                
                const { routeData } = DataManager.getCurrentRouteData();
                if (!routeData) return; // 노선이 없으면 중단

                const companyName = routeData.companyName || '회사명 없음';
                const VEHICLE_COLS = routeData.vehicleColumns || [];
                
                this.ui.scheduleContainer.innerHTML = ''; 

                const startDate = new Date(year, month - 1, selectedOption === '1' ? 1 : 16);
                const endDate = (selectedOption === '1') ? new Date(year, month - 1, 15) : new Date(year, month, 0);
                
                const colsPerPage = 12; 
                const colChunks = [];
                for (let i = 0; i < VEHICLE_COLS.length; i += colsPerPage) {
                    colChunks.push(VEHICLE_COLS.slice(i, i + colsPerPage));
                }
                if (colChunks.length === 0) {
                     colChunks.push([]);
                }

                const dateRange = [];
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    dateRange.push(new Date(d));
                }
                
                this.state.scheduleData = {}; 

                colChunks.forEach((vehicleChunk, chunkIndex) => {
                    
                    const table = document.createElement('table');
                    if (chunkIndex > 0) {
                        table.style.pageBreakBefore = 'always';
                    }

                    // 1. 캡션(제목) 생성
                    const caption = document.createElement('caption');
                    let captionText = `${companyName} [${this.state.currentRoute}] ${year}년 ${month}월 ${startDate.getDate()}일 ~ ${endDate.getDate()}일까지 근무현황표`;
                    if (colChunks.length > 1) {
                        captionText += ` (페이지 ${chunkIndex + 1}/${colChunks.length})`;
                    }
                    if (chunkIndex === 0) caption.id = 'tableCaption';
                    caption.textContent = captionText;
                    table.appendChild(caption);

                    // 2. 헤더 생성
                    const thead = document.createElement('thead');
                    if (chunkIndex === 0) thead.id = 'scheduleHeader';
                    const headerHTML = `<tr><th style="width: 4%;">월일</th><th style="width: 4%;">요일</th>${vehicleChunk.map(c => c === '미입력' ? `<th></th>` : `<th>${c}</th>`).join('')}</tr>`;
                    thead.innerHTML = headerHTML;
                    table.appendChild(thead);

                    // 3. 바디 생성
                    const tbody = document.createElement('tbody');
                    if (chunkIndex === 0) tbody.id = 'scheduleBody';

                    // 날짜별(행) 데이터 계산
                    dateRange.forEach(d => {
                        const dateString = d.toISOString().slice(0, 10);
                        const dayOfWeek = d.getDay();
                        
                        if (!this.state.scheduleData[dateString]) { 
                            let cellsContent = {};
                            VEHICLE_COLS.forEach(colId => { 
                                if (colId === '미입력') {
                                    cellsContent[colId] = [];
                                    return;
                                }

                                let appliedNames = [{ text: '', bold: false }, { text: '', bold: false }];
                                
                                if (this.state.tempScheduleData[dateString] && this.state.tempScheduleData[dateString][colId]) {
                                    appliedNames = this.state.tempScheduleData[dateString][colId];
                                } 
                                else {
                                    const recurringKey = `${dayOfWeek}-${colId}`;
                                    if (this.state.fixedScheduleData[recurringKey]) {
                                        let anchorEntry = null;
                                        for (const entry of this.state.fixedScheduleData[recurringKey]) {
                                            if (new Date(dateString) >= new Date(entry.dateString)) {
                                                anchorEntry = entry;
                                                break; 
                                            }
                                        }

                                        if (anchorEntry) {
                                            const workType = this.state.workTypeConfig[colId] || 'normal';
                                            if (workType === 'biweekly' && dayOfWeek !== 0) {
                                                const anchorDate = new Date(anchorEntry.dateString);
                                                const currentDate = new Date(dateString);
                                                anchorDate.setHours(0, 0, 0, 0);
                                                currentDate.setHours(0, 0, 0, 0);
                                                const msInDay = 24 * 60 * 60 * 1000;
                                                const diffInDays = Math.round((currentDate.getTime() - anchorDate.getTime()) / msInDay);
                                                const weekDifference = Math.floor(diffInDays / 7);
                                                
                                                if (weekDifference % 2 === 1) {
                                                    appliedNames = [anchorEntry.names[1], anchorEntry.names[0]];
                                                } else {
                                                    appliedNames = anchorEntry.names;
                                                }
                                            } else {
                                                appliedNames = anchorEntry.names;
                                            }
                                        }
                                    }
                                }
                                cellsContent[colId] = appliedNames;
                            });
                            this.state.scheduleData[dateString] = cellsContent; 
                        }

                        // 행(Row) HTML 생성
                        const holidayName = applyHolidays ? this.isPublicHoliday(d) : false;
                        const isHoliday = !!holidayName;
                        let rowClass = '';
                        const dayName = this.getDayName(dayOfWeek); 
                        let mainColor = '#333'; 
                        let subText = '';

                        if (isHoliday) {
                            rowClass = 'holiday'; mainColor = '#cc0000'; subText = holidayName.substring(0, 2); 
                        } else if (dayOfWeek === 0) {
                            rowClass = 'sunday'; mainColor = '#cc0000'; subText = '일요'; 
                        } else if (dayOfWeek === 6) {
                            rowClass = 'saturday'; mainColor = '#0000cc'; subText = '토요';
                        }
                        
                        let dayCellContent;
                        if (dayOfWeek === 0 || dayOfWeek === 6 || isHoliday) {
                            dayCellContent = `<div class="day-cell-content"><span class="day-name-main" style="color: ${mainColor};">${dayName}</span><span class="sub-day-info" style="color: ${mainColor};">${subText}</span></div>`;
                        } else {
                            dayCellContent = `<div class="day-cell-content"><span class="day-name-main" style="color: ${mainColor};">${dayName}</span><span class="sub-day-info" style="color: ${mainColor};"></span></div>`;
                        }

                        // 데이터 셀(TD) HTML 생성
                        const dataCellsHTML = vehicleChunk.map(colId =>
                            colId === '미입력' 
                            ? `<td></td>` 
                            : `<td onclick="S1_Module.editCell(this, '${colId}', '${dateString}', ${dayOfWeek})">${this.renderCellContent(this.state.scheduleData[dateString][colId])}</td>`
                        ).join('');

                        tbody.insertAdjacentHTML('beforeend', `
                            <tr class="${rowClass}">
                                <td>${d.getDate()}</td>
                                <td>${dayCellContent}</td> 
                                ${dataCellsHTML}
                            </tr>`);
                    }); 

                    table.appendChild(tbody);
                    this.ui.scheduleContainer.appendChild(table);
                }); 
            },

            /**
             * (Util) 근무일수 계산기
             */
            calculateWorkdays() {
                if (!this.state.currentRoute) {
                    alert('근무일수를 계산할 노선이 없습니다.');
                    return;
                }
                
                const { routeData } = DataManager.getCurrentRouteData();
                if (!routeData) return;
                
                const year = parseInt(this.ui.yearInput.value);
                const month = parseInt(this.ui.monthInput.value);
                const VEHICLE_COLS = routeData.vehicleColumns || [];
                const workdayCounts = {};
                const shiftCounts = {};
                const allNames = new Set();

                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0);

                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateString = d.toISOString().slice(0, 10);
                    const dayOfWeek = d.getDay();
                    let dailyNames = {}; 

                    VEHICLE_COLS.forEach(colId => {
                        if (colId === '미입력') return; 

                        let appliedNames = [{ text: '', bold: false }, { text: '', bold: false }];
                        if (routeData.tempSchedule[dateString] && routeData.tempSchedule[dateString][colId]) {
                           appliedNames = routeData.tempSchedule[dateString][colId];
                        } else {
                            const recurringKey = `${dayOfWeek}-${colId}`;
                            if (routeData.fixedSchedule[recurringKey]) {
                                for (const entry of routeData.fixedSchedule[recurringKey]) {
                                    if (new Date(dateString) >= new Date(entry.dateString)) {
                                        appliedNames = entry.names;
                                        break;
                                    }
                                }
                            }
                        }
                        dailyNames[colId] = appliedNames;
                    });
                    
                    const dayWorkdays = new Set();
                    for (const colId in dailyNames) {
                        if (colId !== '비고' && colId !== '미입력') { 
                            dailyNames[colId].forEach((item, index) => {
                                const name = item.text.trim();
                                if (name !== '' && name !== '휴무') {
                                    allNames.add(name);
                                    if (!shiftCounts[name]) shiftCounts[name] = { 오전: 0, 오후: 0 };
                                    if (index === 0) shiftCounts[name].오전++;
                                    else shiftCounts[name].오후++;
                                    dayWorkdays.add(name);
                                }
                            });
                        }
                    }
                    dayWorkdays.forEach(name => {
                        if (!workdayCounts[name]) workdayCounts[name] = 0;
                        workdayCounts[name]++;
                    });
                }

                const combinedData = Array.from(allNames).map(name => ({
                    name: name, 
                    workdays: workdayCounts[name] || 0,
                    morningShifts: (shiftCounts[name] && shiftCounts[name].오전) || 0,
                    afternoonShifts: (shiftCounts[name] && shiftCounts[name].오후) || 0
                }));
                combinedData.sort((a, b) => b.workdays - a.workdays);
                
                const title = `[${this.state.currentRoute}] ${year}년 ${month}월 근무일수`;
                const tableHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead><tr>
                            <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">이름</th>
                            <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">오전</th>
                            <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">오후</th>
                            <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">총 근무일수</th>
                        </tr></thead>
                        <tbody>${combinedData.map(data => `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.name}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.morningShifts}일</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.afternoonShifts}일</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.workdays}일</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`;
                
                const newWindow = window.open('', '_blank', 'width=600,height=400');
                newWindow.document.write(`<html><head><title>${title}</title><style>
                    body { font-family: Arial, sans-serif; margin: 20px; } h3 { text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; } th { background-color: #f2f2f2; }
                    .print-button { display: block; margin: 20px auto; padding: 10px 20px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; }
                    @media print { .print-button { display: none; } html, body { height: 100%; width: 100%; margin: 0; } }
                    </style></head><body><h3>${title}</h3>${tableHTML}<button class="print-button" onclick="window.print()">인쇄</button></body></html>`);
                newWindow.document.close();
            },

            /**
             * (UI) 인쇄
             */
            printPage() {
                const editCell = document.querySelector('#section1 td.edit-mode');
                if (editCell) {
                    const { colId, dateString } = editCell.dataset;
                    const originalNames = this.state.scheduleData[dateString]?.[colId] || [{ text: '', bold: false }, { text: '', bold: false }];
                    editCell.classList.remove('edit-mode');
                    editCell.innerHTML = this.renderCellContent(originalNames);
                }

                document.documentElement.style.setProperty('--print-margin-left', `${this.ui.marginLeftSelect.value}mm`);
                document.documentElement.style.setProperty('--print-margin-right', `${this.ui.marginRightSelect.value}mm`);
                
                const originalTitle = document.title;
                const captionText = document.getElementById('tableCaption').textContent;
                let newTitle = "근무현황표";
                
                const matches = captionText.match(/\[(.*?)\] (\d{4})년 (\d{1,2})월 (\d{1,2})일 ~ (\d{1,2})일/);
                if (matches) {
                    newTitle = `${matches[1]} ${matches[2]}-${matches[3].padStart(2, '0')} (${matches[4].padStart(2, '0')}일-${matches[5].padStart(2, '0')}일)`;
                } else if (this.state.currentRoute) {
                    newTitle = `${this.state.currentRoute} 근무현황표`;
                }
                
                document.body.classList.remove('printing-section2', 'printing-section3'); 
                document.body.classList.add('printing-section1'); 

                const handleAfterPrint = () => {
                    document.title = originalTitle;
                    document.documentElement.style.removeProperty('--print-margin-left');
                    document.documentElement.style.removeProperty('--print-margin-right');
                    document.body.classList.remove('printing-section1'); 
                    window.removeEventListener('afterprint', handleAfterPrint);
                };
                window.addEventListener('afterprint', handleAfterPrint);
                
                document.title = newTitle;                
                
                // [수정됨] 4. 인쇄 딜레이 제거 (CSS 로직 변경으로 불필요)
                window.print();
  
            },
            
            /**
             * (UI) 폰트 크기 적용
             */
            applyFontSize(size) {
                if (parseFloat(size) < 8) size = '8pt';
                if (parseFloat(size) > 20) size = '20pt';
                document.documentElement.style.setProperty('--worker-font-size', size);
            },

            /**
             * (UI) 데이터 관리 옵션 핸들러
             */
            handleScheduleActions() {
                const action = this.ui.scheduleActionsSelect.value;
                if (action === 'reset') this.resetAllFixedSchedules();
                else if (action === 'backup') this.backupScheduleData();
                else if (action === 'restore') this.ui.restoreFile.click();
                this.ui.scheduleActionsSelect.value = '';
            },

            /**
             * [데이터 연동] 근무 형태 변경
             */
            handleWorkTypeChange() {
                const selectedValue = this.ui.vehicleSelect.value; 
                const workType = this.ui.workTypeSelect.value;
                
                if (!selectedValue || !workType) return;

                let workTypeName = '';
                if (workType === 'normal') workTypeName = '3/3 근무';
                else if (workType === 'biweekly') workTypeName = '격주 근무';
                else if (workType === 'five_day') workTypeName = '5일 근무';
                
                if (selectedValue === 'ALL_VEHICLES') {
                    const vehicleCount = this.state.currentVehicleColumns.filter(c => c !== '미입력').length;
                    if (vehicleCount === 0) {
                        alert('설정할 차량이 없습니다.');
                    } else if (confirm(`[${this.state.currentRoute}] 노선의 '미입력'을 제외한 *전체 차량* (${vehicleCount}대)의 근무형태를 [${workTypeName}]로 설정하고 저장하시겠습니까?`)) {
                        
                        DataManager.updateS1Data(s1_data => {
                            const routeData = s1_data.routes[this.state.currentRoute];
                            if (!routeData) return;
                            this.state.currentVehicleColumns.forEach(colId => {
                                if (colId !== '미입력') { 
                                   routeData.workTypeConfig[colId] = workType;
                                }
                            });
                            this.state.workTypeConfig = routeData.workTypeConfig;
                        });
                        alert(`[${this.state.currentRoute}] 노선의 전체 차량 근무형태가 [${workTypeName}]로 설정되었습니다. '고정' 저장 시 적용됩니다.`);
                    }
                } else {
                    const colId = selectedValue;
                    if (confirm(`차량 [${colId}]의 근무형태를 [${workTypeName}]로 설정하고 저장하시겠습니까?`)) {
                        
                        DataManager.updateS1Data(s1_data => {
                            const routeData = s1_data.routes[this.state.currentRoute];
                            if (!routeData) return;
                            routeData.workTypeConfig[colId] = workType;
                            this.state.workTypeConfig = routeData.workTypeConfig;
                        });
                        alert(`차량 [${colId}]의 근무형태가 [${workTypeName}]로 설정되었습니다. '고정' 저장 시 적용됩니다.`);
                    }
                }
                
                this.ui.vehicleSelect.value = '';
                this.ui.workTypeSelect.value = '';
            },
            
            /**
             * (UI) 노선 이동 드롭다운 핸들러
             */
            handleRouteSelectChange(routeName) {
                if (routeName) {
                    this.loadRouteData(routeName);
                }
            },

            /**
             * (UI) 섹션 이동
             */
            showSection(sectionId) {
                document.getElementById('section1').style.display = 'none';
                document.getElementById('section2').style.display = 'none';
                document.getElementById('section3').style.display = 'none';
                document.querySelector('.divider').style.display = 'none';
                
                const targetSection = document.getElementById(`section${sectionId.replace('S', '')}`);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    targetSection.scrollIntoView({ behavior: 'smooth' });
                }
            },

            /**
             * (UI) 전체 보기
             */
            showAllSections() {
                document.getElementById('section1').style.display = 'block';
                document.getElementById('section2').style.display = 'block';
                document.getElementById('section3').style.display = 'none'; // S3는 기본 숨김
                document.querySelector('.divider').style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },

            /**
             * (UI) 버전 정보 설정
             */
            setVersion() {
                try {
                    // [수정] 버전 정보를 4.8.5로 고정 (파일명 파싱 대신)
                    document.getElementById('version-display').textContent = 'Ver 4.8.5';
                } catch (e) {
                    console.error("버전 정보를 설정하는 데 실패했습니다.", e);
                    document.getElementById('version-display').textContent = 'Ver 4.8.5';
                }
            }
        };
/* ================================================================= */
        /* [Section 2] 승무 일지 JavaScript */
        /* ================================================================= */

        /**
         * 3. S2(승무일지) 모듈
         * - S1 데이터 변경 시(onDataChanged) S2 화면을 새로고침합니다.
         * - S2 근무자 수정 시 DataManager를 통해 S1 데이터를 수정합니다.
         * - S2 일지 데이터를 날짜별로 백업/복원합니다.
         */
        const S2_Module = {
            // S2 UI 요소
            ui: {
                headerTitle: document.querySelector('#section2 .header-title'),
                dateDisplay: document.getElementById('today-date'),
                fontSizeSelect: document.getElementById('font-size-select'),
                dispatchLogBody: document.getElementById('dispatch-log-body'),
                // [수정] 공용 버튼 삭제
                // dispatchButtons: document.getElementById('dispatch-buttons'),
                // dispatchCycleSelect: document.getElementById('dispatch-cycle-select'), 
                // 모달
                restoreModal: document.getElementById('s2_restoreDateModal'),
                restoreFile: document.getElementById('s2_restoreFile'),
                cancelRestoreBtn: document.getElementById('s2_cancelRestoreBtn'),
                confirmRestoreBtn: document.getElementById('s2_confirmRestoreBtn'),
            },

            // S2 내부 상태
            state: {
                s2_currentDate: new Date(), // S2는 기본적으로 '오늘' 날짜 기준
                // [수정] 공용 출차순서 삭제
                // s2_currentDispatchOrder: 'manual', 
                S2_ROUTE_MAP: { // S1 노선명 -> S2 ID 매핑 (확장성)
                    '종로07번': '07',
                    '종로08번': '08',
                    '성동 3-1번': 'sd31',
                    '성동 3-2번': 'sd32'
                },
                S2_USED_VEHICLES: {}, // 현재 S2 화면에 표시된 차량 (차번 변경 시 중복 체크용)
                s2_draggedCell: null,
                s2_draggedRoute: null
            },
            
            // --- [추가] S2 순환주기 헬퍼 함수 ---
            /**
             * 날짜에 일을 더합니다.
             * @param {Date} date - 기준 날짜
             * @param {number} days - 더할 일수
             * @returns {Date} - 계산된 날짜
             */
            addDays(date, days) {
                const result = new Date(date);
                result.setDate(result.getDate() + days);
                return result;
            },
            /**
             * 날짜에 월을 더합니다.
             * @param {Date} date - 기준 날짜
             * @param {number} months - 더할 월수
             * @returns {Date} - 계산된 날짜
             */
            addMonths(date, months) {
                const result = new Date(date);
                result.setMonth(result.getMonth() + months);
                return result;
            },
            /**
             * 배열을 무작위로 섞습니다. (Fisher-Yates shuffle)
             * @param {Array} array - 섞을 배열
             * @returns {Array} - 섞인 새 배열
             */
            shuffleArray(array) {
                let currentIndex = array.length, randomIndex;
                const newArray = [...array]; // 원본 훼손 방지
                while (currentIndex !== 0) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [newArray[currentIndex], newArray[randomIndex]] = [
                        newArray[randomIndex], newArray[currentIndex]];
                }
                return newArray;
            },
            /**
             * 배열을 순환시킵니다.
             * @param {Array} array - 순환할 배열
             * @param {number} count - 순환 횟수 (양수: 앞으로, 음수: 뒤로)
             * @returns {Array} - 순환된 새 배열
             */
            rotateArray(array, count) {
                const len = array.length;
                if (len === 0) return [];
                const netCount = count % len;
                if (netCount === 0) return [...array];
                
                if (netCount > 0) { // 양수 (1,2,3 -> 2,3,1)
                    return [...array.slice(netCount), ...array.slice(0, netCount)];
                } else { // 음수 (1,2,3 -> 3,1,2)
                    return [...array.slice(netCount), ...array.slice(0, len + netCount)];
                }
            },
            // --- [추가 끝] ---


            /**
             * S2 모듈 초기화 (DOM 로드 시 1회 실행)
             */
            initialize() {
                console.log("S2: 초기화 시작");
                DataManager.subscribe(this); // DataManager에 S2 모듈 등록
                DataManager.loadS2Data();    // S2 전용 일지 데이터 로드

                this.bindEventListeners();
                // [수정] 공용 출차순서 설정 삭제
                // this.changeDispatchOrder('manual'); 
                
                // S2의 오늘 날짜 표시
                this.ui.dateDisplay.textContent = this.getTodayDateString(this.state.s2_currentDate);

                // S1 데이터 기준으로 S2 화면 첫 그리기
                this.refreshDispatchLog();
                console.log("S2: 초기화 완료.");
            },

            /**
             * [핵심] DataManager로부터 알림을 처리하는 함수 (S1에서 데이터 변경 시)
             */
            onDataChanged(event, payload) {
                if (event === 's1_data_changed') {
                    console.log("[S2] S1로부터 데이터 변경 알림 수신. S2 갱신 시작.");
                    // S1 데이터(근무표)가 변경되었으므로 S2 화면(근무자)을 새로고침
                    this.refreshDispatchLog();
                }
            },

            /**
             * S2의 모든 이벤트 리스너 바인딩
             */
            bindEventListeners() {
                document.getElementById('s2-showAll').onclick = () => S1_Module.showAllSections();
                // [수정] 공용 출차순서 리스너 삭제
                /*
                this.ui.dispatchButtons.onclick = (e) => {
                    if (e.target.classList.contains('dispatch-button')) {
                        this.changeDispatchOrder(e.target.dataset.order);
                    }
                };
                */
                this.ui.fontSizeSelect.onchange = (e) => this.changeFontSize(e.target.value);
                
                // [수정] S2 백업/복원 버튼 연결
                document.getElementById('s2-backupLog').onclick = () => this.backupLogData();
                document.getElementById('s2-showRestoreModal').onclick = () => this.showRestoreModal();
                
                // [수정] 새로고침 버튼에 확인창 추가
                document.getElementById('s2-refreshLog').onclick = () => {
                    if (confirm("승무일지를 새로고침 하시겠습니까?\n\n[확인]을 누르면 오늘 날짜의 승무일지(S2)에 입력된 모든 시간/근무시간 데이터가 삭제되고, 모든 노선의 출차 순서가 '수동'으로 초기화됩니다.\n(S1 근무표는 변경되지 않습니다.)")) {
                        this.resetS2LogForToday();
                        this.refreshDispatchLog();
                    }
                };
                document.getElementById('s2-printPage').onclick = () => this.printPage();

                // [수정] 복원 모달 이벤트 (단순화)
                this.ui.cancelRestoreBtn.onclick = () => this.hideRestoreModal();
                this.ui.confirmRestoreBtn.onclick = () => this.triggerRestore();
                this.ui.restoreFile.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.restoreLogData(file); // 날짜 인수 제거
                        this.hideRestoreModal();
                    }
                };

                // (동적 생성 요소 이벤트는 dispatchLogBody에 위임)
                const logBody = this.ui.dispatchLogBody;
                logBody.onclick = (e) => {
                    const carCell = e.target.closest('.car-number-cell');
                    const driverCell = e.target.closest('td[data-edit-type="driver"]');
                    
                    // [수정] 노선별 출차순서 버튼
                    const dispatchBtn = e.target.closest('.dispatch-button');

                    if (carCell) {
                        e.preventDefault();
                        const routeName = carCell.closest('.route-section').dataset.routeName;
                        this.toggleCarNumberEditMode(carCell, routeName);
                        return;
                    }
                    if (driverCell) {
                        e.preventDefault();
                        this.toggleEditMode(driverCell);
                        return;
                    }
                    // [수정] 노선별 출차순서 버튼 클릭
                    if (dispatchBtn) {
                        e.preventDefault();
                        const routeId = dispatchBtn.closest('.dispatch-buttons-container').dataset.routeId;
                        const routeName = document.getElementById(`route-${routeId}`).dataset.routeName;
                        const order = dispatchBtn.dataset.order;
                        this.changeDispatchOrder(routeName, order, dispatchBtn.closest('.dispatch-buttons-container'));
                        return;
                    }
                };
                logBody.onmousedown = (e) => {
                    const carControlBtn = e.target.closest('.car-controls button');
                    if (carControlBtn) {
                        e.preventDefault();
                        const td = carControlBtn.closest('.car-number-cell');
                        if (carControlBtn.classList.contains('btn-car-delete')) {
                            this.deleteCarRow(td);
                        } else if (carControlBtn.classList.contains('btn-car-close')) {
                            this.exitCarNumberEditMode(td);
                        }
                        return;
                    }
                    const driverControlBtn = e.target.closest('.edit-controls button');
                    if (driverControlBtn) {
                        e.preventDefault();
                        const td = driverControlBtn.closest('td[data-edit-type="driver"]');
                        if (driverControlBtn.classList.contains('btn-driver-delete')) {
                            this.deleteName(td);
                        } else if (driverControlBtn.classList.contains('btn-driver-save')) {
                            this.saveAndExit(td);
                        }
                        return;
                    }
                    const settingBtn = e.target.closest('.setting-button');
                    if(settingBtn) {
                        e.preventDefault();
                        const routeId = settingBtn.dataset.routeId;
                        if (settingBtn.classList.contains('apply-button')) {
                            this.applyScheduleSettings(routeId); // [수정] 이 함수에 로직 추가
                        } else if (settingBtn.classList.contains('reset-button')) {
                            this.resetScheduleSettings(routeId);
                        }
                        return;
                    }
                };
                logBody.onchange = (e) => {
                    // [수정] 노선별 순환주기 변경
                    if (e.target.classList.contains('dispatch-cycle-select')) {
                        e.stopPropagation();
                        const routeId = e.target.closest('.dispatch-cycle-container').dataset.routeId;
                        const routeName = document.getElementById(`route-${routeId}`).dataset.routeName;
                        const cycle = e.target.value;
                        this.changeDispatchCycle(routeName, cycle);
                        return; // [추가]
                    }

                    if (e.target.classList.contains('car-select-dropdown')) {
                        e.stopPropagation();
                        const routeName = e.target.closest('.route-section').dataset.routeName;
                        this.changeCarNumber(e.target, routeName);
                        return; // [추가]
                    }
                };
                logBody.ondragstart = (e) => {
                    const cell = e.target.closest('td.car-number-cell');
                    if (cell) {
                        const routeName = cell.closest('.route-section').dataset.routeName;
                        this.dragStart(e, routeName);
                    }
                };
                logBody.ondragover = (e) => this.dragOver(e);
                logBody.ondrop = (e) => {
                    const cell = e.target.closest('td.car-number-cell');
                    if (cell) {
                        const routeName = cell.closest('.route-section').dataset.routeName;
                        this.drop(e, routeName);
                    }
                };
                logBody.ondragend = (e) => this.dragEnd(e);
            },

            // --- S2 UI/상태 관리 ---
            getTodayDateString(dateObj) {
                return (dateObj || this.state.s2_currentDate).toLocaleDateString('ko-KR', { 
                    year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'long' 
                }).replace(/\. /g, '.').replace(/\.$/, '').replace(/(\d{4})년 (\d{2})월 (\d{2})일/,'$1년 $2월 $3일');
            },
            changeFontSize(size) {
                document.getElementById('section2').style.fontSize = size + 'pt';
            },

            /**
             * [수정] 노선별 출차 순서 변경 및 저장
             * @param {string} routeName - 노선 이름
             * @param {string} order - 'manual', 'ascending' 등
             * @param {HTMLElement} buttonContainer - .dispatch-buttons-container
             */
            changeDispatchOrder(routeName, order, buttonContainer) {
                if (!routeName || !order) return;

                // 1. UI 업데이트
                buttonContainer.querySelectorAll('.dispatch-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.order === order);
                });
                
                const cycleContainer = buttonContainer.nextElementSibling; // .dispatch-cycle-container
                const cycleSelect = cycleContainer.querySelector('.dispatch-cycle-select');

                // 2. '수동' 선택 시 '순환주기' 비활성화 및 'manual'로 저장
                if (order === 'manual') {
                    cycleSelect.value = 'manual';
                    cycleSelect.disabled = true;
                    this.changeDispatchCycle(routeName, 'manual'); // 순환주기도 'manual'로 저장
                } else {
                    // 3. '수동' 아닐 시 '순환주기' 활성화
                    cycleSelect.disabled = false;
                    if (cycleSelect.value === 'manual') {
                         cycleSelect.value = 'daily'; // 기본값 '하루'
                         this.changeDispatchCycle(routeName, 'daily'); // '하루'로 저장
                    }
                }

                // 4. S2 데이터에 'dispatchType' 저장
                DataManager.updateS2Data(s2_data => {
                    if (!s2_data[routeName]) s2_data[routeName] = {};
                    if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
                    s2_data[routeName]._settings.dispatchType = order;
                });

                // 5. 화면 새로고침 (새 순서 적용)
                this.refreshDispatchLog();
            },

            /**
             * [NEW] 노선별 순환 주기 저장
             * @param {string} routeName - 노선 이름
             * @param {string} cycle - 'manual', 'daily' 등
             */
            changeDispatchCycle(routeName, cycle) {
                if (!routeName || !cycle) return;
                
                // S2 데이터에 'cycle' 저장
                DataManager.updateS2Data(s2_data => {
                    if (!s2_data[routeName]) s2_data[routeName] = {};
                    if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
                    s2_data[routeName]._settings.cycle = cycle;
                });
                // (저장만 하고 새로고침은 하지 않음)
            },

            printPage() {
                document.body.classList.remove('printing-section1', 'printing-section3');
                document.body.classList.add('printing-section2'); 
                const handleAfterPrint = () => {
                    document.body.classList.remove('printing-section2');
                    window.removeEventListener('afterprint', handleAfterPrint);
                };
                window.addEventListener('afterprint', handleAfterPrint);
                
                // [수정됨] 4. 인쇄 딜레이 추가 (모바일 반응속도 고려 300ms로 증가)
                window.print();
            },
            sanitizeForId(text) {
                if (!text) return 'unknown';
                const s2_id = this.state.S2_ROUTE_MAP[text];
                if (s2_id) return s2_id;
                const match = text.match(/\d+/);
                if (match) return match[0];
                return text.toLowerCase().replace(/[^a-z0-9]/g, ''); 
            },

            // --- [추가] S2 순환주기 계산 로직 ---
            /**
             * 오늘 날짜 기준으로 저장된 순환 규칙을 적용하여 차량 순서를 계산하고,
             * 필요한 경우 (날짜가 바뀐 경우) 새 순서를 저장합니다.
             * @param {string} routeName - 노선 이름
             * @param {Array<string>} baseVehicleList - S1에서 가져온 정렬된 차량 목록
             * @returns {Array<string>} - 오늘 날짜에 적용될 차량 순서
             */
            getAndUpdateVehicleOrder(routeName, baseVehicleList) {
                const todayString = this.state.s2_currentDate.toISOString().slice(0, 10);
                const s2_route_data = DataManager.data.s2[routeName] || {};
                const lastCheckDate = s2_route_data._lastCheckDate || '1970-01-01';
                
                // 1. S2 데이터에서 설정값 불러오기
                const s2_settings = s2_route_data._settings || {
                    dispatchType: 'manual',
                    cycle: 'manual',
                    lastRotationDate: '1970-01-01',
                    baseOrder: [...baseVehicleList] // 저장된 순서가 없으면 S1 기본 순서
                };
                
                let currentOrder = s2_settings.baseOrder || [...baseVehicleList];
                
                // 2. 오늘 날짜가 마지막 확인 날짜보다 뒤인 경우 (하루에 한 번만 계산)
                if (todayString > lastCheckDate) {
                    const { dispatchType, cycle, lastRotationDate } = s2_settings;
                    const targetDate = new Date(todayString + 'T00:00:00');
                    const lastRotation = new Date(lastRotationDate + 'T00:00:00');
                    
                    let shouldRotate = false;
                    let newRotationDate = lastRotationDate;
                    
                    if (cycle === 'daily' && targetDate > lastRotation) {
                        shouldRotate = true;
                    } else if (cycle === 'weekly' && targetDate >= this.addDays(lastRotation, 7)) {
                        shouldRotate = true;
                    } else if (cycle === 'monthly' && targetDate >= this.addMonths(lastRotation, 1)) {
                        shouldRotate = true;
                    }
                    
                    // 3. 순환/랜덤 적용
                    if (shouldRotate) {
                        newRotationDate = todayString; // 순환 기준일을 오늘로 갱신
                        if (dispatchType === 'ascending') {
                            currentOrder = this.rotateArray(currentOrder, 1); // 1,2,3 -> 2,3,1
                        } else if (dispatchType === 'descending') {
                            currentOrder = this.rotateArray(currentOrder, -1); // 1,2,3 -> 3,1,2
                        } else if (dispatchType === 'random') {
                            currentOrder = this.shuffleArray(currentOrder);
                        }
                        // 'manual'은 아무것도 하지 않음
                    }
                    
                    // 4. 변경된 순서와 날짜를 S2 데이터에 저장
                    const newSettings = { 
                        ...s2_settings, 
                        baseOrder: currentOrder, 
                        lastRotationDate: newRotationDate 
                    };
                    
                    DataManager.updateS2Data(s2_data => {
                        if (!s2_data[routeName]) s2_data[routeName] = {};
                        s2_data[routeName]._settings = newSettings;
                        s2_data[routeName]._lastCheckDate = todayString;
                    });
                }
                
                // 5. 최종 계산된 순서 반환
                return currentOrder;
            },


            // --- S2 핵심 기능: 화면 그리기 ---
            refreshDispatchLog() {
                console.log("[S2] 승무일지 새로고침 시작...");
                
                const { routeData: currentS1RouteData } = DataManager.getCurrentRouteData();
                const s1_companyName = currentS1RouteData ? currentS1RouteData.companyName : "승무일지";
                this.ui.headerTitle.textContent = `${s1_companyName} 승무일지`;

                // S2는 s2_currentDate (기본: 오늘) 기준
                const dateString = this.state.s2_currentDate.toISOString().slice(0, 10);
                const dayOfWeek = this.state.s2_currentDate.getDay();
                
                const allRoutes = DataManager.getAllRoutes();
                const s2_logData = DataManager.data.s2[dateString] || {}; // 오늘 날짜의 S2 데이터
                
                const container = this.ui.dispatchLogBody;
                container.innerHTML = ''; 
                
                for (const routeName in allRoutes) {
                    const routeData = allRoutes[routeName];
                    if (!routeData) continue;
                    
                    const routeId = this.sanitizeForId(routeName);
                    
                    // 1. S1 근무표 데이터 계산 (S1 데이터는 순서와 무관, 이름만 가져옴)
                    const todayS1Schedule = this.getTodayS1Schedule(routeData, dateString, dayOfWeek);
                    // 2. S2 저장된 데이터 (시간 등)
                    const todayS2RouteLog = s2_logData[routeName] || {};

                    // [수정] S2 차량 정렬 기능 (요청 2) + 순환주기 적용 (요청 3)
                    
                    // 3. S1의 기본 차량 목록 가져오기
                    let vehicleColumns = routeData.vehicleColumns || [];
                    // [수정 1] '미입력'을 필터링합니다. (S1에서 '차량1' 등으로 생성되므로 '미입력'은 S2에 표시되지 않음)
                    let baseVehicleList = vehicleColumns.filter(v => v && v !== '미입력');
                    
                    // 4. S1 목록 기본 정렬 (숫자먼저, 그다음 문자)
                    const isStandardVehicle = (num) => /^\d+$/.test(num.trim());
                    baseVehicleList.sort((a, b) => {
                        const aIsStd = isStandardVehicle(a);
                        const bIsStd = isStandardVehicle(b);
                        
                        if (aIsStd && !bIsStd) return -1;
                        else if (!aIsStd && bIsStd) return 1;
                        else if (aIsStd && bIsStd) return parseInt(a, 10) - parseInt(b, 10);
                        else return a.localeCompare(b);
                    });
                    
                    // 5. [핵심] 순환주기 규칙을 적용하여 오늘 날짜의 차량 순서 계산
                    const validVehicles = this.getAndUpdateVehicleOrder(routeName, baseVehicleList);
                    // [수정 끝]
                    
                    const tableHeader = this.createTableHeaderHTML(routeId);
                    let tableBodyHTML = '';
                    const halfCount = Math.ceil(validVehicles.length / 2);

                    for (let i = 0; i < halfCount; i++) {
                        const leftCar = validVehicles[i] || '미입력';
                        const rightCar = validVehicles[i + halfCount] || '미입력';
                        
                        const leftHTML = this.createRowSideHTML(routeName, leftCar, todayS1Schedule, todayS2RouteLog);
                        const rightHTML = this.createRowSideHTML(routeName, rightCar, todayS1Schedule, todayS2RouteLog);
                        
                        tableBodyHTML += `<tr>${leftHTML}${rightHTML}</tr>`;
                    }
                    
                    // [수정] S1의 원본 차량 목록(baseVehicleList)을 옵션으로 전달
                    const s2_optionsHTML = this.createOptionsHTML(routeId, routeName, baseVehicleList); 

                    container.insertAdjacentHTML('beforeend', `
                        <div class="route-section" id="route-${routeId}" data-route-name="${routeName}">
                            <div class="route-header-flex">
                                <div class="route-title-group">
                                    <div class="route-name-text">${routeName}</div>
                                </div>
                                ${s2_optionsHTML}
                            </div>
                            <table class="journal-table">
                                ${tableHeader}
                                <tbody>${tableBodyHTML}</tbody>
                            </table>
                        </div>
                    `);
                } 
                console.log("[S2] 승무일지 새로고침 완료.");
            },
            
            /**
             * [NEW] 새로고침 시 오늘 날짜의 S2 로그를 삭제하고,
             * 모든 노선의 출차 순서를 '수동'으로 초기화합니다.
             */
            resetS2LogForToday() {
                const dateString = this.state.s2_currentDate.toISOString().slice(0, 10);
                const allRoutes = DataManager.getAllRoutes();
                
                DataManager.updateS2Data(s2_data => {
                    // 1. 오늘 날짜(dateString)의 S2 데이터 삭제
                    if (s2_data[dateString]) {
                        delete s2_data[dateString];
                        console.log(`[S2] ${dateString} 날짜의 승무일지 데이터 삭제 완료.`);
                    }
                    
                    // 2. 모든 노선의 _settings를 '수동'으로 변경
                    for (const routeName in allRoutes) {
                        if (!s2_data[routeName]) s2_data[routeName] = {};
                        if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
                        
                        s2_data[routeName]._settings.dispatchType = 'manual';
                        s2_data[routeName]._settings.cycle = 'manual';
                    }
                    console.log("[S2] 모든 노선의 출차 순서를 '수동'으로 초기화했습니다.");
                });
            },

            /**
             * (Util) S1 데이터로부터 특정 날짜의 근무표 계산 (refreshDispatchLog에서 사용)
             */
            getTodayS1Schedule(routeData, dateString, dayOfWeek) {
                const tempSchedule = routeData.tempSchedule || {};
                const fixedSchedule = routeData.fixedSchedule || {};
                const vehicleColumns = routeData.vehicleColumns || [];
                let todayData = {};
                
                vehicleColumns.forEach(colId => {
                    if (colId === '미입력') return;
                    // 1. 임시 데이터 우선
                    if (tempSchedule[dateString] && tempSchedule[dateString][colId]) {
                        todayData[colId] = JSON.parse(JSON.stringify(tempSchedule[dateString][colId]));
                    } 
                    // 2. 임시 없으면 고정 데이터
                    else {
                        const recurringKey = `${dayOfWeek}-${colId}`;
                        if (fixedSchedule[recurringKey]) {
                            for (const entry of fixedSchedule[recurringKey]) {
                                if (new Date(dateString) >= new Date(entry.dateString)) {
                                    todayData[colId] = JSON.parse(JSON.stringify(entry.names));
                                    break;
                                }
                            }
                        }
                    }
                });
                return todayData;
            },
/**
             * (Util) 고정 근무자 정보 조회 (휴무자 표시용)
             */
            getFixedWorkersForCar(routeData, carNumber, dayOfWeek) {
                const fixedSchedule = routeData.fixedSchedule || {};
                let fixedNames = [{ text: '' }, { text: '' }];
                const recurringKey = `${dayOfWeek}-${carNumber}`;
                
                if (fixedSchedule[recurringKey] && fixedSchedule[recurringKey].length > 0) {
                     fixedNames = fixedSchedule[recurringKey][0].names;
                }
                return fixedNames;
            },


            // --- S2 HTML 생성 헬퍼 ---

            createTableHeaderHTML(routeId) {
                return `
                    <colgroup>
                        <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;">
                        <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;">
                        <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;">
                        <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>차번</th> <th>오전출발</th> <th>근무<br>시간</th> <th>오전근무</th>
                            <th>오후출발</th> <th>근무<br>시간</th> <th>오후근무</th> <th>휴무자</th>
                            <th>차번</th> <th>오전출발</th> <th>근무<br>시간</th> <th>오전근무</th>
                            <th>오후출발</th> <th>근무<br>시간</th> <th>오후근무</th> <th>휴무자</th>
                        </tr>
                    </thead>
                `;
            },
            
            /**
             * [수정] createOptionsHTML
             * @param {string} routeId - 노선 ID
             * @param {string} routeName - 노선 이름
             * @param {Array<string>} vehicleNumbers - S1의 *정렬된 원본* 차량 목록
             */
            createOptionsHTML(routeId, routeName, vehicleNumbers) {
                // vehicleNumbers는 S1의 기본 정렬 목록 (숫자 -> 문자)
                const vehicleOptions = vehicleNumbers.map(v => `<option value="${v}">${v}</option>`).join('');

                // [수정] S2 데이터에서 노선별 설정값 불러오기
                const s2_route_data = DataManager.data.s2[routeName] || {};
                const s2_settings = s2_route_data._settings || { dispatchType: 'manual', cycle: 'daily' };
                
                const dispatchType = s2_settings.dispatchType || 'manual';
                // [수정] '수동'일 때는 순환주기도 'manual' (고정) / 아닐 때는 'daily' (하루)
                const cycleType = (dispatchType === 'manual') ? 'manual' : (s2_settings.cycle || 'daily');
                const isManual = (dispatchType === 'manual');
                
                return `
                    <div class="dispatch-buttons-container" data-route-id="${routeId}">
                         <label>출차순서:</label>
                        <button type="button" class="dispatch-button ${dispatchType === 'manual' ? 'active' : ''}" data-order="manual">1. 수동</button>
                        <button type="button" class="dispatch-button ${dispatchType === 'ascending' ? 'active' : ''}" data-order="ascending">2. 올림</button>
                        <button type="button" class="dispatch-button ${dispatchType === 'descending' ? 'active' : ''}" data-order="descending">3. 내림</button>
                        <button type="button" class="dispatch-button ${dispatchType === 'random' ? 'active' : ''}" data-order="random">4. 랜덤</button>
                    </div>
                    <div class="dispatch-cycle-container" data-route-id="${routeId}">
                         <label>순환주기:</label>
                         <select class="dispatch-cycle-select" ${isManual ? 'disabled' : ''}>
                            <option value="manual" ${cycleType === 'manual' ? 'selected' : ''}>주기 없음 (고정)</option>
                            <option value="daily" ${cycleType === 'daily' ? 'selected' : ''}>하루</option>
                            <option value="weekly" ${cycleType === 'weekly' ? 'selected' : ''}>1주일</option>
                            <option value="monthly" ${cycleType === 'monthly' ? 'selected' : ''}>한달</option>
                         </select>
                    </div>
                    <div class="schedule-options">
                        <div class="am-options">
                            <span>[오전]</span>
                            <select name="vehicle_select_${routeId}_am"><option value="">첫차</option>${vehicleOptions}</select>
                            <input type="number" name="hour_${routeId}_am" min="0" max="23">시
                            <input type="number" name="minute_${routeId}_am" min="0" max="59">분
                            (배차간격 <input type="number" name="interval_${routeId}_am" min="0">분)
                        </div>
                        <div class="pm-options">
                            <span>[오후]</span>
                            <select name="vehicle_select_${routeId}_pm"><option value="">막차</option>${vehicleOptions}</select>
                            <input type="number" name="hour_${routeId}_pm" min="0" max="23">시
                            <input type="number" name="minute_${routeId}_pm" min="0" max="59">분
                            (배차간격 <input type="number" name="interval_${routeId}_pm" min="0">분)
                        </div>
                    </div>
                    <div class="settings-controls">
                        <button type="button" class="setting-button apply-button" data-route-id="${routeId}">시간 적용</button>
                        <button type="button" class="setting-button reset-button" data-route-id="${routeId}">초기화</button>
                    </div>
                `;
            },

            createRowSideHTML(routeName, carNumber, todayS1Schedule, todayS2RouteLog) {
                const routeId = this.sanitizeForId(routeName); 
                
                if (!carNumber || carNumber === '미입력') {
                    return '<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>';
                }

                // S1 근무표 데이터
                const s1CarData = todayS1Schedule[carNumber] || [{ text: '' }, { text: '' }];
                const amDriver = (s1CarData[0].text || '').replace(/\n/g, '<br>');
                const pmDriver = (s1CarData[1].text || '').replace(/\n/g, '<br>');
                const isRest = (amDriver.includes('휴무') || pmDriver.includes('휴무'));
                
                let s2_amDriver_html = isRest ? '' : amDriver;
                let s2_pmDriver_html = isRest ? '' : pmDriver;
                let s2_restDriver_html = '';

                if (isRest) {
                    if (amDriver && !amDriver.includes('휴무')) s2_restDriver_html = amDriver;
                    else if (pmDriver && !pmDriver.includes('휴무')) s2_restDriver_html = pmDriver;
                    else s2_restDriver_html = '휴무';
                } 
                else if (!amDriver && !pmDriver) {
                    try {
                        const dayOfWeek = this.state.s2_currentDate.getDay(); 
                        const routeData = DataManager.getAllRoutes()[routeName];
                        if (routeData) {
                            const fixedWorkers = this.getFixedWorkersForCar(routeData, carNumber, dayOfWeek);
                            const fixedAm = (fixedWorkers[0].text || '');
                            const fixedPm = (fixedWorkers[1].text || '');

                            if (fixedAm && fixedPm && !fixedAm.includes('휴무') && !fixedPm.includes('휴무')) {
                                s2_restDriver_html = `${fixedAm}<br>${fixedPm}`;
                            } else if (fixedAm && !fixedAm.includes('휴무')) {
                                s2_restDriver_html = fixedAm;
                            } else if (fixedPm && !fixedPm.includes('휴무')) {
                                s2_restDriver_html = fixedPm;
                            }
                        }
                    } catch (e) { console.error(`[${carNumber}] 휴무자 자동 계산 오류:`, e); }
                }

                // S2 승무일지 데이터 (시간, 근무시간)
                const s2CarLog = todayS2RouteLog[carNumber] || {};
                const amStartTime = s2CarLog[`start_time_${routeId}_${carNumber}_am`] || '';
                const amWorkHours = s2CarLog[`work_hours_${routeId}_${carNumber}_am`] || '';
                const pmStartTime = s2CarLog[`start_time_${routeId}_${carNumber}_pm`] || '';
                const pmWorkHours = s2CarLog[`work_hours_${routeId}_${carNumber}_pm`] || '';

                // [수정] 근무시간 '0'일 때 '기본'으로 표시하는 로직
                /**
                 * 근무시간 드롭다운 옵션을 생성합니다.
                 * "기본" (value="")은 0, "0", ""일 때 선택됩니다.
                 */
                const generateWorkHoursOptions = (selectedValue) => {
                    // 1. "기본"이 선택되어야 하는지 확인 (값이 없거나 0)
                    const isDefault = (selectedValue === '' || selectedValue == 0);
                    
                    // 2. "기본" 옵션 생성
                    let options = `<option value="" ${isDefault ? 'selected' : ''}>기본</option>`;
                    
                    // 3. 숫자 0-18 옵션 생성
                    for (let i = 0; i < 19; i++) {
                        // "기본"이 아닐 때, 그리고 저장된 값(selectedValue)이 현재 숫자(i)와 일치할 때 selected
                        options += `<option value="${i}" ${!isDefault && selectedValue == i ? 'selected' : ''}>${i}</option>`;
                    }
                    return options;
                };

                const workHoursSelect = generateWorkHoursOptions(amWorkHours);
                const workHoursSelectPM = generateWorkHoursOptions(pmWorkHours);
                // [수정 끝]

                return `
                    <td class="car-number-cell" data-car-number="${carNumber}" draggable="true">
                        <div class="car-display">${carNumber}</div>
                        <div class="car-controls hidden">
                            <select class="car-select-dropdown"></select>
                            <div>
                               <button type="button" class="btn-car-delete">삭제</button>
                        <button type="button" class="btn-car-close">닫기</button>
                    </div>
                </div>
            </td>
            <td data-edit-type="time" data-route-id="${routeId}" data-car-number="${carNumber}" data-time-type="am">
                <input type="text" inputmode="numeric" name="start_time_${routeId}_${carNumber}_am" value="${amStartTime}" placeholder="00:00">
            </td>
            <td data-edit-type="work-hours" data-route-id="${routeId}" data-car-number="${carNumber}" data-time-type="am">
                <select class="s2-work-hours-select" name="work_hours_${routeId}_${carNumber}_am">${workHoursSelect}</select>
            </td>
            <td data-edit-type="driver" data-route-id="${routeId}" data-car-number="${carNumber}" data-time-type="am" data-original-name="${s1CarData[0].text || ''}">${s2_amDriver_html}</td>
            <td data-edit-type="time" data-route-id="${routeId}" data-car-number="${carNumber}" data-time-type="pm">
                <input type="text" inputmode="numeric" name="start_time_${routeId}_${carNumber}_pm" value="${pmStartTime}" placeholder="00:00">
            </td>
            <td data-edit-type="work-hours" data-route-id="${routeId}" data-car-number="${carNumber}" data-time-type="pm">
                <select class="s2-work-hours-select" name="work_hours_${routeId}_${carNumber}_pm">${workHoursSelectPM}</select>
            </td>
            <td data-edit-type="driver" data-route-id="${routeId}" data-car-number="${carNumber}" data-time-type="pm" data-original-name="${s1CarData[1].text || ''}">${s2_pmDriver_html}</td>
            <td data-edit-type="rest" data-route-id="${routeId}" data-car-number="${carNumber}">${s2_restDriver_html}</td>
        `;
    },


    // --- [수정] S2 배차시간 자동 적용 ---
    /**
     * '시간 적용' 버튼 클릭 시 배차 시간을 계산하여 적용합니다.
     */
    applyScheduleSettings(routeId) {
        const section = document.getElementById(`route-${routeId}`);
        if (!section) return;

        const routeName = section.dataset.routeName;

        // 1. 오전 설정값 읽기
        const amStartVehicle = section.querySelector(`select[name="vehicle_select_${routeId}_am"]`).value;
        const amStartHour = parseInt(section.querySelector(`input[name="hour_${routeId}_am"]`).value, 10);
        const amStartMinute = parseInt(section.querySelector(`input[name="minute_${routeId}_am"]`).value, 10);
        const amInterval = parseInt(section.querySelector(`input[name="interval_${routeId}_am"]`).value, 10);

        // 2. 오후 설정값 읽기
        const pmStartVehicle = section.querySelector(`select[name="vehicle_select_${routeId}_pm"]`).value;
        const pmStartHour = parseInt(section.querySelector(`input[name="hour_${routeId}_pm"]`).value, 10);
        const pmStartMinute = parseInt(section.querySelector(`input[name="minute_${routeId}_pm"]`).value, 10);
        const pmInterval = parseInt(section.querySelector(`input[name="interval_${routeId}_pm"]`).value, 10);

        // 3. 현재 표시된 차량 순서 읽기
        const carCells = section.querySelectorAll('td.car-number-cell');
        const vehicleOrder = Array.from(carCells).map(cell => cell.dataset.carNumber).filter(Boolean);

        // 4. S2 데이터 저장을 위한 준비
        const dateString = this.state.s2_currentDate.toISOString().slice(0, 10);

        DataManager.updateS2Data(s2_data => {
            if (!s2_data[dateString]) s2_data[dateString] = {};
            if (!s2_data[dateString][routeName]) s2_data[dateString][routeName] = {};

            const s2_log = s2_data[dateString][routeName];

            // 5. 오전 시간 적용 (첫차, 간격 기준)
            if (amStartVehicle && !isNaN(amStartHour) && !isNaN(amStartMinute) && !isNaN(amInterval)) {
                const startIndex = vehicleOrder.indexOf(amStartVehicle);
                if (startIndex > -1) {
                    let currentTime = new Date();
                    currentTime.setHours(amStartHour, amStartMinute, 0, 0);

                    // 첫차부터 순서대로
                    for (let i = startIndex; i < vehicleOrder.length; i++) {
                        const carNum = vehicleOrder[i];
                        const timeStr = currentTime.toTimeString().slice(0, 5);
                        section.querySelector(`input[name="start_time_${routeId}_${carNum}_am"]`).value = timeStr;
                        if (!s2_log[carNum]) s2_log[carNum] = {};
                        s2_log[carNum][`start_time_${routeId}_${carNum}_am`] = timeStr;
                        currentTime.setMinutes(currentTime.getMinutes() + amInterval);
                    }
                    // 첫차 이전 차량들
                    for (let i = 0; i < startIndex; i++) {
                        const carNum = vehicleOrder[i];
                        const timeStr = currentTime.toTimeString().slice(0, 5);
                        section.querySelector(`input[name="start_time_${routeId}_${carNum}_am"]`).value = timeStr;
                        if (!s2_log[carNum]) s2_log[carNum] = {};
                        s2_log[carNum][`start_time_${routeId}_${carNum}_am`] = timeStr;
                        currentTime.setMinutes(currentTime.getMinutes() + amInterval);
                    }
                }
            }

            // 6. 오후 시간 적용 (막차, 간격 기준)
            if (pmStartVehicle && !isNaN(pmStartHour) && !isNaN(pmStartMinute) && !isNaN(pmInterval)) {
                const startIndex = vehicleOrder.indexOf(pmStartVehicle);
                if (startIndex > -1) {
                    let currentTime = new Date();
                    currentTime.setHours(pmStartHour, pmStartMinute, 0, 0);

                    // 막차부터 역순으로
                    for (let i = startIndex; i >= 0; i--) {
                        const carNum = vehicleOrder[i];
                        const timeStr = currentTime.toTimeString().slice(0, 5);
                        section.querySelector(`input[name="start_time_${routeId}_${carNum}_pm"]`).value = timeStr;
                        if (!s2_log[carNum]) s2_log[carNum] = {};
                        s2_log[carNum][`start_time_${routeId}_${carNum}_pm`] = timeStr;
                        currentTime.setMinutes(currentTime.getMinutes() - pmInterval);
                    }
                    // 막차 이후 차량들 (순서상 뒤)
                    for (let i = vehicleOrder.length - 1; i > startIndex; i--) {
                        const carNum = vehicleOrder[i];
                        const timeStr = currentTime.toTimeString().slice(0, 5);
                        section.querySelector(`input[name="start_time_${routeId}_${carNum}_pm"]`).value = timeStr;
                        if (!s2_log[carNum]) s2_log[carNum] = {};
                        s2_log[carNum][`start_time_${routeId}_${carNum}_pm`] = timeStr;
                        currentTime.setMinutes(currentTime.getMinutes() - pmInterval);
                    }
                }
            }
        });

        alert(`[${routeName}] 배차 시간이 적용되었습니다. (S2 일지에 저장됨)`);
    },
    
    /**
     * '초기화' 버튼 클릭 시 시간 초기화
     */
    resetScheduleSettings(routeId) {
        const section = document.getElementById(`route-${routeId}`);
        if (!section) return;
        
        if (!confirm('입력된 배차 시간 설정(시작차량, 시간, 간격)을 초기화하시겠습니까? (승무일지에 저장된 시간은 삭제되지 않습니다.)')) {
            return;
        }

        section.querySelector(`select[name="vehicle_select_${routeId}_am"]`).value = "";
        section.querySelector(`input[name="hour_${routeId}_am"]`).value = "";
        section.querySelector(`input[name="minute_${routeId}_am"]`).value = "";
        section.querySelector(`input[name="interval_${routeId}_am"]`).value = "";
        section.querySelector(`select[name="vehicle_select_${routeId}_pm"]`).value = "";
        section.querySelector(`input[name="hour_${routeId}_pm"]`).value = "";
        section.querySelector(`input[name="minute_${routeId}_pm"]`).value = "";
        section.querySelector(`input[name="interval_${routeId}_pm"]`).value = "";
    },
    
    // --- S2 데이터 저장 (날짜/차량/시간) ---

    /**
     * (Util) S2 데이터 저장 (시간, 근무시간)
     */
    saveS2LogEntry(routeName, carNumber, fieldName, value) {
        const dateString = this.state.s2_currentDate.toISOString().slice(0, 10);
        
        DataManager.updateS2Data(s2_data => {
            if (!s2_data[dateString]) s2_data[dateString] = {};
            if (!s2_data[dateString][routeName]) s2_data[dateString][routeName] = {};
            if (!s2_data[dateString][routeName][carNumber]) s2_data[dateString][routeName][carNumber] = {};
            
            s2_data[dateString][routeName][carNumber][fieldName] = value;
        });
    },

    // --- S2 근무자 이름 수정 (S1 데이터 연동) ---

    /**
     * (UI) 근무자 이름 셀 편집 모드 진입/종료
     */
    toggleEditMode(td) {
        if (td.classList.contains('edit-mode')) {
            this.saveAndExit(td);
        } else {
            // 모든 다른 편집 모드 종료
            document.querySelectorAll('#section2 td.edit-mode').forEach(cell => this.saveAndExit(cell));
            
            const currentHTML = td.innerHTML;
            const originalName = td.dataset.originalName || currentHTML.replace(/<br>/g, '\n');
            td.classList.add('edit-mode');
            td.innerHTML = `
                <textarea class="driver-input">${originalName}</textarea>
                <div class="edit-controls">
                    <button type="button" class="btn-driver-delete">삭제</button>
                    <button type="button" class="btn-driver-save">저장</button>
                </div>
            `;
            const textarea = td.querySelector('.driver-input');
            textarea.focus();
            textarea.select();
        }
    },
    
    /**
     * (UI) 이름 삭제 (S1 임시 데이터 '휴무'로 저장)
     */
    deleteName(td) {
        const textarea = td.querySelector('.driver-input');
        if (textarea) {
            textarea.value = '휴무';
            this.saveAndExit(td);
        }
    },

    /**
     * [데이터 연동] 이름 저장 (S1 임시 데이터 저장)
     */
    saveAndExit(td) {
        if (!td.classList.contains('edit-mode')) return;

        const textarea = td.querySelector('.driver-input');
        const newName = textarea.value.trim();
        const routeName = td.closest('.route-section').dataset.routeName;
        const carNumber = td.dataset.carNumber;
        const timeType = td.dataset.timeType; // 'am' or 'pm'
        
        // 1. UI 복원
        td.classList.remove('edit-mode');
        td.innerHTML = newName.replace(/\n/g, '<br>');

        // 2. DataManager를 통해 S1 데이터 수정 요청
        const dateString = this.state.s2_currentDate.toISOString().slice(0, 10);
        
        DataManager.updateS1Data(s1_data => {
            const routeData = s1_data.routes[routeName];
            if (!routeData) return;

            // S2는 S1의 '임시(tempSchedule)' 데이터만 수정
            if (!routeData.tempSchedule[dateString]) routeData.tempSchedule[dateString] = {};
            
            // S1의 원본 데이터(고정/임시)를 먼저 로드
            const s1TodayData = this.getTodayS1Schedule(routeData, dateString, this.state.s2_currentDate.getDay());
            let namesToSave = s1TodayData[carNumber] ? JSON.parse(JSON.stringify(s1TodayData[carNumber])) : [{ text: '', bold: false }, { text: '', bold: false }];

            // S1 데이터가 없는 경우(예: 신규), 원본 데이터셋 생성
            if (!namesToSave[0]) namesToSave[0] = { text: '', bold: false };
            if (!namesToSave[1]) namesToSave[1] = { text: '', bold: false };

            // 해당 시간대(오전/오후)의 이름만 변경
            if (timeType === 'am') {
                namesToSave[0].text = newName;
            } else {
                namesToSave[1].text = newName;
            }
            
            // 임시 데이터로 저장
            routeData.tempSchedule[dateString][carNumber] = namesToSave;
        });
        
        // DataManager가 S1에 알림을 보내고, S1이 S2에 다시 알림을 보내
        // refreshDispatchLog()를 자동 호출하여 S2 화면을 갱신합니다.
    },


    // --- S2 차량 번호 수정 (S1 데이터 연동) ---
    
    /**
     * (UI) 차량 번호 셀 편집 모드
     */
    toggleCarNumberEditMode(td, routeName) {
        const controls = td.querySelector('.car-controls');
        if (controls.classList.contains('hidden')) {
            // 다른 모든 편집 모드 종료
            document.querySelectorAll('#section2 .car-controls:not(.hidden)').forEach(
                c => c.classList.add('hidden')
            );
            
            const select = controls.querySelector('select');
            const currentCar = td.dataset.carNumber;
            
            // S1의 원본 차량 목록 로드 (S2_Module.refreshDispatchLog 참조)
            const routeData = DataManager.getAllRoutes()[routeName];
            let vehicleColumns = (routeData.vehicleColumns || []).filter(v => v && v !== '미입력');
            const isStandardVehicle = (num) => /^\d+$/.test(num.trim());
            vehicleColumns.sort((a, b) => {
                const aIsStd = isStandardVehicle(a);
                const bIsStd = isStandardVehicle(b);
                if (aIsStd && !bIsStd) return -1;
                else if (!aIsStd && bIsStd) return 1;
                else if (aIsStd && bIsStd) return parseInt(a, 10) - parseInt(b, 10);
                else return a.localeCompare(b);
            });

            // 드롭다운 옵션 채우기 (현재 S2에 없는 차량만)
            const s2_cars_in_route = new Set(
                Array.from(document.querySelectorAll(`#route-${this.sanitizeForId(routeName)} .car-number-cell`))
                    .map(cell => cell.dataset.carNumber)
                    .filter(Boolean)
            );

            select.innerHTML = `<option value="">-- 차량 변경 --</option>`;
            vehicleColumns.forEach(car => {
                if (!s2_cars_in_route.has(car) || car === currentCar) {
                    select.innerHTML += `<option value="${car}" ${car === currentCar ? 'selected' : ''}>${car}</option>`;
                }
            });

            controls.classList.remove('hidden');
        } else {
            this.exitCarNumberEditMode(td);
        }
    },

    /**
     * (UI) 차량 번호 편집 모드 종료
     */
    exitCarNumberEditMode(td) {
        td.querySelector('.car-controls').classList.add('hidden');
    },

    /**
     * [데이터 연동] 차량 번호 변경 (S1 데이터 수정)
     */
    changeCarNumber(selectElement, routeName) {
        const newCarNumber = selectElement.value;
        if (!newCarNumber) return;

        const td = selectElement.closest('.car-number-cell');
        const oldCarNumber = td.dataset.carNumber;

        if (newCarNumber === oldCarNumber) {
            this.exitCarNumberEditMode(td);
            return;
        }

        // S1 데이터에서 oldCarNumber를 newCarNumber로 변경 (모든 데이터 복사)
        if (confirm(`[${oldCarNumber}] 차량을 [${newCarNumber}] 차량으로 교체하시겠습니까?\nS1(근무현황표)의 모든 고정/임시/근무형태 데이터가 [${oldCarNumber}]에서 [${newCarNumber}]로 이동(덮어쓰기)됩니다.`)) {
            
            DataManager.updateS1Data(s1_data => {
                const routeData = s1_data.routes[routeName];
                if (!routeData) return;

                // 1. vehicleColumns (차량 목록) 업데이트
                const index = routeData.vehicleColumns.indexOf(oldCarNumber);
                if (index > -1) {
                    routeData.vehicleColumns[index] = newCarNumber;
                } else {
                    // S2에만 있는 차량이었다면 (데이터 불일치) S1에 추가
                    routeData.vehicleColumns.push(newCarNumber);
                }
                // newCarNumber가 S1에 이미 있었다면 (중복 발생) 삭제
                routeData.vehicleColumns = routeData.vehicleColumns.filter((v, i) => 
                    v !== oldCarNumber || i === index
                );
                
                // 2. fixedSchedule (고정 근무표) 키 변경
                for (const key in routeData.fixedSchedule) {
                    if (key.endsWith(`-${oldCarNumber}`)) {
                        const newKey = key.replace(`-${oldCarNumber}`, `-${newCarNumber}`);
                        routeData.fixedSchedule[newKey] = routeData.fixedSchedule[key];
                        delete routeData.fixedSchedule[key];
                    }
                }

                // 3. tempSchedule (임시 근무표) 키 변경
                for (const date in routeData.tempSchedule) {
                    if (routeData.tempSchedule[date][oldCarNumber]) {
                        routeData.tempSchedule[date][newCarNumber] = routeData.tempSchedule[date][oldCarNumber];
                        delete routeData.tempSchedule[date][oldCarNumber];
                    }
                }

                // 4. workTypeConfig (근무 형태) 키 변경
                if (routeData.workTypeConfig[oldCarNumber]) {
                    routeData.workTypeConfig[newCarNumber] = routeData.workTypeConfig[oldCarNumber];
                    delete routeData.workTypeConfig[oldCarNumber];
                }
            });
            
            // S2 데이터도 변경 (S2는 S1 알림을 받아 자동 갱신되므로 필수는 아님)
            // ... (S2 데이터 변경 로직은 S1 갱신 알림으로 대체됨)
        }
        
        this.exitCarNumberEditMode(td);
        // S1이 변경되었으므로 S2는 자동으로 refreshDispatchLog()가 호출됨
    },

    /**
     * [데이터 연동] 차량 삭제 (S1 데이터 수정)
     */
    deleteCarRow(td) {
        const carNumber = td.dataset.carNumber;
        const routeName = td.closest('.route-section').dataset.routeName;

        if (confirm(`[${routeName}] 노선의 [${carNumber}] 차량을 삭제하시겠습니까?\nS1(근무현황표)의 모든 고정/임시/근무형태 데이터가 영구적으로 삭제됩니다.`)) {
            
            DataManager.updateS1Data(s1_data => {
                const routeData = s1_data.routes[routeName];
                if (!routeData) return;

                // 1. vehicleColumns (차량 목록) 삭제
                routeData.vehicleColumns = routeData.vehicleColumns.filter(v => v !== carNumber);
                
                // 2. fixedSchedule (고정 근무표) 삭제
                for (const key in routeData.fixedSchedule) {
                    if (key.endsWith(`-${carNumber}`)) {
                        delete routeData.fixedSchedule[key];
                    }
                }

                // 3. tempSchedule (임시 근무표) 삭제
                for (const date in routeData.tempSchedule) {
                    if (routeData.tempSchedule[date][carNumber]) {
                        delete routeData.tempSchedule[date][carNumber];
                    }
                }

                // 4. workTypeConfig (근무 형태) 삭제
                if (routeData.workTypeConfig[carNumber]) {
                    delete routeData.workTypeConfig[carNumber];
                }
            });
            
            // S2 데이터도 삭제 (S2는 S1 알림을 받아 자동 갱신되므로 필수는 아님)
            // ... (S2 데이터 변경 로직은 S1 갱신 알림으로 대체됨)
        }
        
        this.exitCarNumberEditMode(td);
        // S1이 변경되었으므로 S2는 자동으로 refreshDispatchLog()가 호출됨
    },

    // --- S2 드래그 앤 드롭 (차량 순서 변경) ---
    
    dragStart(e, routeName) {
        const target = e.target.closest('td.car-number-cell');
        if (target) {
            this.state.s2_draggedCell = target;
            this.state.s2_draggedRoute = routeName;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', target.dataset.carNumber);
            setTimeout(() => target.style.opacity = '0.5', 0);
        }
    },
    dragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    },
    drop(e, routeName) {
        e.preventDefault();
        const dropTarget = e.target.closest('td.car-number-cell');
        
        if (dropTarget && this.state.s2_draggedCell && this.state.s2_draggedRoute === routeName) {
            const dragCar = this.state.s2_draggedCell.dataset.carNumber;
            const dropCar = dropTarget.dataset.carNumber;

            if (dragCar !== dropCar) {
                this.swapVehicleOrder(routeName, dragCar, dropCar);
            }
        }
        this.dragEnd(e);
    },
    dragEnd(e) {
        if (this.state.s2_draggedCell) {
            this.state.s2_draggedCell.style.opacity = '1';
        }
        this.state.s2_draggedCell = null;
        this.state.s2_draggedRoute = null;
    },

    /**
     * [데이터 연동] 차량 순서 변경 (S1 데이터 수정)
     */
    swapVehicleOrder(routeName, carA, carB) {
        // S1의 vehicleColumns 순서 변경
        DataManager.updateS1Data(s1_data => {
            const routeData = s1_data.routes[routeName];
            if (!routeData || !routeData.vehicleColumns) return;

            const indexA = routeData.vehicleColumns.indexOf(carA);
            const indexB = routeData.vehicleColumns.indexOf(carB);

            if (indexA > -1 && indexB > -1) {
                // S1의 차량 목록 순서를 직접 교체
                [routeData.vehicleColumns[indexA], routeData.vehicleColumns[indexB]] = 
                [routeData.vehicleColumns[indexB], routeData.vehicleColumns[indexA]];
            }
        });

        // S1 데이터가 변경되었으므로, S2는 알림을 받아 자동으로 refreshDispatchLog()를 호출
    },

    // --- [수정] S2 백업 / 복원 (단순화) ---

    /**
     * S2 승무일지 데이터 백업 (S2_LOG_KEY 전체)
     */
    backupLogData() {
        const s2_data = DataManager.data.s2;
        if (Object.keys(s2_data).length === 0) {
            alert('백업할 승무일지(S2) 데이터가 없습니다.');
            return;
        }

        const jsonString = JSON.stringify(s2_data);
        const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
        
        const now = new Date();
        const dateString = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
        
        const { routeName, routeData } = DataManager.getCurrentRouteData();
        let companyName = "전체";
        if (routeData && routeData.companyName) {
            companyName = routeData.companyName.replace(/\s/g, '');
        }

        const filename = `${companyName}_승무일지(S2)_${dateString}.json`;
        
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        alert(`승무일지(S2) 전체 데이터 파일 (${filename})이 다운로드 폴더에 JSON 파일로 저장됩니다.`);
    },
    
    showRestoreModal() {
        this.ui.restoreModal.style.display = 'block';
    },
    hideRestoreModal() {
        this.ui.restoreModal.style.display = 'none';
        this.ui.restoreFile.value = '';
    },
    triggerRestore() {
        this.ui.restoreFile.click();
    },

    /**
     * S2 승무일지 데이터 복원 (S2_LOG_KEY 전체 덮어쓰기)
     */
    restoreLogData(file) {
        if (!file) return;

        if (!confirm(`[${file.name}] 파일을 업로드하여 *모든* 날짜의 승무일지(S2) 데이터를 덮어쓰시겠습니까?`)) {
            this.ui.restoreFile.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const loadedData = JSON.parse(event.target.result);
                
                // S2 데이터는 날짜(YYYY-MM-DD)를 키로 가짐
                if (typeof loadedData !== 'object' || loadedData === null || Array.isArray(loadedData)) {
                     alert('파일 형식이 올바르지 않습니다. S2 백업 파일이 아닙니다.');
                     throw new Error('Invalid S2 saved file structure');
                }
                
                // DataManager에 데이터 수정을 요청 (S2 전체 덮어쓰기)
                DataManager.updateS2Data(s2_data => {
                    // 기존 S2 데이터 모두 삭제
                    Object.keys(s2_data).forEach(key => delete s2_data[key]);
                    // 새 데이터로 채우기
                    Object.assign(s2_data, loadedData);
                });

                alert(`[${file.name}] 파일로부터 S2 승무일지 전체 데이터 복원을 완료했습니다.`);
                
                // 현재 날짜 기준으로 화면 새로고침
                this.refreshDispatchLog();

            } catch (e) {
                alert('파일을 읽는 도중 오류가 발생했습니다. 파일이 손상되었거나 JSON 형식이 아닙니다.');
                console.error('S2 Restore Error:', e);
            } finally {
                this.ui.restoreFile.value = '';
            }
        };
        reader.onerror = () => {
            alert('파일을 읽을 수 없습니다.');
            this.ui.restoreFile.value = '';
        };
        reader.readAsText(file);
    }
};

/* ================================================================= */
/* [Section 3] 정비일지 JavaScript */
/* ================================================================= */

/**
 * 4. S3(정비일지) 모듈
 * - S1 데이터 변경 시(onDataChanged) 노선/차량 드롭다운을 갱신합니다.
 * - S3 일지 데이터를 날짜별로 백업/복원합니다.
 */
const S3_Module = {
    // S3 UI 요소
    ui: {
        container: document.getElementById('section3'),
        maintenanceContainer: document.querySelector('#section3 .maintenance-container'),
        form: document.getElementById('maintenanceForm'),
        dateDisplay: document.getElementById('s3_dateDisplay'),
        title: document.getElementById('s3_title'),
        tbody: document.querySelector('#section3 .form-table tbody'),
        // 인쇄
        marginLeftSelect: document.getElementById('s3_marginLeft'),
        marginRightSelect: document.getElementById('s3_marginRight'),
        fontSizeInput: document.getElementById('s3_fontSizeInput'),
        // 모달
        restoreModal: document.getElementById('s3_restoreDateModal'), // 이 ID는 파일에 없음 (가정)
        restoreFile: document.getElementById('s3_restoreFile'),
        // 계산기 모달
        calculatorModal: document.getElementById('s3_calculatorModal'),
        startDateInput: document.getElementById('s3_startDate'),
        endDateInput: document.getElementById('s3_endDate'),
        totalPriceDisplay: document.getElementById('s3_totalPrice'),
    },

    // S3 내부 상태
    state: {
        s3_currentDate: new Date(),
        s3_rowCount: 10,
    },

    /**
     * S3 모듈 초기화 (DOM 로드 시 1회 실행)
     */
    initialize() {
        console.log("S3: 초기화 시작");
        DataManager.subscribe(this); // DataManager에 S3 모듈 등록
        DataManager.loadS3Data();    // S3 전용 일지 데이터 로드

        // S3는 기본적으로 '오늘' 날짜 기준
        this.state.s3_currentDate = new Date(); 
        this.updateDateDisplay(this.state.s3_currentDate);

        this.bindEventListeners();
        
        // S1 데이터 기준으로 S3 드롭다운 채우기
        this.populateAllRouteSelects();
        // S3 데이터 로드
        this.loadFormData(this.state.s3_currentDate);
        
        console.log("S3: 초기화 완료.");
    },
    
    /**
     * [핵심] DataManager로부터 알림을 처리하는 함수 (S1에서 데이터 변경 시)
     */
    onDataChanged(event, payload) {
        if (event === 's1_data_changed') {
            console.log("[S3] S1로부터 데이터 변경 알림 수신. S3 드롭다운 갱신.");
            // S1 데이터(노선/차량)가 변경되었으므로 S3의 드롭다운을 새로고침
            this.populateAllRouteSelects();
            // 현재 S3 화면에 로드된 데이터와 S1 데이터가 일치하지 않을 수 있으므로
            // 차량 표시(vehicle-display) 영역도 갱신
            this.reloadVehicleDisplays();
        }
    },

    /**
     * (Util) 날짜 변경 시 S3 화면 갱신 (날짜 표시, 데이터 로드)
     */
    changeDate(newDate) {
        this.saveFormData(this.state.s3_currentDate); // 변경 전 날짜 저장
        this.state.s3_currentDate = newDate;
        this.updateDateDisplay(newDate);
        this.clearForm(false); // UI만 클리어 (저장 X)
        this.loadFormData(newDate); // 새 날짜 로드
    },

    /**
     * (UI) S3 헤더 날짜 업데이트
     */
    updateDateDisplay(dateObj) {
        const dateString = dateObj.toLocaleDateString('ko-KR', { 
            year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'long' 
        }).replace(/\. /g, '.').replace(/\.$/, '');
        
        this.ui.dateDisplay.textContent = dateString;
        
        const { routeData } = DataManager.getCurrentRouteData();
        const companyName = (routeData && routeData.companyName) || "차량정비";
        this.ui.title.textContent = `${companyName} 차량정비점검일지 및 작업의뢰서`;
    },

    /**
     * S3의 모든 이벤트 리스너 바인딩
     */
    bindEventListeners() {
        // 상단 버튼
        document.getElementById('s3-showAll').onclick = () => S1_Module.showAllSections();
        document.getElementById('s3-backupFile').onclick = () => this.backupLogData();
        document.getElementById('s3-triggerRestore').onclick = () => this.triggerRestore();
        document.getElementById('s3_restoreFile').onchange = (e) => this.restoreLogData(e.target.files[0]);
        document.getElementById('s3-clearForm').onclick = () => this.clearForm(true);
        document.getElementById('s3-printPage').onclick = () => this.printPage();
        
        // 인쇄 설정
        this.ui.marginLeftSelect.onchange = (e) => document.documentElement.style.setProperty('--s3-print-margin-left', `${e.target.value}mm`);
        this.ui.marginRightSelect.onchange = (e) => document.documentElement.style.setProperty('--s3-print-margin-right', `${e.target.value}mm`);
        this.ui.fontSizeInput.onchange = (e) => this.applyFontSize(e.target.value);
        
        // 테이블 하단
        document.getElementById('s3-addRow').onclick = (e) => this.addRow(e);

        // 테이블 내부 이벤트 (위임)
        this.ui.tbody.oninput = (e) => {
            const target = e.target;
            // 자동 저장
            this.saveFormData(this.state.s3_currentDate); 
            
            // 텍스트 영역 자동 크기 조절
            if (target.tagName === 'TEXTAREA' && target.classList.contains('auto-resize')) {
                this.autoResizeTextarea(target);
            }
            // 가격 포맷팅
            if (target.classList.contains('price-input')) {
                this.formatPriceInput(target);
            }
        };
        
        this.ui.tbody.onchange = (e) => {
            // 노선/차량 드롭다운 변경
            if (e.target.classList.contains('s3_routeSelect_row')) {
                this.handleRouteSelectChange(e.target);
            }
            if (e.target.classList.contains('s3_vehicleSelect_row')) {
                this.handleVehicleSelectChange(e.target);
            }
        };

        // 계산기 모달
        document.getElementById('s3-showCalculator').onclick = () => this.showCalculator();
        document.getElementById('s3-closeCalculator').onclick = () => this.hideCalculator();
        document.getElementById('s3-calculatePrices').onclick = () => this.calculatePrices();
    },
    
    // --- S3 폼/데이터 관리 ---

    /**
     * (UI) 폼 전체 초기화 (날짜 변경 없음)
     */
    clearForm(confirmClear = false) {
        if (confirmClear) {
            if (!confirm(`[${this.ui.dateDisplay.textContent}]의 정비일지 내용을 모두 삭제하시겠습니까? (저장된 데이터도 삭제됩니다.)`)) {
                return;
            }
            // S3 데이터에서도 삭제
            const dateString = this.state.s3_currentDate.toISOString().slice(0, 10);
            DataManager.updateS3Data(s3_data => {
                delete s3_data[dateString];
            });
        }
        
        this.ui.form.reset();
        this.ui.tbody.querySelectorAll('.s3_added-row').forEach(row => row.remove());
        this.state.s3_rowCount = 10;
        
        // UI 초기화
        this.ui.tbody.querySelectorAll('textarea').forEach(ta => {
            ta.value = '';
            this.autoResizeTextarea(ta);
        });
        this.ui.tbody.querySelectorAll('input.price-input').forEach(inp => inp.value = '');
        this.ui.tbody.querySelectorAll('.vehicle-display').forEach(div => div.textContent = '');
        this.ui.tbody.querySelectorAll('.s3_vehicleSelect_row').forEach(sel => sel.style.display = 'none');
        
        this.populateAllRouteSelects();
    },

    /**
     * [데이터 연동] S3 데이터 저장 (특정 날짜)
     */
    saveFormData(dateObj) {
        const dateString = dateObj.toISOString().slice(0, 10);
        const formData = new FormData(this.ui.form);
        const dataToSave = {};
        let isEmpty = true;

        for (let [key, value] of formData.entries()) {
            if (value) {
                dataToSave[key] = value;
                if (key.startsWith('item_') || key.startsWith('detail_') || key.startsWith('parts_') || key.startsWith('price_') || key.startsWith('worker_')) {
                    isEmpty = false;
                }
            }
        }
        
        DataManager.updateS3Data(s3_data => {
            if (isEmpty) {
                delete s3_data[dateString]; // 빈 데이터면 삭제
            } else {
                s3_data[dateString] = dataToSave; // 데이터 저장
            }
        });
    },

    /**
     * [데이터 연동] S3 데이터 로드 (특정 날짜)
     */
    loadFormData(dateObj) {
        const dateString = dateObj.toISOString().slice(0, 10);
        const s3_data = DataManager.data.s3;
        const dataToLoad = s3_data[dateString];

        if (!dataToLoad) {
            console.log(`[S3] ${dateString} 데이터 없음.`);
            return;
        }

        console.log(`[S3] ${dateString} 데이터 로드.`);
        
        // 1. 저장된 데이터 기준으로 행(row)이 부족하면 동적 생성
        let maxRowIndex = 10;
        Object.keys(dataToLoad).forEach(key => {
            const match = key.match(/_(\d+)_(\d+)$/);
            if (match) {
                const rowIndex = parseInt(match[1], 10);
                if (rowIndex > maxRowIndex) maxRowIndex = rowIndex;
            }
        });
        
        while (this.state.s3_rowCount < maxRowIndex) {
            this.addRow(null, false); // 이벤트 없고, 저장 안 함
        }

        // 2. 폼 요소에 데이터 채우기
        for (const key in dataToLoad) {
            const element = this.ui.form.elements[key];
            if (element) {
                element.value = dataToLoad[key];

                // 3. 텍스트 영역 높이 조절
                if (element.tagName === 'TEXTAREA') {
                    this.autoResizeTextarea(element);
                }
                // 4. 가격 포맷팅
                if (element.classList.contains('price-input')) {
                    this.formatPriceInput(element);
                }
                // 5. 차량 드롭다운 상태 복원
                if (element.classList.contains('s3_routeSelect_row')) {
                    this.handleRouteSelectChange(element); // 노선 선택
                }
                if (element.classList.contains('s3_vehicleSelect_row')) {
                    this.handleVehicleSelectChange(element); // 차량 선택
                }
            }
        }
    },

    // --- S3 행/드롭다운 관리 ---

    /**
     * (UI) 정비일지 행 추가
     */
    addRow(event, shouldSave = true) {
        if (event) event.preventDefault();
        this.state.s3_rowCount++;
        const rowIndex = Math.ceil(this.state.s3_rowCount / 6); // 1, 2, 3...
        const subIndex = ((this.state.s3_rowCount - 1) % 6) + 1; // 1, 2... 6
        const baseName = `${rowIndex}_${subIndex}`;

        const newRow = document.createElement('tr');
        newRow.classList.add('entry-row', 's3_added-row');
        newRow.innerHTML = `
            <td class="route-select-cell">
                <select class="header-select s3_routeSelect_row no-print" name="route_${baseName}"></select>
                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_${baseName}" style="display: none;"></select>
                <div class="vehicle-display"></div>
            </td>
            <td><textarea name="item_${baseName}" class="auto-resize"></textarea></td>
            <td><textarea name="detail_${baseName}" class="auto-resize"></textarea></td>
            <td><textarea name="parts_${baseName}" class="auto-resize"></textarea></td>
            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_${baseName}" class="price-input" /></div></td>
            <td><textarea name="worker_${baseName}" class="auto-resize"></textarea></td>
        `;

        // 새 행의 노선 드롭다운 채우기
        this.populateRouteSelect(newRow.querySelector('.s3_routeSelect_row'));
        this.ui.tbody.appendChild(newRow);
        
        if (shouldSave) {
            this.saveFormData(this.state.s3_currentDate);
        }
    },

    /**
     * (UI) 모든 노선 드롭다운 채우기
     */
    populateAllRouteSelects() {
        this.ui.tbody.querySelectorAll('.s3_routeSelect_row').forEach(select => {
            this.populateRouteSelect(select);
        });
    },

    /**
     * [데이터 연동] 단일 노선 드롭다운 채우기 (S1 데이터 기준)
     */
    populateRouteSelect(selectElement) {
        const allRoutes = DataManager.getAllRoutes();
        const routeNames = Object.keys(allRoutes);
        const currentValue = selectElement.value; // 기존 값 유지
        
        selectElement.innerHTML = '<option value="">-- 노선 --</option>';
        routeNames.forEach(name => {
            selectElement.innerHTML += `<option value="${name}">${name}</option>`;
        });
        
        if (routeNames.includes(currentValue)) {
            selectElement.value = currentValue;
        } else {
            selectElement.value = "";
        }
    },
    
    /**
     * (UI) S1 데이터가 변경되었을 때 S3의 차량 표시 영역 갱신
     */
    reloadVehicleDisplays() {
        this.ui.tbody.querySelectorAll('.s3_vehicleSelect_row').forEach(vehicleSelect => {
            if (vehicleSelect.value) {
                this.handleVehicleSelectChange(vehicleSelect);
            }
        });
    },

    /**
     * [데이터 연동] 노선 선택 시 -> 차량 드롭다운 채우기
     */
    handleRouteSelectChange(routeSelect) {
        const cell = routeSelect.closest('td');
        const vehicleSelect = cell.querySelector('.s3_vehicleSelect_row');
        const vehicleDisplay = cell.querySelector('.vehicle-display');
        const routeName = routeSelect.value;
        
        if (!routeName) {
            vehicleSelect.innerHTML = '';
            vehicleSelect.style.display = 'none';
            vehicleDisplay.textContent = '';
            return;
        }

        const allRoutes = DataManager.getAllRoutes();
        const routeData = allRoutes[routeName];
        
        if (routeData && routeData.vehicleColumns) {
            const vehicleList = routeData.vehicleColumns.filter(v => v && v !== '미입력');
            // S2와 동일하게 정렬
            const isStandardVehicle = (num) => /^\d+$/.test(num.trim());
            vehicleList.sort((a, b) => {
                const aIsStd = isStandardVehicle(a);
                const bIsStd = isStandardVehicle(b);
                if (aIsStd && !bIsStd) return -1;
                else if (!aIsStd && bIsStd) return 1;
                else if (aIsStd && bIsStd) return parseInt(a, 10) - parseInt(b, 10);
                else return a.localeCompare(b);
            });

            const currentValue = vehicleSelect.value; // 기존 값 유지
            vehicleSelect.innerHTML = '<option value="">-- 차량 --</option>';
            vehicleList.forEach(car => {
                vehicleSelect.innerHTML += `<option value="${car}">${car}</option>`;
            });
            
            if (vehicleList.includes(currentValue)) {
                vehicleSelect.value = currentValue;
            }
            
            vehicleSelect.style.display = 'block';
            this.handleVehicleSelectChange(vehicleSelect); // 차량 표시 갱신
        }
    },

    /**
     * (UI) 차량 선택 시 -> 하단 텍스트 업데이트
     */
    handleVehicleSelectChange(vehicleSelect) {
        const cell = vehicleSelect.closest('td');
        const routeSelect = cell.querySelector('.s3_routeSelect_row');
        const vehicleDisplay = cell.querySelector('.vehicle-display');
        
        const routeName = routeSelect.value;
        const vehicleName = vehicleSelect.value;
        
        if (routeName && vehicleName) {
            vehicleDisplay.textContent = `${routeName} / ${vehicleName}`;
        } else if (routeName) {
            vehicleDisplay.textContent = `${routeName} / --`;
        } else {
            vehicleDisplay.textContent = '';
        }
    },

    // --- S3 유틸리티 ---

    /**
     * (Util) 텍스트 영역 자동 높이 조절
     */
    autoResizeTextarea(textarea) {
        textarea.style.height = 'auto'; // 높이 초기화
        textarea.style.height = (textarea.scrollHeight) + 'px';
    },

    /**
     * (Util) 가격 입력 포맷 (1,000)
     */
    formatPriceInput(input) {
        let value = input.value.replace(/[^0-9]/g, ''); // 숫자만
        if (value) {
            value = parseInt(value, 10).toLocaleString('ko-KR');
        }
        input.value = value;
    },
    
    /**
     * (Util) 포맷된 가격을 숫자로 변환
     */
    parsePrice(formattedPrice) {
        return parseInt(formattedPrice.replace(/[^0-9]/g, ''), 10) || 0;
    },

    // --- S3 인쇄 ---

    /**
     * (UI) S3 인쇄
     */
    printPage() {
        // 인쇄 설정 적용
        document.documentElement.style.setProperty('--s3-print-margin-top', '10mm');
        document.documentElement.style.setProperty('--s3-print-margin-bottom', '10mm');
        document.documentElement.style.setProperty('--s3-print-margin-left', `${this.ui.marginLeftSelect.value}mm`);
        document.documentElement.style.setProperty('--s3-print-margin-right', `${this.ui.marginRightSelect.value}mm`);
        this.applyFontSize(this.ui.fontSizeInput.value); // 인쇄 폰트 크기 적용

        const originalTitle = document.title;
        const dateText = this.ui.dateDisplay.textContent.split(' (')[0];
        document.title = `차량정비일지_${dateText}`;

        document.body.classList.remove('printing-section1', 'printing-section2');
        document.body.classList.add('printing-section3');

        const handleAfterPrint = () => {
            document.title = originalTitle;
            document.documentElement.style.removeProperty('--s3-print-margin-left');
            document.documentElement.style.removeProperty('--s3-print-margin-right');
            document.body.classList.remove('printing-section3');
            window.removeEventListener('afterprint', handleAfterPrint);
        };
        window.addEventListener('afterprint', handleAfterPrint);

        // [수정됨] 4. 인쇄 딜레이 제거
        window.print();
    },
    
    /**
     * (UI) S3 폰트 크기 적용
     */
    applyFontSize(size) {
        document.documentElement.style.setProperty('--s3-font-size-base', `${size}px`);
        document.documentElement.style.setProperty('--s3-print-font-size', `${size}pt`);
    },
    
    // --- S3 백업 / 복원 ---

    /**
     * S3 정비일지 데이터 백업 (S3_LOG_KEY 전체)
     */
    backupLogData() {
        this.saveFormData(this.state.s3_currentDate); // 현재 날짜 저장
        const s3_data = DataManager.data.s3;
        if (Object.keys(s3_data).length === 0) {
            alert('백업할 정비일지(S3) 데이터가 없습니다.');
            return;
        }

        const jsonString = JSON.stringify(s3_data);
        const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
        
        const now = new Date();
        const dateString = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
        
        const { routeData } = DataManager.getCurrentRouteData();
        let companyName = "전체";
        if (routeData && routeData.companyName) {
            companyName = routeData.companyName.replace(/\s/g, '');
        }

        const filename = `${companyName}_정비일지(S3)_${dateString}.json`;
        
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        alert(`정비일지(S3) 전체 데이터 파일 (${filename})이 다운로드 폴더에 JSON 파일로 저장됩니다.`);
    },
    
    triggerRestore() {
        this.ui.restoreFile.click();
    },

    /**
     * S3 정비일지 데이터 복원 (S3_LOG_KEY 전체 덮어쓰기)
     */
    restoreLogData(file) {
        if (!file) return;

        if (!confirm(`[${file.name}] 파일을 업로드하여 *모든* 날짜의 정비일지(S3) 데이터를 덮어쓰시겠습니까?`)) {
            this.ui.restoreFile.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const loadedData = JSON.parse(event.target.result);
                
                if (typeof loadedData !== 'object' || loadedData === null || Array.isArray(loadedData)) {
                     alert('파일 형식이 올바르지 않습니다. S3 백업 파일이 아닙니다.');
                     throw new Error('Invalid S3 saved file structure');
                }
                
                // DataManager에 데이터 수정을 요청 (S3 전체 덮어쓰기)
                DataManager.updateS3Data(s3_data => {
                    Object.keys(s3_data).forEach(key => delete s3_data[key]);
                    Object.assign(s3_data, loadedData);
                });

                alert(`[${file.name}] 파일로부터 S3 정비일지 전체 데이터 복원을 완료했습니다.`);
                
                // 현재 날짜 기준으로 화면 새로고침
                this.clearForm(false);
                this.loadFormData(this.state.s3_currentDate);

            } catch (e) {
                alert('파일을 읽는 도중 오류가 발생했습니다. 파일이 손상되었거나 JSON 형식이 아닙니다.');
                console.error('S3 Restore Error:', e);
            } finally {
                this.ui.restoreFile.value = '';
            }
        };
        reader.onerror = () => {
            alert('파일을 읽을 수 없습니다.');
            this.ui.restoreFile.value = '';
        };
        reader.readAsText(file);
    },
    
    // --- S3 부품 가격 계산기 ---
    
    /**
     * (UI) 계산기 표시
     */
    showCalculator() {
        this.saveFormData(this.state.s3_currentDate); // 현재 작업 저장
        
        // 기본 기간: 현재 월의 1일 ~ 말일
        const today = new Date();
        const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
        const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        this.ui.startDateInput.value = startDate.toISOString().slice(0, 10);
        this.ui.endDateInput.value = endDate.toISOString().slice(0, 10);
        this.ui.totalPriceDisplay.textContent = '0원';
        
        this.ui.calculatorModal.style.display = 'block';
    },
    
    /**
     * (UI) 계산기 숨기기
     */
    hideCalculator() {
        this.ui.calculatorModal.style.display = 'none';
    },
    
    /**
     * (Util) 기간별 부품 가격 합산
     */
    calculatePrices() {
        const startDate = this.ui.startDateInput.value;
        const endDate = this.ui.endDateInput.value;
        
        if (!startDate || !endDate || startDate > endDate) {
            alert('올바른 기간을 설정하세요.');
            return;
        }
        
        const s3_data = DataManager.data.s3;
        let total = 0;
        
        for (const dateString in s3_data) {
            if (dateString >= startDate && dateString <= endDate) {
                const dayData = s3_data[dateString];
                for (const key in dayData) {
                    if (key.startsWith('price_')) {
                        total += this.parsePrice(dayData[key]);
                    }
                }
            }
        }
        
        this.ui.totalPriceDisplay.textContent = `${total.toLocaleString('ko-KR')}원`;
    }
};

/* ================================================================= */
/* [공통] 초기화 (DOM 로드 완료 시) */
/* ================================================================= */
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM 로드 완료. 모듈 초기화 시작.");
    
    // 버전 설정
    S1_Module.setVersion();

    // S1, S2, S3 모듈 초기화
    S1_Module.initialize();
    S2_Module.initialize();
    S3_Module.initialize();
});
</script>
</body>
</html>
