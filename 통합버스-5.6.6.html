<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>통합 근무 관리 시스템 (현황표 + 승무일지 + 정비일지)</title>
    
    <style>
        /* ================================================================= */
        /* [공통] Global Styles */
        /* ================================================================= */
      
        :root {
            --s3-font-size-base: 16px;
            --s3-print-font-size: 11pt;
            --s3-print-margin-top: 10mm;
            --s3-print-margin-bottom: 10mm;
            --s3-print-margin-left: 10mm;
            --s3-print-margin-right: 10mm;
            --worker-font-size: 14px;
            --print-margin-left: 10mm;
            --print-margin-right: 10mm;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            background-color: #e9ecef;
            color: #333;
            font-size: 16px;
        }

        #header-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        #header-logo {
            height: 24px;
            width: auto;
            margin-right: 8px;
        }
        #version-display {
            font-size: 13px;
            font-weight: bold;
            color: #555;
        }

        .divider {
            margin: 40px 0;
            border: 2px solid #0056b3;
        }

        /* ================================================================= */
        /* [Section 1] 근무 현황표 Styles */
        /* ================================================================= */
        
        #section1 .controls {
            background-color: #fff;
            padding: 15px; border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            align-items: stretch; 
        }

        #section1 .controls fieldset {
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 10px 15px;
            margin: 0;
            background: linear-gradient(145deg, #ffffff, #f0f0f5);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 300px; 
            display: flex;
            flex-direction: column;
            gap: 10px; 
            transition: transform 0.2s;
        }
        
        #section1 .controls fieldset:hover {
             box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        #section1 .controls fieldset legend {
            font-weight: bold;
            font-size: 1.2em;
            color: #0056b3;
            padding: 2px 10px;
            border-radius: 4px;
            background-color: #eaf4ff;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        #section1 .controls .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
        }
        #section1 .controls label { font-weight: bold; margin-right: 5px; white-space: nowrap; }
        
        #section1 .controls input[type="text"],
        #section1 .controls input[type="number"], 
        #section1 .controls select {
            padding: 6px;
            border: 1px solid #a8c8e1; 
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        #section1 .controls input[type="number"] { width: 70px; }
        #section1 .controls input#companyInput { flex: 1 1 auto; min-width: 150px; }
        #section1 .controls select#typeSelect { flex: 1 1 auto; min-width: 150px; }
        #section1 .controls select { flex-grow: 1; min-width: 120px; }

        #section1 #vehicleInputsContainer {
            display: flex;
            flex-wrap: wrap; 
            gap: 5px;
            width: 100%;
            margin-top: 5px;
            padding: 5px;
            background: #e9f0f6; 
            border-radius: 4px;
            border: 1px solid #cfe2f3;
            max-height: 180px;
            overflow-y: auto;
        }
        #section1 #vehicleInputsContainer input {
            width: 80px;
            font-size: 0.9em;
            padding: 4px;
        }

        #section1 .controls select.margin-select {
            width: 35px;
            min-width: 35px;
            padding: 1px 3px;
            font-size: 0.85em; 
            flex-grow: 0;
        }
        
        #section1 .controls button,
        #section1 .controls select.action-select,
        #section1 .controls select.work-type-select,
        #section1 .controls select.vehicle-select {
            padding: 8px 15px;
            color: white; border: none; border-radius: 4px;
            cursor: pointer; font-size: 17.5px;
            text-decoration: none; display: inline-block;
            text-align: center; white-space: nowrap;
            width: auto;
            flex-grow: 0; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        
        #section1 .controls button { background-color: #007bff; }
        #section1 .controls button:hover { background-color: #0056b3; }
        #section1 .controls button.btn-danger { background-color: #dc3545; }
        #section1 .controls button.btn-danger:hover { background-color: #c82333; }
        
        #section1 .controls select.action-select { background-color: #28a745; }
        #section1 .controls select.work-type-select { background-color: #ffc107; color: #333; }
        #section1 .controls select.vehicle-select { background-color: #6c757d; }
        
        #section1 .controls select.route-navigate-select {
            padding: 8px 15px;
            font-size: 17.5px;
            background-color: #17a2b8; 
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            flex-grow: 1;
        }

        #section1 .holiday-option-group {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 5px;
            align-items: center;
            border: 1px solid #b3e5fc;
        }
        #section1 .holiday-option-group select {
            padding: 4px;
            font-size: 0.9em;
            flex-grow: 0; 
            width: 100px;
        }

        #section1 #scheduleContainer {
            background-color: white;
            padding: 10px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 90%;
            overflow-x: auto;
            border-radius: 8px;
            box-sizing: border-box; 
        }
        
        #section1 table {
            width: 100%;
            min-width: 100%; 
            border-collapse: collapse;
            margin: 0 auto; font-size: 0.9em; background-color: #fff; table-layout: fixed;
        }
        #section1 th, #section1 td {
            border: 1px solid #ddd;
            padding: 5px; 
            text-align: center;
            vertical-align: middle; 
            line-height: 1.2; 
            word-break: keep-all;
            height: 38px; box-sizing: border-box;
            font-size: 16px;
        }
        #section1 th { background-color: #f2f2f2; font-weight: bold; }
        #section1 caption {
            font-size: 1.5em;
            margin-bottom: 10px; font-weight: bold;
            color: #333; text-decoration: underline;
        }
        
        #section1 .sunday { background-color: initial !important; }
        #section1 .saturday { background-color: initial !important; }
        #section1 .holiday { 
            background-color: initial !important;
            font-weight: bold; 
            color: #cc0000;
        }
        #section1 .holiday td:not(:nth-child(1)):not(:nth-child(2)) {
            color: #333;
            font-weight: normal;
        }
        
        #section1 .sub-day-info {
            display: block;
            font-size: 0.5em; 
            line-height: 1.2;
            font-weight: bold;
            color: inherit; 
        }
        
        #section1 .day-cell-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1em;
        }
        
        #section1 .day-name-main {
            font-weight: bold;
            font-size: 1.2em; 
            line-height: 1.2;
        }
        
        #section1 .edit-mode {
            position: relative;
            padding: 2px; display: flex; flex-direction: column;
            justify-content: center; height: 100%;
            vertical-align: middle;
        }
        #section1 .edit-mode input {
            width: calc(100% - 8px);
            margin-bottom: 2px;
            padding: 2px; box-sizing: border-box;
        }
        #section1 .edit-mode .cell-buttons { display: flex; justify-content: space-around; margin-top: 2px; }
            
        #section1 .edit-mode .cell-buttons button {
            padding: 3px 5px;
            font-size: 0.7em; 
            color: white; 
            border: none;
            border-radius: 3px; 
            cursor: pointer; 
            white-space: nowrap;
            transition: background-color: 0.15s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            flex-grow: 1; 
            margin: 0 1px;
        }
        
        #section1 .edit-mode .cell-buttons button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }
        #section1 .edit-mode .cell-buttons .btn-fixed { background-color: #007bff; }
        #section1 .edit-mode .cell-buttons .btn-fixed:hover:not(:disabled) { background-color: #0056b3; }
        #section1 .edit-mode .cell-buttons .btn-temp { background-color: #28a745; }
        #section1 .edit-mode .cell-buttons .btn-temp:hover { background-color: #1e7e34; }
        #section1 .edit-mode .cell-buttons .btn-highlight-am { background-color: #6f42c1; }
        #section1 .edit-mode .cell-buttons .btn-highlight-am:hover { background-color: #5a349c; }
        #section1 .edit-mode .cell-buttons .btn-highlight-pm { background-color: #fd7e14; }
        #section1 .edit-mode .cell-buttons .btn-highlight-pm:hover { background-color: #db6a0b; }
        #section1 .edit-mode .cell-buttons .btn-delete { background-color: #dc3545; }
        #section1 .edit-mode .cell-buttons .btn-delete:hover { background-color: #c82333; }

        #section1 .name-entry { 
            display: block;
            margin-top: 2px; 
            margin-bottom: 2px; 
            color: inherit; 
            font-size: var(--worker-font-size); 
        }
        #section1 .hidden-x { color: white; }
        #section1 .name-entry.bold-name { font-weight: bold; }
        #section1 table th:nth-child(1),
        #section1 table td:nth-child(1),
        #section1 table th:nth-child(2),
        #section1 table td:nth-child(2) {
            width: 4%;
            min-width: 60px;
            vertical-align: middle; 
        }

        /* [Section 1] 컨트롤 박스 UI 개선 */
        #section1 .controls input[type="number"] { padding: 8px; font-size: 1em; }
        #section1 .controls input#yearInput { width: 90px; }
        #section1 .controls fieldset:nth-of-type(1) .control-group:nth-of-type(3) button { flex: 1 1 auto; }
        #section1 .controls fieldset:nth-of-type(3) .control-group { flex-direction: column; align-items: stretch; }
        #section1 .controls fieldset:nth-of-type(3) .control-group > * { margin-bottom: 5px; }
        #section1 .controls fieldset:nth-of-type(3) .control-group > *:last-child { margin-bottom: 0; }
        #section1 .controls fieldset:nth-of-type(3) .control-group:nth-of-type(2) { flex-direction: row; align-items: center; gap: 10px; }
        #section1 .controls fieldset:nth-of-type(3) .control-group:nth-of-type(2) > select { flex: 1 1 auto; margin-bottom: 0; }
        #section1 .controls fieldset:nth-of-type(4) .control-group:not(:first-of-type) { flex-direction: column; align-items: stretch; }
        #section1 .controls fieldset:nth-of-type(4) .control-group:not(:first-of-type) > * { margin-bottom: 5px; }
        #section1 .controls .control-group[style*="border-top"] { flex-direction: row; align-items: center; flex-wrap: wrap; }
        #section1 .controls .control-group[style*="border-top"] > div[style*="flex-direction: row"] {
            flex-direction: row !important;
            align-items: center !important; 
            gap: 10px !important; 
            margin-left: 10px !important; 
            flex-wrap: wrap;
        }
        #section1 .controls select.margin-select { width: 60px; min-width: 60px; padding: 4px; font-size: 0.95em; }

        @media screen and (max-width: 1400px) {
            #section1 .controls { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        }

        @media screen and (max-width: 768px) {
            #section1 #scheduleContainer { max-width: 100%; margin: 10px 0; }
            #section1 .controls { grid-template-columns: 1fr; }
            #section1 .controls .control-group { flex-direction: column; align-items: stretch; }
            #section1 .controls input[type="text"], 
            #section1 .controls input[type="number"], 
            #section1 .controls select,
            #section1 .controls input#companyInput, 
            #section1 .controls select#typeSelect { width: 100%; flex-basis: auto; }
            #section1 table { min-width: 100%; font-size: 0.8em; }
            #section1 th, #section1 td { padding: 3px; height: 30px; font-size: 13px !important; word-break: break-all; }
            #section1 .day-name-main { font-size: 1.0em; }
            #section1 .name-entry { font-size: 12px !important; }
        }

        /* ================================================================= */
        /* [Section 2] 승무 일지 Styles */
        /* ================================================================= */

        #section2 {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px; 
            color: #333;
            font-size: 12px;
        }

        #section2 .journal-container {
            background-color: white;
            padding: 15px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            max-width: 90%;
            margin: 10px auto;
            overflow-x: auto;
            box-sizing: border-box;
        }

        #section2 .header-title {
            text-align: center;
            font-size: 1.88em; 
            font-weight: bold;
            color: #0056b3;
            padding-bottom: 4px;
            margin-bottom: 4px;
            border-bottom: 2px solid #0056b3;
        }
        #section2 .title-area {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            margin: 8px 0 10px 0;
            padding: 0 5px; 
            flex-wrap: wrap;
            gap: 10px;
        }

        #section2 .title-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        #section2 .main-title {
            font-size: 1.44em;
            font-weight: bold;
            color: #333;
            display: inline-block;
        }
        
        #section2 .date-navigation-area {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
            border: 1px solid #ced4da;
            background-color: #f8f9fa;
            padding: 5px;
            border-radius: 5px;
            margin-top: 5px;
            width: 100%;
            justify-content: center;
        }
        #section2 .date-navigation-area label { font-size: 1em; font-weight: bold; margin: 0 5px; }
        #section2 .date-navigation-area input[type="date"] { font-size: 1em; padding: 3px; border: 1px solid #ced4da; border-radius: 3px; max-width: 130px; }
        #section2 .date-nav-btn {
            padding: 4px 10px; font-size: 0.94em; font-weight: bold; color: white;
            background-color: #007bff; border: none; border-radius: 3px; cursor: pointer;
        }
        #section2 .date-nav-btn:hover { background-color: #0056b3; }
        #section2 .date-nav-btn.today { background-color: #28a745; }
        #section2 .date-nav-btn.today:hover { background-color: #1e7e34; }
        #section2 .date-nav-btn.secondary { background-color: #6c757d; }
        #section2 .date-nav-btn.secondary:hover { background-color: #5a6268; }

        #section2 .options-right {
            display: flex; align-items: center; flex-wrap: wrap; gap: 10px; justify-content: flex-end; flex-grow: 1;
        }
        
        #section2 .font-selector-container {
            font-size: 0.94em; display: flex; align-items: center; white-space: nowrap;
        }
        #section2 .font-selector-container label { margin-right: 3px; font-weight: normal; }
        #section2 #font-size-select { padding: 1px 3px; font-size: 1em; height: 20px; }
        
        #section2 .dispatch-buttons-container {
            display: flex; align-items: center; font-size: 0.94em; border: 1px solid #ced4da; border-radius: 3px; padding: 2px; white-space: nowrap;
        }
        
        #section2 .dispatch-cycle-container {
             font-size: 0.94em; white-space: nowrap; display: flex; align-items: center; border: 1px solid #ced4da; border-radius: 3px; padding: 2px;
        }
        #section2 .dispatch-cycle-container label { margin: 0 8px; font-weight: normal; color: #333; }
        #section2 .dispatch-cycle-select {
            padding: 3px; font-size: 1em; border: 1px solid #ced4da; border-radius: 3px; height: 25px; vertical-align: middle;
        }
        
        #section2 .dispatch-buttons-container label { margin: 0 8px; font-weight: normal; color: #333; }
        #section2 .dispatch-button {
            padding: 3px 6px; margin-left: -1px; font-size: 1em; background-color: #f8f9fa; color: #333;
            border: 1px solid #ced4da; border-radius: 0; cursor: pointer; transition: background-color: 0.1s;
        }
        #section2 .dispatch-button:first-of-type { border-top-left-radius: 2px; border-bottom-left-radius: 2px; margin-left: 0; }
        #section2 .dispatch-button:last-of-type { border-top-right-radius: 2px; border-bottom-right-radius: 2px; }
        #section2 .dispatch-button:hover { background-color: #e2e6ea; }
        #section2 .dispatch-button.active { background-color: #007bff; color: white; border-color: #007bff; z-index: 1; }

        #section2 .print-button {
            padding: 4px 10px; font-size: 0.94em; font-weight: bold; color: white; background-color: #007bff;
            border: none; border-radius: 3px; cursor: pointer; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); white-space: nowrap;
        }
        #section2 .print-button:hover { background-color: #0056b3; }
        
        #section2 .date-header {
            font-size: 1.5em; font-weight: bold; color: #0056b3; text-align: center; padding: 10px 5px;
            background-color: #eaf4ff; border-top: 2px solid #0056b3; border-bottom: 1px solid #b3d7ff; margin: 15px 0 10px 0; display: block;
        }
        
        #section2 .route-section {
            margin-bottom: 15px; border: 1px solid #ced4da; border-radius: 4px; overflow: hidden;
        }
        
        #section2 .route-header-flex {
            display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 5px;
            background-color: #e6f7ff; padding: 5px 8px; border-bottom: 1px solid #ced4da;
        }
        
        #section2 .route-title-group { display: flex; align-items: center; flex-shrink: 0; }
        #section2 .route-name-text { font-size: 1.22em; font-weight: bold; color: #0056b3; white-space: nowrap; padding-right: 15px; }
        
        #section2 .load-button-container { display: flex; align-items: center; }
        #section2 .load-button {
            background-color: #38b43d; color: white; border: none; padding: 3px 8px; margin-left: 10px;
            border-radius: 3px; cursor: pointer; font-size: 0.88em; white-space: nowrap;
        }
        #section2 .load-button:hover { background-color: #2e8b34; }

        #section2 .schedule-options { display: flex; gap: 15px; font-size: 0.9em; flex-wrap: wrap; }
        #section2 .schedule-options select { font-size: 1em; height: 20px; padding: 0 2px; margin: 2px 0; box-sizing: border-box; vertical-align: middle; }
        #section2 .schedule-options input[type="number"] { width: 30px; height: 18px; text-align: center; font-size: 0.9em; padding: 0; margin: 0 1px; border: 1px solid #ccc; }

        #section2 .am-options, #section2 .pm-options {
            border: 1px solid #ddd; padding: 3px 5px; background-color: #f7f9fb; border-radius: 3px; white-space: nowrap;
        }
        #section2 .am-options span, #section2 .pm-options span { font-weight: bold; }
        
        #section2 .settings-controls {
            display: flex; flex-direction: column; gap: 2px; padding-top: 5px; flex-shrink: 0;
        }

        #section2 .setting-button {
            padding: 3px 5px; font-size: 0.88em; cursor: pointer; border: 1px solid #ccc; border-radius: 3px; white-space: nowrap; transition: background-color: 0.1s;
        }
        #section2 .apply-button { background-color: #d4edda; border-color: #c3e6cb; }
        #section2 .apply-button:hover { background-color: #c3e6cb; }
        #section2 .reset-button { background-color: #f8d7da; border-color: #f5c6cb; }
        #section2 .reset-button:hover { background-color: #f5c6cb; }
        
        #section2 table { 
            width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 0.88em; background-color: #fff;
        }

        #section2 th, #section2 td { 
            border: 1px solid #ddd; padding: 2px 1px; text-align: center; vertical-align: middle;
            height: 20px; box-sizing: border-box; line-height: 1.1; position: relative;
        }

        #section2 th { background-color: #e9ecef; font-weight: bold; color: #333; }
        
        #section2 .car-number-cell { font-weight: bold; font-size: 1.136em; cursor: pointer; padding: 0; }

        #section2 .car-display {
            padding: 2px 1px; height: 100%; width: 100%; box-sizing: border-box;
            display: flex; justify-content: center; align-items: center;
        }

        #section2 .car-controls {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-color: #fff; padding: 1px; box-sizing: border-box; gap: 1px; z-index: 10; border: 2px solid #ffc107;
        }

        #section2 .car-controls select { width: 95%; font-size: 0.8em; padding: 0; margin: 0; height: 14px; }
        #section2 .car-controls button {
            width: 48%; font-size: 0.7em; padding: 0; margin: 0; height: 14px; line-height: 1;
            box-sizing: border-box; border: 1px solid #ccc; cursor: pointer; background-color: #f0f0f0;
        }
        #section2 .car-controls div { display: flex; justify-content: space-between; width: 95%; margin-top: 1px; }
        
        #section2 .journal-table th:nth-child(1),
        #section2 .journal-table th:nth-child(10) { font-size: 1.136em; }
        
        #section2 input[type="number"], #section2 input[type="text"] {
            font-size: 1em; padding: 0; margin: 0; width: 100%; height: 18px; 
            box-sizing: border-box; border: 1px solid #ccc; text-align: center; -moz-appearance: textfield;
        }
        
        #section2 .journal-table colgroup col { width: 5.4%; } 

        #section2 .driver-name {
            box-sizing: border-box; width: 100%; padding: 0; margin: 0; border: none; background: transparent;
            text-align: center; line-height: 1.1em; min-height: 18px; cursor: pointer; display: block;
        }
        
        #section2 .driver-input {
            resize: none; height: 18px; overflow: hidden; border: 1px solid #007bff; background-color: #fff !important;
            font-size: 1em; box-sizing: border-box; width: 100%; padding: 0; margin: 0; text-align: center;
        }

        #section2 .edit-controls {
            display: flex; justify-content: center; gap: 2px; padding: 1px 0; margin-top: -1px; 
        }
        #section2 .edit-controls button {
            flex-grow: 1; padding: 0; margin: 0; font-size: 0.8em; height: 18px; line-height: 1;
            cursor: pointer; border-radius: 2px; border: 1px solid #ccc;
        }
        #section2 .edit-controls button:first-child { background-color: #f44336; color: white; border-color: #d32f2f; }
        #section2 .edit-controls button:last-child { background-color: #4CAF50; color: white; border-color: #388e3c; }

        #section2 .hidden { display: none !important; }
        
        @media screen and (max-width: 768px) {
            #section2 .journal-container { max-width: 100%; margin: 10px 0; padding: 5px; }
            #section2 { font-size: 11px !important; }
            #section2 .options-right { gap: 5px; flex-wrap: wrap; justify-content: flex-end; }
            #section2 .print-button { padding: 3px 6px; font-size: 1em; }
            #section2 .dispatch-buttons-container label { margin: 0 4px; }
            #section2 th, #section2 td { height: 30px; padding: 2px 0; }
            #section2 input[type="number"], #section2 input[type="text"],
            #section2 .s2-work-hours-select, #section2 .driver-input, #section2 .driver-name { height: 16px; font-size: 0.95em; }
            
            #section2 .date-navigation-area { flex-direction: column; align-items: stretch; }
            #section2 .date-navigation-area div { display: flex; gap: 5px; width: 100%; }
            #section2 .date-navigation-area input[type="date"] { flex-grow: 1; max-width: none; }
            #section2 .date-navigation-area .date-nav-btn { flex-grow: 1; }
        }

        #section2 .s2-work-hours-select {
            font-size: 1em; padding: 0; margin: 0; width: 100%; height: 18px; 
            box-sizing: border-box; border: 1px solid #ccc; text-align: center;
            background-color: white; -moz-appearance: none; -webkit-appearance: none; appearance: none;
        }
        
        /* ================================================================= */
        /* [Section 3] 정비일지 Styles */
        /* ================================================================= */
        
        #section3 {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0; padding: 10px; color: #333; font-size: var(--s3-font-size-base); 
        }
        #section3 .maintenance-container {
            max-width: 900px; margin: 18px auto; background: #fff; padding: 10px;
            border: 1px solid #000; box-shadow: 0 6px 18px rgba(0,0,0,0.06); box-sizing: border-box;
        }
        
        #section3 header { display: flex; flex-wrap: wrap; align-items: center; }
        #section3 header h1 {
            flex-basis: 100%; text-align: center; order: -1; margin-bottom: 10px; font-size: 20px; margin-top: 6px;
        }
        #section3 .controls {
            flex-basis: 100%; display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; align-items: center;
        }
        
        #section3 button {
            padding: 8px 12px; border-radius: 4px; border: 1px solid #444; background: #fff; cursor: pointer; font-size: 16px;
        }
        #section3 button.primary { background: #007bff; color: #fff; border-color: #007bff; }
        #section3 button.success { background: #28a745; color: #fff; }
        #section3 button.warning { background: #ffc107; color: #333; }

        #section3 .margin-control-group {
            display: flex; flex-direction: row; align-items: center; gap: 6px; padding: 4px;
            border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa;
        }
        #section3 .margin-control-group > label { font-size: 14px; font-weight: bold; margin-right: 5px; }
        #section3 .margin-control { display: flex; flex-direction: column; align-items: center; }
        #section3 .margin-control label { font-size: 12px; font-weight: bold; color: #333; }
        #section3 .margin-select { width: 45px; font-size: 13px; padding: 1px; border: 1px solid #aaa; border-radius: 3px; }
        
        #section3 .form-table {
            width: 100%; border-collapse: collapse; margin-top: 8px; border: 1px solid #000; table-layout: fixed;
        }
        #section3 .form-table td, #section3 .form-table th {
            border: 1px solid #000; padding: 6px; vertical-align: middle;
            font-size: calc(var(--s3-font-size-base) * 0.9); height: 28px; box-sizing: border-box; word-break: break-all;
        }
        #section3 .form-table thead th { text-align: center; border-top-width: 1px; }
        
        #section3 .route-col { width: 15%; } 
        #section3 .item-col { width: 20%; } 
        #section3 .detail-col { width: 20%; } 
        #section3 .parts-col { width: 15%; } 
        #section3 .price-col { width: 15%; } 
        #section3 .worker-col { width: 15%; } 
        #section3 .date-col { width: auto; }
        
        #section3 #s3_date_nav_container {
            display: flex; justify-content: center; align-items: center; gap: 10px; position: relative;
        }
        #section3 .s3_date_nav_btn {
            font-size: 1em; font-weight: bold; cursor: pointer; color: #0056b3; user-select: none; padding: 5px;
        }
        #section3 .s3_date_nav_btn:hover { color: #007bff; }
        #section3 #s3_dateDisplay_text {
            font-weight: bold; font-size: 1.1em; cursor: pointer; padding: 5px; border-radius: 4px;
        }
         #section3 #s3_dateDisplay_text:hover { background-color: #eaf4ff; }
        
        #section3 #s3_datePicker {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            width: 100px; height: 100%; opacity: 0; cursor: pointer;
        }

        #section3 .route-select-cell { vertical-align: top !important; padding: 4px !important; }
        #section3 .header-select {
            font-size: 11px; padding: 2px; width: 100%; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 3px;
        }
        #section3 .vehicle-display { font-weight: bold; font-size: 12px; color: #0056b3; margin-top: 4px; height: 1.2em; }
        
        #section3 input[type=text], #section3 input[type=number], #section3 textarea, #section3 select {
            width: 100%; box-sizing: border-box; border: none; outline: none; font-size: 14px;
            color: #000; background: transparent; resize: none;
        }
        #section3 textarea.auto-resize { overflow-y: hidden; min-height: 28px; line-height: 1.4; }
        
        #section3 .price-input { text-align: right; width: 100%; padding-right: 20px; box-sizing: border-box; }
        #section3 .price-wrapper { position: relative; width: 100%; }
        #section3 .price-wrapper::after {
            content: "원"; position: absolute; top: 50%; right: 5px; transform: translateY(-50%); color: #555; pointer-events: none;
        }
        #section3 .s3_added-row { background-color: #f0f8ff; }
        
        @media screen and (max-width: 768px) {
            #section3 .maintenance-container {
                max-width: 100%; padding: 5px; margin: 10px 0; overflow-x: auto; box-sizing: border-box;
            }
            #section3 header .controls { flex-direction: column; align-items: stretch; gap: 5px; }
            #section3 header .controls > * { width: 100%; box-sizing: border-box; }
            #section3 .form-table { font-size: 12px; min-width: 800px; }
            #section3 .form-table td, #section3 .form-table th { padding: 4px; }
            #section3 input[type=text], #section3 input[type=number], #section3 textarea, #section3 select { font-size: 12px; }
        }

        /* ================================================================= */
        /* [공통] 인쇄 스타일 */
        /* ================================================================= */
        @media print {
            #header-bar, #s2_restoreDateModal, #s3_restoreDateModal, #s3_calculatorModal, #s2_timeSettingModal { display: none !important; }

            body.printing-section1 #section2, body.printing-section1 #section3, body.printing-section1 .divider { display: none !important; }
            body.printing-section2 #section1, body.printing-section2 #section3, body.printing-section2 .divider { display: none !important; }
            body.printing-section3 #section1, body.printing-section3 #section2, body.printing-section3 .divider { display: none !important; }
            
            body.printing-section1 .controls { display: none !important; }
            
            body.printing-section1 @page { size: A4; margin: 10mm; margin-left: var(--print-margin-left, 15mm); margin-right: var(--print-margin-right, 5mm); }
            body.printing-section1 { background-color: white; margin: 0; padding: 0; -webkit-print-color-adjust: exact; }
            body.printing-section1 #scheduleContainer { box-shadow: none; margin: 0; padding: 0; }
            body.printing-section1 #section1 caption { font-size: 1.0em; margin-bottom: 5px; }
            body.printing-section1 #section1 table { width: 100%; min-width: unset; font-size: 0.8em; border: 1px solid #000; table-layout: fixed; page-break-inside: auto; }
            body.printing-section1 #section1 tr { page-break-inside: avoid; page-break-after: auto; }
            body.printing-section1 #section1 th, body.printing-section1 #section1 td { padding: 1px; height: auto; word-break: break-all; vertical-align: top; border: 1px solid #000; }
            body.printing-section1 #section1 table th:nth-child(1), body.printing-section1 #section1 table td:nth-child(1),
            body.printing-section1 #section1 table th:nth-child(2), body.printing-section1 #section1 table td:nth-child(2) { width: 4%; vertical-align: middle; }
            body.printing-section1 #section1 .sub-day-info { font-size: 0.5em; } 
            body.printing-section1 #section1 .day-name-main { font-size: 1em; }
            body.printing-section1 #section1 .sunday { background-color: initial !important; }
            body.printing-section1 #section1 .saturday { background-color: initial !important; }
            body.printing-section1 #section1 .holiday { background-color: initial !important; font-weight: bold; color: #cc0000; }
            body.printing-section1 #section1 .holiday td:not(:nth-child(1)):not(:nth-child(2)) { color: #000; font-weight: normal; }

            body.printing-section2 @page { size: A4 landscape; margin: 6mm; }
            body.printing-section2 { background-color: white; padding: 0; margin: 0; font-size: 9pt; color: #000; }
            body.printing-section2 #section2 .journal-container { box-shadow: none; border-radius: 0; padding: 0; margin: 0; max-width: 100%; }
            body.printing-section2 #section2 .date-navigation-area,
            body.printing-section2 #section2 .dispatch-cycle-container,
            body.printing-section2 #section2 .print-button, 
            body.printing-section2 #section2 .font-selector-container, 
            body.printing-section2 #section2 .dispatch-buttons-container,
            body.printing-section2 #section2 .driver-input, 
            body.printing-section2 #section2 .edit-controls, 
            body.printing-section2 #section2 .schedule-options, 
            body.printing-section2 #section2 .load-button-container,
            body.printing-section2 #section2 .car-controls,
            body.printing-section2 #section2 .settings-controls 
            { display: none !important; }
            
            body.printing-section2 #section2 table { font-size: 7pt; border-collapse: collapse !important; border: 1px solid #000 !important; }
            body.printing-section2 #section2 th, body.printing-section2 #section2 td { height: 16px; padding: 1px 0px; border: 1px solid #000 !important; }
            body.printing-section2 #section2 .header-title, body.printing-section2 #section2 .main-title, body.printing-section2 #section2 .route-name-text { color: #000 !important; }
            body.printing-section2 #section2 .route-header-flex { background-color: #eee !important; border-bottom: 1px solid #000 !important; }
            body.printing-section2 #section2 .date-header { font-size: 1.2em; padding: 5px; margin: 10px 0 5px 0; background-color: #f0f0f0 !important; border-top: 1px solid #000 !important; border-bottom: 1px solid #000 !important; color: #000 !important; -webkit-print-color-adjust: exact; }

            body.printing-section2 #section2 input[type="number"], body.printing-section2 #section2 input[type="text"],
            body.printing-section2 #section2 .s2-work-hours-select { border: none; background: transparent; padding: 0; height: auto; -webkit-appearance: none; -moz-appearance: none; appearance: none; }

            body.printing-section2 #section2 .driver-name, body.printing-section2 #section2 .car-display { display: flex !important; justify-content: center; align-items: center; border: none !important; cursor: default; height: 100%; width: 100%; }
            body.printing-section2 #section2 .car-number-cell { padding: 2px 1px; }

            body.printing-section3 #section3 .maintenance-container { max-width: 100%; border: none; box-shadow: none; margin: 0; padding: 0; }
            body.printing-section3 #section3 .form-table { font-size: var(--s3-print-font-size); border: 2px solid #000 !important; }
            body.printing-section3 #section3 .form-table td, body.printing-section3 #section3 .form-table th { border: 1px solid #000 !important; padding: 4px !important; height: auto !important; vertical-align: top; }
            body.printing-section3 #section3 input, body.printing-section3 #section3 textarea { border: none !important; background: transparent !important; font-size: calc(var(--s3-print-font-size) * 0.9) !important; height: auto !important; overflow: visible !important; color: #000 !important; }
            body.printing-section3 #section3 .price-wrapper::after { display: none; }
            body.printing-section3 #section3 .price-input { padding-right: 0; }
            body.printing-section3 #section3 .no-print, body.printing-section3 #section3 .header-select { display: none !important; }
            body.printing-section3 #section3 #s3_date_nav_container { display: none !important; }
            body.printing-section3 #section3 #s3_dateDisplay { display: block; font-weight: bold; font-size: 1.1em; }
            body.printing-section3 #section3 .vehicle-display { font-size: 11px !important; color: #000 !important; height: auto !important; margin-top: 0; }
            
            body.printing-section3 @page { 
                size: A4 portrait; margin-top: var(--s3-print-margin-top); margin-bottom: var(--s3-print-margin-bottom); margin-left: var(--s3-print-margin-left); margin-right: var(--s3-print-margin-right);
            }
        }
    </style>
</head>
<body>
<div id="header-bar">
        <img id="header-logo" src="https://raw.githubusercontent.com/waryong2025/dasomsoftec/main/dasom.png" alt="DasomSoftec">
        <span id="version-display">Ver 5.6.5</span> </div>
<div id="section1">
        <div class="controls">

            <fieldset>
                <legend>회사 / 노선 정보</legend>
        
                <div class="control-group">
                   <label for="companyInput">회사명:</label>
                    <input type="text" id="companyInput" placeholder="예: 와룡운수">
                </div>

                <div class="control-group">
                  <label for="typeSelect">버스 종류 선택:</label>
                       <select id="typeSelect">
                        <option value="마을">마을</option>
                        <option value="버스">버스</option>
                    </select>
                </div>
  
                <div class="control-group">
                    <label for="routeInput">노선 번호:</label>
                    <input type="text" id="routeInput" placeholder="예: 종로08">
                    <button id="s1-addOrUpdateRoute">노선 추가/수정</button>
                    <button id="s1-deleteRoute" class="btn-danger">선택 노선 삭제</button>
                </div>
                
                <div class="control-group">
                    <label for="routeNavigateSelect">관련 노선 이동:</label>
                   <select id="routeNavigateSelect" class="route-navigate-select"></select>
                </div>
             </fieldset>

            <fieldset>
                <legend>조회 설정</legend>
                <div class="control-group">
                    <label for="yearInput">년도:</label>
                     <input type="number" id="yearInput" value="2025">
                    <label for="monthInput">월:</label>
                    <input type="number" id="monthInput" value="10" min="1" max="12">
                    
                    <button id="s1-generateSchedule">생성</button>
                </div>
                 <div class="control-group">
                    <input type="radio" id="option1" name="displayOption" value="1">
                    <label for="option1">1일 ~ 15일</label>
                   
                    <input type="radio" id="option2" name="displayOption" value="2" checked>
                    <label for="option2">16일 ~ 말일</label>
                </div>
                <div class="control-group holiday-option-group">
                    <label for="holidaySelect">법정휴무일:</label>
                    <select id="holidaySelect">
                         <option value="apply">적용</option>
                        <option value="ignore">미적용</option>
                    </select>
                </div>
       
                <div class="control-group" style="border-top: 1px solid #dee2e6; padding-top: 10px; margin-top: 5px;">
                    <button id="s1-printPage">인쇄</button>
                    
                    <div style="display: flex; flex-direction: row; gap: 10px; margin-left: 5px; align-items: flex-start; flex-grow: 1;">

                        <div style="display: flex; flex-direction: column; gap: 4px; align-items: stretch; padding: 2px 5px; border: 1px solid #ced4da; border-radius: 4px; background-color: #f8f9fa; flex-shrink: 0;">
                            
                            <div style="display: flex; align-items: center; gap: 2px; font-size: 0.9em; justify-content: space-between;">
                                <label for="marginLeftSelect">좌측:</label>
                                <select id="marginLeftSelect" class="margin-select">
                                    <option value="0">0</option><option value="10" selected>10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option>
                                </select>
                            </div>
    
                            <div style="display: flex; align-items: center; gap: 2px; font-size: 0.9em; justify-content: space-between;">
                                <label for="marginRightSelect">우측:</label>
                                <select id="marginRightSelect" class="margin-select">
                                    <option value="0">0</option><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option>
                                </select>
                            </div>
                        </div>
 
                        <div style="display: flex; align-items: center; gap: 3px; font-size: 0.9em; padding: 2px 5px; background-color: #eaf4ff; border-radius: 4px; border: 1px solid #b3d7ff; flex-grow: 1; white-space: nowrap;">
                           <label for="fontSizeInput" style="font-weight: bold;">글자크기조정:</label>
                           <select id="fontSizeInput" class="margin-select" style="width: 45px; padding: 1px 3px; box-sizing: border-box; font-weight: bold;">
                                <option value="8">8pt</option>
                                <option value="9">9pt</option>
                                <option value="10">10pt</option>
                                <option value="11" selected>11pt</option>
                                <option value="12">12pt</option>
                                <option value="13">13pt</option>
                                <option value="14">14pt</option>
                            </select>
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>차량 설정 (현재 노선)</legend>
                
                <div class="control-group" style="display: flex; flex-direction: row; align-items: center; flex-wrap: nowrap; gap: 5px;">
                    
                    <label for="vehicleCountInput" style="margin-right: 0; white-space: nowrap;">차량 수:</label>
                    
                    <input type="number" id="vehicleCountInput" value="11" min="1" max="50" 
                           style="width: 50px; text-align: center; padding: 5px; margin: 0;">
                    
                    <div style="display: flex; flex-direction: column; justify-content: center; margin-right: 5px;">
                        <button type="button" onclick="document.getElementById('vehicleCountInput').stepUp(); document.getElementById('vehicleCountInput').dispatchEvent(new Event('change'));" 
                                style="font-size: 9px; padding: 0 4px; border: 1px solid #ccc; background: #fff; cursor: pointer; line-height: 1; margin-bottom: 1px; text-align: left; color: #007bff; width: 45px; min-width: 45px; height: auto; box-shadow: none;">
                            ▲증가
                        </button>
                        <button type="button" onclick="document.getElementById('vehicleCountInput').stepDown(); document.getElementById('vehicleCountInput').dispatchEvent(new Event('change'));" 
                                style="font-size: 9px; padding: 0 4px; border: 1px solid #ccc; background: #fff; cursor: pointer; line-height: 1; margin-top: 0; text-align: left; color: #dc3545; width: 45px; min-width: 45px; height: auto; box-shadow: none;">
                            ▼감소
                        </button>
                    </div>

                    <button id="s1-saveRouteConfig" style="white-space: nowrap; margin-left: 0;">
                        차량번호저장
                    </button>
                </div>

                <div class="control-group" style="flex-direction: column; align-items: flex-start; margin-top: 10px;">
                    <label>차량 번호 (총 <span id="vehicleCountDisplay">0</span>대):</label>
                    <div id="vehicleInputsContainer">
                        </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>근무전체데이타관리옵션</legend> 
                <div class="control-group">
                    <select id="scheduleActionsSelect" class="action-select">
                        <option value="">근무전체데이타관리옵션</option> <option value="reset">현재 노선 초기화</option>
                        <option value="backup">전체 데이터 저장</option>
                        <option value="restore">전체 데이터 불러오기</option>
                    </select>
                    <input type="file" id="restoreFile" style="display: none;" accept=".json">
                    <button id="s1-calculateWorkdays">근무일수계산</button>
                </div>
                
                <div class="control-group">
                     <select id="vehicleSelect" class="vehicle-select">
                          <option value="">차량 선택</option>
                     </select>
                    <select id="workTypeSelect" class="work-type-select">
                         <option value="">근무조건 선택</option>
                         <option value="normal">3/3 근무</option>
                         <option value="biweekly">격주 근무</option>
                        <option value="five_day">5일근무</option> 
                    </select>
                </div>

                <div style="border-top: 1px solid #dee2e6; padding-top: 10px; margin-top: 5px;"></div> 
                
                <div class="control-group">
                    <button id="s1-showS2">승무일지 및 배차관리</button>
                    <button id="s1-showS3">차량정비점검일지</button>
                </div>
            </fieldset>
            
        </div>

        <div id="scheduleContainer">
            <table>
                <caption id="tableCaption">근무 현황표를 생성해주세요.</caption>
                <thead id="scheduleHeader">
                </thead>
               <tbody id="scheduleBody">
                </tbody>
            </table>
        </div>
    </div>

    <hr class="divider">

    <div id="section2" style="display: none;">
        <div class="journal-container">

            <div class="header-title">승무일지</div>
            <div class="title-area">
                <div class="title-left">
                    <div class="main-title">승 무 일 지</div>
                </div>
    
                <div class="options-right">
                    <button type="button" id="s2-showAll" class="print-button" style="background-color: #6c757d;">전체보기</button>
               
                    <div class="font-selector-container">
                        <label for="font-size-select">글자크기조정:</label>
                        <select id="font-size-select">
                             <option value="8">8pt</option>
                            <option value="9">9pt</option> 
                            <option value="10">10pt</option> 
                            <option value="11" selected>11pt</option> 
                            <option value="12">12pt</option>
                            <option value="13">13pt</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 5px;">
                        <button type="button" id="s2-backupLog" class="print-button" style="background-color: #28a745;">일지백업</button>
                        <button type="button" id="s2-showRestoreModal" class="print-button" style="background-color: #fd7e14;">일지복원</button>
                        <input type="file" id="s2_restoreFile" style="display: none;" accept=".json">
                    </div>

                   <button type="button" id="s2-refreshLog" class="print-button" style="background-color: #17a2b8;">현재일지새로고침</button>
                   <button id="s2-printPage" class="print-button">인쇄하기</button>
                </div>
            </div>

            <div class="date-navigation-area">
                <div>
                    <button id="s2_prevDate" class="date-nav-btn secondary">◀ 이전</button>
                    <button id="s2_today" class="date-nav-btn today">오늘</button>
                    <button id="s2_nextDate" class="date-nav-btn secondary">다음 ▶</button>
                </div>
                <div>
                    <label for="s2_startDate">기간조회:</label>
                    <input type="date" id="s2_startDate">
                    <span>~</span>
                    <input type="date" id="s2_endDate">
                    <button id="s2_loadRange" class="date-nav-btn">조회</button>
                </div>
            </div>
            <div id="dispatch-log-body">
                </div>
        </div>
    </div>
    <div id="s2_restoreDateModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <h3 style="margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px;">승무일지 불러오기</h3>
            <p>백업한 '.json' 파일을 선택하세요.</p>
            <p style="color: red; font-weight: bold;">S2(승무일지)의 모든 기존 데이터는 덮어쓰여집니다.</p>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button id="s2_cancelRestoreBtn" type="button" style="padding: 10px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">취소</button>
                <button id="s2_confirmRestoreBtn" type="button" style="padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">파일 선택</button>
            </div>
        </div>
    </div>

    <hr class="divider">

    <div id="section3" style="display: none;">
        <div class="maintenance-container">
            <header>
                <h1 id="s3_title" style="flex-basis: 100%; text-align: center; order: -1; margin-bottom: 10px;">
                    차량정비점검일지 및 작업의뢰서
                </h1>
                <div class="controls no-print">
                    <button id="s3-showAll" style="background-color: #6c757d; color: white;">전체보기</button>
                    <button id="s3-backupFile" class="primary">일지백업</button> <input type="file" id="s3_restoreFile" style="display: none;" accept=".json">
                    <button id="s3-triggerRestore" class="warning">일지복구</button> 
                    <button id="s3-showCalculator">모든일지및가격</button>
                    <button id="s3-clearForm">폼초기화</button>
                    <button id="s3-printPage" class="primary">인쇄</button> 
      
                    <div class="margin-control-group no-print">
                        <label>인쇄여백</label>
                        <div class="margin-control">
                            <label for="s3_marginLeft">좌</label>
                            <select id="s3_marginLeft" class="margin-select">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                        <div class="margin-control">
                            <label for="s3_marginRight">우</label>
                            <select id="s3_marginRight" class="margin-select">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                    </div>

                  <div style="display: flex; align-items: center; gap: 5px; font-size: 13pt;">
                        <label for="s3_fontSizeInput">글자크기:</label>
                        <select id="s3_fontSizeInput" style="width: 50px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="8">8pt</option>
                            <option value="9">9pt</option>
                            <option value="10">10pt</option>
                            <option value="11" selected>11pt</option>
                            <option value="12">12pt</option>
                            <option value="13">13pt</option>
                            <option value="14">14pt</option>
                        </select>
                    </div>
                </div>
            </header>

            <form id="maintenanceForm">
            <table class="form-table">
                <colgroup>
                    <col class="route-col">  <col class="item-col">   <col class="detail-col"> <col class="parts-col">  <col class="price-col">  <col class="worker-col"> 
                </colgroup>
                    <thead>
                    <tr>
                        <th class="date-col">년/월/일</th>
                        <th colspan="5" id="s3_dateDisplay">
                            <div id="s3_date_nav_container">
                                <span id="s3_prevDate" class="s3_date_nav_btn no-print">◀ 이전</span>
                                <span id="s3_dateDisplay_text">날짜 로딩 중...</span>
                                <span id="s3_nextDate" class="s3_date_nav_btn no-print">다음 ▶</span>
                                <input type="date" id="s3_datePicker" class="no-print">
                            </div>
                        </th>
                    </tr>
                    <tr>
                        <th class="route-col">노선/차량</th>
                        <th class="item-col">항목</th>
                        <th class="detail-col">정비내역</th>
                        <th class="parts-col">부품내역</th>
                        <th class="price-col">부품가격</th>
                        <th class="worker-col">작업자</th>
                    </tr>
                    </thead>
                    <tbody>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_1"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_1" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_1" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_1" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_1" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_1" class="price-input" /></div></td>
                            <td><textarea name="worker_1_1" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_2"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_2" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_2" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_2" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_2" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_2" class="price-input" /></div></td>
                            <td><textarea name="worker_1_2" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_3"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_3" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_3" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_3" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_3" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_3" class="price-input" /></div></td>
                            <td><textarea name="worker_1_3" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_4"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_4" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_4" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_4" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_4" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_4" class="price-input" /></div></td>
                            <td><textarea name="worker_1_4" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_5"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_5" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_5" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_5" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_5" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_5" class="price-input" /></div></td>
                            <td><textarea name="worker_1_5" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_6"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_6" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_6" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_6" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_6" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_6" class="price-input" /></div></td>
                            <td><textarea name="worker_1_6" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_1"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_1" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_1" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_1" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_1" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_1" class="price-input" /></div></td>
                            <td><textarea name="worker_2_1" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_2"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_2" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_2" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_2" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_2" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_2" class="price-input" /></div></td>
                            <td><textarea name="worker_2_2" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_3"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_3" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_3" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_3" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_3" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_3" class="price-input" /></div></td>
                            <td><textarea name="worker_2_3" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_4"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_4" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_4" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_4" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_4" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_4" class="price-input" /></div></td>
                            <td><textarea name="worker_2_4" class="auto-resize"></textarea></td>
                        </tr>
                    </tbody>
                    <tfoot class="no-print">
                    <tr>
                            <td colspan="6" style="text-align: right; padding: 5px;">
                                <button type="button" id="s3-addRow" style="font-size: 11pt; padding: 4px 8px; background-color: #007bff; color: white; border: none;">
                                    행 추가 (+)
                                </button>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </form>

            <p class="thin-text" style="margin-top:8px">사용법: 셀에 내용을 입력한 뒤 'PDF로 저장 / 인쇄' 버튼을 눌러 A4로 저장하세요. 모바일에서는 가로 모드에서 인쇄 결과가 더 잘 맞을 수 있습니다.</p>
        </div>
    </div>

      <div id="s3_calculatorModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <h3 style="margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px;">모든일지및가격</h3>
            <p>기간을 설정하고 모든 일지 내역과 부품 가격 합계를 확인합니다.</p>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                <label>시작일:</label><input type="date" id="s3_startDate" style="flex-grow: 1; padding: 8px;">
                <label>종료일:</label><input type="date" id="s3_endDate" style="flex-grow: 1; padding: 8px;">
                <button id="s3-calculatePrices" style="padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px;">조회</button>
            </div>

            <div style="padding: 10px; border: 1px solid #ddd; background-color: #f8f9fa;">
                <strong>총 부품가격 합계: <span id="s3_totalPrice" style="color: #dc3545;">0원</span></strong>
            </div>
            <p style="font-size: 0.9em; color: #555;">'조회' 버튼을 누르면 합계가 계산되고, 상세 내역은 새 창으로 열립니다.</p>

            <div style="text-align: right; margin-top: 20px;">
                <button id="s3-closeCalculator" style="padding: 10px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">닫기</button>
            </div>
        </div>
    </div>
    
    <div id="s2_timeSettingModal" style="display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 300px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
            <h3 style="margin-top: 0; text-align: center; color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 10px;">
                시간 및 배차간격 설정
            </h3>
            <p id="s2_timeModal_info" style="text-align: center; font-weight: bold; font-size: 0.9em; color: #555; margin-bottom: 15px;">
                차량 정보 로딩 중...
            </p>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div style="display: flex; gap: 5px; align-items: center;">
                    <label style="width: 50px; font-weight: bold;">시간:</label>
                    <input type="number" id="s2_modal_hour" placeholder="시" style="flex: 1; padding: 8px; text-align: center;" min="0" max="23">
                    <span>:</span>
                    <input type="number" id="s2_modal_minute" placeholder="분" style="flex: 1; padding: 8px; text-align: center;" min="0" max="59">
                </div>
                
                <div style="display: flex; gap: 5px; align-items: center;">
                    <label style="width: 50px; font-weight: bold;">간격:</label>
                    <input type="number" id="s2_modal_interval" placeholder="분 (0이면 현재만 수정)" style="flex: 1; padding: 8px; text-align: center;" min="0">
                </div>
            </div>

            <div style="margin-top: 20px; display: flex; justify-content: space-between; gap: 10px;">
                <button id="s2_modal_cancel" style="flex: 1; padding: 10px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">취소</button>
                <button id="s2_modal_apply" style="flex: 1; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">적용</button>
            </div>
            <p style="font-size: 0.8em; color: #888; margin-top: 10px; text-align: center;">
                * 간격을 입력하면 이후 차량 시간도 자동 계산됩니다.
            </p>
        </div>
    </div>
    
<script>
 /* ================================================================= */
/* [공통] 통합 관리자 (DataManager) - 날짜 오류 수정됨 */
/* ================================================================= */

const DataManager = {
    MASTER_KEY: 'busScheduleManagerData', 
    S2_LOG_KEY: 'busDispatchLogData',     
    S3_LOG_KEY: 'busMaintenanceLogData',  
    
    data: {
        s1: { currentRoute: null, routes: {} },
        s2: {},
        s3: {}
    },

    listeners: [],

    dispatch(event, payload) {
        // console.log(`[DataManager] 알림 발생: ${event}`); // 로그 최소화
        this.listeners.forEach(listener => {
            if (typeof listener.onDataChanged === 'function') {
                listener.onDataChanged(event, payload);
            }
        });
    },

    subscribe(module) {
        this.listeners.push(module);
    },

    saveToStorage(key, value) {
        try {
            localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
            console.error(`저장 실패: ${key}`, e);
        }
    },
    loadFromStorage(key) {
        const data = localStorage.getItem(key);
        try { return JSON.parse(data); } catch { return null; }
    },
    
    // [중요 수정] UTC가 아닌 로컬 시간 기준으로 날짜 문자열 반환 (날짜 밀림 방지)
    getTodayDateString(dateObj = new Date()) {
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    },
    
    loadS1Data() {
        let storedData = this.loadFromStorage(this.MASTER_KEY);
        if (!storedData || !storedData.routes) {
            storedData = { currentRoute: null, routes: {} };
        }
        if (!storedData.currentRoute || !storedData.routes[storedData.currentRoute]) {
            storedData.currentRoute = Object.keys(storedData.routes)[0] || null;
        }
        this.data.s1 = storedData;
        return this.data.s1;
    },
    saveS1Data() {
        this.saveToStorage(this.MASTER_KEY, this.data.s1);
        // S1 데이터 저장 시 S2에게 "새로고침하라"는 신호를 보냄
        this.dispatch('s1_data_changed', this.data.s1);
    },
    updateS1Data(updaterFunction) {
        updaterFunction(this.data.s1);
        this.saveS1Data();
    },
    getCurrentRouteData() {
        const routeName = this.data.s1.currentRoute;
        if (!routeName) return { routeName: null, routeData: null };
        return { routeName, routeData: this.data.s1.routes[routeName] };
    },
    getAllRoutes() { return this.data.s1.routes || {}; },
    setCurrentRoute(routeName) {
        this.data.s1.currentRoute = routeName;
        this.saveS1Data();
    },

    loadS2Data() {
        const storedData = this.loadFromStorage(this.S2_LOG_KEY);
        this.data.s2 = storedData || {};
        return this.data.s2;
    },
    saveS2Data() {
        this.saveToStorage(this.S2_LOG_KEY, this.data.s2);
        // S2 데이터 변경 알림 (필요 시)
        this.dispatch('s2_data_changed', this.data.s2); 
    },
    updateS2Data(updaterFunction) {
        updaterFunction(this.data.s2);
        this.saveS2Data();
    },
    getS2RouteSettings(routeName) {
        const s2_route_data = this.data.s2[routeName] || {};
        return Object.assign({
            dispatchType: 'manual', cycle: 'manual', baseOrder: [],
            am_startVehicle: "", am_hour: "", am_minute: "", am_interval: "",
            pm_startVehicle: "", pm_hour: "", pm_minute: "", pm_interval: ""
        }, s2_route_data._settings);
    },
    getS2LogByDate(dateString) { return this.data.s2[dateString] || {}; },

    loadS3Data() {
        const storedData = this.loadFromStorage(this.S3_LOG_KEY);
        this.data.s3 = storedData || {};
        return this.data.s3;
    },
    saveS3Data() { this.saveToStorage(this.S3_LOG_KEY, this.data.s3); },
    updateS3Data(updaterFunction) { updaterFunction(this.data.s3); this.saveS3Data(); }
};

/* ================================================================= */
/* [Section 1] 근무 현황표 JavaScript (Ver 5.6.5 - Full Code) */
/* ================================================================= */

const S1_Module = {
    state: {
        currentRoute: null,
        currentVehicleColumns: [],
        fixedScheduleData: {},
        tempScheduleData: {},
        workTypeConfig: {},
        scheduleData: {},
        hasShownGuide: false,
        autoFillChainStartDate: null,
        pendingSourceDate: null,
        pendingTargetDate: null
    },
    ui: {},
    publicHolidays2025: {
        '01-01': '신정', '01-28': '설날', '01-29': '설날', '01-30': '설날',
        '03-01': '삼일절', '05-05': '어린이날', '05-06': '부처님오신날',
        '06-06': '현충일', '08-15': '광복절', '10-05': '추석',
        '10-06': '추석', '10-07': '추석', '10-09': '한글날', '12-25': '성탄절'
    },

    getLocalYMD(dateObj) {
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    },

    initialize() {
        console.log("S1: 초기화 시작");
        this.ui = {
            companyInput: document.getElementById('companyInput'),
            typeSelect: document.getElementById('typeSelect'),
            routeInput: document.getElementById('routeInput'),
            routeNavigateSelect: document.getElementById('routeNavigateSelect'),
            yearInput: document.getElementById('yearInput'),
            monthInput: document.getElementById('monthInput'),
            holidaySelect: document.getElementById('holidaySelect'),
            marginLeftSelect: document.getElementById('marginLeftSelect'),
            marginRightSelect: document.getElementById('marginRightSelect'),
            fontSizeInput: document.getElementById('fontSizeInput'),
            scheduleActionsSelect: document.getElementById('scheduleActionsSelect'),
            restoreFile: document.getElementById('restoreFile'),
            vehicleSelect: document.getElementById('vehicleSelect'),
            workTypeSelect: document.getElementById('workTypeSelect'),
            vehicleCountInput: document.getElementById('vehicleCountInput'),
            vehicleCountDisplay: document.getElementById('vehicleCountDisplay'),
            vehicleInputsContainer: document.getElementById('vehicleInputsContainer'),
            scheduleContainer: document.getElementById('scheduleContainer')
        };

        const today = new Date();
        this.ui.yearInput.value = today.getFullYear();
        this.ui.monthInput.value = today.getMonth() + 1;
        const currentDay = today.getDate();
        if (currentDay <= 15) {
            document.getElementById('option1').checked = true;
        } else {
            document.getElementById('option2').checked = true;
        }

        this.injectModals();

        const s1_data = DataManager.loadS1Data();
        this.state.currentRoute = s1_data.currentRoute;

        this.bindEventListeners();
        this.populateRouteSelect();
        this.loadRouteData(this.state.currentRoute);
        DataManager.subscribe(this);
        console.log("S1: 초기화 완료.");
    },

    injectModals() {
        if (!document.getElementById('s1-guide-modal')) {
            const guideModalHTML = `
                <div id="s1-guide-modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);">
                    <div style="background-color:#fff; margin:15% auto; padding:20px; border:1px solid #888; width:80%; max-width:500px; border-radius:8px; text-align:center; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                        <h3 style="color:#0056b3; margin-top:0;">📋 근무표 작성 가이드</h3>
                        <p style="text-align:left; line-height:1.6; font-size:15px;">
                            첫 입력시 <strong>모든 직원들의 차량번호에 오전근무자와 오후근무자 고정근무자</strong>로 꼭 채워주시고,<br>
                            다음 라인부터는 <strong>자동으로 근무자가 채워지고</strong><br>
                            그 다음 <strong>스페어 근무자</strong>를 입력하시고 고정 또는 임시로 넣어주시면 됩니다.
                        </p>
                        <button id="s1-close-guide" style="background-color:#007bff; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-weight:bold; margin-top:10px;">확인</button>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', guideModalHTML);
            document.getElementById('s1-close-guide').onclick = () => {
                document.getElementById('s1-guide-modal').style.display = 'none';
            };
        }

        if (!document.getElementById('s1-autofill-modal')) {
            const autofillModalHTML = `
                <div id="s1-autofill-modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);">
                    <div style="background-color:#fff; margin:15% auto; padding:25px; border:1px solid #888; width:90%; max-width:400px; border-radius:10px; text-align:center; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        <h3 style="color:#28a745; margin-top:0; font-size:1.4em;">⚡ 근무자 자동 생성</h3>
                        <div id="s1-autofill-msg" style="font-size:1.1em; line-height:1.6; margin:20px 0; word-break: keep-all;"></div>
                        <div style="display:flex; justify-content:center; gap:10px;">
                            <button id="s1-confirm-autofill" style="background-color:#28a745; color:white; border:none; padding:12px 20px; border-radius:5px; cursor:pointer; font-size:1em; font-weight:bold;">예 (자동생성)</button>
                            <button id="s1-cancel-autofill" style="background-color:#6c757d; color:white; border:none; padding:12px 20px; border-radius:5px; cursor:pointer; font-size:1em;">아니오</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', autofillModalHTML);

            document.getElementById('s1-cancel-autofill').onclick = () => {
                document.getElementById('s1-autofill-modal').style.display = 'none';
                this.state.pendingSourceDate = null;
                this.state.pendingTargetDate = null;
                this.state.autoFillChainStartDate = null;
            };

            document.getElementById('s1-confirm-autofill').onclick = () => {
                this.executeCopyNextDay();
            };
        }
    },

    onDataChanged(event, payload) {
        if (event === 's1_data_changed') {
            const s1_data = payload;
            this.state.currentRoute = s1_data.currentRoute;
            this.populateRouteSelect();
            this.loadRouteData(this.state.currentRoute, true);
        }
    },

    bindEventListeners() {
        document.getElementById('s1-addOrUpdateRoute').onclick = () => this.addOrUpdateRoute();
        document.getElementById('s1-deleteRoute').onclick = () => this.deleteRoute();
        this.ui.routeNavigateSelect.onchange = (e) => this.handleRouteSelectChange(e.target.value);
        document.getElementById('s1-generateSchedule').onclick = () => this.generateSchedule();
        document.getElementById('s1-printPage').onclick = () => this.printPage();
        this.ui.fontSizeInput.onchange = (e) => this.applyFontSize(e.target.value + 'pt');
        this.ui.scheduleActionsSelect.onchange = () => this.handleScheduleActions();
        
        // [수정] 복원 파일 선택 이벤트
        this.ui.restoreFile.onchange = (e) => {
            if (e.target.files.length > 0) {
                this.restoreScheduleData(e.target.files[0]);
            }
        };
        
        document.getElementById('s1-calculateWorkdays').onclick = () => this.calculateWorkdays();
        this.ui.workTypeSelect.onchange = () => this.handleWorkTypeChange();
        this.ui.vehicleCountInput.onchange = (e) => this.handleVehicleCountChange(e.target.value);
        document.getElementById('s1-saveRouteConfig').onclick = () => this.saveRouteConfig();
        document.getElementById('s1-showS2').onclick = () => this.showSection('S2');
        document.getElementById('s1-showS3').onclick = () => this.showSection('S3');

        document.addEventListener('click', (e) => {
            this.clearEditMode(e);
            if (e.target.closest('#scheduleBody td') && !e.target.closest('.edit-mode')) {
                this.checkAndShowFirstEntryGuide();
            }
        });
    },

    checkAndShowFirstEntryGuide() {
        if (this.state.hasShownGuide) return;
        const isEmpty = Object.keys(this.state.fixedScheduleData).length === 0 && Object.keys(this.state.tempScheduleData).length === 0;
        if (isEmpty) {
            document.getElementById('s1-guide-modal').style.display = 'block';
            this.state.hasShownGuide = true;
        }
    },

    populateRouteSelect() {
        const { routes } = DataManager.data.s1;
        const routeSelect = this.ui.routeNavigateSelect;
        routeSelect.innerHTML = '';
        const routeNames = Object.keys(routes);
        if (routeNames.length === 0) {
            routeSelect.innerHTML = '<option value="">노선을 추가하세요</option>';
            return;
        }
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '--- 노선 이동 ---';
        routeSelect.appendChild(defaultOption);
        routeNames.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            if (name === this.state.currentRoute) {
                option.selected = true;
            }
            routeSelect.appendChild(option);
        });
    },

    loadRouteData(routeName, isRefresh = false) {
        const { routes } = DataManager.data.s1;
        if (!routeName || !routes[routeName]) {
            this.ui.routeInput.value = '';
            this.ui.companyInput.value = '';
            this.ui.typeSelect.value = '마을';
            this.ui.vehicleCountInput.value = 0;
            this.handleVehicleCountChange(0);
            this.state.fixedScheduleData = {};
            this.state.tempScheduleData = {};
            this.state.workTypeConfig = {};
            this.state.currentVehicleColumns = [];
            this.state.currentRoute = null;
            DataManager.setCurrentRoute(null);
            this.updateVehicleSelect();
            if (this.ui.routeNavigateSelect) {
                this.ui.routeNavigateSelect.value = '';
            }
            this.generateSchedule();
            return;
        }

        if (!isRefresh) {
            DataManager.setCurrentRoute(routeName);
        }

        this.state.currentRoute = routeName;
        const routeData = routes[routeName];

        this.state.fixedScheduleData = routeData.fixedSchedule;
        this.state.tempScheduleData = routeData.tempSchedule;
        this.state.workTypeConfig = routeData.workTypeConfig;
        this.state.currentVehicleColumns = routeData.vehicleColumns || [];
        this.ui.routeInput.value = routeName;
        this.ui.companyInput.value = routeData.companyName || '';
        this.ui.typeSelect.value = routeData.type || '마을';
        this.ui.vehicleCountInput.value = this.state.currentVehicleColumns.length;

        this.handleVehicleCountChange(this.state.currentVehicleColumns.length);
        this.updateVehicleSelect();
        if (this.ui.routeNavigateSelect) {
            this.ui.routeNavigateSelect.value = routeName;
        }

        this.state.hasShownGuide = false;
        this.state.autoFillChainStartDate = null;
        this.state.pendingSourceDate = null;
        this.state.pendingTargetDate = null;

        this.generateSchedule();
    },

    addOrUpdateRoute() {
        let routeName = this.ui.routeInput.value.trim();
        if (!routeName) {
            alert('노선 번호를 입력하세요.');
            return;
        }
        if (!routeName.endsWith('번')) {
            routeName += '번';
        }
        this.ui.routeInput.value = routeName;
        const companyName = this.ui.companyInput.value.trim();
        const type = this.ui.typeSelect.value;

        DataManager.updateS1Data(s1_data => {
            if (!s1_data.routes[routeName]) {
                const vehicleCount = parseInt(this.ui.vehicleCountInput.value, 10) || 1;
                const newVehicleColumns = Array.from({
                    length: vehicleCount
                }, (_, i) => `차량${i + 1}`);
                if (newVehicleColumns.length === 0) {
                    newVehicleColumns.push('차량1');
                }
                s1_data.routes[routeName] = {
                    companyName: companyName,
                    type: type,
                    vehicleColumns: newVehicleColumns,
                    fixedSchedule: {},
                    tempSchedule: {},
                    workTypeConfig: {}
                };
                alert(`새 노선 [${routeName}]이 추가되었습니다. 차량 수(${vehicleCount}대)와 차량 번호를 설정하세요.`);
            } else {
                s1_data.routes[routeName].companyName = companyName;
                s1_data.routes[routeName].type = type;
                alert(`[${routeName}] 노선 정보 (회사명, 종류)가 수정되었습니다.`);
            }
            s1_data.currentRoute = routeName;
        });
        this.state.currentRoute = routeName;
        this.populateRouteSelect();
        this.loadRouteData(routeName);
    },

    deleteRoute() {
        const routeName = this.ui.routeNavigateSelect.value;
        if (!routeName) {
            alert('삭제할 노선을 [관련 노선 이동] 드롭다운에서 선택하세요.');
            return;
        }
        if (confirm(`[${routeName}] 노선을 정말로 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`)) {
            let newRouteToLoad = null;
            DataManager.updateS1Data(s1_data => {
                delete s1_data.routes[routeName];
                newRouteToLoad = Object.keys(s1_data.routes)[0] || null;
                s1_data.currentRoute = newRouteToLoad;
            });
            this.state.currentRoute = newRouteToLoad;
            this.populateRouteSelect();
            this.loadRouteData(newRouteToLoad);
            alert(`[${routeName}] 노선이 삭제되었습니다.`);
        }
    },

    saveRouteConfig() {
        if (!this.state.currentRoute) {
            alert('먼저 노선을 선택하거나 추가하세요.');
            return;
        }
        const inputs = this.ui.vehicleInputsContainer.querySelectorAll('input');
        const newVehicleColumns = [];
        inputs.forEach(input => {
            newVehicleColumns.push(input.value.trim() || '미입력');
        });
        DataManager.updateS2Data(s2_data => {
            const routeName = this.state.currentRoute;
            if (!s2_data[routeName]) s2_data[routeName] = {};
            if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
            const s1_base_list = newVehicleColumns.filter(v => v && v !== '미입력' && isNaN(Number(v)) === false);
            const collator = new Intl.Collator(undefined, {
                numeric: true,
                sensitivity: 'base'
            });
            s1_base_list.sort(collator.compare);
            const old_s2_order = s2_data[routeName]._settings.baseOrder || [];
            const new_s2_order = [];
            const s1_set = new Set(s1_base_list);
            old_s2_order.forEach(car => {
                if (s1_set.has(car)) {
                    new_s2_order.push(car);
                    s1_set.delete(car);
                }
            });
            s1_set.forEach(car => {
                new_s2_order.push(car);
            });
            s2_data[routeName]._settings.baseOrder = new_s2_order;
        });
        DataManager.updateS1Data(s1_data => {
            const routeData = s1_data.routes[this.state.currentRoute];
            if (routeData) {
                routeData.vehicleColumns = newVehicleColumns;
            }
        });
        this.loadRouteData(this.state.currentRoute);
        alert(`[${this.state.currentRoute}] 노선의 차량 번호가 저장되었습니다. (S2 목록도 갱신됨)`);
    },

    handleVehicleCountChange(countStr) {
        const count = parseInt(countStr) || 0;
        this.ui.vehicleCountDisplay.textContent = count;
        const container = this.ui.vehicleInputsContainer;
        container.innerHTML = '';
        container.style.flexDirection = 'row';
        container.style.alignItems = 'unset';
        const existingColumns = this.state.currentVehicleColumns || [];
        for (let i = 0; i < count; i++) {
            const input = document.createElement('input');
            input.type = 'text';
            const existingValue = existingColumns[i] || '';
            const defaultPlaceholder = `차량 ${i + 1}`;
            const isDefaultValue = /^차량\d+$/.test(existingValue);
            const isNotEntered = (existingValue === '미입력');
            if (isDefaultValue || isNotEntered || existingValue === '') {
                input.value = '';
                input.placeholder = isNotEntered ? '미입력' : defaultPlaceholder;
            } else {
                input.value = existingValue;
                input.placeholder = defaultPlaceholder;
            }
            input.onfocus = (e) => e.target.select();
            container.appendChild(input);
        }
    },

    updateVehicleSelect() {
        const vehicleSelect = this.ui.vehicleSelect;
        vehicleSelect.innerHTML = '<option value="">차량 선택</option>';
        if (this.state.currentVehicleColumns.length > 0) {
            vehicleSelect.innerHTML += '<option value="ALL_VEHICLES" style="font-weight:bold; background-color:#e0e0e0;">--- 전체차량 ---</option>';
        }
        this.state.currentVehicleColumns.forEach(colName => {
            if (colName && colName !== '미입력') {
                const option = document.createElement('option');
                option.value = colName;
                option.textContent = colName;
                vehicleSelect.appendChild(option);
            }
        });
    },

    getDayName(dayOfWeek) {
        return ['일', '월', '화', '수', '목', '금', '토'][dayOfWeek];
    },

    isPublicHoliday(date) {
        const year = date.getFullYear();
        if (year !== 2025) return false;
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const mmdd = `${month}-${day}`;
        return this.publicHolidays2025[mmdd] || false;
    },

    renderCellContent(names) {
        if (!names || names.length === 0) return '';
        return names.map(item => {
            const text = item.text.trim();
            const display = (text === '' || text === '휴무') ? '.' : text;
            const hiddenClass = (text === '' || text === '휴무') ? ' hidden-x' : '';
            const boldClass = item.bold ? ' bold-name' : '';
            return `<span class="name-entry${hiddenClass}${boldClass}">${display}</span>`;
        }).join('');
    },

    editCell(cell, colId, dateString, dayOfWeek) {
        if (cell.classList.contains('edit-mode')) return;
        document.querySelectorAll('#section1 td.edit-mode').forEach(editCell => {
            const prevColId = editCell.dataset.colId;
            const prevDateString = editCell.dataset.dateString;
            const originalNames = (this.state.scheduleData[prevDateString] && this.state.scheduleData[prevDateString][prevColId]) || [{
                text: '',
                bold: false
            }, {
                text: '',
                bold: false
            }];
            editCell.classList.remove('edit-mode');
            editCell.innerHTML = this.renderCellContent(originalNames);
        });
        const currentNames = (this.state.scheduleData[dateString] && this.state.scheduleData[dateString][colId]) || [{
            text: '',
            bold: false
        }, {
            text: '',
            bold: false
        }];
        const morningValue = (currentNames[0] && currentNames[0].text !== '휴무') ? currentNames[0].text : '';
        const afternoonValue = (currentNames[1] && currentNames[1].text !== '휴무') ? currentNames[1].text : '';
        cell.classList.add('edit-mode');
        cell.dataset.colId = colId;
        cell.dataset.dateString = dateString;
        cell.dataset.dayOfWeek = dayOfWeek;
        cell.innerHTML = ` <input type="text" class="morning-input" value="${morningValue}" placeholder="오전 (비우면 휴무)" data-bold="${currentNames[0].bold}"> <input type="text" class="afternoon-input" value="${afternoonValue}" placeholder="오후 (비우면 휴무)" data-bold="${currentNames[1].bold}"> <div class="cell-buttons"> <button class="btn-fixed">고정</button> <button class="btn-temp">임시</button> <button class="btn-highlight-am">오전스페아</button> <button class="btn-highlight-pm">오후스페아</button> <button class="btn-delete">삭제</button> </div> `;
        cell.querySelector('.morning-input').focus();
        const buttons = cell.querySelector('.cell-buttons');
        buttons.querySelector('.btn-fixed').onclick = (e) => {
            e.stopPropagation();
            this.saveFixedCell(cell);
        };
        buttons.querySelector('.btn-temp').onclick = (e) => {
            e.stopPropagation();
            this.saveTempCell(cell);
        };
        buttons.querySelector('.btn-highlight-am').onclick = (e) => {
            e.stopPropagation();
            this.highlightCell(cell, 'am');
        };
        buttons.querySelector('.btn-highlight-pm').onclick = (e) => {
            e.stopPropagation();
            this.highlightCell(cell, 'pm');
        };
        buttons.querySelector('.btn-delete').onclick = (e) => {
            e.stopPropagation();
            this.deleteCell(cell);
        };
    },

    clearEditMode(event) {
        if (event.target.matches('#section1 td:nth-child(1)') || event.target.matches('#section1 td:nth-child(2)')) {
            const editCell = document.querySelector('#section1 td.edit-mode');
            if (editCell) {
                const prevColId = editCell.dataset.colId;
                const prevDateString = editCell.dataset.dateString;
                const originalNames = (this.state.scheduleData[prevDateString] && this.state.scheduleData[prevDateString][prevColId]) || [{
                    text: '',
                    bold: false
                }, {
                    text: '',
                    bold: false
                }];
                editCell.classList.remove('edit-mode');
                editCell.innerHTML = this.renderCellContent(originalNames);
            }
        }
    },

    getNamesAndBoldStateFromCell(cellElement) {
        const morningInput = cellElement.querySelector('.morning-input');
        const afternoonInput = cellElement.querySelector('.afternoon-input');
        const morningText = morningInput.value.trim();
        const afternoonText = afternoonInput.value.trim();
        return [{
            text: morningText === '' ? '' : morningText,
            bold: morningInput.dataset.bold === 'true'
        }, {
            text: afternoonText === '' ? '' : afternoonText,
            bold: afternoonInput.dataset.bold === 'true'
        }];
    },

    highlightCell(cellElement, timeOfDay) {
        let inputElement = cellElement.querySelector(timeOfDay === 'am' ? '.morning-input' : '.afternoon-input');
        if (inputElement) {
            const newState = !(inputElement.dataset.bold === 'true');
            inputElement.dataset.bold = newState;
            inputElement.style.fontWeight = newState ? 'bold' : 'normal';
        }
    },

    saveFixedCell(cellElement) {
        const {
            colId,
            dayOfWeek,
            dateString
        } = cellElement.dataset;
        const newNames = this.getNamesAndBoldStateFromCell(cellElement);
        const currentData = this.state.scheduleData[dateString] && this.state.scheduleData[dateString][colId];
        const oldAm = currentData && currentData[0] ? currentData[0].text : '';
        const oldPm = currentData && currentData[1] ? currentData[1].text : '';
        const newAm = newNames[0].text;
        const newPm = newNames[1].text;
        if (oldAm && oldAm !== '휴무' && oldAm !== newAm) {
            this.updateS2HolidayWorker(dateString, this.state.currentRoute, colId, 'am', oldAm);
        }
        if (oldPm && oldPm !== '휴무' && oldPm !== newPm) {
            this.updateS2HolidayWorker(dateString, this.state.currentRoute, colId, 'pm', oldPm);
        }
        DataManager.updateS1Data(s1_data => {
            const routeData = s1_data.routes[this.state.currentRoute];
            if (!routeData) return;
            const currentRecurringKey = `${dayOfWeek}-${colId}`;
            if (!routeData.fixedSchedule[currentRecurringKey]) {
                routeData.fixedSchedule[currentRecurringKey] = [];
            }
            routeData.fixedSchedule[currentRecurringKey] = routeData.fixedSchedule[currentRecurringKey].filter(entry => entry.dateString !== dateString);
            routeData.fixedSchedule[currentRecurringKey].push({
                dateString: dateString,
                names: newNames
            });
            for (const key in routeData.fixedSchedule) {
                routeData.fixedSchedule[key].sort((a, b) => new Date(b.dateString) - new Date(a.dateString));
            }
            this.state.fixedScheduleData = routeData.fixedSchedule;
        });
        this.generateSchedule();
        this.checkLineComplete(dateString, colId);
    },

    saveTempCell(cellElement) {
        const {
            colId,
            dateString
        } = cellElement.dataset;
        const newNames = this.getNamesAndBoldStateFromCell(cellElement);
        const currentData = this.state.scheduleData[dateString] && this.state.scheduleData[dateString][colId];
        const oldAm = currentData && currentData[0] ? currentData[0].text : '';
        const oldPm = currentData && currentData[1] ? currentData[1].text : '';
        const newAm = newNames[0].text;
        const newPm = newNames[1].text;
        if (oldAm && oldAm !== '휴무' && oldAm !== newAm) {
            this.updateS2HolidayWorker(dateString, this.state.currentRoute, colId, 'am', oldAm);
        }
        if (oldPm && oldPm !== '휴무' && oldPm !== newPm) {
            this.updateS2HolidayWorker(dateString, this.state.currentRoute, colId, 'pm', oldPm);
        }
        DataManager.updateS1Data(s1_data => {
            const routeData = s1_data.routes[this.state.currentRoute];
            if (!routeData) return;
            if (!routeData.tempSchedule[dateString]) routeData.tempSchedule[dateString] = {};
            routeData.tempSchedule[dateString][colId] = newNames;
            this.state.tempScheduleData = routeData.tempSchedule;
        });
        this.generateSchedule();
        this.checkLineComplete(dateString, colId);
    },

    updateS2HolidayWorker(dateString, routeName, carNum, shift, workerName) {
        DataManager.updateS2Data(s2_data => {
            if (!s2_data[dateString]) s2_data[dateString] = {};
            if (!s2_data[dateString][routeName]) s2_data[dateString][routeName] = {};
            if (!s2_data[dateString][routeName][carNum]) s2_data[dateString][routeName][carNum] = {};
            let routeId = routeName.toLowerCase().replace(/[^a-z0-9-]/g, '');
            if (routeName === '종로07번') routeId = '07';
            else if (routeName === '종로08번') routeId = '08';
            else if (routeName === '성동 3-1번') routeId = 'sd31';
            else if (routeName === '성동 3-2번') routeId = 'sd32';
            const key = `holiday_worker_${routeId}_${carNum}_${shift}`;
            s2_data[dateString][routeName][carNum][key] = workerName;
        });
    },

    deleteCell(cellElement) {
        const {
            colId,
            dayOfWeek,
            dateString
        } = cellElement.dataset;
        DataManager.updateS1Data(s1_data => {
            const routeData = s1_data.routes[this.state.currentRoute];
            if (!routeData) return;
            if (routeData.tempSchedule[dateString]?.[colId]) {
                delete routeData.tempSchedule[dateString][colId];
                if (Object.keys(routeData.tempSchedule[dateString]).length === 0) {
                    delete routeData.tempSchedule[dateString];
                }
            }
            const recurringKey = `${dayOfWeek}-${colId}`;
            if (!routeData.fixedSchedule[recurringKey]) {
                routeData.fixedSchedule[recurringKey] = [];
            }
            const blankNames = [{
                text: '',
                bold: false
            }, {
                text: '',
                bold: false
            }];
            routeData.fixedSchedule[recurringKey] = routeData.fixedSchedule[recurringKey].filter(entry => entry.dateString !== dateString);
            routeData.fixedSchedule[recurringKey].push({
                dateString: dateString,
                names: blankNames
            });
            routeData.fixedSchedule[recurringKey].sort((a, b) => new Date(b.dateString) - new Date(a.dateString));
            this.state.fixedScheduleData = routeData.fixedSchedule;
            this.state.tempScheduleData = routeData.tempSchedule;
        });
        this.generateSchedule();
    },

    checkLineComplete(dateString, triggeredColId) {
        const allColumns = this.state.currentVehicleColumns.filter(c => c !== '미입력');
        if (allColumns.length === 0) return;
        const lastColId = allColumns[allColumns.length - 1];
        if (triggeredColId && triggeredColId !== lastColId) {
            return;
        }
        const currentData = this.state.scheduleData[dateString];
        if (!currentData) return;
        let isFull = true;
        for (const col of allColumns) {
            const cellData = currentData[col];
            const am = cellData && cellData[0] ? cellData[0].text.trim() : '';
            const pm = cellData && cellData[1] ? cellData[1].text.trim() : '';
            if (am === '' || pm === '') {
                isFull = false;
                break;
            }
        }
        if (isFull) {
            if (!this.state.autoFillChainStartDate) {
                this.state.autoFillChainStartDate = new Date(dateString);
            }
            const start = this.state.autoFillChainStartDate;
            const current = new Date(dateString);
            const diffTime = current - start;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays >= 7) {
                this.state.autoFillChainStartDate = null;
                return;
            }
            const nextDate = new Date(dateString);
            nextDate.setDate(nextDate.getDate() + 1);
            const nextDateStr = this.getLocalYMD(nextDate);
            this.state.pendingSourceDate = dateString;
            this.state.pendingTargetDate = nextDateStr;
            const msgEl = document.getElementById('s1-autofill-msg');
            msgEl.innerHTML = ` <strong style="color:#333;">${dateString}</strong> 근무자 입력 완료.<br><br> <span style="color:#0056b3; font-weight:bold; font-size:1.2em;">${nextDateStr} (다음날)</span> 근무자도<br> 동일하게 <span style="color:#28a745; font-weight:bold;">자동 생성</span> 하시겠습니까? `;
            document.getElementById('s1-autofill-modal').style.display = 'block';
        }
    },

    executeCopyNextDay() {
        const sourceDateStr = this.state.pendingSourceDate;
        const targetDateStr = this.state.pendingTargetDate;
        if (!sourceDateStr || !targetDateStr) return;
        document.getElementById('s1-autofill-modal').style.display = 'none';
        const sourceData = this.state.scheduleData[sourceDateStr];
        if (!sourceData) return;
        const targetDate = new Date(targetDateStr);
        const targetDayOfWeek = targetDate.getDay();
        const allColumns = this.state.currentVehicleColumns.filter(c => c !== '미입력');
        const lastColId = allColumns.length > 0 ? allColumns[allColumns.length - 1] : null;
        DataManager.updateS1Data(s1_data => {
            const routeData = s1_data.routes[this.state.currentRoute];
            if (!routeData) return;
            Object.keys(sourceData).forEach(colId => {
                const names = sourceData[colId];
                const recurringKey = `${targetDayOfWeek}-${colId}`;
                if (!routeData.fixedSchedule[recurringKey]) {
                    routeData.fixedSchedule[recurringKey] = [];
                }
                routeData.fixedSchedule[recurringKey] = routeData.fixedSchedule[recurringKey].filter(entry => entry.dateString !== targetDateStr);
                routeData.fixedSchedule[recurringKey].push({
                    dateString: targetDateStr,
                    names: JSON.parse(JSON.stringify(names))
                });
                routeData.fixedSchedule[recurringKey].sort((a, b) => new Date(b.dateString) - new Date(a.dateString));
            });
            this.state.fixedScheduleData = routeData.fixedSchedule;
        });
        this.generateSchedule();
        if (lastColId) {
            this.checkLineComplete(targetDateStr, lastColId);
        }
    },

    resetAllFixedSchedules() {
        if (!this.state.currentRoute) {
            alert('초기화할 노선이 선택되지 않았습니다.');
            return;
        }
        const password = prompt(`[${this.state.currentRoute}] 노선의 모든 고정/임시 근무표 및 근무형태 설정을 삭제하시려면 비밀번호를 입력하세요.`);
        if (password === "201023") {
            if (confirm(`[${this.state.currentRoute}] 노선의 모든 근무표 데이터를 삭제합니다. 계속하시겠습니까?`)) {
                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[this.state.currentRoute];
                    if (routeData) {
                        routeData.fixedSchedule = {};
                        routeData.tempSchedule = {};
                        routeData.workTypeConfig = {};
                        this.state.fixedScheduleData = routeData.fixedSchedule;
                        this.state.tempScheduleData = routeData.tempSchedule;
                        this.state.workTypeConfig = routeData.workTypeConfig;
                    }
                });
                DataManager.updateS2Data(s2_data => {
                    const routeName = this.state.currentRoute;
                    if (s2_data[routeName] && s2_data[routeName]._settings) {
                        delete s2_data[routeName]._settings;
                    }
                });
                this.generateSchedule();
                alert(`[${this.state.currentRoute}] 노선의 근무표가 초기화되었습니다.`);
            }
        } else {
            alert("비밀번호 확인 후 신청하세요.");
        }
    },

    backupScheduleData() {
        const backupData = DataManager.data.s1;
        const jsonString = JSON.stringify(backupData);
        const now = new Date();
        const dateString = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
        let companyName = "전체";
        let routeName = "전체";
        if (this.state.currentRoute && DataManager.data.s1.routes[this.state.currentRoute]) {
            const routeData = DataManager.data.s1.routes[this.state.currentRoute];
            companyName = (routeData.companyName || "회사없음").replace(/\s/g, '');
            routeName = this.state.currentRoute.replace(/\s/g, '');
        }
        const filename = `${companyName}_${routeName}_근무현황표(S1)_${dateString}.json`;
        const blob = new Blob([jsonString], {
            type: 'application/json;charset=utf-8'
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        alert(`근무현황표(S1) 데이터 파일 (${filename})이 다운로드 폴더에 JSON 파일로 저장됩니다.`);
    },

    restoreScheduleData(file) {
        const selectElement = this.ui.scheduleActionsSelect;
        if (!file) {
            selectElement.value = '';
            return;
        }
        if (!confirm(`[${file.name}] 파일을 업로드하여 저장된 *모든* 노선의 근무표(S1)를 불러오시겠습니까? (현재 모든 S1 데이터는 덮어쓰여집니다.)`)) {
            this.ui.restoreFile.value = '';
            selectElement.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const loadedData = JSON.parse(event.target.result);
                if (!loadedData.routes || loadedData.currentRoute === undefined) {
                    alert('파일 형식이 올바르지 않거나 데이터가 부족합니다. (routes, currentRoute 속성 필요)');
                    throw new Error('Invalid saved file structure');
                }
                DataManager.updateS1Data(s1_data => {
                    s1_data.routes = loadedData.routes;
                    s1_data.currentRoute = loadedData.currentRoute;
                });
                this.state.currentRoute = loadedData.currentRoute;
                this.populateRouteSelect();
                this.loadRouteData(this.state.currentRoute);
                alert(`[${file.name}] 파일로부터 S1 전체 데이터 불러오기를 완료했습니다. 화면을 확인해주세요.`);
            } catch (e) {
                alert('파일을 읽는 도중 오류가 발생했습니다. 파일이 손상되었거나 JSON 형식이 아닙니다.');
                console.error('Restore Error:', e);
            } finally {
                this.ui.restoreFile.value = '';
                selectElement.value = '';
            }
        };
        reader.onerror = () => {
            alert('파일을 읽을 수 없습니다.');
            this.ui.restoreFile.value = '';
        };
        reader.readAsText(file);
    },

    generateSchedule() {
        if (!this.state.currentRoute) {
            this.ui.scheduleContainer.innerHTML = '<table><caption id="tableCaption">표시할 노선을 선택하거나 추가해주세요.</caption></table>';
            return;
        }
        const year = parseInt(this.ui.yearInput.value);
        const month = parseInt(this.ui.monthInput.value);
        const selectedOption = document.querySelector('#section1 input[name="displayOption"]:checked').value;
        const applyHolidays = this.ui.holidaySelect.value === 'apply';
        const {
            routeData
        } = DataManager.getCurrentRouteData();
        if (!routeData) return;
        const companyName = routeData.companyName || '회사명 없음';
        const VEHICLE_COLS = routeData.vehicleColumns || [];
        this.ui.scheduleContainer.innerHTML = '';
        const startDate = new Date(year, month - 1, selectedOption === '1' ? 1 : 16);
        const endDate = (selectedOption === '1') ? new Date(year, month - 1, 15) : new Date(year, month, 0);
        const colsPerPage = 12;
        const colChunks = [];
        for (let i = 0; i < VEHICLE_COLS.length; i += colsPerPage) {
            colChunks.push(VEHICLE_COLS.slice(i, i + colsPerPage));
        }
        if (colChunks.length === 0) {
            colChunks.push([]);
        }
        const dateRange = [];
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            dateRange.push(new Date(d));
        }
        this.state.scheduleData = {};
        colChunks.forEach((vehicleChunk, chunkIndex) => {
            const table = document.createElement('table');
            if (chunkIndex > 0) {
                table.style.pageBreakBefore = 'always';
            }
            const caption = document.createElement('caption');
            let captionText = `${companyName} [${this.state.currentRoute}] ${year}년 ${month}월 ${startDate.getDate()}일 ~ ${endDate.getDate()}일까지 근무현황표`;
            if (colChunks.length > 1) {
                captionText += ` (페이지 ${chunkIndex + 1}/${colChunks.length})`;
            }
            if (chunkIndex === 0) caption.id = 'tableCaption';
            caption.textContent = captionText;
            table.appendChild(caption);
            const thead = document.createElement('thead');
            if (chunkIndex === 0) thead.id = 'scheduleHeader';
            const headerHTML = `<tr><th style="width: 4%;">월일</th><th style="width: 4%;">요일</th>${vehicleChunk.map(c => `<th>${c}</th>`).join('')}</tr>`;
            thead.innerHTML = headerHTML;
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            if (chunkIndex === 0) tbody.id = 'scheduleBody';
            dateRange.forEach(d => {
                const dateString = this.getLocalYMD(d);
                const dayOfWeek = d.getDay();
                if (!this.state.scheduleData[dateString]) {
                    let cellsContent = {};
                    VEHICLE_COLS.forEach(colId => {
                        let appliedNames = [{
                            text: '',
                            bold: false
                        }, {
                            text: '',
                            bold: false
                        }];
                        if (this.state.tempScheduleData[dateString] && this.state.tempScheduleData[dateString][colId]) {
                            appliedNames = this.state.tempScheduleData[dateString][colId];
                        } else {
                            const recurringKey = `${dayOfWeek}-${colId}`;
                            if (this.state.fixedScheduleData[recurringKey]) {
                                let anchorEntry = null;
                                for (const entry of this.state.fixedScheduleData[recurringKey]) {
                                    if (new Date(dateString) >= new Date(entry.dateString)) {
                                        anchorEntry = entry;
                                        break;
                                    }
                                }
                                if (anchorEntry) {
                                    const workType = this.state.workTypeConfig[colId] || 'normal';
                                    if (workType === 'biweekly' && dayOfWeek !== 0) {
                                        const anchorDate = new Date(anchorEntry.dateString);
                                        const currentDate = new Date(dateString);
                                        anchorDate.setHours(0, 0, 0, 0);
                                        currentDate.setHours(0, 0, 0, 0);
                                        const msInDay = 24 * 60 * 60 * 1000;
                                        const diffInDays = Math.round((currentDate.getTime() - anchorDate.getTime()) / msInDay);
                                        const weekDifference = Math.floor(diffInDays / 7);
                                        if (weekDifference % 2 === 1) {
                                            appliedNames = [anchorEntry.names[1], anchorEntry.names[0]];
                                        } else {
                                            appliedNames = anchorEntry.names;
                                        }
                                    } else {
                                        appliedNames = anchorEntry.names;
                                    }
                                }
                            }
                        }
                        cellsContent[colId] = appliedNames;
                    });
                    this.state.scheduleData[dateString] = cellsContent;
                }
                const holidayName = applyHolidays ? this.isPublicHoliday(d) : false;
                const isHoliday = !!holidayName;
                let rowClass = '';
                const dayName = this.getDayName(dayOfWeek);
                let mainColor = '#333';
                let subText = '';
                if (isHoliday) {
                    rowClass = 'holiday';
                    mainColor = '#cc0000';
                    subText = holidayName.substring(0, 2);
                } else if (dayOfWeek === 0) {
                    rowClass = 'sunday';
                    mainColor = '#cc0000';
                    subText = '일요';
                } else if (dayOfWeek === 6) {
                    rowClass = 'saturday';
                    mainColor = '#0000cc';
                    subText = '토요';
                }
                let dayCellContent;
                if (dayOfWeek === 0 || dayOfWeek === 6 || isHoliday) {
                    dayCellContent = `<div class="day-cell-content"><span class="day-name-main" style="color: ${mainColor};">${dayName}</span><span class="sub-day-info" style="color: ${mainColor};">${subText}</span></div>`;
                } else {
                    dayCellContent = `<div class="day-cell-content"><span class="day-name-main" style="color: ${mainColor};">${dayName}</span><span class="sub-day-info" style="color: ${mainColor};"></span></div>`;
                }
                const dataCellsHTML = vehicleChunk.map(colId => `<td onclick="S1_Module.editCell(this, '${colId}', '${dateString}', ${dayOfWeek})">${this.renderCellContent(this.state.scheduleData[dateString][colId])}</td>`).join('');
                tbody.insertAdjacentHTML('beforeend', `<tr class="${rowClass}"><td>${d.getDate()}</td><td>${dayCellContent}</td>${dataCellsHTML}</tr>`);
            });
            table.appendChild(tbody);
            this.ui.scheduleContainer.appendChild(table);
        });
    },

    calculateWorkdays() {
        if (!this.state.currentRoute) {
            alert('근무일수를 계산할 노선이 없습니다.');
            return;
        }
        const {
            routeData
        } = DataManager.getCurrentRouteData();
        if (!routeData) return;
        const year = parseInt(this.ui.yearInput.value);
        const month = parseInt(this.ui.monthInput.value);
        const VEHICLE_COLS = routeData.vehicleColumns || [];
        const workdayCounts = {};
        const shiftCounts = {};
        const allNames = new Set();
        const startDate = new Date(year, month - 1, 1);
        const endDate = new Date(year, month, 0);
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateString = this.getLocalYMD(d);
            const dayOfWeek = d.getDay();
            let dailyNames = {};
            VEHICLE_COLS.forEach(colId => {
                if (colId === '미입력') return;
                let appliedNames = [{
                    text: '',
                    bold: false
                }, {
                    text: '',
                    bold: false
                }];
                if (routeData.tempSchedule[dateString] && routeData.tempSchedule[dateString][colId]) {
                    appliedNames = routeData.tempSchedule[dateString][colId];
                } else {
                    const recurringKey = `${dayOfWeek}-${colId}`;
                    if (routeData.fixedSchedule[recurringKey]) {
                        for (const entry of routeData.fixedSchedule[recurringKey]) {
                            if (new Date(dateString) >= new Date(entry.dateString)) {
                                appliedNames = entry.names;
                                break;
                            }
                        }
                    }
                }
                dailyNames[colId] = appliedNames;
            });
            const dayWorkdays = new Set();
            for (const colId in dailyNames) {
                if (colId !== '비고' && colId !== '미입력') {
                    dailyNames[colId].forEach((item, index) => {
                        const name = item.text.trim();
                        if (name !== '' && name !== '휴무') {
                            allNames.add(name);
                            if (!shiftCounts[name]) shiftCounts[name] = {
                                오전: 0,
                                오후: 0
                            };
                            if (index === 0) shiftCounts[name].오전++;
                            else shiftCounts[name].오후++;
                            dayWorkdays.add(name);
                        }
                    });
                }
            }
            dayWorkdays.forEach(name => {
                if (!workdayCounts[name]) workdayCounts[name] = 0;
                workdayCounts[name]++;
            });
        }
        const combinedData = Array.from(allNames).map(name => ({
            name: name,
            workdays: workdayCounts[name] || 0,
            morningShifts: (shiftCounts[name] && shiftCounts[name].오전) || 0,
            afternoonShifts: (shiftCounts[name] && shiftCounts[name].오후) || 0
        }));
        combinedData.sort((a, b) => b.workdays - a.workdays);
        const title = `[${this.state.currentRoute}] ${year}년 ${month}월 근무일수`;
        const tableHTML = ` <table style="width: 100%; border-collapse: collapse;"> <thead><tr> <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">이름</th> <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">오전</th> <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">오후</th> <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">총 근무일수</th> </tr></thead> <tbody>${combinedData.map(data => ` <tr> <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.name}</td> <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.morningShifts}일</td> <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.afternoonShifts}일</td> <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.workdays}일</td> </tr>`).join('')} </tbody> </table>`;
        const newWindow = window.open('', '_blank', 'width=600,height=400');
        newWindow.document.write(`<html><head><title>${title}</title><style> body { font-family: Arial, sans-serif; margin: 20px; } h3 { text-align: center; } table { width: 100%; border-collapse: collapse; margin-top: 20px; } th, td { border: 1px solid #ddd; padding: 10px; text-align: center; } th { background-color: #f2f2f2; } .print-button { display: block; margin: 20px auto; padding: 10px 20px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; } @media print { .print-button { display: none; } html, body { height: 100%; width: 100%; margin: 0; } } </style></head><body><h3>${title}</h3>${tableHTML}<button class="print-button" onclick="window.print()">인쇄</button></body></html>`);
        newWindow.document.close();
    },

    printPage() {
        const editCell = document.querySelector('#section1 td.edit-mode');
        if (editCell) {
            const {
                colId,
                dateString
            } = editCell.dataset;
            const originalNames = this.state.scheduleData[dateString]?.[colId] || [{
                text: '',
                bold: false
            }, {
                text: '',
                bold: false
            }];
            editCell.classList.remove('edit-mode');
            editCell.innerHTML = this.renderCellContent(originalNames);
        }
        document.documentElement.style.setProperty('--print-margin-left', `${this.ui.marginLeftSelect.value}mm`);
        document.documentElement.style.setProperty('--print-margin-right', `${this.ui.marginRightSelect.value}mm`);
        const originalTitle = document.title;
        const captionText = document.getElementById('tableCaption').textContent;
        let newTitle = "근무현황표";
        const matches = captionText.match(/\[(.*?)\] (\d{4})년 (\d{1,2})월 (\d{1,2})일 ~ (\d{1,2})일/);
        if (matches) {
            newTitle = `${matches[1]} ${matches[2]}-${matches[3].padStart(2, '0')} (${matches[4].padStart(2, '0')}일-${matches[5].padStart(2, '0')}일)`;
        } else if (this.state.currentRoute) {
            newTitle = `${this.state.currentRoute} 근무현황표`;
        }
        document.body.classList.remove('printing-section2', 'printing-section3');
        document.body.classList.add('printing-section1');
        const handleAfterPrint = () => {
            document.title = originalTitle;
            document.documentElement.style.removeProperty('--print-margin-left');
            document.documentElement.style.removeProperty('--print-margin-right');
            document.body.classList.remove('printing-section1');
            window.removeEventListener('afterprint', handleAfterPrint);
        };
        window.addEventListener('afterprint', handleAfterPrint);
        document.title = newTitle;
        window.print();
    },

    applyFontSize(size) {
        if (parseFloat(size) < 8) size = '8pt';
        if (parseFloat(size) > 20) size = '20pt';
        document.documentElement.style.setProperty('--worker-font-size', size);
    },

    handleScheduleActions() {
        const action = this.ui.scheduleActionsSelect.value;
        if (action === 'reset') this.resetAllFixedSchedules();
        else if (action === 'backup') this.backupScheduleData();
        else if (action === 'restore') this.ui.restoreFile.click();
        this.ui.scheduleActionsSelect.value = '';
    },

    handleWorkTypeChange() {
        const selectedValue = this.ui.vehicleSelect.value;
        const workType = this.ui.workTypeSelect.value;
        if (!selectedValue || !workType) return;
        let workTypeName = '';
        if (workType === 'normal') workTypeName = '3/3 근무';
        else if (workType === 'biweekly') workTypeName = '격주 근무';
        else if (workType === 'five_day') workTypeName = '5일 근무';
        if (selectedValue === 'ALL_VEHICLES') {
            const vehicleCount = this.state.currentVehicleColumns.filter(c => c !== '미입력').length;
            if (vehicleCount === 0) {
                alert('설정할 차량이 없습니다.');
            } else if (confirm(`[${this.state.currentRoute}] 노선의 '미입력'을 제외한 *전체 차량* (${vehicleCount}대)의 근무형태를 [${workTypeName}]로 설정하고 저장하시겠습니까?`)) {
                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[this.state.currentRoute];
                    if (!routeData) return;
                    this.state.currentVehicleColumns.forEach(colId => {
                        if (colId !== '미입력') {
                            routeData.workTypeConfig[colId] = workType;
                        }
                    });
                    this.state.workTypeConfig = routeData.workTypeConfig;
                });
                alert(`[${this.state.currentRoute}] 노선의 전체 차량 근무형태가 [${workTypeName}]로 설정되었습니다. '고정' 저장 시 적용됩니다.`);
            }
        } else {
            const colId = selectedValue;
            if (confirm(`차량 [${colId}]의 근무형태를 [${workTypeName}]로 설정하고 저장하시겠습니까?`)) {
                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[this.state.currentRoute];
                    if (!routeData) return;
                    routeData.workTypeConfig[colId] = workType;
                    this.state.workTypeConfig = routeData.workTypeConfig;
                });
                alert(`차량 [${colId}]의 근무형태가 [${workTypeName}]로 설정되었습니다. '고정' 저장 시 적용됩니다.`);
            }
        }
        this.ui.vehicleSelect.value = '';
        this.ui.workTypeSelect.value = '';
    },

    handleRouteSelectChange(routeName) {
        if (routeName) {
            this.loadRouteData(routeName);
        }
    },

    showSection(sectionId) {
        document.getElementById('section1').style.display = 'none';
        document.getElementById('section2').style.display = 'none';
        document.getElementById('section3').style.display = 'none';
        document.querySelectorAll('.divider').forEach(d => d.style.display = 'none');
        const targetSection = document.getElementById(`section${sectionId.replace('S', '')}`);
        if (targetSection) {
            targetSection.style.display = 'block';
            targetSection.scrollIntoView({
                behavior: 'smooth'
            });
        }
    },

    showAllSections() {
        document.getElementById('section1').style.display = 'block';
        document.getElementById('section2').style.display = 'block';
        document.getElementById('section3').style.display = 'block';
        document.querySelectorAll('.divider').forEach(d => d.style.display = 'block');
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    },

    setVersion() {
        try {
            document.getElementById('version-display').textContent = 'Ver 5.6.5';
        } catch (e) {
            console.error("버전 정보를 설정하는 데 실패했습니다.", e);
        }
    }
};

/* ================================================================= */
/* [Section 2] 승무 일지 JavaScript (Ver 5.6.5 - Holiday Display Added) */
/* ================================================================= */

const S2_Module = {
    ui: {
        headerTitle: document.querySelector('#section2 .header-title'),
        fontSizeSelect: document.getElementById('font-size-select'),
        dispatchLogBody: document.getElementById('dispatch-log-body'),
        prevDateBtn: document.getElementById('s2_prevDate'),
        todayBtn: document.getElementById('s2_today'),
        nextDateBtn: document.getElementById('s2_nextDate'),
        startDateInput: document.getElementById('s2_startDate'),
        endDateInput: document.getElementById('s2_endDate'),
        loadRangeBtn: document.getElementById('s2_loadRange'),
        restoreModal: document.getElementById('s2_restoreDateModal'),
        restoreFile: document.getElementById('s2_restoreFile'),
        cancelRestoreBtn: document.getElementById('s2_cancelRestoreBtn'),
        confirmRestoreBtn: document.getElementById('s2_confirmRestoreBtn'),
        timeModal: document.getElementById('s2_timeSettingModal'),
        timeModalInfo: document.getElementById('s2_timeModal_info'),
        modalHour: document.getElementById('s2_modal_hour'),
        modalMinute: document.getElementById('s2_modal_minute'),
        modalInterval: document.getElementById('s2_modal_interval'),
        modalApplyBtn: document.getElementById('s2_modal_apply'),
        modalCancelBtn: document.getElementById('s2_modal_cancel'),
    },

    state: {
        s2_currentDates: [],
        S2_ROUTE_MAP: {
            '종로07번': '07', '종로08번': '08',
            '성동 3-1번': 'sd31', '성동 3-2번': 'sd32'
        },
        S2_USED_VEHICLES: {},
        s2_draggedCell: null,
        s2_draggedRoute: null,
        activeTimeTarget: null
    },

    addDays(date, days) {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    },

    rotateArray(array, count) {
        const len = array.length;
        if (len === 0) return [];
        const netCount = count % len;
        if (netCount === 0) return [...array];
        if (netCount > 0) {
            return [...array.slice(netCount), ...array.slice(0, netCount)];
        } else {
            return [...array.slice(len + netCount), ...array.slice(0, len + netCount)];
        }
    },

    seededShuffle(array, seed) {
        const result = [...array];
        let m = result.length, t, i;
        let h = 0x811c9dc5;
        for (let j = 0; j < seed.length; j++) {
            h ^= seed.charCodeAt(j);
            h = Math.imul(h, 0x01000193);
        }
        
        const random = () => {
            let t = (h += 0x6D2B79F5);
            t = Math.imul(t ^ (t >>> 15), t | 1);
            t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
            return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        };

        while (m) {
            i = Math.floor(random() * m--);
            t = result[m];
            result[m] = result[i];
            result[i] = t;
        }
        return result;
    },

    initialize() {
        console.log("S2: 초기화 시작");
        DataManager.subscribe(this);
        DataManager.loadS2Data();

        this.bindEventListeners();
        this.loadToday();
        this.refreshDispatchLog();
        console.log("S2: 초기화 완료.");
    },

    loadToday() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayString = DataManager.getTodayDateString(today);
        this.state.s2_currentDates = [{ date: today, dateString: todayString }];
        this.ui.startDateInput.value = todayString;
        this.ui.endDateInput.value = todayString;
        this.refreshDispatchLog();
    },

    onDataChanged(event, payload) {
        if (event === 's1_data_changed') {
            this.refreshDispatchLog();
        }
    },

    bindEventListeners() {
        document.getElementById('s2-showAll').onclick = () => S1_Module.showAllSections();
        this.ui.fontSizeSelect.onchange = (e) => this.changeFontSize(e.target.value);
        document.getElementById('s2-backupLog').onclick = () => this.backupLogData();
        document.getElementById('s2-showRestoreModal').onclick = () => this.showRestoreModal();
        
        document.getElementById('s2-refreshLog').onclick = () => {
            if (confirm("현재 조회된 날짜의 시간 데이터를 모두 지우고, 출차 순서를 '수동'으로 초기화하시겠습니까?")) {
                this.resetS2LogForCurrentDates();
                this.refreshDispatchLog();
            }
        };
        
        document.getElementById('s2-printPage').onclick = () => this.printPage();

        this.ui.prevDateBtn.onclick = () => this.navigateDate(-1);
        this.ui.todayBtn.onclick = () => this.loadToday();
        this.ui.nextDateBtn.onclick = () => this.navigateDate(1);
        this.ui.loadRangeBtn.onclick = () => this.loadDateRange();
        this.ui.cancelRestoreBtn.onclick = () => this.hideRestoreModal();
        this.ui.confirmRestoreBtn.onclick = () => this.triggerRestore();
        this.ui.restoreFile.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                this.restoreLogData(file);
                this.hideRestoreModal();
            }
        };
        
        this.ui.modalCancelBtn.onclick = () => { this.ui.timeModal.style.display = 'none'; };
        this.ui.modalApplyBtn.onclick = () => this.applyTimeFromModal();

        const logBody = this.ui.dispatchLogBody;
        logBody.onchange = (e) => {
            const target = e.target;
            if (target.tagName === 'INPUT' && (target.name.startsWith('start_time_') || target.name.startsWith('pm_start_time_'))) {
                target.value = this.formatTimeInput(target.value);
                this.saveS2LogEntryFromElement(target);
            } else if (target.tagName === 'SELECT' && target.classList.contains('s2-work-hours-select')) {
                this.handleWorkHoursChange(target);
            } else if (e.target.classList.contains('dispatch-cycle-select')) {
                e.stopPropagation();
                const routeId = e.target.closest('.dispatch-cycle-container').dataset.routeId;
                const routeName = document.getElementById(`route-${routeId}`).dataset.routeName;
                this.changeDispatchCycle(routeName, e.target.value);
            } else if (e.target.classList.contains('car-select-dropdown')) {
                e.stopPropagation();
                const routeName = e.target.closest('.route-section').dataset.routeName;
                this.changeCarNumber(e.target, routeName);
            } else if (target.name && (target.name.startsWith('am_startVehicle') || target.name.startsWith('pm_startVehicle'))) {
                 const routeId = target.name.split('_')[2];
                 const routeName = document.getElementById(`route-${routeId}`).dataset.routeName;
                 this.saveScheduleSettings(routeName, routeId);
            }
            else if (target.closest('.schedule-options')) {
                e.stopPropagation();
            }
        };

        logBody.onclick = (e) => {
            const carCell = e.target.closest('.car-number-cell');
            const driverCell = e.target.closest('td[data-edit-type="driver"]');
            const dispatchBtn = e.target.closest('.dispatch-button');
            
            if (e.target.tagName === 'INPUT' && (e.target.name.startsWith('start_time_') || e.target.name.startsWith('pm_start_time_'))) {
                this.openTimeModal(e.target);
                return;
            }

            if (carCell) {
                e.preventDefault();
                const routeName = carCell.closest('.route-section').dataset.routeName;
                this.toggleCarNumberEditMode(carCell, routeName);
            } else if (driverCell) {
                e.preventDefault();
                this.toggleEditMode(driverCell);
            } else if (dispatchBtn) {
                e.preventDefault();
                const routeName = document.getElementById(`route-${dispatchBtn.closest('.dispatch-buttons-container').dataset.routeId}`).dataset.routeName;
                this.changeDispatchOrder(routeName, dispatchBtn.dataset.order, dispatchBtn.closest('.dispatch-buttons-container'));
            }
        };

        logBody.onmousedown = (e) => {
             const carControlBtn = e.target.closest('.car-controls button');
             if (carControlBtn) {
                 e.preventDefault();
                 const td = carControlBtn.closest('.car-number-cell');
                 if (carControlBtn.classList.contains('btn-car-delete')) this.deleteCarRow(td);
                 else if (carControlBtn.classList.contains('btn-car-close')) this.exitCarNumberEditMode(td);
                 return;
             }
             const driverControlBtn = e.target.closest('.edit-controls button');
             if (driverControlBtn) {
                 e.preventDefault();
                 const td = driverControlBtn.closest('td[data-edit-type="driver"]');
                 if (driverControlBtn.classList.contains('btn-driver-delete')) this.deleteName(td);
                 else if (driverControlBtn.classList.contains('btn-driver-save')) this.saveAndExit(td);
                 return;
             }
             const settingBtn = e.target.closest('.setting-button');
             if (settingBtn) {
                 e.preventDefault();
                 const routeId = settingBtn.dataset.routeId;
                 const routeName = document.getElementById(`route-${routeId}`).dataset.routeName;
                 const dateString = this.state.s2_currentDates[0]?.dateString;
                 if (!dateString) return;
 
                 if (settingBtn.classList.contains('apply-button')) this.applyScheduleSettings(routeName, routeId, dateString, true);
                 else if (settingBtn.classList.contains('reset-button')) this.resetScheduleSettings(routeName, routeId);
             }
         };
        logBody.ondragstart = (e) => this.dragStart(e, e.target.closest('.route-section').dataset.routeName);
        logBody.ondragover = (e) => this.dragOver(e);
        logBody.ondrop = (e) => this.drop(e, e.target.closest('.route-section').dataset.routeName);
        logBody.ondragend = (e) => this.dragEnd(e);
    },
    
    openTimeModal(inputElement) {
        this.state.activeTimeTarget = inputElement; 
        const carNum = inputElement.dataset.carNum;
        const shift = inputElement.dataset.shift; 
        const routeSection = inputElement.closest('.route-section');
        const routeName = routeSection.dataset.routeName;
        
        let currentVal = inputElement.value.replace(/[^0-9:]/g, '');
        let hh = '', mm = '';
        if (currentVal.length === 4 && !currentVal.includes(':')) {
            hh = currentVal.substr(0, 2);
            mm = currentVal.substr(2, 2);
        } else if (currentVal.includes(':')) {
            [hh, mm] = currentVal.split(':');
        }

        this.ui.timeModalInfo.textContent = `[${routeName}] ${carNum}호 (${shift === 'am' ? '오전' : '오후'}) 출발시간 설정`;
        this.ui.modalHour.value = hh;
        this.ui.modalMinute.value = mm;
        this.ui.modalInterval.value = ''; 
        this.ui.timeModal.style.display = 'block';
        this.ui.modalHour.focus();
    },

    applyTimeFromModal() {
        const targetInput = this.state.activeTimeTarget;
        if (!targetInput) return;

        const hour = parseInt(this.ui.modalHour.value);
        const minute = parseInt(this.ui.modalMinute.value);
        const interval = parseInt(this.ui.modalInterval.value) || 0;

        if (isNaN(hour) || isNaN(minute)) {
            alert("시, 분을 정확히 입력해주세요.");
            return;
        }

        let currentTime = new Date();
        currentTime.setHours(hour, minute, 0, 0);

        const routeSection = targetInput.closest('.route-section');
        const shift = targetInput.dataset.shift; 
        
        const allInputs = Array.from(routeSection.querySelectorAll(`input[name*="${shift === 'am' ? '_am' : '_pm'}"]`));
        const timeInputs = allInputs.filter(el => el.name.startsWith(shift === 'am' ? 'start_time_' : 'pm_start_time_'));
        
        timeInputs.sort((a, b) => parseInt(a.dataset.seqOrder || 0) - parseInt(b.dataset.seqOrder || 0));

        let startIndex = timeInputs.indexOf(targetInput);
        if (startIndex === -1) return;

        DataManager.updateS2Data(s2_data => {
            const dateString = targetInput.closest('tr').dataset.dateString;
            const routeName = routeSection.dataset.routeName;
            
            for (let i = startIndex; i < timeInputs.length; i++) {
                const input = timeInputs[i];
                const carNum = input.dataset.carNum;
                const timeTd = input.closest('td');
                const driverTd = timeTd.previousElementSibling; 
                const driverNameSpan = driverTd.querySelector('.driver-name');
                const driverName = driverNameSpan ? driverNameSpan.textContent.trim() : '';
                
                if (driverName && driverName !== '휴무') {
                    const timeStr = currentTime.toTimeString().slice(0, 5);
                    input.value = timeStr;
                    if (!s2_data[dateString]) s2_data[dateString] = {};
                    if (!s2_data[dateString][routeName]) s2_data[dateString][routeName] = {};
                    if (!s2_data[dateString][routeName][carNum]) s2_data[dateString][routeName][carNum] = {};
                    
                    const dbKey = (shift === 'am') 
                        ? `start_time_${this.sanitizeForId(routeName)}_${carNum}_am` 
                        : `pm_start_time_${this.sanitizeForId(routeName)}_${carNum}_pm`;
                    
                    s2_data[dateString][routeName][carNum][dbKey] = timeStr;

                    if (interval !== 0) currentTime.setMinutes(currentTime.getMinutes() + interval);
                } else {
                    input.value = '';
                    if (!s2_data[dateString]) s2_data[dateString] = {};
                    if (!s2_data[dateString][routeName]) s2_data[dateString][routeName] = {};
                    if (!s2_data[dateString][routeName][carNum]) s2_data[dateString][routeName][carNum] = {};

                    const dbKey = (shift === 'am') 
                        ? `start_time_${this.sanitizeForId(routeName)}_${carNum}_am` 
                        : `pm_start_time_${this.sanitizeForId(routeName)}_${carNum}_pm`;
                    s2_data[dateString][routeName][carNum][dbKey] = '';
                }
            }
        });
        this.ui.timeModal.style.display = 'none';
    },

    getFormattedDateString(dateObj) {
        return dateObj.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'long' }).replace(/\. /g, '.').replace(/\.$/, '');
    },
    changeFontSize(size) { document.getElementById('section2').style.fontSize = size + 'pt'; },
    printPage() {
        document.body.classList.remove('printing-section1', 'printing-section3');
        document.body.classList.add('printing-section2');
        const handleAfterPrint = () => {
            document.body.classList.remove('printing-section2');
            window.removeEventListener('afterprint', handleAfterPrint);
        };
        window.addEventListener('afterprint', handleAfterPrint);
        window.print();
    },
    sanitizeForId(text) {
        if (!text) return 'unknown';
        const s2_id = this.state.S2_ROUTE_MAP[text];
        return s2_id ? s2_id : text.toLowerCase().replace(/[^a-z0-9-]/g, '');
    },
    formatTimeInput(val) {
        if(!val) return '';
        val = val.replace(/[^0-9:]/g, '');
        if(val.length === 4 && !val.includes(':')) return val.slice(0,2) + ':' + val.slice(2);
        return val;
    },
    saveS2LogEntryFromElement(el) {
        const name = el.name;
        const val = el.value;
        const dateStr = el.closest('tr').dataset.dateString;
        const routeName = el.closest('.route-section').dataset.routeName;
        const carNum = el.dataset.carNum;
        
        DataManager.updateS2Data(s2_data => {
            if(!s2_data[dateStr]) s2_data[dateStr] = {};
            if(!s2_data[dateStr][routeName]) s2_data[dateStr][routeName] = {};
            if(!s2_data[dateStr][routeName][carNum]) s2_data[dateStr][routeName][carNum] = {};
            s2_data[dateStr][routeName][carNum][name] = val;
        });
    },
    backupLogData() {
        const backupData = DataManager.data.s2;
        const jsonString = JSON.stringify(backupData);
        const now = new Date();
        const dateString = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
        const filename = `승무일지(S2)_백업_${dateString}.json`;
        const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        alert('승무일지 데이터가 백업되었습니다.');
    },
    showRestoreModal() { this.ui.restoreModal.style.display = 'block'; },
    hideRestoreModal() { this.ui.restoreModal.style.display = 'none'; this.ui.restoreFile.value = ''; },
    triggerRestore() { this.ui.restoreFile.click(); },
    restoreLogData(file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const loadedData = JSON.parse(event.target.result);
                DataManager.updateS2Data(s2_data => {
                    Object.keys(s2_data).forEach(key => delete s2_data[key]);
                    Object.assign(s2_data, loadedData);
                });
                alert('승무일지 데이터가 복원되었습니다.');
                this.refreshDispatchLog();
            } catch (e) { alert('파일을 읽는 도중 오류가 발생했습니다.'); }
        };
        reader.readAsText(file);
    },

    changeDispatchOrder(routeName, order, buttonContainer) {
        buttonContainer.querySelectorAll('.dispatch-button').forEach(btn => btn.classList.toggle('active', btn.dataset.order === order));
        
        const cycleSelect = buttonContainer.nextElementSibling.querySelector('.dispatch-cycle-select');
        if (order === 'manual') {
            cycleSelect.value = 'manual';
            cycleSelect.disabled = true;
            DataManager.updateS2Data(s2_data => {
                 if (!s2_data[routeName]) s2_data[routeName] = {};
                 if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
                 s2_data[routeName]._settings.cycle = 'manual';
            });
        } else {
            cycleSelect.disabled = false;
            if (cycleSelect.value === 'manual') {
                cycleSelect.value = 'daily';
                DataManager.updateS2Data(s2_data => {
                     if (!s2_data[routeName]) s2_data[routeName] = {};
                     if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
                     s2_data[routeName]._settings.cycle = 'daily';
                });
            }
        }

        DataManager.updateS2Data(s2_data => {
            if (!s2_data[routeName]) s2_data[routeName] = {};
            if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
            s2_data[routeName]._settings.dispatchType = order;
        });
    },

    changeDispatchCycle(routeName, cycle) {
        DataManager.updateS2Data(s2_data => {
            if (!s2_data[routeName]) s2_data[routeName] = {};
            if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
            s2_data[routeName]._settings.cycle = cycle;
        });
    },

    navigateDate(days) {
        if (this.state.s2_currentDates.length === 0) return this.loadToday();
        const currentDate = this.state.s2_currentDates[0].date;
        const newDate = this.addDays(currentDate, days);
        newDate.setHours(0, 0, 0, 0);
        const newDateString = DataManager.getTodayDateString(newDate);
        this.state.s2_currentDates = [{ date: newDate, dateString: newDateString }];
        this.ui.startDateInput.value = newDateString;
        this.ui.endDateInput.value = newDateString;
        this.refreshDispatchLog();
    },

    loadDateRange() {
        const startDate = new Date(this.ui.startDateInput.value + 'T00:00:00');
        const endDate = new Date(this.ui.endDateInput.value + 'T00:00:00');
        if (isNaN(startDate) || isNaN(endDate)) return alert('날짜를 선택해주세요.');
        if (startDate > endDate) return alert('시작일은 종료일보다 이전이어야 합니다.');
        const dates = [];
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            d.setHours(0, 0, 0, 0);
            dates.push({ date: new Date(d), dateString: DataManager.getTodayDateString(d) });
        }
        if (dates.length > 31) return alert('최대 31일까지 조회 가능합니다.');
        this.state.s2_currentDates = dates;
        this.refreshDispatchLog();
    },

    calculateOrderForDate(routeName, targetDateString, s2_settings) {
        let baseOrder = s2_settings.baseOrder || [];
        
        // S1 데이터 강제 확인 및 동기화
        const allRoutes = DataManager.getAllRoutes();
        const routeData = allRoutes[routeName];
        if (routeData && routeData.vehicleColumns) {
            let s1_base_list = routeData.vehicleColumns.filter(v => v && v !== '미입력');
            const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
            s1_base_list.sort(collator.compare);
            
            if (!baseOrder.length || baseOrder.length !== s1_base_list.length) {
                baseOrder = s1_base_list;
            }
        }
        
        if (!baseOrder.length) return [];
        if (s2_settings.dispatchType === 'manual' || s2_settings.cycle === 'manual') return baseOrder;

        if (s2_settings.dispatchType === 'random') {
             const seed = targetDateString.replace(/-/g, '') + routeName;
             return this.seededShuffle(baseOrder, seed);
        }

        const today = new Date(); today.setHours(0, 0, 0, 0);
        const targetDate = new Date(targetDateString); targetDate.setHours(0, 0, 0, 0);
        const diffDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
        
        let rotateCount = 0;
        if (s2_settings.cycle === 'daily') rotateCount = diffDays;
        else if (s2_settings.cycle === 'weekly') rotateCount = Math.floor(diffDays / 7);
        else if (s2_settings.cycle === 'monthly') rotateCount = Math.floor(diffDays / 30);
        
        if (s2_settings.dispatchType === 'descending') {
            rotateCount = -rotateCount;
        }

        return this.rotateArray(baseOrder, rotateCount);
    },

    calculateAutoTimes(validVehicles, s2_settings, todayS1Schedule) {
        const result = {};
        const am_interval = parseInt(s2_settings.am_interval, 10);
        const pm_interval = parseInt(s2_settings.pm_interval, 10);
        
        const am_hour = s2_settings.am_hour !== '' ? parseInt(s2_settings.am_hour, 10) : NaN;
        const am_minute = s2_settings.am_minute !== '' ? parseInt(s2_settings.am_minute, 10) : NaN;
        
        const pm_hour = s2_settings.pm_hour !== '' ? parseInt(s2_settings.pm_hour, 10) : NaN;
        const pm_minute = s2_settings.pm_minute !== '' ? parseInt(s2_settings.pm_minute, 10) : NaN;

        if (!isNaN(am_interval) && !isNaN(am_hour) && !isNaN(am_minute)) {
            let am_time = new Date();
            am_time.setHours(am_hour, am_minute, 0, 0);
            
            validVehicles.forEach((carNum) => {
                if (!result[carNum]) result[carNum] = {};
                const s1Data = todayS1Schedule[carNum];
                const amDriver = (s1Data && s1Data[0] && s1Data[0].text) ? s1Data[0].text.trim() : '';
                const hasAmDriver = (amDriver !== '' && amDriver !== '휴무');

                if (hasAmDriver) {
                    result[carNum].am = am_time.toTimeString().slice(0, 5);
                    am_time.setMinutes(am_time.getMinutes() + am_interval);
                } else {
                    result[carNum].am = ''; 
                }
            });
        }

        if (!isNaN(pm_interval) && !isNaN(pm_hour) && !isNaN(pm_minute)) {
            let pm_time = new Date();
            pm_time.setHours(pm_hour, pm_minute, 0, 0);
            
            let startIdx = validVehicles.indexOf(s2_settings.pm_startVehicle);
            if (startIdx === -1) startIdx = 0;

            const assignPM = (idx) => {
                const carNum = validVehicles[idx];
                if (!result[carNum]) result[carNum] = {};

                const s1Data = todayS1Schedule[carNum];
                const pmDriver = (s1Data && s1Data[1] && s1Data[1].text) ? s1Data[1].text.trim() : '';
                const hasPmDriver = (pmDriver !== '' && pmDriver !== '휴무');
                
                if (hasPmDriver) {
                    result[carNum].pm = pm_time.toTimeString().slice(0, 5);
                    pm_time.setMinutes(pm_time.getMinutes() + pm_interval);
                } else {
                    result[carNum].pm = '';
                }
            };

            for (let i = startIdx; i < validVehicles.length; i++) assignPM(i);
            for (let i = 0; i < startIdx; i++) assignPM(i);
        }
        return result;
    },

    refreshDispatchLog() {
        console.log("[S2] 승무일지 새로고침 시작...");
        const { routeData } = DataManager.getCurrentRouteData();
        this.ui.headerTitle.textContent = `${routeData ? routeData.companyName : "승무일지"} 승무일지`;
        const container = this.ui.dispatchLogBody;
        container.innerHTML = '';

        if (this.state.s2_currentDates.length === 0) {
            container.innerHTML = '<div class="date-header">조회할 날짜를 선택해주세요.</div>';
            return;
        }

        this.state.s2_currentDates.forEach(dateInfo => {
            const { date, dateString } = dateInfo;
            const dayOfWeek = date.getDay();
            const s2_logData = DataManager.getS2LogByDate(dateString);

            // [중요 수정] 법정휴일 표시 로직 추가
            const holidaySelect = document.getElementById('holidaySelect');
            const applyHolidays = holidaySelect && holidaySelect.value === 'apply';
            let holidaySuffix = "";

            if (applyHolidays && S1_Module && S1_Module.isPublicHoliday) {
                 const hName = S1_Module.isPublicHoliday(date);
                 if (hName) {
                     holidaySuffix = ` <span style="color:#cc0000; font-size:0.8em;">(${hName})</span>`;
                 }
            }

            container.insertAdjacentHTML('beforeend', `<div class="date-header">${this.getFormattedDateString(date)}${holidaySuffix}</div>`);

            const allRoutes = DataManager.getAllRoutes();
            for (const routeName in allRoutes) {
                const routeData = allRoutes[routeName];
                if (!routeData) continue;

                const routeId = this.sanitizeForId(routeName);
                const s2_settings = DataManager.getS2RouteSettings(routeName);
                
                const todayS1Schedule = this.getTodayS1Schedule(routeData, dateString, dayOfWeek);
                const todayS2RouteLog = s2_logData[routeName] || {};

                let validVehicles = this.calculateOrderForDate(routeName, dateString, s2_settings);
                
                if (!validVehicles || validVehicles.length === 0) {
                    let s1_base_list = (routeData.vehicleColumns || []).filter(v => v && v !== '미입력');
                    const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
                    s1_base_list.sort(collator.compare);
                    validVehicles = s1_base_list;
                }

                if (s2_settings.dispatchType === 'manual' && s2_settings.cycle === 'manual' && s2_settings.am_startVehicle) {
                    const idx = validVehicles.indexOf(s2_settings.am_startVehicle);
                    if (idx > -1) validVehicles = this.rotateArray(validVehicles, idx);
                }

                const autoTimes = this.calculateAutoTimes(validVehicles, s2_settings, todayS1Schedule);

                let s2_optionsHTML = (dateString === this.state.s2_currentDates[0].dateString) ? 
                    this.createOptionsHTML(routeId, routeName, validVehicles, s2_settings) : '';

                const halfCount = Math.ceil(validVehicles.length / 2);
                let tableBodyHTML = '';
                for (let i = 0; i < halfCount; i++) {
                    const leftCar = validVehicles[i] || '미입력';
                    const rightCar = validVehicles[i + halfCount] || '미입력';
                    const leftSeq = i + 1;
                    const rightSeq = i + 1 + halfCount;

                    const leftHTML = this.createRowSideHTML(routeName, leftCar, leftSeq, todayS1Schedule, todayS2RouteLog, s2_settings, dateString, autoTimes);
                    const rightHTML = this.createRowSideHTML(routeName, rightCar, rightSeq, todayS1Schedule, todayS2RouteLog, s2_settings, dateString, autoTimes);
                    tableBodyHTML += `<tr data-date-string="${dateString}">${leftHTML}${rightHTML}</tr>`;
                }

                container.insertAdjacentHTML('beforeend', `
                    <div class="route-section" id="route-${routeId}" data-route-name="${routeName}">
                        <div class="route-header-flex">
                            <div class="route-title-group"><div class="route-name-text">${routeName}</div></div>
                            ${s2_optionsHTML}
                        </div>
                        <table class="journal-table">${this.createTableHeaderHTML(routeId)}<tbody>${tableBodyHTML}</tbody></table>
                    </div>
                `);
            }
        });
    },

    getTodayS1Schedule(routeData, dateString, dayOfWeek) {
        const s1Schedule = {};
        const VEHICLE_COLS = routeData.vehicleColumns || [];
        VEHICLE_COLS.forEach(colId => {
            if (colId === '미입력') return;
            let appliedNames = [{ text: '', bold: false }, { text: '', bold: false }]; 
            if (routeData.tempSchedule[dateString] && routeData.tempSchedule[dateString][colId]) {
                appliedNames = routeData.tempSchedule[dateString][colId];
            } 
            else {
                const recurringKey = `${dayOfWeek}-${colId}`;
                if (routeData.fixedSchedule[recurringKey]) {
                    let anchorEntry = null;
                    for (const entry of routeData.fixedSchedule[recurringKey]) {
                        if (new Date(dateString) >= new Date(entry.dateString)) {
                            anchorEntry = entry;
                            break;
                        }
                    }
                    if (anchorEntry) {
                        const workType = routeData.workTypeConfig[colId] || 'normal';
                        if (workType === 'biweekly' && dayOfWeek !== 0) {
                            const anchorDate = new Date(anchorEntry.dateString);
                            const currentDate = new Date(dateString);
                            anchorDate.setHours(0, 0, 0, 0);
                            currentDate.setHours(0, 0, 0, 0);
                            const msInDay = 24 * 60 * 60 * 1000;
                            const diffInDays = Math.round((currentDate.getTime() - anchorDate.getTime()) / msInDay);
                            const weekDifference = Math.floor(diffInDays / 7);
                            
                            if (weekDifference % 2 === 1) {
                                appliedNames = [anchorEntry.names[1], anchorEntry.names[0]];
                            } else {
                                appliedNames = anchorEntry.names;
                            }
                        } else {
                            appliedNames = anchorEntry.names;
                        }
                    }
                }
            }
            s1Schedule[colId] = appliedNames;
        });
        return s1Schedule;
    },

    resetS2LogForCurrentDates() {
        DataManager.updateS2Data(s2_data => {
            this.state.s2_currentDates.forEach(d => { 
                if (s2_data[d.dateString]) delete s2_data[d.dateString]; 
            });
            
            const allRoutes = DataManager.getAllRoutes();
            Object.keys(allRoutes).forEach(r => {
                if (!s2_data[r]) s2_data[r] = {};
                if (!s2_data[r]._settings) s2_data[r]._settings = {};
                s2_data[r]._settings.dispatchType = 'manual';
                s2_data[r]._settings.cycle = 'manual';
                
                ['am_startVehicle', 'am_hour', 'am_minute', 'am_interval', 
                 'pm_startVehicle', 'pm_hour', 'pm_minute', 'pm_interval'].forEach(k => {
                    delete s2_data[r]._settings[k];
                });
            });
        });
    },

    saveScheduleSettings(routeName, routeId) {
        const container = document.getElementById(`route-${routeId}`);
        const getVal = (name) => container.querySelector(`[name="${name}_${routeId}"]`).value;
        const settings = {
            am_startVehicle: getVal('am_startVehicle'), am_hour: getVal('am_hour'), am_minute: getVal('am_minute'), am_interval: getVal('am_interval'),
            pm_startVehicle: getVal('pm_startVehicle'), pm_hour: getVal('pm_hour'), pm_minute: getVal('pm_minute'), pm_interval: getVal('pm_interval')
        };
        DataManager.updateS2Data(s2_data => {
            if (!s2_data[routeName]) s2_data[routeName] = {};
            if (!s2_data[routeName]._settings) s2_data[routeName]._settings = {};
            Object.assign(s2_data[routeName]._settings, settings);
        });
    },

    applyScheduleSettings(routeName, routeId, dateString, forceSave = false) {
        this.saveScheduleSettings(routeName, routeId);
        this.refreshDispatchLog();
        if (forceSave) alert(`[${routeName}] 시간 설정이 적용되었습니다.`);
    },

    resetScheduleSettings(routeName, routeId) {
        if (!confirm("시간 설정과 입력된 시간을 초기화하시겠습니까?")) return;
        
        DataManager.updateS2Data(s2_data => {
            if (s2_data[routeName]?._settings) {
                const s = s2_data[routeName]._settings;
                ['am_startVehicle','am_hour','am_minute','am_interval','pm_startVehicle','pm_hour','pm_minute','pm_interval'].forEach(k => delete s[k]);
            }
            const dateStr = this.state.s2_currentDates[0]?.dateString;
            if (dateStr && s2_data[dateStr] && s2_data[dateStr][routeName]) {
                const log = s2_data[dateStr][routeName];
                Object.keys(log).forEach(car => {
                    delete log[car][`start_time_${routeId}_${car}_am`];
                    delete log[car][`pm_start_time_${routeId}_${car}_pm`];
                });
            }
        });
        this.refreshDispatchLog();
    },

    createTableHeaderHTML(routeId) {
        const colgroup = `
            <colgroup>
                <col style="width: 3%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;">
                <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;">
                <col style="width: 3%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;">
                <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;"> <col style="width: 5%;">
            </colgroup>`;
        const header = `
            <thead>
                <tr>
                    <th style="background:#e9ecef; color:#333;">순서</th>
                    <th id="header_car_${routeId}_1">차<br>번</th> <th>오전<br>근무</th> <th>출발<br>시간</th> <th>근무<br>시간</th> <th>휴무자<br>(오전)</th>
                    <th>오후<br>근무</th> <th>출발<br>시간</th> <th>근무<br>시간</th> <th>휴무자<br>(오후)</th>
                    
                    <th style="background:#e9ecef; color:#333;">순서</th>
                    <th id="header_car_${routeId}_2">차<br>번</th> <th>오전<br>근무</th> <th>출발<br>시간</th> <th>근무<br>시간</th> <th>휴무자<br>(오전)</th>
                    <th>오후<br>근무</th> <th>출발<br>시간</th> <th>근무<br>시간</th> <th>휴무자<br>(오후)</th>
                </tr>
            </thead>`;
        return colgroup + header;
    },

    createRowSideHTML(routeName, carNum, seqNum, todayS1Schedule, todayS2RouteLog, s2_settings, dateString, autoTimes = {}) {
        const routeId = this.sanitizeForId(routeName);
        const seqHTML = `<td style="font-weight:bold; background-color:#f8f9fa; color:#555;">${seqNum}</td>`;

        if (carNum === '미입력' || !carNum) {
            return `${seqHTML}<td class="car-number-cell" data-car-number="미입력"></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>`;
        }

        const s1CarData = todayS1Schedule[carNum] || [{text:''},{text:''}];
        const amDriver = (s1CarData[0].text||'').trim();
        const pmDriver = (s1CarData[1].text||'').trim();
        const amDisp = (amDriver===''||amDriver==='휴무')?'':amDriver;
        const pmDisp = (pmDriver===''||pmDriver==='휴무')?'':pmDriver;
        
        const log = todayS2RouteLog[carNum] || {};
        const amKey = `start_time_${routeId}_${carNum}_am`;
        const pmKey = `pm_start_time_${routeId}_${carNum}_pm`;
        const amHKey = `work_hours_${routeId}_${carNum}_am`;
        const pmHKey = `work_hours_${routeId}_${carNum}_pm`;
        
        const amHolidayWorkerStored = log[`holiday_worker_${routeId}_${carNum}_am`] || '';
        const pmHolidayWorkerStored = log[`holiday_worker_${routeId}_${carNum}_pm`] || '';

        const amHoliday = log[amHKey] === '휴무';
        const pmHoliday = log[pmHKey] === '휴무';
        
        const amHolidayDisp = amHolidayWorkerStored ? amHolidayWorkerStored : (amHoliday ? amDisp : '');
        const pmHolidayDisp = pmHolidayWorkerStored ? pmHolidayWorkerStored : (pmHoliday ? pmDisp : '');
        
        const amClass = (amHoliday && amDisp) ? 'hidden' : '';
        const pmClass = (pmHoliday && pmDisp) ? 'hidden' : '';

        const amTimeValue = log[amKey] !== undefined ? log[amKey] : (autoTimes[carNum] && autoTimes[carNum].am ? autoTimes[carNum].am : '');
        const pmTimeValue = log[pmKey] !== undefined ? log[pmKey] : (autoTimes[carNum] && autoTimes[carNum].pm ? autoTimes[carNum].pm : '');

        const opts = (val) => ['', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '휴무'].map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('');

        return `
            ${seqHTML}
            <td class="car-number-cell" data-car-number="${carNum}" draggable="true">
                <div class="car-display">${carNum}</div>
                <div class="car-controls hidden">
                    <select class="car-select-dropdown"></select>
                    <div><button class="btn-car-delete">삭제</button><button class="btn-car-close">닫기</button></div>
                </div>
            </td>
            <td data-edit-type="driver" data-s1-key="${routeName}" data-car-number="${carNum}" data-shift="am" data-date-string="${dateString}">
                <span class="driver-name ${amClass}" style="${s1CarData[0].bold?'font-weight:bold':''}">${amDisp}</span>
                <input type="text" class="driver-input hidden" value="${amDriver}">
                <div class="edit-controls hidden"><button class="btn-driver-delete">삭제</button><button class="btn-driver-save">저장</button></div>
            </td>
            <td><input type="text" inputmode="numeric" name="${amKey}" data-car-num="${carNum}" data-shift="am" data-seq-order="${seqNum}" value="${amTimeValue}" ${amDisp?'':'disabled'}></td>
            <td><select class="s2-work-hours-select" name="${amHKey}" data-car-num="${carNum}" data-shift="am" ${amDisp?'':'disabled'}>${opts(log[amHKey])}</select></td>
            <td class="s2-holiday-cell" data-shift="am">${amHolidayDisp}</td>
            
            <td data-edit-type="driver" data-s1-key="${routeName}" data-car-number="${carNum}" data-shift="pm" data-date-string="${dateString}">
                <span class="driver-name ${pmClass}" style="${s1CarData[1].bold?'font-weight:bold':''}">${pmDisp}</span>
                <input type="text" class="driver-input hidden" value="${pmDriver}">
                <div class="edit-controls hidden"><button class="btn-driver-delete">삭제</button><button class="btn-driver-save">저장</button></div>
            </td>
            <td><input type="text" inputmode="numeric" name="${pmKey}" data-car-num="${carNum}" data-shift="pm" data-seq-order="${seqNum}" value="${pmTimeValue}" ${pmDisp?'':'disabled'}></td>
            <td><select class="s2-work-hours-select" name="${pmHKey}" data-car-num="${carNum}" data-shift="pm" ${pmDisp?'':'disabled'}>${opts(log[pmHKey])}</select></td>
            <td class="s2-holiday-cell" data-shift="pm">${pmHolidayDisp}</td>
        `;
    },

    handleWorkHoursChange(el) {
        const val = el.value;
        const td = el.closest('td');
        const holidayCell = td.nextElementSibling;
        const driverCell = td.previousElementSibling.previousElementSibling;
        const timeInput = td.previousElementSibling.querySelector('input');
        const driverName = driverCell.querySelector('.driver-name');
        
        if (val === '휴무') {
            if(holidayCell) holidayCell.textContent = driverName.textContent;
            driverName.classList.add('hidden');
            if(timeInput) { timeInput.value = ''; this.saveS2LogEntryFromElement(timeInput); }
        } else {
            if(holidayCell) holidayCell.textContent = '';
            driverName.classList.remove('hidden');
            if(timeInput && driverName.textContent.trim()) timeInput.disabled = false;
        }
        this.saveS2LogEntryFromElement(el);
    },

    createOptionsHTML(routeId, routeName, validVehicles, s2_settings) {
        const dType = s2_settings.dispatchType || 'manual';
        const cycle = s2_settings.cycle || 'manual';
        
        const opts = validVehicles.map(c => `<option value="${c}" ${s2_settings.am_startVehicle===c?'selected':''}>${c}</option>`).join('');
        const pmOpts = validVehicles.map(c => `<option value="${c}" ${s2_settings.pm_startVehicle===c?'selected':''}>${c}</option>`).join('');

        const btns = [['manual','수동'],['ascending','순차'],['descending','역순'],['random','랜덤']].map(([k,v]) => 
            `<button type="button" class="dispatch-button ${dType===k?'active':''}" data-order="${k}">${v}</button>`
        ).join('');
        const cycles = [['manual','주기 없음'],['daily','하루'],['weekly','1주'],['monthly','1개월']].map(([k,v]) => 
            `<option value="${k}" ${cycle===k?'selected':''}>${v}</option>`
        ).join('');
        
        const am_hour = s2_settings.am_hour || '';
        const am_minute = s2_settings.am_minute || '';
        const am_interval = s2_settings.am_interval || '';
        const pm_hour = s2_settings.pm_hour || '';
        const pm_minute = s2_settings.pm_minute || '';
        const pm_interval = s2_settings.pm_interval || '';

        return `
            <div class="schedule-options">
                <div class="am-options"><span>오전</span>
                    <select name="am_startVehicle_${routeId}"><option value="">시작차량</option>${opts}</select>
                    <input type="number" name="am_hour_${routeId}" placeholder="시" value="${am_hour}">
                    <input type="number" name="am_minute_${routeId}" placeholder="분" value="${am_minute}">
                    <input type="number" name="am_interval_${routeId}" placeholder="간격" value="${am_interval}">
                </div>
                <div class="pm-options"><span>오후</span>
                    <select name="pm_startVehicle_${routeId}"><option value="">오후시작</option>${pmOpts}</select>
                    <input type="number" name="pm_hour_${routeId}" placeholder="시" value="${pm_hour}">
                    <input type="number" name="pm_minute_${routeId}" placeholder="분" value="${pm_minute}">
                    <input type="number" name="pm_interval_${routeId}" placeholder="간격" value="${pm_interval}">
                </div>
            </div>
            <div class="settings-controls">
                <button type="button" class="setting-button apply-button" data-route-id="${routeId}">시간 적용</button>
                <button type="button" class="setting-button reset-button" data-route-id="${routeId}">시간 초기화</button>
            </div>
            <div class="load-button-container">
                <div class="dispatch-buttons-container" data-route-id="${routeId}"><label>출차순서:</label>${btns}</div>
                <div class="dispatch-cycle-container" data-route-id="${routeId}"><label>순환주기:</label>
                <select class="dispatch-cycle-select" ${dType==='manual'?'disabled':''}>${cycles}</select></div>
            </div>
        `;
    },
    fillOptionsValues(routeId, s2_settings) {},
    toggleEditMode(cell) {
        document.querySelectorAll('td[data-edit-type="driver"]').forEach(c => {
            c.querySelector('.driver-name').classList.remove('hidden');
            c.querySelector('.driver-input').classList.add('hidden');
            c.querySelector('.edit-controls').classList.add('hidden');
        });
        cell.querySelector('.driver-name').classList.add('hidden');
        const inp = cell.querySelector('.driver-input');
        inp.classList.remove('hidden');
        cell.querySelector('.edit-controls').classList.remove('hidden');
        inp.focus(); inp.select();
    },
    saveAndExit(cell) {
        const routeName = cell.dataset.s1Key;
        const carNum = cell.dataset.carNumber;
        const shiftIdx = (cell.dataset.shift === 'am') ? 0 : 1;
        const newVal = cell.querySelector('.driver-input').value.trim();
        const dateStr = cell.dataset.dateString;
        
        DataManager.updateS1Data(s1_data => {
            const route = s1_data.routes[routeName];
            if(!route) return;
            if(!route.tempSchedule[dateStr]) route.tempSchedule[dateStr] = {};
            
            const todaySch = this.getTodayS1Schedule(route, dateStr, new Date(dateStr).getDay());
            const current = todaySch[carNum] || [{text:''},{text:''}];
            current[shiftIdx].text = (newVal===''||newVal==='휴무') ? '' : newVal;
            route.tempSchedule[dateStr][carNum] = current;
        });
        this.refreshDispatchLog();
    },
    deleteName(cell) {
        cell.querySelector('.driver-input').value = '';
        this.saveAndExit(cell);
    },
    toggleCarNumberEditMode(cell, routeName) {
        const display = cell.querySelector('.car-display');
        const ctrls = cell.querySelector('.car-controls');
        const sel = cell.querySelector('.car-select-dropdown');
        
        if (ctrls.classList.contains('hidden')) {
            const routeData = DataManager.getAllRoutes()[routeName];
            const allCars = (routeData.vehicleColumns||[]).filter(v=>v&&v!=='미입력');
            const used = {};
            cell.closest('.route-section').querySelectorAll('.car-number-cell').forEach(c=>used[c.dataset.carNumber]=true);
            
            sel.innerHTML = '<option value="">-- 변경 --</option>' + 
                allCars.map(c => (used[c] && c!==cell.dataset.carNumber) ? '' : `<option value="${c}" ${c===cell.dataset.carNumber?'selected':''}>${c}</option>`).join('');
            
            display.classList.add('hidden');
            ctrls.classList.remove('hidden');
        } else {
            display.classList.remove('hidden');
            ctrls.classList.add('hidden');
        }
    },
    changeCarNumber(sel, routeName) {
        const newCar = sel.value;
        const oldCar = sel.closest('td').dataset.carNumber;
        const dateStr = sel.closest('tr').dataset.dateString;
        if(!newCar || newCar===oldCar) return;
        
        DataManager.updateS2Data(s2_data => {
            const log = s2_data[dateStr]?.[routeName];
            if(log && log[oldCar]) {
                const oldD = log[oldCar];
                const newD = {};
                const rId = this.sanitizeForId(routeName);
                Object.keys(oldD).forEach(k => newD[k.replace(`_${oldCar}_`,`_${newCar}_`)] = oldD[k]);
                delete log[oldCar];
                log[newCar] = newD;
            }
            const sett = s2_data[routeName]?._settings;
            if(sett?.baseOrder) {
                const idx = sett.baseOrder.indexOf(oldCar);
                if(idx>-1) sett.baseOrder[idx] = newCar;
            }
        });
        this.refreshDispatchLog();
    },
    deleteCarRow(cell) {
        if(!confirm("이 차량을 승무일지에서 삭제하시겠습니까?")) return;
        const car = cell.dataset.carNumber;
        const route = cell.closest('.route-section').dataset.routeName;
        const date = cell.closest('tr').dataset.dateString;
        
        DataManager.updateS2Data(s2_data => {
            if(s2_data[date]?.[route]?.[car]) delete s2_data[date][route][car];
            const sett = s2_data[route]?._settings;
            if(sett?.baseOrder) sett.baseOrder = sett.baseOrder.filter(c => c !== car);
        });
        this.refreshDispatchLog();
    },
    exitCarNumberEditMode(cell) {
        cell.querySelector('.car-display').classList.remove('hidden');
        cell.querySelector('.car-controls').classList.add('hidden');
    },
    
    dragStart(e, routeName) {
        this.state.s2_draggedCell = e.target.closest('td');
        this.state.s2_draggedRoute = routeName;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', e.target.closest('td').dataset.carNumber);
        setTimeout(() => {
            this.state.s2_draggedCell.style.opacity = '0.4';
        }, 0);
    },
    dragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    },
    drop(e, routeName) {
        e.preventDefault();
        if (this.state.s2_draggedRoute !== routeName) {
            console.warn("[S2] 다른 노선 간 드래그는 불가능합니다.");
            return;
        }
        const targetCell = e.target.closest('td.car-number-cell');
        const draggedCar = this.state.s2_draggedCell.dataset.carNumber;
        const targetCar = targetCell.dataset.carNumber;

        if (draggedCar === targetCar) return;
        DataManager.updateS2Data(s2_data => {
            const s2_settings = DataManager.getS2RouteSettings(routeName);
            let baseOrder = s2_settings.baseOrder || [];
            
            const draggedIndex = baseOrder.indexOf(draggedCar);
            const targetIndex = baseOrder.indexOf(targetCar);
            
            if (draggedIndex > -1 && targetIndex > -1) {
                const [draggedItem] = baseOrder.splice(draggedIndex, 1);
                baseOrder.splice(targetIndex, 0, draggedItem);
                
                if (!s2_data[routeName]) s2_data[routeName] = {};
                s2_data[routeName]._settings = { ...s2_settings, baseOrder: baseOrder };
                
                const container = document.querySelector(`#route-${this.sanitizeForId(routeName)} .dispatch-buttons-container`);
                if (container) {
                    this.changeDispatchOrder(routeName, 'manual', container);
                }
            }
        });
        this.refreshDispatchLog();
    },
    dragEnd(e) {
        if (this.state.s2_draggedCell) {
                this.state.s2_draggedCell.style.opacity = '1';
                this.state.s2_draggedCell = null;
                this.state.s2_draggedRoute = null;
            }
        }
    };

    /* ================================================================= */
    /* [Section 3] 차량정비점검일지 JavaScript */
    /* ================================================================= */

    const S3_Module = {
        ui: {
            dateDisplay: document.getElementById('s3_dateDisplay_text'),
            datePicker: document.getElementById('s3_datePicker'),
            prevDateBtn: document.getElementById('s3_prevDate'),
            nextDateBtn: document.getElementById('s3_nextDate'),
            form: document.getElementById('maintenanceForm'),
            tbody: document.querySelector('#maintenanceForm tbody'),
            
            calculatorModal: document.getElementById('s3_calculatorModal'),
            calcStartDate: document.getElementById('s3_startDate'),
            calcEndDate: document.getElementById('s3_endDate'),
            calcTotal: document.getElementById('s3_totalPrice'),
            
            restoreFile: document.getElementById('s3_restoreFile'),
            
            marginLeftSelect: document.getElementById('s3_marginLeft'),
            marginRightSelect: document.getElementById('s3_marginRight'),
            fontSizeInput: document.getElementById('s3_fontSizeInput'),
        },
        
        state: {
            currentDate: new Date(),
            rowCount: 0
        },

        initialize() {
            console.log("S3: 초기화 시작");
            DataManager.subscribe(this);
            
            // 오늘 날짜 설정
            this.state.currentDate.setHours(0,0,0,0);
            
            this.bindEventListeners();
            this.loadDataForDate(this.state.currentDate);
            console.log("S3: 초기화 완료.");
        },

        onDataChanged(event, payload) {
            if (event === 's1_data_changed') {
                // 노선 정보가 바뀌면 드롭다운 갱신 필요
                this.updateAllRouteSelects();
            }
        },

        bindEventListeners() {
            document.getElementById('s3-showAll').onclick = () => S1_Module.showAllSections();
            
            // 날짜 네비게이션
            this.ui.prevDateBtn.onclick = () => this.navigateDate(-1);
            this.ui.nextDateBtn.onclick = () => this.navigateDate(1);
            
            this.ui.dateDisplay.onclick = () => {
                this.ui.datePicker.showPicker ? this.ui.datePicker.showPicker() : this.ui.datePicker.click();
            };
            
            this.ui.datePicker.onchange = (e) => {
                const newDate = new Date(e.target.value);
                if (!isNaN(newDate)) {
                    this.state.currentDate = newDate;
                    this.state.currentDate.setHours(0,0,0,0);
                    this.loadDataForDate(this.state.currentDate);
                }
            };

            // 폼 데이터 변경 감지 (자동 저장)
            this.ui.form.onchange = (e) => {
                this.saveCurrentData();
                if (e.target.classList.contains('price-input')) {
                    this.formatPriceInput(e.target);
                }
            };
            
            this.ui.form.oninput = (e) => {
                if (e.target.classList.contains('auto-resize')) {
                    this.autoResize(e.target);
                }
            };

            // 행 추가
            document.getElementById('s3-addRow').onclick = () => this.addNewRow();
            
            // 초기화
            document.getElementById('s3-clearForm').onclick = () => {
                if(confirm("현재 보고 있는 날짜의 정비일지를 초기화하시겠습니까?")) {
                    const dateKey = DataManager.getTodayDateString(this.state.currentDate);
                    DataManager.updateS3Data(s3_data => {
                        delete s3_data[dateKey];
                    });
                    this.loadDataForDate(this.state.currentDate);
                }
            };

            // 백업 및 복구
            document.getElementById('s3-backupFile').onclick = () => this.backupData();
            document.getElementById('s3-triggerRestore').onclick = () => this.ui.restoreFile.click();
            this.ui.restoreFile.onchange = (e) => this.restoreData(e.target.files[0]);

            // 계산기 모달
            document.getElementById('s3-showCalculator').onclick = () => {
                this.ui.calculatorModal.style.display = 'block';
                // 이번 달 1일 ~ 오늘 로 기본 설정
                const today = new Date();
                const y = today.getFullYear();
                const m = today.getMonth();
                const firstDay = new Date(y, m, 1);
                this.ui.calcStartDate.value = DataManager.getTodayDateString(firstDay);
                this.ui.calcEndDate.value = DataManager.getTodayDateString(today);
            };
            document.getElementById('s3-closeCalculator').onclick = () => {
                this.ui.calculatorModal.style.display = 'none';
            };
            document.getElementById('s3-calculatePrices').onclick = () => this.calculatePeriodPrice();

            // 인쇄 및 스타일 설정
            document.getElementById('s3-printPage').onclick = () => this.printPage();
            this.ui.marginLeftSelect.onchange = (e) => {
                document.documentElement.style.setProperty('--s3-print-margin-left', e.target.value + 'mm');
            };
            this.ui.marginRightSelect.onchange = (e) => {
                document.documentElement.style.setProperty('--s3-print-margin-right', e.target.value + 'mm');
            };
            this.ui.fontSizeInput.onchange = (e) => {
                document.documentElement.style.setProperty('--s3-font-size-base', e.target.value + 'pt');
                document.documentElement.style.setProperty('--s3-print-font-size', e.target.value + 'pt');
            };
            
            // 모달 외부 클릭 닫기
            window.onclick = (event) => {
                if (event.target == this.ui.calculatorModal) {
                    this.ui.calculatorModal.style.display = "none";
                }
            };
        },

        navigateDate(days) {
            this.state.currentDate.setDate(this.state.currentDate.getDate() + days);
            this.loadDataForDate(this.state.currentDate);
        },

        loadDataForDate(date) {
            const dateString = DataManager.getTodayDateString(date);
            const displayString = `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일 (${S1_Module.getDayName(date.getDay())})`;
            
            this.ui.dateDisplay.textContent = displayString;
            this.ui.datePicker.value = dateString;

            const s3_data = DataManager.loadS3Data();
            const dayData = s3_data[dateString] || {};
            
            // 기존 행 초기화 (기본 틀 유지 또는 재생성)
            // HTML에 기본적으로 있는 entry-row들을 찾아서 값을 채우거나, 데이터에 맞춰 행을 늘림
            
            // 1. 현재 테이블의 모든 entry-row 제거
            const existingRows = this.ui.tbody.querySelectorAll('.entry-row');
            existingRows.forEach(row => row.remove());

            // 2. 저장된 데이터가 있으면 그만큼 행 생성, 없으면 기본 8행(또는 적절한 수) 생성
            const savedIndices = Object.keys(dayData).map(k => {
                const parts = k.split('_'); // item_RowIndex
                return parseInt(parts[1]) || 0;
            }).filter(i => i > 0);
            
            const maxRowIndex = savedIndices.length > 0 ? Math.max(...savedIndices) : 8; // 최소 8줄
            this.state.rowCount = 0;

            for (let i = 1; i <= maxRowIndex; i++) {
                this.createRow(i, dayData);
            }
            
            // auto-resize 적용
            this.ui.tbody.querySelectorAll('textarea').forEach(el => this.autoResize(el));
        },

        createRow(index, dayData) {
            this.state.rowCount = Math.max(this.state.rowCount, index);
            
            const tr = document.createElement('tr');
            tr.className = 'entry-row';
            if (index > 8) tr.classList.add('s3_added-row'); // 추가된 행 구분
            
            // 데이터 추출 helper
            const getVal = (field) => (dayData[`${field}_${index}`] || '');
            
            // 노선/차량 값
            const routeVal = getVal('route');
            const vehicleVal = getVal('vehicle'); // 실제로는 car number string
            
            // 노선 select HTML 생성
            const routeSelectHTML = `<select class="header-select s3_routeSelect_row no-print" name="route_${index}" onchange="S3_Module.handleRouteChange(this)"></select>`;
            // 차량 select HTML 생성 (초기엔 숨김)
            const vehicleSelectHTML = `<select class="header-select s3_vehicleSelect_row no-print" name="vehicle_${index}" style="display:none;" onchange="S3_Module.handleVehicleChange(this)"></select>`;
            
            // 인쇄용 display
            const displayVal = (routeVal && vehicleVal) ? `[${routeVal}] ${vehicleVal}` : '';
            
            tr.innerHTML = `
                <td class="route-select-cell">
                    ${routeSelectHTML}
                    ${vehicleSelectHTML}
                    <div class="vehicle-display">${displayVal}</div>
                </td>
                <td><textarea name="item_${index}" class="auto-resize">${getVal('item')}</textarea></td>
                <td><textarea name="detail_${index}" class="auto-resize">${getVal('detail')}</textarea></td>
                <td><textarea name="parts_${index}" class="auto-resize">${getVal('parts')}</textarea></td>
                <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_${index}" class="price-input" value="${getVal('price')}"/></div></td>
                <td><textarea name="worker_${index}" class="auto-resize">${getVal('worker')}</textarea></td>
            `;
            
            this.ui.tbody.appendChild(tr);

            // Select 박스 초기화
            const routeSelect = tr.querySelector(`.s3_routeSelect_row`);
            const vehicleSelect = tr.querySelector(`.s3_vehicleSelect_row`);
            
            this.populateRouteSelect(routeSelect, routeVal);
            if (routeVal) {
                this.populateVehicleSelect(vehicleSelect, routeVal, vehicleVal);
                vehicleSelect.style.display = 'block';
            }
        },

        addNewRow() {
            this.state.rowCount++;
            this.createRow(this.state.rowCount, {});
        },

        updateAllRouteSelects() {
            // 현재 화면에 있는 모든 select 갱신
            const selects = document.querySelectorAll('.s3_routeSelect_row');
            selects.forEach(sel => {
                const currentVal = sel.value;
                this.populateRouteSelect(sel, currentVal);
            });
        },

        populateRouteSelect(selectElement, selectedValue) {
            const routes = DataManager.getAllRoutes();
            selectElement.innerHTML = '<option value="">노선선택</option>';
            Object.keys(routes).forEach(rName => {
                const opt = document.createElement('option');
                opt.value = rName;
                opt.textContent = rName;
                if (rName === selectedValue) opt.selected = true;
                selectElement.appendChild(opt);
            });
        },

        handleRouteChange(selectElement) {
            const routeName = selectElement.value;
            const vehicleSelect = selectElement.nextElementSibling; // vehicle select
            const displayDiv = vehicleSelect.nextElementSibling;
            
            if (routeName) {
                this.populateVehicleSelect(vehicleSelect, routeName, null);
                vehicleSelect.style.display = 'block';
                displayDiv.textContent = `[${routeName}]`;
            } else {
                vehicleSelect.style.display = 'none';
                vehicleSelect.innerHTML = '';
                displayDiv.textContent = '';
            }
            this.saveCurrentData();
        },
        
        populateVehicleSelect(selectElement, routeName, selectedValue) {
            const routeData = DataManager.getAllRoutes()[routeName];
            selectElement.innerHTML = '<option value="">차량선택</option>';
            if (routeData && routeData.vehicleColumns) {
                // S1 설정에서 가져온 차량 리스트 + 정렬
                let cars = routeData.vehicleColumns.filter(c => c && c !== '미입력' && !isNaN(c));
                const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
                cars.sort(collator.compare);
                
                cars.forEach(car => {
                    const opt = document.createElement('option');
                    opt.value = car;
                    opt.textContent = car;
                    if (car === selectedValue) opt.selected = true;
                    selectElement.appendChild(opt);
                });
            }
        },

        handleVehicleChange(selectElement) {
            const vehicleVal = selectElement.value;
            const routeSelect = selectElement.previousElementSibling;
            const displayDiv = selectElement.nextElementSibling;
            
            if (routeSelect.value && vehicleVal) {
                displayDiv.textContent = `[${routeSelect.value}] ${vehicleVal}`;
            }
            this.saveCurrentData();
        },

        saveCurrentData() {
            const dateKey = DataManager.getTodayDateString(this.state.currentDate);
            const formData = {};
            
            // 모든 입력 필드 순회
            this.ui.tbody.querySelectorAll('input, textarea, select').forEach(el => {
                if (el.name) {
                    // route_1, item_1 등으로 저장
                    formData[el.name] = el.value;
                }
            });

            DataManager.updateS3Data(s3_data => {
                s3_data[dateKey] = formData;
            });
        },

        autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        },

        formatPriceInput(input) {
            let val = input.value.replace(/[^0-9]/g, '');
            if (val) {
                val = parseInt(val).toLocaleString();
            }
            input.value = val;
        },

        calculatePeriodPrice() {
            const startStr = this.ui.calcStartDate.value;
            const endStr = this.ui.calcEndDate.value;
            
            if (!startStr || !endStr) {
                alert("시작일과 종료일을 모두 선택해주세요.");
                return;
            }
            
            const startDate = new Date(startStr);
            const endDate = new Date(endStr);
            
            if (startDate > endDate) {
                alert("시작일이 종료일보다 늦을 수 없습니다.");
                return;
            }

            const s3_data = DataManager.loadS3Data();
            let totalPrice = 0;
            let detailHTML = `
                <html>
                <head>
                    <title>부품 상세 내역</title>
                    <style>
                        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                        th { background-color: #f2f2f2; }
                        .r { text-align: right; }
                        h2 { text-align: center; color: #0056b3; }
                        .period { text-align: center; margin-bottom: 20px; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h2>정비 부품 상세 내역</h2>
                    <div class="period">기간: ${startStr} ~ ${endStr}</div>
                    <table>
                        <thead>
                            <tr>
                                <th>날짜</th>
                                <th>노선/차량</th>
                                <th>항목</th>
                                <th>정비내역</th>
                                <th>부품내역</th>
                                <th>부품가격</th>
                                <th>작업자</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dKey = DataManager.getTodayDateString(d);
                const dayData = s3_data[dKey];
                if (dayData) {
                    // 인덱스 추출 및 정렬
                    const indices = Object.keys(dayData)
                        .filter(k => k.startsWith('item_'))
                        .map(k => parseInt(k.split('_')[1]))
                        .sort((a,b) => a-b);
                    
                    const uniqueIndices = [...new Set(indices)];

                    uniqueIndices.forEach(idx => {
                        const priceStr = dayData[`price_${idx}`] || '';
                        const priceVal = parseInt(priceStr.replace(/,/g, '')) || 0;
                        const item = dayData[`item_${idx}`] || '';
                        const detail = dayData[`detail_${idx}`] || '';
                        const parts = dayData[`parts_${idx}`] || '';
                        
                        // 내용이 있거나 가격이 있는 경우만 집계
                        if (item || detail || parts || priceVal > 0) {
                            totalPrice += priceVal;
                            
                            const route = dayData[`route_${idx}`] || '';
                            const vehicle = dayData[`vehicle_${idx}`] || '';
                            const vehicleDisp = (route && vehicle) ? `[${route}] ${vehicle}` : '';
                            
                            detailHTML += `
                                <tr>
                                    <td>${dKey}</td>
                                    <td>${vehicleDisp}</td>
                                    <td>${item}</td>
                                    <td>${detail}</td>
                                    <td>${parts}</td>
                                    <td class="r">${priceVal.toLocaleString()}</td>
                                    <td>${dayData[`worker_${idx}`] || ''}</td>
                                </tr>
                            `;
                        }
                    });
                }
            }

            detailHTML += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="5" style="text-align: right;">총 합계</th>
                                <th class="r" style="color: red; font-size: 1.2em;">${totalPrice.toLocaleString()}</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </body>
                </html>
            `;

            this.ui.calcTotal.textContent = totalPrice.toLocaleString() + "원";
            
            // 상세 내역 팝업
            const popup = window.open('', '_blank', 'width=900,height=600');
            popup.document.write(detailHTML);
            popup.document.close();
        },

        backupData() {
            const data = DataManager.data.s3;
            const jsonString = JSON.stringify(data);
            const now = new Date();
            const dateString = DataManager.getTodayDateString(now).replace(/-/g,'');
            const filename = `정비일지(S3)_백업_${dateString}.json`;
            
            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            alert("정비일지 데이터가 백업되었습니다.");
        },

        restoreData(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loaded = JSON.parse(e.target.result);
                    DataManager.updateS3Data(s3_data => {
                        // 전체 덮어쓰기
                        Object.keys(s3_data).forEach(k => delete s3_data[k]);
                        Object.assign(s3_data, loaded);
                    });
                    this.loadDataForDate(this.state.currentDate);
                    alert("정비일지가 복구되었습니다.");
                } catch(err) {
                    alert("파일 형식이 올바르지 않습니다.");
                    console.error(err);
                }
                this.ui.restoreFile.value = '';
            };
            reader.readAsText(file);
        },

        printPage() {
            document.body.classList.remove('printing-section1', 'printing-section2');
            document.body.classList.add('printing-section3');
            
            // 인쇄 전 textarea 높이 재조정 (확실하게 하기 위함)
            this.ui.tbody.querySelectorAll('textarea').forEach(el => this.autoResize(el));
            
            const handleAfterPrint = () => {
                document.body.classList.remove('printing-section3');
                window.removeEventListener('afterprint', handleAfterPrint);
            };
            window.addEventListener('afterprint', handleAfterPrint);
            window.print();
        }
    };

    /* ================================================================= */
    /* [공통] 초기화 로직 */
    /* ================================================================= */

    document.addEventListener('DOMContentLoaded', () => {
        S1_Module.initialize();
        S2_Module.initialize();
        S3_Module.initialize();

        // 탭 전환 등 초기 UI 상태 설정
        // 기본적으로 S1을 보여줌
        S1_Module.showSection('S1');
        S1_Module.setVersion();
    });

</script>
</body>
</html>