<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통합 근무 관리 시스템 (현황표 + 승무일지 + 정비일지)</title>
    
    <style>
        /* ================================================================= */
        /* [공통] Global Styles */
        /* ================================================================= */
        :root {
            /* S3 폰트 크기 변수 */
            --s3-font-size-base: 14pt; 
            --s3-print-font-size: 11pt;
            
            /* S3 인쇄 여백 CSS 변수 */
            --s3-print-margin-top: 10mm;
            --s3-print-margin-bottom: 10mm;
            --s3-print-margin-left: 10mm;
            --s3-print-margin-right: 10mm;

            /* S1 폰트 크기 변수 */
            --worker-font-size: 11pt;
            /* S1 인쇄 여백 CSS 변수 */
            --print-margin-left: 10mm;
            --print-margin-right: 10mm;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            background-color: #e9ecef; /* 배경색 변경 */
            color: #333;
            font-size: 14pt;
        }

        /* 상단 버전 헤더바 */
        #header-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 5px 10px;
            background-color: #f8f9fa; /* 컨트롤박스 배경과 비슷하게 */
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 10px; /* #section1과의 간격 */
            border-radius: 8px;
        }
        #header-logo {
            height: 24px; 
            width: auto;
            margin-right: 8px;
        }
        #version-display {
            font-size: 10pt;
            font-weight: bold;
            color: #555;
        }

        .divider {
            margin: 40px 0;
            border: 2px solid #0056b3;
        }


        /* ================================================================= */
        /* [Section 1] 근무 현황표 Styles */
        /* ================================================================= */
        
        #section1 .controls {
            background-color: #fff;
            padding: 15px; border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            align-items: stretch; 
        }

        #section1 .controls fieldset {
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 10px 15px;
            margin: 0;
            background: linear-gradient(145deg, #ffffff, #f0f0f5);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 300px; 
            display: flex;
            flex-direction: column;
            gap: 10px; 
            transition: transform 0.2s;
        }
        
        #section1 .controls fieldset:hover {
             box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
             transform: translateY(-2px);
        }

        #section1 .controls fieldset legend {
            font-weight: bold;
            font-size: 1.2em;
            color: #0056b3;
            padding: 2px 10px;
            border-radius: 4px;
            background-color: #eaf4ff;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        #section1 .controls .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
        }
        #section1 .controls label { font-weight: bold;
            margin-right: 5px; white-space: nowrap; }
        #section1 .controls input[type="text"],
        #section1 .controls input[type="number"], 
        #section1 .controls select {
            padding: 6px;
            border: 1px solid #a8c8e1; 
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        #section1 .controls input[type="number"] { width: 70px;
        }
        
        #section1 .controls input#companyInput {
            flex: 1 1 auto;
            min-width: 150px;
        }
        #section1 .controls select#typeSelect {
            flex: 1 1 auto;
            min-width: 150px;
        }
        
        #section1 .controls select { flex-grow: 1;
            min-width: 120px; }

        #section1 #vehicleInputsContainer {
            display: flex;
            flex-wrap: wrap; 
            gap: 5px;
            width: 100%;
            margin-top: 5px;
            padding: 5px;
            background: #e9f0f6; 
            border-radius: 4px;
            border: 1px solid #cfe2f3;
            max-height: 180px;
            overflow-y: auto;
        }
        #section1 #vehicleInputsContainer input {
            width: 80px;
            font-size: 0.9em;
            padding: 4px;
        }

        #section1 .controls select.margin-select {
            width: 35px;
            min-width: 35px;
            padding: 1px 3px;
            font-size: 0.85em; 
            flex-grow: 0;
        }
        
        #section1 .controls button,
        #section1 .controls select.action-select,
        #section1 .controls select.work-type-select,
        #section1 .controls select.vehicle-select {
            padding: 8px 15px;
            color: white; border: none; border-radius: 4px;
            cursor: pointer; font-size: 17.5px;
            text-decoration: none; display: inline-block;
            text-align: center; white-space: nowrap;
            width: auto;
            flex-grow: 0; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        
        #section1 .controls button { background-color: #007bff;
        }
        #section1 .controls button:hover { background-color: #0056b3;
        }
        #section1 .controls button.btn-danger { background-color: #dc3545;
        }
        #section1 .controls button.btn-danger:hover { background-color: #c82333;
        }
        
        #section1 .controls select.action-select { background-color: #28a745;
        }
        #section1 .controls select.work-type-select { background-color: #ffc107; color: #333;
        }
        #section1 .controls select.vehicle-select { background-color: #6c757d;
        }
        
        #section1 .controls select.route-navigate-select {
            padding: 8px 15px;
            font-size: 17.5px;
            background-color: #17a2b8; 
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            flex-grow: 1;
        }

        #section1 .holiday-option-group {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 5px;
            align-items: center;
            border: 1px solid #b3e5fc;
        }
        #section1 .holiday-option-group select {
            padding: 4px;
            font-size: 0.9em;
            flex-grow: 0; 
            width: 100px;
        }

        #section1 #scheduleContainer {
            background-color: white;
            padding: 10px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 90%;
            overflow-x: auto;
            border-radius: 8px;
            box-sizing: border-box; 
        }
        
        #section1 table {
            width: 100%;
            min-width: 100%; 
            border-collapse: collapse;
            margin: 0 auto; font-size: 0.9em; background-color: #fff; table-layout: fixed;
        }
        #section1 th, #section1 td {
            border: 1px solid #ddd;
            padding: 5px; 
            text-align: center;
            vertical-align: middle; 
            line-height: 1.2; 
            word-break: keep-all;
            height: 38px; box-sizing: border-box;
            font-size: 13pt;
        }
        #section1 th { background-color: #f2f2f2; font-weight: bold;
        }
        #section1 caption {
            font-size: 1.5em;
            margin-bottom: 10px; font-weight: bold;
            color: #333; text-decoration: underline;
        }
        
        #section1 .sunday { background-color: initial !important;
        }
        #section1 .saturday { background-color: initial !important;
        }
        #section1 .holiday { 
            background-color: initial !important;
            font-weight: bold; 
            color: #cc0000;
        }
        
        #section1 .holiday td:not(:nth-child(1)):not(:nth-child(2)) {
            color: #333;
            font-weight: normal;
        }
        
        #section1 .sub-day-info {
            display: block;
            font-size: 0.5em; 
            line-height: 1.2;
            font-weight: bold;
            color: inherit; 
        }
        
        #section1 .day-cell-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1em;
        }
        
        #section1 .day-name-main {
            font-weight: bold;
            font-size: 1.2em; 
            line-height: 1.2;
        }
        
        #section1 .edit-mode {
            position: relative;
            padding: 2px; display: flex; flex-direction: column;
            justify-content: center; height: 100%;
            vertical-align: middle;
        }
        #section1 .edit-mode input {
            width: calc(100% - 8px);
            margin-bottom: 2px;
            padding: 2px; box-sizing: border-box;
        }
        #section1 .edit-mode .cell-buttons { display: flex;
            justify-content: space-around; margin-top: 2px; }
            
        #section1 .edit-mode .cell-buttons button {
            padding: 3px 5px;
            font-size: 0.7em; 
            color: white; 
            border: none;
            border-radius: 3px; 
            cursor: pointer; 
            white-space: nowrap;
            transition: background-color: 0.15s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            flex-grow: 1; 
            margin: 0 1px;
        }
        
        #section1 .edit-mode .cell-buttons button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        #section1 .edit-mode .cell-buttons .btn-fixed { background-color: #007bff;
        }
        #section1 .edit-mode .cell-buttons .btn-fixed:hover:not(:disabled) { background-color: #0056b3;
        }
        #section1 .edit-mode .cell-buttons .btn-temp { background-color: #28a745;
        }
        #section1 .edit-mode .cell-buttons .btn-temp:hover { background-color: #1e7e34;
        }
        #section1 .edit-mode .cell-buttons .btn-highlight-am { background-color: #6f42c1;
        }
        #section1 .edit-mode .cell-buttons .btn-highlight-am:hover { background-color: #5a349c;
        }
        #section1 .edit-mode .cell-buttons .btn-highlight-pm { background-color: #fd7e14;
        }
        #section1 .edit-mode .cell-buttons .btn-highlight-pm:hover { background-color: #db6a0b;
        }
        #section1 .edit-mode .cell-buttons .btn-delete { background-color: #dc3545;
        }
        #section1 .edit-mode .cell-buttons .btn-delete:hover { background-color: #c82333;
        }


        #section1 .name-entry { 
            display: block;
            margin-top: 2px; 
            margin-bottom: 2px; 
            color: inherit; 
            font-size: var(--worker-font-size); 
        }
        #section1 .hidden-x { color: white;
        }
        #section1 .name-entry.bold-name {
            font-weight: bold;
        }
        #section1 table th:nth-child(1),
        #section1 table td:nth-child(1),
        #section1 table th:nth-child(2),
        #section1 table td:nth-child(2) {
            width: 4%;
            min-width: 60px;
            vertical-align: middle; 
        }

        /* [Section 1] 컨트롤 박스 UI 개선 */
        #section1 .controls input[type="number"] {
            padding: 8px; 
            font-size: 1em;
        }
        #section1 .controls input#yearInput {
            width: 90px;
        }
        #section1 .controls fieldset:nth-of-type(1) .control-group:nth-of-type(3) button {
            flex: 1 1 auto; 
        }
        #section1 .controls fieldset:nth-of-type(3) .control-group {
            flex-direction: column;
            align-items: stretch;
        }
        #section1 .controls fieldset:nth-of-type(3) .control-group > * {
            margin-bottom: 5px;
        }
        #section1 .controls fieldset:nth-of-type(3) .control-group > *:last-child {
            margin-bottom: 0;
        }
        #section1 .controls fieldset:nth-of-type(3) .control-group:nth-of-type(2) {
            flex-direction: row; 
            align-items: center;
            gap: 10px; 
        }
        #section1 .controls fieldset:nth-of-type(3) .control-group:nth-of-type(2) > select {
            flex: 1 1 auto; 
            margin-bottom: 0; 
        }
        #section1 .controls fieldset:nth-of-type(4) .control-group:not(:first-of-type) {
             flex-direction: column;
            align-items: stretch;
        }
        #section1 .controls fieldset:nth-of-type(4) .control-group:not(:first-of-type) > * {
            margin-bottom: 5px;
        }
        #section1 .controls .control-group[style*="border-top"] {
            flex-direction: row; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        #section1 .controls .control-group[style*="border-top"] > div[style*="flex-direction: row"] {
            flex-direction: row !important; 
            align-items: center !important; 
            gap: 10px !important; 
            margin-left: 10px !important; 
            flex-wrap: wrap; 
        }
        #section1 .controls select.margin-select {
            width: 60px; 
            min-width: 60px;
            padding: 4px; 
            font-size: 0.95em; 
        }

        @media screen and (max-width: 1400px) {
            #section1 .controls {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        @media screen and (max-width: 768px) {
            
            #section1 #scheduleContainer {
                max-width: 100%;
                margin: 10px 0; 
            }
            
            #section1 .controls {
                grid-template-columns: 1fr;
            }
            #section1 .controls .control-group { 
                flex-direction: column; 
                align-items: stretch;
            }
            #section1 .controls input[type="text"], 
            #section1 .controls input[type="number"], 
            #section1 .controls select,
            #section1 .controls input#companyInput, 
            #section1 .controls select#typeSelect { 
                width: 100%;
                flex-basis: auto;
            }
            
            #section1 table { 
                min-width: 100%;
                font-size: 0.8em; 
            }
            #section1 th, #section1 td {
                padding: 3px;
                height: 30px;
                font-size: 10pt; 
            }
            #section1 .day-name-main { font-size: 1.0em; }
            #section1 .name-entry { font-size: 9pt; }
        }
        /* ================================================================= */
        /* [Section 2] 승무 일지 Styles */
        /* ================================================================= */

        #section2 {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px; 
            color: #333;
            font-size: 9pt; 
        }

        #section2 .journal-container {
            background-color: white;
            padding: 15px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            max-width: 90%;
            margin: 10px auto;
            overflow-x: auto;
            box-sizing: border-box;
        }

        #section2 .header-title {
            text-align: center;
            font-size: 1.88em; 
            font-weight: bold;
            color: #0056b3;
            padding-bottom: 4px;
            margin-bottom: 4px;
            border-bottom: 2px solid #0056b3;
        }

        #section2 .title-area {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            margin: 8px 0 10px 0;
            padding: 0 5px; 
        }

        #section2 .title-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        #section2 .main-title {
            font-size: 1.44em; 
            font-weight: bold;
            color: #333;
            display: inline-block;
        }
        
        #section2 .date-display {
            font-size: 1em; 
            color: #666;
            margin-top: 2px;
        }
        
        #section2 .options-right {
            display: flex;
            align-items: center;
            gap: 10px; 
        }
        
        #section2 .font-selector-container {
            font-size: 0.94em; 
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        #section2 .font-selector-container label {
            margin-right: 3px;
            font-weight: normal;
        }
        
        #section2 #font-size-select {
            padding: 1px 3px;
            font-size: 1em;
            height: 20px;
        }
        
        #section2 .dispatch-buttons-container {
            display: flex;
            align-items: center;
            font-size: 0.94em; 
            border: 1px solid #ced4da;
            border-radius: 3px;
            padding: 2px;
        }

        #section2 .dispatch-buttons-container label {
            margin: 0 8px;
            font-weight: normal;
            color: #333;
        }

        #section2 .dispatch-button {
            padding: 3px 6px;
            margin-left: -1px; 
            font-size: 1em; 
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ced4da;
            border-radius: 0;
            cursor: pointer;
            transition: background-color: 0.1s;
        }

        #section2 .dispatch-button:first-of-type {
            border-top-left-radius: 2px;
            border-bottom-left-radius: 2px;
            margin-left: 0;
        }
        #section2 .dispatch-button:last-of-type {
            border-top-right-radius: 2px;
            border-bottom-right-radius: 2px;
        }

        #section2 .dispatch-button:hover {
            background-color: #e2e6ea;
        }

        #section2 .dispatch-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            z-index: 1; 
        }

        #section2 .print-button {
            padding: 4px 10px; 
            font-size: 0.94em;
            font-weight: bold;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        #section2 .print-button:hover {
            background-color: #0056b3;
        }
        
        #section2 .date-header {
            display: none;
        }

        #section2 .route-section {
            margin-bottom: 15px; 
            border: 1px solid #ced4da;
            border-radius: 4px;
            overflow: hidden;
        }
        
        #section2 .route-header-flex {
            display: flex;
            justify-content: space-between; 
            align-items: flex-start; 
            background-color: #e6f7ff;
            padding: 5px 8px;
            border-bottom: 1px solid #ced4da;
        }
        
        #section2 .route-title-group {
            display: flex;
            align-items: center;
        }

        #section2 .route-name-text {
            font-size: 1.22em; 
            font-weight: bold;
            color: #0056b3;
            white-space: nowrap; 
            padding-right: 15px; 
        }
        
        #section2 .load-button-container {
            display: flex;
            align-items: center;
        }
        #section2 .load-button {
            background-color: #38b43d; 
            color: white;
            border: none;
            padding: 3px 8px;
            margin-left: 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.88em;
            white-space: nowrap;
        }
        #section2 .load-button:hover {
            background-color: #2e8b34;
        }

        #section2 .schedule-options {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
        }

        #section2 .schedule-options select {
            font-size: 1em;
            height: 20px;
            padding: 0 2px;
            margin: 2px 0;
            box-sizing: border-box;
            vertical-align: middle;
        }

        #section2 .schedule-options input[type="number"] {
            width: 30px; 
            height: 18px; 
            text-align: center;
            font-size: 0.9em;
            padding: 0;
            margin: 0 1px;
            border: 1px solid #ccc;
        }

        #section2 .am-options, #section2 .pm-options {
            border: 1px solid #ddd;
            padding: 3px 5px;
            background-color: #f7f9fb;
            border-radius: 3px;
        }

        #section2 .am-options span, #section2 .pm-options span {
            font-weight: bold;
        }
        
        #section2 .settings-controls {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding-top: 5px; 
        }

        #section2 .setting-button {
            padding: 3px 5px;
            font-size: 0.88em;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 3px;
            white-space: nowrap;
            transition: background-color: 0.1s;
        }

        #section2 .apply-button {
            background-color: #d4edda; 
            border-color: #c3e6cb;
        }

        #section2 .apply-button:hover {
            background-color: #c3e6cb;
        }

        #section2 .reset-button {
            background-color: #f8d7da; 
            border-color: #f5c6cb;
        }

        #section2 .reset-button:hover {
            background-color: #f5c6cb;
        }
        
        #section2 table { 
            width: 100%; 
            border-collapse: collapse;
            table-layout: fixed; 
            font-size: 0.88em; 
            background-color: #fff;
        }

        #section2 th, #section2 td { 
            border: 1px solid #ddd;
            padding: 2px 1px; 
            text-align: center;
            vertical-align: middle;
            height: 20px; 
            box-sizing: border-box;
            line-height: 1.1;
            position: relative;
        }

        #section2 th {
            background-color: #e9ecef;
            font-weight: bold;
            color: #333;
        }
        
        #section2 .car-number-cell {
            font-weight: bold;
            font-size: 1.136em; 
            cursor: pointer;
            padding: 0;
        }

        #section2 .car-display {
            padding: 2px 1px;
            height: 100%;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #section2 .car-controls {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #fff;
            padding: 1px;
            box-sizing: border-box;
            gap: 1px;
            z-index: 10;
            border: 2px solid #ffc107; 
        }

        #section2 .car-controls select {
            width: 95%;
            font-size: 0.8em;
            padding: 0;
            margin: 0;
            height: 14px;
        }

        #section2 .car-controls button {
            width: 48%;
            font-size: 0.7em;
            padding: 0;
            margin: 0;
            height: 14px;
            line-height: 1;
            box-sizing: border-box;
            border: 1px solid #ccc;
            cursor: pointer;
            background-color: #f0f0f0;
        }

        #section2 .car-controls div {
            display: flex;
            justify-content: space-between;
            width: 95%;
            margin-top: 1px;
        }
        
        #section2 .journal-table th:nth-child(1),
        #section2 .journal-table th:nth-child(9) {
            font-size: 1.136em; 
        }
        
        #section2 input[type="number"], #section2 input[type="text"] {
            font-size: 1em; 
            padding: 0;
            margin: 0;
            width: 100%;
            height: 18px; 
            box-sizing: border-box;
            border: 1px solid #ccc;
            text-align: center;
            -moz-appearance: textfield;
        }
        
        #section2 .journal-table colgroup col:nth-child(1), #section2 .journal-table colgroup col:nth-child(9) { width: 5.4%; } 
        #section2 .journal-table colgroup col:nth-child(8), #section2 .journal-table colgroup col:nth-child(16) { width: 5.4%; } 
        #section2 .journal-table colgroup col:nth-child(2), #section2 .journal-table colgroup col:nth-child(3), #section2 .journal-table colgroup col:nth-child(4), 
        #section2 .journal-table colgroup col:nth-child(5), #section2 .journal-table colgroup col:nth-child(6), #section2 .journal-table colgroup col:nth-child(7), 
        #section2 .journal-table colgroup col:nth-child(10), #section2 .journal-table colgroup col:nth-child(11), #section2 .journal-table colgroup col:nth-child(12),
        #section2 .journal-table colgroup col:nth-child(13), #section2 .journal-table colgroup col:nth-child(14), #section2 .journal-table colgroup col:nth-child(15) { width: 5.4%; }
        
        #section2 .driver-name {
            box-sizing: border-box;
            width: 100%;
            padding: 0;
            margin: 0;
            border: none;
            background: transparent;
            text-align: center;
            line-height: 1.1em; 
            min-height: 18px; 
            cursor: pointer;
            display: block;
        }
        
        #section2 .driver-input {
            resize: none; 
            height: 18px; 
            overflow: hidden;
            border: 1px solid #007bff; 
            background-color: #fff !important;
            font-size: 1em;
            box-sizing: border-box;
            width: 100%;
            padding: 0;
            margin: 0;
            text-align: center;
        }

        #section2 .edit-controls {
            display: flex;
            justify-content: center;
            gap: 2px;
            padding: 1px 0;
            margin-top: -1px; 
        }
        
        #section2 .edit-controls button {
            flex-grow: 1;
            padding: 0;
            margin: 0;
            font-size: 0.8em;
            height: 18px;
            line-height: 1;
            cursor: pointer;
            border-radius: 2px;
            border: 1px solid #ccc;
        }
        
        #section2 .edit-controls button:first-child { background-color: #f44336; color: white; border-color: #d32f2f; }
        #section2 .edit-controls button:last-child { background-color: #4CAF50; color: white; border-color: #388e3c; }

        #section2 .hidden {
            display: none !important;
        }
        
        @media screen and (max-width: 768px) {
            #section2 .journal-container {
                max-width: 100%;
                margin: 10px 0; 
                padding: 5px; 
            }
            #section2 {
                font-size: 8pt; 
            }
            #section2 .options-right {
                gap: 5px;
                flex-wrap: wrap; 
                justify-content: flex-end;
            }
            #section2 .print-button {
                padding: 3px 6px;
                font-size: 1em;
            }
            #section2 .dispatch-buttons-container label {
                margin: 0 4px;
            }
            #section2 th, #section2 td {
                height: 30px;
                padding: 2px 0;
            }
            #section2 input[type="number"], #section2 input[type="text"],
            #section2 .s2-work-hours-select,
            #section2 .driver-input,
            #section2 .driver-name {
                height: 16px;
                font-size: 0.95em;
            }
        }

        #section2 .s2-work-hours-select {
            font-size: 1em; 
            padding: 0;
            margin: 0;
            width: 100%;
            height: 18px; 
            box-sizing: border-box;
            border: 1px solid #ccc;
            text-align: center;
            background-color: white; 
            -moz-appearance: none; 
            -webkit-appearance: none; 
            appearance: none;
        }
        
        /* ================================================================= */
        /* [Section 3] 정비일지 Styles */
        /* ================================================================= */
        
        #section3 {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 10px; 
            color: #333;
            font-size: var(--s3-font-size-base); 
        }
        #section3 .maintenance-container {
            max-width: 900px; 
            margin: 18px auto;
            background: #fff;
            padding: 10px;
            border: 1px solid #000;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
        }
        
        #section3 header {
            display: flex;
            flex-wrap: wrap; 
            align-items: center; 
        }
        #section3 header h1 {
            flex-basis: 100%; 
            text-align: center; 
            order: -1; 
            margin-bottom: 10px;
            font-size: 20px;
            margin-top: 6px;
        }
        #section3 .controls {
            flex-basis: 100%; 
            display: flex;
            gap: 8px;
            flex-wrap: wrap; 
            justify-content: flex-end; 
            align-items: center; 
        }
        
        #section3 button {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #fff;
            cursor: pointer;
            font-size: 13pt; 
        }
        #section3 button.primary {
            background: #007bff;
            color: #fff;
            border-color: #007bff;
        }
        #section3 button.success {
            background: #28a745;
            color: #fff;
        }
        #section3 button.warning {
            background: #ffc107;
            color: #333;
        }

        #section3 .margin-control-group {
            display: flex;
            flex-direction: row; 
            align-items: center; 
            gap: 6px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        #section3 .margin-control-group > label {
            font-size: 11pt; 
            font-weight: bold;
            margin-right: 5px;
        }
        #section3 .margin-control {
            display: flex;
            flex-direction: column; 
            align-items: center; 
        }
        #section3 .margin-control label {
            font-size: 9pt; 
            font-weight: bold;
            color: #333;
        }
        #section3 .margin-select {
            width: 45px;
            font-size: 10pt;
            padding: 1px;
            border: 1px solid #aaa;
            border-radius: 3px;
        }
        
        #section3 .form-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            border: 1px solid #000; 
            table-layout: fixed; 
        }
        #section3 .form-table td, #section3 .form-table th {
            border: 1px solid #000; 
            padding: 6px;
            vertical-align: middle;
            font-size: calc(var(--s3-font-size-base) * 0.9);
            height: 28px;
            box-sizing: border-box;
            word-break: break-all; 
        }
        #section3 .form-table thead th {
            text-align: center;
            border-top-width: 1px; 
        }
        
        #section3 .route-col { width: 15%; } /* 노선/차량 */
        #section3 .item-col { width: 20%; } /* 항목 */
        #section3 .detail-col { width: 25%; } /* 정비내역 */
        #section3 .parts-col { width: 15%; } /* 부품내역 */
        #section3 .price-col { width: 10%; } /* 부품가격 */
        #section3 .worker-col { width: 15%; } /* 작업자 */
        #section3 .date-col { width: 150px; }
        
        
        #section3 .route-select-cell {
            vertical-align: top !important; 
            padding: 4px !important;
        }
        #section3 .header-select {
            font-size: 11px; 
            padding: 2px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 3px;
        }
        #section3 .vehicle-display {
            font-weight: bold;
            font-size: 12px;
            color: #0056b3;
            margin-top: 4px;
            height: 1.2em; 
        }
        
        #section3 input[type=text], #section3 input[type=number], #section3 textarea, #section3 select {
            width: 100%;
            box-sizing: border-box;
            border: none;
            outline: none;
            font-size: 11pt; 
            color: #000; 
            background: transparent;
            resize: none;
        }
        #section3 textarea.auto-resize {
            overflow-y: hidden;
            min-height: 28px;
            line-height: 1.4;
        }
        
        /* [수정됨] .price-input 스타일 */
        #section3 .price-input {
            text-align: right;
            width: 100%; 
            padding-right: 20px; /* "원" 글자가 들어갈 공간 확보 */
            box-sizing: border-box; 
        }

        /* [수정됨] 입력칸과 "원" 글자를 감쌀 컨테이너 */
        #section3 .price-wrapper {
            position: relative;
            width: 100%;
        }

        /* [수정됨] "원" 글자를 입력칸 위에 겹치게 하는 스타일 */
        #section3 .price-wrapper::after {
            content: "원";
            position: absolute;
            top: 50%;
            right: 5px; /* 입력칸 안쪽 우측 여백 */
            transform: translateY(-50%);
            color: #555; /* 글자 색상 */
            pointer-events: none; /* "원" 글자가 클릭되는 것을 방지 */
        }

        #section3 .s3_added-row {
            background-color: #f0f8ff; /* AliceBlue */
        }
        
        /* ================================================================= */
        /* [공통] 인쇄 스타일 (S1, S2, S3 통합) */
        /* ================================================================= */
        @media print {
            
            #header-bar {
                display: none !important;
            }

            body > * {
                display: none !important;
            }
            body.printing-section1 #section1 {
                display: block !important;
            }
            body.printing-section1 #section1 .controls {
                display: none !important;
            }
            body.printing-section2 #section2 {
                display: block !important;
            }
            body.printing-section3 #section3 {
                display: block !important;
            }
            
            /* ----- S1 인쇄 규칙 ----- */
            body.printing-section1 @page {
                size: A4;
                margin: 10mm;
                margin-left: var(--print-margin-left, 15mm);
                margin-right: var(--print-margin-right, 5mm);
            }
            body.printing-section1 { background-color: white;
                margin: 0; padding: 0; -webkit-print-color-adjust: exact; }
            
            body.printing-section1 .controls { display: none;
            }
            body.printing-section1 #scheduleContainer { box-shadow: none; margin: 0;
                padding: 0; }
            body.printing-section1 #section1 caption {
                font-size: 1.0em; 
                margin-bottom: 5px; 
            }
            body.printing-section1 #section1 table { 
                width: 100%;
                min-width: unset; 
                font-size: 0.8em; 
                border: 1px solid #000; 
                table-layout: fixed;
                page-break-inside: auto;
            }
            body.printing-section1 #section1 tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            body.printing-section1 #section1 th, 
            body.printing-section1 #section1 td { padding: 1px;
                height: auto; word-break: break-all; vertical-align: top; border: 1px solid #000;
            }
            
            body.printing-section1 #section1 table th:nth-child(1), 
            body.printing-section1 #section1 table td:nth-child(1),
            body.printing-section1 #section1 table th:nth-child(2), 
            body.printing-section1 #section1 table td:nth-child(2) { 
                width: 4%;
                vertical-align: middle; 
            }
            
            body.printing-section1 #section1 .sub-day-info { font-size: 0.5em;
            } 
            body.printing-section1 #section1 .day-name-main { font-size: 1em;
            }
            
            body.printing-section1 #section1 .sunday { background-color: initial !important;
            }
            body.printing-section1 #section1 .saturday { background-color: initial !important;
            }
            body.printing-section1 #section1 .holiday { 
                background-color: initial !important;
                font-weight: bold; 
                color: #cc0000; 
            }
            body.printing-section1 #section1 .holiday td:not(:nth-child(1)):not(:nth-child(2)) {
                color: #000;
                font-weight: normal;
            }

            /* ----- S2 인쇄 규칙 ----- */
            body.printing-section2 @page {
                size: A4 landscape;
                margin: 6mm; 
            }
            body.printing-section2 { 
                background-color: white; 
                padding: 0; 
                margin: 0; 
                font-size: 9pt;
                color: #000;
            }
            body.printing-section2 #section2 .journal-container {
                box-shadow: none;
                border-radius: 0;
                padding: 0;
                margin: 0;
                max-width: 100%;
            }
            
            body.printing-section2 #section2 .print-button, 
            body.printing-section2 #section2 .font-selector-container, 
            body.printing-section2 #section2 .dispatch-buttons-container,
            body.printing-section2 #section2 .driver-input, 
            body.printing-section2 #section2 .edit-controls, 
            body.printing-section2 #section2 .schedule-options, 
            body.printing-section2 #section2 .load-button-container,
            body.printing-section2 #section2 .car-controls,
            body.printing-section2 #section2 .settings-controls {
                         display: none !important;
            }
            
            body.printing-section2 #section2 table { 
                font-size: 7pt; 
                border-collapse: collapse !important; 
                border: 1px solid #000 !important; 
            }
            body.printing-section2 #section2 th, 
            body.printing-section2 #section2 td { 
                height: 16px;
                padding: 1px 0px; 
                border: 1px solid #000 !important; 
            }
            
            body.printing-section2 #section2 .header-title, 
            body.printing-section2 #section2 .main-title, 
            body.printing-section2 #section2 .route-name-text { color: #000 !important;
            }
            
            body.printing-section2 #section2 .route-header-flex { background-color: #eee !important;
                border-bottom: 1px solid #000 !important; }
            
            body.printing-section2 #section2 input[type="number"], 
            body.printing-section2 #section2 input[type="text"] {
                border: none;
                background: transparent;
                padding: 0;
                height: auto;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            
            body.printing-section2 #section2 .s2-work-hours-select {
                border: none;
                background: transparent;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                padding: 0; 
                height: auto;
            }

            body.printing-section2 #section2 .driver-name, 
            body.printing-section2 #section2 .car-display {
                display: flex !important;
                justify-content: center;
                align-items: center;
                border: none !important;
                cursor: default;
                height: 100%;
                width: 100%;
            }
            body.printing-section2 #section2 .car-number-cell {
                padding: 2px 1px;
            }

            /* S3 인쇄 규칙 */
            body.printing-section3 #section3 .maintenance-container {
                max-width: 100%;
                border: none;
                box-shadow: none;
                margin: 0;
                padding: 0;
            }
            body.printing-section3 #section3 .form-table {
                font-size: var(--s3-print-font-size);
                border: 2px solid #000 !important; 
            }
            body.printing-section3 #section3 .form-table td, 
            body.printing-section3 #section3 .form-table th {
                border: 1px solid #000 !important;
                padding: 4px !important; 
                height: auto !important; 
                vertical-align: top; 
            }
            body.printing-section3 #section3 input, 
            body.printing-section3 #section3 textarea {
                border: none !important;
                background: transparent !important;
                font-size: calc(var(--s3-print-font-size) * 0.9) !important;
                height: auto !important;
                overflow: visible !important;
                color: #000 !important; 
            }
            
            /* S3 인쇄 시 '원' 글자 숨기기 */
            body.printing-section3 #section3 .price-wrapper::after {
                display: none;
            }
            body.printing-section3 #section3 .price-input {
                padding-right: 0; /* 인쇄 시 여백 제거 */
            }

            body.printing-section3 #section3 .no-print,
            body.printing-section3 #section3 .header-select {
                display: none !important;
            }
            
            body.printing-section3 #section3 .vehicle-display {
                font-size: 11px !important; 
                color: #000 !important; 
                height: auto !important;
                margin-top: 0;
            }
            
            body.printing-section3 @page { 
                size: A4 portrait; 
                margin-top: var(--s3-print-margin-top);
                margin-bottom: var(--s3-print-margin-bottom);
                margin-left: var(--s3-print-margin-left);
                margin-right: var(--s3-print-margin-right);
            }
        }
    </style>
</head>
<body>

    <div id="header-bar">
        <img id="header-logo" src="https://raw.githubusercontent.com/waryong2025/dasomsoftec/main/dasom.png" alt="DasomSoftec">
        <span id="version-display">Ver 4.5.2-fix</span>
    </div>


    <div id="section1">
        <div class="controls">

            <fieldset>
                <legend>회사 / 노선 정보</legend>
                
                <div class="control-group">
                   <label for="companyInput">회사명:</label>
                    <input type="text" id="companyInput" placeholder="예: 와룡운수">
                </div>

                <div class="control-group">
                    <label for="typeSelect">버스 종류 선택:</label>
                       <select id="typeSelect">
                        <option value="마을">마을</option>
                        <option value="버스">버스</option>
                    </select>
                </div>
  
               
                <div class="control-group">
                    <label for="routeInput">노선 번호:</label>
                    <input type="text" id="routeInput" placeholder="예: 종로08">
                    <button id="s1-addOrUpdateRoute">노선 추가/수정</button>
                    <button id="s1-deleteRoute" class="btn-danger">선택 노선 삭제</button>
                </div>
                
                 <div class="control-group">
                    <label for="routeNavigateSelect">관련 노선 이동:</label>
                   <select id="routeNavigateSelect" class="route-navigate-select"></select>
                </div>
    
             </fieldset>

            <fieldset>
                <legend>조회 설정</legend>
                <div class="control-group">
                    <label for="yearInput">년도:</label>
                     <input type="number" id="yearInput" value="2025">
                    <label for="monthInput">월:</label>
                    <input type="number" id="monthInput" value="10">
                    
                    <button id="s1-generateSchedule">생성</button>
                </div>
                 <div class="control-group">
                    <input type="radio" id="option1" name="displayOption" value="1">
                    <label for="option1">1일 ~ 15일</label>
                   
                    <input type="radio" id="option2" name="displayOption" value="2" checked>
                    <label for="option2">16일 ~ 말일</label>
                </div>
                <div class="control-group holiday-option-group">
                    <label for="holidaySelect">법정휴무일:</label>
                
                    <select id="holidaySelect">
                         <option value="apply">적용</option>
                        <option value="ignore">미적용</option>
                    </select>
                </div>
         
               
                <div class="control-group" style="border-top: 1px solid #dee2e6; padding-top: 10px; margin-top: 5px;">
                    <button id="s1-printPage">인쇄</button>
                    
                    <div style="display: flex; flex-direction: row; gap: 10px; margin-left: 5px; align-items: flex-start; flex-grow: 1;">

                        <div style="display: flex; flex-direction: column; gap: 4px; align-items: stretch; padding: 2px 5px; border: 1px solid #ced4da; border-radius: 4px; background-color: #f8f9fa; flex-shrink: 0;">
                            
                            <div style="display: flex; align-items: center; gap: 2px; font-size: 0.9em; justify-content: space-between;">
                                <label for="marginLeftSelect">좌측:</label>
                                <select id="marginLeftSelect" class="margin-select">
                                     <option value="0">0</option><option value="10" selected>10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option>
                                </select>
                            </div>
                         
    
                            <div style="display: flex; align-items: center; gap: 2px; font-size: 0.9em; justify-content: space-between;">
                                <label for="marginRightSelect">우측:</label>
                                <select id="marginRightSelect" class="margin-select">
                                     <option value="0">0</option><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option>
                                </select>
                            </div>
                         </div>
 
                        <div style="display: flex; align-items: center; gap: 3px; font-size: 0.9em; padding: 2px 5px; background-color: #eaf4ff; border-radius: 4px; border: 1px solid #b3d7ff; flex-grow: 1; white-space: nowrap;">
                           <label for="fontSizeInput" style="font-weight: bold;">글자크기조정:</label>
                           <select id="fontSizeInput" class="margin-select" style="width: 45px; padding: 1px 3px; box-sizing: border-box; font-weight: bold;">
                                <option value="8">8pt</option>
                                <option value="9">9pt</option>
                                <option value="10">10pt</option>
                                <option value="11" selected>11pt</option>
                                <option value="12">12pt</option>
                                <option value="13">13pt</option>
                                <option value="14">14pt</option>
                            </select>
                        </div>

                    </div>
                    
                </div>
              
            </fieldset>

            <fieldset>
                <legend>근무전체데이타관리옵션</legend> <div class="control-group">
                    <select id="scheduleActionsSelect" class="action-select">
                        <option value="">근무전체데이타관리옵션</option> <option value="reset">현재 노선 초기화</option>
                        <option value="backup">전체 데이터 저장</option>
                        <option value="restore">전체 데이터 불러오기</option>
                    </select>
                    <input type="file" id="restoreFile" style="display: none;" accept=".json">
                
    
                    <button id="s1-calculateWorkdays">근무일수계산</button>
                </div>
                
                <div class="control-group">
                     <select id="vehicleSelect" class="vehicle-select">
                          <option value="">차량 선택</option>
                     </select>
                    <select id="workTypeSelect" class="work-type-select">
                         <option value="">근무조건 선택</option>
                         <option value="normal">3/3 근무</option>
                        <option value="biweekly">격주 근무</option>
                        <option value="five_day">5일근무</option> 
                    </select>
                </div>

           
           <div style="border-top: 1px solid #dee2e6; padding-top: 10px; margin-top: 5px;"></div> 
                
                <div class="control-group">
                    <button id="s1-showS2">승무일지 및 배차관리</button>
                    <button id="s1-showS3">차량정비점검일지</button>
           
                </div>
            </fieldset>
            
            <fieldset>
                <legend>차량 설정 (현재 노선)</legend>
                <div class="control-group">
                     <label for="vehicleCountInput">차량 수:</label>
                    <input type="number" id="vehicleCountInput" value="11" min="1" max="50">
                    <button id="s1-saveRouteConfig">차량 번호 저장</button>
                </div>
                <div class="control-group" style="flex-direction: column; align-items: flex-start;">
                    <label>차량 번호 (총 <span id="vehicleCountDisplay">0</span>대):</label>
                    <div id="vehicleInputsContainer">
                        </div>
                </div>
            </fieldset>
  
           
        </div>

        <div id="scheduleContainer">
            <table>
                <caption id="tableCaption">근무 현황표를 생성해주세요.</caption>
                <thead id="scheduleHeader">
                </thead>
         
               <tbody id="scheduleBody">
                </tbody>
            </table>
        </div>
    </div>

    <hr class="divider">

    <div id="section2" style="display: none;">
        <div class="journal-container">

            <div class="header-title">승무일지</div>

             <div class="title-area">
      
                     <div class="title-left">
                    <div class="main-title">승 무 일 지 (일일)</div>
                    <div id="today-date" class="date-display"></div>
                </div>
                
          
                 <div class="options-right">
                    
                    <button type="button" id="s2-showAll" class="print-button" style="background-color: #6c757d;">전체보기</button>
                    
                    <div id="dispatch-buttons" class="dispatch-buttons-container">
                         <label>출차순서:</label>
                        <button type="button" class="dispatch-button" data-order="1">1. 올림차순</button>
                        <button type="button" class="dispatch-button" data-order="2">2. 내림차순</button>
                        <button type="button" class="dispatch-button" data-order="3">3. 수동입력</button>
                        <button type="button" class="dispatch-button" data-order="4">4. 랜덤(한달)</button>
                    </div>

                    <div class="font-selector-container">
                        <label for="font-size-select">글자크기조정:</label>
                        <select id="font-size-select">
                            <option value="8">8pt</option>
                            <option value="9">9pt</option> 
                            <option value="10">10pt</option> 
                            <option value="11" selected>11pt</option> <option value="12">12pt</option>
                            <option value="13">13pt</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 5px;">
                        <button type="button" id="s2-backupLog" class="print-button" style="background-color: #28a745;">일지백업 (날짜)</button>
                        <button type="button" id="s2-showRestoreModal" class="print-button" style="background-color: #fd7e14;">일지복원 (날짜)</button>
                        <input type="file" id="s2_restoreFile" style="display: none;" accept=".json">
                    </div>

                   <button type="button" id="s2-refreshLog" class="print-button" style="background-color: #17a2b8;">새로고침</button>
                   
                   <button id="s2-printPage" class="print-button">인쇄하기</button>
           
                 </div>
            </div>
            
             <div class="date-header">2025년 10월 16일 목요일</div> 

             <div id="dispatch-log-body">
                </div>

   
           </div>
    </div>

    <div id="s2_restoreDateModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <h3 style="margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px;">승무일지 불러오기 날짜 선택</h3>
            <p>불러올 데이터가 적용될 날짜를 선택하세요.</p>
            <p>날짜를 선택하지 않으면 **오늘 날짜**로 불러옵니다.</p>
            
            <input type="date" id="s2_restoreSelectedDate" style="width: 95%; padding: 8px; font-size: 1.1em; margin-bottom: 15px;">
            
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="s2_cancelRestoreBtn" type="button" style="padding: 10px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">취소</button>
                <button id="s2_confirmRestoreBtn" type="button" style="padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">파일 선택</button>
            </div>
        </div>
    </div>

    <hr class="divider">

    <div id="section3" style="display: none;">
        <div class="maintenance-container">
            <header>
                <h1 id="s3_title" style="flex-basis: 100%; text-align: center; order: -1; margin-bottom: 10px;">
                    차량점검정비일지
                </h1>
                <div class="controls no-print">
        
                    <button id="s3-showAll" style="background-color: #6c757d; color: white;">전체보기</button>
                <button id="s3-backupFile" class="primary">일지백업</button> <input type="file" id="s3_restoreFile" style="display: none;" accept=".json">

             <button id="s3-triggerRestore" class="warning">일지복구</button> <button id="s3-showCalculator">부품가격계산</button>
                    <button id="s3-clearForm">폼초기화</button>
                    <button id="s3-printPage" class="primary">인쇄</button> 

                    <div class="margin-control-group no-print">
                        <label>인쇄여백</label>
                        <div class="margin-control">
                            <label for="s3_marginLeft">좌</label>
                            <select id="s3_marginLeft" class="margin-select">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                        <div class="margin-control">
                            <label for="s3_marginRight">우</label>
                            <select id="s3_marginRight" class="margin-select">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 5px; font-size: 13pt;">
                        <label for="s3_fontSizeInput">글자크기:</label>
                        <select id="s3_fontSizeInput" style="width: 50px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="8">8pt</option>
                            <option value="9">9pt</option>
                            <option value="10">10pt</option>
                            <option value="11" selected>11pt</option>
                            <option value="12">12pt</option>
                            <option value="13">13pt</option>
                            <option value="14">14pt</option>
                        </select>
                    </div>

                </div>
            </header>

            <form id="maintenanceForm">
                <table class="form-table">
<colgroup>
            <col class="route-col">  <col class="item-col">   <col class="detail-col"> <col class="parts-col">  <col class="price-col">  <col class="worker-col"> </colgroup>
                    <thead>
                    <tr>
                        <th class="date-col">년/월/일</th>
                        <th colspan="5" id="s3_dateDisplay">날짜 자동 입력</th>
                    </tr>
                    <tr>
                        <th class="route-col">노선/차량</th>
                        <th class="item-col">항목</th>
                        <th class="detail-col">정비내역</th>
                        <th class="parts-col">부품내역</th>
                        <th class="price-col">부품가격</th>
                        <th class="worker-col">작업자</th>
                    </tr>
                    </thead>
                    <tbody>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_1"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_1" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_1" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_1" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_1" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_1" class="price-input" /></div></td>
                            <td><textarea name="worker_1_1" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_2"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_2" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_2" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_2" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_2" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_2" class="price-input" /></div></td>
                            <td><textarea name="worker_1_2" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_3"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_3" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_3" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_3" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_3" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_3" class="price-input" /></div></td>
                            <td><textarea name="worker_1_3" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_4"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_4" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_4" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_4" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_4" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_4" class="price-input" /></div></td>
                            <td><textarea name="worker_1_4" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_5"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_5" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_5" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_5" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_5" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_5" class="price-input" /></div></td>
                            <td><textarea name="worker_1_5" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_1_6"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_1_6" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_1_6" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_1_6" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_1_6" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_1_6" class="price-input" /></div></td>
                            <td><textarea name="worker_1_6" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_1"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_1" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_1" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_1" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_1" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_1" class="price-input" /></div></td>
                            <td><textarea name="worker_2_1" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_2"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_2" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_2" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_2" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_2" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_2" class="price-input" /></div></td>
                            <td><textarea name="worker_2_2" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_3"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_3" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_3" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_3" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_3" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_3" class="price-input" /></div></td>
                            <td><textarea name="worker_2_3" class="auto-resize"></textarea></td>
                        </tr>
                        <tr class="entry-row">
                            <td class="route-select-cell">
                                <select class="header-select s3_routeSelect_row no-print" name="route_2_4"></select>
                                <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_2_4" style="display: none;"></select>
                                <div class="vehicle-display"></div>
                            </td>
                            <td><textarea name="item_2_4" class="auto-resize"></textarea></td>
                            <td><textarea name="detail_2_4" class="auto-resize"></textarea></td>
                            <td><textarea name="parts_2_4" class="auto-resize"></textarea></td>
                            <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_2_4" class="price-input" /></div></td>
                            <td><textarea name="worker_2_4" class="auto-resize"></textarea></td>
                        </tr>
                    </tbody>
                    <tfoot class="no-print">
                        <tr>
                            <td colspan="6" style="text-align: right; padding: 5px;">
                                <button type="button" id="s3-addRow" style="font-size: 11pt; padding: 4px 8px; background-color: #007bff; color: white; border: none;">
                                    행 추가 (+)
                                </button>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </form>

            <p class="thin-text" style="margin-top:8px">사용법: 셀에 내용을 입력한 뒤 'PDF로 저장 / 인쇄' 버튼을 눌러 A4로 저장하세요. 모바일에서는 가로 모드에서 인쇄 결과가 더 잘 맞을 수 있습니다.</p>
        </div>
    </div>

    <div id="s3_restoreDateModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <h3 style="margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px;">일지복구</h3>
            <p>백업한 '.json' 파일을 선택하세요.</p>
            <p style="color: red; font-weight: bold;">S3(정비일지)의 모든 기존 데이터는 덮어쓰여집니다.</p>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button id="s3_cancelRestoreBtn" type="button" style="padding: 10px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">취소</button>
                <button id="s3_triggerRestoreBtn" type="button" style="padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">파일 선택</button>
            </div>
        </div>
    </div>

    <div id="s3_calculatorModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <h3 style="margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px;">부품가격 계산기</h3>
            <p>기간을 설정하고 부품 가격 합계를 확인합니다.</p>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                <label>시작일:</label><input type="date" id="s3_startDate" style="flex-grow: 1; padding: 8px;">
                <label>종료일:</label><input type="date" id="s3_endDate" style="flex-grow: 1; padding: 8px;">
                <button id="s3-calculatePrices" style="padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px;">계산</button>
            </div>

            <div style="padding: 10px; border: 1px solid #ddd; background-color: #f8f9fa;">
                <strong>총 합계: <span id="s3_totalPrice" style="color: #dc3545;">0원</span></strong>
            </div>

            <div style="text-align: right; margin-top: 20px;">
                <button id="s3-closeCalculator" style="padding: 10px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">닫기</button>
            </div>
        </div>
    </div>

<script>
        /* ================================================================= */
        /* [공통] 통합 관리자 (DataManager) */
        /* (S1, S2, S3 데이터 동기화 총괄) */
        /* ================================================================= */

        /**
         * 1. 데이터 관리자 (DataManager)
         * - 모든 데이터의 로드, 저장, 수정을 담당합니다.
         * - 데이터 변경 시 "알림(dispatch)"을 보내 S2, S3가 반응하도록 합니다.
         */
        const DataManager = {
            MASTER_KEY: 'busScheduleManagerData', // S1, S2 공유 (근무표)
            S2_LOG_KEY: 'busDispatchLogData',     // S2 전용 (승무일지)
            S3_LOG_KEY: 'busMaintenanceLogData',  // S3 전용 (정비일지)
            
            // 데이터 저장소 (메모리)
            data: {
                s1: { currentRoute: null, routes: {} }, // S1 근무표 데이터
                s2: {}, // S2 승무일지 데이터
                s3: {}  // S3 정비일지 데이터
            },

            // 알림을 받을 모듈(S1, S2, S3)을 등록하는 곳
            listeners: [],

            // 알림 기능: 데이터가 변경되면 등록된 모듈에 알림
            dispatch(event, payload) {
                console.log(`[DataManager] 알림 발생: ${event}`, payload);
                this.listeners.forEach(listener => {
                    if (typeof listener.onDataChanged === 'function') {
                        listener.onDataChanged(event, payload);
                    }
                });
            },

            // 알림 받을 모듈 등록
            subscribe(module) {
                this.listeners.push(module);
            },

            // --- 공통 유틸리티 ---
            saveToStorage(key, value) {
                localStorage.setItem(key, JSON.stringify(value));
            },
            loadFromStorage(key) {
                const data = localStorage.getItem(key);
                try {
                    return JSON.parse(data);
                } catch {
                    return null;
                }
            },

            // --- S1 (근무표) 데이터 관리 ---
            loadS1Data() {
                let storedData = this.loadFromStorage(this.MASTER_KEY);
                if (!storedData || !storedData.routes) {
                    storedData = { currentRoute: null, routes: {} };
                }
                if (!storedData.currentRoute || !storedData.routes[storedData.currentRoute]) {
                    storedData.currentRoute = Object.keys(storedData.routes)[0] || null;
                }
                this.data.s1 = storedData;
                console.log("[DataManager] S1(근무표) 데이터 로드 완료.");
                return this.data.s1;
            },
            saveS1Data() {
                this.saveToStorage(this.MASTER_KEY, this.data.s1);
                console.log("[DataManager] S1(근무표) 데이터 저장 완료.");
                // S1 데이터 변경 시 S2, S3에 알림
                this.dispatch('s1_data_changed', this.data.s1);
            },
            updateS1Data(updaterFunction) {
                updaterFunction(this.data.s1);
                this.saveS1Data();
            },
            getCurrentRouteData() {
                const routeName = this.data.s1.currentRoute;
                if (!routeName) return { routeName: null, routeData: null };
                return {
                    routeName,
                    routeData: this.data.s1.routes[routeName]
                };
            },
            getAllRoutes() {
                return this.data.s1.routes || {};
            },
            setCurrentRoute(routeName) {
                this.data.s1.currentRoute = routeName;
                this.saveS1Data(); // 저장 및 알림(dispatch)
                console.log(`[DataManager] 현재 노선 변경: ${routeName}`);
            },

            // --- S2 (승무일지) 데이터 관리 ---
            loadS2Data() {
                const storedData = this.loadFromStorage(this.S2_LOG_KEY);
                this.data.s2 = storedData || {};
                console.log("[DataManager] S2(승무일지) 데이터 로드 완료.");
                return this.data.s2;
            },
            saveS2Data() {
                this.saveToStorage(this.S2_LOG_KEY, this.data.s2);
                console.log("[DataManager] S2(승무일지) 데이터 저장 완료.");
            },
            updateS2Data(updaterFunction) {
                updaterFunction(this.data.s2);
                this.saveS2Data();
            },

            // --- S3 (정비일지) 데이터 관리 ---
            loadS3Data() {
                const storedData = this.loadFromStorage(this.S3_LOG_KEY);
                this.data.s3 = storedData || {};
                console.log("[DataManager] S3(정비일지) 데이터 로드 완료.");
                return this.data.s3;
            },
            saveS3Data() {
                this.saveToStorage(this.S3_LOG_KEY, this.data.s3);
                console.log("[DataManager] S3(정비일지) 데이터 저장 완료.");
            },
            updateS3Data(updaterFunction) {
                updaterFunction(this.data.s3);
                this.saveS3Data();
            }
        };


        /* ================================================================= */
        /* [Section 1] 근무 현황표 JavaScript */
        /* ================================================================= */

        /**
         * 2. S1(근무 현황표) 모듈
         * - DataManager로부터 데이터를 받아 화면(테이블)을 그립니다.
         * - 노선 추가, 삭제, 근무표 수정 등 S1 데이터를 변경하는 작업을
         * DataManager에 요청합니다.
         */
        const S1_Module = {
            // S1 내부 상태
            state: {
                currentRoute: null,
                currentVehicleColumns: [],
                fixedScheduleData: {},
                tempScheduleData: {},
                workTypeConfig: {},
                scheduleData: {} // 현재 화면에 그려진 데이터 (임시)
            },

            // S1 UI 요소 캐시
            ui: {},

            // 2025년 공휴일 데이터 (이름 포함)
            publicHolidays2025: {
                '01-01': '신정', '01-28': '설날', '01-29': '설날', '01-30': '설날',
                '03-01': '삼일절', '05-05': '어린이날', '05-06': '부처님오신날',
                '06-06': '현충일', '08-15': '광복절', '10-05': '추석',
                '10-06': '추석', '10-07': '추석', '10-09': '한글날', '12-25': '성탄절'
            },

            /**
             * S1 모듈 초기화 (DOM 로드 시 1회 실행)
             */
            initialize() {
                console.log("S1: 초기화 시작");
                // UI 요소 캐시
                this.ui = {
                    companyInput: document.getElementById('companyInput'),
                    typeSelect: document.getElementById('typeSelect'),
                    routeInput: document.getElementById('routeInput'),
                    routeNavigateSelect: document.getElementById('routeNavigateSelect'),
                    yearInput: document.getElementById('yearInput'),
                    monthInput: document.getElementById('monthInput'),
                    holidaySelect: document.getElementById('holidaySelect'),
                    marginLeftSelect: document.getElementById('marginLeftSelect'),
                    marginRightSelect: document.getElementById('marginRightSelect'),
                    fontSizeInput: document.getElementById('fontSizeInput'),
                    scheduleActionsSelect: document.getElementById('scheduleActionsSelect'),
                    restoreFile: document.getElementById('restoreFile'),
                    vehicleSelect: document.getElementById('vehicleSelect'),
                    workTypeSelect: document.getElementById('workTypeSelect'),
                    vehicleCountInput: document.getElementById('vehicleCountInput'),
                    vehicleCountDisplay: document.getElementById('vehicleCountDisplay'),
                    vehicleInputsContainer: document.getElementById('vehicleInputsContainer'),
                    scheduleContainer: document.getElementById('scheduleContainer')
                };

                // 날짜 초기화
                const today = new Date();
                this.ui.yearInput.value = today.getFullYear();
                this.ui.monthInput.value = today.getMonth() + 1;
                const currentDay = today.getDate();
                if (currentDay <= 15) {
                    document.getElementById('option1').checked = true;
                } else {
                    document.getElementById('option2').checked = true;
                }

                // DataManager로부터 S1 데이터 로드
                const s1_data = DataManager.loadS1Data();
                this.state.currentRoute = s1_data.currentRoute;

                // 이벤트 리스너 바인딩
                this.bindEventListeners();

                // 노선 선택 드롭다운 채우기
                this.populateRouteSelect();
                // 현재 노선 데이터 화면에 로드
                this.loadRouteData(this.state.currentRoute);

                // DataManager에 S1 모듈 등록 (S2 등에서 데이터 변경 시 알림 받기 위함)
                DataManager.subscribe(this);

                console.log("S1: 초기화 완료.");
            },

            /**
             * DataManager로부터 알림을 처리하는 함수 (S2/S3에서 데이터 변경 시)
             */
            onDataChanged(event, payload) {
                // S1 데이터가 외부(S2)에서 변경된 경우, S1 화면을 다시 그림
                if (event === 's1_data_changed') {
                    console.log("[S1] S2로부터 데이터 변경 알림 수신. S1 갱신 시작.");
                    const s1_data = payload;
                    this.state.currentRoute = s1_data.currentRoute;
                    this.populateRouteSelect();
                    this.loadRouteData(this.state.currentRoute, true); // true = 갱신 알림
                }
            },

            /**
             * S1의 모든 이벤트 리스너 바인딩
             */
            bindEventListeners() {
                document.getElementById('s1-addOrUpdateRoute').onclick = () => this.addOrUpdateRoute();
                document.getElementById('s1-deleteRoute').onclick = () => this.deleteRoute();
                this.ui.routeNavigateSelect.onchange = (e) => this.handleRouteSelectChange(e.target.value);
                
                document.getElementById('s1-generateSchedule').onclick = () => this.generateSchedule();
                document.getElementById('s1-printPage').onclick = () => this.printPage();
                this.ui.fontSizeInput.onchange = (e) => this.applyFontSize(e.target.value + 'pt');

                this.ui.scheduleActionsSelect.onchange = () => this.handleScheduleActions();
                this.ui.restoreFile.onchange = (e) => this.restoreScheduleData(e.target.files[0]);
                document.getElementById('s1-calculateWorkdays').onclick = () => this.calculateWorkdays();
                this.ui.workTypeSelect.onchange = () => this.handleWorkTypeChange();
                
                this.ui.vehicleCountInput.onchange = (e) => this.handleVehicleCountChange(e.target.value);
                document.getElementById('s1-saveRouteConfig').onclick = () => this.saveRouteConfig();

                document.getElementById('s1-showS2').onclick = () => this.showSection('S2');
                document.getElementById('s1-showS3').onclick = () => this.showSection('S3');
                
                document.addEventListener('click', (e) => this.clearEditMode(e));
            },

            /**
             * [데이터 연동] 노선 목록 드롭다운 채우기
             */
            populateRouteSelect() {
                const { routes } = DataManager.data.s1;
                const routeSelect = this.ui.routeNavigateSelect;
                routeSelect.innerHTML = ''; 
                const routeNames = Object.keys(routes);

                if (routeNames.length === 0) {
                    routeSelect.innerHTML = '<option value="">노선을 추가하세요</option>';
                    return;
                }
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '--- 노선 이동 ---';
                routeSelect.appendChild(defaultOption);

                routeNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    if (name === this.state.currentRoute) {
                        option.selected = true;
                    }
                    routeSelect.appendChild(option);
                });
            },

            /**
             * [데이터 연동] 특정 노선 데이터 로드 (S1 상태 변경)
             */
            loadRouteData(routeName, isRefresh = false) {
                const { routes } = DataManager.data.s1;

                if (!routeName || !routes[routeName]) {
                    // UI 초기화
                    this.ui.routeInput.value = '';
                    this.ui.companyInput.value = '';
                    this.ui.typeSelect.value = '마을';
                    this.ui.vehicleCountInput.value = 0;
                    this.handleVehicleCountChange(0);
                    
                    // S1 내부 상태 초기화
                    this.state.fixedScheduleData = {};
                    this.state.tempScheduleData = {};
                    this.state.workTypeConfig = {};
                    this.state.currentVehicleColumns = [];
                    this.state.currentRoute = null;
                    
                    DataManager.setCurrentRoute(null);
                    
                    this.updateVehicleSelect();
                    if (this.ui.routeNavigateSelect) {
                        this.ui.routeNavigateSelect.value = '';
                    }
                    this.generateSchedule(); 
                    return;
                }

                // DataManager에 현재 노선 설정 요청 (알림 발생)
                // (S2 등에서 발생한 갱신(isRefresh)일 경우는 제외)
                if (!isRefresh) {
                    DataManager.setCurrentRoute(routeName);
                }
                
                this.state.currentRoute = routeName;
                const routeData = routes[routeName];

                // S1 내부 상태 변수 로드
                this.state.fixedScheduleData = routeData.fixedSchedule;
                this.state.tempScheduleData = routeData.tempSchedule;
                this.state.workTypeConfig = routeData.workTypeConfig;
                this.state.currentVehicleColumns = routeData.vehicleColumns || [];

                // S1 컨트롤 UI 업데이트
                this.ui.routeInput.value = routeName;
                this.ui.companyInput.value = routeData.companyName || '';
                this.ui.typeSelect.value = routeData.type || '마을';
                this.ui.vehicleCountInput.value = this.state.currentVehicleColumns.length;

                this.handleVehicleCountChange(this.state.currentVehicleColumns.length);
                this.updateVehicleSelect();
                if (this.ui.routeNavigateSelect) {
                    this.ui.routeNavigateSelect.value = routeName;
                }
                
                // 근무 현황표 다시 그리기
                this.generateSchedule(); 
            },

            /**
             * [데이터 연동] 노선 추가 또는 수정
             */
            addOrUpdateRoute() {
                const routeName = this.ui.routeInput.value.trim();
                if (!routeName) {
                    alert('노선 번호를 입력하세요.');
                    return;
                }
                const companyName = this.ui.companyInput.value.trim();
                const type = this.ui.typeSelect.value;
                
                // DataManager에 데이터 수정을 요청
                DataManager.updateS1Data(s1_data => {
                    if (!s1_data.routes[routeName]) {
                        // 새 노선 추가
                        s1_data.routes[routeName] = {
                            companyName: companyName,
                            type: type,
                            vehicleColumns: ['차량1'], 
                            fixedSchedule: {},
                            tempSchedule: {},
                            workTypeConfig: {}
                        };
                        alert(`새 노선 [${routeName}]이 추가되었습니다. 차량 수와 차량 번호를 설정하세요.`);
                    } else {
                        // 기존 노선 정보 업데이트
                        s1_data.routes[routeName].companyName = companyName;
                        s1_data.routes[routeName].type = type;
                        alert(`[${routeName}] 노선 정보 (회사명, 종류)가 수정되었습니다.`);
                    }
                    s1_data.currentRoute = routeName;
                });

                // S1 상태 업데이트 및 UI 갱신 (DataManager가 알림을 보내지만, S1은 즉시 갱신)
                this.state.currentRoute = routeName;
                this.populateRouteSelect(); 
                this.loadRouteData(routeName);
            },

            /**
             * [데이터 연동] 노선 삭제
             */
            deleteRoute() {
                const routeName = this.ui.routeNavigateSelect.value;
                if (!routeName) {
                    alert('삭제할 노선을 [관련 노선 이동] 드롭다운에서 선택하세요.');
                    return;
                }

                if (confirm(`[${routeName}] 노선을 정말로 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`)) {
                    let newRouteToLoad = null;
                    
                    // DataManager에 데이터 수정을 요청
                    DataManager.updateS1Data(s1_data => {
                        delete s1_data.routes[routeName];
                        newRouteToLoad = Object.keys(s1_data.routes)[0] || null;
                        s1_data.currentRoute = newRouteToLoad;
                    });
                    
                    // S1 상태 업데이트 및 UI 갱신
                    this.state.currentRoute = newRouteToLoad;
                    this.populateRouteSelect(); 
                    this.loadRouteData(newRouteToLoad); 
                    
                    alert(`[${routeName}] 노선이 삭제되었습니다.`);
                }
            },

            /**
             * [데이터 연동] 차량 번호 저장
             */
            saveRouteConfig() {
                if (!this.state.currentRoute) {
                    alert('먼저 노선을 선택하거나 추가하세요.');
                    return;
                }

                const inputs = this.ui.vehicleInputsContainer.querySelectorAll('input');
                const newVehicleColumns = [];
                inputs.forEach(input => {
                    newVehicleColumns.push(input.value.trim() || '미입력');
                });

                // DataManager에 데이터 수정을 요청
                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[this.state.currentRoute];
                    if (routeData) {
                        routeData.vehicleColumns = newVehicleColumns;
                    }
                });

                // S1 상태 업데이트 및 UI 갱신
                this.state.currentVehicleColumns = newVehicleColumns; 
                this.updateVehicleSelect(); 
                this.generateSchedule(); 
                
                alert(`[${this.state.currentRoute}] 노선의 차량 번호가 저장되었습니다.`);
            },

            /**
             * (UI) 차량 수 변경 시 입력란 동적 생성
             */
            handleVehicleCountChange(countStr) {
                const count = parseInt(countStr) || 0;
                this.ui.vehicleCountDisplay.textContent = count;
                const container = this.ui.vehicleInputsContainer;
                container.innerHTML = ''; 
                container.style.flexDirection = 'row'; 
                container.style.alignItems = 'unset';

                const existingColumns = this.state.currentVehicleColumns || [];
                
                for (let i = 0; i < count; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    const existingValue = existingColumns[i] || '';
                    if (existingValue === '미입력') {
                        input.placeholder = '미입력';
                        input.value = '';
                    } else {
                        input.placeholder = `차량 ${i + 1}`;
                        input.value = existingValue;
                    }
                    container.appendChild(input);
                }
            },
            
            /**
             * (UI) 차량 선택 드롭다운 업데이트
             */
            updateVehicleSelect() {
                const vehicleSelect = this.ui.vehicleSelect;
                vehicleSelect.innerHTML = '<option value="">차량 선택</option>';
                
                if (this.state.currentVehicleColumns.length > 0) {
                     vehicleSelect.innerHTML += '<option value="ALL_VEHICLES" style="font-weight:bold; background-color:#e0e0e0;">--- 전체차량 ---</option>';
                }

                this.state.currentVehicleColumns.forEach(colName => {
                    if(colName && colName !== '미입력') {
                        const option = document.createElement('option');
                        option.value = colName;
                        option.textContent = colName;
                        vehicleSelect.appendChild(option);
                    }
                });
            },

            /**
             * (Util) 요일 이름 반환
             */
            getDayName(dayOfWeek) {
                return ['일', '월', '화', '수', '목', '금', '토'][dayOfWeek];
            },
            
            /**
             * (Util) 공휴일 확인
             */
            isPublicHoliday(date) {
                const year = date.getFullYear();
                if (year !== 2025) return false; // 2025년 데이터만 있음
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const mmdd = `${month}-${day}`;
                return this.publicHolidays2025[mmdd] || false; 
            },

            /**
             * (UI) 셀 내용물(이름) HTML 생성
             */
            renderCellContent(names) {
                if (!names || names.length === 0) return '';
                return names.map(item => {
                    const text = item.text.trim();
                    const display = text === '' ? '.' : text;
                    const hiddenClass = text === '' ? ' hidden-x' : '';
                    const boldClass = item.bold ? ' bold-name' : ''; 
                    return `<span class="name-entry${hiddenClass}${boldClass}">${display}</span>`;
                }).join('');
            },

            /**
             * (UI) 셀 편집 모드 진입
             */
            editCell(cell, colId, dateString, dayOfWeek) {
                if (cell.classList.contains('edit-mode')) return;

                // 기존 편집 모드 셀 닫기
                document.querySelectorAll('#section1 td.edit-mode').forEach(editCell => { 
                    const prevColId = editCell.dataset.colId;
                    const prevDateString = editCell.dataset.dateString;
                    const originalNames = (this.state.scheduleData[prevDateString] && this.state.scheduleData[prevDateString][prevColId]) || [{ text: '', bold: false }, { text: '', bold: false }];
                    editCell.classList.remove('edit-mode');
                    editCell.innerHTML = this.renderCellContent(originalNames);
                });

                const currentNames = (this.state.scheduleData[dateString] && this.state.scheduleData[dateString][colId]) || [{ text: '', bold: false }, { text: '', bold: false }];
                const morningValue = currentNames[0] ? currentNames[0].text : '';
                const afternoonValue = currentNames[1] ? currentNames[1].text : '';
                const isBiweeklySunday = (this.state.workTypeConfig[colId] === 'biweekly' && dayOfWeek === 0);

                cell.classList.add('edit-mode');
                cell.dataset.colId = colId;
                cell.dataset.dateString = dateString;
                cell.dataset.dayOfWeek = dayOfWeek;
                cell.innerHTML = `
                    <input type="text" class="morning-input" value="${morningValue}" placeholder="오전" data-bold="${currentNames[0].bold}">
                    <input type="text" class="afternoon-input" value="${afternoonValue}" placeholder="오후" data-bold="${currentNames[1].bold}">
                    <div class="cell-buttons">
                        <button class="btn-fixed" ${isBiweeklySunday ? 'disabled title="격주 근무 차량은 일요일 고정 저장이 불가능합니다."' : ''}>고정</button>
                        <button class="btn-temp">임시</button>
                        <button class="btn-highlight-am">오전 강조</button>
                        <button class="btn-highlight-pm">오후 강조</button>
                        <button class="btn-delete">삭제</button>
                    </div>
                `;
                cell.querySelector('.morning-input').focus();

                // 새로 생성된 버튼들에 이벤트 리스너 바인딩
                const buttons = cell.querySelector('.cell-buttons');
                buttons.querySelector('.btn-fixed').onclick = (e) => { e.stopPropagation(); this.saveFixedCell(cell); };
                buttons.querySelector('.btn-temp').onclick = (e) => { e.stopPropagation(); this.saveTempCell(cell); };
                buttons.querySelector('.btn-highlight-am').onclick = (e) => { e.stopPropagation(); this.highlightCell(cell, 'am'); };
                buttons.querySelector('.btn-highlight-pm').onclick = (e) => { e.stopPropagation(); this.highlightCell(cell, 'pm'); };
                buttons.querySelector('.btn-delete').onclick = (e) => { e.stopPropagation(); this.deleteCell(cell); };
            },
            
            /**
             * (UI) 편집 모드 해제
             */
            clearEditMode(event) {
                // S1의 날짜/요일 셀 클릭 시
                if (event.target.matches('#section1 td:nth-child(1)') || event.target.matches('#section1 td:nth-child(2)')) {
                    const editCell = document.querySelector('#section1 td.edit-mode');
                    if (editCell) {
                        const prevColId = editCell.dataset.colId;
                        const prevDateString = editCell.dataset.dateString;
                        const originalNames = (this.state.scheduleData[prevDateString] && this.state.scheduleData[prevDateString][prevColId]) || [{ text: '', bold: false }, { text: '', bold: false }];
                        editCell.classList.remove('edit-mode');
                        editCell.innerHTML = this.renderCellContent(originalNames);
                    }
                }
            },

            /**
             * (Util) 편집 셀에서 이름/강조 정보 가져오기
             */
            getNamesAndBoldStateFromCell(cellElement) {
                const morningInput = cellElement.querySelector('.morning-input');
                const afternoonInput = cellElement.querySelector('.afternoon-input');
                return [ 
                    { text: morningInput.value.trim(), bold: morningInput.dataset.bold === 'true' }, 
                    { text: afternoonInput.value.trim(), bold: afternoonInput.dataset.bold === 'true' } 
                ];
            },

            /**
             * (UI) 오전/오후 강조 토글
             */
            highlightCell(cellElement, timeOfDay) {
                let inputElement = cellElement.querySelector(timeOfDay === 'am' ? '.morning-input' : '.afternoon-input');
                if (inputElement) {
                    const newState = !(inputElement.dataset.bold === 'true');
                    inputElement.dataset.bold = newState; 
                    inputElement.style.fontWeight = newState ? 'bold' : 'normal';
                }
            },

            /**
             * [데이터 연동] '고정' 저장
             */
            saveFixedCell(cellElement) {
                const { colId, dayOfWeek, dateString } = cellElement.dataset;
                const namesToSave = this.getNamesAndBoldStateFromCell(cellElement);
                const workType = this.state.workTypeConfig[colId] || 'normal';

                if (workType === 'biweekly' && dayOfWeek === '0') {
                    alert('격주 근무 차량은 일요일 고정 저장이 불가능합니다.');
                    return;
                }

                // DataManager에 데이터 수정을 요청
                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[this.state.currentRoute];
                    if (!routeData) return;

                    const currentRecurringKey = `${dayOfWeek}-${colId}`;
                    if (!routeData.fixedSchedule[currentRecurringKey]) {
                        routeData.fixedSchedule[currentRecurringKey] = [];
                    }
                    routeData.fixedSchedule[currentRecurringKey] = 
                        routeData.fixedSchedule[currentRecurringKey].filter(
                            entry => entry.dateString !== dateString
                        );
                    routeData.fixedSchedule[currentRecurringKey].push({ dateString: dateString, names: namesToSave });

                    for (const key in routeData.fixedSchedule) {
                        routeData.fixedSchedule[key].sort((a, b) => new Date(b.dateString) - new Date(a.dateString));
                    }
                    
                    this.state.fixedScheduleData = routeData.fixedSchedule;
                });
                
                this.generateSchedule();
            },

            /**
             * [데이터 연동] '임시' 저장
             */
            saveTempCell(cellElement) {
                const { colId, dateString } = cellElement.dataset;
                const namesToSave = this.getNamesAndBoldStateFromCell(cellElement);

                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[this.state.currentRoute];
                    if (!routeData) return;

                    if (!routeData.tempSchedule[dateString]) routeData.tempSchedule[dateString] = {};
                    routeData.tempSchedule[dateString][colId] = namesToSave;
                    
                    this.state.tempScheduleData = routeData.tempSchedule;
                });

                this.generateSchedule();
            },

            /**
             * [데이터 연동] '삭제'
             */
            deleteCell(cellElement) {
                const { colId, dayOfWeek, dateString } = cellElement.dataset;

                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[this.state.currentRoute];
                    if (!routeData) return;

                    if (routeData.tempSchedule[dateString]?.[colId]) {
                        delete routeData.tempSchedule[dateString][colId];
                        if (Object.keys(routeData.tempSchedule[dateString]).length === 0) {
                            delete routeData.tempSchedule[dateString];
                        }
                    }

                    const recurringKey = `${dayOfWeek}-${colId}`;
                    if (!routeData.fixedSchedule[recurringKey]) {
                        routeData.fixedSchedule[recurringKey] = [];
                    }
                    
                    const blankNames = [{ text: '', bold: false }, { text: '', bold: false }];
                    routeData.fixedSchedule[recurringKey] = 
                        routeData.fixedSchedule[recurringKey].filter(entry => entry.dateString !== dateString);
                    routeData.fixedSchedule[recurringKey].push({ dateString: dateString, names: blankNames });
                    routeData.fixedSchedule[recurringKey].sort((a, b) => new Date(b.dateString) - new Date(a.dateString));
                    
                    this.state.fixedScheduleData = routeData.fixedSchedule;
                    this.state.tempScheduleData = routeData.tempSchedule;
                });
                
                this.generateSchedule();
            },
/**
             * [데이터 연동] 현재 노선 초기화
             */
            resetAllFixedSchedules() {
                if (!this.state.currentRoute) {
                    alert('초기화할 노선이 선택되지 않았습니다.');
                    return;
                }
                const password = prompt(`[${this.state.currentRoute}] 노선의 모든 고정/임시 근무표 및 근무형태 설정을 삭제하시려면 비밀번호를 입력하세요.`);
                if (password === "201023") {
                    if (confirm(`[${this.state.currentRoute}] 노선의 모든 근무표 데이터를 삭제합니다. 계속하시겠습니까?`)) {
                        
                        // DataManager에 데이터 수정을 요청
                        DataManager.updateS1Data(s1_data => {
                            const routeData = s1_data.routes[this.state.currentRoute];
                            if (routeData) {
                                routeData.fixedSchedule = {};
                                routeData.tempSchedule = {};
                                routeData.workTypeConfig = {};
                                
                                // S1 내부 상태도 즉시 동기화
                                this.state.fixedScheduleData = routeData.fixedSchedule;
                                this.state.tempScheduleData = routeData.tempSchedule;
                                this.state.workTypeConfig = routeData.workTypeConfig;
                            }
                        });

                        // 화면 갱신
                        this.generateSchedule();
                        alert(`[${this.state.currentRoute}] 노선의 근무표가 초기화되었습니다.`);
                    }
                } else {
                    alert("비밀번호 확인 후 신청하세요.");
                }
            },

            /**
             * [데이터 연동] 전체 데이터 저장 (백업)
             */
            backupScheduleData() {
                const backupData = DataManager.data.s1; // DataManager의 최신 S1 데이터 사용
                const jsonString = JSON.stringify(backupData);
                const now = new Date();
                const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
                const routeIdentifier = (this.state.currentRoute ? this.state.currentRoute.replace(/\s/g, '') : 'all');
                const filename = `bus_schedule_${routeIdentifier}_saved_${timestamp}.json`;
                
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                alert(`전체 근무표 저장 데이터 파일 (${filename})이 다운로드 폴더에 JSON 파일로 저장됩니다.`);
            },

            /**
             * [데이터 연동] 전체 데이터 불러오기 (복원)
             */
            restoreScheduleData(file) {
                const selectElement = this.ui.scheduleActionsSelect;
                if (!file) {
                    selectElement.value = '';
                    return;
                }
                if (!confirm(`[${file.name}] 파일을 업로드하여 저장된 *모든* 노선의 근무표를 불러오시겠습니까? (현재 모든 데이터는 덮어쓰여집니다.)`)) {
                    this.ui.restoreFile.value = '';
                    selectElement.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedData = JSON.parse(event.target.result);
                        if (!loadedData.routes || loadedData.currentRoute === undefined) {
                             alert('파일 형식이 올바르지 않거나 데이터가 부족합니다. (routes, currentRoute 속성 필요)');
                             throw new Error('Invalid saved file structure');
                        }
                        
                        // DataManager에 데이터 수정을 요청 (완전 덮어쓰기)
                        DataManager.updateS1Data(s1_data => {
                            s1_data.routes = loadedData.routes;
                            s1_data.currentRoute = loadedData.currentRoute;
                        });

                        // S1 상태 업데이트 및 UI 갱신
                        this.state.currentRoute = loadedData.currentRoute; 
                        this.populateRouteSelect();
                        this.loadRouteData(this.state.currentRoute);
                        alert(`[${file.name}] 파일로부터 전체 데이터 불러오기를 완료했습니다. 화면을 확인해주세요.`);

                    } catch (e) {
                        alert('파일을 읽는 도중 오류가 발생했습니다. 파일이 손상되었거나 JSON 형식이 아닙니다.');
                        console.error('Restore Error:', e);
                    } finally {
                        this.ui.restoreFile.value = '';
                        selectElement.value = '';
                    }
                };
                reader.onerror = () => {
                    alert('파일을 읽을 수 없습니다.');
                    this.ui.restoreFile.value = '';
                    selectElement.value = '';
                };
                reader.readAsText(file);
            },

            /**
             * (UI) 근무 현황표 테이블 생성 (핵심)
             */
            generateSchedule() {
                if (!this.state.currentRoute) {
                    this.ui.scheduleContainer.innerHTML = '<table><caption id="tableCaption">표시할 노선을 선택하거나 추가해주세요.</caption></table>';
                    return;
                }

                const year = parseInt(this.ui.yearInput.value);
                const month = parseInt(this.ui.monthInput.value);
                const selectedOption = document.querySelector('#section1 input[name="displayOption"]:checked').value;
                const applyHolidays = this.ui.holidaySelect.value === 'apply';
                
                const { routeData } = DataManager.getCurrentRouteData();
                if (!routeData) return; // 노선이 없으면 중단

                const companyName = routeData.companyName || '회사명 없음';
                const VEHICLE_COLS = routeData.vehicleColumns || [];
                
                this.ui.scheduleContainer.innerHTML = ''; 

                const startDate = new Date(year, month - 1, selectedOption === '1' ? 1 : 16);
                const endDate = (selectedOption === '1') ? new Date(year, month - 1, 15) : new Date(year, month, 0);
                
                const colsPerPage = 12; 
                const colChunks = [];
                for (let i = 0; i < VEHICLE_COLS.length; i += colsPerPage) {
                    colChunks.push(VEHICLE_COLS.slice(i, i + colsPerPage));
                }
                if (colChunks.length === 0) {
                     colChunks.push([]);
                }

                const dateRange = [];
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    dateRange.push(new Date(d));
                }
                
                this.state.scheduleData = {}; 

                colChunks.forEach((vehicleChunk, chunkIndex) => {
                    
                    const table = document.createElement('table');
                    if (chunkIndex > 0) {
                        table.style.pageBreakBefore = 'always';
                    }

                    // 1. 캡션(제목) 생성
                    const caption = document.createElement('caption');
                    let captionText = `${companyName} [${this.state.currentRoute}] ${year}년 ${month}월 ${startDate.getDate()}일 ~ ${endDate.getDate()}일까지 근무현황표`;
                    if (colChunks.length > 1) {
                        captionText += ` (페이지 ${chunkIndex + 1}/${colChunks.length})`;
                    }
                    if (chunkIndex === 0) caption.id = 'tableCaption';
                    caption.textContent = captionText;
                    table.appendChild(caption);

                    // 2. 헤더 생성
                    const thead = document.createElement('thead');
                    if (chunkIndex === 0) thead.id = 'scheduleHeader';
                    const headerHTML = `<tr><th style="width: 4%;">월일</th><th style="width: 4%;">요일</th>${vehicleChunk.map(c => c === '미입력' ? `<th></th>` : `<th>${c}</th>`).join('')}</tr>`;
                    thead.innerHTML = headerHTML;
                    table.appendChild(thead);

                    // 3. 바디 생성
                    const tbody = document.createElement('tbody');
                    if (chunkIndex === 0) tbody.id = 'scheduleBody';

                    // 날짜별(행) 데이터 계산
                    dateRange.forEach(d => {
                        const dateString = d.toISOString().slice(0, 10);
                        const dayOfWeek = d.getDay();
                        
                        if (!this.state.scheduleData[dateString]) { 
                            let cellsContent = {};
                            VEHICLE_COLS.forEach(colId => { 
                                if (colId === '미입력') {
                                    cellsContent[colId] = [];
                                    return;
                                }

                                let appliedNames = [{ text: '', bold: false }, { text: '', bold: false }];
                                
                                if (this.state.tempScheduleData[dateString] && this.state.tempScheduleData[dateString][colId]) {
                                    appliedNames = this.state.tempScheduleData[dateString][colId];
                                } 
                                else {
                                    const recurringKey = `${dayOfWeek}-${colId}`;
                                    if (this.state.fixedScheduleData[recurringKey]) {
                                        let anchorEntry = null;
                                        for (const entry of this.state.fixedScheduleData[recurringKey]) {
                                            if (new Date(dateString) >= new Date(entry.dateString)) {
                                                anchorEntry = entry;
                                                break; 
                                            }
                                        }

                                        if (anchorEntry) {
                                            const workType = this.state.workTypeConfig[colId] || 'normal';
                                            if (workType === 'biweekly' && dayOfWeek !== 0) {
                                                const anchorDate = new Date(anchorEntry.dateString);
                                                const currentDate = new Date(dateString);
                                                anchorDate.setHours(0, 0, 0, 0);
                                                currentDate.setHours(0, 0, 0, 0);
                                                const msInDay = 24 * 60 * 60 * 1000;
                                                const diffInDays = Math.round((currentDate.getTime() - anchorDate.getTime()) / msInDay);
                                                const weekDifference = Math.floor(diffInDays / 7);
                                                
                                                if (weekDifference % 2 === 1) {
                                                    appliedNames = [anchorEntry.names[1], anchorEntry.names[0]];
                                                } else {
                                                    appliedNames = anchorEntry.names;
                                                }
                                            } else {
                                                appliedNames = anchorEntry.names;
                                            }
                                        }
                                    }
                                }
                                cellsContent[colId] = appliedNames;
                            });
                            this.state.scheduleData[dateString] = cellsContent; 
                        }

                        // 행(Row) HTML 생성
                        const holidayName = applyHolidays ? this.isPublicHoliday(d) : false;
                        const isHoliday = !!holidayName;
                        let rowClass = '';
                        const dayName = this.getDayName(dayOfWeek); 
                        let mainColor = '#333'; 
                        let subText = '';

                        if (isHoliday) {
                            rowClass = 'holiday'; mainColor = '#cc0000'; subText = holidayName.substring(0, 2); 
                        } else if (dayOfWeek === 0) {
                            rowClass = 'sunday'; mainColor = '#cc0000'; subText = '일요'; 
                        } else if (dayOfWeek === 6) {
                            rowClass = 'saturday'; mainColor = '#0000cc'; subText = '토요';
                        }
                        
                        let dayCellContent;
                        if (dayOfWeek === 0 || dayOfWeek === 6 || isHoliday) {
                            dayCellContent = `<div class="day-cell-content"><span class="day-name-main" style="color: ${mainColor};">${dayName}</span><span class="sub-day-info" style="color: ${mainColor};">${subText}</span></div>`;
                        } else {
                            dayCellContent = `<div class="day-cell-content"><span class="day-name-main" style="color: ${mainColor};">${dayName}</span><span class="sub-day-info" style="color: ${mainColor};"></span></div>`;
                        }

                        // 데이터 셀(TD) HTML 생성
                        const dataCellsHTML = vehicleChunk.map(colId =>
                            colId === '미입력' 
                            ? `<td></td>` 
                            : `<td onclick="S1_Module.editCell(this, '${colId}', '${dateString}', ${dayOfWeek})">${this.renderCellContent(this.state.scheduleData[dateString][colId])}</td>`
                        ).join('');

                        tbody.insertAdjacentHTML('beforeend', `
                            <tr class="${rowClass}">
                                <td>${d.getDate()}</td>
                                <td>${dayCellContent}</td> 
                                ${dataCellsHTML}
                            </tr>`);
                    }); 

                    table.appendChild(tbody);
                    this.ui.scheduleContainer.appendChild(table);
                }); 
            },

            /**
             * (Util) 근무일수 계산기
             */
            calculateWorkdays() {
                if (!this.state.currentRoute) {
                    alert('근무일수를 계산할 노선이 없습니다.');
                    return;
                }
                
                const { routeData } = DataManager.getCurrentRouteData();
                if (!routeData) return;
                
                const year = parseInt(this.ui.yearInput.value);
                const month = parseInt(this.ui.monthInput.value);
                const VEHICLE_COLS = routeData.vehicleColumns || [];
                const workdayCounts = {};
                const shiftCounts = {};
                const allNames = new Set();

                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0);

                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateString = d.toISOString().slice(0, 10);
                    const dayOfWeek = d.getDay();
                    let dailyNames = {}; 

                    VEHICLE_COLS.forEach(colId => {
                        if (colId === '미입력') return; 

                        let appliedNames = [{ text: '', bold: false }, { text: '', bold: false }];
                        if (routeData.tempSchedule[dateString] && routeData.tempSchedule[dateString][colId]) {
                           appliedNames = routeData.tempSchedule[dateString][colId];
                        } else {
                            const recurringKey = `${dayOfWeek}-${colId}`;
                            if (routeData.fixedSchedule[recurringKey]) {
                                for (const entry of routeData.fixedSchedule[recurringKey]) {
                                    if (new Date(dateString) >= new Date(entry.dateString)) {
                                        appliedNames = entry.names;
                                        break;
                                    }
                                }
                            }
                        }
                        dailyNames[colId] = appliedNames;
                    });
                    
                    const dayWorkdays = new Set();
                    for (const colId in dailyNames) {
                        if (colId !== '비고' && colId !== '미입력') { 
                            dailyNames[colId].forEach((item, index) => {
                                const name = item.text.trim();
                                if (name !== '' && name !== '휴무') {
                                    allNames.add(name);
                                    if (!shiftCounts[name]) shiftCounts[name] = { 오전: 0, 오후: 0 };
                                    if (index === 0) shiftCounts[name].오전++;
                                    else shiftCounts[name].오후++;
                                    dayWorkdays.add(name);
                                }
                            });
                        }
                    }
                    dayWorkdays.forEach(name => {
                        if (!workdayCounts[name]) workdayCounts[name] = 0;
                        workdayCounts[name]++;
                    });
                }

                const combinedData = Array.from(allNames).map(name => ({
                    name: name, 
                    workdays: workdayCounts[name] || 0,
                    morningShifts: (shiftCounts[name] && shiftCounts[name].오전) || 0,
                    afternoonShifts: (shiftCounts[name] && shiftCounts[name].오후) || 0
                }));
                combinedData.sort((a, b) => b.workdays - a.workdays);
                
                const title = `[${this.state.currentRoute}] ${year}년 ${month}월 근무일수`;
                const tableHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead><tr>
                            <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">이름</th>
                            <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">오전</th>
                            <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">오후</th>
                            <th style="width: 25%; padding: 8px; border: 1px solid #ddd;">총 근무일수</th>
                        </tr></thead>
                        <tbody>${combinedData.map(data => `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.name}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.morningShifts}일</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.afternoonShifts}일</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${data.workdays}일</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`;
                
                const newWindow = window.open('', '_blank', 'width=600,height=400');
                newWindow.document.write(`<html><head><title>${title}</title><style>
                    body { font-family: Arial, sans-serif; margin: 20px; } h3 { text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; } th { background-color: #f2f2f2; }
                    .print-button { display: block; margin: 20px auto; padding: 10px 20px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; }
                    @media print { .print-button { display: none; } html, body { height: 100%; width: 100%; margin: 0; } }
                    </style></head><body><h3>${title}</h3>${tableHTML}<button class="print-button" onclick="window.print()">인쇄</button></body></html>`);
                newWindow.document.close();
            },

            /**
             * (UI) 인쇄
             */
            printPage() {
                const editCell = document.querySelector('#section1 td.edit-mode');
                if (editCell) {
                    const { colId, dateString } = editCell.dataset;
                    const originalNames = this.state.scheduleData[dateString]?.[colId] || [{ text: '', bold: false }, { text: '', bold: false }];
                    editCell.classList.remove('edit-mode');
                    editCell.innerHTML = this.renderCellContent(originalNames);
                }

                document.documentElement.style.setProperty('--print-margin-left', `${this.ui.marginLeftSelect.value}mm`);
                document.documentElement.style.setProperty('--print-margin-right', `${this.ui.marginRightSelect.value}mm`);
                
                const originalTitle = document.title;
                const captionText = document.getElementById('tableCaption').textContent;
                let newTitle = "근무현황표";
                
                const matches = captionText.match(/\[(.*?)\] (\d{4})년 (\d{1,2})월 (\d{1,2})일 ~ (\d{1,2})일/);
                if (matches) {
                    newTitle = `${matches[1]} ${matches[2]}-${matches[3].padStart(2, '0')} (${matches[4].padStart(2, '0')}일-${matches[5].padStart(2, '0')}일)`;
                } else if (this.state.currentRoute) {
                    newTitle = `${this.state.currentRoute} 근무현황표`;
                }
                
                document.body.classList.remove('printing-section2', 'printing-section3'); 
                document.body.classList.add('printing-section1'); 

                const handleAfterPrint = () => {
                    document.title = originalTitle;
                    document.documentElement.style.removeProperty('--print-margin-left');
                    document.documentElement.style.removeProperty('--print-margin-right');
                    document.body.classList.remove('printing-section1'); 
                    window.removeEventListener('afterprint', handleAfterPrint);
                };
                window.addEventListener('afterprint', handleAfterPrint);
                
                document.title = newTitle;
                window.print();
            },
            
            /**
             * (UI) 폰트 크기 적용
             */
            applyFontSize(size) {
                if (parseFloat(size) < 8) size = '8pt';
                if (parseFloat(size) > 20) size = '20pt';
                document.documentElement.style.setProperty('--worker-font-size', size);
            },

            /**
             * (UI) 데이터 관리 옵션 핸들러
             */
            handleScheduleActions() {
                const action = this.ui.scheduleActionsSelect.value;
                if (action === 'reset') this.resetAllFixedSchedules();
                else if (action === 'backup') this.backupScheduleData();
                else if (action === 'restore') this.ui.restoreFile.click();
                this.ui.scheduleActionsSelect.value = '';
            },

            /**
             * [데이터 연동] 근무 형태 변경
             */
            handleWorkTypeChange() {
                const selectedValue = this.ui.vehicleSelect.value; 
                const workType = this.ui.workTypeSelect.value;
                
                if (!selectedValue || !workType) return;

                let workTypeName = '';
                if (workType === 'normal') workTypeName = '3/3 근무';
                else if (workType === 'biweekly') workTypeName = '격주 근무';
                else if (workType === 'five_day') workTypeName = '5일 근무';
                
                if (selectedValue === 'ALL_VEHICLES') {
                    const vehicleCount = this.state.currentVehicleColumns.filter(c => c !== '미입력').length;
                    if (vehicleCount === 0) {
                        alert('설정할 차량이 없습니다.');
                    } else if (confirm(`[${this.state.currentRoute}] 노선의 '미입력'을 제외한 *전체 차량* (${vehicleCount}대)의 근무형태를 [${workTypeName}]로 설정하고 저장하시겠습니까?`)) {
                        
                        DataManager.updateS1Data(s1_data => {
                            const routeData = s1_data.routes[this.state.currentRoute];
                            if (!routeData) return;
                            this.state.currentVehicleColumns.forEach(colId => {
                                if (colId !== '미입력') { 
                                   routeData.workTypeConfig[colId] = workType;
                                }
                            });
                            this.state.workTypeConfig = routeData.workTypeConfig;
                        });
                        alert(`[${this.state.currentRoute}] 노선의 전체 차량 근무형태가 [${workTypeName}]로 설정되었습니다. '고정' 저장 시 적용됩니다.`);
                    }
                } else {
                    const colId = selectedValue;
                    if (confirm(`차량 [${colId}]의 근무형태를 [${workTypeName}]로 설정하고 저장하시겠습니까?`)) {
                        
                        DataManager.updateS1Data(s1_data => {
                            const routeData = s1_data.routes[this.state.currentRoute];
                            if (!routeData) return;
                            routeData.workTypeConfig[colId] = workType;
                            this.state.workTypeConfig = routeData.workTypeConfig;
                        });
                        alert(`차량 [${colId}]의 근무형태가 [${workTypeName}]로 설정되었습니다. '고정' 저장 시 적용됩니다.`);
                    }
                }
                
                this.ui.vehicleSelect.value = '';
                this.ui.workTypeSelect.value = '';
            },
            
            /**
             * (UI) 노선 이동 드롭다운 핸들러
             */
            handleRouteSelectChange(routeName) {
                if (routeName) {
                    this.loadRouteData(routeName);
                }
            },

            /**
             * (UI) 섹션 이동
             */
            showSection(sectionId) {
                document.getElementById('section1').style.display = 'none';
                document.getElementById('section2').style.display = 'none';
                document.getElementById('section3').style.display = 'none';
                document.querySelector('.divider').style.display = 'none';
                
                const targetSection = document.getElementById(`section${sectionId.replace('S', '')}`);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    targetSection.scrollIntoView({ behavior: 'smooth' });
                }
            },

            /**
             * (UI) 전체 보기
             */
            showAllSections() {
                document.getElementById('section1').style.display = 'block';
                document.getElementById('section2').style.display = 'block';
                document.getElementById('section3').style.display = 'none'; // S3는 기본 숨김
                document.querySelector('.divider').style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },

            /**
             * (UI) 버전 정보 설정
             */
            setVersion() {
                try {
                    const url = window.location.pathname; 
                    const fileNameMatch = url.match(/[\w-]+\.html/i);
                    if (!fileNameMatch) {
                        document.getElementById('version-display').textContent = 'Ver 4.5.2-fix';
                        return;
                    }
                    const fileName = fileNameMatch[0]; 
                    const versionMatch = fileName.match(/(\d+\.\d+\.\d+)/);
                    if (versionMatch && versionMatch[1]) {
                        document.getElementById('version-display').textContent = 'Ver ' + versionMatch[1];
                    } else {
                        document.getElementById('version-display').textContent = 'Ver 4.5.2-fix';
                    }
                } catch (e) {
                    console.error("버전 정보를 읽어오는 데 실패했습니다.", e);
                    document.getElementById('version-display').textContent = 'Ver 4.5.2-fix';
                }
            }
        };

        
        /* ================================================================= */
        /* [Section 2] 승무 일지 JavaScript */
        /* ================================================================= */

        /**
         * 3. S2(승무일지) 모듈
         * - S1 데이터 변경 시(onDataChanged) S2 화면을 새로고침합니다.
         * - S2 근무자 수정 시 DataManager를 통해 S1 데이터를 수정합니다.
         * - S2 일지 데이터를 날짜별로 백업/복원합니다.
         */
        const S2_Module = {
            // S2 UI 요소
            ui: {
                headerTitle: document.querySelector('#section2 .header-title'),
                dateDisplay: document.getElementById('today-date'),
                fontSizeSelect: document.getElementById('font-size-select'),
                dispatchLogBody: document.getElementById('dispatch-log-body'),
                dispatchButtons: document.getElementById('dispatch-buttons'),
                // 모달
                restoreModal: document.getElementById('s2_restoreDateModal'),
                restoreFile: document.getElementById('s2_restoreFile'),
                restoreSelectedDate: document.getElementById('s2_restoreSelectedDate'),
                cancelRestoreBtn: document.getElementById('s2_cancelRestoreBtn'),
                confirmRestoreBtn: document.getElementById('s2_confirmRestoreBtn'),
            },

            // S2 내부 상태
            state: {
                s2_currentDate: new Date(), // S2는 기본적으로 '오늘' 날짜 기준
                s2_currentDispatchOrder: '1',
                S2_ROUTE_MAP: { // S1 노선명 -> S2 ID 매핑 (확장성)
                    '종로07번': '07',
                    '종로08번': '08',
                    '성동 3-1번': 'sd31',
                    '성동 3-2번': 'sd32'
                },
                S2_USED_VEHICLES: {}, // 현재 S2 화면에 표시된 차량 (차번 변경 시 중복 체크용)
                s2_draggedCell: null,
                s2_draggedRoute: null
            },

            /**
             * S2 모듈 초기화 (DOM 로드 시 1회 실행)
             */
            initialize() {
                console.log("S2: 초기화 시작");
                DataManager.subscribe(this); // DataManager에 S2 모듈 등록
                DataManager.loadS2Data();    // S2 전용 일지 데이터 로드

                this.bindEventListeners();
                this.changeDispatchOrder('1'); // 출차순서 기본값
                
                // S2의 오늘 날짜 표시
                this.ui.dateDisplay.textContent = this.getTodayDateString(this.state.s2_currentDate);

                // S1 데이터 기준으로 S2 화면 첫 그리기
                this.refreshDispatchLog();
                console.log("S2: 초기화 완료.");
            },

            /**
             * [핵심] DataManager로부터 알림을 처리하는 함수 (S1에서 데이터 변경 시)
             */
            onDataChanged(event, payload) {
                if (event === 's1_data_changed') {
                    console.log("[S2] S1로부터 데이터 변경 알림 수신. S2 갱신 시작.");
                    // S1 데이터(근무표)가 변경되었으므로 S2 화면(근무자)을 새로고침
                    this.refreshDispatchLog();
                }
            },

            /**
             * S2의 모든 이벤트 리스너 바인딩
             */
            bindEventListeners() {
                document.getElementById('s2-showAll').onclick = () => S1_Module.showAllSections();
                this.ui.dispatchButtons.onclick = (e) => {
                    if (e.target.classList.contains('dispatch-button')) {
                        this.changeDispatchOrder(e.target.dataset.order);
                    }
                };
                this.ui.fontSizeSelect.onchange = (e) => this.changeFontSize(e.target.value);
                
                // [수정] S2 백업/복원 버튼 연결
                document.getElementById('s2-backupLog').onclick = () => this.backupLogData();
                document.getElementById('s2-showRestoreModal').onclick = () => this.showRestoreModal();
                
                document.getElementById('s2-refreshLog').onclick = () => this.refreshDispatchLog();
                document.getElementById('s2-printPage').onclick = () => this.printPage();

                // 복원 모달 이벤트
                this.ui.cancelRestoreBtn.onclick = () => this.hideRestoreModal();
                this.ui.confirmRestoreBtn.onclick = () => this.triggerRestore();
                this.ui.restoreFile.onchange = (e) => {
                    const file = e.target.files[0];
                    const selectedDate = this.ui.restoreSelectedDate.value;
                    if (file && selectedDate) {
                        this.restoreLogData(file, selectedDate);
                        this.hideRestoreModal();
                    } else if (!selectedDate) {
                        alert("파일을 적용할 날짜를 먼저 선택해주세요.");
                    }
                };

                // (동적 생성 요소 이벤트는 dispatchLogBody에 위임)
                const logBody = this.ui.dispatchLogBody;
                logBody.onclick = (e) => {
                    const carCell = e.target.closest('.car-number-cell');
                    const driverCell = e.target.closest('td[data-edit-type="driver"]');
                    if (carCell) {
                        e.preventDefault();
                        const routeName = carCell.closest('.route-section').dataset.routeName;
                        this.toggleCarNumberEditMode(carCell, routeName);
                        return;
                    }
                    if (driverCell) {
                        e.preventDefault();
                        this.toggleEditMode(driverCell);
                        return;
                    }
                };
                logBody.onmousedown = (e) => {
                    const carControlBtn = e.target.closest('.car-controls button');
                    if (carControlBtn) {
                        e.preventDefault();
                        const td = carControlBtn.closest('.car-number-cell');
                        if (carControlBtn.classList.contains('btn-car-delete')) {
                            this.deleteCarRow(td);
                        } else if (carControlBtn.classList.contains('btn-car-close')) {
                            this.exitCarNumberEditMode(td);
                        }
                        return;
                    }
                    const driverControlBtn = e.target.closest('.edit-controls button');
                    if (driverControlBtn) {
                        e.preventDefault();
                        const td = driverControlBtn.closest('td[data-edit-type="driver"]');
                        if (driverControlBtn.classList.contains('btn-driver-delete')) {
                            this.deleteName(td);
                        } else if (driverControlBtn.classList.contains('btn-driver-save')) {
                            this.saveAndExit(td);
                        }
                        return;
                    }
                    const settingBtn = e.target.closest('.setting-button');
                    if(settingBtn) {
                        e.preventDefault();
                        const routeId = settingBtn.dataset.routeId;
                        if (settingBtn.classList.contains('apply-button')) {
                            this.applyScheduleSettings(routeId);
                        } else if (settingBtn.classList.contains('reset-button')) {
                            this.resetScheduleSettings(routeId);
                        }
                        return;
                    }
                };
                logBody.onchange = (e) => {
                    if (e.target.classList.contains('car-select-dropdown')) {
                        e.stopPropagation();
                        const routeName = e.target.closest('.route-section').dataset.routeName;
                        this.changeCarNumber(e.target, routeName);
                    }
                };
                logBody.ondragstart = (e) => {
                    const cell = e.target.closest('td.car-number-cell');
                    if (cell) {
                        const routeName = cell.closest('.route-section').dataset.routeName;
                        this.dragStart(e, routeName);
                    }
                };
                logBody.ondragover = (e) => this.dragOver(e);
                logBody.ondrop = (e) => {
                    const cell = e.target.closest('td.car-number-cell');
                    if (cell) {
                        const routeName = cell.closest('.route-section').dataset.routeName;
                        this.drop(e, routeName);
                    }
                };
                logBody.ondragend = (e) => this.dragEnd(e);
            },

            // --- S2 UI/상태 관리 ---
            getTodayDateString(dateObj) {
                return (dateObj || this.state.s2_currentDate).toLocaleDateString('ko-KR', { 
                    year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'long' 
                }).replace(/\. /g, '.').replace(/\.$/, '').replace(/(\d{4})년 (\d{2})월 (\d{2})일/,'$1년 $2월 $3일');
            },
            changeFontSize(size) {
                document.getElementById('section2').style.fontSize = size + 'pt';
            },
            changeDispatchOrder(order) {
                if (!order) return;
                this.state.s2_currentDispatchOrder = order;
                this.ui.dispatchButtons.querySelectorAll('.dispatch-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.order === order);
                });
            },
            printPage() {
                document.body.classList.remove('printing-section1', 'printing-section3');
                document.body.classList.add('printing-section2'); 
                const handleAfterPrint = () => {
                    document.body.classList.remove('printing-section2');
                    window.removeEventListener('afterprint', handleAfterPrint);
                };
                window.addEventListener('afterprint', handleAfterPrint);
                window.print();
            },
            sanitizeForId(text) {
                if (!text) return 'unknown';
                const s2_id = this.state.S2_ROUTE_MAP[text];
                if (s2_id) return s2_id;
                const match = text.match(/\d+/);
                if (match) return match[0];
                return text.toLowerCase().replace(/[^a-z0-9]/g, ''); 
            },

            // --- S2 핵심 기능: 화면 그리기 ---
            refreshDispatchLog() {
                console.log("[S2] 승무일지 새로고침 시작...");
                
                const { routeData: currentS1RouteData } = DataManager.getCurrentRouteData();
                const s1_companyName = currentS1RouteData ? currentS1RouteData.companyName : "승무일지";
                this.ui.headerTitle.textContent = `${s1_companyName} 승무일지`;

                // S2는 s2_currentDate (기본: 오늘) 기준
                const dateString = this.state.s2_currentDate.toISOString().slice(0, 10);
                const dayOfWeek = this.state.s2_currentDate.getDay();
                
                const allRoutes = DataManager.getAllRoutes();
                const s2_logData = DataManager.data.s2[dateString] || {}; // 오늘 날짜의 S2 데이터
                
                const container = this.ui.dispatchLogBody;
                container.innerHTML = ''; 
                
                for (const routeName in allRoutes) {
                    const routeData = allRoutes[routeName];
                    if (!routeData) continue;
                    
                    const routeId = this.sanitizeForId(routeName);
                    
                    // 1. S1 근무표 데이터 계산
                    const todayS1Schedule = this.getTodayS1Schedule(routeData, dateString, dayOfWeek);
                    // 2. S2 저장된 데이터 (시간 등)
                    const todayS2RouteLog = s2_logData[routeName] || {};

                    const vehicleColumns = routeData.vehicleColumns || [];
                    const validVehicles = vehicleColumns.filter(v => v && v !== '미입력');
                    
                    const tableHeader = this.createTableHeaderHTML(routeId);
                    let tableBodyHTML = '';
                    const halfCount = Math.ceil(validVehicles.length / 2);

                    for (let i = 0; i < halfCount; i++) {
                        const leftCar = validVehicles[i] || '미입력';
                        const rightCar = validVehicles[i + halfCount] || '미입력';
                        
                        const leftHTML = this.createRowSideHTML(routeName, leftCar, todayS1Schedule, todayS2RouteLog);
                        const rightHTML = this.createRowSideHTML(routeName, rightCar, todayS1Schedule, todayS2RouteLog);
                        
                        tableBodyHTML += `<tr>${leftHTML}${rightHTML}</tr>`;
                    }
                    
                    const s2_optionsHTML = this.createOptionsHTML(routeId, validVehicles);

                    container.insertAdjacentHTML('beforeend', `
                        <div class="route-section" id="route-${routeId}" data-route-name="${routeName}">
                            <div class="route-header-flex">
                                <div class="route-title-group">
                                    <div class="route-name-text">${routeName}</div>
                                </div>
                                ${s2_optionsHTML}
                            </div>
                            <table class="journal-table">
                                ${tableHeader}
                                <tbody>${tableBodyHTML}</tbody>
                            </table>
                        </div>
                    `);
                } 
                console.log("[S2] 승무일지 새로고침 완료.");
            },
            
            /**
             * (Util) S1 데이터로부터 특정 날짜의 근무표 계산 (refreshDispatchLog에서 사용)
             */
            getTodayS1Schedule(routeData, dateString, dayOfWeek) {
                const tempSchedule = routeData.tempSchedule || {};
                const fixedSchedule = routeData.fixedSchedule || {};
                const vehicleColumns = routeData.vehicleColumns || [];
                let todayData = {};
                
                vehicleColumns.forEach(colId => {
                    if (colId === '미입력') return;
                    // 1. 임시 데이터 우선
                    if (tempSchedule[dateString] && tempSchedule[dateString][colId]) {
                        todayData[colId] = JSON.parse(JSON.stringify(tempSchedule[dateString][colId]));
                    } 
                    // 2. 임시 없으면 고정 데이터
                    else {
                        const recurringKey = `${dayOfWeek}-${colId}`;
                        if (fixedSchedule[recurringKey]) {
                            for (const entry of fixedSchedule[recurringKey]) {
                                if (new Date(dateString) >= new Date(entry.dateString)) {
                                    todayData[colId] = JSON.parse(JSON.stringify(entry.names));
                                    break;
                                }
                            }
                        }
                    }
                });
                return todayData;
            },
/**
             * (Util) 고정 근무자 정보 조회 (휴무자 표시용)
             */
            getFixedWorkersForCar(routeData, carNumber, dayOfWeek) {
                const fixedSchedule = routeData.fixedSchedule || {};
                let fixedNames = [{ text: '' }, { text: '' }];
                const recurringKey = `${dayOfWeek}-${carNumber}`;
                
                if (fixedSchedule[recurringKey] && fixedSchedule[recurringKey].length > 0) {
                     fixedNames = fixedSchedule[recurringKey][0].names;
                }
                return fixedNames;
            },


            // --- S2 HTML 생성 헬퍼 ---

            createTableHeaderHTML(routeId) {
                return `
                    <colgroup>
                        <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;">
                        <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;">
                        <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;">
                        <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;"> <col style="width: 5.4%;">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>차번</th> <th>오전출발</th> <th>근무<br>시간</th> <th>오전근무</th>
                            <th>오후출발</th> <th>근무<br>시간</th> <th>오후근무</th> <th>휴무자</th>
                            <th>차번</th> <th>오전출발</th> <th>근무<br>시간</th> <th>오전근무</th>
                            <th>오후출발</th> <th>근무<br>시간</th> <th>오후근무</th> <th>휴무자</th>
                        </tr>
                    </thead>
                `;
            },
            
            createOptionsHTML(routeId, vehicleNumbers) {
                const validVehicles = vehicleNumbers.filter(v => v && v !== '미입력');
                const vehicleOptions = validVehicles.map(v => `<option value="${v}">${v}</option>`).join('');
                
                return `
                    <div class="schedule-options">
                        <div class="am-options">
                            <span>[오전]</span>
                            <select name="vehicle_select_${routeId}_am"><option value="">첫차</option>${vehicleOptions}</select>
                            <input type="number" name="hour_${routeId}_am" min="0" max="23">시
                            <input type="number" name="minute_${routeId}_am" min="0" max="59">분
                            (배차간격 <input type="number" name="interval_${routeId}_am" min="0">분)
                        </div>
                        <div class="pm-options">
                            <span>[오후]</span>
                            <select name="vehicle_select_${routeId}_pm"><option value="">막차</option>${vehicleOptions}</select>
                            <input type="number" name="hour_${routeId}_pm" min="0" max="23">시
                            <input type="number" name="minute_${routeId}_pm" min="0" max="59">분
                            (배차간격 <input type="number" name="interval_${routeId}_pm" min="0">분)
                        </div>
                    </div>
                    <div class="settings-controls">
                        <button type="button" class="setting-button apply-button" data-route-id="${routeId}">시간 적용</button>
                        <button type="button" class="setting-button reset-button" data-route-id="${routeId}">초기화</button>
                    </div>
                `;
            },

            createRowSideHTML(routeName, carNumber, todayS1Schedule, todayS2RouteLog) {
                const routeId = this.sanitizeForId(routeName); 
                
                if (!carNumber || carNumber === '미입력') {
                    return '<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>';
                }

                // S1 근무표 데이터
                const s1CarData = todayS1Schedule[carNumber] || [{ text: '' }, { text: '' }];
                const amDriver = (s1CarData[0].text || '').replace(/\n/g, '<br>');
                const pmDriver = (s1CarData[1].text || '').replace(/\n/g, '<br>');
                const isRest = (amDriver.includes('휴무') || pmDriver.includes('휴무'));
                
                let s2_amDriver_html = isRest ? '' : amDriver;
                let s2_pmDriver_html = isRest ? '' : pmDriver;
                let s2_restDriver_html = '';

                if (isRest) {
                    if (amDriver && !amDriver.includes('휴무')) s2_restDriver_html = amDriver;
                    else if (pmDriver && !pmDriver.includes('휴무')) s2_restDriver_html = pmDriver;
                    else s2_restDriver_html = '휴무';
                } 
                else if (!amDriver && !pmDriver) {
                    try {
                        const dayOfWeek = this.state.s2_currentDate.getDay(); 
                        const routeData = DataManager.getAllRoutes()[routeName];
                        if (routeData) {
                            const fixedWorkers = this.getFixedWorkersForCar(routeData, carNumber, dayOfWeek);
                            const fixedAm = (fixedWorkers[0].text || '');
                            const fixedPm = (fixedWorkers[1].text || '');

                            if (fixedAm && fixedPm && !fixedAm.includes('휴무') && !fixedPm.includes('휴무')) {
                                s2_restDriver_html = `${fixedAm}<br>${fixedPm}`;
                            } else if (fixedAm && !fixedAm.includes('휴무')) {
                                s2_restDriver_html = fixedAm;
                            } else if (fixedPm && !fixedPm.includes('휴무')) {
                                s2_restDriver_html = fixedPm;
                            }
                        }
                    } catch (e) { console.error(`[${carNumber}] 휴무자 자동 계산 오류:`, e); }
                }

                // S2 승무일지 데이터 (시간, 근무시간)
                const s2CarLog = todayS2RouteLog[carNumber] || {};
                const amStartTime = s2CarLog[`start_time_${routeId}_${carNumber}_am`] || '';
                const amWorkHours = s2CarLog[`work_hours_${routeId}_${carNumber}_am`] || '';
                const pmStartTime = s2CarLog[`start_time_${routeId}_${carNumber}_pm`] || '';
                const pmWorkHours = s2CarLog[`work_hours_${routeId}_${carNumber}_pm`] || '';

                const workHoursSelect = `
                    <option value="" selected>기본</option>
                    ${Array.from({length: 19}, (_, i) => `<option value="${i}" ${amWorkHours == i ? 'selected' : ''}>${i}</option>`).join('')}
                `;
                const workHoursSelectPM = `
                    <option value="" selected>기본</option>
                    ${Array.from({length: 19}, (_, i) => `<option value="${i}" ${pmWorkHours == i ? 'selected' : ''}>${i}</option>`).join('')}
                `;

                return `
                    <td class="car-number-cell" data-car-number="${carNumber}" draggable="true">
                        <div class="car-display">${carNumber}</div>
                        <div class="car-controls hidden">
                            <select class="car-select-dropdown"></select>
                            <div>
                                <button class="btn-car-delete">삭제</button>
                                <button class="btn-car-close">닫기</button>
                            </div>
                        </div>
                    </td>
                    <td><input type="text" name="start_time_${routeId}_${carNumber}_am" value="${amStartTime}"></td>
                    <td>
                        <select name="work_hours_${routeId}_${carNumber}_am" class="s2-work-hours-select">
                            ${workHoursSelect}
                        </select>
                    </td>
                    <td data-edit-type="driver" data-driver-type="am_driver" data-car-number="${carNumber}">
                        <span class="driver-name">${s2_amDriver_html}</span>
                        <textarea class="driver-input hidden"></textarea>
                        <div class="edit-controls hidden">
                            <button class="btn-driver-delete">삭제</button>
                            <button class="btn-driver-save">수정</button>
                        </div>
                    </td>
                    <td><input type="text" name="start_time_${routeId}_${carNumber}_pm" value="${pmStartTime}"></td>
                    <td>
                        <select name="work_hours_${routeId}_${carNumber}_pm" class="s2-work-hours-select">
                            ${workHoursSelectPM}
                        </select>
                    </td> 
                    <td data-edit-type="driver" data-driver-type="pm_driver" data-car-number="${carNumber}">
                        <span class="driver-name">${s2_pmDriver_html}</span>
                        <textarea class="driver-input hidden"></textarea>
                        <div class="edit-controls hidden">
                            <button class="btn-driver-delete">삭제</button>
                            <button class="btn-driver-save">수정</button>
                        </div>
                    </td> 
                    <td data-edit-type="driver" data-driver-type="rest_driver" data-car-number="${carNumber}">
                        <span class="driver-name">${s2_restDriver_html}</span>
                        <textarea class="driver-input hidden"></textarea>
                        <div class="edit-controls hidden">
                            <button class="btn-driver-delete">삭제</button>
                            <button class="btn-driver-save">수정</button>
                        </div>
                    </td> 
                `;
            },

            // --- S2 차번 변경/삭제 (S1 연동 없음, S2 화면에서만) ---
            getUsedCarNumbers(routeId) {
                const used = [];
                document.querySelectorAll(`#route-${routeId} .car-number-cell`).forEach(cell => {
                    const carNum = cell.dataset.carNumber;
                    if (carNum) used.push(carNum);
                });
                this.state.S2_USED_VEHICLES[routeId] = used;
                return used;
            },
            toggleCarNumberEditMode(td, routeName) {
                const carDisplay = td.querySelector('.car-display');
                const carControls = td.querySelector('.car-controls');
                if (!carControls || !carDisplay) return;
                const carSelect = carControls.querySelector('select');
                this.closeAllEditModes(td);
                if (carControls.classList.contains('hidden')) {
                    carDisplay.classList.add('hidden');
                    carControls.classList.remove('hidden');
                    this.populateCarSelect(carSelect, routeName, td.dataset.carNumber);
                }
            },
            exitCarNumberEditMode(td) {
                if (!td) return;
                const carDisplay = td.querySelector('.car-display');
                const carControls = td.querySelector('.car-controls');
                if (carDisplay) carDisplay.classList.remove('hidden');
                if (carControls) carControls.classList.add('hidden');
            },
            
            /**
             * (Util) S2 차번 변경 시 사용 가능한 차량 목록 채우기
             */
            populateCarSelect(selectElement, routeName, currentCar) {
                const routeData = DataManager.getAllRoutes()[routeName];
                if (!routeData) return;
                const allVehicles = routeData.vehicleColumns || [];
                const routeId = this.sanitizeForId(routeName);
                const usedVehicles = this.getUsedCarNumbers(routeId);
                
                selectElement.innerHTML = `<option value="${currentCar}">${currentCar} (현재)</option>`;
                allVehicles.forEach(v => {
                    if (v && v !== '미입력' && v !== currentCar && !usedVehicles.includes(v)) {
                        selectElement.innerHTML += `<option value="${v}">${v}</option>`;
                    }
                });
                selectElement.innerHTML += `<option value="" style="color:red; font-weight:bold;">[이 줄에서 삭제]</option>`;
            },

            /**
             * (UI) S2 차번 변경 (S1 근무자 데이터 연동)
             */
            changeCarNumber(selectElement, routeName) {
                const newCarNumber = selectElement.value;
                const td = selectElement.closest('.car-number-cell');
                if (!td) return;
                const oldCarNumber = td.dataset.carNumber;
                
                if (newCarNumber === "") {
                    this.deleteCarRow(td);
                    return;
                }
                
                if (newCarNumber === oldCarNumber) {
                    this.exitCarNumberEditMode(td);
                    return;
                }

                const dateString = this.state.s2_currentDate.toISOString().slice(0, 10);
                
                // 1. S2 로그 데이터(시간 등) 마이그레이션
                DataManager.updateS2Data(s2_data => {
                    if(!s2_data[dateString]) s2_data[dateString] = {};
                    if(!s2_data[dateString][routeName]) s2_data[dateString][routeName] = {};
                    const s2CarLog = s2_data[dateString][routeName];
                    if (s2CarLog[oldCarNumber]) {
                        s2CarLog[newCarNumber] = s2CarLog[oldCarNumber];
                        delete s2CarLog[oldCarNumber];
                    }
                });
                
                // 2. S1 데이터(근무자)를 새 차번에 맞게 다시 가져와서 행 재구성
                const routeData = DataManager.getAllRoutes()[routeName];
                const dayOfWeek = this.state.s2_currentDate.getDay();
                const todayS1Schedule = this.getTodayS1Schedule(routeData, dateString, dayOfWeek);
                const s2LogData = DataManager.data.s2[dateString] || {};
                const todayS2RouteLog = s2LogData[routeName] || {};

                const tr = td.closest('tr');
                const cellIndex = td.cellIndex;
                
                let newSideHTML = this.createRowSideHTML(routeName, newCarNumber, todayS1Schedule, todayS2RouteLog);
                let startIndex = (cellIndex === 0) ? 0 : 8; // 0 (왼쪽) 또는 8 (오른쪽)

                // 8개의 <td> HTML을 파싱하여 기존 셀 교체
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = `<table><tbody><tr>${newSideHTML}</tr></tbody></table>`;
                const newCells = Array.from(tempDiv.querySelector('tr').cells);
                
                for(let i=0; i<8; i++) {
                    tr.cells[startIndex + i].replaceWith(newCells[i].cloneNode(true));
                }
            },

            /**
             * (UI) S2 차번 삭제 (S1 연동 없음, S2 화면에서만)
             */
            deleteCarRow(td) {
                if (!confirm(`[${td.dataset.carNumber}] 차량을 이 줄에서 삭제(숨김)하시겠습니까? (S1 근무표에는 영향이 없습니다.)`)) {
                    this.exitCarNumberEditMode(td);
                    return;
                }
                
                const routeName = td.closest('.route-section').dataset.routeName;
                const oldCarNumber = td.dataset.carNumber;
                const dateString = this.state.s2_currentDate.toISOString().slice(0, 10);

                // S2 데이터에서 삭제
                DataManager.updateS2Data(s2_data => {
                     if (s2_data[dateString]?.[routeName]?.[oldCarNumber]) {
                        delete s2_data[dateString][routeName][oldCarNumber];
                    }
                });

                // 8개 셀을 공백으로 교체
                const tr = td.closest('tr');
                const cellIndex = td.cellIndex;
                const blankHTML = '<td></td>'.repeat(8);
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = `<table><tbody><tr>${blankHTML}</tr></tbody></table>`;
                const newCells = Array.from(tempDiv.querySelector('tr').cells);
                
                const startIndex = (cellIndex === 0) ? 0 : 8;
                for(let i=0; i<8; i++) {
                    tr.cells[startIndex + i].replaceWith(newCells[i].cloneNode(true));
                }
            },
            
            /**
             * (Util) 모든 S2 편집창 닫기
             */
            closeAllEditModes(exceptCell = null) {
                document.querySelectorAll('#section2 td.car-number-cell').forEach(td => {
                    if (td !== exceptCell) this.exitCarNumberEditMode(td);
                });
                document.querySelectorAll('#section2 td[data-edit-type="driver"]').forEach(td => {
                    if (td !== exceptCell) this.exitEditMode(td);
                });
            },

            // --- S2 근무자 이름 변경 (S1 연동) ---
            
            /**
             * (UI) 근무자 이름 편집 모드 진입
             */
            toggleEditMode(td) {
                this.closeAllEditModes(td); // 다른 편집창 닫기
                const span = td.querySelector('.driver-name');
                const textarea = td.querySelector('.driver-input');
                const controls = td.querySelector('.edit-controls');
                
                span.classList.add('hidden');
                textarea.classList.remove('hidden');
                controls.classList.remove('hidden');
                
                // <br> 태그를 줄바꿈(\n)으로 변경하여 textarea에 설정
                textarea.value = span.innerText; 
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
                textarea.focus();
            },
            
            /**
             * (UI) 근무자 이름 편집 모드 종료
             */
            exitEditMode(td) {
                if (!td) return;
                const span = td.querySelector('.driver-name');
                const textarea = td.querySelector('.driver-input');
                const controls = td.querySelector('.edit-controls');
                
                span.classList.remove('hidden');
                textarea.classList.add('hidden');
                controls.classList.add('hidden');
            },
            
            /**
             * (UI) 근무자 이름 '수정' (S1 연동)
             */
            saveAndExit(td) {
                const routeName = td.closest('.route-section').dataset.routeName;
                const carNumber = td.dataset.carNumber;
                const driverType = td.dataset.driverType; // am_driver, pm_driver, rest_driver
                const textarea = td.querySelector('.driver-input');
                const span = td.querySelector('.driver-name');
                
                const newName = textarea.value.trim();
                span.innerHTML = newName.replace(/\n/g, '<br>'); // 줄바꿈을 <br>로 변경하여 표시
                
                this.updateS1DataFromS2(routeName, carNumber, driverType, newName);
                this.exitEditMode(td);
            },
            
            /**
             * (UI) 근무자 이름 '삭제' (S1 연동)
             */
            deleteName(td) {
                const routeName = td.closest('.route-section').dataset.routeName;
                const carNumber = td.dataset.carNumber;
                const driverType = td.dataset.driverType;
                const span = td.querySelector('.driver-name');
                
                span.innerHTML = ''; // 화면에서 삭제
                
                this.updateS1DataFromS2(routeName, carNumber, driverType, '');
                this.exitEditMode(td);
            },
            
            /**
             * [핵심] S2(승무일지) 수정 -> S1(근무표) '임시' 데이터 업데이트
             */
            updateS1DataFromS2(routeName, carNumber, driverType, newName) {
                const dateString = this.state.s2_currentDate.toISOString().slice(0, 10);
                
                // S2에서의 수정은 항상 S1의 '임시' 데이터를 수정/생성합니다.
                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[routeName];
                    if (!routeData) return;
                    
                    if (!routeData.tempSchedule[dateString]) {
                        routeData.tempSchedule[dateString] = {};
                    }
                    
                    // 1. 해당 날짜/차량의 현재 S1 데이터(임시 또는 고정)를 가져옵니다.
                    const dayOfWeek = this.state.s2_currentDate.getDay();
                    let s1Names = [{ text: '', bold: false }, { text: '', bold: false }];
                    
                    if (routeData.tempSchedule[dateString][carNumber]) {
                        // 이미 임시 데이터가 있으면 그걸 사용
                        s1Names = routeData.tempSchedule[dateString][carNumber];
                    } else {
                        // 없으면 고정 데이터를 복사해옴
                        const recurringKey = `${dayOfWeek}-${carNumber}`;
                        if (routeData.fixedSchedule[recurringKey]) {
                            for (const entry of routeData.fixedSchedule[recurringKey]) {
                                if (new Date(dateString) >= new Date(entry.dateString)) {
                                    s1Names = JSON.parse(JSON.stringify(entry.names)); // Deep copy
                                    break;
                                }
                            }
                        }
                    }

                    // 2. S2에서 수정한 필드에 따라 S1 데이터를 변경
                    if (driverType === 'am_driver') {
                        s1Names[0].text = newName;
                    } else if (driverType === 'pm_driver') {
                        s1Names[1].text = newName;
                    } else if (driverType === 'rest_driver') {
                        // '휴무자' 필드 수정 시
                        if (newName && newName !== '휴무') {
                             s1Names[0].text = newName; // 휴무자를 오전에 배정
                             s1Names[1].text = '휴무';   // 오후를 휴무 처리
                        } else if (newName === '휴무') {
                             s1Names[0].text = '휴무';   // 둘 다 휴무 처리
                             s1Names[1].text = '휴무';
                        } else {
                             // 휴무자 필드를 비우면 S1도 비움
                            s1Names[0].text = '';
                            s1Names[1].text = '';
                        }
                    }
                    
                    // 3. S1 임시 데이터로 저장
                    routeData.tempSchedule[dateString][carNumber] = s1Names;
                });
                
                console.log(`[S2] S1 임시데이터 업데이트 완료: [${routeName}] ${dateString} / ${carNumber}`);
                // DataManager.updateS1Data()가 's1_data_changed' 이벤트를 발생시키고,
                // S2의 onDataChanged가 this.refreshDispatchLog()를 호출하여 화면을 갱신합니다.
            },
            
            // --- S2 드래그 앤 드롭 (차번 교환) ---
            
            dragStart(e, routeName) {
                this.state.s2_draggedCell = e.target.closest('td.car-number-cell');
                this.state.s2_draggedRoute = routeName;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', e.target.dataset.carNumber);
                e.target.style.opacity = '0.5';
            },
            
            dragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            },
            
            drop(e, routeName) {
                e.preventDefault();
                const targetCell = e.target.closest('td.car-number-cell');
                const draggedCell = this.state.s2_draggedCell;
                
                if (!targetCell || !draggedCell || targetCell === draggedCell || this.state.s2_draggedRoute !== routeName) {
                    if (draggedCell) draggedCell.style.opacity = '1';
                    return;
                }
                
                // 교환할 두 차량 번호
                const car1 = draggedCell.dataset.carNumber;
                const car2 = targetCell.dataset.carNumber;
                const dateString = this.state.s2_currentDate.toISOString().slice(0, 10);

                // 1. S2 로그 데이터(시간 등) 교환
                DataManager.updateS2Data(s2_data => {
                    if(!s2_data[dateString]) s2_data[dateString] = {};
                    if(!s2_data[dateString][routeName]) s2_data[dateString][routeName] = {};
                    const s2CarLog = s2_data[dateString][routeName];
                    
                    const tempLog = s2CarLog[car1] || {};
                    s2CarLog[car1] = s2CarLog[car2] || {};
                    s2CarLog[car2] = tempLog;
                });

                // 2. S1 데이터(근무자) 교환
                const routeData = DataManager.getAllRoutes()[routeName];
                const dayOfWeek = this.state.s2_currentDate.getDay();
                const todayS1Schedule = this.getTodayS1Schedule(routeData, dateString, dayOfWeek);
                
                // S1 근무자 정보 가져오기 (교환 전)
                const s1Car1Data = todayS1Schedule[car1] ? JSON.parse(JSON.stringify(todayS1Schedule[car1])) : [{ text: '' }, { text: '' }];
                const s1Car2Data = todayS1Schedule[car2] ? JSON.parse(JSON.stringify(todayS1Schedule[car2])) : [{ text: '' }, { text: '' }];

                // S1 임시 데이터로 교환하여 저장
                DataManager.updateS1Data(s1_data => {
                    const routeData = s1_data.routes[routeName];
                    if (!routeData) return;
                    if (!routeData.tempSchedule[dateString]) routeData.tempSchedule[dateString] = {};
                    
                    routeData.tempSchedule[dateString][car1] = s1Car2Data;
                    routeData.tempSchedule[dateString][car2] = s1Car1Data;
                });
                
                // updateS1Data가 이벤트를 발생시켜 S2 화면을 새로고침하므로
                // 수동으로 DOM을 조작할 필요 없이 refreshDispatchLog()가 실행됩니다.
            },
            
            dragEnd(e) {
                if(this.state.s2_draggedCell) {
                    this.state.s2_draggedCell.style.opacity = '1';
                }
                this.state.s2_draggedCell = null;
                this.state.s2_draggedRoute = null;
            },
            
            // --- S2 시간 일괄 적용 ---
            
            applyScheduleSettings(routeId) {
                const routeName = document.getElementById(`route-${routeId}`).dataset.routeName;
                const amStartVehicle = document.querySelector(`select[name="vehicle_select_${routeId}_am"]`).value;
                const amHour = document.querySelector(`input[name="hour_${routeId}_am"]`).value;
                const amMin = document.querySelector(`input[name="minute_${routeId}_am"]`).value;
                const amInterval = parseInt(document.querySelector(`input[name="interval_${routeId}_am"]`).value);
                
                const pmStartVehicle = document.querySelector(`select[name="vehicle_select_${routeId}_pm"]`).value;
                const pmHour = document.querySelector(`input[name="hour_${routeId}_pm"]`).value;
                const pmMin = document.querySelector(`input[name="minute_${routeId}_pm"]`).value;
                const pmInterval = parseInt(document.querySelector(`input[name="interval_${routeId}_pm"]`).value);

                const amStartTime = (amHour || amMin) ? `${amHour.padStart(2, '0')}:${amMin.padStart(2, '0')}` : '';
                const pmStartTime = (pmHour || pmMin) ? `${pmHour.padStart(2, '0')}:${pmMin.padStart(2, '0')}` : '';
                
                const dateString = this.state.s2_currentDate.toISOString().slice(0, 10);
                
                DataManager.updateS2Data(s2_data => {
                    if (!s2_data[dateString]) s2_data[dateString] = {};
                    if (!s2_data[dateString][routeName]) s2_data[dateString][routeName] = {};
                    const s2RouteLog = s2_data[dateString][routeName];
                    
                    // 1. 특정 차량 시작 시간 설정
                    if (amStartVehicle && amStartTime) {
                        if (!s2RouteLog[amStartVehicle]) s2RouteLog[amStartVehicle] = {};
                        s2RouteLog[amStartVehicle][`start_time_${routeId}_${amStartVehicle}_am`] = amStartTime;
                    }
                    if (pmStartVehicle && pmStartTime) {
                        if (!s2RouteLog[pmStartVehicle]) s2RouteLog[pmStartVehicle] = {};
                        s2RouteLog[pmStartVehicle][`start_time_${routeId}_${pmStartVehicle}_pm`] = pmStartTime;
                    }

                    // 2. 배차 간격 일괄 적용 (간격이 0보다 클 때)
                    const allCarCells = Array.from(document.querySelectorAll(`#route-${routeId} .car-number-cell`));
                    
                    if (amInterval > 0 && amStartTime) {
                        let currentAmTime = new Date(`${dateString}T${amStartTime}`);
                        allCarCells.forEach(cell => {
                            const car = cell.dataset.carNumber;
                            if (car) {
                                if (!s2RouteLog[car]) s2RouteLog[car] = {};
                                const timeStr = `${currentAmTime.getHours().toString().padStart(2, '0')}:${currentAmTime.getMinutes().toString().padStart(2, '0')}`;
                                s2RouteLog[car][`start_time_${routeId}_${car}_am`] = timeStr;
                                currentAmTime.setMinutes(currentAmTime.getMinutes() + amInterval);
                            }
                        });
                    }
                    
                    if (pmInterval > 0 && pmStartTime) {
                        let currentPmTime = new Date(`${dateString}T${pmStartTime}`);
                        allCarCells.forEach(cell => {
                            const car = cell.dataset.carNumber;
                            if (car) {
                                if (!s2RouteLog[car]) s2RouteLog[car] = {};
                                const timeStr = `${currentPmTime.getHours().toString().padStart(2, '0')}:${currentPmTime.getMinutes().toString().padStart(2, '0')}`;
                                s2RouteLog[car][`start_time_${routeId}_${car}_pm`] = timeStr;
                                currentPmTime.setMinutes(currentPmTime.getMinutes() + pmInterval);
                            }
                        });
                    }
                });
                
                // 화면 새로고침
                this.refreshDispatchLog();
                alert(`[${routeName}] 배차시간이 적용되었습니다.`);
            },
            
            resetScheduleSettings(routeId) {
                if (!confirm('정말 이 노선의 배차시간을 모두 초기화하시겠습니까? (근무자는 변경되지 않습니다.)')) return;
                
                const routeName = document.getElementById(`route-${routeId}`).dataset.routeName;
                const dateString = this.state.s2_currentDate.toISOString().slice(0, 10);
                
                DataManager.updateS2Data(s2_data => {
                    if (s2_data[dateString]?.[routeName]) {
                        const s2RouteLog = s2_data[dateString][routeName];
                        for(const car in s2RouteLog) {
                            delete s2RouteLog[car][`start_time_${routeId}_${car}_am`];
                            delete s2RouteLog[car][`work_hours_${routeId}_${car}_am`];
                            delete s2RouteLog[car][`start_time_${routeId}_${car}_pm`];
                            delete s2RouteLog[car][`work_hours_${routeId}_${car}_pm`];
                        }
                    }
                });
                
                this.refreshDispatchLog();
            },
            
            // --- S2 데이터 백업/복원 (날짜 기준) ---
            
            backupLogData() {
                const dateString = this.state.s2_currentDate.toISOString().slice(0, 10);
                const s2_logData = DataManager.data.s2[dateString];
                if (!s2_logData || Object.keys(s2_logData).length === 0) {
                    alert(`[${dateString}] 백업할 승무일지 데이터가 없습니다.`);
                    return;
                }
                
                const jsonString = JSON.stringify(s2_logData);
                const filename = `bus_dispatch_log_${dateString}.json`;
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                alert(`[${dateString}] 날짜의 승무일지 데이터가 저장되었습니다.`);
            },
            
            showRestoreModal() {
                this.ui.restoreSelectedDate.value = this.state.s2_currentDate.toISOString().slice(0, 10);
                this.ui.restoreModal.style.display = 'block';
            },
            
            hideRestoreModal() {
                this.ui.restoreModal.style.display = 'none';
                this.ui.restoreFile.value = '';
            },
            
            triggerRestore() {
                if (!this.ui.restoreSelectedDate.value) {
                    alert('데이터를 복원할 날짜를 선택해주세요.');
                    return;
                }
                this.ui.restoreFile.click();
            },
            
            restoreLogData(file, targetDateString) {
                if (!file || !targetDateString) return;
                
                if (!confirm(`[${targetDateString}] 날짜에 [${file.name}] 파일의 데이터를 덮어쓰시겠습니까?`)) {
                    this.hideRestoreModal();
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedData = JSON.parse(event.target.result);
                        
                        DataManager.updateS2Data(s2_data => {
                            s2_data[targetDateString] = loadedData;
                        });
                        
                        // 만약 현재 보고 있는 날짜에 복원한 거라면, 화면 새로고침
                        if (targetDateString === this.state.s2_currentDate.toISOString().slice(0, 10)) {
                            this.refreshDispatchLog();
                        }
                        
                        alert(`[${targetDateString}] 날짜로 승무일지 복원이 완료되었습니다.`);
                        
                    } catch (e) {
                        alert('파일을 읽는 도중 오류가 발생했습니다. JSON 형식이 아닙니다.');
                        console.error('S2 Restore Error:', e);
                    } finally {
                        this.hideRestoreModal();
                    }
                };
                reader.readAsText(file);
            }
        }; // End of S2_Module

        /* ================================================================= */
        /* [Section 3] 정비일지 JavaScript */
        /* ================================================================= */
        
        /**
         * 4. S3(정비일지) 모듈
         * - S1 데이터 변경 시(onDataChanged) 노선/차량 드롭다운을 갱신합니다.
         * - S3 일지 데이터를 날짜별로 저장/로드합니다.
         */
        const S3_Module = {
            ui: {
                container: document.getElementById('section3'),
                form: document.getElementById('maintenanceForm'),
                tbody: document.querySelector('#maintenanceForm tbody'),
                dateDisplay: document.getElementById('s3_dateDisplay'),
                title: document.getElementById('s3_title'),
                // Modals
                restoreModal: document.getElementById('s3_restoreDateModal'),
                restoreFile: document.getElementById('s3_restoreFile'),
                cancelRestoreBtn: document.getElementById('s3_cancelRestoreBtn'),
                triggerRestoreBtn: document.getElementById('s3_triggerRestoreBtn'),
                calculatorModal: document.getElementById('s3_calculatorModal'),
                startDate: document.getElementById('s3_startDate'),
                endDate: document.getElementById('s3_endDate'),
                totalPrice: document.getElementById('s3_totalPrice'),
                // Margins & Font
                marginLeft: document.getElementById('s3_marginLeft'),
                marginRight: document.getElementById('s3_marginRight'),
                fontSizeInput: document.getElementById('s3_fontSizeInput'),
            },
            state: {
                s3_currentDate: new Date(),
                s3_rowCount: 10, // HTML에 기본 10줄이 있음
                s3_allRoutesData: {}, // S1 노선/차량 데이터 캐시
            },

            /**
             * S3 모듈 초기화
             */
            initialize() {
                console.log("S3: 초기화 시작");
                DataManager.subscribe(this); // DataManager에 S3 모듈 등록
                DataManager.loadS3Data();    // S3 전용 데이터 로드
                this.state.s3_allRoutesData = DataManager.getAllRoutes(); // S1 데이터 가져오기

                this.bindEventListeners();
                this.setTodayDate();
                this.populateAllRouteSelects(); // S1 데이터로 드롭다운 채우기
                this.loadFormData(this.state.s3_currentDate); // 오늘 날짜 데이터 로드
                
                // CSS 변수에 정의된 기본값으로 UI 설정
                this.ui.fontSizeInput.value = '11';
                this.ui.marginLeft.value = '10';
                this.ui.marginRight.value = '10';

                console.log("S3: 초기화 완료.");
            },
            
            /**
             * [핵심] DataManager로부터 알림 처리 (S1 변경 시)
             */
            onDataChanged(event, payload) {
                if (event === 's1_data_changed') {
                    console.log("[S3] S1로부터 데이터 변경 알림 수신. S3 노선/차량 드롭다운 갱신.");
                    this.state.s3_allRoutesData = DataManager.getAllRoutes();
                    this.populateAllRouteSelects();
                    // 현재 선택된 값을 유지하기 위해 폼 데이터를 다시 로드
                    this.loadFormData(this.state.s3_currentDate); 
                }
            },
            
            /**
             * (UI) 오늘 날짜 표시 및 제목 설정
             */
            setTodayDate() {
                const dateStr = this.state.s3_currentDate.toLocaleDateString('ko-KR', {
                    year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'long'
                }).replace(/\. /g, '.').replace(/\.$/, '');
                this.ui.dateDisplay.textContent = dateStr;
                
                const { routeData: currentS1RouteData } = DataManager.getCurrentRouteData();
                const companyName = currentS1RouteData ? currentS1RouteData.companyName : "차량점검정비일지";
                this.ui.title.textContent = companyName + " 차량점검정비일지";
            },

            /**
             * S3의 모든 이벤트 리스너 바인딩
             */
            bindEventListeners() {
                document.getElementById('s3-showAll').onclick = () => S1_Module.showAllSections();
                /* "일지저장" 버튼 리스너 삭제
            document.getElementById('s3-saveData').onclick = (e) => {
                e.preventDefault();
                this.saveFormData(this.state.s3_currentDate);
            };
            */
            document.getElementById('s3-backupFile').onclick = (e) => {
                e.preventDefault();
                // 1. 현재 폼 내용을 먼저 DataManager에 저장합니다.
                this.saveFormData(this.state.s3_currentDate);
                // 2. 방금 저장한 오늘 날짜의 데이터를 파일로 백업합니다.
                this.backupLogData();
            };
                document.getElementById('s3-triggerRestore').onclick = (e) => {
                    e.preventDefault();
                    this.ui.restoreModal.style.display = 'block';
                };
                document.getElementById('s3-clearForm').onclick = (e) => {
                    e.preventDefault();
                    this.clearForm();
                };
                document.getElementById('s3-printPage').onclick = (e) => {
                    e.preventDefault();
                    this.printPage();
                };
                document.getElementById('s3-addRow').onclick = (e) => {
                    e.preventDefault();
                    this.addRow();
                };
                
                // Textarea 자동 높이 조절 및 가격 포맷팅
                this.ui.tbody.addEventListener('input', e => {
                    if (e.target.tagName.toLowerCase() === 'textarea' && e.target.classList.contains('auto-resize')) {
                        this.autoResizeTextarea(e.target);
                    }
                   if (e.target.classList.contains('price-input')) {
                        this.formatPriceInput(e.target);
                    }
                });
                
                // S3 폼 자동 저장을 위한 이벤트 리스너
                // (내용 변경 즉시 DataManager에 저장)
                this.ui.tbody.addEventListener('change', e => {
                    // 드롭다운 (select) 또는 가격 (price-input) 변경 시
                    if (e.target.tagName.toLowerCase() === 'select' || e.target.classList.contains('price-input')) {
                        this.saveFormData(this.state.s3_currentDate);
                    }
                    // 노선 <select> 변경 시
                    if (e.target.classList.contains('s3_routeSelect_row')) {
                        this.handleRouteSelectChange(e.target);
                    }
                    // 차량 <select> 변경 시
                    if (e.target.classList.contains('s3_vehicleSelect_row')) {
                        this.handleVehicleSelectChange(e.target);
                    }
                });
                
                // Textarea 또는 Input에서 포커스가 벗어날 때 (blur) 저장
                this.ui.tbody.addEventListener('blur', e => {
                    if (e.target.tagName.toLowerCase() === 'textarea' || e.target.classList.contains('price-input')) {
                        this.saveFormData(this.state.s3_currentDate);
                    }
                }, true); // Use capture phase for blur

                // 복원 모달 버튼
                this.ui.cancelRestoreBtn.onclick = () => this.ui.restoreModal.style.display = 'none';
                this.ui.triggerRestoreBtn.onclick = () => this.ui.restoreFile.click();
                this.ui.restoreFile.onchange = (e) => this.restoreLogData(e.target.files[0]);

                // 계산기 모달 버튼
                document.getElementById('s3-showCalculator').onclick = (e) => {
                    e.preventDefault();
                    this.showCalculator();
                };
                document.getElementById('s3-calculatePrices').onclick = () => this.calculatePrices();
                document.getElementById('s3-closeCalculator').onclick = () => this.ui.calculatorModal.style.display = 'none';
                
                // 인쇄 설정 (여백,  FONT)
                this.ui.marginLeft.onchange = () => this.applyPrintMargins();
                this.ui.marginRight.onchange = () => this.applyPrintMargins();
                this.ui.fontSizeInput.onchange = () => this.applyFontSize();
            },

            /**
             * [핵심] S3 폼 데이터 -> DataManager에 저장
             * @param {Date} date - 저장할 날짜
             */
            saveFormData(date) {
                const dateString = date.toISOString().slice(0, 10);
                const formData = new FormData(this.ui.form);
                const dataToSave = {};

                // 폼 전체의 name: value를 객체로 만듦
                for (let [name, value] of formData.entries()) {
                    dataToSave[name] = value;
                }
                
                // DataManager의 S3 영역에 'YYYY-MM-DD' 키로 저장
                DataManager.updateS3Data(s3_data => {
                    s3_data[dateString] = dataToSave;
                });
                console.log(`[S3] ${dateString} 정비일지 저장 완료.`);
            },

            /**
             * [핵심] DataManager -> S3 폼 데이터 로드
             * @param {Date} date - 불러올 날짜
             */
            loadFormData(date) {
                const dateString = date.toISOString().slice(0, 10);
                const s3_data = DataManager.data.s3;
                const dataToLoad = s3_data[dateString] || {};

                // 폼의 모든 요소에 대해
                this.ui.form.querySelectorAll('input, textarea, select').forEach(el => {
                    const name = el.name;
                    if (dataToLoad[name] !== undefined) {
                        el.value = dataToLoad[name];
                        
                        // 데이터 로드 후 후속 UI 처리
                        if (el.tagName.toLowerCase() === 'textarea') {
                            this.autoResizeTextarea(el); // 텍스트 영역 높이 조절
                        }
                        if (el.classList.contains('price-input')) {
                            this.formatPriceInput(el, true); // 가격 포맷팅 (로드 시)
                        }
                        if (el.classList.contains('s3_routeSelect_row')) {
                            this.handleRouteSelectChange(el, true); // 차량 드롭다운 채우기 (로드)
                        }
                        if (el.classList.contains('s3_vehicleSelect_row')) {
                            this.handleVehicleSelectChange(el, true); // 차량 디스플레이 업데이트 (로드)
                        }
                    }
                });
                console.log(`[S3] ${dateString} 정비일지 로드 완료.`);
            },

            /**
             * (UI) 폼 초기화
             */
            clearForm() {
                if (confirm('현재 날짜의 정비일지 폼을 모두 초기화하시겠습니까? (저장된 데이터도 삭제됩니다)')) {
                    const dateString = this.state.s3_currentDate.toISOString().slice(0, 10);
                    
                    // DataManager에서 해당 날짜 데이터 삭제
                    DataManager.updateS3Data(s3_data => {
                        delete s3_data[dateString];
                    });
                    
                    // 폼 UI 리셋
                    this.ui.form.reset();
                    
                    // '행 추가'로 생성된 tr 삭제
                    this.ui.tbody.querySelectorAll('tr.s3_added-row').forEach(tr => {
                        tr.remove();
                    });
                    
                    // 기본 10개 행의 내용 초기화
                    this.ui.tbody.querySelectorAll('textarea').forEach(el => {
                        el.value = '';
                        this.autoResizeTextarea(el);
                    });
                    this.ui.tbody.querySelectorAll('.price-input').forEach(el => {
                        el.value = '';
                    });
                    this.ui.tbody.querySelectorAll('.s3_vehicleSelect_row').forEach(el => {
                        el.innerHTML = '';
                        el.style.display = 'none';
                    });
                    this.ui.tbody.querySelectorAll('.vehicle-display').forEach(el => {
                        el.textContent = '';
                    });
                    
                    this.state.s3_rowCount = 10; // 기본 행 10개
                    alert('현재 폼이 초기화되었습니다.');
                }
            },

            /**
             * (UI) 행 추가
             */
            addRow() {
                this.state.s3_rowCount++;
                const newRow = document.createElement('tr');
                newRow.classList.add('entry-row', 's3_added-row'); // 추가된 행 식별 클래스
                
                // name 속성의 인덱스 계산 (1_1 ~ 2_10 ...)
                const rowNum = Math.floor((this.state.s3_rowCount - 1) / 10) + 1;
                const cellNum = ((this.state.s3_rowCount - 1) % 10) + 1;
                
                newRow.innerHTML = `
                    <td class="route-select-cell">
                        <select class="header-select s3_routeSelect_row no-print" name="route_${rowNum}_${cellNum}"></select>
                        <select class="header-select s3_vehicleSelect_row no-print" name="vehicle_${rowNum}_${cellNum}" style="display: none;"></select>
                        <div class="vehicle-display"></div>
                    </td>
                    <td><textarea name="item_${rowNum}_${cellNum}" class="auto-resize"></textarea></td>
                    <td><textarea name="detail_${rowNum}_${cellNum}" class="auto-resize"></textarea></td>
                    <td><textarea name="parts_${rowNum}_${cellNum}" class="auto-resize"></textarea></td>
                    <td><div class="price-wrapper"><input type="text" inputmode="numeric" name="price_${rowNum}_${cellNum}" class="price-input" /></div></td>
                    <td><textarea name="worker_${rowNum}_${cellNum}" class="auto-resize"></textarea></td>
                `;
                this.ui.tbody.appendChild(newRow);
                
                // 새 행의 노선 드롭다운 채우기
                const newRouteSelect = newRow.querySelector('.s3_routeSelect_row');
                this.populateRouteSelect(newRouteSelect);
            },

            /**
             * (UI) Textarea 자동 높이 조절
             */
            autoResizeTextarea(textarea) {
                textarea.style.height = 'auto'; // 높이 초기화
                const scrollHeight = textarea.scrollHeight;
                textarea.style.height = (scrollHeight < 28 ? 28 : scrollHeight) + 'px'; // 최소 높이 28px
            },

            /**
             * (UI) 가격 입력 포맷 (1,000)
             * @param {HTMLInputElement} input - 가격 입력 필드
             * @param {boolean} isOnLoad - 데이터 로드 시 호출되었는지 여부
             */
            formatPriceInput(input, isOnLoad = false) {
                let value = input.value.replace(/,/g, ''); // 콤마 제거
                
                if (value === '' || isNaN(value)) {
                    // 숫자가 아닌 값 (e.g. "별매")은 로드 시에는 허용, 사용자 입력 시에는 초기화
                    if (!isOnLoad) input.value = '';
                    return;
                }
                
                if (value.includes('.')) { // 소수점 방지
                    value = value.split('.')[0];
                }
                
                const formattedValue = Number(value).toLocaleString('ko-KR');
                input.value = formattedValue;
            },

            /**
             * [데이터 연동] S3의 모든 노선 드롭다운 채우기
             */
            populateAllRouteSelects() {
                const allSelects = this.ui.tbody.querySelectorAll('.s3_routeSelect_row');
                allSelects.forEach(select => this.populateRouteSelect(select));
            },

            /**
             * (Util) 개별 노선 드롭다운 채우기
             */
            populateRouteSelect(selectElement) {
                const currentValue = selectElement.value; // 현재 값 유지
                selectElement.innerHTML = '<option value="">노선</option>';
                
                const routeNames = Object.keys(this.state.s3_allRoutesData);
                routeNames.forEach(name => {
                    selectElement.innerHTML += `<option value="${name}">${name}</option>`;
                });
                
                // 현재 값이 유효하면 다시 선택
                if (routeNames.includes(currentValue)) {
                    selectElement.value = currentValue;
                }
            },

            /**
             * [데이터 연동] 노선 선택 시 -> 차량 드롭다운 채우기
             */
            handleRouteSelectChange(routeSelect, isOnLoad = false) {
                const routeName = routeSelect.value;
                const vehicleSelect = routeSelect.nextElementSibling; // 바로 뒤 <select>
                
                if (!routeName || !vehicleSelect || !vehicleSelect.classList.contains('s3_vehicleSelect_row')) {
                    if (vehicleSelect) vehicleSelect.style.display = 'none';
                    this.updateVehicleDisplay(routeSelect.closest('td'), '', ''); // 표시 초기화
                    return;
                }
                
                const routeData = this.state.s3_allRoutesData[routeName];
                if (routeData && routeData.vehicleColumns) {
                    // 차량 드롭다운 채우기
                    this.populateVehicleSelect(vehicleSelect, routeData.vehicleColumns);
                    vehicleSelect.style.display = 'block';
                    
                    // (중요) 로드 시가 아닐 경우 (사용자가 직접 변경) 차량 표시도 업데이트
                    if (!isOnLoad) {
                        this.handleVehicleSelectChange(vehicleSelect, false);
                    }
                } else {
                    vehicleSelect.style.display = 'none';
                }
            },
            
            /**
             * (Util) 개별 차량 드롭다운 채우기
             */
            populateVehicleSelect(vehicleSelect, vehicleList) {
                const currentValue = vehicleSelect.value; // 현재 값 유지
                vehicleSelect.innerHTML = '<option value="">차량</option>';
                
                vehicleList.forEach(vehicle => {
                    if (vehicle && vehicle !== '미입력') {
                        vehicleSelect.innerHTML += `<option value="${vehicle}">${vehicle}</option>`;
                    }
                });
                
                if (vehicleList.includes(currentValue)) {
                    vehicleSelect.value = currentValue;
                }
            },
            
            /**
             * [데이터 연동] 차량 선택 시 -> 하단 .vehicle-display 업데이트
             */
            handleVehicleSelectChange(vehicleSelect, isOnLoad = false) {
                const routeSelect = vehicleSelect.previousElementSibling;
                const routeName = routeSelect ? routeSelect.value : '';
                const vehicleNumber = vehicleSelect.value;
                
                // 인쇄용 텍스트 업데이트
                this.updateVehicleDisplay(vehicleSelect.closest('td'), routeName, vehicleNumber);
                
                // (중요) UI 변경 시 즉시 저장 (로드 시 제외)
                if (!isOnLoad) {
                    this.saveFormData(this.state.s3_currentDate);
                }
            },

            /**
             * (UI) .vehicle-display (인쇄용) 텍스트 업데이트
             */
            updateVehicleDisplay(cell, routeName, vehicleNumber) {
                const displayDiv = cell.querySelector('.vehicle-display');
                if (displayDiv) {
                    // 예: "종로08번 / 1234" -> "종로08 / 1234"
                    const shortRouteName = routeName.replace('번', '');
                    displayDiv.textContent = (routeName && vehicleNumber) ? `${shortRouteName} / ${vehicleNumber}` : '';
                }
            },

            /**
             * S3 데이터 백업 (현재 날짜 기준)
             */
            backupLogData() {
                // (저장은 이미 s3-backupFile 버튼 클릭 시 선행되었음)
                const dateString = this.state.s3_currentDate.toISOString().slice(0, 10);
                const dataToSave = DataManager.data.s3[dateString];

                if (!dataToSave || Object.keys(dataToSave).length === 0) {
                    alert(`[${dateString}] 백업할 정비일지 데이터가 없습니다.`);
                    return;
                }
                
                const jsonString = JSON.stringify(dataToSave);
                const filename = `bus_maintenance_log_${dateString}.json`;
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                alert(`[${dateString}] 날짜의 정비일지 데이터가 파일로 저장되었습니다.`);
            },

            /**
             * S3 데이터 복원 (현재 날짜 기준)
             */
            restoreLogData(file) {
                if (!file) {
                    this.ui.restoreModal.style.display = 'none';
                    return;
                }
                const dateString = this.state.s3_currentDate.toISOString().slice(0, 10);
                
                if (!confirm(`[${dateString}] 날짜에 [${file.name}] 파일의 데이터를 덮어쓰시겠습니까?`)) {
                    this.ui.restoreFile.value = '';
                    this.ui.restoreModal.style.display = 'none';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedData = JSON.parse(event.target.result);
                        
                        // 1. DataManager에 저장
                        DataManager.updateS3Data(s3_data => {
                            s3_data[dateString] = loadedData;
                        });
                        
                        // 2. 폼에 다시 로드
                        this.loadFormData(this.state.s3_currentDate);
                        
                        alert(`[${dateString}] 날짜로 정비일지 복원이 완료되었습니다.`);
                    } catch (e) {
                        alert('파일을 읽는 도중 오류가 발생했습니다. JSON 형식이 아닙니다.');
                        console.error('S3 Restore Error:', e);
                    } finally {
                        this.ui.restoreFile.value = '';
                        this.ui.restoreModal.style.display = 'none';
                    }
                };
                reader.readAsText(file);
            },

            /**
             * (UI) 인쇄
             */
            printPage() {
                // 1. 현재 폼 내용 저장 (인쇄 전 최신화)
                this.saveFormData(this.state.s3_currentDate);
                
                // 2. 인쇄 설정 적용
                this.applyPrintMargins();
                this.applyFontSize();

                // 3. 인쇄
                const originalTitle = document.title;
                const datePart = this.ui.dateDisplay.textContent.split(' ')[0]; // "2025년 10월 16일"
                document.title = `${this.ui.title.textContent}_${datePart}`;
                
                document.body.classList.remove('printing-section1', 'printing-section2');
                document.body.classList.add('printing-section3');
                
                const handleAfterPrint = () => {
                    document.title = originalTitle;
                    document.body.classList.remove('printing-section3');
                    window.removeEventListener('afterprint', handleAfterPrint);
                };
                window.addEventListener('afterprint', handleAfterPrint);
                
                window.print();
            },

            /**
             * (UI) 인쇄 여백 적용
             */
            applyPrintMargins() {
                document.documentElement.style.setProperty('--s3-print-margin-left', `${this.ui.marginLeft.value}mm`);
                document.documentElement.style.setProperty('--s3-print-margin-right', `${this.ui.marginRight.value}mm`);
            },

            /**
             * (UI) S3 폰트 크기 적용
             */
            applyFontSize() {
                const size = this.ui.fontSizeInput.value + 'pt';
                // 화면 폰트
                document.documentElement.style.setProperty('--s3-font-size-base', size);
                // 인쇄 폰트
                document.documentElement.style.setProperty('--s3-print-font-size', size);
            },

            /**
             * (UI) 계산기 모달 표시
             */
            showCalculator() {
                // 모달 열 때 날짜를 오늘로 초기화
                const today = new Date().toISOString().slice(0, 10);
                this.ui.startDate.value = today;
                this.ui.endDate.value = today;
                this.ui.totalPrice.textContent = '0원';
                this.ui.calculatorModal.style.display = 'block';
            },

            /**
             * (Logic) 부품 가격 계산
             */
            calculatePrices() {
                const startDate = this.ui.startDate.value;
                const endDate = this.ui.endDate.value;
                if (!startDate || !endDate) {
                    alert('시작일과 종료일을 모두 선택하세요.');
                    return;
                }

                const start = new Date(startDate);
                const end = new Date(endDate);
                const s3_data = DataManager.data.s3; // S3 전체 데이터
                let total = 0;

                // 시작일부터 종료일까지 순회
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateString = d.toISOString().slice(0, 10);
                    const dayData = s3_data[dateString]; // 해당 날짜의 폼 데이터
                    
                    if (dayData) {
                        // 폼 데이터의 모든 키 순회
                        for (const key in dayData) {
                            // 'price_'로 시작하는 키 (e.g. price_1_1)
                            if (key.startsWith('price_')) {
                                const price = parseFloat(dayData[key].replace(/,/g, ''));
                                if (!isNaN(price)) {
                                    total += price;
                                }
                            }
                        }
                    }
                }
                
                this.ui.totalPrice.textContent = `${total.toLocaleString('ko-KR')}원`;
            }
        }; // End of S3_Module

        /* ================================================================= */
        /* [공통] 초기화 (DOM 로드 완료 시) */
        /* ================================================================= */

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM 로드 완료. 모듈 초기화 시작.");
            
            // 각 모듈 초기화 실행
            S1_Module.initialize();
            S2_Module.initialize();
            S3_Module.initialize();
            
            // S1 모듈이 '전체보기' 및 '섹션이동' 기능을 제어하므로,
            // S2/S3에 있는 관련 버튼들의 이벤트를 S1의 함수로 연결
            document.getElementById('s2-showAll').onclick = () => S1_Module.showAllSections();
            document.getElementById('s3-showAll').onclick = () => S1_Module.showAllSections();

            document.getElementById('s1-showS2').onclick = () => S1_Module.showSection('S2');
            document.getElementById('s1-showS3').onclick = () => S1_Module.showSection('S3');
            
            console.log("모든 모듈 초기화 완료.");
        });
</script>

</body>
</html>
